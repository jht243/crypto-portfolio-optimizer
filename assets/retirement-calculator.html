<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Retirement Calculator â€” Retirement, Savings, and Finance Metrics</title>
    <meta name="description" content="A comprehensive retirement calculator for Retirement, Ideal Savings, Asset Allocation, and Income Needs." />
    <meta property="og:title" content="Retirement, Savings, and Asset Allocation Calculator" />
    <meta property="og:description" content="Use this simple and powerful tool to calculate Retirement, ideal savings, asset allocation, and income requirements." />
    <meta name="keywords" content="retirement calculator, asset allocation calculator, income calculator, ideal savings, tdee, finance metrics, planning" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #F3F4F6;
        color: #1F2937;
        -webkit-font-smoothing: antialiased;
      }
      #retirement-calculator-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }
    </style>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit"></script>
    <script>
      window.TURNSTILE_SITE_KEY = "__TURNSTILE_SITE_KEY__";
    </script>
  </head>
  <body>
    <div id="retirement-calculator-root"></div>
    <!-- 
      Load script via import() to avoid HTML parser issues with inline code
    -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqIEB0eXBlIHtSZWFjdENvbXBvbmVudH0KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gewogICAgICAgICAgdHJhbnNpdGlvbjogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gewogICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgIC8vIFVzZWQgdG8gcmVwcm9kdWNlIGJlaGF2aW9yIG9mIGBiYXRjaGVkVXBkYXRlc2AgaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICBpc0JhdGNoaW5nTGVnYWN5OiBmYWxzZSwKICAgICAgICAgIGRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqIEB0eXBlIHtSZWFjdENvbXBvbmVudH0KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSB7fTsKICAgICAgICB2YXIgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRFeHRyYVN0YWNrRnJhbWUgPSBzdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgewogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUgPSBmdW5jdGlvbihzdGFjaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRTdGFja0FkZGVuZHVtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9ICIiOwogICAgICAgICAgICBpZiAoY3VycmVudEV4dHJhU3RhY2tGcmFtZSkgewogICAgICAgICAgICAgIHN0YWNrICs9IGN1cnJlbnRFeHRyYVN0YWNrRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGltcGwgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjazsKICAgICAgICAgICAgaWYgKGltcGwpIHsKICAgICAgICAgICAgICBzdGFjayArPSBpbXBsKCkgfHwgIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0YWNrOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLAogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybjMoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQyLCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdDIgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0Mik7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnQgPSB7fTsKICAgICAgICBmdW5jdGlvbiB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2NvbnN0cnVjdG9yID0gcHVibGljSW5zdGFuY2UuY29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gX2NvbnN0cnVjdG9yICYmIChfY29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgX2NvbnN0cnVjdG9yLm5hbWUpIHx8ICJSZWFjdENsYXNzIjsKICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBjb21wb25lbnROYW1lICsgIi4iICsgY2FsbGVyTmFtZTsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudFt3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvcigiQ2FuJ3QgY2FsbCAlcyBvbiBhIGNvbXBvbmVudCB0aGF0IGlzIG5vdCB5ZXQgbW91bnRlZC4gVGhpcyBpcyBhIG5vLW9wLCBidXQgaXQgbWlnaHQgaW5kaWNhdGUgYSBidWcgaW4geW91ciBhcHBsaWNhdGlvbi4gSW5zdGVhZCwgYXNzaWduIHRvIGB0aGlzLnN0YXRlYCBkaXJlY3RseSBvciBkZWZpbmUgYSBgc3RhdGUgPSB7fTtgIGNsYXNzIHByb3BlcnR5IHdpdGggdGhlIGRlc2lyZWQgc3RhdGUgaW4gdGhlICVzIGNvbXBvbmVudC4iLCBjYWxsZXJOYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBDaGVja3Mgd2hldGhlciBvciBub3QgdGhpcyBjb21wb3NpdGUgY29tcG9uZW50IGlzIG1vdW50ZWQuCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB3ZSB3YW50IHRvIHRlc3QuCiAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIG1vdW50ZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgICAqIEBwcm90ZWN0ZWQKICAgICAgICAgICAqIEBmaW5hbAogICAgICAgICAgICovCiAgICAgICAgICBpc01vdW50ZWQ6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEZvcmNlcyBhbiB1cGRhdGUuIFRoaXMgc2hvdWxkIG9ubHkgYmUgaW52b2tlZCB3aGVuIGl0IGlzIGtub3duIHdpdGgKICAgICAgICAgICAqIGNlcnRhaW50eSB0aGF0IHdlIGFyZSAqKm5vdCoqIGluIGEgRE9NIHRyYW5zYWN0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFlvdSBtYXkgd2FudCB0byBjYWxsIHRoaXMgd2hlbiB5b3Uga25vdyB0aGF0IHNvbWUgZGVlcGVyIGFzcGVjdCBvZiB0aGUKICAgICAgICAgICAqIGNvbXBvbmVudCdzIHN0YXRlIGhhcyBjaGFuZ2VkIGJ1dCBgc2V0U3RhdGVgIHdhcyBub3QgY2FsbGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoaXMgd2lsbCBub3QgaW52b2tlIGBzaG91bGRDb21wb25lbnRVcGRhdGVgLCBidXQgaXQgd2lsbCBpbnZva2UKICAgICAgICAgICAqIGBjb21wb25lbnRXaWxsVXBkYXRlYCBhbmQgYGNvbXBvbmVudERpZFVwZGF0ZWAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBjYWxsZXJOYW1lIG5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogUmVwbGFjZXMgYWxsIG9mIHRoZSBzdGF0ZS4gQWx3YXlzIHVzZSB0aGlzIG9yIGBzZXRTdGF0ZWAgdG8gbXV0YXRlIHN0YXRlLgogICAgICAgICAgICogWW91IHNob3VsZCB0cmVhdCBgdGhpcy5zdGF0ZWAgYXMgaW1tdXRhYmxlLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IGB0aGlzLnN0YXRlYCB3aWxsIGJlIGltbWVkaWF0ZWx5IHVwZGF0ZWQsIHNvCiAgICAgICAgICAgKiBhY2Nlc3NpbmcgYHRoaXMuc3RhdGVgIGFmdGVyIGNhbGxpbmcgdGhpcyBtZXRob2QgbWF5IHJldHVybiB0aGUgb2xkIHZhbHVlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBsZXRlU3RhdGUgTmV4dCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY29tcGxldGVTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFNldHMgYSBzdWJzZXQgb2YgdGhlIHN0YXRlLiBUaGlzIG9ubHkgZXhpc3RzIGJlY2F1c2UgX3BlbmRpbmdTdGF0ZSBpcwogICAgICAgICAgICogaW50ZXJuYWwuIFRoaXMgcHJvdmlkZXMgYSBtZXJnaW5nIHN0cmF0ZWd5IHRoYXQgaXMgbm90IGF2YWlsYWJsZSB0byBkZWVwCiAgICAgICAgICAgKiBwcm9wZXJ0aWVzIHdoaWNoIGlzIGNvbmZ1c2luZy4gVE9ETzogRXhwb3NlIHBlbmRpbmdTdGF0ZSBvciBkb24ndCB1c2UgaXQKICAgICAgICAgICAqIGR1cmluZyB0aGUgbWVyZ2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFydGlhbFN0YXRlIE5leHQgcGFydGlhbCBzdGF0ZSB0byBiZSBtZXJnZWQgd2l0aCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IE5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInNldFN0YXRlIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50ID0ge307CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uKHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAiZnVuY3Rpb24iICYmIHBhcnRpYWxTdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0U3RhdGUoLi4uKTogdGFrZXMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcyB0byB1cGRhdGUgb3IgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFuIG9iamVjdCBvZiBzdGF0ZSB2YXJpYWJsZXMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgICAgaXNNb3VudGVkOiBbImlzTW91bnRlZCIsICJJbnN0ZWFkLCBtYWtlIHN1cmUgdG8gY2xlYW4gdXAgc3Vic2NyaXB0aW9ucyBhbmQgcGVuZGluZyByZXF1ZXN0cyBpbiBjb21wb25lbnRXaWxsVW5tb3VudCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4iXSwKICAgICAgICAgICAgcmVwbGFjZVN0YXRlOiBbInJlcGxhY2VTdGF0ZSIsICJSZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIHNldFN0YXRlIGluc3RlYWQgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzMyMzYpLiJdCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyA9IGZ1bmN0aW9uKG1ldGhvZE5hbWUsIGluZm8pIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENvbXBvbmVudC5wcm90b3R5cGUsIG1ldGhvZE5hbWUsIHsKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgd2FybjMoIiVzKC4uLikgaXMgZGVwcmVjYXRlZCBpbiBwbGFpbiBKYXZhU2NyaXB0IFJlYWN0IGNsYXNzZXMuICVzIiwgaW5mb1swXSwgaW5mb1sxXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICAgIGlmIChkZXByZWNhdGVkQVBJcy5oYXNPd25Qcm9wZXJ0eShmbk5hbWUpKSB7CiAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50RHVtbXkoKSB7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gUHVyZUNvbXBvbmVudDMocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgfQogICAgICAgIHZhciBwdXJlQ29tcG9uZW50UHJvdG90eXBlID0gUHVyZUNvbXBvbmVudDMucHJvdG90eXBlID0gbmV3IENvbXBvbmVudER1bW15KCk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGFzc2lnbjIocHVyZUNvbXBvbmVudFByb3RvdHlwZSwgQ29tcG9uZW50LnByb3RvdHlwZSk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVmKCkgewogICAgICAgICAgdmFyIHJlZk9iamVjdCA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgT2JqZWN0LnNlYWwocmVmT2JqZWN0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWZPYmplY3Q7CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheTIoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgIHJlZjogdHJ1ZSwKICAgICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24sIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duLCBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgInJlZiIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZEtleShjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAia2V5IikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJrZXkiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ0tleSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ0tleS5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAicmVmIiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgY29uZmlnLl9fc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gY29uZmlnLl9fc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZjIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50NDAodHlwZSwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgdmFyIHNlbGYyID0gbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBudWxsOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZjIgPSBjb25maWcuX19zZWxmID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc2VsZjsKICAgICAgICAgICAgc291cmNlID0gY29uZmlnLl9fc291cmNlID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc291cmNlOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZEFycmF5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgJiYgdHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVBbmRSZXBsYWNlS2V5KG9sZEVsZW1lbnQsIG5ld0tleSkgewogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBSZWFjdEVsZW1lbnQob2xkRWxlbWVudC50eXBlLCBuZXdLZXksIG9sZEVsZW1lbnQucmVmLCBvbGRFbGVtZW50Ll9zZWxmLCBvbGRFbGVtZW50Ll9zb3VyY2UsIG9sZEVsZW1lbnQuX293bmVyLCBvbGRFbGVtZW50LnByb3BzKTsKICAgICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnQ5KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LmNsb25lRWxlbWVudCguLi4pOiBUaGUgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWN0IGVsZW1lbnQsIGJ1dCB5b3UgcGFzc2VkICIgKyBlbGVtZW50ICsgIi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbjIoe30sIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHJlZiA9IGVsZW1lbnQucmVmOwogICAgICAgICAgdmFyIHNlbGYyID0gZWxlbWVudC5fc2VsZjsKICAgICAgICAgIHZhciBzb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgJiYgZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IGVsZW1lbnQudHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoY29uZmlnW3Byb3BOYW1lXSA9PT0gdm9pZCAwICYmIGRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CiAgICAgICAgICBpZiAoY2hpbGRyZW5MZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW5MZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHZhciBjaGlsZEFycmF5ID0gQXJyYXkoY2hpbGRyZW5MZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUmVhY3RFbGVtZW50KGVsZW1lbnQudHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIG93bmVyLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTYob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIgJiYgb2JqZWN0ICE9PSBudWxsICYmIG9iamVjdC4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFOwogICAgICAgIH0KICAgICAgICB2YXIgU0VQQVJBVE9SID0gIi4iOwogICAgICAgIHZhciBTVUJTRVBBUkFUT1IgPSAiOiI7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlKGtleSkgewogICAgICAgICAgdmFyIGVzY2FwZVJlZ2V4ID0gL1s9Ol0vZzsKICAgICAgICAgIHZhciBlc2NhcGVyTG9va3VwID0gewogICAgICAgICAgICAiPSI6ICI9MCIsCiAgICAgICAgICAgICI6IjogIj0yIgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBlc2NhcGVkU3RyaW5nID0ga2V5LnJlcGxhY2UoZXNjYXBlUmVnZXgsIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBlc2NhcGVyTG9va3VwW21hdGNoXTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuICIkIiArIGVzY2FwZWRTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzID0gZmFsc2U7CiAgICAgICAgdmFyIHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4ID0gL1wvKy9nOwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZVVzZXJQcm92aWRlZEtleSh0ZXh0KSB7CiAgICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4LCAiJCYvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnRLZXkoZWxlbWVudCwgaW5kZXgpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gIm9iamVjdCIgJiYgZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXNjYXBlKCIiICsgZWxlbWVudC5rZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZGV4LnRvU3RyaW5nKDM2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwSW50b0FycmF5KGNoaWxkcmVuLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmFtZVNvRmFyLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgY2hpbGRyZW47CiAgICAgICAgICBpZiAodHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnZva2VDYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7CiAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkcmVuLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGludm9rZUNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfY2hpbGQgPSBjaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG1hcHBlZENoaWxkID0gY2FsbGJhY2soX2NoaWxkKTsKICAgICAgICAgICAgdmFyIGNoaWxkS2V5ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiArIGdldEVsZW1lbnRLZXkoX2NoaWxkLCAwKSA6IG5hbWVTb0ZhcjsKICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgIHZhciBlc2NhcGVkQ2hpbGRLZXkgPSAiIjsKICAgICAgICAgICAgICBpZiAoY2hpbGRLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXNjYXBlZENoaWxkS2V5ID0gZXNjYXBlVXNlclByb3ZpZGVkS2V5KGNoaWxkS2V5KSArICIvIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWFwSW50b0FycmF5KG1hcHBlZENoaWxkLCBhcnJheSwgZXNjYXBlZENoaWxkS2V5LCAiIiwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwcGVkQ2hpbGQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE2KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1hcHBlZENoaWxkLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkID0gY2xvbmVBbmRSZXBsYWNlS2V5KAogICAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCwKICAgICAgICAgICAgICAgICAgLy8gS2VlcCBib3RoIHRoZSAobWFwcGVkKSBhbmQgb2xkIGtleXMgaWYgdGhleSBkaWZmZXIsIGp1c3QgYXMKICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2VBbGxDaGlsZHJlbiB1c2VkIHRvIGRvIGZvciBvYmplY3RzIGFzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgIGVzY2FwZWRQcmVmaXggKyAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFJlYWN0LlBvcnRhbCBkb2Vzbid0IGhhdmUgYSBrZXkKICAgICAgICAgICAgICAgICAgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpID8gKAogICAgICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgZXhpc3RpbmcgZWxlbWVudCdzIGtleSBjYW4gYmUgYSBudW1iZXIKICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaW50ZXJuYWwvc2FmZS1zdHJpbmctY29lcmNpb24KICAgICAgICAgICAgICAgICAgICBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoIiIgKyBtYXBwZWRDaGlsZC5rZXkpICsgIi8iCiAgICAgICAgICAgICAgICAgICkgOiAiIikgKyBjaGlsZEtleQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJyYXkucHVzaChtYXBwZWRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICB2YXIgbmV4dE5hbWU7CiAgICAgICAgICB2YXIgc3VidHJlZUNvdW50ID0gMDsKICAgICAgICAgIHZhciBuZXh0TmFtZVByZWZpeCA9IG5hbWVTb0ZhciA9PT0gIiIgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CiAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpKTsKICAgICAgICAgICAgICBzdWJ0cmVlQ291bnQgKz0gbWFwSW50b0FycmF5KGNoaWxkLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmV4dE5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhYmxlQ2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiA9PT0gaXRlcmFibGVDaGlsZHJlbi5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICAgIHdhcm4zKCJVc2luZyBNYXBzIGFzIGNoaWxkcmVuIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSBhbiBhcnJheSBvZiBrZXllZCBSZWFjdEVsZW1lbnRzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChpdGVyYWJsZUNoaWxkcmVuKTsKICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICB2YXIgaWkgPSAwOwogICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gc3RlcC52YWx1ZTsKICAgICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpaSsrKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlblN0cmluZyA9IFN0cmluZyhjaGlsZHJlbik7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRyZW5TdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjaGlsZHJlbikuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkcmVuU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdWJ0cmVlQ291bnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgbWFwSW50b0FycmF5KGNoaWxkcmVuLCByZXN1bHQsICIiLCAiIiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBjaGlsZCwgY291bnQrKyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvdW50Q2hpbGRyZW4oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbisrOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yRWFjaENoaWxkcmVuKGNoaWxkcmVuLCBmb3JFYWNoRnVuYywgZm9yRWFjaENvbnRleHQpIHsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yRWFjaEZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZvckVhY2hDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9BcnJheShjaGlsZHJlbikgewogICAgICAgICAgcmV0dXJuIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICB9KSB8fCBbXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25seUNoaWxkKGNoaWxkcmVuKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50MTYoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuQ2hpbGRyZW4ub25seSBleHBlY3RlZCB0byByZWNlaXZlIGEgc2luZ2xlIFJlYWN0IGVsZW1lbnQgY2hpbGQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbnRleHQxMihkZWZhdWx0VmFsdWUpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfQ09OVEVYVF9UWVBFLAogICAgICAgICAgICAvLyBBcyBhIHdvcmthcm91bmQgdG8gc3VwcG9ydCBtdWx0aXBsZSBjb25jdXJyZW50IHJlbmRlcmVycywgd2UgY2F0ZWdvcml6ZQogICAgICAgICAgICAvLyBzb21lIHJlbmRlcmVycyBhcyBwcmltYXJ5IGFuZCBvdGhlcnMgYXMgc2Vjb25kYXJ5LiBXZSBvbmx5IGV4cGVjdAogICAgICAgICAgICAvLyB0aGVyZSB0byBiZSB0d28gY29uY3VycmVudCByZW5kZXJlcnMgYXQgbW9zdDogUmVhY3QgTmF0aXZlIChwcmltYXJ5KSBhbmQKICAgICAgICAgICAgLy8gRmFicmljIChzZWNvbmRhcnkpOyBSZWFjdCBET00gKHByaW1hcnkpIGFuZCBSZWFjdCBBUlQgKHNlY29uZGFyeSkuCiAgICAgICAgICAgIC8vIFNlY29uZGFyeSByZW5kZXJlcnMgc3RvcmUgdGhlaXIgY29udGV4dCB2YWx1ZXMgb24gc2VwYXJhdGUgZmllbGRzLgogICAgICAgICAgICBfY3VycmVudFZhbHVlOiBkZWZhdWx0VmFsdWUsCiAgICAgICAgICAgIF9jdXJyZW50VmFsdWUyOiBkZWZhdWx0VmFsdWUsCiAgICAgICAgICAgIC8vIFVzZWQgdG8gdHJhY2sgaG93IG1hbnkgY29uY3VycmVudCByZW5kZXJlcnMgdGhpcyBjb250ZXh0IGN1cnJlbnRseQogICAgICAgICAgICAvLyBzdXBwb3J0cyB3aXRoaW4gaW4gYSBzaW5nbGUgcmVuZGVyZXIuIFN1Y2ggYXMgcGFyYWxsZWwgc2VydmVyIHJlbmRlcmluZy4KICAgICAgICAgICAgX3RocmVhZENvdW50OiAwLAogICAgICAgICAgICAvLyBUaGVzZSBhcmUgY2lyY3VsYXIKICAgICAgICAgICAgUHJvdmlkZXI6IG51bGwsCiAgICAgICAgICAgIENvbnN1bWVyOiBudWxsLAogICAgICAgICAgICAvLyBBZGQgdGhlc2UgdG8gdXNlIHNhbWUgaGlkZGVuIGNsYXNzIGluIFZNIGFzIFNlcnZlckNvbnRleHQKICAgICAgICAgICAgX2RlZmF1bHRWYWx1ZTogbnVsbCwKICAgICAgICAgICAgX2dsb2JhbE5hbWU6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUFJPVklERVJfVFlQRSwKICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMgPSBmYWxzZTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlciA9IGZhbHNlOwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBDb25zdW1lciA9IHsKICAgICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfQ09OVEVYVF9UWVBFLAogICAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENvbnN1bWVyLCB7CiAgICAgICAgICAgICAgUHJvdmlkZXI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dC5Db25zdW1lci5Qcm92aWRlcj4gaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuUHJvdmlkZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuUHJvdmlkZXI7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfUHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5Qcm92aWRlciA9IF9Qcm92aWRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9jdXJyZW50VmFsdWU6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfY3VycmVudFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IF9jdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfY3VycmVudFZhbHVlMjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTI7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfY3VycmVudFZhbHVlMikgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUyID0gX2N1cnJlbnRWYWx1ZTI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfdGhyZWFkQ291bnQ6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll90aHJlYWRDb3VudDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF90aHJlYWRDb3VudCkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll90aHJlYWRDb3VudCA9IF90aHJlYWRDb3VudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIENvbnN1bWVyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuQ29uc3VtZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LkNvbnN1bWVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lcikgewogICAgICAgICAgICAgICAgICAgIHdhcm4zKCJTZXR0aW5nIGBkaXNwbGF5TmFtZWAgb24gQ29udGV4dC5Db25zdW1lciBoYXMgbm8gZWZmZWN0LiBZb3Ugc2hvdWxkIHNldCBpdCBkaXJlY3RseSBvbiB0aGUgY29udGV4dCB3aXRoIENvbnRleHQuZGlzcGxheU5hbWUgPSAnJXMnLiIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb250ZXh0LkNvbnN1bWVyID0gQ29uc3VtZXI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciA9IG51bGw7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlcjIgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIHZhciBVbmluaXRpYWxpemVkID0gLTE7CiAgICAgICAgdmFyIFBlbmRpbmcgPSAwOwogICAgICAgIHZhciBSZXNvbHZlZCA9IDE7CiAgICAgICAgdmFyIFJlamVjdGVkID0gMjsKICAgICAgICBmdW5jdGlvbiBsYXp5SW5pdGlhbGl6ZXIocGF5bG9hZCkgewogICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICB2YXIgY3RvciA9IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gY3RvcigpOwogICAgICAgICAgICB0aGVuYWJsZS50aGVuKGZ1bmN0aW9uKG1vZHVsZU9iamVjdDIpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkID0gcGF5bG9hZDsKICAgICAgICAgICAgICAgIHJlc29sdmVkLl9zdGF0dXMgPSBSZXNvbHZlZDsKICAgICAgICAgICAgICAgIHJlc29sdmVkLl9yZXN1bHQgPSBtb2R1bGVPYmplY3QyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZWplY3RlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZWplY3RlZC5fc3RhdHVzID0gUmVqZWN0ZWQ7CiAgICAgICAgICAgICAgICByZWplY3RlZC5fcmVzdWx0ID0gZXJyb3IyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICB2YXIgcGVuZGluZyA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgcGVuZGluZy5fc3RhdHVzID0gUGVuZGluZzsKICAgICAgICAgICAgICBwZW5kaW5nLl9yZXN1bHQgPSB0aGVuYWJsZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUmVzb2x2ZWQpIHsKICAgICAgICAgICAgdmFyIG1vZHVsZU9iamVjdCA9IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChtb2R1bGVPYmplY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoImxhenk6IEV4cGVjdGVkIHRoZSByZXN1bHQgb2YgYSBkeW5hbWljIGltcG9ydCgpIGNhbGwuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzXG5cbllvdXIgY29kZSBzaG91bGQgbG9vayBsaWtlOiBcbiAgY29uc3QgTXlDb21wb25lbnQgPSBsYXp5KCgpID0+IGltcG9ydCgnLi9NeUNvbXBvbmVudCcpKVxuXG5EaWQgeW91IGFjY2lkZW50YWxseSBwdXQgY3VybHkgYnJhY2VzIGFyb3VuZCB0aGUgaW1wb3J0PyIsIG1vZHVsZU9iamVjdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoISgiZGVmYXVsdCIgaW4gbW9kdWxlT2JqZWN0KSkgewogICAgICAgICAgICAgICAgZXJyb3IoImxhenk6IEV4cGVjdGVkIHRoZSByZXN1bHQgb2YgYSBkeW5hbWljIGltcG9ydCgpIGNhbGwuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzXG5cbllvdXIgY29kZSBzaG91bGQgbG9vayBsaWtlOiBcbiAgY29uc3QgTXlDb21wb25lbnQgPSBsYXp5KCgpID0+IGltcG9ydCgnLi9NeUNvbXBvbmVudCcpKSIsIG1vZHVsZU9iamVjdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtb2R1bGVPYmplY3QuZGVmYXVsdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGF6eShjdG9yKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IHsKICAgICAgICAgICAgLy8gV2UgdXNlIHRoZXNlIGZpZWxkcyB0byBzdG9yZSB0aGUgcmVzdWx0LgogICAgICAgICAgICBfc3RhdHVzOiBVbmluaXRpYWxpemVkLAogICAgICAgICAgICBfcmVzdWx0OiBjdG9yCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGxhenlUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfTEFaWV9UWVBFLAogICAgICAgICAgICBfcGF5bG9hZDogcGF5bG9hZCwKICAgICAgICAgICAgX2luaXQ6IGxhenlJbml0aWFsaXplcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMobGF6eVR5cGUsIHsKICAgICAgICAgICAgICBkZWZhdWx0UHJvcHM6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdEZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYGRlZmF1bHRQcm9wc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICBkZWZhdWx0UHJvcHMgPSBuZXdEZWZhdWx0UHJvcHM7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsYXp5VHlwZSwgImRlZmF1bHRQcm9wcyIsIHsKICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgcHJvcFR5cGVzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcHJvcFR5cGVzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3UHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBwcm9wVHlwZXNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgcHJvcFR5cGVzID0gbmV3UHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJwcm9wVHlwZXMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhenlUeXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3J3YXJkUmVmMTUocmVuZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCAmJiByZW5kZXIuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgcmVjZWl2ZWQgYSBgbWVtb2AgY29tcG9uZW50LiBJbnN0ZWFkIG9mIGZvcndhcmRSZWYobWVtbyguLi4pKSwgdXNlIG1lbW8oZm9yd2FyZFJlZiguLi4pKS4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVuZGVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVxdWlyZXMgYSByZW5kZXIgZnVuY3Rpb24gYnV0IHdhcyBnaXZlbiAlcy4iLCByZW5kZXIgPT09IG51bGwgPyAibnVsbCIgOiB0eXBlb2YgcmVuZGVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocmVuZGVyLmxlbmd0aCAhPT0gMCAmJiByZW5kZXIubGVuZ3RoICE9PSAyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGFjY2VwdCBleGFjdGx5IHR3byBwYXJhbWV0ZXJzOiBwcm9wcyBhbmQgcmVmLiAlcyIsIHJlbmRlci5sZW5ndGggPT09IDEgPyAiRGlkIHlvdSBmb3JnZXQgdG8gdXNlIHRoZSByZWYgcGFyYW1ldGVyPyIgOiAiQW55IGFkZGl0aW9uYWwgcGFyYW1ldGVyIHdpbGwgYmUgdW5kZWZpbmVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVuZGVyICE9IG51bGwpIHsKICAgICAgICAgICAgICBpZiAocmVuZGVyLmRlZmF1bHRQcm9wcyAhPSBudWxsIHx8IHJlbmRlci5wcm9wVHlwZXMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVuZGVyIGZ1bmN0aW9ucyBkbyBub3Qgc3VwcG9ydCBwcm9wVHlwZXMgb3IgZGVmYXVsdFByb3BzLiBEaWQgeW91IGFjY2lkZW50YWxseSBwYXNzIGEgUmVhY3QgY29tcG9uZW50PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIsCiAgICAgICAgICAgIHJlbmRlcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG93bk5hbWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50VHlwZSwgImRpc3BsYXlOYW1lIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG93bk5hbWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgIG93bk5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgaWYgKCFyZW5kZXIubmFtZSAmJiAhcmVuZGVyLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlci5kaXNwbGF5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50VHlwZTsKICAgICAgICB9CiAgICAgICAgdmFyIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0U7CiAgICAgICAgewogICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IGVuYWJsZURlYnVnVHJhY2luZyB8fCB0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbiB8fCB0eXBlID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtZW1vNyh0eXBlLCBjb21wYXJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIm1lbW86IFRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgY29tcG9uZW50LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcyIsIHR5cGUgPT09IG51bGwgPyAibnVsbCIgOiB0eXBlb2YgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX01FTU9fVFlQRTIsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGNvbXBhcmU6IGNvbXBhcmUgPT09IHZvaWQgMCA/IG51bGwgOiBjb21wYXJlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXR5cGUubmFtZSAmJiAhdHlwZS5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICB0eXBlLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGlzcGF0Y2hlcigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlQ29udGV4dDEyKENvbnRleHQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbnRleHQuX2NvbnRleHQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciByZWFsQ29udGV4dCA9IENvbnRleHQuX2NvbnRleHQ7CiAgICAgICAgICAgICAgaWYgKHJlYWxDb250ZXh0LkNvbnN1bWVyID09PSBDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQ2FsbGluZyB1c2VDb250ZXh0KENvbnRleHQuQ29uc3VtZXIpIGlzIG5vdCBzdXBwb3J0ZWQsIG1heSBjYXVzZSBidWdzLCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byBjYWxsIHVzZUNvbnRleHQoQ29udGV4dCkgaW5zdGVhZD8iKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlYWxDb250ZXh0LlByb3ZpZGVyID09PSBDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQ2FsbGluZyB1c2VDb250ZXh0KENvbnRleHQuUHJvdmlkZXIpIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHVzZUNvbnRleHQoQ29udGV4dCkgaW5zdGVhZD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUNvbnRleHQoQ29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN0YXRlMTIoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWYxNShpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZihpbml0aWFsVmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VFZmZlY3QxNShjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTGF5b3V0RWZmZWN0OShjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDYWxsYmFjazcoY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTWVtbzgoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUltcGVyYXRpdmVIYW5kbGUzKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVidWdWYWx1ZTIodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlVHJhbnNpdGlvbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSWQyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSWQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgfQogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2SW5mbwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB3YXJuOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXAKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoZm4sIFtdLCBGYWtlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgRmFrZS5jYWxsKCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudDIpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQyLnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhczMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhczModHlwZVNwZWNzLCB0eXBlU3BlY05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gRXJyb3IoKGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIikgKyAiOiAiICsgbG9jYXRpb24gKyAiIHR5cGUgYCIgKyB0eXBlU3BlY05hbWUgKyAiYCBpcyBpbnZhbGlkOyBpdCBtdXN0IGJlIGEgZnVuY3Rpb24sIHVzdWFsbHkgZnJvbSB0aGUgYHByb3AtdHlwZXNgIHBhY2thZ2UsIGJ1dCByZWNlaXZlZCBgIiArIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSArICJgLlRoaXMgb2Z0ZW4gaGFwcGVucyBiZWNhdXNlIG9mIHR5cG9zIHN1Y2ggYXMgYFByb3BUeXBlcy5mdW5jdGlvbmAgaW5zdGVhZCBvZiBgUHJvcFR5cGVzLmZ1bmNgLiIpOwogICAgICAgICAgICAgICAgICAgIGVyci5uYW1lID0gIkludmFyaWFudCBWaW9sYXRpb24iOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvciQxID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCAiU0VDUkVUX0RPX05PVF9QQVNTX1RISVNfT1JfWU9VX1dJTExfQkVfRklSRUQiKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSBleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxICYmICEoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yKSkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiB0eXBlIHNwZWNpZmljYXRpb24gb2YgJXMgYCVzYCBpcyBpbnZhbGlkOyB0aGUgdHlwZSBjaGVja2VyIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiBZb3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIHBhc3MgYW4gYXJndW1lbnQgdG8gdGhlIHR5cGUgY2hlY2tlciBjcmVhdG9yIChhcnJheU9mLCBpbnN0YW5jZU9mLCBvYmplY3RPZiwgb25lT2YsIG9uZU9mVHlwZSwgYW5kIHNoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4iLCBjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvciQxKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yICYmICEoZXJyb3IkMS5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgICAgICAgbG9nZ2VkVHlwZUZhaWx1cmVzW2Vycm9yJDEubWVzc2FnZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkZhaWxlZCAlcyB0eXBlOiAlcyIsIGxvY2F0aW9uLCBlcnJvciQxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG5hbWUgKyAiYC4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKHNvdXJjZSkgewogICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciBmaWxlTmFtZSA9IHNvdXJjZS5maWxlTmFtZS5yZXBsYWNlKC9eLipbXFxcL10vLCAiIik7CiAgICAgICAgICAgIHZhciBsaW5lTnVtYmVyID0gc291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bUZvclByb3BzKGVsZW1lbnRQcm9wcykgewogICAgICAgICAgaWYgKGVsZW1lbnRQcm9wcyAhPT0gbnVsbCAmJiBlbGVtZW50UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oZWxlbWVudFByb3BzLl9fc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgdmFyIGluZm8gPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5hbWUpIHsKICAgICAgICAgICAgICBpbmZvID0gIlxuXG5DaGVjayB0aGUgdG9wLWxldmVsIHJlbmRlciBjYWxsIHVzaW5nIDwiICsgcGFyZW50TmFtZSArICI+LiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbmZvOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUV4cGxpY2l0S2V5KGVsZW1lbnQsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgIHZhciBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvID0gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKTsKICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dID0gdHJ1ZTsKICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50Ll9vd25lciAmJiBlbGVtZW50Ll9vd25lciAhPT0gUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCkgewogICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpOwogICAgICAgICAgICBlcnJvcignRWFjaCBjaGlsZCBpbiBhIGxpc3Qgc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4lcyVzIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicsIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8sIGNoaWxkT3duZXIpOwogICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUNoaWxkS2V5cyhub2RlLCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG5vZGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0FycmF5Mihub2RlKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlW2ldOwogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE2KGNoaWxkKSkgewogICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50MTYobm9kZSkpIHsKICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE2KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BUeXBlcykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3BUeXBlcywgZWxlbWVudC5wcm9wcywgInByb3AiLCBuYW1lLCBlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlLlByb3BUeXBlcyAhPT0gdm9pZCAwICYmICFwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgX25hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbXBvbmVudCAlcyBkZWNsYXJlZCBgUHJvcFR5cGVzYCBpbnN0ZWFkIG9mIGBwcm9wVHlwZXNgLiBEaWQgeW91IG1pc3NwZWxsIHRoZSBwcm9wZXJ0eSBhc3NpZ25tZW50PyIsIF9uYW1lIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLmdldERlZmF1bHRQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiAhdHlwZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0RGVmYXVsdFByb3BzIGlzIG9ubHkgdXNlZCBvbiBjbGFzc2ljIFJlYWN0LmNyZWF0ZUNsYXNzIGRlZmluaXRpb25zLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgbmFtZWQgYGRlZmF1bHRQcm9wc2AgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZnJhZ21lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhmcmFnbWVudC5wcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIGlmIChrZXkgIT09ICJjaGlsZHJlbiIgJiYga2V5ICE9PSAia2V5IikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBwcm9wIGAlc2Agc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4gUmVhY3QuRnJhZ21lbnQgY2FuIG9ubHkgaGF2ZSBga2V5YCBhbmQgYGNoaWxkcmVuYCBwcm9wcy4iLCBrZXkpOwogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZnJhZ21lbnQucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXR0cmlidXRlIGByZWZgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIik7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpOwogICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bUZvclByb3BzKHByb3BzKTsKICAgICAgICAgICAgaWYgKHNvdXJjZUluZm8pIHsKICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaW5mbyArPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkyKHR5cGUpKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJhcnJheSI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSAhPT0gdm9pZCAwICYmIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgIGluZm8gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5jcmVhdGVFbGVtZW50OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50ID0gY3JlYXRlRWxlbWVudDQwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbih0eXBlKSB7CiAgICAgICAgICB2YXIgdmFsaWRhdGVkRmFjdG9yeSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbi5iaW5kKG51bGwsIHR5cGUpOwogICAgICAgICAgdmFsaWRhdGVkRmFjdG9yeS50eXBlID0gdHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gdHJ1ZTsKICAgICAgICAgICAgICB3YXJuMygiUmVhY3QuY3JlYXRlRmFjdG9yeSgpIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBDb25zaWRlciB1c2luZyBKU1ggb3IgdXNlIFJlYWN0LmNyZWF0ZUVsZW1lbnQoKSBkaXJlY3RseSBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh2YWxpZGF0ZWRGYWN0b3J5LCAidHlwZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgd2FybjMoIkZhY3RvcnkudHlwZSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdGhlIGNsYXNzIGRpcmVjdGx5IGJlZm9yZSBwYXNzaW5nIGl0IHRvIGNyZWF0ZUZhY3RvcnkuIik7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInR5cGUiLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiB0eXBlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVkRmFjdG9yeTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb24oZWxlbWVudCwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IGNsb25lRWxlbWVudDkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgbmV3RWxlbWVudC50eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKG5ld0VsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzY29wZSwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2NvcGUoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybjMoIkRldGVjdGVkIGEgbGFyZ2UgbnVtYmVyIG9mIHVwZGF0ZXMgaW5zaWRlIHN0YXJ0VHJhbnNpdGlvbi4gSWYgdGhpcyBpcyBkdWUgdG8gYSBzdWJzY3JpcHRpb24gcGxlYXNlIHJlLXdyaXRlIGl0IHRvIHVzZSBSZWFjdCBwcm92aWRlZCBob29rcy4gT3RoZXJ3aXNlIGNvbmN1cnJlbnQgbW9kZSBndWFyYW50ZWVzIGFyZSBvZmYgdGhlIHRhYmxlLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID0gZmFsc2U7CiAgICAgICAgdmFyIGVucXVldWVUYXNrSW1wbCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVRhc2sodGFzazIpIHsKICAgICAgICAgIGlmIChlbnF1ZXVlVGFza0ltcGwgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgcmVxdWlyZVN0cmluZyA9ICgicmVxdWlyZSIgKyBNYXRoLnJhbmRvbSgpKS5zbGljZSgwLCA3KTsKICAgICAgICAgICAgICB2YXIgbm9kZVJlcXVpcmUgPSBtb2R1bGUgJiYgbW9kdWxlW3JlcXVpcmVTdHJpbmddOwogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IG5vZGVSZXF1aXJlLmNhbGwobW9kdWxlLCAidGltZXJzIikuc2V0SW1tZWRpYXRlOwogICAgICAgICAgICB9IGNhdGNoIChfZXJyKSB7CiAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1lc3NhZ2VDaGFubmVsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBoYXZlIGEgTWVzc2FnZUNoYW5uZWwgaW1wbGVtZW50YXRpb24sIHNvIGVucXVldWluZyB0YXNrcyB2aWEgYXdhaXQgYWN0KGFzeW5jICgpID0+IC4uLikgd2lsbCBmYWlsLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZSBhdCBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzIGlmIHlvdSBlbmNvdW50ZXIgdGhpcyB3YXJuaW5nLiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKHZvaWQgMCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVucXVldWVUYXNrSW1wbCh0YXNrMik7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RTY29wZURlcHRoID0gMDsKICAgICAgICB2YXIgZGlkV2Fybk5vQXdhaXRBY3QgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBhY3QoY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByZXZBY3RTY29wZURlcHRoID0gYWN0U2NvcGVEZXB0aDsKICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCsrOwogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldklzQmF0Y2hpbmdMZWdhY3kgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSB0cnVlOwogICAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgaWYgKCFwcmV2SXNCYXRjaGluZ0xlZ2FjeSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHByZXZJc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhciB3YXNBd2FpdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgIHdhc0F3YWl0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVuYWJsZVJlc3VsdC50aGVuKGZ1bmN0aW9uKHJldHVyblZhbHVlMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZTIsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5Ob0F3YWl0QWN0ICYmIHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghd2FzQXdhaXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2Fybk5vQXdhaXRBY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBjYWxsZWQgYWN0KGFzeW5jICgpID0+IC4uLikgd2l0aG91dCBhd2FpdC4gVGhpcyBjb3VsZCBsZWFkIHRvIHVuZXhwZWN0ZWQgdGVzdGluZyBiZWhhdmlvdXIsIGludGVybGVhdmluZyBtdWx0aXBsZSBhY3QgY2FsbHMgYW5kIG1peGluZyB0aGVpciBzY29wZXMuIFlvdSBzaG91bGQgLSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhlbmFibGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gcmVzdWx0OwogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIF9xdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoX3F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUoX3F1ZXVlKTsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZTIgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmV2QWN0U2NvcGVEZXB0aCAhPT0gYWN0U2NvcGVEZXB0aCAtIDEpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHNlZW0gdG8gaGF2ZSBvdmVybGFwcGluZyBhY3QoKSBjYWxscywgdGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBCZSBzdXJlIHRvIGF3YWl0IHByZXZpb3VzIGFjdCgpIGNhbGxzIGJlZm9yZSBtYWtpbmcgYSBuZXcgb25lLiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RTY29wZURlcHRoID0gcHJldkFjdFNjb3BlRGVwdGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlVGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmx1c2hBY3RRdWV1ZShxdWV1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmx1c2hpbmcpIHsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcXVldWUgPSBxdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUVsZW1lbnQkMSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY2xvbmVFbGVtZW50JDEgPSBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgQ2hpbGRyZW4yID0gewogICAgICAgICAgbWFwOiBtYXBDaGlsZHJlbiwKICAgICAgICAgIGZvckVhY2g6IGZvckVhY2hDaGlsZHJlbiwKICAgICAgICAgIGNvdW50OiBjb3VudENoaWxkcmVuLAogICAgICAgICAgdG9BcnJheSwKICAgICAgICAgIG9ubHk6IG9ubHlDaGlsZAogICAgICAgIH07CiAgICAgICAgZXhwb3J0cy5DaGlsZHJlbiA9IENoaWxkcmVuMjsKICAgICAgICBleHBvcnRzLkNvbXBvbmVudCA9IENvbXBvbmVudDsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLlByb2ZpbGVyID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICBleHBvcnRzLlB1cmVDb21wb25lbnQgPSBQdXJlQ29tcG9uZW50MzsKICAgICAgICBleHBvcnRzLlN0cmljdE1vZGUgPSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOwogICAgICAgIGV4cG9ydHMuU3VzcGVuc2UgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgIGV4cG9ydHMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBSZWFjdFNoYXJlZEludGVybmFsczsKICAgICAgICBleHBvcnRzLmFjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLmNsb25lRWxlbWVudCA9IGNsb25lRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQxMjsKICAgICAgICBleHBvcnRzLmNyZWF0ZUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVGYWN0b3J5ID0gY3JlYXRlRmFjdG9yeTsKICAgICAgICBleHBvcnRzLmNyZWF0ZVJlZiA9IGNyZWF0ZVJlZjsKICAgICAgICBleHBvcnRzLmZvcndhcmRSZWYgPSBmb3J3YXJkUmVmMTU7CiAgICAgICAgZXhwb3J0cy5pc1ZhbGlkRWxlbWVudCA9IGlzVmFsaWRFbGVtZW50MTY7CiAgICAgICAgZXhwb3J0cy5sYXp5ID0gbGF6eTsKICAgICAgICBleHBvcnRzLm1lbW8gPSBtZW1vNzsKICAgICAgICBleHBvcnRzLnN0YXJ0VHJhbnNpdGlvbiA9IHN0YXJ0VHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2FjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLnVzZUNhbGxiYWNrID0gdXNlQ2FsbGJhY2s3OwogICAgICAgIGV4cG9ydHMudXNlQ29udGV4dCA9IHVzZUNvbnRleHQxMjsKICAgICAgICBleHBvcnRzLnVzZURlYnVnVmFsdWUgPSB1c2VEZWJ1Z1ZhbHVlMjsKICAgICAgICBleHBvcnRzLnVzZURlZmVycmVkVmFsdWUgPSB1c2VEZWZlcnJlZFZhbHVlOwogICAgICAgIGV4cG9ydHMudXNlRWZmZWN0ID0gdXNlRWZmZWN0MTU7CiAgICAgICAgZXhwb3J0cy51c2VJZCA9IHVzZUlkMjsKICAgICAgICBleHBvcnRzLnVzZUltcGVyYXRpdmVIYW5kbGUgPSB1c2VJbXBlcmF0aXZlSGFuZGxlMzsKICAgICAgICBleHBvcnRzLnVzZUluc2VydGlvbkVmZmVjdCA9IHVzZUluc2VydGlvbkVmZmVjdDsKICAgICAgICBleHBvcnRzLnVzZUxheW91dEVmZmVjdCA9IHVzZUxheW91dEVmZmVjdDk7CiAgICAgICAgZXhwb3J0cy51c2VNZW1vID0gdXNlTWVtbzg7CiAgICAgICAgZXhwb3J0cy51c2VSZWR1Y2VyID0gdXNlUmVkdWNlcjsKICAgICAgICBleHBvcnRzLnVzZVJlZiA9IHVzZVJlZjE1OwogICAgICAgIGV4cG9ydHMudXNlU3RhdGUgPSB1c2VTdGF0ZTEyOwogICAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmUgPSB1c2VTeW5jRXh0ZXJuYWxTdG9yZTI7CiAgICAgICAgZXhwb3J0cy51c2VUcmFuc2l0aW9uID0gdXNlVHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnZlcnNpb24gPSBSZWFjdFZlcnNpb247CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9zY2hlZHVsZXJAMC4yMy4yL25vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXJfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY2hlZHVsZXJEZWJ1Z2dpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGZyYW1lWWllbGRNcyA9IDU7CiAgICAgICAgZnVuY3Rpb24gcHVzaChoZWFwLCBub2RlKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBoZWFwLmxlbmd0aDsKICAgICAgICAgIGhlYXAucHVzaChub2RlKTsKICAgICAgICAgIHNpZnRVcChoZWFwLCBub2RlLCBpbmRleCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlZWszKGhlYXApIHsKICAgICAgICAgIHJldHVybiBoZWFwLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBoZWFwWzBdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3AoaGVhcCkgewogICAgICAgICAgaWYgKGhlYXAubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpcnN0ID0gaGVhcFswXTsKICAgICAgICAgIHZhciBsYXN0MiA9IGhlYXAucG9wKCk7CiAgICAgICAgICBpZiAobGFzdDIgIT09IGZpcnN0KSB7CiAgICAgICAgICAgIGhlYXBbMF0gPSBsYXN0MjsKICAgICAgICAgICAgc2lmdERvd24oaGVhcCwgbGFzdDIsIDApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0VXAoaGVhcCwgbm9kZSwgaSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaTsKICAgICAgICAgIHdoaWxlIChpbmRleCA+IDApIHsKICAgICAgICAgICAgdmFyIHBhcmVudEluZGV4ID0gaW5kZXggLSAxID4+PiAxOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gaGVhcFtwYXJlbnRJbmRleF07CiAgICAgICAgICAgIGlmIChjb21wYXJlKHBhcmVudCwgbm9kZSkgPiAwKSB7CiAgICAgICAgICAgICAgaGVhcFtwYXJlbnRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcGFyZW50OwogICAgICAgICAgICAgIGluZGV4ID0gcGFyZW50SW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNpZnREb3duKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICB2YXIgaGFsZkxlbmd0aCA9IGxlbmd0aCA+Pj4gMTsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGhhbGZMZW5ndGgpIHsKICAgICAgICAgICAgdmFyIGxlZnRJbmRleCA9IChpbmRleCArIDEpICogMiAtIDE7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gaGVhcFtsZWZ0SW5kZXhdOwogICAgICAgICAgICB2YXIgcmlnaHRJbmRleCA9IGxlZnRJbmRleCArIDE7CiAgICAgICAgICAgIHZhciByaWdodCA9IGhlYXBbcmlnaHRJbmRleF07CiAgICAgICAgICAgIGlmIChjb21wYXJlKGxlZnQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIGxlZnQpIDwgMCkgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSByaWdodDsKICAgICAgICAgICAgICAgIGhlYXBbcmlnaHRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IGxlZnQ7CiAgICAgICAgICAgICAgICBoZWFwW2xlZnRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgICAgaW5kZXggPSBsZWZ0SW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJpZ2h0SW5kZXggPCBsZW5ndGggJiYgY29tcGFyZShyaWdodCwgbm9kZSkgPCAwKSB7CiAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSByaWdodDsKICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBpbmRleCA9IHJpZ2h0SW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYSwgYikgewogICAgICAgICAgdmFyIGRpZmYgPSBhLnNvcnRJbmRleCAtIGIuc29ydEluZGV4OwogICAgICAgICAgcmV0dXJuIGRpZmYgIT09IDAgPyBkaWZmIDogYS5pZCAtIGIuaWQ7CiAgICAgICAgfQogICAgICAgIHZhciBJbW1lZGlhdGVQcmlvcml0eSA9IDE7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gMjsKICAgICAgICB2YXIgTm9ybWFsUHJpb3JpdHkgPSAzOwogICAgICAgIHZhciBMb3dQcmlvcml0eSA9IDQ7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IDU7CiAgICAgICAgZnVuY3Rpb24gbWFya1Rhc2tFcnJvcmVkKHRhc2syLCBtcykgewogICAgICAgIH0KICAgICAgICB2YXIgaGFzUGVyZm9ybWFuY2VOb3cgPSB0eXBlb2YgcGVyZm9ybWFuY2UgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgaWYgKGhhc1BlcmZvcm1hbmNlTm93KSB7CiAgICAgICAgICB2YXIgbG9jYWxQZXJmb3JtYW5jZSA9IHBlcmZvcm1hbmNlOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsUGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbG9jYWxEYXRlMiA9IERhdGU7CiAgICAgICAgICB2YXIgaW5pdGlhbFRpbWUgPSBsb2NhbERhdGUyLm5vdygpOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsRGF0ZTIubm93KCkgLSBpbml0aWFsVGltZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBtYXhTaWduZWQzMUJpdEludCA9IDEwNzM3NDE4MjM7CiAgICAgICAgdmFyIElNTUVESUFURV9QUklPUklUWV9USU1FT1VUID0gLTE7CiAgICAgICAgdmFyIFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVCA9IDI1MDsKICAgICAgICB2YXIgTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQgPSA1ZTM7CiAgICAgICAgdmFyIExPV19QUklPUklUWV9USU1FT1VUID0gMWU0OwogICAgICAgIHZhciBJRExFX1BSSU9SSVRZX1RJTUVPVVQgPSBtYXhTaWduZWQzMUJpdEludDsKICAgICAgICB2YXIgdGFza1F1ZXVlID0gW107CiAgICAgICAgdmFyIHRpbWVyUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGFza0lkQ291bnRlciA9IDE7CiAgICAgICAgdmFyIGN1cnJlbnRUYXNrID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsU2V0VGltZW91dCA9IHR5cGVvZiBzZXRUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gc2V0VGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsQ2xlYXJUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsU2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gInVuZGVmaW5lZCIgPyBzZXRJbW1lZGlhdGUgOiBudWxsOwogICAgICAgIHZhciBpc0lucHV0UGVuZGluZyA9IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nICE9PSB2b2lkIDAgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcgIT09IHZvaWQgMCA/IG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nLmJpbmQobmF2aWdhdG9yLnNjaGVkdWxpbmcpIDogbnVsbDsKICAgICAgICBmdW5jdGlvbiBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgdGltZXIgPSBwZWVrMyh0aW1lclF1ZXVlKTsKICAgICAgICAgIHdoaWxlICh0aW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodGltZXIuY2FsbGJhY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBwb3AodGltZXJRdWV1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGltZXIuc3RhcnRUaW1lIDw9IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIHRpbWVyLnNvcnRJbmRleCA9IHRpbWVyLmV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICAgIHB1c2godGFza1F1ZXVlLCB0aW1lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRpbWVvdXQoY3VycmVudFRpbWUpIHsKICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCkgewogICAgICAgICAgICBpZiAocGVlazModGFza1F1ZXVlKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrMyh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVxdWVzdEhvc3RUaW1lb3V0KGhhbmRsZVRpbWVvdXQsIGZpcnN0VGltZXIuc3RhcnRUaW1lIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFdvcmsoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKSB7CiAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgaWYgKGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgICBjYW5jZWxIb3N0VGltZW91dCgpOwogICAgICAgICAgfQogICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsaW5nKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgICAgICAgICAgbWFya1Rhc2tFcnJvcmVkKGN1cnJlbnRUYXNrLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmlzUXVldWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBpbml0aWFsVGltZTI7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGN1cnJlbnRUYXNrID0gcGVlazModGFza1F1ZXVlKTsKICAgICAgICAgIHdoaWxlIChjdXJyZW50VGFzayAhPT0gbnVsbCAmJiAhZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA+IGN1cnJlbnRUaW1lICYmICghaGFzVGltZVJlbWFpbmluZyB8fCBzaG91bGRZaWVsZFRvSG9zdCgpKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGN1cnJlbnRUYXNrLmNhbGxiYWNrOwogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gY3VycmVudFRhc2sucHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgICB2YXIgZGlkVXNlckNhbGxiYWNrVGltZW91dCA9IGN1cnJlbnRUYXNrLmV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICAgIHZhciBjb250aW51YXRpb25DYWxsYmFjayA9IGNhbGxiYWNrKGRpZFVzZXJDYWxsYmFja1RpbWVvdXQpOwogICAgICAgICAgICAgIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRpbnVhdGlvbkNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5jYWxsYmFjayA9IGNvbnRpbnVhdGlvbkNhbGxiYWNrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRhc2sgPT09IHBlZWszKHRhc2tRdWV1ZSkpIHsKICAgICAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gcGVlazModGFza1F1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50VGFzayAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBmaXJzdFRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RUaW1lb3V0KGhhbmRsZVRpbWVvdXQsIGZpcnN0VGltZXIuc3RhcnRUaW1lIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5KHByaW9yaXR5TGV2ZWwsIGV2ZW50SGFuZGxlcikgewogICAgICAgICAgc3dpdGNoIChwcmlvcml0eUxldmVsKSB7CiAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBldmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9uZXh0KGV2ZW50SGFuZGxlcikgewogICAgICAgICAgdmFyIHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnRQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBldmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV93cmFwQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHZhciBwYXJlbnRQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwYXJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgdmFyIHN0YXJ0VGltZTI7CiAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJvYmplY3QiICYmIG9wdGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRlbGF5ID0gb3B0aW9ucy5kZWxheTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgJiYgZGVsYXkgPiAwKSB7CiAgICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lICsgZGVsYXk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGltZW91dDsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gVVNFUl9CTE9DS0lOR19QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSURMRV9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBMT1dfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aW1lb3V0ID0gTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBzdGFydFRpbWUyICsgdGltZW91dDsKICAgICAgICAgIHZhciBuZXdUYXNrID0gewogICAgICAgICAgICBpZDogdGFza0lkQ291bnRlcisrLAogICAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCwKICAgICAgICAgICAgc3RhcnRUaW1lOiBzdGFydFRpbWUyLAogICAgICAgICAgICBleHBpcmF0aW9uVGltZSwKICAgICAgICAgICAgc29ydEluZGV4OiAtMQogICAgICAgICAgfTsKICAgICAgICAgIGlmIChzdGFydFRpbWUyID4gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBzdGFydFRpbWUyOwogICAgICAgICAgICBwdXNoKHRpbWVyUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAocGVlazModGFza1F1ZXVlKSA9PT0gbnVsbCAmJiBuZXdUYXNrID09PSBwZWVrMyh0aW1lclF1ZXVlKSkgewogICAgICAgICAgICAgIGlmIChpc0hvc3RUaW1lb3V0U2NoZWR1bGVkKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxIb3N0VGltZW91dCgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RUaW1lb3V0KGhhbmRsZVRpbWVvdXQsIHN0YXJ0VGltZTIgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgIHB1c2godGFza1F1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXdUYXNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY29udGludWVFeGVjdXRpb24oKSB7CiAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkICYmICFpc1BlcmZvcm1pbmdXb3JrKSB7CiAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSgpIHsKICAgICAgICAgIHJldHVybiBwZWVrMyh0YXNrUXVldWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjayh0YXNrMikgewogICAgICAgICAgdGFzazIuY2FsbGJhY2sgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdmFyIHRhc2tUaW1lb3V0SUQgPSAtMTsKICAgICAgICB2YXIgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICB2YXIgc3RhcnRUaW1lID0gLTE7CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkWWllbGRUb0hvc3QoKSB7CiAgICAgICAgICB2YXIgdGltZUVsYXBzZWQgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpIC0gc3RhcnRUaW1lOwogICAgICAgICAgaWYgKHRpbWVFbGFwc2VkIDwgZnJhbWVJbnRlcnZhbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdFBhaW50KCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZUZyYW1lUmF0ZShmcHMpIHsKICAgICAgICAgIGlmIChmcHMgPCAwIHx8IGZwcyA+IDEyNSkgewogICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKCJmb3JjZUZyYW1lUmF0ZSB0YWtlcyBhIHBvc2l0aXZlIGludCBiZXR3ZWVuIDAgYW5kIDEyNSwgZm9yY2luZyBmcmFtZSByYXRlcyBoaWdoZXIgdGhhbiAxMjUgZnBzIGlzIG5vdCBzdXBwb3J0ZWQiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZwcyA+IDApIHsKICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IE1hdGguZmxvb3IoMWUzIC8gZnBzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBmcmFtZVlpZWxkTXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgICAgc3RhcnRUaW1lID0gY3VycmVudFRpbWU7CiAgICAgICAgICAgIHZhciBoYXNUaW1lUmVtYWluaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGhhc01vcmVXb3JrID0gdHJ1ZTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBoYXNNb3JlV29yayA9IHNjaGVkdWxlZEhvc3RDYWxsYmFjayhoYXNUaW1lUmVtYWluaW5nLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKGhhc01vcmVXb3JrKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmU7CiAgICAgICAgaWYgKHR5cGVvZiBsb2NhbFNldEltbWVkaWF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbG9jYWxTZXRJbW1lZGlhdGUocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgTWVzc2FnZUNoYW5uZWwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpOwogICAgICAgICAgdmFyIHBvcnQgPSBjaGFubmVsLnBvcnQyOwogICAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBwZXJmb3JtV29ya1VudGlsRGVhZGxpbmU7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwb3J0LnBvc3RNZXNzYWdlKG51bGwpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbG9jYWxTZXRUaW1lb3V0KHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSwgMCk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0SG9zdENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgIGlmICghaXNNZXNzYWdlTG9vcFJ1bm5pbmcpIHsKICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSB0cnVlOwogICAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0SG9zdFRpbWVvdXQoY2FsbGJhY2ssIG1zKSB7CiAgICAgICAgICB0YXNrVGltZW91dElEID0gbG9jYWxTZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjayhleHBvcnRzLnVuc3RhYmxlX25vdygpKTsKICAgICAgICAgIH0sIG1zKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuY2VsSG9zdFRpbWVvdXQoKSB7CiAgICAgICAgICBsb2NhbENsZWFyVGltZW91dCh0YXNrVGltZW91dElEKTsKICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSAtMTsKICAgICAgICB9CiAgICAgICAgdmFyIHVuc3RhYmxlX3JlcXVlc3RQYWludCA9IHJlcXVlc3RQYWludDsKICAgICAgICB2YXIgdW5zdGFibGVfUHJvZmlsaW5nID0gbnVsbDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0lkbGVQcmlvcml0eSA9IElkbGVQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0ltbWVkaWF0ZVByaW9yaXR5ID0gSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Mb3dQcmlvcml0eSA9IExvd1ByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfTm9ybWFsUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX1Byb2ZpbGluZyA9IHVuc3RhYmxlX1Byb2ZpbGluZzsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5ID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9jYW5jZWxDYWxsYmFjayA9IHVuc3RhYmxlX2NhbmNlbENhbGxiYWNrOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfY29udGludWVFeGVjdXRpb24gPSB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbjsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2ZvcmNlRnJhbWVSYXRlID0gZm9yY2VGcmFtZVJhdGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IHVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUgPSB1bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25leHQgPSB1bnN0YWJsZV9uZXh0OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcGF1c2VFeGVjdXRpb24gPSB1bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbjsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3JlcXVlc3RQYWludCA9IHVuc3RhYmxlX3JlcXVlc3RQYWludDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3J1bldpdGhQcmlvcml0eSA9IHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2sgPSB1bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2hvdWxkWWllbGQgPSBzaG91bGRZaWVsZFRvSG9zdDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3dyYXBDYWxsYmFjayA9IHVuc3RhYmxlX3dyYXBDYWxsYmFjazsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9zY2hlZHVsZXJAMC4yMy4yL25vZGVfbW9kdWxlcy9zY2hlZHVsZXIvaW5kZXguanMKdmFyIHJlcXVpcmVfc2NoZWR1bGVyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9zY2hlZHVsZXJAMC4yMy4yL25vZGVfbW9kdWxlcy9zY2hlZHVsZXIvaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9zY2hlZHVsZXJfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgU2NoZWR1bGVyID0gcmVxdWlyZV9zY2hlZHVsZXIoKTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSBSZWFjdDM5Ll9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIHZhciBzdXBwcmVzc1dhcm5pbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzZXRTdXBwcmVzc1dhcm5pbmcobmV3U3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN1cHByZXNzV2FybmluZyA9IG5ld1N1cHByZXNzV2FybmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybjMoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlcnJvcihmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIEZ1bmN0aW9uQ29tcG9uZW50ID0gMDsKICAgICAgICB2YXIgQ2xhc3NDb21wb25lbnQgPSAxOwogICAgICAgIHZhciBJbmRldGVybWluYXRlQ29tcG9uZW50ID0gMjsKICAgICAgICB2YXIgSG9zdFJvb3QgPSAzOwogICAgICAgIHZhciBIb3N0UG9ydGFsID0gNDsKICAgICAgICB2YXIgSG9zdENvbXBvbmVudCA9IDU7CiAgICAgICAgdmFyIEhvc3RUZXh0ID0gNjsKICAgICAgICB2YXIgRnJhZ21lbnQxMCA9IDc7CiAgICAgICAgdmFyIE1vZGUgPSA4OwogICAgICAgIHZhciBDb250ZXh0Q29uc3VtZXIgPSA5OwogICAgICAgIHZhciBDb250ZXh0UHJvdmlkZXIgPSAxMDsKICAgICAgICB2YXIgRm9yd2FyZFJlZjIgPSAxMTsKICAgICAgICB2YXIgUHJvZmlsZXIgPSAxMjsKICAgICAgICB2YXIgU3VzcGVuc2VDb21wb25lbnQgPSAxMzsKICAgICAgICB2YXIgTWVtb0NvbXBvbmVudCA9IDE0OwogICAgICAgIHZhciBTaW1wbGVNZW1vQ29tcG9uZW50ID0gMTU7CiAgICAgICAgdmFyIExhenlDb21wb25lbnQgPSAxNjsKICAgICAgICB2YXIgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50ID0gMTc7CiAgICAgICAgdmFyIERlaHlkcmF0ZWRGcmFnbWVudCA9IDE4OwogICAgICAgIHZhciBTdXNwZW5zZUxpc3RDb21wb25lbnQgPSAxOTsKICAgICAgICB2YXIgU2NvcGVDb21wb25lbnQgPSAyMTsKICAgICAgICB2YXIgT2Zmc2NyZWVuQ29tcG9uZW50ID0gMjI7CiAgICAgICAgdmFyIExlZ2FjeUhpZGRlbkNvbXBvbmVudCA9IDIzOwogICAgICAgIHZhciBDYWNoZUNvbXBvbmVudCA9IDI0OwogICAgICAgIHZhciBUcmFjaW5nTWFya2VyQ29tcG9uZW50ID0gMjU7CiAgICAgICAgdmFyIGVuYWJsZUNsaWVudFJlbmRlckZhbGxiYWNrT25UZXh0TWlzbWF0Y2ggPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVOZXdSZWNvbmNpbGVyID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxhenlDb250ZXh0UHJvcGFnYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVN1c3BlbnNlQXZvaWRUaGlzRmFsbGJhY2sgPSBmYWxzZTsKICAgICAgICB2YXIgZGlzYWJsZUNvbW1lbnRzQXNET01Db250YWluZXJzID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCA9IGZhbHNlOwogICAgICAgIHZhciB3YXJuQWJvdXRTdHJpbmdSZWZzID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsZXJUaW1lciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgPSB0cnVlOwogICAgICAgIHZhciBhbGxOYXRpdmVFdmVudHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzID0ge307CiAgICAgICAgdmFyIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMgPSB7fTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlclR3b1BoYXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcyk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUgKyAiQ2FwdHVyZSIsIGRlcGVuZGVuY2llcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRGlyZWN0RXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzW3JlZ2lzdHJhdGlvbk5hbWVdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV2ZW50UmVnaXN0cnk6IE1vcmUgdGhhbiBvbmUgcGx1Z2luIGF0dGVtcHRlZCB0byBwdWJsaXNoIHRoZSBzYW1lIHJlZ2lzdHJhdGlvbiBuYW1lLCBgJXNgLiIsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzW3JlZ2lzdHJhdGlvbk5hbWVdID0gZGVwZW5kZW5jaWVzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSByZWdpc3RyYXRpb25OYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXNbbG93ZXJDYXNlZE5hbWVdID0gcmVnaXN0cmF0aW9uTmFtZTsKICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgPT09ICJvbkRvdWJsZUNsaWNrIikgewogICAgICAgICAgICAgIHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMub25kYmxjbGljayA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVwZW5kZW5jaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5hZGQoZGVwZW5kZW5jaWVzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhblVzZURPTTIgPSAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgYXR0cmlidXRlIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBhdHRyaWJ1dGVOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIHByb3AgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBDU1MgcHJvcGVydHkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIEhUTUwgbWFya3VwIHVzZXMgYSB2YWx1ZSBvZiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJGb3JtIGZpZWxkIHZhbHVlcyAodmFsdWUsIGNoZWNrZWQsIGRlZmF1bHRWYWx1ZSwgb3IgZGVmYXVsdENoZWNrZWQgcHJvcHMpIG11c3QgYmUgc3RyaW5ncywgbm90ICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVTRVJWRUQgPSAwOwogICAgICAgIHZhciBTVFJJTkcgPSAxOwogICAgICAgIHZhciBCT09MRUFOSVNIX1NUUklORyA9IDI7CiAgICAgICAgdmFyIEJPT0xFQU4gPSAzOwogICAgICAgIHZhciBPVkVSTE9BREVEX0JPT0xFQU4gPSA0OwogICAgICAgIHZhciBOVU1FUklDID0gNTsKICAgICAgICB2YXIgUE9TSVRJVkVfTlVNRVJJQyA9IDY7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgPSAiOkEtWl9hLXpcXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9DSEFSID0gQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJcXC0uMC05XFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICAgICAgdmFyIFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYID0gbmV3IFJlZ0V4cCgiXlsiICsgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgdmFyIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZVNhZmUoYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWC50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lOiBgJXNgIiwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUubGVuZ3RoID4gMiAmJiAobmFtZVswXSA9PT0gIm8iIHx8IG5hbWVbMF0gPT09ICJPIikgJiYgKG5hbWVbMV0gPT09ICJuIiB8fCBuYW1lWzFdID09PSAiTiIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICBjYXNlICJzeW1ib2wiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICJib29sZWFuIjogewogICAgICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIXByb3BlcnR5SW5mby5hY2NlcHRzQm9vbGVhbnM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXgyID0gbmFtZS50b0xvd2VyQ2FzZSgpLnNsaWNlKDAsIDUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeDIgIT09ICJkYXRhLSIgJiYgcHJlZml4MiAhPT0gImFyaWEtIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChwcm9wZXJ0eUluZm8udHlwZSkgewogICAgICAgICAgICAgIGNhc2UgQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBPVkVSTE9BREVEX0JPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgIGNhc2UgTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSBQT1NJVElWRV9OVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA8IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHJvcGVydHlJbmZvKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KG5hbWUpID8gcHJvcGVydGllc1tuYW1lXSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFByb3BlcnR5SW5mb1JlY29yZChuYW1lLCB0eXBlLCBtdXN0VXNlUHJvcGVydHksIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSwgc2FuaXRpemVVUkwyLCByZW1vdmVFbXB0eVN0cmluZykgewogICAgICAgICAgdGhpcy5hY2NlcHRzQm9vbGVhbnMgPSB0eXBlID09PSBCT09MRUFOSVNIX1NUUklORyB8fCB0eXBlID09PSBCT09MRUFOIHx8IHR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTjsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IGF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIHRoaXMubXVzdFVzZVByb3BlcnR5ID0gbXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgdGhpcy5wcm9wZXJ0eU5hbWUgPSBuYW1lOwogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuc2FuaXRpemVVUkwgPSBzYW5pdGl6ZVVSTDI7CiAgICAgICAgICB0aGlzLnJlbW92ZUVtcHR5U3RyaW5nID0gcmVtb3ZlRW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJlc2VydmVkUHJvcHMgPSBbCiAgICAgICAgICAiY2hpbGRyZW4iLAogICAgICAgICAgImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIC8vIFRPRE86IFRoaXMgcHJldmVudHMgdGhlIGFzc2lnbm1lbnQgb2YgZGVmYXVsdFZhbHVlIHRvIHJlZ3VsYXIKICAgICAgICAgIC8vIGVsZW1lbnRzIChub3QganVzdCBpbnB1dHMpLiBOb3cgdGhhdCBSZWFjdERPTUlucHV0IGFzc2lnbnMgdG8gdGhlCiAgICAgICAgICAvLyBkZWZhdWx0VmFsdWUgcHJvcGVydHkgLS0gZG8gd2UgbmVlZCB0aGlzPwogICAgICAgICAgImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgImlubmVySFRNTCIsCiAgICAgICAgICAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciLAogICAgICAgICAgInN0eWxlIgogICAgICAgIF07CiAgICAgICAgcmVzZXJ2ZWRQcm9wcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBSRVNFUlZFRCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgW1siYWNjZXB0Q2hhcnNldCIsICJhY2NlcHQtY2hhcnNldCJdLCBbImNsYXNzTmFtZSIsICJjbGFzcyJdLCBbImh0bWxGb3IiLCAiZm9yIl0sIFsiaHR0cEVxdWl2IiwgImh0dHAtZXF1aXYiXV0uZm9yRWFjaChmdW5jdGlvbihfcmVmMikgewogICAgICAgICAgdmFyIG5hbWUgPSBfcmVmMlswXSwgYXR0cmlidXRlTmFtZSA9IF9yZWYyWzFdOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJjb250ZW50RWRpdGFibGUiLCAiZHJhZ2dhYmxlIiwgInNwZWxsQ2hlY2siLCAidmFsdWUiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImF1dG9SZXZlcnNlIiwgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLCAiZm9jdXNhYmxlIiwgInByZXNlcnZlQWxwaGEiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAiYXN5bmMiLAogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBwcmV2ZW50cyBpdCBmcm9tIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIERPTQogICAgICAgICAgLy8gb24gdGhlIGNsaWVudCBzaWRlIGJlY2F1c2UgdGhlIGJyb3dzZXJzIGFyZSBpbmNvbnNpc3RlbnQuIEluc3RlYWQgd2UgY2FsbCBmb2N1cygpLgogICAgICAgICAgImF1dG9Gb2N1cyIsCiAgICAgICAgICAiYXV0b1BsYXkiLAogICAgICAgICAgImNvbnRyb2xzIiwKICAgICAgICAgICJkZWZhdWx0IiwKICAgICAgICAgICJkZWZlciIsCiAgICAgICAgICAiZGlzYWJsZWQiLAogICAgICAgICAgImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgICJoaWRkZW4iLAogICAgICAgICAgImxvb3AiLAogICAgICAgICAgIm5vTW9kdWxlIiwKICAgICAgICAgICJub1ZhbGlkYXRlIiwKICAgICAgICAgICJvcGVuIiwKICAgICAgICAgICJwbGF5c0lubGluZSIsCiAgICAgICAgICAicmVhZE9ubHkiLAogICAgICAgICAgInJlcXVpcmVkIiwKICAgICAgICAgICJyZXZlcnNlZCIsCiAgICAgICAgICAic2NvcGVkIiwKICAgICAgICAgICJzZWFtbGVzcyIsCiAgICAgICAgICAvLyBNaWNyb2RhdGEKICAgICAgICAgICJpdGVtU2NvcGUiCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjaGVja2VkIiwKICAgICAgICAgIC8vIE5vdGU6IGBvcHRpb24uc2VsZWN0ZWRgIGlzIG5vdCB1cGRhdGVkIGlmIGBzZWxlY3QubXVsdGlwbGVgIGlzCiAgICAgICAgICAvLyBkaXNhYmxlZCB3aXRoIGByZW1vdmVBdHRyaWJ1dGVgLiBXZSBoYXZlIHNwZWNpYWwgbG9naWMgZm9yIGhhbmRsaW5nIHRoaXMuCiAgICAgICAgICAibXVsdGlwbGUiLAogICAgICAgICAgIm11dGVkIiwKICAgICAgICAgICJzZWxlY3RlZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2FwdHVyZSIsCiAgICAgICAgICAiZG93bmxvYWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE9WRVJMT0FERURfQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNvbHMiLAogICAgICAgICAgInJvd3MiLAogICAgICAgICAgInNpemUiLAogICAgICAgICAgInNwYW4iCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFBPU0lUSVZFX05VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsicm93U3BhbiIsICJzdGFydCJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE5VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIENBTUVMSVpFID0gL1tcLVw6XShbYS16XSkvZzsKICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW5bMV0udG9VcHBlckNhc2UoKTsKICAgICAgICB9OwogICAgICAgIFsKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IiwKICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiLAogICAgICAgICAgImFyYWJpYy1mb3JtIiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCIsCiAgICAgICAgICAiY2FwLWhlaWdodCIsCiAgICAgICAgICAiY2xpcC1wYXRoIiwKICAgICAgICAgICJjbGlwLXJ1bGUiLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItcHJvZmlsZSIsCiAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSIsCiAgICAgICAgICAiZW5hYmxlLWJhY2tncm91bmQiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1ydWxlIiwKICAgICAgICAgICJmbG9vZC1jb2xvciIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSIsCiAgICAgICAgICAiZm9udC1mYW1pbHkiLAogICAgICAgICAgImZvbnQtc2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplLWFkanVzdCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIiwKICAgICAgICAgICJmb250LXN0eWxlIiwKICAgICAgICAgICJmb250LXZhcmlhbnQiLAogICAgICAgICAgImZvbnQtd2VpZ2h0IiwKICAgICAgICAgICJnbHlwaC1uYW1lIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiLAogICAgICAgICAgImhvcml6LW9yaWdpbi14IiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciIsCiAgICAgICAgICAibWFya2VyLWVuZCIsCiAgICAgICAgICAibWFya2VyLW1pZCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJwYWludC1vcmRlciIsCiAgICAgICAgICAicGFub3NlLTEiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IiwKICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciLAogICAgICAgICAgInN0b3AtY29sb3IiLAogICAgICAgICAgInN0b3Atb3BhY2l0eSIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS13aWR0aCIsCiAgICAgICAgICAidGV4dC1hbmNob3IiLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIiwKICAgICAgICAgICJ1bmljb2RlLXJhbmdlIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iLAogICAgICAgICAgInYtYWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1oYW5naW5nIiwKICAgICAgICAgICJ2LWlkZW9ncmFwaGljIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCIsCiAgICAgICAgICAidmVydC1hZHYteSIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teSIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiLAogICAgICAgICAgInhtbG5zOnhsaW5rIiwKICAgICAgICAgICJ4LWhlaWdodCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhsaW5rOmFjdHVhdGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiLAogICAgICAgICAgInhsaW5rOnJvbGUiLAogICAgICAgICAgInhsaW5rOnNob3ciLAogICAgICAgICAgInhsaW5rOnRpdGxlIiwKICAgICAgICAgICJ4bGluazp0eXBlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhtbDpiYXNlIiwKICAgICAgICAgICJ4bWw6bGFuZyIsCiAgICAgICAgICAieG1sOnNwYWNlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInRhYkluZGV4IiwgImNyb3NzT3JpZ2luIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciB4bGlua0hyZWYgPSAieGxpbmtIcmVmIjsKICAgICAgICBwcm9wZXJ0aWVzW3hsaW5rSHJlZl0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgInhsaW5rSHJlZiIsCiAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgInhsaW5rOmhyZWYiLAogICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgWyJzcmMiLCAiaHJlZiIsICJhY3Rpb24iLCAiZm9ybUFjdGlvbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGlzSmF2YVNjcmlwdFByb3RvY29sID0gL15bXHUwMDAwLVx1MDAxRiBdKmpbXHJcblx0XSphW1xyXG5cdF0qdltcclxuXHRdKmFbXHJcblx0XSpzW1xyXG5cdF0qY1tcclxuXHRdKnJbXHJcblx0XSppW1xyXG5cdF0qcFtcclxuXHRdKnRbXHJcblx0XSpcOi9pOwogICAgICAgIHZhciBkaWRXYXJuID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2FuaXRpemVVUkwodXJsKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybiAmJiBpc0phdmFTY3JpcHRQcm90b2NvbC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICBkaWRXYXJuID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiQSBmdXR1cmUgdmVyc2lvbiBvZiBSZWFjdCB3aWxsIGJsb2NrIGphdmFzY3JpcHQ6IFVSTHMgYXMgYSBzZWN1cml0eSBwcmVjYXV0aW9uLiBVc2UgZXZlbnQgaGFuZGxlcnMgaW5zdGVhZCBpZiB5b3UgY2FuLiBJZiB5b3UgbmVlZCB0byBnZW5lcmF0ZSB1bnNhZmUgSFRNTCB0cnkgdXNpbmcgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgaW5zdGVhZC4gUmVhY3Qgd2FzIHBhc3NlZCAlcy4iLCBKU09OLnN0cmluZ2lmeSh1cmwpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTCgiIiArIGV4cGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgICB2YXIgc3RyaW5nVmFsdWUgPSBudWxsOwogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJpbmdWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlID09PSBudWxsID8gZXhwZWN0ZWQgOiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZ1ZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW5vZGUuaGFzQXR0cmlidXRlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCB2YWx1ZSwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICBpZiAoc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyB8fCBwcm9wZXJ0eUluZm8gPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUsICIiICsgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbXVzdFVzZVByb3BlcnR5ID0gcHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIGlmIChtdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdHlwZSA9PT0gQk9PTEVBTiA/IGZhbHNlIDogIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWU7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gQk9PTEVBTiB8fCBfdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOICYmIHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTChhdHRyaWJ1dGVWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlTlMoYXR0cmlidXRlTmFtZXNwYWNlLCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9TQ09QRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc2NvcGUiKTsKICAgICAgICB2YXIgUkVBQ1RfREVCVUdfVFJBQ0lOR19NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5kZWJ1Z190cmFjZV9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIFJFQUNUX0xFR0FDWV9ISURERU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxlZ2FjeV9oaWRkZW4iKTsKICAgICAgICB2YXIgUkVBQ1RfQ0FDSEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNhY2hlIik7CiAgICAgICAgdmFyIFJFQUNUX1RSQUNJTkdfTUFSS0VSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC50cmFjaW5nX21hcmtlciIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoY3Rvciwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgb3duZXIgPSBmaWJlci5fZGVidWdPd25lciA/IGZpYmVyLl9kZWJ1Z093bmVyLnR5cGUgOiBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIkxhenkiKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmaWJlci50eXBlLnJlbmRlcik7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQ2xhc3NDb21wb25lbnRGcmFtZShmaWJlci50eXBlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaW5mbyArPSBkZXNjcmliZUZpYmVyKG5vZGUpOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSk7CiAgICAgICAgICAgIHJldHVybiBpbmZvOwogICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgcmV0dXJuICJcbkVycm9yIGdlbmVyYXRpbmcgc3RhY2s6ICIgKyB4Mi5tZXNzYWdlICsgIlxuIiArIHgyLnN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lJDEob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIG91dGVyVHlwZS5kaXNwbGF5TmFtZSB8fCAoZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSQxKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlIENhY2hlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiQ2FjaGUiOwogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUkMShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJEZWh5ZHJhdGVkRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSQxKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICBjYXNlIEZyYWdtZW50MTA6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudDMgPSBudWxsOwogICAgICAgIHZhciBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBjdXJyZW50My5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChjdXJyZW50Myk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnQzID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudDMgPSBmaWJlcjsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUmVuZGVyaW5nKHJlbmRlcmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1JlbmRlcmluZyA9IHJlbmRlcmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUb1N0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGhhc1JlYWRPbmx5VmFsdWUgPSB7CiAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgICAgIGltYWdlOiB0cnVlLAogICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgICByZXNldDogdHJ1ZSwKICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcyh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIShoYXNSZWFkT25seVZhbHVlW3Byb3BzLnR5cGVdIHx8IHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLm9uSW5wdXQgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMudmFsdWUgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYHZhbHVlYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdFZhbHVlYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy5jaGVja2VkID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGBjaGVja2VkYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdENoZWNrZWRgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgIHZhciB0eXBlID0gZWxlbS50eXBlOwogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICh0eXBlID09PSAiY2hlY2tib3giIHx8IHR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaFRyYWNrZXIobm9kZSkgewogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDaGVja2FibGUobm9kZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLmNoZWNrZWQgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB2YWx1ZUZpZWxkKTsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9ICIiICsgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXQ2ID0gZGVzY3JpcHRvci5nZXQsIHNldDQgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Ni5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICBzZXQ0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgdHJhY2tlciA9IHsKICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGV0YWNoVHJhY2tlcihub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB0cmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFjayhub2RlKSB7CiAgICAgICAgICBpZiAoZ2V0VHJhY2tlcihub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRUcmFja2VyKG5vZGUpOwogICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpOwogICAgICAgICAgaWYgKG5leHRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnQoZG9jKSB7CiAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICBpZiAodHlwZW9mIGRvYyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZG9jLmFjdGl2ZUVsZW1lbnQgfHwgZG9jLmJvZHk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYm9keTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ29udHJvbGxlZChwcm9wcykgewogICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgcmV0dXJuIHVzZXNDaGVja2VkID8gcHJvcHMuY2hlY2tlZCAhPSBudWxsIDogcHJvcHMudmFsdWUgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzOS5DaGlsZHJlbi5mb3JFYWNoKHByb3BzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAic3RyaW5nIiB8fCB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaW5mZXIgdGhlIG9wdGlvbiB2YWx1ZSBvZiBjb21wbGV4IGNoaWxkcmVuLiBQYXNzIGEgYHZhbHVlYCBwcm9wIG9yIHVzZSBhIHBsYWluIHN0cmluZyBhcyBjaGlsZHJlbiB0byA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlBhc3MgYSBgdmFsdWVgIHByb3AgaWYgeW91IHNldCBkYW5nZXJvdXNseUlubmVySFRNTCBzbyBSZWFjdCBrbm93cyB3aGljaCB2YWx1ZSBzaG91bGQgYmUgc2VsZWN0ZWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5zZWxlY3RlZCAhPSBudWxsICYmICFkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbikgewogICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgb24gPHNlbGVjdD4gaW5zdGVhZCBvZiBzZXR0aW5nIGBzZWxlY3RlZGAgb24gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSkpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5Mihwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zMihub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBvcHRpb25zMiA9IG5vZGUub3B0aW9uczsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9wdGlvbnMyLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2ldLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRTZWxlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG9wdGlvbnMyLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgPT09IG51bGwgJiYgIW9wdGlvbnMyW19pMl0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZCA9IG9wdGlvbnMyW19pMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdFVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbml0aWFsVmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShpbml0aWFsVmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCAmJiBub2RlLmRlZmF1bHRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7CiAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRleHRDb250ZW50ICE9PSAiIiAmJiB0ZXh0Q29udGVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICB2YXIgTUFUSF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCI7CiAgICAgICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICByZXR1cm4gU1ZHX05BTUVTUEFDRTsKICAgICAgICAgICAgY2FzZSAibWF0aCI6CiAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50TmFtZXNwYWNlLCB0eXBlKSB7CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09IG51bGwgfHwgcGFyZW50TmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PT0gU1ZHX05BTUVTUEFDRSAmJiB0eXBlID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24gPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMCwgYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICAgIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciByZXVzYWJsZVNWR0NvbnRhaW5lcjsKICAgICAgICB2YXIgc2V0SW5uZXJIVE1MID0gY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgaWYgKCEoImlubmVySFRNTCIgaW4gbm9kZSkpIHsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lciA9IHJldXNhYmxlU1ZHQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgdmFyIHN2Z05vZGUgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHN2Z05vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdmdOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9KTsKICAgICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICB2YXIgRE9DVU1FTlRfTk9ERSA9IDk7CiAgICAgICAgdmFyIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgPSAxMTsKICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc2hvcnRoYW5kVG9Mb25naGFuZCA9IHsKICAgICAgICAgIGFuaW1hdGlvbjogWyJhbmltYXRpb25EZWxheSIsICJhbmltYXRpb25EaXJlY3Rpb24iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRmlsbE1vZGUiLCAiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiLCAiYW5pbWF0aW9uTmFtZSIsICJhbmltYXRpb25QbGF5U3RhdGUiLCAiYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246IFsiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIl0sCiAgICAgICAgICBib3JkZXI6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tTdGFydDogWyJib3JkZXJCbG9ja1N0YXJ0Q29sb3IiLCAiYm9yZGVyQmxvY2tTdGFydFN0eWxlIiwgImJvcmRlckJsb2NrU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgYm9yZGVySW1hZ2U6IFsiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVFbmQ6IFsiYm9yZGVySW5saW5lRW5kQ29sb3IiLCAiYm9yZGVySW5saW5lRW5kU3R5bGUiLCAiYm9yZGVySW5saW5lRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJMZWZ0OiBbImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJSYWRpdXM6IFsiYm9yZGVyQm90dG9tTGVmdFJhZGl1cyIsICJib3JkZXJCb3R0b21SaWdodFJhZGl1cyIsICJib3JkZXJUb3BMZWZ0UmFkaXVzIiwgImJvcmRlclRvcFJpZ2h0UmFkaXVzIl0sCiAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyU3R5bGU6IFsiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiXSwKICAgICAgICAgIGJvcmRlclRvcDogWyJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGNvbHVtblJ1bGU6IFsiY29sdW1uUnVsZUNvbG9yIiwgImNvbHVtblJ1bGVTdHlsZSIsICJjb2x1bW5SdWxlV2lkdGgiXSwKICAgICAgICAgIGNvbHVtbnM6IFsiY29sdW1uQ291bnQiLCAiY29sdW1uV2lkdGgiXSwKICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgIGZsZXhGbG93OiBbImZsZXhEaXJlY3Rpb24iLCAiZmxleFdyYXAiXSwKICAgICAgICAgIGZvbnQ6IFsiZm9udEZhbWlseSIsICJmb250RmVhdHVyZVNldHRpbmdzIiwgImZvbnRLZXJuaW5nIiwgImZvbnRMYW5ndWFnZU92ZXJyaWRlIiwgImZvbnRTaXplIiwgImZvbnRTaXplQWRqdXN0IiwgImZvbnRTdHJldGNoIiwgImZvbnRTdHlsZSIsICJmb250VmFyaWFudCIsICJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIiwgImZvbnRXZWlnaHQiLCAibGluZUhlaWdodCJdLAogICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgZ2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWQ6IFsiZ3JpZEF1dG9Db2x1bW5zIiwgImdyaWRBdXRvRmxvdyIsICJncmlkQXV0b1Jvd3MiLCAiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbjogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbkdhcDogWyJjb2x1bW5HYXAiXSwKICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFJvdzogWyJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZFJvd0dhcDogWyJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGxpc3RTdHlsZTogWyJsaXN0U3R5bGVJbWFnZSIsICJsaXN0U3R5bGVQb3NpdGlvbiIsICJsaXN0U3R5bGVUeXBlIl0sCiAgICAgICAgICBtYXJnaW46IFsibWFyZ2luQm90dG9tIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAibWFyZ2luVG9wIl0sCiAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgbWFzazogWyJtYXNrQ2xpcCIsICJtYXNrQ29tcG9zaXRlIiwgIm1hc2tJbWFnZSIsICJtYXNrTW9kZSIsICJtYXNrT3JpZ2luIiwgIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSIsICJtYXNrUmVwZWF0IiwgIm1hc2tTaXplIl0sCiAgICAgICAgICBtYXNrUG9zaXRpb246IFsibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIl0sCiAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICBvdmVyZmxvdzogWyJvdmVyZmxvd1giLCAib3ZlcmZsb3dZIl0sCiAgICAgICAgICBwYWRkaW5nOiBbInBhZGRpbmdCb3R0b20iLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiwgInBhZGRpbmdUb3AiXSwKICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgIHBsYWNlSXRlbXM6IFsiYWxpZ25JdGVtcyIsICJqdXN0aWZ5SXRlbXMiXSwKICAgICAgICAgIHBsYWNlU2VsZjogWyJhbGlnblNlbGYiLCAianVzdGlmeVNlbGYiXSwKICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgIHRleHRFbXBoYXNpczogWyJ0ZXh0RW1waGFzaXNDb2xvciIsICJ0ZXh0RW1waGFzaXNTdHlsZSJdLAogICAgICAgICAgdHJhbnNpdGlvbjogWyJ0cmFuc2l0aW9uRGVsYXkiLCAidHJhbnNpdGlvbkR1cmF0aW9uIiwgInRyYW5zaXRpb25Qcm9wZXJ0eSIsICJ0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgfTsKICAgICAgICB2YXIgaXNVbml0bGVzc051bWJlciA9IHsKICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgYXNwZWN0UmF0aW86IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZU91dHNldDogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVdpZHRoOiB0cnVlLAogICAgICAgICAgYm94RmxleDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgIGJveE9yZGluYWxHcm91cDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbkNvdW50OiB0cnVlLAogICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgIGZsZXg6IHRydWUsCiAgICAgICAgICBmbGV4R3JvdzogdHJ1ZSwKICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgICAgICBmbGV4TmVnYXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICBncmlkQXJlYTogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1NwYW46IHRydWUsCiAgICAgICAgICBncmlkUm93U3RhcnQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbkVuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgZm9udFdlaWdodDogdHJ1ZSwKICAgICAgICAgIGxpbmVDbGFtcDogdHJ1ZSwKICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICBvcGFjaXR5OiB0cnVlLAogICAgICAgICAgb3JkZXI6IHRydWUsCiAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgdGFiU2l6ZTogdHJ1ZSwKICAgICAgICAgIHdpZG93czogdHJ1ZSwKICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgIHpvb206IHRydWUsCiAgICAgICAgICAvLyBTVkctcmVsYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0b3BPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaG9mZnNldDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXgyICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeGVzMiA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlczIuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbjIoewogICAgICAgICAgbWVudWl0ZW06IHRydWUKICAgICAgICB9LCBvbWl0dGVkQ2xvc2VUYWdzKTsKICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgIGZ1bmN0aW9uIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm9pZEVsZW1lbnRUYWdzW3RhZ10pIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0YWcgKyAiIGlzIGEgdm9pZCBlbGVtZW50IHRhZyBhbmQgbXVzdCBuZWl0aGVyIGhhdmUgYGNoaWxkcmVuYCBub3IgdXNlIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSAib2JqZWN0IiB8fCAhKEhUTUwgaW4gcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJvcHMuc3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nICYmIHByb3BzLmNvbnRlbnRFZGl0YWJsZSAmJiBwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGBjb250ZW50RWRpdGFibGVgIGFuZCBjb250YWlucyBgY2hpbGRyZW5gIG1hbmFnZWQgYnkgUmVhY3QuIEl0IGlzIG5vdyB5b3VyIHJlc3BvbnNpYmlsaXR5IHRvIGd1YXJhbnRlZSB0aGF0IG5vbmUgb2YgdGhvc2Ugbm9kZXMgYXJlIHVuZXhwZWN0ZWRseSBtb2RpZmllZCBvciBkdXBsaWNhdGVkLiBUaGlzIGlzIHByb2JhYmx5IG5vdCBpbnRlbnRpb25hbC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnN0eWxlICE9IG51bGwgJiYgdHlwZW9mIHByb3BzLnN0eWxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIGlmICh0YWdOYW1lLmluZGV4T2YoIi0iKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyI7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgICAgICAgY2FzZSAiYW5ub3RhdGlvbi14bWwiOgogICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXNyYyI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtZm9ybWF0IjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLW5hbWUiOgogICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAvLyBIVE1MCiAgICAgICAgICBhY2NlcHQ6ICJhY2NlcHQiLAogICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgImFjY2VwdC1jaGFyc2V0IjogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgYWNjZXNza2V5OiAiYWNjZXNzS2V5IiwKICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICBhbGxvd2Z1bGxzY3JlZW46ICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgYWx0OiAiYWx0IiwKICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgYXN5bmM6ICJhc3luYyIsCiAgICAgICAgICBhdXRvY2FwaXRhbGl6ZTogImF1dG9DYXBpdGFsaXplIiwKICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICBhdXRvY29ycmVjdDogImF1dG9Db3JyZWN0IiwKICAgICAgICAgIGF1dG9mb2N1czogImF1dG9Gb2N1cyIsCiAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgIGF1dG9zYXZlOiAiYXV0b1NhdmUiLAogICAgICAgICAgY2FwdHVyZTogImNhcHR1cmUiLAogICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgIGNoYWxsZW5nZTogImNoYWxsZW5nZSIsCiAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICBjaGVja2VkOiAiY2hlY2tlZCIsCiAgICAgICAgICBjaGlsZHJlbjogImNoaWxkcmVuIiwKICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgIGNsYXNzOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNsYXNzaWQ6ICJjbGFzc0lEIiwKICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICBjb2xzOiAiY29scyIsCiAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiLAogICAgICAgICAgY29udGV4dG1lbnU6ICJjb250ZXh0TWVudSIsCiAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgIGNvbnRyb2xzbGlzdDogImNvbnRyb2xzTGlzdCIsCiAgICAgICAgICBjb29yZHM6ICJjb29yZHMiLAogICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICBkYW5nZXJvdXNseXNldGlubmVyaHRtbDogImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIGRhdGE6ICJkYXRhIiwKICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgZGVmYXVsdDogImRlZmF1bHQiLAogICAgICAgICAgZGVmYXVsdGNoZWNrZWQ6ICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgZGVmZXI6ICJkZWZlciIsCiAgICAgICAgICBkaXI6ICJkaXIiLAogICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICBkaXNhYmxlcGljdHVyZWlucGljdHVyZTogImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgIGRpc2FibGVyZW1vdGVwbGF5YmFjazogImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgIGRyYWdnYWJsZTogImRyYWdnYWJsZSIsCiAgICAgICAgICBlbmN0eXBlOiAiZW5jVHlwZSIsCiAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBmb3JtOiAiZm9ybSIsCiAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICBmb3JtYWN0aW9uOiAiZm9ybUFjdGlvbiIsCiAgICAgICAgICBmb3JtZW5jdHlwZTogImZvcm1FbmNUeXBlIiwKICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgZm9ybXRhcmdldDogImZvcm1UYXJnZXQiLAogICAgICAgICAgZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCiAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICBoZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgICAgaGlkZGVuOiAiaGlkZGVuIiwKICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgIGhyZWY6ICJocmVmIiwKICAgICAgICAgIGhyZWZsYW5nOiAiaHJlZkxhbmciLAogICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgaHR0cGVxdWl2OiAiaHR0cEVxdWl2IiwKICAgICAgICAgICJodHRwLWVxdWl2IjogImh0dHBFcXVpdiIsCiAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgIGltYWdlc2l6ZXM6ICJpbWFnZVNpemVzIiwKICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgaW5uZXJodG1sOiAiaW5uZXJIVE1MIiwKICAgICAgICAgIGlucHV0bW9kZTogImlucHV0TW9kZSIsCiAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgaXM6ICJpcyIsCiAgICAgICAgICBpdGVtaWQ6ICJpdGVtSUQiLAogICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICBpdGVtcmVmOiAiaXRlbVJlZiIsCiAgICAgICAgICBpdGVtc2NvcGU6ICJpdGVtU2NvcGUiLAogICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICBrZXlwYXJhbXM6ICJrZXlQYXJhbXMiLAogICAgICAgICAga2V5dHlwZTogImtleVR5cGUiLAogICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgbGFiZWw6ICJsYWJlbCIsCiAgICAgICAgICBsYW5nOiAibGFuZyIsCiAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICBsb29wOiAibG9vcCIsCiAgICAgICAgICBsb3c6ICJsb3ciLAogICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICBtYXJnaW53aWR0aDogIm1hcmdpbldpZHRoIiwKICAgICAgICAgIG1hcmdpbmhlaWdodDogIm1hcmdpbkhlaWdodCIsCiAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKICAgICAgICAgIG1lZGlhOiAibWVkaWEiLAogICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgbWV0aG9kOiAibWV0aG9kIiwKICAgICAgICAgIG1pbjogIm1pbiIsCiAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgbXVsdGlwbGU6ICJtdWx0aXBsZSIsCiAgICAgICAgICBtdXRlZDogIm11dGVkIiwKICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgIG5vbW9kdWxlOiAibm9Nb2R1bGUiLAogICAgICAgICAgbm9uY2U6ICJub25jZSIsCiAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICBvcGVuOiAib3BlbiIsCiAgICAgICAgICBvcHRpbXVtOiAib3B0aW11bSIsCiAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICBwbGFjZWhvbGRlcjogInBsYWNlaG9sZGVyIiwKICAgICAgICAgIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiLAogICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgIHByZWxvYWQ6ICJwcmVsb2FkIiwKICAgICAgICAgIHByb2ZpbGU6ICJwcm9maWxlIiwKICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgcmVmZXJyZXJwb2xpY3k6ICJyZWZlcnJlclBvbGljeSIsCiAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgcmVxdWlyZWQ6ICJyZXF1aXJlZCIsCiAgICAgICAgICByZXZlcnNlZDogInJldmVyc2VkIiwKICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgIHJvd3M6ICJyb3dzIiwKICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgIHNjb3BlOiAic2NvcGUiLAogICAgICAgICAgc2NvcGVkOiAic2NvcGVkIiwKICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICBzZWFtbGVzczogInNlYW1sZXNzIiwKICAgICAgICAgIHNlbGVjdGVkOiAic2VsZWN0ZWQiLAogICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICBzaXplOiAic2l6ZSIsCiAgICAgICAgICBzaXplczogInNpemVzIiwKICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgIHNwZWxsY2hlY2s6ICJzcGVsbENoZWNrIiwKICAgICAgICAgIHNyYzogInNyYyIsCiAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgc3JjbGFuZzogInNyY0xhbmciLAogICAgICAgICAgc3Jjc2V0OiAic3JjU2V0IiwKICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgc3RlcDogInN0ZXAiLAogICAgICAgICAgc3R5bGU6ICJzdHlsZSIsCiAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgIHRhcmdldDogInRhcmdldCIsCiAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgIHdpZHRoOiAid2lkdGgiLAogICAgICAgICAgd21vZGU6ICJ3bW9kZSIsCiAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAvLyBTVkcKICAgICAgICAgIGFib3V0OiAiYWJvdXQiLAogICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IjogImFjY2VudEhlaWdodCIsCiAgICAgICAgICBhY2N1bXVsYXRlOiAiYWNjdW11bGF0ZSIsCiAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgIGFsaWdubWVudGJhc2VsaW5lOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSI6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgYWxwaGFiZXRpYzogImFscGhhYmV0aWMiLAogICAgICAgICAgYW1wbGl0dWRlOiAiYW1wbGl0dWRlIiwKICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSI6ICJhcmFiaWNGb3JtIiwKICAgICAgICAgIGFzY2VudDogImFzY2VudCIsCiAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICBhdHRyaWJ1dGV0eXBlOiAiYXR0cmlidXRlVHlwZSIsCiAgICAgICAgICBhdXRvcmV2ZXJzZTogImF1dG9SZXZlcnNlIiwKICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgIGJhc2VmcmVxdWVuY3k6ICJiYXNlRnJlcXVlbmN5IiwKICAgICAgICAgIGJhc2VsaW5lc2hpZnQ6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgIGJhc2Vwcm9maWxlOiAiYmFzZVByb2ZpbGUiLAogICAgICAgICAgYmJveDogImJib3giLAogICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICBiaWFzOiAiYmlhcyIsCiAgICAgICAgICBieTogImJ5IiwKICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgY2FwaGVpZ2h0OiAiY2FwSGVpZ2h0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IjogImNhcEhlaWdodCIsCiAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICBjbGlwcGF0aDogImNsaXBQYXRoIiwKICAgICAgICAgICJjbGlwLXBhdGgiOiAiY2xpcFBhdGgiLAogICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgY2xpcHJ1bGU6ICJjbGlwUnVsZSIsCiAgICAgICAgICAiY2xpcC1ydWxlIjogImNsaXBSdWxlIiwKICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIjogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgY29sb3Jwcm9maWxlOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICBjb2xvcnJlbmRlcmluZzogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICBjb250ZW50c3R5bGV0eXBlOiAiY29udGVudFN0eWxlVHlwZSIsCiAgICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICBjeTogImN5IiwKICAgICAgICAgIGQ6ICJkIiwKICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgZGVjZWxlcmF0ZTogImRlY2VsZXJhdGUiLAogICAgICAgICAgZGVzY2VudDogImRlc2NlbnQiLAogICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgIGRpcmVjdGlvbjogImRpcmVjdGlvbiIsCiAgICAgICAgICBkaXNwbGF5OiAiZGlzcGxheSIsCiAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICBkb21pbmFudGJhc2VsaW5lOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgZHg6ICJkeCIsCiAgICAgICAgICBkeTogImR5IiwKICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgZWxldmF0aW9uOiAiZWxldmF0aW9uIiwKICAgICAgICAgIGVuYWJsZWJhY2tncm91bmQ6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgIGVuZDogImVuZCIsCiAgICAgICAgICBleHBvbmVudDogImV4cG9uZW50IiwKICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgIGZpbGw6ICJmaWxsIiwKICAgICAgICAgIGZpbGxvcGFjaXR5OiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICBmaWxscnVsZTogImZpbGxSdWxlIiwKICAgICAgICAgICJmaWxsLXJ1bGUiOiAiZmlsbFJ1bGUiLAogICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgIGZpbHRlcnJlczogImZpbHRlclJlcyIsCiAgICAgICAgICBmaWx0ZXJ1bml0czogImZpbHRlclVuaXRzIiwKICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSI6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgZmxvb2Rjb2xvcjogImZsb29kQ29sb3IiLAogICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgZm9jdXNhYmxlOiAiZm9jdXNhYmxlIiwKICAgICAgICAgIGZvbnRmYW1pbHk6ICJmb250RmFtaWx5IiwKICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgIGZvbnRzaXplOiAiZm9udFNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZSI6ICJmb250U2l6ZSIsCiAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IjogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgIGZvbnRzdHJldGNoOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICBmb250c3R5bGU6ICJmb250U3R5bGUiLAogICAgICAgICAgImZvbnQtc3R5bGUiOiAiZm9udFN0eWxlIiwKICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgImZvbnQtdmFyaWFudCI6ICJmb250VmFyaWFudCIsCiAgICAgICAgICBmb250d2VpZ2h0OiAiZm9udFdlaWdodCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICBmb3JtYXQ6ICJmb3JtYXQiLAogICAgICAgICAgZnJvbTogImZyb20iLAogICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICBmeTogImZ5IiwKICAgICAgICAgIGcxOiAiZzEiLAogICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICBnbHlwaG5hbWU6ICJnbHlwaE5hbWUiLAogICAgICAgICAgImdseXBoLW5hbWUiOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbnZlcnRpY2FsOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgZ2x5cGhyZWY6ICJnbHlwaFJlZiIsCiAgICAgICAgICBncmFkaWVudHRyYW5zZm9ybTogImdyYWRpZW50VHJhbnNmb3JtIiwKICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgIGhhbmdpbmc6ICJoYW5naW5nIiwKICAgICAgICAgIGhvcml6YWR2eDogImhvcml6QWR2WCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgIGhvcml6b3JpZ2lueDogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiOiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgaW1hZ2VyZW5kZXJpbmc6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIjogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICBpbjogImluIiwKICAgICAgICAgIGlubGlzdDogImlubGlzdCIsCiAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgazE6ICJrMSIsCiAgICAgICAgICBrMjogImsyIiwKICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgazQ6ICJrNCIsCiAgICAgICAgICBrOiAiayIsCiAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAga2VybmVsdW5pdGxlbmd0aDogImtlcm5lbFVuaXRMZW5ndGgiLAogICAgICAgICAga2VybmluZzogImtlcm5pbmciLAogICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgIGtleXNwbGluZXM6ICJrZXlTcGxpbmVzIiwKICAgICAgICAgIGtleXRpbWVzOiAia2V5VGltZXMiLAogICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgIGxldHRlcnNwYWNpbmc6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyI6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciI6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgIGxpbWl0aW5nY29uZWFuZ2xlOiAibGltaXRpbmdDb25lQW5nbGUiLAogICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICBtYXJrZXJlbmQ6ICJtYXJrZXJFbmQiLAogICAgICAgICAgIm1hcmtlci1lbmQiOiAibWFya2VyRW5kIiwKICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICBtYXJrZXJtaWQ6ICJtYXJrZXJNaWQiLAogICAgICAgICAgIm1hcmtlci1taWQiOiAibWFya2VyTWlkIiwKICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCI6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICBtYXJrZXJ1bml0czogIm1hcmtlclVuaXRzIiwKICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgbWFzazogIm1hc2siLAogICAgICAgICAgbWFza2NvbnRlbnR1bml0czogIm1hc2tDb250ZW50VW5pdHMiLAogICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgIG1hdGhlbWF0aWNhbDogIm1hdGhlbWF0aWNhbCIsCiAgICAgICAgICBtb2RlOiAibW9kZSIsCiAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICBvZmZzZXQ6ICJvZmZzZXQiLAogICAgICAgICAgb3BhY2l0eTogIm9wYWNpdHkiLAogICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICBvcmRlcjogIm9yZGVyIiwKICAgICAgICAgIG9yaWVudDogIm9yaWVudCIsCiAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgIG9yaWdpbjogIm9yaWdpbiIsCiAgICAgICAgICBvdmVyZmxvdzogIm92ZXJmbG93IiwKICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiI6ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIG92ZXJsaW5ldGhpY2tuZXNzOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICBwYWludG9yZGVyOiAicGFpbnRPcmRlciIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiOiAicGFpbnRPcmRlciIsCiAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAicGFub3NlLTEiOiAicGFub3NlMSIsCiAgICAgICAgICBwYXRobGVuZ3RoOiAicGF0aExlbmd0aCIsCiAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICBwYXR0ZXJudHJhbnNmb3JtOiAicGF0dGVyblRyYW5zZm9ybSIsCiAgICAgICAgICBwYXR0ZXJudW5pdHM6ICJwYXR0ZXJuVW5pdHMiLAogICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIjogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgcG9pbnRzOiAicG9pbnRzIiwKICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICBwb2ludHNhdHk6ICJwb2ludHNBdFkiLAogICAgICAgICAgcG9pbnRzYXR6OiAicG9pbnRzQXRaIiwKICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICBwcmVzZXJ2ZWFscGhhOiAicHJlc2VydmVBbHBoYSIsCiAgICAgICAgICBwcmVzZXJ2ZWFzcGVjdHJhdGlvOiAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgIHByb3BlcnR5OiAicHJvcGVydHkiLAogICAgICAgICAgcjogInIiLAogICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgIHJlZng6ICJyZWZYIiwKICAgICAgICAgIHJlZnk6ICJyZWZZIiwKICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCI6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgcmVwZWF0Y291bnQ6ICJyZXBlYXRDb3VudCIsCiAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgcmVxdWlyZWRleHRlbnNpb25zOiAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAgICAgICAgIHJlcXVpcmVkZmVhdHVyZXM6ICJyZXF1aXJlZEZlYXR1cmVzIiwKICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgcmVzdGFydDogInJlc3RhcnQiLAogICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgIHJvdGF0ZTogInJvdGF0ZSIsCiAgICAgICAgICByeDogInJ4IiwKICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgc2NhbGU6ICJzY2FsZSIsCiAgICAgICAgICBzZWN1cml0eTogInNlY3VyaXR5IiwKICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgIHNoYXBlcmVuZGVyaW5nOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyI6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgIHNwYWNpbmc6ICJzcGFjaW5nIiwKICAgICAgICAgIHNwZWN1bGFyY29uc3RhbnQ6ICJzcGVjdWxhckNvbnN0YW50IiwKICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgIHNwZWVkOiAic3BlZWQiLAogICAgICAgICAgc3ByZWFkbWV0aG9kOiAic3ByZWFkTWV0aG9kIiwKICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgc3RkZGV2aWF0aW9uOiAic3RkRGV2aWF0aW9uIiwKICAgICAgICAgIHN0ZW1oOiAic3RlbWgiLAogICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICBzdGl0Y2h0aWxlczogInN0aXRjaFRpbGVzIiwKICAgICAgICAgIHN0b3Bjb2xvcjogInN0b3BDb2xvciIsCiAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgc3RvcG9wYWNpdHk6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IjogInN0b3BPcGFjaXR5IiwKICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiI6ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgc3RyaWtldGhyb3VnaHRoaWNrbmVzczogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgc3RyaW5nOiAic3RyaW5nIiwKICAgICAgICAgIHN0cm9rZTogInN0cm9rZSIsCiAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiOiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgIHN0cm9rZWRhc2hvZmZzZXQ6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgIHN0cm9rZWxpbmVjYXA6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCI6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICBzdHJva2VtaXRlcmxpbWl0OiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICBzdHJva2V3aWR0aDogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IjogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgc3VwcHJlc3Njb250ZW50ZWRpdGFibGV3YXJuaW5nOiAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICBzdXJmYWNlc2NhbGU6ICJzdXJmYWNlU2NhbGUiLAogICAgICAgICAgc3lzdGVtbGFuZ3VhZ2U6ICJzeXN0ZW1MYW5ndWFnZSIsCiAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgIHRhcmdldHg6ICJ0YXJnZXRYIiwKICAgICAgICAgIHRhcmdldHk6ICJ0YXJnZXRZIiwKICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciI6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgIHRleHRkZWNvcmF0aW9uOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICB0ZXh0bGVuZ3RoOiAidGV4dExlbmd0aCIsCiAgICAgICAgICB0ZXh0cmVuZGVyaW5nOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICB0bzogInRvIiwKICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zZm9ybSIsCiAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgdTE6ICJ1MSIsCiAgICAgICAgICB1MjogInUyIiwKICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiI6ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICB1bmRlcmxpbmV0aGlja25lc3M6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHVuaWNvZGU6ICJ1bmljb2RlIiwKICAgICAgICAgIHVuaWNvZGViaWRpOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICB1bmljb2RlcmFuZ2U6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICB1bnNlbGVjdGFibGU6ICJ1bnNlbGVjdGFibGUiLAogICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1hbHBoYWJldGljIjogInZBbHBoYWJldGljIiwKICAgICAgICAgIHZhbHVlczogInZhbHVlcyIsCiAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiOiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgIHZlcnNpb246ICJ2ZXJzaW9uIiwKICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgInZlcnQtYWR2LXkiOiAidmVydEFkdlkiLAogICAgICAgICAgdmVydG9yaWdpbng6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueTogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IjogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgInYtaGFuZ2luZyI6ICJ2SGFuZ2luZyIsCiAgICAgICAgICB2aWRlb2dyYXBoaWM6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgIHZpZXdib3g6ICJ2aWV3Qm94IiwKICAgICAgICAgIHZpZXd0YXJnZXQ6ICJ2aWV3VGFyZ2V0IiwKICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgIHZtYXRoZW1hdGljYWw6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCI6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgd2lkdGhzOiAid2lkdGhzIiwKICAgICAgICAgIHdvcmRzcGFjaW5nOiAid29yZFNwYWNpbmciLAogICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICB3cml0aW5nbW9kZTogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICB4MjogIngyIiwKICAgICAgICAgIHg6ICJ4IiwKICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHhoZWlnaHQ6ICJ4SGVpZ2h0IiwKICAgICAgICAgICJ4LWhlaWdodCI6ICJ4SGVpZ2h0IiwKICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSI6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgeGxpbmthcmNyb2xlOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICB4bGlua2hyZWY6ICJ4bGlua0hyZWYiLAogICAgICAgICAgInhsaW5rOmhyZWYiOiAieGxpbmtIcmVmIiwKICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSI6ICJ4bGlua1JvbGUiLAogICAgICAgICAgeGxpbmtzaG93OiAieGxpbmtTaG93IiwKICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICB4bGlua3RpdGxlOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICAieGxpbms6dGl0bGUiOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiOiAieGxpbmtUeXBlIiwKICAgICAgICAgIHhtbGJhc2U6ICJ4bWxCYXNlIiwKICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgIHhtbGxhbmc6ICJ4bWxMYW5nIiwKICAgICAgICAgICJ4bWw6bGFuZyI6ICJ4bWxMYW5nIiwKICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgInhtbDpzcGFjZSI6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB4bWxuc3hsaW5rOiAieG1sbnNYbGluayIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICB4bWxzcGFjZTogInhtbFNwYWNlIiwKICAgICAgICAgIHkxOiAieTEiLAogICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICB5OiAieSIsCiAgICAgICAgICB5Y2hhbm5lbHNlbGVjdG9yOiAieUNoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB6OiAieiIsCiAgICAgICAgICB6b29tYW5kcGFuOiAiem9vbUFuZFBhbiIKICAgICAgICB9OwogICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICJhcmlhLWN1cnJlbnQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICJhcmlhLWRldGFpbHMiOiAwLAogICAgICAgICAgImFyaWEtZGlzYWJsZWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWhpZGRlbiI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEta2V5c2hvcnRjdXRzIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICJhcmlhLXJvbGVkZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAvLyBXaWRnZXQgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICJhcmlhLWNoZWNrZWQiOiAwLAogICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAwLAogICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgImFyaWEtbGV2ZWwiOiAwLAogICAgICAgICAgImFyaWEtbW9kYWwiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpc2VsZWN0YWJsZSI6IDAsCiAgICAgICAgICAiYXJpYS1vcmllbnRhdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAiYXJpYS1wcmVzc2VkIjogMCwKICAgICAgICAgICJhcmlhLXJlYWRvbmx5IjogMCwKICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICJhcmlhLXNlbGVjdGVkIjogMCwKICAgICAgICAgICJhcmlhLXNvcnQiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVub3ciOiAwLAogICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgIC8vIExpdmUgUmVnaW9uIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF0b21pYyI6IDAsCiAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICJhcmlhLWxpdmUiOiAwLAogICAgICAgICAgImFyaWEtcmVsZXZhbnQiOiAwLAogICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1kcm9wZWZmZWN0IjogMCwKICAgICAgICAgICJhcmlhLWdyYWJiZWQiOiAwLAogICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiOiAwLAogICAgICAgICAgImFyaWEtY29sY291bnQiOiAwLAogICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtY29sc3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1jb250cm9scyI6IDAsCiAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1lcnJvcm1lc3NhZ2UiOiAwLAogICAgICAgICAgImFyaWEtZmxvd3RvIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgImFyaWEtb3ducyI6IDAsCiAgICAgICAgICAiYXJpYS1wb3NpbnNldCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dzcGFuIjogMCwKICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciByQVJJQUNhbWVsID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHkodGFnTmFtZSwgbmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBQ2FtZWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBhcmlhTmFtZSA9ICJhcmlhLSIgKyBuYW1lLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChjb3JyZWN0TmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBBUklBIGF0dHJpYnV0ZXMgZm9sbG93IHRoZSBwYXR0ZXJuIGFyaWEtKiBhbmQgbXVzdCBiZSBsb3dlcmNhc2UuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIGNvcnJlY3ROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBsb3dlckNhc2VkTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IHN0YW5kYXJkTmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGludmFsaWRQcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkodHlwZSwga2V5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGludmFsaWRQcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IGludmFsaWRQcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVOdWxsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICJpbnB1dCIgJiYgdHlwZSAhPT0gInRleHRhcmVhIiAmJiB0eXBlICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZU51bGwgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IiAmJiBwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgYXJyYXkgd2hlbiBgbXVsdGlwbGVgIGlzIHNldCB0byBgdHJ1ZWAgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMkMSA9IHt9OwogICAgICAgICAgdmFyIEVWRU5UX05BTUVfUkVHRVggPSAvXm9uLi87CiAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICB2YXIgckFSSUEkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMkMSwgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllcyQxW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3VzaW4iIHx8IGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c291dCIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50UmVnaXN0cnkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMiA9IGV2ZW50UmVnaXN0cnkucmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIgPSBldmVudFJlZ2lzdHJ5LnBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXM7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gSXQgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gUmVhY3QgZXZlbnRzIHVzZSB0aGUgY2FtZWxDYXNlIG5hbWluZyBjb252ZW50aW9uLCBmb3IgZXhhbXBsZSBgb25DbGlja2AuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICBlcnJvcigiRGlyZWN0bHkgc2V0dGluZyBwcm9wZXJ0eSBgaW5uZXJIVE1MYCBpcyBub3QgcGVybWl0dGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgbG9va3VwIGRvY3VtZW50YXRpb24gb24gYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImFyaWEiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpcyIgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGEgYCVzYCBmb3IgYSBzdHJpbmcgYXR0cmlidXRlIGBpc2AuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIHR5cGVvZiB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgTmFOIGZvciB0aGUgYCVzYCBhdHRyaWJ1dGUuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIG5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICBpZiAocG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIERPTSBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZCAmJiBuYW1lICE9PSBsb3dlckNhc2VkTmFtZSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgJiYgc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzUmVzZXJ2ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gImZhbHNlIiB8fCB2YWx1ZSA9PT0gInRydWUiKSAmJiBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24odHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkkMSh0eXBlLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgdW5rbm93blByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gdW5rbm93blByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWVzIGZvciBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSB0aGVtIGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgdGhlbSBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpOwogICAgICAgIH0KICAgICAgICB2YXIgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgPSAxOwogICAgICAgIHZhciBJU19OT05fREVMRUdBVEVEID0gMSA8PCAxOwogICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgIHZhciBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUyA9IElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFIHwgSVNfTk9OX0RFTEVHQVRFRCB8IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgdmFyIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFJlcGxheWluZ0V2ZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gbm90IGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudCA9PT0gY3VycmVudFJlcGxheWluZ0V2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldCB8fCBuYXRpdmVFdmVudC5zcmNFbGVtZW50IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlSW1wbCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICBpZiAoIWludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN0b3JlSW1wbCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbigpIG5lZWRzIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSkgewogICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICByZXN0b3JlSW1wbChpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBfcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oaW1wbCkgewogICAgICAgICAgcmVzdG9yZUltcGwgPSBpbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCkgewogICAgICAgICAgaWYgKHJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgcmV0dXJuIHJlc3RvcmVUYXJnZXQgIT09IG51bGwgfHwgcmVzdG9yZVF1ZXVlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcmVzdG9yZVRhcmdldDsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXRzID0gcmVzdG9yZVF1ZXVlOwogICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgdmFyIGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzID0gbmVlZHNTdGF0ZVJlc3RvcmUoKTsKICAgICAgICAgIGlmIChjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcykgewogICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzKGZuLCBhLCBiKSB7CiAgICAgICAgICBpZiAoaXNJbnNpZGVFdmVudEhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIpOwogICAgICAgICAgfQogICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGJhdGNoZWRVcGRhdGVzSW1wbChmbiwgYSwgYik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICBmaW5pc2hFdmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihfYmF0Y2hlZFVwZGF0ZXNJbXBsLCBfZGlzY3JldGVVcGRhdGVzSW1wbCwgX2ZsdXNoU3luY0ltcGwpIHsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzSW1wbCA9IF9iYXRjaGVkVXBkYXRlc0ltcGw7CiAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZXJhY3RpdmUodGFnKSB7CiAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRW50ZXIiOgogICAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIyICYmIHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBgIiArIHJlZ2lzdHJhdGlvbk5hbWUgKyAiYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAiICsgdHlwZW9mIGxpc3RlbmVyMiArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdGlvbnMsICJwYXNzaXZlIiwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZDsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kaXNwYXRjaEV2ZW50ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGRvY3VtZW50LmNyZWF0ZUV2ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmYWtlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInJlYWN0Iik7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tEZXYobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgZG9jdW1lbnRgIGdsb2JhbCB3YXMgZGVmaW5lZCB3aGVuIFJlYWN0IHdhcyBpbml0aWFsaXplZCwgYnV0IGlzIG5vdCBkZWZpbmVkIGFueW1vcmUuIFRoaXMgY2FuIGhhcHBlbiBpbiBhIHRlc3QgZW52aXJvbm1lbnQgaWYgYSBjb21wb25lbnQgc2NoZWR1bGVzIGFuIHVwZGF0ZSBmcm9tIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjaywgYnV0IHRoZSB0ZXN0IGhhcyBhbHJlYWR5IGZpbmlzaGVkIHJ1bm5pbmcuIFRvIHNvbHZlIHRoaXMsIHlvdSBjYW4gZWl0aGVyIHVubW91bnQgdGhlIGNvbXBvbmVudCBhdCB0aGUgZW5kIG9mIHlvdXIgdGVzdCAoYW5kIGVuc3VyZSB0aGF0IGFueSBhc3luY2hyb25vdXMgb3BlcmF0aW9ucyBnZXQgY2FuY2VsZWQgaW4gYGNvbXBvbmVudFdpbGxVbm1vdW50YCksIG9yIHlvdSBjYW4gY2hhbmdlIHRoZSB0ZXN0IGl0c2VsZiB0byBiZSBhc3luY2hyb25vdXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnQiKTsKICAgICAgICAgICAgICB2YXIgZGlkQ2FsbCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudERlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbmRvdywgImV2ZW50Iik7CiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUFmdGVyRGlzcGF0Y2goKSB7CiAgICAgICAgICAgICAgICBmYWtlTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LmV2ZW50ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuaGFzT3duUHJvcGVydHkoImV2ZW50IikpIHsKICAgICAgICAgICAgICAgICAgd2luZG93LmV2ZW50ID0gd2luZG93RXZlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrMigpIHsKICAgICAgICAgICAgICAgIGRpZENhbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgICAgICAgZGlkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICB2YXIgZGlkU2V0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgaXNDcm9zc09yaWdpbkVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlV2luZG93RXJyb3IoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IGV2ZW50LmVycm9yOwogICAgICAgICAgICAgICAgZGlkU2V0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGVycm9yMiA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgaXNDcm9zc09yaWdpbkVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiB0eXBlb2YgZXJyb3IyID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoaW5uZXIpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dFR5cGUgPSAicmVhY3QtIiArIChuYW1lID8gbmFtZSA6ICJpbnZva2VndWFyZGVkY2FsbGJhY2siKTsKICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgZmFrZU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIGZha2VOb2RlLmRpc3BhdGNoRXZlbnQoZXZ0KTsKICAgICAgICAgICAgICBpZiAod2luZG93RXZlbnREZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAiZXZlbnQiLCB3aW5kb3dFdmVudERlc2NyaXB0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkQ2FsbCAmJiBkaWRFcnJvcikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTZXRFcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoYEFuIGVycm9yIHdhcyB0aHJvd24gaW5zaWRlIG9uZSBvZiB5b3VyIGNvbXBvbmVudHMsIGJ1dCBSZWFjdCBkb2Vzbid0IGtub3cgd2hhdCBpdCB3YXMuIFRoaXMgaXMgbGlrZWx5IGR1ZSB0byBicm93c2VyIGZsYWtpbmVzcy4gUmVhY3QgZG9lcyBpdHMgYmVzdCB0byBwcmVzZXJ2ZSB0aGUgIlBhdXNlIG9uIGV4Y2VwdGlvbnMiIGJlaGF2aW9yIG9mIHRoZSBEZXZUb29scywgd2hpY2ggcmVxdWlyZXMgc29tZSBERVYtbW9kZSBvbmx5IHRyaWNrcy4gSXQncyBwb3NzaWJsZSB0aGF0IHRoZXNlIGRvbid0IHdvcmsgaW4geW91ciBicm93c2VyLiBUcnkgdHJpZ2dlcmluZyB0aGUgZXJyb3IgaW4gcHJvZHVjdGlvbiBtb2RlLCBvciBzd2l0Y2hpbmcgdG8gYSBtb2Rlcm4gYnJvd3Nlci4gSWYgeW91IHN1c3BlY3QgdGhhdCB0aGlzIGlzIGFjdHVhbGx5IGFuIGlzc3VlIHdpdGggUmVhY3QsIHBsZWFzZSBmaWxlIGFuIGlzc3VlLmApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Nyb3NzT3JpZ2luRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJBIGNyb3NzLW9yaWdpbiBlcnJvciB3YXMgdGhyb3duLiBSZWFjdCBkb2Vzbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0IGluIGRldmVsb3BtZW50LiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Nyb3Nzb3JpZ2luLWVycm9yIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBpZiAoIWRpZENhbGwpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMSA9IGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGw7CiAgICAgICAgdmFyIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIHJlcG9ydGVyID0gewogICAgICAgICAgb25FcnJvcjogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgIGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgIGlmICghaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgICAgaGFzUmV0aHJvd0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICByZXRocm93RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gcmV0aHJvd0Vycm9yOwogICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBoYXNFcnJvcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gY2F1Z2h0RXJyb3I7CiAgICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGVycm9yMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2xlYXJDYXVnaHRFcnJvciB3YXMgY2FsbGVkIGJ1dCBubyBlcnJvciB3YXMgY2FwdHVyZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldDUoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5Ll9yZWFjdEludGVybmFsczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzMyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldDMoa2V5LCB2YWx1ZSkgewogICAgICAgICAga2V5Ll9yZWFjdEludGVybmFscyA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgUGVyZm9ybWVkV29yayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUGxhY2VtZW50ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgVXBkYXRlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgQ2hpbGREZWxldGlvbiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIENvbnRlbnRSZXNldCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBDYWxsYmFjayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGlkQ2FwdHVyZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZUNsaWVudFJlbmRlciA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZjIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFNuYXBzaG90ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFZpc2liaWxpdHkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFN0b3JlQ29uc2lzdGVuY3kgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmMiB8IEh5ZHJhdGluZyB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIExheW91dE1hc2sgPSBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZjIgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgIHZhciBTdGF0aWNNYXNrID0gTGF5b3V0U3RhdGljIHwgUGFzc2l2ZVN0YXRpYyB8IFJlZlN0YXRpYzsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZmliZXI7CiAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgIGlmICgobm9kZS5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgbmVhcmVzdE1vdW50ZWQgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKG5vZGUucmV0dXJuKSB7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRhaW5lckZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgPyBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01vdW50ZWQoY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyRmliZXIpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbjIoe30sIGludGVybmFscywgewogICAgICAgICAgICAgICAgZ2V0TGFuZUxhYmVsTWFwLAogICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzKTsKICAgICAgICAgICAgaW5qZWN0ZWRIb29rID0gaG9vazsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMuIiwgZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhvb2suY2hlY2tEQ0UpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uU2NoZWR1bGVSb290KHJvb3QzLCBjaGlsZHJlbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdChyZW5kZXJlcklELCByb290MywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290KHJvb3QzLCBldmVudFByaW9yaXR5KSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSAocm9vdDMuY3VycmVudC5mbGFncyAmIERpZENhcHR1cmUpID09PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyKSB7CiAgICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgSWRsZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgc2NoZWR1bGVyUHJpb3JpdHksIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCB2b2lkIDAsIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uUG9zdENvbW1pdFJvb3Qocm9vdDMpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRVbm1vdW50KGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQocmVuZGVyZXJJRCwgZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhuZXdJc1N0cmljdE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB1bnN0YWJsZV95aWVsZFZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICBzZXRTdXBwcmVzc1dhcm5pbmcobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZShyZW5kZXJlcklELCBuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmplY3RQcm9maWxpbmdIb29rcyhwcm9maWxpbmdIb29rcykgewogICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcyA9IHByb2ZpbGluZ0hvb2tzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMYW5lTGFiZWxNYXAoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxOwogICAgICAgICAgICBmb3IgKHZhciBpbmRleDIgPSAwOyBpbmRleDIgPCBUb3RhbExhbmVzOyBpbmRleDIrKykgewogICAgICAgICAgICAgIHZhciBsYWJlbCA9IGdldExhYmVsRm9yTGFuZShsYW5lKTsKICAgICAgICAgICAgICBtYXAzLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXAzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJZaWVsZGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIENvbmN1cnJlbnRNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUHJvZmlsZU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RMZWdhY3lNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdEVmZmVjdHNNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIGNsejMyID0gTWF0aC5jbHozMiA/IE1hdGguY2x6MzIgOiBjbHozMkZhbGxiYWNrOwogICAgICAgIHZhciBsb2cyID0gTWF0aC5sb2c7CiAgICAgICAgdmFyIExOMiA9IE1hdGguTE4yOwogICAgICAgIGZ1bmN0aW9uIGNsejMyRmFsbGJhY2soeDIpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4MiA+Pj4gMDsKICAgICAgICAgIGlmIChhc1VpbnQgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIDMyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDMxIC0gKGxvZzIoYXNVaW50KSAvIExOMiB8IDApIHwgMDsKICAgICAgICB9CiAgICAgICAgdmFyIFRvdGFsTGFuZXMgPSAzMTsKICAgICAgICB2YXIgTm9MYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBOb0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBTeW5jTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0SHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0TGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQyNDAKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU3ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTAgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjIxNDQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MjQyODgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMwMDIzNDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjc3NzIxNgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjcxMDg4NjQKICAgICAgICApOwogICAgICAgIHZhciBTb21lUmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICB2YXIgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICovCiAgICAgICAgICAxMzQyMTc3MjgKICAgICAgICApOwogICAgICAgIHZhciBOb25JZGxlTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NQogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMjY4NDM1NDU2CiAgICAgICAgKTsKICAgICAgICB2YXIgSWRsZUxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MzY4NzA5MTIKICAgICAgICApOwogICAgICAgIHZhciBPZmZzY3JlZW5MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNzM3NDE4MjQKICAgICAgICApOwogICAgICAgIGZ1bmN0aW9uIGdldExhYmVsRm9yTGFuZShsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChsYW5lICYgU3luY0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlN5bmMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91cyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0SHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdEh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0TGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbkh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgUmV0cnlMYW5lcykgewogICAgICAgICAgICAgIHJldHVybiAiUmV0cnkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiU2VsZWN0aXZlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vVGltZXN0YW1wID0gLTE7CiAgICAgICAgdmFyIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICB2YXIgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykpIHsKICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdExhbmU7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzOwogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBSZXRyeUxhbmVzOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlTGFuZTsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0TGFuZXMocm9vdDMsIHdpcExhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHBlbmRpbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBub25JZGxlUGVuZGluZ0xhbmVzID0gcGVuZGluZ0xhbmVzICYgTm9uSWRsZUxhbmVzOwogICAgICAgICAgaWYgKG5vbklkbGVQZW5kaW5nTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIG5vbklkbGVVbmJsb2NrZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmIChub25JZGxlVW5ibG9ja2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhub25JZGxlVW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBub25JZGxlUGluZ2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgICAgICAgaWYgKG5vbklkbGVQaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bmJsb2NrZWRMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgICAgaWYgKHVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXModW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChwaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3aXBMYW5lcyAhPT0gTm9MYW5lcyAmJiB3aXBMYW5lcyAhPT0gbmV4dExhbmVzICYmIC8vIElmIHdlIGFscmVhZHkgc3VzcGVuZGVkIHdpdGggYSBkZWxheSwgdGhlbiBpbnRlcnJ1cHRpbmcgaXMgZmluZS4gRG9uJ3QKICAgICAgICAgIC8vIGJvdGhlciB3YWl0aW5nIHVudGlsIHRoZSByb290IGlzIGNvbXBsZXRlLgogICAgICAgICAgKHdpcExhbmVzICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBuZXh0TGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgICAgdmFyIHdpcExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKHdpcExhbmVzKTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIFRlc3RzIHdoZXRoZXIgdGhlIG5leHQgbGFuZSBpcyBlcXVhbCBvciBsb3dlciBwcmlvcml0eSB0aGFuIHRoZSB3aXAKICAgICAgICAgICAgICAvLyBvbmUuIFRoaXMgd29ya3MgYmVjYXVzZSB0aGUgYml0cyBkZWNyZWFzZSBpbiBwcmlvcml0eSBhcyB5b3UgZ28gbGVmdC4KICAgICAgICAgICAgICBuZXh0TGFuZSA+PSB3aXBMYW5lIHx8IC8vIERlZmF1bHQgcHJpb3JpdHkgdXBkYXRlcyBzaG91bGQgbm90IGludGVycnVwdCB0cmFuc2l0aW9uIHVwZGF0ZXMuIFRoZQogICAgICAgICAgICAgIC8vIG9ubHkgZGlmZmVyZW5jZSBiZXR3ZWVuIGRlZmF1bHQgdXBkYXRlcyBhbmQgdHJhbnNpdGlvbiB1cGRhdGVzIGlzIHRoYXQKICAgICAgICAgICAgICAvLyBkZWZhdWx0IHVwZGF0ZXMgZG8gbm90IHN1cHBvcnQgcmVmcmVzaCB0cmFuc2l0aW9ucy4KICAgICAgICAgICAgICBuZXh0TGFuZSA9PT0gRGVmYXVsdExhbmUgJiYgKHdpcExhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHJldHVybiB3aXBMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKChuZXh0TGFuZXMgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0TGFuZXMgfD0gcGVuZGluZ0xhbmVzICYgRGVmYXVsdExhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW50YW5nbGVkTGFuZXMgPSByb290My5lbnRhbmdsZWRMYW5lczsKICAgICAgICAgIGlmIChlbnRhbmdsZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICAgIHZhciBsYW5lcyA9IG5leHRMYW5lcyAmIGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgICAgbmV4dExhbmVzIHw9IGVudGFuZ2xlbWVudHNbaW5kZXgyXTsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IGV2ZW50VGltZXNbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKGV2ZW50VGltZSA+IG1vc3RSZWNlbnRFdmVudFRpbWUpIHsKICAgICAgICAgICAgICBtb3N0UmVjZW50RXZlbnRUaW1lID0gZXZlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSkgewogICAgICAgICAgc3dpdGNoIChsYW5lKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDI1MDsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDVlMzsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIlNob3VsZCBoYXZlIGZvdW5kIG1hdGNoaW5nIGxhbmVzLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA9PT0gTm9UaW1lc3RhbXApIHsKICAgICAgICAgICAgICBpZiAoKGxhbmUgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMgfHwgKGxhbmUgJiBwaW5nZWRMYW5lcykgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gY29tcHV0ZUV4cGlyYXRpb25UaW1lKGxhbmUsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgfD0gbGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpIHsKICAgICAgICAgIHZhciBldmVyeXRoaW5nQnV0T2Zmc2NyZWVuID0gcm9vdDMucGVuZGluZ0xhbmVzICYgfk9mZnNjcmVlbkxhbmU7CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gZXZlcnl0aGluZ0J1dE9mZnNjcmVlbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChldmVyeXRoaW5nQnV0T2Zmc2NyZWVuICYgT2Zmc2NyZWVuTGFuZSkgewogICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1N5bmNMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0xhbmUpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc05vbklkbGVXb3JrKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgTm9uSWRsZUxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFJldHJ5TGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHZhciBVcmdlbnRMYW5lcyA9IFN5bmNMYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRMYW5lOwogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFVyZ2VudExhbmVzKSA9PT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgU3luY0RlZmF1bHRMYW5lcyA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBTeW5jRGVmYXVsdExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNFeHBpcmVkTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiByb290My5leHBpcmVkTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RyYW5zaXRpb25MYW5lKGxhbmUpIHsKICAgICAgICAgIHJldHVybiAobGFuZSAmIFRyYW5zaXRpb25MYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCkgewogICAgICAgICAgdmFyIGxhbmUgPSBuZXh0VHJhbnNpdGlvbkxhbmU7CiAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRUcmFuc2l0aW9uTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lID0gVHJhbnNpdGlvbkxhbmUxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFJldHJ5TGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFJldHJ5TGFuZTsKICAgICAgICAgIG5leHRSZXRyeUxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRSZXRyeUxhbmUgJiBSZXRyeUxhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gbGFuZXMgJiAtbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAzMSAtIGNsejMyKGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZVRvSW5kZXgobGFuZSkgewogICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU29tZUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIChhICYgYikgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3Vic2V0T2ZMYW5lcyhzZXQ0LCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiAoc2V0NCAmIHN1YnNldCkgPT09IHN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVyZ2VMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSB8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUxhbmVzKHNldDQsIHN1YnNldCkgewogICAgICAgICAgcmV0dXJuIHNldDQgJiB+c3Vic2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnRlcnNlY3RMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAmIGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0xhbmVzKGxhbmUpIHsKICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJQcmlvcml0eUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IE5vTGFuZSAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVMYW5lTWFwKGluaXRpYWwpIHsKICAgICAgICAgIHZhciBsYW5lTWFwID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IFRvdGFsTGFuZXM7IGkrKykgewogICAgICAgICAgICBsYW5lTWFwLnB1c2goaW5pdGlhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZU1hcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCB1cGRhdGVMYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyB8PSB1cGRhdGVMYW5lOwogICAgICAgICAgaWYgKHVwZGF0ZUxhbmUgIT09IElkbGVMYW5lKSB7CiAgICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KHVwZGF0ZUxhbmUpOwogICAgICAgICAgZXZlbnRUaW1lc1tpbmRleDJdID0gZXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzIHw9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgJj0gfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMsIGV2ZW50VGltZSkgewogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgfD0gcm9vdDMuc3VzcGVuZGVkTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RGaW5pc2hlZChyb290MywgcmVtYWluaW5nTGFuZXMpIHsKICAgICAgICAgIHZhciBub0xvbmdlclBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5yZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyA9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMubXV0YWJsZVJlYWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLmVudGFuZ2xlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IG5vTG9uZ2VyUGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSA9IE5vTGFuZXM7CiAgICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIGVudGFuZ2xlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcm9vdEVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXMgfD0gZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSByb290RW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgLy8gSXMgdGhpcyBvbmUgb2YgdGhlIG5ld2x5IGVudGFuZ2xlZCBsYW5lcz8KICAgICAgICAgICAgICBsYW5lICYgZW50YW5nbGVkTGFuZXMgfCAvLyBJcyB0aGlzIGxhbmUgdHJhbnNpdGl2ZWx5IGVudGFuZ2xlZCB3aXRoIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdICYgZW50YW5nbGVkTGFuZXMKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciByZW5kZXJMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGxhbmU7CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlckxhbmUpIHsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICBsYW5lID0gVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgICAgbGFuZSA9IElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhbmUgPSBOb0xhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGxhbmUgJiAocm9vdDMuc3VzcGVuZGVkTGFuZXMgfCByZW5kZXJMYW5lczIpKSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBOb0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZXMpIHsKICAgICAgICAgIGlmICghaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSByb290My5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gbGFuZVRvSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgdXBkYXRlcnMgPSBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwW2luZGV4Ml07CiAgICAgICAgICAgIHVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICBpZiAodXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB1cGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCAhbWVtb2l6ZWRVcGRhdGVycy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBEaXNjcmV0ZUV2ZW50UHJpb3JpdHkgPSBTeW5jTGFuZTsKICAgICAgICB2YXIgQ29udGludW91c0V2ZW50UHJpb3JpdHkgPSBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgIHZhciBEZWZhdWx0RXZlbnRQcmlvcml0eSA9IERlZmF1bHRMYW5lOwogICAgICAgIHZhciBJZGxlRXZlbnRQcmlvcml0eSA9IElkbGVMYW5lOwogICAgICAgIHZhciBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KG5ld1ByaW9yaXR5KSB7CiAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBuZXdQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuV2l0aFByaW9yaXR5KHByaW9yaXR5LCBmbikgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmV2aW91c1ByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiID8gYSA6IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxvd2VyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSA9PT0gMCB8fCBhID4gYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hpZ2hlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IDAgJiYgYSA8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVzVG9FdmVudFByaW9yaXR5KGxhbmVzKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc05vbklkbGVXb3JrKGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSb290RGVoeWRyYXRlZChyb290MykgewogICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHJvb3QzLmN1cnJlbnQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUuaXNEZWh5ZHJhdGVkOwogICAgICAgIH0KICAgICAgICB2YXIgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZm4pIHsKICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5OwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMTsKICAgICAgICBmdW5jdGlvbiBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICB2YXIgcXVldWVkRGlzY3JldGVFdmVudHMgPSBbXTsKICAgICAgICB2YXIgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cyA9IFtdOwogICAgICAgIHZhciBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMgPSBbCiAgICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAgICJtb3VzZXVwIiwKICAgICAgICAgICJ0b3VjaGNhbmNlbCIsCiAgICAgICAgICAidG91Y2hlbmQiLAogICAgICAgICAgInRvdWNoc3RhcnQiLAogICAgICAgICAgImF1eGNsaWNrIiwKICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAicG9pbnRlcmNhbmNlbCIsCiAgICAgICAgICAicG9pbnRlcmRvd24iLAogICAgICAgICAgInBvaW50ZXJ1cCIsCiAgICAgICAgICAiZHJhZ2VuZCIsCiAgICAgICAgICAiZHJhZ3N0YXJ0IiwKICAgICAgICAgICJkcm9wIiwKICAgICAgICAgICJjb21wb3NpdGlvbmVuZCIsCiAgICAgICAgICAiY29tcG9zaXRpb25zdGFydCIsCiAgICAgICAgICAia2V5ZG93biIsCiAgICAgICAgICAia2V5cHJlc3MiLAogICAgICAgICAgImtleXVwIiwKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAidGV4dElucHV0IiwKICAgICAgICAgIC8vIEludGVudGlvbmFsbHkgY2FtZWxDYXNlCiAgICAgICAgICAiY29weSIsCiAgICAgICAgICAiY3V0IiwKICAgICAgICAgICJwYXN0ZSIsCiAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgImNoYW5nZSIsCiAgICAgICAgICAiY29udGV4dG1lbnUiLAogICAgICAgICAgInJlc2V0IiwKICAgICAgICAgICJzdWJtaXQiCiAgICAgICAgXTsKICAgICAgICBmdW5jdGlvbiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZXZlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzLmluZGV4T2YoZXZlbnRUeXBlKSA+IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJsb2NrZWRPbiwKICAgICAgICAgICAgZG9tRXZlbnROYW1lLAogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzLAogICAgICAgICAgICBuYXRpdmVFdmVudCwKICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyczogW3RhcmdldENvbnRhaW5lcl0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmRlbGV0ZShwb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5kZWxldGUoX3BvaW50ZXJJZCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChleGlzdGluZ1F1ZXVlZEV2ZW50LCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGV4aXN0aW5nUXVldWVkRXZlbnQgPT09IG51bGwgfHwgZXhpc3RpbmdRdWV1ZWRFdmVudC5uYXRpdmVFdmVudCAhPT0gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZmliZXIyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1ZXVlZEV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZXhpc3RpbmdRdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzIHw9IGV2ZW50U3lzdGVtRmxhZ3M7CiAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVycyA9IGV4aXN0aW5nUXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIGlmICh0YXJnZXRDb250YWluZXIgIT09IG51bGwgJiYgdGFyZ2V0Q29udGFpbmVycy5pbmRleE9mKHRhcmdldENvbnRhaW5lcikgPT09IC0xKSB7CiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMucHVzaCh0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXN0aW5nUXVldWVkRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOiB7CiAgICAgICAgICAgICAgdmFyIGZvY3VzRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRm9jdXMsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGZvY3VzRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6IHsKICAgICAgICAgICAgICB2YXIgZHJhZ0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRHJhZywgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgZHJhZ0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIG1vdXNlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkTW91c2UsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG1vdXNlRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjogewogICAgICAgICAgICAgIHZhciBwb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5zZXQocG9pbnRlcklkLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJzLmdldChwb2ludGVySWQpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHBvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQyID0gX3BvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLnNldChfcG9pbnRlcklkMiwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZ2V0KF9wb2ludGVySWQyKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBfcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShxdWV1ZWRUYXJnZXQudGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocXVldWVkVGFyZ2V0LnByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgIHZhciB1cGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxKCk7CiAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gewogICAgICAgICAgICBibG9ja2VkT246IG51bGwsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgcHJpb3JpdHk6IHVwZGF0ZVByaW9yaXR5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkodXBkYXRlUHJpb3JpdHksIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tpXS5wcmlvcml0eSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNwbGljZShpLCAwLCBxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBxdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgd2hpbGUgKHRhcmdldENvbnRhaW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyc1swXTsKICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KHF1ZXVlZEV2ZW50LmRvbUV2ZW50TmFtZSwgcXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gcXVldWVkRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRDbG9uZSA9IG5ldyBuYXRpdmVFdmVudC5jb25zdHJ1Y3RvcihuYXRpdmVFdmVudC50eXBlLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgICBzZXRSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgcmVzZXRSZXBsYXlpbmdFdmVudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMyA9IGdldEluc3RhbmNlRnJvbU5vZGUobmV4dEJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKF9maWJlcjMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKHF1ZXVlZEV2ZW50LCBrZXksIG1hcDMpIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXBsYXlVbmJsb2NrZWRFdmVudHMoKSB7CiAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRGb2N1cykpIHsKICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWREcmFnKSkgewogICAgICAgICAgICBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZE1vdXNlKSkgewogICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQsIHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCkgewogICAgICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSB0cnVlOwogICAgICAgICAgICAgIFNjaGVkdWxlci51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrKFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSwgcmVwbGF5VW5ibG9ja2VkRXZlbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeUlmQmxvY2tlZE9uKHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERpc2NyZXRlRXZlbnRzWzBdLCB1bmJsb2NrZWQpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gcXVldWVkRGlzY3JldGVFdmVudHNbaV07CiAgICAgICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRGb2N1cywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREcmFnLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRNb3VzZSwgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1bmJsb2NrID0gZnVuY3Rpb24ocXVldWVkRXZlbnQyKSB7CiAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQyLCB1bmJsb2NrZWQpOwogICAgICAgICAgfTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbX2ldOwogICAgICAgICAgICBpZiAocXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV4dEV4cGxpY2l0VGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzWzBdOwogICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChuZXh0RXhwbGljaXRUYXJnZXQpOwogICAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMuc2hpZnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIF9lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBzZXRFbmFibGVkKGVuYWJsZWQpIHsKICAgICAgICAgIF9lbmFibGVkID0gISFlbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0VuYWJsZWQoKSB7CiAgICAgICAgICByZXR1cm4gX2VuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgZXZlbnRQcmlvcml0eSA9IGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIHZhciBsaXN0ZW5lcldyYXBwZXI7CiAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoQ29udGludW91c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJXcmFwcGVyLmJpbmQobnVsbCwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaERpc2NyZXRlRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoIV9lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVJZkNvbnRpbnVvdXNFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UgJiYgaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgd2hpbGUgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBibG9ja2VkT24pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgbnVsbCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50VGFyZ2V0ID0gZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpOwogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmVhcmVzdE1vdW50ZWQgIT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgIGNhc2UgImNsb3NlIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgY2FzZSAiYXV4Y2xpY2siOgogICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICBjYXNlICJkcm9wIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJpbnZhbGlkIjoKICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICBjYXNlICJwYXVzZSI6CiAgICAgICAgICAgIGNhc2UgInBsYXkiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICBjYXNlICJyYXRlY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicmVzZXQiOgogICAgICAgICAgICBjYXNlICJyZXNpemUiOgogICAgICAgICAgICBjYXNlICJzZWVrZWQiOgogICAgICAgICAgICBjYXNlICJzdWJtaXQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgIGNhc2UgInZvbHVtZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdGlvbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInRleHRJbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWlucHV0IjoKICAgICAgICAgICAgY2FzZSAiYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImZ1bGxzY3JlZW5jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJmb2N1cyI6CiAgICAgICAgICAgIGNhc2UgImhhc2hjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJwb3BzdGF0ZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdHN0YXJ0IjoKICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICBjYXNlICJ0b2dnbGUiOgogICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZW50ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZWxlYXZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmVudGVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmxlYXZlIjoKICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgIm1lc3NhZ2UiOiB7CiAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5ID0gZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHNjaGVkdWxlclByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBwYXNzaXZlKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMiwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcm9vdDIgPSBudWxsOwogICAgICAgIHZhciBzdGFydFRleHQgPSBudWxsOwogICAgICAgIHZhciBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHJvb3QyID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICBzdGFydFRleHQgPSBnZXRUZXh0KCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICByb290MiA9IG51bGw7CiAgICAgICAgICBzdGFydFRleHQgPSBudWxsOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICAgIGlmIChmYWxsYmFja1RleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgIHZhciBzdGFydFZhbHVlID0gc3RhcnRUZXh0OwogICAgICAgICAgdmFyIHN0YXJ0TGVuZ3RoID0gc3RhcnRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICB2YXIgZW5kOwogICAgICAgICAgdmFyIGVuZFZhbHVlID0gZ2V0VGV4dCgpOwogICAgICAgICAgdmFyIGVuZExlbmd0aCA9IGVuZFZhbHVlLmxlbmd0aDsKICAgICAgICAgIGZvciAoc3RhcnQgPSAwOyBzdGFydCA8IHN0YXJ0TGVuZ3RoOyBzdGFydCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0XSAhPT0gZW5kVmFsdWVbc3RhcnRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBtaW5FbmQgPSBzdGFydExlbmd0aCAtIHN0YXJ0OwogICAgICAgICAgZm9yIChlbmQgPSAxOyBlbmQgPD0gbWluRW5kOyBlbmQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydExlbmd0aCAtIGVuZF0gIT09IGVuZFZhbHVlW2VuZExlbmd0aCAtIGVuZF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHNsaWNlVGFpbCA9IGVuZCA+IDEgPyAxIC0gZW5kIDogdm9pZCAwOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gZW5kVmFsdWUuc2xpY2Uoc3RhcnQsIHNsaWNlVGFpbCk7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KCkgewogICAgICAgICAgaWYgKCJ2YWx1ZSIgaW4gcm9vdDIpIHsKICAgICAgICAgICAgcmV0dXJuIHJvb3QyLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3QyLnRleHRDb250ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2hhckNvZGU7CiAgICAgICAgICB2YXIga2V5Q29kZSA9IG5hdGl2ZUV2ZW50LmtleUNvZGU7CiAgICAgICAgICBpZiAoImNoYXJDb2RlIiBpbiBuYXRpdmVFdmVudCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IG5hdGl2ZUV2ZW50LmNoYXJDb2RlOwogICAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDAgJiYga2V5Q29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGFyQ29kZSA9IGtleUNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDEwKSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPj0gMzIgfHwgY2hhckNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZSgpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2UoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEludGVyZmFjZSkgewogICAgICAgICAgZnVuY3Rpb24gU3ludGhldGljQmFzZUV2ZW50KHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgICB0aGlzLl9yZWFjdE5hbWUgPSByZWFjdE5hbWU7CiAgICAgICAgICAgIHRoaXMuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0aGlzLnR5cGUgPSByZWFjdEV2ZW50VHlwZTsKICAgICAgICAgICAgdGhpcy5uYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgICB0aGlzLmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBfcHJvcE5hbWUgaW4gSW50ZXJmYWNlKSB7CiAgICAgICAgICAgICAgaWYgKCFJbnRlcmZhY2UuaGFzT3duUHJvcGVydHkoX3Byb3BOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBub3JtYWxpemUyID0gSW50ZXJmYWNlW19wcm9wTmFtZV07CiAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZTIpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZTIobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBuYXRpdmVFdmVudFtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByZXZlbnRlZCA9IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgIT0gbnVsbCA/IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgOiBuYXRpdmVFdmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2lnbjIoU3ludGhldGljQmFzZUV2ZW50LnByb3RvdHlwZSwgewogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LmNhbmNlbEJ1YmJsZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBXZSByZWxlYXNlIGFsbCBkaXNwYXRjaGVkIGBTeW50aGV0aWNFdmVudGBzIGFmdGVyIGVhY2ggZXZlbnQgbG9vcCwgYWRkaW5nCiAgICAgICAgICAgICAqIHRoZW0gYmFjayBpbnRvIHRoZSBwb29sLiBUaGlzIGFsbG93cyBhIHdheSB0byBob2xkIG9udG8gYSByZWZlcmVuY2UgdGhhdAogICAgICAgICAgICAgKiB3b24ndCBiZSBhZGRlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwZXJzaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBpZiB0aGlzIGV2ZW50IHNob3VsZCBiZSByZWxlYXNlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBzaG91bGQgbm90IGJlIHJlbGVhc2VkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc1BlcnNpc3RlbnQ6IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBTeW50aGV0aWNCYXNlRXZlbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBFdmVudEludGVyZmFjZSA9IHsKICAgICAgICAgIGV2ZW50UGhhc2U6IDAsCiAgICAgICAgICBidWJibGVzOiAwLAogICAgICAgICAgY2FuY2VsYWJsZTogMCwKICAgICAgICAgIHRpbWVTdGFtcDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwogICAgICAgICAgfSwKICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IDAsCiAgICAgICAgICBpc1RydXN0ZWQ6IDAKICAgICAgICB9OwogICAgICAgIHZhciBTeW50aGV0aWNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVUlFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHNjcmVlblg6IDAsCiAgICAgICAgICBzY3JlZW5ZOiAwLAogICAgICAgICAgY2xpZW50WDogMCwKICAgICAgICAgIGNsaWVudFk6IDAsCiAgICAgICAgICBwYWdlWDogMCwKICAgICAgICAgIHBhZ2VZOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIGJ1dHRvbjogMCwKICAgICAgICAgIGJ1dHRvbnM6IDAsCiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQucmVsYXRlZFRhcmdldCA9PT0gdm9pZCAwKSByZXR1cm4gZXZlbnQuZnJvbUVsZW1lbnQgPT09IGV2ZW50LnNyY0VsZW1lbnQgPyBldmVudC50b0VsZW1lbnQgOiBldmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRYOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WCIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRYOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WSIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRZOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNNb3VzZUV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoTW91c2VFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIERyYWdFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGFUcmFuc2ZlcjogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNEcmFnRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChEcmFnRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBGb2N1c0V2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGFuaW1hdGlvbk5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQW5pbWF0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChBbmltYXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIENsaXBib2FyZEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGNsaXBib2FyZERhdGE6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiY2xpcGJvYXJkRGF0YSIgaW4gZXZlbnQgPyBldmVudC5jbGlwYm9hcmREYXRhIDogd2luZG93LmNsaXBib2FyZERhdGE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBrZXk6IGdldEV2ZW50S2V5LAogICAgICAgICAgY29kZTogMCwKICAgICAgICAgIGxvY2F0aW9uOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIHJlcGVhdDogMCwKICAgICAgICAgIGxvY2FsZTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIC8vIExlZ2FjeSBJbnRlcmZhY2UKICAgICAgICAgIGNoYXJDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICBrZXlDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICB3aGljaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0tleWJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChLZXlib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgUG9pbnRlckV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcG9pbnRlcklkOiAwLAogICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICBoZWlnaHQ6IDAsCiAgICAgICAgICBwcmVzc3VyZTogMCwKICAgICAgICAgIHRhbmdlbnRpYWxQcmVzc3VyZTogMCwKICAgICAgICAgIHRpbHRYOiAwLAogICAgICAgICAgdGlsdFk6IDAsCiAgICAgICAgICB0d2lzdDogMCwKICAgICAgICAgIHBvaW50ZXJUeXBlOiAwLAogICAgICAgICAgaXNQcmltYXJ5OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1BvaW50ZXJFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFBvaW50ZXJFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRvdWNoRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBwcm9wZXJ0eU5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVHJhbnNpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgV2hlZWxFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRlbHRhWDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJkZWx0YVgiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFYIDogKAogICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhWGAgZm9yIFdlYmtpdCBhbmQgbm9ybWFsaXplIChyaWdodCBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFYIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWCA6IDAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFZIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWSA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVlgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFZIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWSA6ICgKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhYCBmb3IgSUU8OSBhbmQgbm9ybWFsaXplIChkb3duIGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAgICJ3aGVlbERlbHRhIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhIDogMAogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVo6IDAsCiAgICAgICAgICAvLyBCcm93c2VycyB3aXRob3V0ICJkZWx0YU1vZGUiIGlzIHJlcG9ydGluZyBpbiByYXcgd2hlZWwgZGVsdGEgd2hlcmUgb25lCiAgICAgICAgICAvLyBub3RjaCBvbiB0aGUgc2Nyb2xsIGlzIGFsd2F5cyArLy0gMTIwLCByb3VnaGx5IGVxdWl2YWxlbnQgdG8gcGl4ZWxzLgogICAgICAgICAgLy8gQSBnb29kIGFwcHJveGltYXRpb24gb2YgRE9NX0RFTFRBX0xJTkUgKDEpIGlzIDUlIG9mIHZpZXdwb3J0IHNpemUgb3IKICAgICAgICAgIC8vIH40MCBwaXhlbHMsIGZvciBET01fREVMVEFfU0NSRUVOICgyKSBpdCBpcyA4Ny41JSBvZiB2aWV3cG9ydCBzaXplLgogICAgICAgICAgZGVsdGFNb2RlOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1doZWVsRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChXaGVlbEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRU5EX0tFWUNPREVTID0gWzksIDEzLCAyNywgMzJdOwogICAgICAgIHZhciBTVEFSVF9LRVlDT0RFID0gMjI5OwogICAgICAgIHZhciBjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ID0gY2FuVXNlRE9NMiAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00yICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50KSB7CiAgICAgICAgICBkb2N1bWVudE1vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VUZXh0SW5wdXRFdmVudCA9IGNhblVzZURPTTIgJiYgIlRleHRFdmVudCIgaW4gd2luZG93ICYmICFkb2N1bWVudE1vZGU7CiAgICAgICAgdmFyIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhID0gY2FuVXNlRE9NMiAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTTIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICJvbiIgKyBldmVudE5hbWVTdWZmaXg7CiAgICAgICAgICB2YXIgaXNTdXBwb3J0ZWQgPSBldmVudE5hbWUgaW4gZG9jdW1lbnQ7CiAgICAgICAgICBpZiAoIWlzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsKICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSB0eXBlb2YgZWxlbWVudFtldmVudE5hbWVdID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQxKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNoYW5nZSIsIFsiY2hhbmdlIiwgImNsaWNrIiwgImZvY3VzaW4iLCAiZm9jdXNvdXQiLCAiaW5wdXQiLCAia2V5ZG93biIsICJrZXl1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgdGFyZ2V0KSB7CiAgICAgICAgICBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGluc3QsICJvbkNoYW5nZSIpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25DaGFuZ2UiLCAiY2hhbmdlIiwgbnVsbCwgbmF0aXZlRXZlbnQsIHRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDaGFuZ2VFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSA9PT0gInNlbGVjdCIgfHwgbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiZmlsZSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hbnVhbERpc3BhdGNoQ2hhbmdlRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgYWN0aXZlRWxlbWVudEluc3QsIG5hdGl2ZUV2ZW50LCBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkpOwogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMocnVuRXZlbnRJbkJhdGNoLCBkaXNwYXRjaFF1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuRXZlbnRJbkJhdGNoKGRpc3BhdGNoUXVldWUpIHsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIDApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCkgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpOwogICAgICAgICAgaWYgKHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzSW5wdXRFdmVudFN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBpc0V2ZW50U3VwcG9ydGVkKCJpbnB1dCIpICYmICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gdGFyZ2V0OwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgYWN0aXZlRWxlbWVudC5hdHRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKSB7CiAgICAgICAgICBpZiAoIWFjdGl2ZUVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYWN0aXZlRWxlbWVudC5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVQcm9wZXJ0eUNoYW5nZShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnByb3BlcnR5TmFtZSAhPT0gInZhbHVlIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KSkgewogICAgICAgICAgICBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXZlbnRzRm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNpbiIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgICAgc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3Vzb3V0IikgewogICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInNlbGVjdGlvbmNoYW5nZSIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5dXAiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQoYWN0aXZlRWxlbWVudEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDbGlja0V2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0udHlwZSA9PT0gInJhZGlvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNsaWNrIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImlucHV0IiB8fCBkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIobm9kZSkgewogICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5fd3JhcHBlclN0YXRlOwogICAgICAgICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuY29udHJvbGxlZCB8fCBub2RlLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsICJudW1iZXIiLCBub2RlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICB2YXIgZ2V0VGFyZ2V0SW5zdEZ1bmMsIGhhbmRsZUV2ZW50RnVuYzsKICAgICAgICAgIGlmIChzaG91bGRVc2VDaGFuZ2VFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGlmIChpc0lucHV0RXZlbnRTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dE9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsOwogICAgICAgICAgICAgIGhhbmRsZUV2ZW50RnVuYyA9IGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRVc2VDbGlja0V2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvckNsaWNrRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0VGFyZ2V0SW5zdEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGluc3QgPSBnZXRUYXJnZXRJbnN0RnVuYyhkb21FdmVudE5hbWUsIHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhbmRsZUV2ZW50RnVuYykgewogICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXROb2RlLCB0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cih0YXJnZXROb2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMigpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VFbnRlciIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUxlYXZlIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJFbnRlciIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uUG9pbnRlckxlYXZlIiwgWyJwb2ludGVyb3V0IiwgInBvaW50ZXJvdmVyIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGlzT3ZlckV2ZW50ID0gZG9tRXZlbnROYW1lID09PSAibW91c2VvdmVyIiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciI7CiAgICAgICAgICB2YXIgaXNPdXRFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IjsKICAgICAgICAgIGlmIChpc092ZXJFdmVudCAmJiAhaXNSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgdmFyIHJlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVsYXRlZCkgewogICAgICAgICAgICAgIGlmIChnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShyZWxhdGVkKSB8fCBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChyZWxhdGVkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc091dEV2ZW50ICYmICFpc092ZXJFdmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2luOwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgd2luID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZG9jID0gbmF0aXZlRXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKGRvYykgewogICAgICAgICAgICAgIHdpbiA9IGRvYy5kZWZhdWx0VmlldyB8fCBkb2MucGFyZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdpbiA9IHdpbmRvdzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb20yOwogICAgICAgICAgdmFyIHRvMjsKICAgICAgICAgIGlmIChpc091dEV2ZW50KSB7CiAgICAgICAgICAgIHZhciBfcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQudG9FbGVtZW50OwogICAgICAgICAgICBmcm9tMiA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRvMiA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodG8yKTsKICAgICAgICAgICAgICBpZiAodG8yICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0bzIudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHRvMi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICB0bzIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbTIgPSBudWxsOwogICAgICAgICAgICB0bzIgPSB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZyb20yID09PSB0bzIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICB2YXIgbGVhdmVFdmVudFR5cGUgPSAib25Nb3VzZUxlYXZlIjsKICAgICAgICAgIHZhciBlbnRlckV2ZW50VHlwZSA9ICJvbk1vdXNlRW50ZXIiOwogICAgICAgICAgdmFyIGV2ZW50VHlwZVByZWZpeCA9ICJtb3VzZSI7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiKSB7CiAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgbGVhdmVFdmVudFR5cGUgPSAib25Qb2ludGVyTGVhdmUiOwogICAgICAgICAgICBlbnRlckV2ZW50VHlwZSA9ICJvblBvaW50ZXJFbnRlciI7CiAgICAgICAgICAgIGV2ZW50VHlwZVByZWZpeCA9ICJwb2ludGVyIjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tTm9kZSA9IGZyb20yID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKGZyb20yKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0bzIgPT0gbnVsbCA/IHdpbiA6IGdldE5vZGVGcm9tSW5zdGFuY2UodG8yKTsKICAgICAgICAgIHZhciBsZWF2ZSA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IobGVhdmVFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJsZWF2ZSIsIGZyb20yLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bzIsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGVudGVyRXZlbnQudGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgICBlbnRlckV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgICAgZW50ZXIgPSBlbnRlckV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZSwgZW50ZXIsIGZyb20yLCB0bzIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICh4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzNDsKICAgICAgICBmdW5jdGlvbiBzaGFsbG93RXF1YWwyKG9iakEsIG9iakIpIHsKICAgICAgICAgIGlmIChvYmplY3RJcyhvYmpBLCBvYmpCKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgICAgICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwogICAgICAgICAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5c0EubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRLZXkgPSBrZXlzQVtpXTsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8ICFvYmplY3RJcyhvYmpBW2N1cnJlbnRLZXldLCBvYmpCW2N1cnJlbnRLZXldKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWZOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNpYmxpbmdOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChyb290Mywgb2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGdldExlYWZOb2RlKHJvb3QzKTsKICAgICAgICAgIHZhciBub2RlU3RhcnQgPSAwOwogICAgICAgICAgdmFyIG5vZGVFbmQgPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIG5vZGVFbmQgPSBub2RlU3RhcnQgKyBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICBpZiAobm9kZVN0YXJ0IDw9IG9mZnNldCAmJiBub2RlRW5kID49IG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBvZmZzZXQgLSBub2RlU3RhcnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGVTdGFydCA9IG5vZGVFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IGdldExlYWZOb2RlKGdldFNpYmxpbmdOb2RlKG5vZGUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T2Zmc2V0cyhvdXRlck5vZGUpIHsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gb3V0ZXJOb2RlLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gb3duZXJEb2N1bWVudCAmJiBvd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uICYmIHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxlY3Rpb24uYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0ID0gc2VsZWN0aW9uLmFuY2hvck9mZnNldCwgZm9jdXNOb2RlID0gc2VsZWN0aW9uLmZvY3VzTm9kZSwgZm9jdXNPZmZzZXQgPSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhbmNob3JOb2RlLm5vZGVUeXBlOwogICAgICAgICAgICBmb2N1c05vZGUubm9kZVR5cGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpIHsKICAgICAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICAgICAgdmFyIHN0YXJ0ID0gLTE7CiAgICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5BbmNob3IgPSAwOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluRm9jdXMgPSAwOwogICAgICAgICAgdmFyIG5vZGUgPSBvdXRlck5vZGU7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBvdXRlcjogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlID09PSBhbmNob3JOb2RlICYmIChhbmNob3JPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGggKyBhbmNob3JPZmZzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmb2N1c05vZGUgJiYgKGZvY3VzT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aCArIGZvY3VzT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBsZW5ndGggKz0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLmZpcnN0Q2hpbGQpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGFuY2hvck5vZGUgJiYgKytpbmRleFdpdGhpbkFuY2hvciA9PT0gYW5jaG9yT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IGxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGZvY3VzTm9kZSAmJiArK2luZGV4V2l0aGluRm9jdXMgPT09IGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUubmV4dFNpYmxpbmcpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGFydCA9PT0gLTEgfHwgZW5kID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICBlbmQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldE9mZnNldHMobm9kZSwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIHZhciB3aW4gPSBkb2MgJiYgZG9jLmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICghd2luLmdldFNlbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IG5vZGUudGV4dENvbnRlbnQubGVuZ3RoOwogICAgICAgICAgdmFyIHN0YXJ0ID0gTWF0aC5taW4ob2Zmc2V0cy5zdGFydCwgbGVuZ3RoKTsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZCA9PT0gdm9pZCAwID8gc3RhcnQgOiBNYXRoLm1pbihvZmZzZXRzLmVuZCwgbGVuZ3RoKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uLmV4dGVuZCAmJiBzdGFydCA+IGVuZCkgewogICAgICAgICAgICB2YXIgdGVtcCA9IGVuZDsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICAgIHN0YXJ0ID0gdGVtcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgc3RhcnQpOwogICAgICAgICAgdmFyIGVuZE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgZW5kKTsKICAgICAgICAgIGlmIChzdGFydE1hcmtlciAmJiBlbmRNYXJrZXIpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAxICYmIHNlbGVjdGlvbi5hbmNob3JOb2RlID09PSBzdGFydE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbi5hbmNob3JPZmZzZXQgPT09IHN0YXJ0TWFya2VyLm9mZnNldCAmJiBzZWxlY3Rpb24uZm9jdXNOb2RlID09PSBlbmRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQgPT09IGVuZE1hcmtlci5vZmZzZXQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJhbmdlNCA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZTQuc2V0U3RhcnQoc3RhcnRNYXJrZXIubm9kZSwgc3RhcnRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgICBpZiAoc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uZXh0ZW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByYW5nZTQuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RleHROb2RlKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlKSB7CiAgICAgICAgICBpZiAoIW91dGVyTm9kZSB8fCAhaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlID09PSBpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUob3V0ZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUoaW5uZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlLnBhcmVudE5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmICgiY29udGFpbnMiIGluIG91dGVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gb3V0ZXJOb2RlLmNvbnRhaW5zKGlubmVyTm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gISEob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGlubmVyTm9kZSkgJiAxNik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW5Eb2N1bWVudChub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm93bmVyRG9jdW1lbnQgJiYgY29udGFpbnNOb2RlKG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW5GcmFtZShpZnJhbWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgaWZyYW1lLmNvbnRlbnRXaW5kb3cubG9jYXRpb24uaHJlZiA9PT0gInN0cmluZyI7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50RGVlcCgpIHsKICAgICAgICAgIHZhciB3aW4gPSB3aW5kb3c7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQoKTsKICAgICAgICAgIHdoaWxlIChlbGVtZW50IGluc3RhbmNlb2Ygd2luLkhUTUxJRnJhbWVFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChpc1NhbWVPcmlnaW5GcmFtZShlbGVtZW50KSkgewogICAgICAgICAgICAgIHdpbiA9IGVsZW1lbnQuY29udGVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCh3aW4uZG9jdW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtICYmIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAidGV4dCIgfHwgZWxlbS50eXBlID09PSAic2VhcmNoIiB8fCBlbGVtLnR5cGUgPT09ICJ0ZWwiIHx8IGVsZW0udHlwZSA9PT0gInVybCIgfHwgZWxlbS50eXBlID09PSAicGFzc3dvcmQiKSB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiB8fCBlbGVtLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKSB7CiAgICAgICAgICB2YXIgZm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZm9jdXNlZEVsZW0sCiAgICAgICAgICAgIHNlbGVjdGlvblJhbmdlOiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZm9jdXNlZEVsZW0pID8gZ2V0U2VsZWN0aW9uKGZvY3VzZWRFbGVtKSA6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTZWxlY3Rpb24ocHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbikgewogICAgICAgICAgdmFyIGN1ckZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHZhciBwcmlvckZvY3VzZWRFbGVtID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5mb2N1c2VkRWxlbTsKICAgICAgICAgIHZhciBwcmlvclNlbGVjdGlvblJhbmdlID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5zZWxlY3Rpb25SYW5nZTsKICAgICAgICAgIGlmIChjdXJGb2N1c2VkRWxlbSAhPT0gcHJpb3JGb2N1c2VkRWxlbSAmJiBpc0luRG9jdW1lbnQocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgaWYgKHByaW9yU2VsZWN0aW9uUmFuZ2UgIT09IG51bGwgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uKHByaW9yRm9jdXNlZEVsZW0sIHByaW9yU2VsZWN0aW9uUmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvcnMgPSBbXTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9yID0gcHJpb3JGb2N1c2VkRWxlbTsKICAgICAgICAgICAgd2hpbGUgKGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmIChhbmNlc3Rvci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGFuY2VzdG9yLAogICAgICAgICAgICAgICAgICBsZWZ0OiBhbmNlc3Rvci5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICB0b3A6IGFuY2VzdG9yLnNjcm9sbFRvcAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFuY2VzdG9ycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpbmZvID0gYW5jZXN0b3JzW2ldOwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxMZWZ0ID0gaW5mby5sZWZ0OwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxUb3AgPSBpbmZvLnRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24oaW5wdXQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb247CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBzZWxlY3Rpb24gPSB7CiAgICAgICAgICAgICAgc3RhcnQ6IGlucHV0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogaW5wdXQuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxlY3Rpb24gPSBnZXRPZmZzZXRzKGlucHV0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24gfHwgewogICAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgICAgZW5kOiAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb24oaW5wdXQsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IG9mZnNldHMuc3RhcnQ7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQ7CiAgICAgICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25TdGFydCA9IHN0YXJ0OwogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25FbmQgPSBNYXRoLm1pbihlbmQsIGlucHV0LnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRPZmZzZXRzKGlucHV0LCBvZmZzZXRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCA9IGNhblVzZURPTTIgJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbDIobGFzdFNlbGVjdGlvbiwgY3VycmVudFNlbGVjdGlvbikpIHsKICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoYWN0aXZlRWxlbWVudEluc3QkMSwgIm9uU2VsZWN0Iik7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25TZWxlY3QiLCAic2VsZWN0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBhY3RpdmVFbGVtZW50JDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpIHx8IHRhcmdldE5vZGUuY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgICBpZiAoc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFrZVByZWZpeE1hcChzdHlsZVByb3AsIGV2ZW50TmFtZSkgewogICAgICAgICAgdmFyIHByZWZpeGVzMyA9IHt9OwogICAgICAgICAgcHJlZml4ZXMzW3N0eWxlUHJvcC50b0xvd2VyQ2FzZSgpXSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcHJlZml4ZXMzWyJXZWJraXQiICsgc3R5bGVQcm9wXSA9ICJ3ZWJraXQiICsgZXZlbnROYW1lOwogICAgICAgICAgcHJlZml4ZXMzWyJNb3oiICsgc3R5bGVQcm9wXSA9ICJtb3oiICsgZXZlbnROYW1lOwogICAgICAgICAgcmV0dXJuIHByZWZpeGVzMzsKICAgICAgICB9CiAgICAgICAgdmFyIHZlbmRvclByZWZpeGVzID0gewogICAgICAgICAgYW5pbWF0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uRW5kIiksCiAgICAgICAgICBhbmltYXRpb25pdGVyYXRpb246IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25JdGVyYXRpb24iKSwKICAgICAgICAgIGFuaW1hdGlvbnN0YXJ0OiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uU3RhcnQiKSwKICAgICAgICAgIHRyYW5zaXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIlRyYW5zaXRpb24iLCAiVHJhbnNpdGlvbkVuZCIpCiAgICAgICAgfTsKICAgICAgICB2YXIgcHJlZml4ZWRFdmVudE5hbWVzID0ge307CiAgICAgICAgdmFyIHN0eWxlID0ge307CiAgICAgICAgaWYgKGNhblVzZURPTTIpIHsKICAgICAgICAgIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iikuc3R5bGU7CiAgICAgICAgICBpZiAoISgiQW5pbWF0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbmVuZC5hbmltYXRpb247CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25pdGVyYXRpb24uYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uc3RhcnQuYW5pbWF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCEoIlRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMudHJhbnNpdGlvbmVuZC50cmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZShldmVudE5hbWUpIHsKICAgICAgICAgIGlmIChwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV07CiAgICAgICAgICB9IGVsc2UgaWYgKCF2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJlZml4TWFwID0gdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlUHJvcCBpbiBwcmVmaXhNYXApIHsKICAgICAgICAgICAgaWYgKHByZWZpeE1hcC5oYXNPd25Qcm9wZXJ0eShzdHlsZVByb3ApICYmIHN0eWxlUHJvcCBpbiBzdHlsZSkgewogICAgICAgICAgICAgIHJldHVybiBwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSA9IHByZWZpeE1hcFtzdHlsZVByb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgIH0KICAgICAgICB2YXIgQU5JTUFUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25lbmQiKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX0lURVJBVElPTiA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25pdGVyYXRpb24iKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX1NUQVJUID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbnN0YXJ0Iik7CiAgICAgICAgdmFyIFRSQU5TSVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoInRyYW5zaXRpb25lbmQiKTsKICAgICAgICB2YXIgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBzaW1wbGVFdmVudFBsdWdpbkV2ZW50cyA9IFsiYWJvcnQiLCAiYXV4Q2xpY2siLCAiY2FuY2VsIiwgImNhblBsYXkiLCAiY2FuUGxheVRocm91Z2giLCAiY2xpY2siLCAiY2xvc2UiLCAiY29udGV4dE1lbnUiLCAiY29weSIsICJjdXQiLCAiZHJhZyIsICJkcmFnRW5kIiwgImRyYWdFbnRlciIsICJkcmFnRXhpdCIsICJkcmFnTGVhdmUiLCAiZHJhZ092ZXIiLCAiZHJhZ1N0YXJ0IiwgImRyb3AiLCAiZHVyYXRpb25DaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAiZ290UG9pbnRlckNhcHR1cmUiLCAiaW5wdXQiLCAiaW52YWxpZCIsICJrZXlEb3duIiwgImtleVByZXNzIiwgImtleVVwIiwgImxvYWQiLCAibG9hZGVkRGF0YSIsICJsb2FkZWRNZXRhZGF0YSIsICJsb2FkU3RhcnQiLCAibG9zdFBvaW50ZXJDYXB0dXJlIiwgIm1vdXNlRG93biIsICJtb3VzZU1vdmUiLCAibW91c2VPdXQiLCAibW91c2VPdmVyIiwgIm1vdXNlVXAiLCAicGFzdGUiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInBvaW50ZXJDYW5jZWwiLCAicG9pbnRlckRvd24iLCAicG9pbnRlck1vdmUiLCAicG9pbnRlck91dCIsICJwb2ludGVyT3ZlciIsICJwb2ludGVyVXAiLCAicHJvZ3Jlc3MiLCAicmF0ZUNoYW5nZSIsICJyZXNldCIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdWJtaXQiLCAic3VzcGVuZCIsICJ0aW1lVXBkYXRlIiwgInRvdWNoQ2FuY2VsIiwgInRvdWNoRW5kIiwgInRvdWNoU3RhcnQiLCAidm9sdW1lQ2hhbmdlIiwgInNjcm9sbCIsICJ0b2dnbGUiLCAidG91Y2hNb3ZlIiwgIndhaXRpbmciLCAid2hlZWwiXTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5zZXQoZG9tRXZlbnROYW1lLCByZWFjdE5hbWUpOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlYWN0TmFtZSwgW2RvbUV2ZW50TmFtZV0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50cygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzW2ldOwogICAgICAgICAgICB2YXIgZG9tRXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBjYXBpdGFsaXplZEV2ZW50ID0gZXZlbnROYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBldmVudE5hbWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCAib24iICsgY2FwaXRhbGl6ZWRFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9FTkQsICJvbkFuaW1hdGlvbkVuZCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fSVRFUkFUSU9OLCAib25BbmltYXRpb25JdGVyYXRpb24iKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX1NUQVJULCAib25BbmltYXRpb25TdGFydCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZGJsY2xpY2siLCAib25Eb3VibGVDbGljayIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNpbiIsICJvbkZvY3VzIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJmb2N1c291dCIsICJvbkJsdXIiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoVFJBTlNJVElPTl9FTkQsICJvblRyYW5zaXRpb25FbmQiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciByZWFjdE5hbWUgPSB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5nZXQoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIGlmIChyZWFjdE5hbWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRXZlbnQ7CiAgICAgICAgICB2YXIgcmVhY3RFdmVudFR5cGUgPSBkb21FdmVudE5hbWU7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgaWYgKGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0tleWJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImZvY3VzIjsKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmVhY3RFdmVudFR5cGUgPSAiYmx1ciI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5idXR0b24gPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRHJhZ0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVG91Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fRU5EOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9JVEVSQVRJT046CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX1NUQVJUOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRSQU5TSVRJT05fRU5EOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNVSUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljV2hlZWxFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNDbGlwYm9hcmRFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJsb3N0cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjY3VtdWxhdGVUYXJnZXRPbmx5ID0gIWluQ2FwdHVyZVBoYXNlICYmIC8vIFRPRE86IGlkZWFsbHksIHdlJ2QgZXZlbnR1YWxseSBhZGQgYWxsIGV2ZW50cyBmcm9tCiAgICAgICAgICAgIC8vIG5vbkRlbGVnYXRlZEV2ZW50cyBsaXN0IGluIERPTVBsdWdpbkV2ZW50U3lzdGVtLgogICAgICAgICAgICAvLyBUaGVuIHdlIGNhbiByZW1vdmUgdGhpcyBzcGVjaWFsIGxpc3QuCiAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBicmVha2luZyBjaGFuZ2UgdGhhdCBjYW4gd2FpdCB1bnRpbCBSZWFjdCAxOC4KICAgICAgICAgICAgZG9tRXZlbnROYW1lID09PSAic2Nyb2xsIjsKICAgICAgICAgICAgdmFyIF9saXN0ZW5lcnMgPSBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudC50eXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHkpOwogICAgICAgICAgICBpZiAoX2xpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9ldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQ6IF9ldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogX2xpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMigpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDEoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMoKTsKICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBzaG91bGRQcm9jZXNzUG9seWZpbGxQbHVnaW5zID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUykgPT09IDA7CiAgICAgICAgICBpZiAoc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucykgewogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDEoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG1lZGlhRXZlbnRUeXBlcyA9IFsiYWJvcnQiLCAiY2FucGxheSIsICJjYW5wbGF5dGhyb3VnaCIsICJkdXJhdGlvbmNoYW5nZSIsICJlbXB0aWVkIiwgImVuY3J5cHRlZCIsICJlbmRlZCIsICJlcnJvciIsICJsb2FkZWRkYXRhIiwgImxvYWRlZG1ldGFkYXRhIiwgImxvYWRzdGFydCIsICJwYXVzZSIsICJwbGF5IiwgInBsYXlpbmciLCAicHJvZ3Jlc3MiLCAicmF0ZWNoYW5nZSIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdXNwZW5kIiwgInRpbWV1cGRhdGUiLCAidm9sdW1lY2hhbmdlIiwgIndhaXRpbmciXTsKICAgICAgICB2YXIgbm9uRGVsZWdhdGVkRXZlbnRzID0gbmV3IFNldChbImNhbmNlbCIsICJjbG9zZSIsICJpbnZhbGlkIiwgImxvYWQiLCAic2Nyb2xsIiwgInRvZ2dsZSJdLmNvbmNhdChtZWRpYUV2ZW50VHlwZXMpKTsKICAgICAgICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyMiwgdm9pZCAwLCBldmVudCk7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGRpc3BhdGNoTGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHByZXZpb3VzSW5zdGFuY2U7CiAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRpID0gZGlzcGF0Y2hMaXN0ZW5lcnNbaV0sIGluc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuaW5zdGFuY2UsIGN1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5jdXJyZW50VGFyZ2V0LCBsaXN0ZW5lcjIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5saXN0ZW5lcjsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyMiA9IGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBpc1Bhc3NpdmVMaXN0ZW5lciA9IHZvaWQgMDsKICAgICAgICAgIGlmIChwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAidG91Y2hzdGFydCIgfHwgZG9tRXZlbnROYW1lID09PSAidG91Y2htb3ZlIiB8fCBkb21FdmVudE5hbWUgPT09ICJ3aGVlbCIpIHsKICAgICAgICAgICAgICBpc1Bhc3NpdmVMaXN0ZW5lciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgIHZhciB1bnN1YnNjcmliZUxpc3RlbmVyOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMiwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdyYW5kQ29udGFpbmVyID09PSB0YXJnZXRDb250YWluZXIgfHwgZ3JhbmRDb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBncmFuZENvbnRhaW5lci5wYXJlbnROb2RlID09PSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBhbmNlc3Rvckluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgaWYgKChldmVudFN5c3RlbUZsYWdzICYgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUpID09PSAwICYmIChldmVudFN5c3RlbUZsYWdzICYgSVNfTk9OX0RFTEVHQVRFRCkgPT09IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lck5vZGUgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgIG1haW5Mb29wOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5vZGVUYWcgPSBub2RlLnRhZzsKICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0Um9vdCB8fCBub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gbm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGNvbnRhaW5lcjIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGdyYW5kTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kVGFnID0gZ3JhbmROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFRhZyA9PT0gSG9zdFJvb3QgfHwgZ3JhbmRUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kQ29udGFpbmVyID0gZ3JhbmROb2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBncmFuZE5vZGUgPSBncmFuZE5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRUYWcgPT09IEhvc3RDb21wb25lbnQgfHwgcGFyZW50VGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGFuY2VzdG9ySW5zdCA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBtYWluTG9vcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyMiA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgYW5jZXN0b3JJbnN0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lcjogbGlzdGVuZXIyLAogICAgICAgICAgICBjdXJyZW50VGFyZ2V0CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnRUeXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHksIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgIT09IG51bGwgPyByZWFjdE5hbWUgKyAiQ2FwdHVyZSIgOiBudWxsOwogICAgICAgICAgdmFyIHJlYWN0RXZlbnROYW1lID0gaW5DYXB0dXJlUGhhc2UgPyBjYXB0dXJlTmFtZSA6IHJlYWN0TmFtZTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgdmFyIGxhc3RIb3N0Q29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UyLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMi50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdEhvc3RDb21wb25lbnQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHJlYWN0RXZlbnROYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGxhc3RIb3N0Q29tcG9uZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhY2N1bXVsYXRlVGFyZ2V0T25seSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUpIHsKICAgICAgICAgIHZhciBjYXB0dXJlTmFtZSA9IHJlYWN0TmFtZSArICJDYXB0dXJlIjsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTMuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UzLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVOYW1lKTsKICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVhY3ROYW1lKTsKICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnQoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGluc3QgPSBpbnN0LnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKGluc3QgJiYgaW5zdC50YWcgIT09IEhvc3RDb21wb25lbnQpOwogICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IoaW5zdEEsIGluc3RCKSB7CiAgICAgICAgICB2YXIgbm9kZUEgPSBpbnN0QTsKICAgICAgICAgIHZhciBub2RlQiA9IGluc3RCOwogICAgICAgICAgdmFyIGRlcHRoQSA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQSA9IG5vZGVBOyB0ZW1wQTsgdGVtcEEgPSBnZXRQYXJlbnQodGVtcEEpKSB7CiAgICAgICAgICAgIGRlcHRoQSsrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoQiA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQiA9IG5vZGVCOyB0ZW1wQjsgdGVtcEIgPSBnZXRQYXJlbnQodGVtcEIpKSB7CiAgICAgICAgICAgIGRlcHRoQisrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGRlcHRoQSAtIGRlcHRoQiA+IDApIHsKICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBkZXB0aEEtLTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEIgLSBkZXB0aEEgPiAwKSB7CiAgICAgICAgICAgIG5vZGVCID0gZ2V0UGFyZW50KG5vZGVCKTsKICAgICAgICAgICAgZGVwdGhCLS07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVwdGggPSBkZXB0aEE7CiAgICAgICAgICB3aGlsZSAoZGVwdGgtLSkgewogICAgICAgICAgICBpZiAobm9kZUEgPT09IG5vZGVCIHx8IG5vZGVCICE9PSBudWxsICYmIG5vZGVBID09PSBub2RlQi5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZUE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBldmVudCwgdGFyZ2V0LCBjb21tb24sIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IGV2ZW50Ll9yZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXQ7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlID09PSBjb21tb24pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGluc3RhbmNlLCBhbHRlcm5hdGUgPSBfaW5zdGFuY2U0LmFsdGVybmF0ZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlNC5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTQudGFnOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmVFdmVudCwgZW50ZXJFdmVudCwgZnJvbTIsIHRvMikgewogICAgICAgICAgdmFyIGNvbW1vbiA9IGZyb20yICYmIHRvMiA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20yLCB0bzIpIDogbnVsbDsKICAgICAgICAgIGlmIChmcm9tMiAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20yLCBjb21tb24sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bzIgIT09IG51bGwgJiYgZW50ZXJFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGVudGVyRXZlbnQsIHRvMiwgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00yICYmICFkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UgPSBmdW5jdGlvbihwcm9wTmFtZSwgc2VydmVyVmFsdWUsIGNsaWVudFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFZhbHVlKTsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJWYWx1ZSk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVmFsdWUgPT09IG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJQcm9wIGAlc2AgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAlcyBDbGllbnQ6ICVzIiwgcHJvcE5hbWUsIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSksIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyaWJ1dGVOYW1lcykgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgYXR0cmlidXRlTmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVycm9yKCJFeHRyYSBhdHRyaWJ1dGVzIGZyb20gdGhlIHNlcnZlcjogJXMiLCBuYW1lcyk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24ocmVnaXN0cmF0aW9uTmFtZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgbm9ybWFsaXplSFRNTCA9IGZ1bmN0aW9uKHBhcmVudCwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGVzdEVsZW1lbnQgPSBwYXJlbnQubmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSA/IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQocGFyZW50LnRhZ05hbWUpIDogcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKHBhcmVudC5uYW1lc3BhY2VVUkksIHBhcmVudC50YWdOYW1lKTsKICAgICAgICAgICAgdGVzdEVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgcmV0dXJuIHRlc3RFbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBOT1JNQUxJWkVfTkVXTElORVNfUkVHRVggPSAvXHJcbj8vZzsKICAgICAgICB2YXIgTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYID0gL1x1MDAwMHxcdUZGRkQvZzsKICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUobWFya3VwKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKG1hcmt1cCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWFya3VwU3RyaW5nID0gdHlwZW9mIG1hcmt1cCA9PT0gInN0cmluZyIgPyBtYXJrdXAgOiAiIiArIG1hcmt1cDsKICAgICAgICAgIHJldHVybiBtYXJrdXBTdHJpbmcucmVwbGFjZShOT1JNQUxJWkVfTkVXTElORVNfUkVHRVgsICJcbiIpLnJlcGxhY2UoTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYLCAiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChzZXJ2ZXJUZXh0LCBjbGllbnRUZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VGV4dCk7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVGV4dCk7CiAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclRleHQgPT09IG5vcm1hbGl6ZWRDbGllbnRUZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignVGV4dCBjb250ZW50IGRpZCBub3QgbWF0Y2guIFNlcnZlcjogIiVzIiBDbGllbnQ6ICIlcyInLCBub3JtYWxpemVkU2VydmVyVGV4dCwgbm9ybWFsaXplZENsaWVudFRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgJiYgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRleHQgY29udGVudCBkb2VzIG5vdCBtYXRjaCBzZXJ2ZXItcmVuZGVyZWQgSFRNTC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3A0KCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChub2RlKSB7CiAgICAgICAgICBub2RlLm9uY2xpY2sgPSBub29wNDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50NDAodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50LCBwYXJlbnROYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHZhciBkb21FbGVtZW50OwogICAgICAgICAgdmFyIG5hbWVzcGFjZVVSSSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIG5hbWVzcGFjZVVSSSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIHR5cGUgIT09IHR5cGUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIjwlcyAvPiBpcyB1c2luZyBpbmNvcnJlY3QgY2FzaW5nLiBVc2UgUGFzY2FsQ2FzZSBmb3IgUmVhY3QgY29tcG9uZW50cywgb3IgbG93ZXJjYXNlIGZvciBIVE1MIGVsZW1lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gInNjcmlwdCIpIHsKICAgICAgICAgICAgICB2YXIgZGl2ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PFwvc2NyaXB0PiI7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBkaXYuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gZGl2LnJlbW92ZUNoaWxkKGZpcnN0Q2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUsIHsKICAgICAgICAgICAgICAgIGlzOiBwcm9wcy5pcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGRvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAocHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5tdWx0aXBsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLnNpemUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5zaXplID0gcHJvcHMuc2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUkksIHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRvbUVsZW1lbnQpID09PSAiW29iamVjdCBIVE1MVW5rbm93bkVsZW1lbnRdIiAmJiAhaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRVbmtub3duVGFncywgdHlwZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgdGFnIDwlcz4gaXMgdW5yZWNvZ25pemVkIGluIHRoaXMgYnJvd3Nlci4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIFJlYWN0IGNvbXBvbmVudCwgc3RhcnQgaXRzIG5hbWUgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KS5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcHJvcHMpOwogICAgICAgICAgc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgcHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCBmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIHZhciBsYXN0UHJvcHM7CiAgICAgICAgICB2YXIgbmV4dFByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBsYXN0UmF3UHJvcHM7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gbmV4dFJhd1Byb3BzOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgbGFzdFByb3BzLm9uQ2xpY2sgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG5leHRQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgbmV4dFByb3BzKTsKICAgICAgICAgIHZhciBwcm9wS2V5OwogICAgICAgICAgdmFyIHN0eWxlTmFtZTsKICAgICAgICAgIHZhciBzdHlsZVVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgZm9yIChwcm9wS2V5IGluIGxhc3RQcm9wcykgewogICAgICAgICAgICBpZiAobmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8ICFsYXN0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbGFzdFByb3BzW3Byb3BLZXldID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFN0eWxlID0gbGFzdFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RTdHlsZSkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RTdHlsZS5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgfHwgcHJvcEtleSA9PT0gQ0hJTERSRU4pIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIHZhciBsYXN0UHJvcCA9IGxhc3RQcm9wcyAhPSBudWxsID8gbGFzdFByb3BzW3Byb3BLZXldIDogdm9pZCAwOwogICAgICAgICAgICBpZiAoIW5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBuZXh0UHJvcCA9PT0gbGFzdFByb3AgfHwgbmV4dFByb3AgPT0gbnVsbCAmJiBsYXN0UHJvcCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFByb3ApIHsKICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmICghbmV4dFByb3AgfHwgIW5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiBsYXN0UHJvcFtzdHlsZU5hbWVdICE9PSBuZXh0UHJvcFtzdHlsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9IG5leHRQcm9wW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQucHVzaChwcm9wS2V5LCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0gbmV4dFByb3A7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIHZhciBsYXN0SHRtbCA9IGxhc3RQcm9wID8gbGFzdFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RIdG1sICE9PSBuZXh0SHRtbCkgewogICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCAmJiBsYXN0UHJvcCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0eWxlVXBkYXRlcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFByb3BzW1NUWUxFXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKFNUWUxFLCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcykgewogICAgICAgICAgaWYgKHRhZyA9PT0gImlucHV0IiAmJiBuZXh0UmF3UHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuZXh0UmF3UHJvcHMubmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB1cGRhdGVET01Qcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHdhc0N1c3RvbUNvbXBvbmVudFRhZywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RVcGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHByb3BOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICghcG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcGFyZW50TmFtZXNwYWNlLCByb290Q29udGFpbmVyRWxlbWVudCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIGV4dHJhQXR0cmlidXRlTmFtZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBkb21FbGVtZW50LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlc1tfaV0ubmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNoZWNrZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGVjdGVkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmFkZChhdHRyaWJ1dGVzW19pXS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFyYXdQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IHJhd1Byb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSAiIiArIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sICIiICsgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRXYXJuRGV2ICYmIHRydWUgJiYgLy8gQ29udmluY2UgRmxvdyB3ZSd2ZSBjYWxjdWxhdGVkIGl0IChpdCdzIERFVi1vbmx5IGluIHRoaXMgbWV0aG9kLikKICAgICAgICAgICAgdHlwZW9mIGlzQ3VzdG9tQ29tcG9uZW50VGFnID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICB2YXIgc2VydmVyVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPyBudWxsIDogZ2V0UHJvcGVydHlJbmZvKHByb3BLZXkpOwogICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gPT09IHRydWUpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgfHwgLy8gQ29udHJvbGxlZCBhdHRyaWJ1dGVzIGFyZSBub3QgdmFsaWRhdGVkCiAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBpZ25vcmUgdGhlbSBvbiBjb250cm9sbGVkIHRhZ3MuCiAgICAgICAgICAgICAgcHJvcEtleSA9PT0gInZhbHVlIiB8fCBwcm9wS2V5ID09PSAiY2hlY2tlZCIgfHwgcHJvcEtleSA9PT0gInNlbGVjdGVkIikgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVySFRNTCA9IGRvbUVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkSFRNTCA9IG5vcm1hbGl6ZUhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRIVE1MICE9PSBzZXJ2ZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlckhUTUwsIGV4cGVjdGVkSFRNTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgIGlmIChjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFN0eWxlID0gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBkb21FbGVtZW50LmdldEF0dHJpYnV0ZSgic3R5bGUiKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkU3R5bGUgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBleHBlY3RlZFN0eWxlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgJiYgIWVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkSWdub3JlQXR0cmlidXRlKHByb3BLZXksIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpICYmICFzaG91bGRSZW1vdmVBdHRyaWJ1dGUocHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBvd25OYW1lc3BhY2UgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodGFnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG51bGwgJiYgc3RhbmRhcmROYW1lICE9PSBwcm9wS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUoc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZG9udFdhcm5DdXN0b21FbGVtZW50ID0gZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydDsKICAgICAgICAgICAgICAgIGlmICghZG9udFdhcm5DdXN0b21FbGVtZW50ICYmIG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSAmJiAhaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgLSBTaG91bGQgYmUgaW5mZXJyZWQgYXMgbm90IHVuZGVmaW5lZC4KICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuc2l6ZSA+IDAgJiYgcmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzKGV4dHJhQXR0cmlidXRlTmFtZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIHRydWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmF3UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFRleHQodGV4dE5vZGUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBpc0RpZmZlcmVudCA9IHRleHROb2RlLm5vZGVWYWx1ZSAhPT0gdGV4dDsKICAgICAgICAgIHJldHVybiBpc0RpZmZlcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIDwlcz4gaW4gPCVzPi4iLCBjaGlsZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIHRoZSB0ZXh0IG5vZGUgIiVzIiBpbiA8JXM+LicsIGNoaWxkLm5vZGVWYWx1ZSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyA8JXM+IGluIDwlcz4uIiwgdGFnLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Tm9kZSwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0V4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyB0ZXh0IG5vZGUgZm9yICIlcyIgaW4gPCVzPi4nLCB0ZXh0LCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMoZG9tRWxlbWVudCwgdGFnLCBwcm9wcykgewogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHNwZWNpYWxUYWdzID0gWyJhZGRyZXNzIiwgImFwcGxldCIsICJhcmVhIiwgImFydGljbGUiLCAiYXNpZGUiLCAiYmFzZSIsICJiYXNlZm9udCIsICJiZ3NvdW5kIiwgImJsb2NrcXVvdGUiLCAiYm9keSIsICJiciIsICJidXR0b24iLCAiY2FwdGlvbiIsICJjZW50ZXIiLCAiY29sIiwgImNvbGdyb3VwIiwgImRkIiwgImRldGFpbHMiLCAiZGlyIiwgImRpdiIsICJkbCIsICJkdCIsICJlbWJlZCIsICJmaWVsZHNldCIsICJmaWdjYXB0aW9uIiwgImZpZ3VyZSIsICJmb290ZXIiLCAiZm9ybSIsICJmcmFtZSIsICJmcmFtZXNldCIsICJoMSIsICJoMiIsICJoMyIsICJoNCIsICJoNSIsICJoNiIsICJoZWFkIiwgImhlYWRlciIsICJoZ3JvdXAiLCAiaHIiLCAiaHRtbCIsICJpZnJhbWUiLCAiaW1nIiwgImlucHV0IiwgImlzaW5kZXgiLCAibGkiLCAibGluayIsICJsaXN0aW5nIiwgIm1haW4iLCAibWFycXVlZSIsICJtZW51IiwgIm1lbnVpdGVtIiwgIm1ldGEiLCAibmF2IiwgIm5vZW1iZWQiLCAibm9mcmFtZXMiLCAibm9zY3JpcHQiLCAib2JqZWN0IiwgIm9sIiwgInAiLCAicGFyYW0iLCAicGxhaW50ZXh0IiwgInByZSIsICJzY3JpcHQiLCAic2VjdGlvbiIsICJzZWxlY3QiLCAic291cmNlIiwgInN0eWxlIiwgInN1bW1hcnkiLCAidGFibGUiLCAidGJvZHkiLCAidGQiLCAidGVtcGxhdGUiLCAidGV4dGFyZWEiLCAidGZvb3QiLCAidGgiLCAidGhlYWQiLCAidGl0bGUiLCAidHIiLCAidHJhY2siLCAidWwiLCAid2JyIiwgInhtcCJdOwogICAgICAgICAgdmFyIGluU2NvcGVUYWdzID0gWwogICAgICAgICAgICAiYXBwbGV0IiwKICAgICAgICAgICAgImNhcHRpb24iLAogICAgICAgICAgICAiaHRtbCIsCiAgICAgICAgICAgICJ0YWJsZSIsCiAgICAgICAgICAgICJ0ZCIsCiAgICAgICAgICAgICJ0aCIsCiAgICAgICAgICAgICJtYXJxdWVlIiwKICAgICAgICAgICAgIm9iamVjdCIsCiAgICAgICAgICAgICJ0ZW1wbGF0ZSIsCiAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2h0bWwtaW50ZWdyYXRpb24tcG9pbnQKICAgICAgICAgICAgLy8gVE9ETzogRGlzdGluZ3Vpc2ggYnkgbmFtZXNwYWNlIGhlcmUgLS0gZm9yIDx0aXRsZT4sIGluY2x1ZGluZyBpdCBoZXJlCiAgICAgICAgICAgIC8vIGVycnMgb24gdGhlIHNpZGUgb2YgZmV3ZXIgd2FybmluZ3MKICAgICAgICAgICAgImZvcmVpZ25PYmplY3QiLAogICAgICAgICAgICAiZGVzYyIsCiAgICAgICAgICAgICJ0aXRsZSIKICAgICAgICAgIF07CiAgICAgICAgICB2YXIgYnV0dG9uU2NvcGVUYWdzID0gaW5TY29wZVRhZ3MuY29uY2F0KFsiYnV0dG9uIl0pOwogICAgICAgICAgdmFyIGltcGxpZWRFbmRUYWdzID0gWyJkZCIsICJkdCIsICJsaSIsICJvcHRpb24iLCAib3B0Z3JvdXAiLCAicCIsICJycCIsICJydCJdOwogICAgICAgICAgdmFyIGVtcHR5QW5jZXN0b3JJbmZvID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgICBmb3JtVGFnOiBudWxsLAogICAgICAgICAgICBhVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgYnV0dG9uVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgbm9iclRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIHBUYWdJbkJ1dHRvblNjb3BlOiBudWxsLAogICAgICAgICAgICBsaXN0SXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsLAogICAgICAgICAgICBkbEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbihvbGRJbmZvLCB0YWcpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IGFzc2lnbjIoe30sIG9sZEluZm8gfHwgZW1wdHlBbmNlc3RvckluZm8pOwogICAgICAgICAgICB2YXIgaW5mbyA9IHsKICAgICAgICAgICAgICB0YWcKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGluU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidXR0b25TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWxUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEgJiYgdGFnICE9PSAiYWRkcmVzcyIgJiYgdGFnICE9PSAiZGl2IiAmJiB0YWcgIT09ICJwIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFuY2VzdG9ySW5mby5jdXJyZW50ID0gaW5mbzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmZvcm1UYWcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJhIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImJ1dHRvbiIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJsaSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm87CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGlzVGFnVmFsaWRXaXRoUGFyZW50ID0gZnVuY3Rpb24odGFnLCBwYXJlbnRUYWcpIHsKICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRUYWcpIHsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAib3B0Z3JvdXAiIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJvcHRncm91cCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAib3B0aW9uIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRoIiB8fCB0YWcgPT09ICJ0ZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRyIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNvbCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjYXB0aW9uIiB8fCB0YWcgPT09ICJjb2xncm91cCIgfHwgdGFnID09PSAidGJvZHkiIHx8IHRhZyA9PT0gInRmb290IiB8fCB0YWcgPT09ICJ0aGVhZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImJhc2UiIHx8IHRhZyA9PT0gImJhc2Vmb250IiB8fCB0YWcgPT09ICJiZ3NvdW5kIiB8fCB0YWcgPT09ICJsaW5rIiB8fCB0YWcgPT09ICJtZXRhIiB8fCB0YWcgPT09ICJ0aXRsZSIgfHwgdGFnID09PSAibm9zY3JpcHQiIHx8IHRhZyA9PT0gIm5vZnJhbWVzIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiaHRtbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaGVhZCIgfHwgdGFnID09PSAiYm9keSIgfHwgdGFnID09PSAiZnJhbWVzZXQiOwogICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJmcmFtZSI7CiAgICAgICAgICAgICAgY2FzZSAiI2RvY3VtZW50IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJodG1sIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyAhPT0gImgxIiAmJiBwYXJlbnRUYWcgIT09ICJoMiIgJiYgcGFyZW50VGFnICE9PSAiaDMiICYmIHBhcmVudFRhZyAhPT0gImg0IiAmJiBwYXJlbnRUYWcgIT09ICJoNSIgJiYgcGFyZW50VGFnICE9PSAiaDYiOwogICAgICAgICAgICAgIGNhc2UgInJwIjoKICAgICAgICAgICAgICBjYXNlICJydCI6CiAgICAgICAgICAgICAgICByZXR1cm4gaW1wbGllZEVuZFRhZ3MuaW5kZXhPZihwYXJlbnRUYWcpID09PSAtMTsKICAgICAgICAgICAgICBjYXNlICJib2R5IjoKICAgICAgICAgICAgICBjYXNlICJjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJjb2wiOgogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWUiOgogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0ZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgIGNhc2UgInRoIjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyA9PSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnID0gZnVuY3Rpb24odGFnLCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJhZGRyZXNzIjoKICAgICAgICAgICAgICBjYXNlICJhcnRpY2xlIjoKICAgICAgICAgICAgICBjYXNlICJhc2lkZSI6CiAgICAgICAgICAgICAgY2FzZSAiYmxvY2txdW90ZSI6CiAgICAgICAgICAgICAgY2FzZSAiY2VudGVyIjoKICAgICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGNhc2UgImRpciI6CiAgICAgICAgICAgICAgY2FzZSAiZGl2IjoKICAgICAgICAgICAgICBjYXNlICJkbCI6CiAgICAgICAgICAgICAgY2FzZSAiZmllbGRzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZpZ2NhcHRpb24iOgogICAgICAgICAgICAgIGNhc2UgImZpZ3VyZSI6CiAgICAgICAgICAgICAgY2FzZSAiZm9vdGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkZXIiOgogICAgICAgICAgICAgIGNhc2UgImhncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAibWFpbiI6CiAgICAgICAgICAgICAgY2FzZSAibWVudSI6CiAgICAgICAgICAgICAgY2FzZSAibmF2IjoKICAgICAgICAgICAgICBjYXNlICJvbCI6CiAgICAgICAgICAgICAgY2FzZSAicCI6CiAgICAgICAgICAgICAgY2FzZSAic2VjdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAic3VtbWFyeSI6CiAgICAgICAgICAgICAgY2FzZSAidWwiOgogICAgICAgICAgICAgIGNhc2UgInByZSI6CiAgICAgICAgICAgICAgY2FzZSAibGlzdGluZyI6CiAgICAgICAgICAgICAgY2FzZSAidGFibGUiOgogICAgICAgICAgICAgIGNhc2UgImhyIjoKICAgICAgICAgICAgICBjYXNlICJ4bXAiOgogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICBjYXNlICJmb3JtIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uZm9ybVRhZyB8fCBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAibGkiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImRkIjoKICAgICAgICAgICAgICBjYXNlICJkdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiYSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgIm5vYnIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGlkV2FybiQxID0ge307CiAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbihjaGlsZFRhZywgY2hpbGRUZXh0LCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgYW5jZXN0b3JJbmZvID0gYW5jZXN0b3JJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvOwogICAgICAgICAgICB2YXIgcGFyZW50SW5mbyA9IGFuY2VzdG9ySW5mby5jdXJyZW50OwogICAgICAgICAgICB2YXIgcGFyZW50VGFnID0gcGFyZW50SW5mbyAmJiBwYXJlbnRJbmZvLnRhZzsKICAgICAgICAgICAgaWYgKGNoaWxkVGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkVGFnICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3Rpbmc6IHdoZW4gY2hpbGRUZXh0IGlzIHBhc3NlZCwgY2hpbGRUYWcgc2hvdWxkIGJlIG51bGwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGRUYWcgPSAiI3RleHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50ID0gaXNUYWdWYWxpZFdpdGhQYXJlbnQoY2hpbGRUYWcsIHBhcmVudFRhZykgPyBudWxsIDogcGFyZW50SW5mbzsKICAgICAgICAgICAgdmFyIGludmFsaWRBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgPyBudWxsIDogZmluZEludmFsaWRBbmNlc3RvckZvclRhZyhjaGlsZFRhZywgYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGludmFsaWRQYXJlbnRPckFuY2VzdG9yID0gaW52YWxpZFBhcmVudCB8fCBpbnZhbGlkQW5jZXN0b3I7CiAgICAgICAgICAgIGlmICghaW52YWxpZFBhcmVudE9yQW5jZXN0b3IpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9yVGFnID0gaW52YWxpZFBhcmVudE9yQW5jZXN0b3IudGFnOwogICAgICAgICAgICB2YXIgd2FybktleSA9ICEhaW52YWxpZFBhcmVudCArICJ8IiArIGNoaWxkVGFnICsgInwiICsgYW5jZXN0b3JUYWc7CiAgICAgICAgICAgIGlmIChkaWRXYXJuJDFbd2FybktleV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybiQxW3dhcm5LZXldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRhZ0Rpc3BsYXlOYW1lID0gY2hpbGRUYWc7CiAgICAgICAgICAgIHZhciB3aGl0ZXNwYWNlSW5mbyA9ICIiOwogICAgICAgICAgICBpZiAoY2hpbGRUYWcgPT09ICIjdGV4dCIpIHsKICAgICAgICAgICAgICBpZiAoL1xTLy50ZXN0KGNoaWxkVGV4dCkpIHsKICAgICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIlRleHQgbm9kZXMiOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJXaGl0ZXNwYWNlIHRleHQgbm9kZXMiOwogICAgICAgICAgICAgICAgd2hpdGVzcGFjZUluZm8gPSAiIE1ha2Ugc3VyZSB5b3UgZG9uJ3QgaGF2ZSBhbnkgZXh0cmEgd2hpdGVzcGFjZSBiZXR3ZWVuIHRhZ3Mgb24gZWFjaCBsaW5lIG9mIHlvdXIgc291cmNlIGNvZGUuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiPCIgKyBjaGlsZFRhZyArICI+IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW52YWxpZFBhcmVudCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yVGFnID09PSAidGFibGUiICYmIGNoaWxkVGFnID09PSAidHIiKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGNoaWxkIG9mIDwlcz4uJXMlcyIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZywgd2hpdGVzcGFjZUluZm8sIGluZm8pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGRlc2NlbmRhbnQgb2YgPCVzPi4iLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMSA9ICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciOwogICAgICAgIHZhciBTVVNQRU5TRV9TVEFSVF9EQVRBID0gIiQiOwogICAgICAgIHZhciBTVVNQRU5TRV9FTkRfREFUQSA9ICIvJCI7CiAgICAgICAgdmFyIFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSA9ICIkPyI7CiAgICAgICAgdmFyIFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgPSAiJCEiOwogICAgICAgIHZhciBTVFlMRSQxID0gInN0eWxlIjsKICAgICAgICB2YXIgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgdmFyIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRleHQocm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2U7CiAgICAgICAgICB2YXIgbm9kZVR5cGUgPSByb290Q29udGFpbmVySW5zdGFuY2Uubm9kZVR5cGU7CiAgICAgICAgICBzd2l0Y2ggKG5vZGVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfTk9ERToKICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFOiB7CiAgICAgICAgICAgICAgdHlwZSA9IG5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gIiNkb2N1bWVudCIgOiAiI2ZyYWdtZW50IjsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSByb290Q29udGFpbmVySW5zdGFuY2UuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHJvb3QzID8gcm9vdDMubmFtZXNwYWNlVVJJIDogZ2V0Q2hpbGROYW1lc3BhY2UobnVsbCwgIiIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyByb290Q29udGFpbmVySW5zdGFuY2UucGFyZW50Tm9kZSA6IHJvb3RDb250YWluZXJJbnN0YW5jZTsKICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gY29udGFpbmVyMi5uYW1lc3BhY2VVUkkgfHwgbnVsbDsKICAgICAgICAgICAgICB0eXBlID0gY29udGFpbmVyMi50YWdOYW1lOwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKG93bk5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkYXRlZFRhZyA9IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8obnVsbCwgdmFsaWRhdGVkVGFnKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENoaWxkSG9zdENvbnRleHQocGFyZW50SG9zdENvbnRleHQsIHR5cGUsIHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50SG9zdENvbnRleHREZXYgPSBwYXJlbnRIb3N0Q29udGV4dDsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKHBhcmVudEhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKHBhcmVudEhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRm9yQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBpc0VuYWJsZWQoKTsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKTsKICAgICAgICAgIHZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBzZXRFbmFibGVkKGZhbHNlKTsKICAgICAgICAgIHJldHVybiBhY3RpdmVJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRBZnRlckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICByZXN0b3JlU2VsZWN0aW9uKHNlbGVjdGlvbkluZm9ybWF0aW9uKTsKICAgICAgICAgIHNldEVuYWJsZWQoZXZlbnRzRW5hYmxlZCk7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gbnVsbDsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2UodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHZhciBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcodHlwZSwgbnVsbCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJlbnROYW1lc3BhY2UgPSBob3N0Q29udGV4dERldi5uYW1lc3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ0MCh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXM0ID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXM0KHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbjIoe30sIHBhcmVudENvbnRleHQsIGNoaWxkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0IHx8IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgdHlwZSwgZGlkQ2hhbmdlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYW4gaW5zdGFuY2UgYnkgdGhpcyBwb2ludC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkQ2hhbmdlKSB7CiAgICAgICAgICAgICAgdmFyIG1lcmdlZENvbnRleHQgPSBwcm9jZXNzQ2hpbGRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdHlwZSwgcHJldmlvdXNDb250ZXh0KTsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IG1lcmdlZENvbnRleHQ7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVyZ2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmliZXJNb3VudGVkKGZpYmVyKSB8fCBmaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBzdWJ0cmVlIHBhcmVudCB0byBiZSBhIG1vdW50ZWQgY2xhc3MgY29tcG9uZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuY29udGV4dDsKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IG5vZGUudHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIExlZ2FjeVJvb3QgPSAwOwogICAgICAgIHZhciBDb25jdXJyZW50Um9vdCA9IDE7CiAgICAgICAgdmFyIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgdmFyIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgIHZhciBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChzeW5jUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgc3luY1F1ZXVlID0gW2NhbGxiYWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IHRydWU7CiAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKSB7CiAgICAgICAgICBpZiAoaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3MoKSB7CiAgICAgICAgICBpZiAoIWlzRmx1c2hpbmdTeW5jUXVldWUgJiYgc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSB0cnVlOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZVByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGlzU3luYyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gc3luY1F1ZXVlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKGlzU3luYyk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IHN5bmNRdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2soSW1tZWRpYXRlUHJpb3JpdHksIGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1VwZGF0ZVByaW9yaXR5KTsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZm9ya1N0YWNrID0gW107CiAgICAgICAgdmFyIGZvcmtTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUZvcmtQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVGb3JrQ291bnQgPSAwOwogICAgICAgIHZhciBpZFN0YWNrID0gW107CiAgICAgICAgdmFyIGlkU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlQ29udGV4dElkID0gMTsKICAgICAgICB2YXIgdHJlZUNvbnRleHRPdmVyZmxvdyA9ICIiOwogICAgICAgIGZ1bmN0aW9uIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9ya2VkKSAhPT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rm9ya3NBdExldmVsKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gdHJlZUZvcmtDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJlZUlkKCkgewogICAgICAgICAgdmFyIG92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBpZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBpZCA9IGlkV2l0aExlYWRpbmdCaXQgJiB+Z2V0TGVhZGluZ0JpdChpZFdpdGhMZWFkaW5nQml0KTsKICAgICAgICAgIHJldHVybiBpZC50b1N0cmluZygzMikgKyBvdmVyZmxvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya0NvdW50OwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtQcm92aWRlcjsKICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB0cmVlRm9ya0NvdW50ID0gdG90YWxDaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4sIGluZGV4MikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIGJhc2VJZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBiYXNlT3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGJhc2VMZW5ndGggPSBnZXRCaXRMZW5ndGgoYmFzZUlkV2l0aExlYWRpbmdCaXQpIC0gMTsKICAgICAgICAgIHZhciBiYXNlSWQgPSBiYXNlSWRXaXRoTGVhZGluZ0JpdCAmIH4oMSA8PCBiYXNlTGVuZ3RoKTsKICAgICAgICAgIHZhciBzbG90ID0gaW5kZXgyICsgMTsKICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyBiYXNlTGVuZ3RoOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDMwKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZk92ZXJmbG93Qml0cyA9IGJhc2VMZW5ndGggLSBiYXNlTGVuZ3RoICUgNTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93Qml0cyA9ICgxIDw8IG51bWJlck9mT3ZlcmZsb3dCaXRzKSAtIDE7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvdyA9IChiYXNlSWQgJiBuZXdPdmVyZmxvd0JpdHMpLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VJZCA9IGJhc2VJZCA+PiBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VMZW5ndGggPSBiYXNlTGVuZ3RoIC0gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZMZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdE9mTmV3Qml0cyA9IHNsb3QgPDwgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIGlkID0gcmVzdE9mTmV3Qml0cyB8IHJlc3RPZkJhc2VJZDsKICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gbmV3T3ZlcmZsb3cgKyBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IHJlc3RPZkxlbmd0aCB8IGlkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV3Qml0cyA9IHNsb3QgPDwgYmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIF9pZCA9IG5ld0JpdHMgfCBiYXNlSWQ7CiAgICAgICAgICAgIHZhciBfb3ZlcmZsb3cgPSBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IGxlbmd0aCB8IF9pZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IF9vdmVyZmxvdzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IDE7CiAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSAwOwogICAgICAgICAgICBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJpdExlbmd0aChudW1iZXI0KSB7CiAgICAgICAgICByZXR1cm4gMzIgLSBjbHozMihudW1iZXI0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQ0KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQ0LmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczUgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50NC5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDQucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ0LnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50NC5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50NCwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50NC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gRnJhZ21lbnQxMCkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZnJhZ21lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGZyYWdtZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQoIiIgKyBuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgbnVsbCwgbmV3Q2hpbGQpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQyID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkMi5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQzID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkMy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG9sZEZpYmVyICE9PSBudWxsID8gb2xkRmliZXIua2V5IDogbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBvbGRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBtYXRjaGVkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMyA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIzLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IiB8fCBjaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCwgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoa25vd25LZXlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFrbm93bktleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IoIkVuY291bnRlcmVkIHR3byBjaGlsZHJlbiB3aXRoIHRoZSBzYW1lIGtleSwgYCVzYC4gS2V5cyBzaG91bGQgYmUgdW5pcXVlIHNvIHRoYXQgY29tcG9uZW50cyBtYWludGFpbiB0aGVpciBpZGVudGl0eSBhY3Jvc3MgdXBkYXRlcy4gTm9uLXVuaXF1ZSBrZXlzIG1heSBjYXVzZSBjaGlsZHJlbiB0byBiZSBkdXBsaWNhdGVkIGFuZC9vciBvbWl0dGVkIFx1MjAxNCB0aGUgYmVoYXZpb3IgaXMgdW5zdXBwb3J0ZWQgYW5kIGNvdWxkIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiIsIGtleSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gY2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gY2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRLZXkoaW5pdChwYXlsb2FkKSwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3Q2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld0lkeCA9PT0gbmV3Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlciA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMiA9IHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMi5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmRlbGV0ZShfbmV3RmliZXIyLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjIua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MyID0gbmV3SWR4OwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZHJlbkl0ZXJhYmxlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gb2JqZWN0IGlzIG5vdCBhbiBpdGVyYWJsZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgLy8gJEZsb3dGaXhNZSBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCB0b1N0cmluZ1RhZwogICAgICAgICAgICAgIG5ld0NoaWxkcmVuSXRlcmFibGVbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gIkdlbmVyYXRvciIpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2VuZXJhdG9ycykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgR2VuZXJhdG9ycyBhcyBjaGlsZHJlbiBpcyB1bnN1cHBvcnRlZCBhbmQgd2lsbCBsaWtlbHkgeWllbGQgdW5leHBlY3RlZCByZXN1bHRzIGJlY2F1c2UgZW51bWVyYXRpbmcgYSBnZW5lcmF0b3IgbXV0YXRlcyBpdC4gWW91IG1heSBjb252ZXJ0IGl0IHRvIGFuIGFycmF5IHdpdGggYEFycmF5LmZyb20oKWAgb3IgdGhlIGBbLi4uc3ByZWFkXWAgb3BlcmF0b3IgYmVmb3JlIHJlbmRlcmluZy4gS2VlcCBpbiBtaW5kIHlvdSBtaWdodCBuZWVkIHRvIHBvbHlmaWxsIHRoZXNlIGZlYXR1cmVzIGZvciBvbGRlciBicm93c2Vycy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW5JdGVyYWJsZS5lbnRyaWVzID09PSBpdGVyYXRvckZuKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgX25ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmIChfbmV3Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHZhciBrbm93bktleXMgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIF9zdGVwID0gX25ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gaXRlcmFibGUgb2JqZWN0IHByb3ZpZGVkIG5vIGl0ZXJhdG9yLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzTmV3RmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBuZXdJZHggPSAwOwogICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMyA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMywgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXI0ID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjQua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyNC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjQsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczQgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkICE9PSBudWxsICYmIGN1cnJlbnRGaXJzdENoaWxkLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEZyYWdtZW50MTApIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICAgICAgaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGNoaWxkLCBlbGVtZW50KSB8fCAvLyBMYXp5IHR5cGVzIHNob3VsZCByZWNvbmNpbGUgdGhlaXIgcmVzb2x2ZWQgdHlwZS4KICAgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBkbyB0aGlzIGFmdGVyIHRoZSBIb3QgUmVsb2FkaW5nIGNoZWNrIGFib3ZlLAogICAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAgICAgLy8gaXQgZG9lc24ndCByZXN1c3BlbmQuIFNvIHdlIGNhbid0IGxldCB0aGUgY2FsbCBiZWxvdyBzdXNwZW5kLgogICAgICAgICAgICAgICAgICB0eXBlb2YgZWxlbWVudFR5cGUgPT09ICJvYmplY3QiICYmIGVsZW1lbnRUeXBlICE9PSBudWxsICYmIGVsZW1lbnRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgJiYgcmVzb2x2ZUxhenkoZWxlbWVudFR5cGUpID09PSBjaGlsZC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgIHZhciBfZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY2hpbGQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBfZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQ0ID0gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQpOwogICAgICAgICAgICAgIF9jcmVhdGVkNC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBwb3J0YWwsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwb3J0YWwua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQudGFnID09PSBIb3N0UG9ydGFsICYmIGNoaWxkLnN0YXRlTm9kZS5jb250YWluZXJJbmZvID09PSBwb3J0YWwuY29udGFpbmVySW5mbyAmJiBjaGlsZC5zdGF0ZU5vZGUuaW1wbGVtZW50YXRpb24gPT09IHBvcnRhbC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQgPSB0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsICYmIG5ld0NoaWxkLnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgJiYgbmV3Q2hpbGQua2V5ID09PSBudWxsOwogICAgICAgICAgICBpZiAoaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCkgewogICAgICAgICAgICAgIG5ld0NoaWxkID0gbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkl0ZXJhdG9yKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsICIiICsgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMjsKICAgICAgICB9CiAgICAgICAgdmFyIHJlY29uY2lsZUNoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKHRydWUpOwogICAgICAgIHZhciBtb3VudENoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKGZhbHNlKTsKICAgICAgICBmdW5jdGlvbiBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnQ0LmNoaWxkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVzdW1pbmcgd29yayBub3QgeWV0IGltcGxlbWVudGVkLiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudENoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZC5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnRDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnNpYmxpbmcgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICBuZXdDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRXb3JrSW5Qcm9ncmVzcyhjaGlsZCwgbGFuZXMpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZUN1cnNvciA9IGNyZWF0ZUN1cnNvcihudWxsKTsKICAgICAgICB2YXIgcmVuZGVyZXJTaWdpbDsKICAgICAgICB7CiAgICAgICAgICByZW5kZXJlclNpZ2lsID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hQcm92aWRlcihwcm92aWRlckZpYmVyLCBjb250ZXh0LCBuZXh0VmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHVzaCh2YWx1ZUN1cnNvciwgY29udGV4dC5fY3VycmVudFZhbHVlLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gbmV4dFZhbHVlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gdm9pZCAwICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gbnVsbCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHJlbmRlcmVyU2lnaWwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJEZXRlY3RlZCBtdWx0aXBsZSByZW5kZXJlcnMgY29uY3VycmVudGx5IHJlbmRlcmluZyB0aGUgc2FtZSBjb250ZXh0IHByb3ZpZGVyLiBUaGlzIGlzIGN1cnJlbnRseSB1bnN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gcmVuZGVyZXJTaWdpbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BQcm92aWRlcihjb250ZXh0LCBwcm92aWRlckZpYmVyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gdmFsdWVDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHBvcCh2YWx1ZUN1cnNvciwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnQsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHBhcmVudDsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBub2RlLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhbHRlcm5hdGUgIT09IG51bGwgJiYgIWlzU3Vic2V0T2ZMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9kZSAhPT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByb3BhZ2F0aW9uIHJvb3Qgd2hlbiBzY2hlZHVsaW5nIGNvbnRleHQgd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgZmliZXIucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXh0RmliZXIgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBsaXN0ID0gZmliZXIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICBpZiAobGlzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIHZhciBkZXBlbmRlbmN5ID0gbGlzdC5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgd2hpbGUgKGRlcGVuZGVuY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbmN5LmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgbGlzdC5sYW5lcyA9IG1lcmdlTGFuZXMobGlzdC5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmN5ID0gZGVwZW5kZW5jeS5uZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnR5cGUgPT09IHdvcmtJblByb2dyZXNzMi50eXBlID8gbnVsbCA6IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gRGVoeWRyYXRlZEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudFN1c3BlbnNlID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBqdXN0IGNhbWUgZnJvbSBhIHBhcmVudCBzbyB3ZSBtdXN0IGhhdmUgaGFkIGEgcGFyZW50LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5sYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50U3VzcGVuc2UubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9hbHRlcm5hdGUgPSBwYXJlbnRTdXNwZW5zZS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKF9hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9hbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKF9hbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50U3VzcGVuc2UsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgd2hpbGUgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRGaWJlciA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBuZXh0RmliZXIuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gc2libGluZzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IG5leHRGaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB2YXIgZGVwZW5kZW5jaWVzID0gd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llczsKICAgICAgICAgIGlmIChkZXBlbmRlbmNpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBmaXJzdENvbnRleHQgPSBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIGlmIChmaXJzdENvbnRleHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKGRlcGVuZGVuY2llcy5sYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWRDb250ZXh0KGNvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYpIHsKICAgICAgICAgICAgICBlcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgIGlmIChsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPT09IGNvbnRleHQpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY29udGV4dEl0ZW0gPSB7CiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICBtZW1vaXplZFZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChsYXN0Q29udGV4dERlcGVuZGVuY3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyLmRlcGVuZGVuY2llcyA9IHsKICAgICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjb250ZXh0SXRlbQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbGFzdENvbnRleHREZXBlbmRlbmN5Lm5leHQgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IFtxdWV1ZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzLnB1c2gocXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25jdXJyZW50UXVldWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gY29uY3VycmVudFF1ZXVlc1tpXTsKICAgICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkVXBkYXRlID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIHZhciBsYXN0UGVuZGluZ1VwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAobGFzdFBlbmRpbmdVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIGxhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBmaXJzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlQW5kRWFnZXJseUJhaWxvdXQoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSkgewogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdCA9IG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290OwogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KHNvdXJjZUZpYmVyLCBsYW5lKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIGxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlID09PSBudWxsICYmIChzb3VyY2VGaWJlci5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IHNvdXJjZUZpYmVyOwogICAgICAgICAgdmFyIHBhcmVudCA9IHNvdXJjZUZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcGFyZW50LmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudC5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgYWx0ZXJuYXRlID0gcGFyZW50LmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKChwYXJlbnQuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHZhciByb290MyA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFVwZGF0ZVN0YXRlID0gMDsKICAgICAgICB2YXIgUmVwbGFjZVN0YXRlID0gMTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGUgPSAyOwogICAgICAgIHZhciBDYXB0dXJlVXBkYXRlID0gMzsKICAgICAgICB2YXIgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZTsKICAgICAgICB2YXIgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVVcGRhdGVRdWV1ZShmaWJlcikgewogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBiYXNlU3RhdGU6IGZpYmVyLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIHNoYXJlZDogewogICAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWZmZWN0czogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGV2ZW50VGltZSwKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgdGFnOiBVcGRhdGVTdGF0ZSwKICAgICAgICAgICAgcGF5bG9hZDogbnVsbCwKICAgICAgICAgICAgY2FsbGJhY2s6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID09PSBzaGFyZWRRdWV1ZSAmJiAhZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSkgewogICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgKHNldFN0YXRlLCByZXBsYWNlU3RhdGUsIG9yIGZvcmNlVXBkYXRlKSB3YXMgc2NoZWR1bGVkIGZyb20gaW5zaWRlIGFuIHVwZGF0ZSBmdW5jdGlvbi4gVXBkYXRlIGZ1bmN0aW9ucyBzaG91bGQgYmUgcHVyZSwgd2l0aCB6ZXJvIHNpZGUtZWZmZWN0cy4gQ29uc2lkZXIgdXNpbmcgY29tcG9uZW50RGlkVXBkYXRlIG9yIGEgY2FsbGJhY2suIik7CiAgICAgICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoKSkgewogICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgIHJldHVybiB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHNoYXJlZFF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBzaGFyZWRRdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgc2hhcmVkUXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGNhcHR1cmVkVXBkYXRlKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICB2YXIgbmV3Rmlyc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdMYXN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChmaXJzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZS5ldmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlLmxhbmUsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbmV3Rmlyc3QsCiAgICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbmV3TGFzdCwKICAgICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMsIGluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKHVwZGF0ZS50YWcpIHsKICAgICAgICAgICAgY2FzZSBSZXBsYWNlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGF5bG9hZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENhcHR1cmVVcGRhdGU6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBVcGRhdGVTdGF0ZTogewogICAgICAgICAgICAgIHZhciBfcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFzc2lnbjIoe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcmNlVXBkYXRlOiB7CiAgICAgICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIHByb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICB2YXIgY3VycmVudExhc3RCYXNlVXBkYXRlID0gY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgIT09IGxhc3RCYXNlVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50TGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBxdWV1ZS5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0xhc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUV2ZW50VGltZSA9IHVwZGF0ZS5ldmVudFRpbWU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMyLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZSA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGVFdmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgbmV3U3RhdGUsIHByb3BzLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB1cGRhdGUuY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgLy8gSWYgdGhlIHVwZGF0ZSB3YXMgYWxyZWFkeSBjb21taXR0ZWQsIHdlIHNob3VsZCBub3QgcXVldWUgaXRzCiAgICAgICAgICAgICAgICAvLyBjYWxsYmFjayBhZ2Fpbi4KICAgICAgICAgICAgICAgIHVwZGF0ZS5sYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENhbGxiYWNrOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0cyA9IHF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcXVldWUuZWZmZWN0cyA9IFt1cGRhdGVdOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh1cGRhdGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgIGlmICh1cGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgICAgICAgIHZhciBfZmlyc3RQZW5kaW5nVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdXBkYXRlID0gX2ZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IG5ld0ZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLnNoYXJlZC5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIGludGVybGVhdmVkLmxhbmUpOwogICAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhuZXdMYW5lcyk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG5ld0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGFyZ3VtZW50IHBhc3NlZCBhcyBjYWxsYmFjay4gRXhwZWN0ZWQgYSBmdW5jdGlvbi4gSW5zdGVhZCAiICsgKCJyZWNlaXZlZDogIiArIGNhbGxiYWNrKSk7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpIHsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaGFzRm9yY2VVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgZmluaXNoZWRRdWV1ZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBlZmZlY3RzID0gZmluaXNoZWRRdWV1ZS5lZmZlY3RzOwogICAgICAgICAgZmluaXNoZWRRdWV1ZS5lZmZlY3RzID0gbnVsbDsKICAgICAgICAgIGlmIChlZmZlY3RzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWZmZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBlZmZlY3RzW2ldOwogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGVmZmVjdC5jYWxsYmFjazsKICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVmZmVjdC5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5PX0NPTlRFWFQgPSB7fTsKICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yJDEgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciByb290SW5zdGFuY2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICBmdW5jdGlvbiByZXF1aXJlZENvbnRleHQoYykgewogICAgICAgICAgaWYgKGMgPT09IE5PX0NPTlRFWFQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBob3N0IGNvbnRleHQgdG8gZXhpc3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250YWluZXIoKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIHJvb3RJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250YWluZXIoZmliZXIsIG5leHRSb290SW5zdGFuY2UpIHsKICAgICAgICAgIHB1c2gocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIG5leHRSb290SW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBOT19DT05URVhULCBmaWJlcik7CiAgICAgICAgICB2YXIgbmV4dFJvb3RDb250ZXh0ID0gZ2V0Um9vdEhvc3RDb250ZXh0KG5leHRSb290SW5zdGFuY2UpOwogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Um9vdENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRhaW5lcihmaWJlcikgewogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIHBvcChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0Q29udGV4dCgpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZ2V0Q2hpbGRIb3N0Q29udGV4dChjb250ZXh0LCBmaWJlci50eXBlKTsKICAgICAgICAgIGlmIChjb250ZXh0ID09PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgbmV4dENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIGlmIChjb250ZXh0RmliZXJTdGFja0N1cnNvci5jdXJyZW50ICE9PSBmaWJlcikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgRGVmYXVsdFN1c3BlbnNlQ29udGV4dCA9IDA7CiAgICAgICAgdmFyIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrID0gMTsKICAgICAgICB2YXIgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0ID0gMTsKICAgICAgICB2YXIgRm9yY2VTdXNwZW5zZUZhbGxiYWNrID0gMjsKICAgICAgICB2YXIgc3VzcGVuc2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihEZWZhdWx0U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICBmdW5jdGlvbiBoYXNTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgZmxhZykgewogICAgICAgICAgcmV0dXJuIChwYXJlbnRDb250ZXh0ICYgZmxhZykgIT09IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc2hhbGxvd0NvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgfCBzaGFsbG93Q29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzdWJ0cmVlQ29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgfCBzdWJ0cmVlQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN1c3BlbnNlQ29udGV4dChmaWJlciwgbmV3Q29udGV4dCkgewogICAgICAgICAgcHVzaChzdXNwZW5zZVN0YWNrQ3Vyc29yLCBuZXdDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFN1c3BlbnNlQ29udGV4dChmaWJlcikgewogICAgICAgICAgcG9wKHN1c3BlbnNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKHdvcmtJblByb2dyZXNzMiwgaGFzSW52aXNpYmxlUGFyZW50KSB7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEZpcnN0U3VzcGVuZGVkKHJvdykgewogICAgICAgICAgdmFyIG5vZGUgPSByb3c7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgPT09IG51bGwgfHwgaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhkZWh5ZHJhdGVkKSB8fCBpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhkZWh5ZHJhdGVkKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCAmJiAvLyByZXZlYWxPcmRlciB1bmRlZmluZWQgY2FuJ3QgYmUgdHJ1c3RlZCBiZWNhdXNlIGl0IGRvbid0CiAgICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2Ygd2hldGhlciBpdCBzdXNwZW5kZWQgb3Igbm90LgogICAgICAgICAgICBub2RlLm1lbW9pemVkUHJvcHMucmV2ZWFsT3JkZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKG5vZGUuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHJvdykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHJvdykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIE5vRmxhZ3MkMSA9ICgKICAgICAgICAgIC8qICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBIYXNFZmZlY3QgPSAoCiAgICAgICAgICAvKiAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIEluc2VydGlvbiA9ICgKICAgICAgICAgIC8qICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dCA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUGFzc2l2ZSQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzU291cmNlcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gd29ya0luUHJvZ3Jlc3NTb3VyY2VzW2ldOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbXV0YWJsZVNvdXJjZS5fd29ya0luUHJvZ3Jlc3NWZXJzaW9uUHJpbWFyeSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpIHsKICAgICAgICAgIHZhciBnZXRWZXJzaW9uID0gbXV0YWJsZVNvdXJjZS5fZ2V0VmVyc2lvbjsKICAgICAgICAgIHZhciB2ZXJzaW9uMiA9IGdldFZlcnNpb24obXV0YWJsZVNvdXJjZS5fc291cmNlKTsKICAgICAgICAgIGlmIChyb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID09IG51bGwpIHsKICAgICAgICAgICAgcm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YSA9IFttdXRhYmxlU291cmNlLCB2ZXJzaW9uMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhLnB1c2gobXV0YWJsZVNvdXJjZSwgdmVyc2lvbjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIHZhciByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgUkVfUkVOREVSX0xJTUlUID0gMjU7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICB2YXIgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBtb3VudEhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYgPSBbaG9va05hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGhvb2tUeXBlc0Rldi5wdXNoKGhvb2tOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb29rVHlwZXNEZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYrKzsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2W2hvb2tUeXBlc1VwZGF0ZUluZGV4RGV2XSAhPT0gaG9va05hbWUpIHsKICAgICAgICAgICAgICAgIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGhvb2tOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGVwcyAhPT0gdm9pZCAwICYmIGRlcHMgIT09IG51bGwgJiYgIWlzQXJyYXkyKGRlcHMpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIHJlY2VpdmVkIGEgZmluYWwgYXJndW1lbnQgdGhhdCBpcyBub3QgYW4gYXJyYXkgKGluc3RlYWQsIHJlY2VpdmVkIGAlc2ApLiBXaGVuIHNwZWNpZmllZCwgdGhlIGZpbmFsIGFyZ3VtZW50IG11c3QgYmUgYW4gYXJyYXkuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsIHR5cGVvZiBkZXBzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25Ib29rTWlzbWF0Y2hJbkRldihjdXJyZW50SG9va05hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEpOwogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB0YWJsZSA9ICIiOwogICAgICAgICAgICAgICAgdmFyIHNlY29uZENvbHVtblN0YXJ0ID0gMzA7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBob29rVHlwZXNVcGRhdGVJbmRleERldjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRIb29rTmFtZSA9IGhvb2tUeXBlc0RldltpXTsKICAgICAgICAgICAgICAgICAgdmFyIG5ld0hvb2tOYW1lID0gaSA9PT0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPyBjdXJyZW50SG9va05hbWUgOiBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IGkgKyAxICsgIi4gIiArIG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB3aGlsZSAocm93Lmxlbmd0aCA8IHNlY29uZENvbHVtblN0YXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgcm93ICs9ICIgIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByb3cgKz0gbmV3SG9va05hbWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICB0YWJsZSArPSByb3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaGFzIGRldGVjdGVkIGEgY2hhbmdlIGluIHRoZSBvcmRlciBvZiBIb29rcyBjYWxsZWQgYnkgJXMuIFRoaXMgd2lsbCBsZWFkIHRvIGJ1Z3MgYW5kIGVycm9ycyBpZiBub3QgZml4ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCByZWFkIHRoZSBSdWxlcyBvZiBIb29rczogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3J1bGVzLW9mLWhvb2tzXG5cbiAgIFByZXZpb3VzIHJlbmRlciAgICAgICAgICAgIE5leHQgcmVuZGVyXG4gICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiVzICAgXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXG4iLCBjb21wb25lbnROYW1lLCB0YWJsZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93SW52YWxpZEhvb2tFcnJvcigpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob29rIGNhbGwuIEhvb2tzIGNhbiBvbmx5IGJlIGNhbGxlZCBpbnNpZGUgb2YgdGhlIGJvZHkgb2YgYSBmdW5jdGlvbiBjb21wb25lbnQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1pZ2h0IGhhdmUgbWlzbWF0Y2hpbmcgdmVyc2lvbnMgb2YgUmVhY3QgYW5kIHRoZSByZW5kZXJlciAoc3VjaCBhcyBSZWFjdCBET00pXG4yLiBZb3UgbWlnaHQgYmUgYnJlYWtpbmcgdGhlIFJ1bGVzIG9mIEhvb2tzXG4zLiBZb3UgbWlnaHQgaGF2ZSBtb3JlIHRoYW4gb25lIGNvcHkgb2YgUmVhY3QgaW4gdGhlIHNhbWUgYXBwXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2ludmFsaWQtaG9vay1jYWxsIGZvciB0aXBzIGFib3V0IGhvdyB0byBkZWJ1ZyBhbmQgZml4IHRoaXMgcHJvYmxlbS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcmV2RGVwcyA9PT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIHJlY2VpdmVkIGEgZmluYWwgYXJndW1lbnQgZHVyaW5nIHRoaXMgcmVuZGVyLCBidXQgbm90IGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiBFdmVuIHRob3VnaCB0aGUgZmluYWwgYXJndW1lbnQgaXMgb3B0aW9uYWwsIGl0cyB0eXBlIGNhbm5vdCBjaGFuZ2UgYmV0d2VlbiByZW5kZXJzLiIsIGN1cnJlbnRIb29rTmFtZUluRGV2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcy5sZW5ndGggIT09IHByZXZEZXBzLmxlbmd0aCkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgZmluYWwgYXJndW1lbnQgcGFzc2VkIHRvICVzIGNoYW5nZWQgc2l6ZSBiZXR3ZWVuIHJlbmRlcnMuIFRoZSBvcmRlciBhbmQgc2l6ZSBvZiB0aGlzIGFycmF5IG11c3QgcmVtYWluIGNvbnN0YW50LlxuXG5QcmV2aW91czogJXNcbkluY29taW5nOiAlcyIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCAiWyIgKyBwcmV2RGVwcy5qb2luKCIsICIpICsgIl0iLCAiWyIgKyBuZXh0RGVwcy5qb2luKCIsICIpICsgIl0iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmV2RGVwcy5sZW5ndGggJiYgaSA8IG5leHREZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChvYmplY3RJcyhuZXh0RGVwc1tpXSwgcHJldkRlcHNbaV0pKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBzZWNvbmRBcmcsIG5leHRSZW5kZXJMYW5lcykgewogICAgICAgICAgcmVuZGVyTGFuZXMgPSBuZXh0UmVuZGVyTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgewogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Ll9kZWJ1Z0hvb2tUeXBlcyA6IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICBpZiAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZlJlUmVuZGVycyA9IDA7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICAgICAgaWYgKG51bWJlck9mUmVSZW5kZXJzID49IFJFX1JFTkRFUl9MSU1JVCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUb28gbWFueSByZS1yZW5kZXJzLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiByZW5kZXJzIHRvIHByZXZlbnQgYW4gaW5maW5pdGUgbG9vcC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbnVtYmVyT2ZSZVJlbmRlcnMgKz0gMTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIGNoaWxkcmVuID0gQ29tcG9uZW50KHByb3BzLCBzZWNvbmRBcmcpOwogICAgICAgICAgICB9IHdoaWxlIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpOwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdIb29rVHlwZXMgPSBob29rVHlwZXNEZXY7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlkUmVuZGVyVG9vRmV3SG9va3MgPSBjdXJyZW50SG9vayAhPT0gbnVsbCAmJiBjdXJyZW50SG9vay5uZXh0ICE9PSBudWxsOwogICAgICAgICAgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiAoY3VycmVudDQuZmxhZ3MgJiBTdGF0aWNNYXNrKSAhPT0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFN0YXRpY01hc2spICYmIC8vIERpc2FibGUgdGhpcyB3YXJuaW5nIGluIGxlZ2FjeSBtb2RlLCBiZWNhdXNlIGxlZ2FjeSBTdXNwZW5zZSBpcyB3ZWlyZAogICAgICAgICAgICAvLyBhbmQgY3JlYXRlcyBmYWxzZSBwb3NpdGl2ZXMuIFRvIG1ha2UgdGhpcyB3b3JrIGluIGxlZ2FjeSBtb2RlLCB3ZSdkCiAgICAgICAgICAgIC8vIG5lZWQgdG8gbWFyayBmaWJlcnMgdGhhdCBjb21taXQgaW4gYW4gaW5jb21wbGV0ZSBzdGF0ZSwgc29tZWhvdy4gRm9yCiAgICAgICAgICAgIC8vIG5vdyBJJ2xsIGRpc2FibGUgdGhlIHdhcm5pbmcgdGhhdCBtb3N0IG9mIHRoZSBidWdzIHRoYXQgd291bGQgdHJpZ2dlcgogICAgICAgICAgICAvLyBpdCBhcmUgZWl0aGVyIGV4Y2x1c2l2ZSB0byBjb25jdXJyZW50IG1vZGUgb3IgZXhpc3QgaW4gYm90aC4KICAgICAgICAgICAgKGN1cnJlbnQ0Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogRXhwZWN0ZWQgc3RhdGljIGZsYWcgd2FzIG1pc3NpbmcuIFBsZWFzZSBub3RpZnkgdGhlIFJlYWN0IHRlYW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIGlmIChkaWRSZW5kZXJUb29GZXdIb29rcykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIGZld2VyIGhvb2tzIHRoYW4gZXhwZWN0ZWQuIFRoaXMgbWF5IGJlIGNhdXNlZCBieSBhbiBhY2NpZGVudGFsIGVhcmx5IHJldHVybiBzdGF0ZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRGlkUmVuZGVySWRIb29rKCkgewogICAgICAgICAgdmFyIGRpZFJlbmRlcklkSG9vayA9IGxvY2FsSWRDb3VudGVyICE9PSAwOwogICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgcmV0dXJuIGRpZFJlbmRlcklkSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihNb3VudFBhc3NpdmVEZXYgfCBNb3VudExheW91dERldiB8IFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH4oUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50NC5sYW5lcyA9IHJlbW92ZUxhbmVzKGN1cnJlbnQ0LmxhbmVzLCBsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SG9va3NBZnRlclRocm93KCkgewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICBpZiAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgd2hpbGUgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhvb2sgPSBob29rLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgICBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgICAgIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2UgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBob29rID0gewogICAgICAgICAgICBtZW1vaXplZFN0YXRlOiBudWxsLAogICAgICAgICAgICBiYXNlU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VRdWV1ZTogbnVsbCwKICAgICAgICAgICAgcXVldWU6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZSA9IHdvcmtJblByb2dyZXNzSG9vayA9IGhvb2s7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IGhvb2s7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICB2YXIgbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnRIb29rLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0V29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dDsKICAgICAgICAgICAgY3VycmVudEhvb2sgPSBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobmV4dEN1cnJlbnRIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZW5kZXJlZCBtb3JlIGhvb2tzIHRoYW4gZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudEhvb2sgPSBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICAgIHZhciBuZXdIb29rID0gewogICAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50SG9vay5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgYmFzZVF1ZXVlOiBjdXJyZW50SG9vay5iYXNlUXVldWUsCiAgICAgICAgICAgICAgcXVldWU6IGN1cnJlbnRIb29rLnF1ZXVlLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubWVtb2l6ZWRTdGF0ZSA9IHdvcmtJblByb2dyZXNzSG9vayA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBuZXdIb29rOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbGFzdEVmZmVjdDogbnVsbCwKICAgICAgICAgICAgc3RvcmVzOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXNpY1N0YXRlUmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIGFjdGlvbiA9PT0gImZ1bmN0aW9uIiA/IGFjdGlvbihzdGF0ZSkgOiBhY3Rpb247CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICBpZiAoaW5pdCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdChpbml0aWFsQXJnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdGlhbEFyZzsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IHJlZHVjZXIsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUxMwogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hSZWR1Y2VyQWN0aW9uLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgYmFzZVF1ZXVlID0gY3VycmVudDQuYmFzZVF1ZXVlOwogICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgYmFzZUZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmdGaXJzdCA9IHBlbmRpbmdRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIGJhc2VRdWV1ZS5uZXh0ID0gcGVuZGluZ0ZpcnN0OwogICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZS5uZXh0ID0gYmFzZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQuYmFzZVF1ZXVlICE9PSBiYXNlUXVldWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBlcnJvcjogRXhwZWN0ZWQgd29yay1pbi1wcm9ncmVzcyBxdWV1ZSB0byBiZSBhIGNsb25lLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50NC5iYXNlUXVldWUgPSBiYXNlUXVldWUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY3VycmVudDQuYmFzZVN0YXRlOwogICAgICAgICAgICB2YXIgbmV3QmFzZVN0YXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUxhc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHJlbmRlckxhbmVzLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbmV3QmFzZVF1ZXVlTGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBfY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlLmhhc0VhZ2VyU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSB1cGRhdGUuZWFnZXJTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwgJiYgdXBkYXRlICE9PSBmaXJzdCk7CiAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gbmV3QmFzZVF1ZXVlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3QmFzZVN0YXRlOwogICAgICAgICAgICBob29rLmJhc2VRdWV1ZSA9IG5ld0Jhc2VRdWV1ZUxhc3Q7CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZExhbmUgPSBpbnRlcmxlYXZlZC5sYW5lOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICB2YXIgbGFzdFJlbmRlclBoYXNlVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChsYXN0UmVuZGVyUGhhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciBmaXJzdFJlbmRlclBoYXNlVXBkYXRlID0gbGFzdFJlbmRlclBoYXNlVXBkYXRlLm5leHQ7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUpOwogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtuZXdTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudE11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGlzSHlkcmF0aW5nMiA9IGdldElzSHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICAgIGlmIChnZXRTZXJ2ZXJTbmFwc2hvdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGdldFNlcnZlclNuYXBzaG90LCB3aGljaCBpcyByZXF1aXJlZCBmb3Igc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFdpbGwgcmV2ZXJ0IHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U2VydmVyU25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0U25hcHNob3QgIT09IGdldFNlcnZlclNuYXBzaG90KCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U2VydmVyU25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpbnN0ID0gewogICAgICAgICAgICB2YWx1ZTogbmV4dFNuYXBzaG90LAogICAgICAgICAgICBnZXRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBpbnN0OwogICAgICAgICAgbW91bnRFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldlNuYXBzaG90ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHNuYXBzaG90Q2hhbmdlZCA9ICFvYmplY3RJcyhwcmV2U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICBpZiAoc25hcHNob3RDaGFuZ2VkKSB7CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gaG9vay5xdWV1ZTsKICAgICAgICAgIHVwZGF0ZUVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGlmIChpbnN0LmdldFNuYXBzaG90ICE9PSBnZXRTbmFwc2hvdCB8fCBzbmFwc2hvdENoYW5nZWQgfHwgLy8gQ2hlY2sgaWYgdGhlIHN1c2JjcmliZSBmdW5jdGlvbiBjaGFuZ2VkLiBXZSBjYW4gc2F2ZSBzb21lIG1lbW9yeSBieQogICAgICAgICAgLy8gY2hlY2tpbmcgd2hldGhlciB3ZSBzY2hlZHVsZWQgYSBzdWJzY3JpcHRpb24gZWZmZWN0IGFib3ZlLgogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzSG9vay5tZW1vaXplZFN0YXRlLnRhZyAmIEhhc0VmZmVjdCkgewogICAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgcmVuZGVyZWRTbmFwc2hvdCkgewogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICAgIHZhciBjaGVjayA9IHsKICAgICAgICAgICAgZ2V0U25hcHNob3QsCiAgICAgICAgICAgIHZhbHVlOiByZW5kZXJlZFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHN0b3JlcyA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlczsKICAgICAgICAgICAgaWYgKHN0b3JlcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RvcmVzLnB1c2goY2hlY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0b3JlSW5zdGFuY2UoZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpIHsKICAgICAgICAgIGluc3QudmFsdWUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdWJzY3JpYmVUb1N0b3JlKGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHZhciBoYW5kbGVTdG9yZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGhhbmRsZVN0b3JlQ2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGluc3QudmFsdWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgICAgcmV0dXJuICFvYmplY3RJcyhwcmV2VmFsdWUsIG5leHRWYWx1ZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcikgewogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaWYgKHR5cGVvZiBpbml0aWFsU3RhdGUxMyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbml0aWFsU3RhdGUxMyA9IGluaXRpYWxTdGF0ZTEzKCk7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBob29rLmJhc2VTdGF0ZSA9IGluaXRpYWxTdGF0ZTEzOwogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRSZWR1Y2VyOiBiYXNpY1N0YXRlUmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZTEzCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFNldFN0YXRlLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hFZmZlY3QodGFnLCBjcmVhdGUsIGRlc3Ryb3ksIGRlcHMpIHsKICAgICAgICAgIHZhciBlZmZlY3QgPSB7CiAgICAgICAgICAgIHRhZywKICAgICAgICAgICAgY3JlYXRlLAogICAgICAgICAgICBkZXN0cm95LAogICAgICAgICAgICBkZXBzLAogICAgICAgICAgICAvLyBDaXJjdWxhcgogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICBsYXN0RWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgICAgZWZmZWN0Lm5leHQgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWZmZWN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9yZWYyID0gewogICAgICAgICAgICAgIGN1cnJlbnQ6IGluaXRpYWxWYWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBfcmVmMjsKICAgICAgICAgICAgcmV0dXJuIF9yZWYyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgcmV0dXJuIGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIHZvaWQgMCwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcHJldkVmZmVjdCA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGRlc3Ryb3kgPSBwcmV2RWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZFZmZlY3QuZGVwczsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoTW91bnRQYXNzaXZlRGV2IHwgUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoUGFzc2l2ZSwgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgSW5zZXJ0aW9uLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdChjcmVhdGUsIHJlZikgewogICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHJlZkNhbGxiYWNrID0gcmVmOwogICAgICAgICAgICB2YXIgX2luc3QgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmQ2FsbGJhY2soX2luc3QpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVmQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHJlZiAhPT0gbnVsbCAmJiByZWYgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gcmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFyZWZPYmplY3QuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBmaXJzdCBhcmd1bWVudCB0byBlaXRoZXIgYmUgYSByZWYgY2FsbGJhY2sgb3IgUmVhY3QuY3JlYXRlUmVmKCkgb2JqZWN0LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCAiYW4gb2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKHJlZk9iamVjdCkuam9pbigiLCAiKSArICJ9Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfaW5zdDIgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmT2JqZWN0LmN1cnJlbnQgPSBfaW5zdDI7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZSA6ICJudWxsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlZmZlY3REZXBzID0gZGVwcyAhPT0gbnVsbCAmJiBkZXBzICE9PSB2b2lkIDAgPyBkZXBzLmNvbmNhdChbcmVmXSkgOiBudWxsOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUsIHJlZiksIGVmZmVjdERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgfQogICAgICAgIHZhciB1cGRhdGVEZWJ1Z1ZhbHVlID0gbW91bnREZWJ1Z1ZhbHVlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbmV4dENyZWF0ZSgpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIG5leHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByZXNvbHZlZEN1cnJlbnRIb29rID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gcmVzb2x2ZWRDdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBzaG91bGREZWZlclZhbHVlID0gIWluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKHJlbmRlckxhbmVzKTsKICAgICAgICAgIGlmIChzaG91bGREZWZlclZhbHVlKSB7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXModmFsdWUsIHByZXZWYWx1ZSkpIHsKICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRMYW5lID0gY2xhaW1OZXh0VHJhbnNpdGlvbkxhbmUoKTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXZWYWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VTdGF0ZSkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFRyYW5zaXRpb24oc2V0UGVuZGluZywgY2FsbGJhY2ssIG9wdGlvbnMyKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGhpZ2hlckV2ZW50UHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSwgQ29udGludW91c0V2ZW50UHJpb3JpdHkpKTsKICAgICAgICAgIHNldFBlbmRpbmcodHJ1ZSk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldFBlbmRpbmcoZmFsc2UpOwogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybjMoIkRldGVjdGVkIGEgbGFyZ2UgbnVtYmVyIG9mIHVwZGF0ZXMgaW5zaWRlIHN0YXJ0VHJhbnNpdGlvbi4gSWYgdGhpcyBpcyBkdWUgdG8gYSBzdWJzY3JpcHRpb24gcGxlYXNlIHJlLXdyaXRlIGl0IHRvIHVzZSBSZWFjdCBwcm92aWRlZCBob29rcy4gT3RoZXJ3aXNlIGNvbmN1cnJlbnQgbW9kZSBndWFyYW50ZWVzIGFyZSBvZmYgdGhlIHRhYmxlLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF9tb3VudFN0YXRlID0gbW91bnRTdGF0ZShmYWxzZSksIGlzUGVuZGluZyA9IF9tb3VudFN0YXRlWzBdLCBzZXRQZW5kaW5nID0gX21vdW50U3RhdGVbMV07CiAgICAgICAgICB2YXIgc3RhcnQgPSBzdGFydFRyYW5zaXRpb24uYmluZChudWxsLCBzZXRQZW5kaW5nKTsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHN0YXJ0OwogICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBfdXBkYXRlU3RhdGUgPSB1cGRhdGVTdGF0ZSgpLCBpc1BlbmRpbmcgPSBfdXBkYXRlU3RhdGVbMF07CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHN0YXJ0ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF9yZXJlbmRlclN0YXRlID0gcmVyZW5kZXJTdGF0ZSgpLCBpc1BlbmRpbmcgPSBfcmVyZW5kZXJTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICB2YXIgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldElzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2VJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SWQoKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gcm9vdDMuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHZhciBpZDsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHZhciB0cmVlSWQgPSBnZXRUcmVlSWQoKTsKICAgICAgICAgICAgaWQgPSAiOiIgKyBpZGVudGlmaWVyUHJlZml4ICsgIlIiICsgdHJlZUlkOwogICAgICAgICAgICB2YXIgbG9jYWxJZCA9IGxvY2FsSWRDb3VudGVyKys7CiAgICAgICAgICAgIGlmIChsb2NhbElkID4gMCkgewogICAgICAgICAgICAgIGlkICs9ICJIIiArIGxvY2FsSWQudG9TdHJpbmcoMzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlkICs9ICI6IjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBnbG9iYWxDbGllbnRJZCA9IGdsb2JhbENsaWVudElkQ291bnRlcisrOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiciIgKyBnbG9iYWxDbGllbnRJZC50b1N0cmluZygzMikgKyAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBpZDsKICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSWQoKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIGlkID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaFJlZHVjZXJBY3Rpb24oZmliZXIsIHF1ZXVlLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiU3RhdGUgdXBkYXRlcyBmcm9tIHRoZSB1c2VTdGF0ZSgpIGFuZCB1c2VSZWR1Y2VyKCkgSG9va3MgZG9uJ3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIHRoZSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIGFjdGlvbiwKICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogZmFsc2UsCiAgICAgICAgICAgIGVhZ2VyU3RhdGU6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoaXNSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikpIHsKICAgICAgICAgICAgZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoU2V0U3RhdGUoZmliZXIsIHF1ZXVlLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiU3RhdGUgdXBkYXRlcyBmcm9tIHRoZSB1c2VTdGF0ZSgpIGFuZCB1c2VSZWR1Y2VyKCkgSG9va3MgZG9uJ3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIHRoZSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIGFjdGlvbiwKICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogZmFsc2UsCiAgICAgICAgICAgIGVhZ2VyU3RhdGU6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoaXNSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikpIHsKICAgICAgICAgICAgZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGZpYmVyLmxhbmVzID09PSBOb0xhbmVzICYmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgYWx0ZXJuYXRlLmxhbmVzID09PSBOb0xhbmVzKSkgewogICAgICAgICAgICAgIHZhciBsYXN0UmVuZGVyZWRSZWR1Y2VyID0gcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlcjsKICAgICAgICAgICAgICBpZiAobGFzdFJlbmRlcmVkUmVkdWNlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgZWFnZXJTdGF0ZSA9IGxhc3RSZW5kZXJlZFJlZHVjZXIoY3VycmVudFN0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgICB1cGRhdGUuaGFzRWFnZXJTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5lYWdlclN0YXRlID0gZWFnZXJTdGF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKG9iamVjdElzKGVhZ2VyU3RhdGUsIGN1cnJlbnRTdGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGVBbmRFYWdlcmx5QmFpbG91dChmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25VcGRhdGUocm9vdDMsIHF1ZXVlLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbWFya1VwZGF0ZUluRGV2VG9vbHMoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgcmV0dXJuIGZpYmVyID09PSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKSB7CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgIHZhciBwZW5kaW5nID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpIHsKICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxhbmVzID0gcXVldWUubGFuZXM7CiAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIHF1ZXVlLmxhbmVzID0gbmV3UXVldWVMYW5lczsKICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSwgYWN0aW9uKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDb250ZXh0T25seURpc3BhdGNoZXIgPSB7CiAgICAgICAgICByZWFkQ29udGV4dCwKICAgICAgICAgIHVzZUNhbGxiYWNrOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VDb250ZXh0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VNZW1vOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VSZWR1Y2VyOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VSZWY6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN0YXRlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VUcmFuc2l0aW9uOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSWQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgIH07CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5JbnZhbGlkSG9va0FjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlcnJvcigiRG8gbm90IGNhbGwgSG9va3MgaW5zaWRlIHVzZUVmZmVjdCguLi4pLCB1c2VNZW1vKC4uLiksIG9yIG90aGVyIGJ1aWx0LWluIEhvb2tzLiBZb3UgY2FuIG9ubHkgY2FsbCBIb29rcyBhdCB0aGUgdG9wIGxldmVsIG9mIHlvdXIgUmVhY3QgZnVuY3Rpb24uIEZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3J1bGVzLW9mLWhvb2tzIik7CiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBub3ckMSA9IFNjaGVkdWxlci51bnN0YWJsZV9ub3c7CiAgICAgICAgdmFyIGNvbW1pdFRpbWUgPSAwOwogICAgICAgIHZhciBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgcHJvZmlsZXJTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBmYWxzZTsKICAgICAgICB2YXIgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVJc05lc3RlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCkgewogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN5bmNOZXN0ZWRVcGRhdGVGbGFnKCkgewogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlSXNOZXN0ZWQgPSBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQ7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21taXRUaW1lKCkgewogICAgICAgICAgcmV0dXJuIGNvbW1pdFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZENvbW1pdFRpbWUoKSB7CiAgICAgICAgICBjb21taXRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQcm9maWxlclRpbWVyKGZpYmVyKSB7CiAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICBpZiAoZmliZXIuYWN0dWFsU3RhcnRUaW1lIDwgMCkgewogICAgICAgICAgICBmaWJlci5hY3R1YWxTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZyhmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShmaWJlciwgb3ZlcnJpZGVCYXNlVGltZSkgewogICAgICAgICAgaWYgKHByb2ZpbGVyU3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHByb2ZpbGVyU3RhcnRUaW1lOwogICAgICAgICAgICBmaWJlci5hY3R1YWxEdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgaWYgKG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgICAgICBmaWJlci5zZWxmQmFzZUR1cmF0aW9uID0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSAtMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChsYXlvdXRFZmZlY3RTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gbGF5b3V0RWZmZWN0U3RhcnRUaW1lOwogICAgICAgICAgICBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICByb290My5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaWJlcikgewogICAgICAgICAgaWYgKHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJvb3QzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocGFyZW50U3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBsYXlvdXRFZmZlY3RTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpIHsKICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICBmaWJlci5hY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgaWYgKENvbXBvbmVudCAmJiBDb21wb25lbnQuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbjIoe30sIGJhc2VQcm9wcyk7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSBDb21wb25lbnQuZGVmYXVsdFByb3BzOwogICAgICAgICAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBkZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiYXNlUHJvcHM7CiAgICAgICAgfQogICAgICAgIHZhciBmYWtlSW50ZXJuYWxJbnN0YW5jZSA9IHt9OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uSW52YWxpZENhbGxiYWNrOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgdmFyIGRpZFdhcm5PbkludmFsaWRDYWxsYmFjayA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IG51bGwgfHwgdHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXkgPSBjYWxsZXJOYW1lICsgIl8iICsgY2FsbGJhY2s7CiAgICAgICAgICAgIGlmICghZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrLmFkZChrZXkpOwogICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxlck5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZSA9IGZ1bmN0aW9uKHR5cGUsIHBhcnRpYWxTdGF0ZSkgewogICAgICAgICAgICBpZiAocGFydGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZS5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCk6IEEgdmFsaWQgc3RhdGUgb2JqZWN0IChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGZha2VJbnRlcm5hbEluc3RhbmNlLCAiX3Byb2Nlc3NDaGlsZENvbnRleHQiLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJfcHJvY2Vzc0NoaWxkQ29udGV4dCBpcyBub3QgYXZhaWxhYmxlIGluIFJlYWN0IDE2Ky4gVGhpcyBsaWtlbHkgbWVhbnMgeW91IGhhdmUgbXVsdGlwbGUgY29waWVzIG9mIFJlYWN0IGFuZCBhcmUgYXR0ZW1wdGluZyB0byBuZXN0IGEgUmVhY3QgMTUgdHJlZSBpbnNpZGUgYSBSZWFjdCAxNiB0cmVlIHVzaW5nIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyLCB3aGljaCBpc24ndCBzdXBwb3J0ZWQuIFRyeSB0byBtYWtlIHN1cmUgeW91IGhhdmUgb25seSBvbmUgY29weSBvZiBSZWFjdCAoYW5kIGlkZWFsbHksIHN3aXRjaCB0byBSZWFjdERPTS5jcmVhdGVQb3J0YWwpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5mcmVlemUoZmFrZUludGVybmFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV4dFByb3BzKSB7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlID0gZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKG5leHRQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5PblVuZGVmaW5lZERlcml2ZWRTdGF0ZShjdG9yLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1lbW9pemVkU3RhdGUgPSBwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDAgPyBwcmV2U3RhdGUgOiBhc3NpZ24yKHt9LCBwcmV2U3RhdGUsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYmFzZVN0YXRlID0gbWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNsYXNzQ29tcG9uZW50VXBkYXRlciA9IHsKICAgICAgICAgIGlzTW91bnRlZCwKICAgICAgICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NShpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NShpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnRhZyA9IFJlcGxhY2VTdGF0ZTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGVucXVldWVGb3JjZVVwZGF0ZTogZnVuY3Rpb24oaW5zdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NShpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCkgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuc2hvdWxkQ29tcG9uZW50VXBkYXRlKCk6IFJldHVybmVkIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIGEgYm9vbGVhbiB2YWx1ZS4gTWFrZSBzdXJlIHRvIHJldHVybiB0cnVlIG9yIGZhbHNlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgY3Rvci5wcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuICFzaGFsbG93RXF1YWwyKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbDIob2xkU3RhdGUsIG5ld1N0YXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcykgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIHZhciByZW5kZXJQcmVzZW50ID0gaW5zdGFuY2UucmVuZGVyOwogICAgICAgICAgICBpZiAoIXJlbmRlclByZXNlbnQpIHsKICAgICAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgdHlwZW9mIGN0b3IucHJvdG90eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IE5vIGByZW5kZXJgIG1ldGhvZCBmb3VuZCBvbiB0aGUgcmV0dXJuZWQgY29tcG9uZW50IGluc3RhbmNlOiBkaWQgeW91IGFjY2lkZW50YWxseSByZXR1cm4gYW4gb2JqZWN0IGZyb20gdGhlIGNvbnN0cnVjdG9yPyIsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IHlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gZGVmaW5lIGByZW5kZXJgLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuZ2V0SW5pdGlhbFN0YXRlICYmICFpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUuaXNSZWFjdENsYXNzQXBwcm92ZWQgJiYgIWluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldEluaXRpYWxTdGF0ZSB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIERpZCB5b3UgbWVhbiB0byBkZWZpbmUgYSBzdGF0ZSBwcm9wZXJ0eSBpbnN0ZWFkPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXREZWZhdWx0UHJvcHMgJiYgIWluc3RhbmNlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgd2FzIGRlZmluZWQgb24gJXMsIGEgcGxhaW4gSmF2YVNjcmlwdCBjbGFzcy4gVGhpcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgY2xhc3NlcyBjcmVhdGVkIHVzaW5nIFJlYWN0LmNyZWF0ZUNsYXNzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGRlZmF1bHRQcm9wcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBlcnJvcigicHJvcFR5cGVzIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIHByb3BUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZSkgewogICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZSB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBjb250ZXh0VHlwZSBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3Rvci5jaGlsZENvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmhhcyhjdG9yKSAmJiAvLyBTdHJpY3QgTW9kZSBoYXMgaXRzIG93biB3YXJuaW5nIGZvciBsZWdhY3kgY29udGV4dCwgc28gd2UgY2FuIHNraXAKICAgICAgICAgICAgICAvLyB0aGlzIG9uZS4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIHVzZXMgdGhlIGxlZ2FjeSBjaGlsZENvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgaW5zdGVhZFxuXG4uTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmhhcyhjdG9yKSAmJiAvLyBTdHJpY3QgTW9kZSBoYXMgaXRzIG93biB3YXJuaW5nIGZvciBsZWdhY3kgY29udGV4dCwgc28gd2UgY2FuIHNraXAKICAgICAgICAgICAgICAvLyB0aGlzIG9uZS4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIHVzZXMgdGhlIGxlZ2FjeSBjb250ZXh0VHlwZXMgQVBJIHdoaWNoIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBVc2UgUmVhY3QuY3JlYXRlQ29udGV4dCgpIHdpdGggc3RhdGljIGNvbnRleHRUeXBlIGluc3RlYWQuXG5cbkxlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9sZWdhY3ktY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiY29udGV4dFR5cGVzIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3Rvci5jb250ZXh0VHlwZSAmJiBjdG9yLmNvbnRleHRUeXBlcyAmJiAhZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgZGVjbGFyZXMgYm90aCBjb250ZXh0VHlwZXMgYW5kIGNvbnRleHRUeXBlIHN0YXRpYyBwcm9wZXJ0aWVzLiBUaGUgbGVnYWN5IGNvbnRleHRUeXBlcyBwcm9wZXJ0eSB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50U2hvdWxkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50U2hvdWxkVXBkYXRlKCkuIERpZCB5b3UgbWVhbiBzaG91bGRDb21wb25lbnRVcGRhdGUoKT8gVGhlIG5hbWUgaXMgcGhyYXNlZCBhcyBhIHF1ZXN0aW9uIGJlY2F1c2UgdGhlIGZ1bmN0aW9uIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHZhbHVlLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiBjdG9yLnByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCAmJiB0eXBlb2YgaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpLiBzaG91bGRDb21wb25lbnRVcGRhdGUgc2hvdWxkIG5vdCBiZSB1c2VkIHdoZW4gZXh0ZW5kaW5nIFJlYWN0LlB1cmVDb21wb25lbnQuIFBsZWFzZSBleHRlbmQgUmVhY3QuQ29tcG9uZW50IGlmIHNob3VsZENvbXBvbmVudFVwZGF0ZSBpcyB1c2VkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQSBwdXJlIGNvbXBvbmVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFVubW91bnQoKS4gQnV0IHRoZXJlIGlzIG5vIHN1Y2ggbGlmZWN5Y2xlIG1ldGhvZC4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxVbm1vdW50KCk/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnREaWRSZWNlaXZlUHJvcHMoKS4gQnV0IHRoZXJlIGlzIG5vIHN1Y2ggbGlmZWN5Y2xlIG1ldGhvZC4gSWYgeW91IG1lYW50IHRvIHVwZGF0ZSB0aGUgc3RhdGUgaW4gcmVzcG9uc2UgdG8gY2hhbmdpbmcgcHJvcHMsIHVzZSBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCkuIElmIHlvdSBtZWFudCB0byBmZXRjaCBkYXRhIG9yIHJ1biBzaWRlLWVmZmVjdHMgb3IgbXV0YXRpb25zIGFmdGVyIFJlYWN0IGhhcyB1cGRhdGVkIHRoZSBVSSwgdXNlIGNvbXBvbmVudERpZFVwZGF0ZSgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc011dGF0ZWRQcm9wcyA9IGluc3RhbmNlLnByb3BzICE9PSBuZXdQcm9wczsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSB2b2lkIDAgJiYgaGFzTXV0YXRlZFByb3BzKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IFdoZW4gY2FsbGluZyBzdXBlcigpIGluIGAlc2AsIG1ha2Ugc3VyZSB0byBwYXNzIHVwIHRoZSBzYW1lIHByb3BzIHRoYXQgeW91ciBjb21wb25lbnQncyBjb25zdHJ1Y3RvciB3YXMgcGFzc2VkLiIsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiU2V0dGluZyBkZWZhdWx0UHJvcHMgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWZpbmUgZGVmYXVsdFByb3BzIGFzIGEgc3RhdGljIHByb3BlcnR5IG9uICVzLiIsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAhZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIHNob3VsZCBiZSB1c2VkIHdpdGggY29tcG9uZW50RGlkVXBkYXRlKCkuIFRoaXMgY29tcG9uZW50IGRlZmluZXMgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBvbmx5LiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoKSBpcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGEgc3RhdGljIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgaXMgZGVmaW5lZCBhcyBhIHN0YXRpYyBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhbiBpbnN0YW5jZSBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9zdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICBpZiAoX3N0YXRlICYmICh0eXBlb2YgX3N0YXRlICE9PSAib2JqZWN0IiB8fCBpc0FycmF5Mihfc3RhdGUpKSkgewogICAgICAgICAgICAgIGVycm9yKCIlcy5zdGF0ZTogbXVzdCBiZSBzZXQgdG8gYW4gb2JqZWN0IG9yIG51bGwiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgY3Rvci5jaGlsZENvbnRleHRUeXBlcyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuZ2V0Q2hpbGRDb250ZXh0KCk6IGNoaWxkQ29udGV4dFR5cGVzIG11c3QgYmUgZGVmaW5lZCBpbiBvcmRlciB0byB1c2UgZ2V0Q2hpbGRDb250ZXh0KCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZXIgPSBjbGFzc0NvbXBvbmVudFVwZGF0ZXI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgICAgICBzZXQzKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgewogICAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEluc3RhbmNlID0gZmFrZUludGVybmFsSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBwcm9wcykgewogICAgICAgICAgdmFyIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoImNvbnRleHRUeXBlIiBpbiBjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSAoCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgY29udGV4dFR5cGUgPT09IG51bGwgfHwgY29udGV4dFR5cGUgIT09IHZvaWQgMCAmJiBjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFICYmIGNvbnRleHRUeXBlLl9jb250ZXh0ID09PSB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIiOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byB1bmRlZmluZWQuIFRoaXMgY2FuIGJlIGNhdXNlZCBieSBhIHR5cG8gb3IgYnkgbWl4aW5nIHVwIG5hbWVkIGFuZCBkZWZhdWx0IGltcG9ydHMuIFRoaXMgY2FuIGFsc28gaGFwcGVuIGR1ZSB0byBhIGNpcmN1bGFyIGRlcGVuZGVuY3ksIHNvIHRyeSBtb3ZpbmcgdGhlIGNyZWF0ZUNvbnRleHQoKSBjYWxsIHRvIGEgc2VwYXJhdGUgZmlsZS4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dFR5cGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Qcm92aWRlciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuQ29uc3VtZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlZmluZXMgYW4gaW52YWxpZCBjb250ZXh0VHlwZS4gY29udGV4dFR5cGUgc2hvdWxkIHBvaW50IHRvIHRoZSBDb250ZXh0IG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVDb250ZXh0KCkuJXMiLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IGN0b3IuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGNvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgIT09IG51bGwgJiYgaW5zdGFuY2Uuc3RhdGUgIT09IHZvaWQgMCA/IGluc3RhbmNlLnN0YXRlIDogbnVsbDsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBzdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCJgJXNgIHVzZXMgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYnV0IGl0cyBpbml0aWFsIHN0YXRlIGlzICVzLiBUaGlzIGlzIG5vdCByZWNvbW1lbmRlZC4gSW5zdGVhZCwgZGVmaW5lIHRoZSBpbml0aWFsIHN0YXRlIGJ5IGFzc2lnbmluZyBhbiBvYmplY3QgdG8gYHRoaXMuc3RhdGVgIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBgJXNgLiBUaGlzIGVuc3VyZXMgdGhhdCBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBhcmd1bWVudHMgaGF2ZSBhIGNvbnNpc3RlbnQgc2hhcGUuIiwgY29tcG9uZW50TmFtZSwgaW5zdGFuY2Uuc3RhdGUgPT09IG51bGwgPyAibnVsbCIgOiAidW5kZWZpbmVkIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxVcGRhdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gImNvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJjb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICB2YXIgbmV3QXBpTmFtZSA9IHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiA/ICJnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSIgOiAiZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmFkZChfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbnNhZmUgbGVnYWN5IGxpZmVjeWNsZXMgd2lsbCBub3QgYmUgY2FsbGVkIGZvciBjb21wb25lbnRzIHVzaW5nIG5ldyBjb21wb25lbnQgQVBJcy5cblxuJXMgdXNlcyAlcyBidXQgYWxzbyBjb250YWlucyB0aGUgZm9sbG93aW5nIGxlZ2FjeSBsaWZlY3ljbGVzOiVzJXMlc1xuXG5UaGUgYWJvdmUgbGlmZWN5Y2xlcyBzaG91bGQgYmUgcmVtb3ZlZC4gTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTpcbmh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMiLCBfY29tcG9uZW50TmFtZSwgbmV3QXBpTmFtZSwgZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsTW91bnROYW1lIDogIiIsIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lIDogIiIsIGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxVcGRhdGVOYW1lIDogIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzTGVnYWN5Q29udGV4dENvbnN1bWVyKSB7CiAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IG9sZFN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5yZWZzID0ge307CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3Mod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHVucmVzb2x2ZWRPbGRQcm9wcyk7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIHVucmVzb2x2ZWROZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IGluc3RhbmNlLmNvbnRleHQ7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV4dFVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBuZXh0Q29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBuZXh0VW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIHZhciBoYXNOZXdMaWZlY3ljbGVzID0gdHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gdW5yZXNvbHZlZE5ld1Byb3BzIHx8IG9sZENvbnRleHQgIT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzZXRIYXNGb3JjZVVwZGF0ZUJlZm9yZVByb2Nlc3NpbmcoKTsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaW5zdGFuY2Uuc3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzID09PSB1bnJlc29sdmVkTmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgJiYgIWVuYWJsZUxhenlDb250ZXh0UHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB8fCBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCkgfHwgLy8gVE9ETzogSW4gc29tZSBjYXNlcywgd2UnbGwgZW5kIHVwIGNoZWNraW5nIGlmIGNvbnRleHQgaGFzIGNoYW5nZWQgdHdpY2UsCiAgICAgICAgICAvLyBib3RoIGJlZm9yZSBhbmQgYWZ0ZXIgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAgaGFzIGJlZW4gY2FsbGVkLiBOb3QgaWRlYWwsCiAgICAgICAgICAvLyBidXQgSSdtIGxvYXRoIHRvIHJlZmFjdG9yIHRoaXMgZnVuY3Rpb24uIFRoaXMgb25seSBoYXBwZW5zIGZvciBtZW1vaXplZAogICAgICAgICAgLy8gY29tcG9uZW50cyBzbyBpdCdzIG5vdCB0aGF0IGNvbW1vbi4KICAgICAgICAgIGVuYWJsZUxhenlDb250ZXh0UHJvcGFnYXRpb247CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2UpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2UsCiAgICAgICAgICAgIHN0YWNrOiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qoc291cmNlKSwKICAgICAgICAgICAgZGlnZXN0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDYXB0dXJlZFZhbHVlKHZhbHVlLCBkaWdlc3QsIHN0YWNrKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgc291cmNlOiBudWxsLAogICAgICAgICAgICBzdGFjazogc3RhY2sgIT0gbnVsbCA/IHN0YWNrIDogbnVsbCwKICAgICAgICAgICAgZGlnZXN0OiBkaWdlc3QgIT0gbnVsbCA/IGRpZ2VzdCA6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbG9nQ2FwdHVyZWRFcnJvcihib3VuZGFyeSwgZXJyb3JJbmZvKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbG9nRXJyb3IgPSBzaG93RXJyb3JEaWFsb2coYm91bmRhcnksIGVycm9ySW5mbyk7CiAgICAgICAgICAgIGlmIChsb2dFcnJvciA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVycm9yMiA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICB2YXIgc291cmNlID0gZXJyb3JJbmZvLnNvdXJjZTsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvckluZm8uc3RhY2s7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudFN0YWNrID0gc3RhY2sgIT09IG51bGwgPyBzdGFjayA6ICIiOwogICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IHNvdXJjZSA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoc291cmNlKSA6IG51bGw7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWVNZXNzYWdlID0gY29tcG9uZW50TmFtZSA/ICJUaGUgYWJvdmUgZXJyb3Igb2NjdXJyZWQgaW4gdGhlIDwiICsgY29tcG9uZW50TmFtZSArICI+IGNvbXBvbmVudDoiIDogIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiBvbmUgb2YgeW91ciBSZWFjdCBjb21wb25lbnRzOiI7CiAgICAgICAgICAgICAgdmFyIGVycm9yQm91bmRhcnlNZXNzYWdlOwogICAgICAgICAgICAgIGlmIChib3VuZGFyeS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9ICJDb25zaWRlciBhZGRpbmcgYW4gZXJyb3IgYm91bmRhcnkgdG8geW91ciB0cmVlIHRvIGN1c3RvbWl6ZSBlcnJvciBoYW5kbGluZyBiZWhhdmlvci5cblZpc2l0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9lcnJvci1ib3VuZGFyaWVzIHRvIGxlYXJuIG1vcmUgYWJvdXQgZXJyb3IgYm91bmRhcmllcy4iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGJvdW5kYXJ5KSB8fCAiQW5vbnltb3VzIjsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIlJlYWN0IHdpbGwgdHJ5IHRvIHJlY3JlYXRlIHRoaXMgY29tcG9uZW50IHRyZWUgZnJvbSBzY3JhdGNoICIgKyAoInVzaW5nIHRoZSBlcnJvciBib3VuZGFyeSB5b3UgcHJvdmlkZWQsICIgKyBlcnJvckJvdW5kYXJ5TmFtZSArICIuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21iaW5lZE1lc3NhZ2UgPSBjb21wb25lbnROYW1lTWVzc2FnZSArICJcbiIgKyBjb21wb25lbnRTdGFjayArICJcblxuIiArICgiIiArIGVycm9yQm91bmRhcnlNZXNzYWdlKTsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGNvbWJpbmVkTWVzc2FnZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAkMSA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290RXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gewogICAgICAgICAgICBlbGVtZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVycm9yMiA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvblVuY2F1Z2h0RXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKGZpYmVyLCBlcnJvckluZm8sIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnRhZyA9IENhcHR1cmVVcGRhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID0gZmliZXIudHlwZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3I7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yJDEpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdCA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChpbnN0ICE9PSBudWxsICYmIHR5cGVvZiBpbnN0LmNvbXBvbmVudERpZENhdGNoID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uIGNhbGxiYWNrKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgbWFya0xlZ2FjeUVycm9yQm91bmRhcnlBc0ZhaWxlZCh0aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yJDEyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB0aGlzLmNvbXBvbmVudERpZENhdGNoKGVycm9yJDEyLCB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjazogc3RhY2sgIT09IG51bGwgPyBzdGFjayA6ICIiCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKGZpYmVyLmxhbmVzLCBTeW5jTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEVycm9yIGJvdW5kYXJpZXMgc2hvdWxkIGltcGxlbWVudCBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoKS4gSW4gdGhhdCBtZXRob2QsIHJldHVybiBhIHN0YXRlIHVwZGF0ZSB0byBkaXNwbGF5IGFuIGVycm9yIG1lc3NhZ2Ugb3IgZmFsbGJhY2sgVUkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgdmFyIHRocmVhZElEczsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCQxKCk7CiAgICAgICAgICAgIHRocmVhZElEcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJlYWRJRHMgPSBwaW5nQ2FjaGUuZ2V0KHdha2VhYmxlKTsKICAgICAgICAgICAgaWYgKHRocmVhZElEcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBwaW5nQ2FjaGUuc2V0KHdha2VhYmxlLCB0aHJlYWRJRHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRocmVhZElEcy5oYXMobGFuZXMpKSB7CiAgICAgICAgICAgIHRocmVhZElEcy5hZGQobGFuZXMpOwogICAgICAgICAgICB2YXIgcGluZyA9IHBpbmdTdXNwZW5kZWRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdha2VhYmxlLCBsYW5lcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FrZWFibGUudGhlbihwaW5nLCBwaW5nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgd2FrZWFibGVzID0gc3VzcGVuc2VCb3VuZGFyeS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh3YWtlYWJsZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS51cGRhdGVRdWV1ZSA9IHVwZGF0ZVF1ZXVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2FrZWFibGVzLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0U3VzcGVuZGVkQ29tcG9uZW50KHNvdXJjZUZpYmVyLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHZhciB0YWcgPSBzb3VyY2VGaWJlci50YWc7CiAgICAgICAgICBpZiAoKHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiAodGFnID09PSBGdW5jdGlvbkNvbXBvbmVudCB8fCB0YWcgPT09IEZvcndhcmRSZWYyIHx8IHRhZyA9PT0gU2ltcGxlTWVtb0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRTb3VyY2UgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50U291cmNlKSB7CiAgICAgICAgICAgICAgc291cmNlRmliZXIudXBkYXRlUXVldWUgPSBjdXJyZW50U291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50U291cmNlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBjdXJyZW50U291cmNlLmxhbmVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCAmJiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uobm9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChub2RlICE9PSBudWxsKTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICBpZiAoKHN1c3BlbnNlQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5ID09PSByZXR1cm5GaWJlcikgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgfD0gRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyAmPSB+KExpZmVjeWNsZUVmZmVjdE1hc2sgfCBJbmNvbXBsZXRlKTsKICAgICAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTb3VyY2VGaWJlciA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U291cmNlRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc291cmNlRmliZXIudGFnID0gSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgICAgIGVucXVldWVVcGRhdGUoc291cmNlRmliZXIsIHVwZGF0ZSwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIFN5bmNMYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3VzcGVuc2VCb3VuZGFyeTsKICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkubGFuZXMgPSByb290UmVuZGVyTGFuZXM7CiAgICAgICAgICByZXR1cm4gc3VzcGVuc2VCb3VuZGFyeTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dFeGNlcHRpb24ocm9vdDMsIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgdmFsdWUsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgfD0gSW5jb21wbGV0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdmFsdWU7CiAgICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ29tcG9uZW50KHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN1c3BlbnNlQm91bmRhcnkgPSBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaW5jbHVkZXNTeW5jTGFuZShyb290UmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdW5jYXVnaHRTdXNwZW5zZUVycm9yID0gbmV3IEVycm9yKCJBIGNvbXBvbmVudCBzdXNwZW5kZWQgd2hpbGUgcmVzcG9uZGluZyB0byBzeW5jaHJvbm91cyBpbnB1dC4gVGhpcyB3aWxsIGNhdXNlIHRoZSBVSSB0byBiZSByZXBsYWNlZCB3aXRoIGEgbG9hZGluZyBpbmRpY2F0b3IuIFRvIGZpeCwgdXBkYXRlcyB0aGF0IHN1c3BlbmQgc2hvdWxkIGJlIHdyYXBwZWQgd2l0aCBzdGFydFRyYW5zaXRpb24uIik7CiAgICAgICAgICAgICAgdmFsdWUgPSB1bmNhdWdodFN1c3BlbnNlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIHNvdXJjZUZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgdmFyIF9zdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIGlmIChfc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKChfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyAmIFNob3VsZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIF9zdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKF9zdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlRmliZXIpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgIHJlbmRlckRpZEVycm9yKHZhbHVlKTsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIF9lcnJvckluZm8gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVJvb3RFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF9lcnJvckluZm8sIGxhbmUpOwogICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgdXBkYXRlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHZhciBjdG9yID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncyAmJiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IGluc3RhbmNlICE9PSBudWxsICYmIHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgICB2YXIgX2xhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgX2xhbmUpOwogICAgICAgICAgICAgICAgICB2YXIgX3VwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBlcnJvckluZm8sIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgX3VwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IHdvcmtJblByb2dyZXNzMi5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlICh3b3JrSW5Qcm9ncmVzczIgIT09IG51bGwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5kZWRDYWNoZSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0QmFkQ2xhc3M7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRSZXZlYWxPcmRlcjsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VGFpbE9wdGlvbnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0QmFkQ2xhc3MgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gZmFsc2U7CiAgICAgICAgICBkaWRXYXJuQWJvdXRSZXZlYWxPcmRlciA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnMgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZVVubW91bnRDdXJyZW50QW5kUmVjb25jaWxlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZvcndhcmRSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByZW5kZXIyID0gQ29tcG9uZW50LnJlbmRlcjsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlcjIsIG5leHRQcm9wcywgcmVmLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlcjIsIG5leHRQcm9wcywgcmVmLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiAhZGlkUmVjZWl2ZVVwZGF0ZSkgewogICAgICAgICAgICBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBDb21wb25lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgJiYgQ29tcG9uZW50LmNvbXBhcmUgPT09IG51bGwgJiYgLy8gU2ltcGxlTWVtb0NvbXBvbmVudCBjb2RlcGF0aCBkb2Vzbid0IHJlc29sdmUgb3V0ZXIgcHJvcHMgZWl0aGVyLgogICAgICAgICAgICBDb21wb25lbnQuZGVmYXVsdFByb3BzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRUeXBlID0gdHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBTaW1wbGVNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZXNvbHZlZFR5cGUsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChDb21wb25lbnQuZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBtZW1vIGNvbXBvbmVudHMgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVXNlIEphdmFTY3JpcHQgZGVmYXVsdCBwYXJhbWV0ZXJzIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGQgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMoQ29tcG9uZW50LnR5cGUsIG51bGwsIG5leHRQcm9wcywgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2hpbGQucmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3R5cGUgPSBDb21wb25lbnQudHlwZTsKICAgICAgICAgICAgdmFyIF9pbm5lclByb3BUeXBlcyA9IF90eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgaWYgKF9pbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgX2lubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudENoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ID0gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCkgewogICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudENoaWxkLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHZhciBjb21wYXJlID0gQ29tcG9uZW50LmNvbXBhcmU7CiAgICAgICAgICAgIGNvbXBhcmUgPSBjb21wYXJlICE9PSBudWxsID8gY29tcGFyZSA6IHNoYWxsb3dFcXVhbDI7CiAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50NC5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgbmV4dFByb3BzKTsKICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIG91dGVyTWVtb1R5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBvdXRlck1lbW9UeXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBvdXRlck1lbW9UeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IG91dGVyTWVtb1R5cGUgJiYgb3V0ZXJNZW1vVHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIChTaW1wbGVNZW1vQ29tcG9uZW50IGhhcyBubyBkZWZhdWx0UHJvcHMpCiAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShvdXRlck1lbW9UeXBlKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICBpZiAoc2hhbGxvd0VxdWFsMihwcmV2UHJvcHMsIG5leHRQcm9wcykgJiYgY3VycmVudDQucmVmID09PSB3b3JrSW5Qcm9ncmVzczIucmVmICYmIC8vIFByZXZlbnQgYmFpbG91dCBpZiB0aGUgaW1wbGVtZW50YXRpb24gY2hhbmdlZCBkdWUgdG8gaG90IHJlbG9hZC4KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPT09IGN1cnJlbnQ0LnR5cGUpIHsKICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IG5leHRQcm9wcyA9IHByZXZQcm9wczsKICAgICAgICAgICAgICBpZiAoIWNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgoY3VycmVudDQuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgOiBudWxsOwogICAgICAgICAgaWYgKG5leHRQcm9wcy5tb2RlID09PSAiaGlkZGVuIiB8fCBlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogbnVsbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5leHRTdGF0ZTsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICB2YXIgc3Bhd25lZENhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5leHRCYXNlTGFuZXM7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHByZXZCYXNlTGFuZXMgPSBwcmV2U3RhdGUuYmFzZUxhbmVzOwogICAgICAgICAgICAgICAgbmV4dEJhc2VMYW5lcyA9IG1lcmdlTGFuZXMocHJldkJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dEJhc2VMYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBsYW5lVG9MYW5lcyhPZmZzY3JlZW5MYW5lKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogbmV4dEJhc2VMYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogc3Bhd25lZENhY2hlUG9vbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IF9uZXh0U3RhdGU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBuZXh0QmFzZUxhbmVzKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZTIgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlMjsKICAgICAgICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzMiA9IHByZXZTdGF0ZSAhPT0gbnVsbCA/IHByZXZTdGF0ZS5iYXNlTGFuZXMgOiByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgc3VidHJlZVJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfc3VidHJlZVJlbmRlckxhbmVzOwogICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgX3N1YnRyZWVSZW5kZXJMYW5lcyA9IG1lcmdlTGFuZXMocHJldlN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgX3N1YnRyZWVSZW5kZXJMYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBfc3VidHJlZVJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQcm9maWxlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgJiYgcmVmICE9PSBudWxsIHx8IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0LnJlZiAhPT0gcmVmKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWYyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hvdWxkRXJyb3Iod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wSW5zdGFuY2UgPSBuZXcgY3Rvcih3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcywgX2luc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgX2luc3RhbmNlLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKF9pbnN0YW5jZSwgc3RhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gbmV3IEVycm9yKCJTaW11bGF0ZWQgZXJyb3IgY29taW5nIGZyb20gRGV2VG9vbHMiKTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgd29ya0luUHJvZ3Jlc3MyKSwgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGU7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSXQgbG9va3MgbGlrZSAlcyBpcyByZWFzc2lnbmluZyBpdHMgb3duIGB0aGlzLnByb3BzYCB3aGlsZSByZW5kZXJpbmcuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgY2FuIGxlYWQgdG8gY29uZnVzaW5nIGJ1Z3MuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJhIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRVbml0T2ZXb3JrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGRpZENhcHR1cmVFcnJvciA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAocm9vdDMucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLnBlbmRpbmdDb250ZXh0LCByb290My5wZW5kaW5nQ29udGV4dCAhPT0gcm9vdDMuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRleHQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBjdXJyZW50IGZpYmVyLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV4dFByb3BzLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgIHZhciBvdmVycmlkZVN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IG5leHRDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGNhY2hlOiBuZXh0U3RhdGUuY2FjaGUsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbmV4dFN0YXRlLnBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXMsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0Q2hpbGRyZW4gIT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgX3JlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzICYgflBsYWNlbWVudCB8IEh5ZHJhdGluZzsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIGlmIChuZXh0Q2hpbGRyZW4gPT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIG5leHRQcm9wcyk7CiAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJldlByb3BzICE9PSBudWxsICYmIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByZXZQcm9wcykpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENvbnRlbnRSZXNldDsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExhenlDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IGVsZW1lbnRUeXBlOwogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgdmFyIENvbXBvbmVudCA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFRhZyA9IHdvcmtJblByb2dyZXNzMi50YWcgPSByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpOwogICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQsIHByb3BzKTsKICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIHN3aXRjaCAocmVzb2x2ZWRUYWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVGb3J3YXJkUmVmKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIGZvciBvdXRlciBvbmx5CiAgICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVNZW1vQ29tcG9uZW50KAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIENvbXBvbmVudCwKICAgICAgICAgICAgICAgIHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudC50eXBlLCByZXNvbHZlZFByb3BzKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQgIT09IG51bGwgJiYgdHlwZW9mIENvbXBvbmVudCA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgdHlwZW9mIENvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gaGF2ZSBhIHJlbmRlciBtZXRob2QsIGJ1dCBkb2Vzbid0IGV4dGVuZCBSZWFjdC5Db21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIFJ1biB0aGVzZSBjaGVja3MgaW4gcHJvZHVjdGlvbiBvbmx5IGlmIHRoZSBmbGFnIGlzIG9mZi4KICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDAKICAgICAgICAgICkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMiA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gdmFsdWUuc3RhdGUgIT09IG51bGwgJiYgdmFsdWUuc3RhdGUgIT09IHZvaWQgMCA/IHZhbHVlLnN0YXRlIDogbnVsbDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHZhbHVlKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4obnVsbCwgd29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQpIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbiBjb21wb25lbnQuIiwgQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3duZXJOYW1lIHx8ICIiOwogICAgICAgICAgICAgIHZhciBkZWJ1Z1NvdXJjZSA9IHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgaWYgKGRlYnVnU291cmNlKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nS2V5ID0gZGVidWdTb3VyY2UuZmlsZU5hbWUgKyAiOiIgKyBkZWJ1Z1NvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBiZSBnaXZlbiByZWZzLiBBdHRlbXB0cyB0byBhY2Nlc3MgdGhpcyByZWYgd2lsbCBmYWlsLiBEaWQgeW91IG1lYW4gdG8gdXNlIFJlYWN0LmZvcndhcmRSZWYoKT8lcyIsIGluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdW5jdGlvbiBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTMgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIiwgX2NvbXBvbmVudE5hbWUzKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBjb250ZXh0VHlwZS4iLCBfY29tcG9uZW50TmFtZTQpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgU1VTUEVOREVEX01BUktFUiA9IHsKICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICB0cmVlQ29udGV4dDogbnVsbCwKICAgICAgICAgIHJldHJ5TGFuZTogTm9MYW5lCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgY2FjaGVQb29sOiBnZXRTdXNwZW5kZWRDYWNoZSgpLAogICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IG1lcmdlTGFuZXMocHJldk9mZnNjcmVlblN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKSwKICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICB0cmFuc2l0aW9uczogcHJldk9mZnNjcmVlblN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiByZW1vdmVMYW5lcyhjdXJyZW50NC5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkU3VzcGVuZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChkaWRTdXNwZW5kIHx8IHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50NCkpIHsKICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5EaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBkZWh5ZHJhdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmYWxsYmFja0ZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZGVoeWRyYXRlZCA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChfZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX25leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdGF0ZSA9IGN1cnJlbnQ0LmNoaWxkLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLmNoaWxkTGFuZXMgPSBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4yID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gX3ByaW1hcnlDaGlsZEZyYWdtZW50MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50NCwgb2Zmc2NyZWVuUHJvcHMpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50NCwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IFtjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50XTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgIC8vIGNvbXBsZXRlZCwgZXZlbiB0aG91Z2ggaXQncyBpbiBhbiBpbmNvbnNpc3RlbnQgc3RhdGUuCiAgICAgICAgICAgIChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gTWFrZSBzdXJlIHdlJ3JlIG9uIHRoZSBzZWNvbmQgcGFzcywgaS5lLiB0aGUgcHJpbWFyeSBjaGlsZCBmcmFnbWVudCB3YXMKICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAvLyB3aGVuIERldlRvb2xzIGZvcmNlcyB1cyB0byBkaXNwbGF5IGEgZmFsbGJhY2s7IHdlIHNraXAgdGhlIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAvLyBwYXNzIGVudGlyZWx5IGFuZCBnbyBzdHJhaWdodCB0byByZW5kZXJpbmcgdGhlIGZhbGxiYWNrLiAoSW4gQ29uY3VycmVudAogICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgLy8gb25seSBjb2RlcGF0aC4pCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgcHJpbWFyeUNoaWxkUHJvcHMpOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIGZpYmVyTW9kZSk7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaHlkcmF0ZSBTdXNwZW5zZSBpbiBsZWdhY3kgbW9kZS4gU3dpdGNoIGZyb20gUmVhY3RET00uaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIpIHRvIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikucmVuZGVyKGVsZW1lbnQpIG9yIHJlbW92ZSB0aGUgU3VzcGVuc2UgY29tcG9uZW50cyBmcm9tIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgY29tcG9uZW50cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhTeW5jTGFuZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCFkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgIHdhcm5JZkh5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoCiAgICAgICAgICAgICAgICBjdXJyZW50NCwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoZW4gd2UgZGVsZXRlIGxlZ2FjeSBtb2RlLCB3ZSBzaG91bGQgbWFrZSB0aGlzIGVycm9yIGFyZ3VtZW50CiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAvLyBkZS1vcHQgdG8gY2xpZW50IHJlbmRlcmluZyBzaG91bGQgaGF2ZSBhbiBlcnJvciBtZXNzYWdlLgogICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIF9nZXRTdXNwZW5zZUluc3RhbmNlRiA9IGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICBzdGFjayA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5zdGFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICBpZiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIlRoZSBzZXJ2ZXIgY291bGQgbm90IGZpbmlzaCB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LCBsaWtlbHkgZHVlIHRvIGFuIGVycm9yIGR1cmluZyBzZXJ2ZXIgcmVuZGVyaW5nLiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUoZXJyb3IyLCBkaWdlc3QsIHN0YWNrKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBjYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dENoYW5nZWQyID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIGN1cnJlbnQ0LmNoaWxkTGFuZXMpOwogICAgICAgICAgICBpZiAoZGlkUmVjZWl2ZVVwZGF0ZSB8fCBoYXNDb250ZXh0Q2hhbmdlZDIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lID0gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lOwogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50NCwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudDQsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhpcyBTdXNwZW5zZSBib3VuZGFyeSByZWNlaXZlZCBhbiB1cGRhdGUgYmVmb3JlIGl0IGZpbmlzaGVkIGh5ZHJhdGluZy4gVGhpcyBjYXVzZWQgdGhlIGJvdW5kYXJ5IHRvIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiBUaGUgdXN1YWwgd2F5IHRvIGZpeCB0aGlzIGlzIHRvIHdyYXAgdGhlIG9yaWdpbmFsIHVwZGF0ZSBpbiBzdGFydFRyYW5zaXRpb24uIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeS5iaW5kKG51bGwsIGN1cnJlbnQ0KTsKICAgICAgICAgICAgICByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShzdXNwZW5zZUluc3RhbmNlLCByZXRyeSk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZS50cmVlQ29udGV4dCk7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZTIgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZyB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIoZmliZXIsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZExhc3RDb250ZW50Um93KGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciByb3cgPSBmaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdyA9IHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXN0Q29udGVudFJvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXZlYWxPcmRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBVc2UgbG93ZXJjYXNlICIlcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZCI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignJXMgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09ICJjb2xsYXBzZWQiICYmIHRhaWxNb2RlICE9PSAiaGlkZGVuIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRTbG90LCBpbmRleDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQW5BcnJheSA9IGlzQXJyYXkyKGNoaWxkU2xvdCk7CiAgICAgICAgICAgIHZhciBpc0l0ZXJhYmxlID0gIWlzQW5BcnJheSAmJiB0eXBlb2YgZ2V0SXRlcmF0b3JGbihjaGlsZFNsb3QpID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgICBpZiAoaXNBbkFycmF5IHx8IGlzSXRlcmFibGUpIHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IGlzQW5BcnJheSA/ICJhcnJheSIgOiAiaXRlcmFibGUiOwogICAgICAgICAgICAgIGVycm9yKCJBIG5lc3RlZCAlcyB3YXMgcGFzc2VkIHRvIHJvdyAjJXMgaW4gPFN1c3BlbnNlTGlzdCAvPi4gV3JhcCBpdCBpbiBhbiBhZGRpdGlvbmFsIFN1c3BlbnNlTGlzdCB0byBjb25maWd1cmUgaXRzIHJldmVhbE9yZGVyOiA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPS4uLj4gLi4uIDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPnslc308L1N1c3BlbnNlTGlzdD4gLi4uIDwvU3VzcGVuc2VMaXN0PiIsIHR5cGUsIGluZGV4MiwgdHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTdXNwZW5zZUxpc3RDaGlsZHJlbihjaGlsZHJlbiwgcmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChyZXZlYWxPcmRlciA9PT0gImZvcndhcmRzIiB8fCByZXZlYWxPcmRlciA9PT0gImJhY2t3YXJkcyIpICYmIGNoaWxkcmVuICE9PSB2b2lkIDAgJiYgY2hpbGRyZW4gIT09IG51bGwgJiYgY2hpbGRyZW4gIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRyZW5baV0sIGkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihjaGlsZHJlbik7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuSXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5JdGVyYXRvcikgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGVwID0gY2hpbGRyZW5JdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoc3RlcC52YWx1ZSwgX2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIF9pKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBlcnJvcignQSBzaW5nbGUgcm93IHdhcyBwYXNzZWQgdG8gYSA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPSIlcyIgLz4uIFRoaXMgaXMgbm90IHVzZWZ1bCBzaW5jZSBpdCBuZWVkcyBtdWx0aXBsZSByb3dzLiBEaWQgeW91IG1lYW4gdG8gcGFzcyBtdWx0aXBsZSBjaGlsZHJlbiBvciBhbiBhcnJheT8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGlzQmFja3dhcmRzLCB0YWlsLCBsYXN0Q29udGVudFJvdywgdGFpbE1vZGUpIHsKICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gewogICAgICAgICAgICAgIGlzQmFja3dhcmRzLAogICAgICAgICAgICAgIHJlbmRlcmluZzogbnVsbCwKICAgICAgICAgICAgICByZW5kZXJpbmdTdGFydFRpbWU6IDAsCiAgICAgICAgICAgICAgbGFzdDogbGFzdENvbnRlbnRSb3csCiAgICAgICAgICAgICAgdGFpbCwKICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMgPSBpc0JhY2t3YXJkczsKICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID0gMDsKICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdCA9IGxhc3RDb250ZW50Um93OwogICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gdGFpbDsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbE1vZGUgPSB0YWlsTW9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcmV2ZWFsT3JkZXIgPSBuZXh0UHJvcHMucmV2ZWFsT3JkZXI7CiAgICAgICAgICB2YXIgdGFpbE1vZGUgPSBuZXh0UHJvcHMudGFpbDsKICAgICAgICAgIHZhciBuZXdDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhbGlkYXRlUmV2ZWFsT3JkZXIocmV2ZWFsT3JkZXIpOwogICAgICAgICAgdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgdmFsaWRhdGVTdXNwZW5zZUxpc3RDaGlsZHJlbihuZXdDaGlsZHJlbiwgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgdmFyIHNob3VsZEZvcmNlRmFsbGJhY2sgPSBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgaWYgKHNob3VsZEZvcmNlRmFsbGJhY2spIHsKICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRCZWZvcmUgPSBjdXJyZW50NCAhPT0gbnVsbCAmJiAoY3VycmVudDQuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRCZWZvcmUpIHsKICAgICAgICAgICAgICBwcm9wYWdhdGVTdXNwZW5zZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIpIHsKICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkcyI6IHsKICAgICAgICAgICAgICAgIHZhciBsYXN0Q29udGVudFJvdyA9IGZpbmRMYXN0Q29udGVudFJvdyh3b3JrSW5Qcm9ncmVzczIuY2hpbGQpOwogICAgICAgICAgICAgICAgdmFyIHRhaWw7CiAgICAgICAgICAgICAgICBpZiAobGFzdENvbnRlbnRSb3cgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGFpbCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSBsYXN0Q29udGVudFJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgdGFpbCwKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3csCiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkcyI6IHsKICAgICAgICAgICAgICAgIHZhciBfdGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgcm93ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByb3c7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG5leHRSb3cgPSByb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgcm93LnNpYmxpbmcgPSBfdGFpbDsKICAgICAgICAgICAgICAgICAgX3RhaWwgPSByb3c7CiAgICAgICAgICAgICAgICAgIHJvdyA9IG5leHRSb3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgX3RhaWwsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAidG9nZXRoZXIiOiB7CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIHRhaWwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gbGFzdAogICAgICAgICAgICAgICAgICB2b2lkIDAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUG9ydGFsQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcHJvdmlkZXJUeXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHByb3ZpZGVyVHlwZS5fY29udGV4dDsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IG5ld1Byb3BzLnZhbHVlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoISgidmFsdWUiIGluIG5ld1Byb3BzKSkgewogICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgYHZhbHVlYCBwcm9wIGlzIHJlcXVpcmVkIGZvciB0aGUgYDxDb250ZXh0LlByb3ZpZGVyPmAuIERpZCB5b3UgbWlzc3BlbGwgaXQgb3IgZm9yZ2V0IHRvIHBhc3MgaXQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm92aWRlclByb3BUeXBlcyA9IHdvcmtJblByb2dyZXNzMi50eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgaWYgKHByb3ZpZGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvdmlkZXJQcm9wVHlwZXMsIG5ld1Byb3BzLCAicHJvcCIsICJDb250ZXh0LlByb3ZpZGVyIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHB1c2hQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIG5ld1ZhbHVlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG9sZFZhbHVlID0gb2xkUHJvcHMudmFsdWU7CiAgICAgICAgICAgICAgaWYgKG9iamVjdElzKG9sZFZhbHVlLCBuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRQcm9wcy5jaGlsZHJlbiA9PT0gbmV3UHJvcHMuY2hpbGRyZW4gJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJvcGFnYXRlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRleHRDb25zdW1lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb250ZXh0Ll9jb250ZXh0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAoY29udGV4dCAhPT0gY29udGV4dC5Db25zdW1lcikgewogICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dD4gZGlyZWN0bHkgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJlbmRlcjIgPSBuZXdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZW5kZXIyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29udGV4dCBjb25zdW1lciB3YXMgcmVuZGVyZWQgd2l0aCBtdWx0aXBsZSBjaGlsZHJlbiwgb3IgYSBjaGlsZCB0aGF0IGlzbid0IGEgZnVuY3Rpb24uIEEgY29udGV4dCBjb25zdW1lciBleHBlY3RzIGEgc2luZ2xlIGNoaWxkIHRoYXQgaXMgYSBmdW5jdGlvbi4gSWYgeW91IGRpZCBwYXNzIGEgZnVuY3Rpb24sIG1ha2Ugc3VyZSB0aGVyZSBpcyBubyB0cmFpbGluZyBvciBsZWFkaW5nIHdoaXRlc3BhY2UgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDaGlsZHJlbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgbmV3Q2hpbGRyZW4gPSByZW5kZXIyKG5ld1ZhbHVlKTsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCkgewogICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBjdXJyZW50NC5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcykpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3VudEZpYmVyKGN1cnJlbnQ0LCBvbGRXb3JrSW5Qcm9ncmVzcywgbmV3V29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBzd2FwIHRoZSByb290IGZpYmVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIG9sZFdvcmtJblByb2dyZXNzLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLmluZGV4ID0gb2xkV29ya0luUHJvZ3Jlc3MuaW5kZXg7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnNpYmxpbmcgPSBvbGRXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZXR1cm4gPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnJlZiA9IG9sZFdvcmtJblByb2dyZXNzLnJlZjsKICAgICAgICAgICAgaWYgKG9sZFdvcmtJblByb2dyZXNzID09PSByZXR1cm5GaWJlci5jaGlsZCkgewogICAgICAgICAgICAgIHJldHVybkZpYmVyLmNoaWxkID0gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTaWJsaW5nID0gcmV0dXJuRmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHBhcmVudCB0byBoYXZlIGEgY2hpbGQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChwcmV2U2libGluZy5zaWJsaW5nICE9PSBvbGRXb3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgcHJldlNpYmxpbmcgPSBwcmV2U2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCB0aGUgcHJldmlvdXMgc2libGluZy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldlNpYmxpbmcuc2libGluZyA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY3VycmVudDRdOwogICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY3VycmVudDQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgcmV0dXJuIG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgdXBkYXRlTGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHVwZGF0ZUxhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0RWFybHlCYWlsb3V0SWZOb1NjaGVkdWxlZFVwZGF0ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHB1c2hIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudmFsdWU7CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChoYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkTGFuZXMgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzOwogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBwcmltYXJ5Q2hpbGRMYW5lcykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgICAgdmFyIF9oYXNDaGlsZFdvcmsgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgICBpZiAoX2hhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJlZ2luV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgJiYgY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVtb3VudEZpYmVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgd29ya0luUHJvZ3Jlc3MyLmtleSwgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcywgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyIHx8IG51bGwsIHdvcmtJblByb2dyZXNzMi5tb2RlLCB3b3JrSW5Qcm9ncmVzczIubGFuZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgaGFzQ29udGV4dENoYW5nZWQoKSB8fCAvLyBGb3JjZSBhIHJlLXJlbmRlciBpZiB0aGUgaW1wbGVtZW50YXRpb24gY2hhbmdlZCBkdWUgdG8gaG90IHJlbG9hZDoKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IGN1cnJlbnQ0LnR5cGUpIHsKICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ID0gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgJiYgLy8gSWYgdGhpcyBpcyB0aGUgc2Vjb25kIHBhc3Mgb2YgYW4gZXJyb3Igb3Igc3VzcGVuc2UgYm91bmRhcnksIHRoZXJlCiAgICAgICAgICAgICAgLy8gbWF5IG5vdCBiZSB3b3JrIHNjaGVkdWxlZCBvbiBgY3VycmVudGAsIHNvIHdlIGNoZWNrIGZvciB0aGlzIGZsYWcuCiAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChjdXJyZW50NC5mbGFncyAmIEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2UpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBpc0ZvcmtlZENoaWxkKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICB2YXIgc2xvdEluZGV4ID0gd29ya0luUHJvZ3Jlc3MyLmluZGV4OwogICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gZ2V0Rm9ya3NBdExldmVsKCk7CiAgICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5kZXRlcm1pbmF0ZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIudHlwZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF6eUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBlbGVtZW50VHlwZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciB1bnJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciByZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBDb21wb25lbnQgPyB1bnJlc29sdmVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQsIHVucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50ID8gX3VucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKF9Db21wb25lbnQsIF91bnJlc29sdmVkUHJvcHMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50LCBfcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0Um9vdChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdFRleHQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMiA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMiA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gdHlwZSA/IF91bnJlc29sdmVkUHJvcHMyIDogcmVzb2x2ZURlZmF1bHRQcm9wczIodHlwZSwgX3VucmVzb2x2ZWRQcm9wczIpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIF9yZXNvbHZlZFByb3BzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZyYWdtZW50MTA6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQcm9maWxlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMiwgX3VucmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IF90eXBlMi5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlMikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudDIsIF91bnJlc29sdmVkUHJvcHM0KTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX0NvbXBvbmVudDIsIF9yZXNvbHZlZFByb3BzNCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB1bml0IG9mIHdvcmsgdGFnICgiICsgd29ya0luUHJvZ3Jlc3MyLnRhZyArICIpLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhcHBlbmRBbGxDaGlsZHJlbjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lcjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbXBvbmVudCQxOwogICAgICAgIHZhciB1cGRhdGVIb3N0VGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuID0gZnVuY3Rpb24ocGFyZW50LCB3b3JrSW5Qcm9ncmVzczIsIG5lZWRzVmlzaWJpbGl0eVRvZ2dsZSwgaXNIaWRkZW4pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBwcmVwYXJlVXBkYXRlKGluc3RhbmNlLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0KTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICBpZiAob2xkVGV4dCAhPT0gbmV3VGV4dCkgewogICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBoYXNSZW5kZXJlZEFUYWlsRmFsbGJhY2spIHsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAocmVuZGVyU3RhdGUudGFpbE1vZGUpIHsKICAgICAgICAgICAgY2FzZSAiaGlkZGVuIjogewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIGxhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKHRhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZSA9IHRhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFpbE5vZGUgPSB0YWlsTm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJjb2xsYXBzZWQiOiB7CiAgICAgICAgICAgICAgdmFyIF90YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIF9sYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChfdGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChfdGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIF9sYXN0VGFpbE5vZGUgPSBfdGFpbE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfdGFpbE5vZGUgPSBfdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9sYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrICYmIHJlbmRlclN0YXRlLnRhaWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBidWJibGVQcm9wZXJ0aWVzKGNvbXBsZXRlZFdvcmspIHsKICAgICAgICAgIHZhciBkaWRCYWlsb3V0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGUgIT09IG51bGwgJiYgY29tcGxldGVkV29yay5hbHRlcm5hdGUuY2hpbGQgPT09IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIGlmICghZGlkQmFpbG91dCkgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgdHJlZUJhc2VEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhjaGlsZC5sYW5lcywgY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IGNoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIGFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdHJlZUJhc2VEdXJhdGlvbiArPSBjaGlsZC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uID0gYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZC5sYW5lcywgX2NoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuc3VidHJlZUZsYWdzOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIF9jaGlsZC5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgX3RyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIF9jaGlsZDIgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZDIubGFuZXMsIF9jaGlsZDIuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIF90cmVlQmFzZUR1cmF0aW9uICs9IF9jaGlsZDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIF9jaGlsZDIgPSBfY2hpbGQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IF90cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY2hpbGQzID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQzLmxhbmVzLCBfY2hpbGQzLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQzLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfY2hpbGQzLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICBfY2hpbGQzID0gX2NoaWxkMy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wbGV0ZWRXb3JrLmNoaWxkTGFuZXMgPSBuZXdDaGlsZExhbmVzOwogICAgICAgICAgcmV0dXJuIGRpZEJhaWxvdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKSB7CiAgICAgICAgICBpZiAoaGFzVW5oeWRyYXRlZFRhaWxOb2RlcygpICYmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyIHwgSW5jb21wbGV0ZSB8IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsICYmIG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICghd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQSBkZWh5ZHJhdGVkIHN1c3BlbnNlIGNvbXBvbmVudCB3YXMgY29tcGxldGVkIHdpdGhvdXQgYSBoeWRyYXRlZCBub2RlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpc1RpbWVkT3V0U3VzcGVuc2UgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChpc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoX2lzVGltZWRPdXRTdXNwZW5zZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9wcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gX3ByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQxMDoKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciBmaWJlclJvb3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBpZiAoZmliZXJSb290LnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBmaWJlclJvb3QuY29udGV4dCA9IGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmICh3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY2xpZW50IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICFwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkIHx8IC8vIENoZWNrIGlmIHdlIHJldmVydGVkIHRvIGNsaWVudCByZW5kZXJpbmcgKGUuZy4gZHVlIHRvIGFuIGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSAhPT0gTm9GbGFncwogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NC5yZWYgIT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghbmV3UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZSh0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGluc3RhbmNlLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBuZXdQcm9wczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgJiYgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld1RleHQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBtdXN0IGhhdmUgbmV3IHByb3BzIGZvciBuZXcgbW91bnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkMiA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkMikgewogICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGNyZWF0ZVRleHRJbnN0YW5jZShuZXdUZXh0LCBfcm9vdENvbnRhaW5lckluc3RhbmNlLCBfY3VycmVudEhvc3RDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoID0gY29tcGxldGVEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKCFmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHREaWRUaW1lb3V0ID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2RGlkVGltZW91dCA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0ICE9PSBwcmV2RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuRmliZXIyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuRmliZXIyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNJbnZpc2libGVDaGlsZENvbnRleHQgPSBjdXJyZW50NCA9PT0gbnVsbCAmJiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudW5zdGFibGVfYXZvaWRUaGlzRmFsbGJhY2sgIT09IHRydWUgfHwgIWVuYWJsZVN1c3BlbnNlQXZvaWRUaGlzRmFsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNJbnZpc2libGVDaGlsZENvbnRleHQgfHwgaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcmVwYXJlUG9ydGFsTW91bnQod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKF9Db21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQWxyZWFkeSA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRUYWlsID0gcmVuZGVyU3RhdGUucmVuZGVyaW5nOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZFRhaWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbm5vdEJlU3VzcGVuZGVkID0gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgJiYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKTsKICAgICAgICAgICAgICAgICAgaWYgKCFjYW5ub3RCZVN1c3BlbmRlZCkgewogICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RoZW5hYmxlcyA9IHN1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG5ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgICAgICAgICByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCAmJiBub3coKSA+IGdldFJlbmRlclRhcmdldFRpbWUoKSkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgX3N1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyZW5kZXJlZFRhaWwpOwogICAgICAgICAgICAgICAgICBpZiAoX3N1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX25ld1RoZW5hYmxlcyA9IF9zdXNwZW5kZWQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXdUaGVuYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IF9uZXdUaGVuYWJsZXM7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsID09PSBudWxsICYmIHJlbmRlclN0YXRlLnRhaWxNb2RlID09PSAiaGlkZGVuIiAmJiAhcmVuZGVyZWRUYWlsLmFsdGVybmF0ZSAmJiAhZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSB0aW1lIGl0IHRvb2sgdG8gcmVuZGVyIGxhc3Qgcm93IGlzIGdyZWF0ZXIgdGhhbiB0aGUgcmVtYWluaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gdGltZSB3ZSBoYXZlIHRvIHJlbmRlci4gU28gcmVuZGVyaW5nIG9uZSBtb3JlIHJvdyB3b3VsZCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICAvLyBleGNlZWQgaXQuCiAgICAgICAgICAgICAgICAgICAgbm93KCkgKiAyIC0gcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpICYmIHJlbmRlckxhbmVzMiAhPT0gT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gU29tZVJldHJ5TGFuZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLmlzQmFja3dhcmRzKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlcmVkVGFpbC5zaWJsaW5nID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcmVuZGVyU3RhdGUubGFzdDsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzU2libGluZy5zaWJsaW5nID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbmV4dDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBuZXh0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSBub3coKTsKICAgICAgICAgICAgICAgIG5leHQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHZhciBuZXh0SXNIaWRkZW4gPSBfbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9wcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIHByZXZJc0hpZGRlbiA9IF9wcmV2U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocHJldklzSGlkZGVuICE9PSBuZXh0SXNIaWRkZW4gJiYgLy8gTGVnYWN5SGlkZGVuIGRvZXNuJ3QgZG8gYW55IGhpZGluZyDigJQgaXQgb25seSBwcmUtcmVuZGVycy4KICAgICAgICAgICAgICAgICFlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghbmV4dElzSGlkZGVuIHx8ICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHN1YnRyZWVSZW5kZXJMYW5lcywgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgJiAoUGxhY2VtZW50IHwgVXBkYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICB2YXIgX2ZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmICgoX2ZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgIT09IE5vRmxhZ3MgJiYgKF9mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaHJldyBpbiBuZXdseSBtb3VudGVkIGRlaHlkcmF0ZWQgY29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfZmxhZ3MyID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChfZmxhZ3MyICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gX2ZsYWdzMiAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKGludGVycnVwdGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IGludGVycnVwdGVkV29yay50eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICAgIGlmIChjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBpbnRlcnJ1cHRlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGludGVycnVwdGVkV29yay50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyhpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha1NldCA9IHR5cGVvZiBXZWFrU2V0ID09PSAiZnVuY3Rpb24iID8gV2Vha1NldCA6IFNldDsKICAgICAgICB2YXIgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIgPSBmdW5jdGlvbihjdXJyZW50NCwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQsIGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyKGN1cnJlbnQ0LCBpbnN0YW5jZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUF0dGFjaFJlZihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgcmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgJiYgY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldFZhbCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZXR1cm4gdmFsdWUgZnJvbSBhIGNhbGxiYWNrIHJlZiBpbiAlcy4gQSBjYWxsYmFjayByZWYgc2hvdWxkIG5vdCByZXR1cm4gYSBmdW5jdGlvbi4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQ0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsRGVzdHJveShjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZm9jdXNlZEluc3RhbmNlSGFuZGxlID0gbnVsbDsKICAgICAgICB2YXIgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaXJzdENoaWxkKSB7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBwcmVwYXJlRm9yQ29tbWl0KHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfYmVnaW4oKTsKICAgICAgICAgIHZhciBzaG91bGRGaXJlID0gc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyOwogICAgICAgICAgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHNob3VsZEZpcmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIEJlZm9yZU11dGF0aW9uTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKChmbGFncyAmIFNuYXBzaG90KSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc25hcHNob3QgPSBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZShmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgPT09IGZpbmlzaGVkV29yay50eXBlID8gcHJldlByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50NCwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCB1cGRhdGVRdWV1ZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAoX3VwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsuY2hpbGQudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGdldFB1YmxpY0luc3RhbmNlKGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIF91cGRhdGVRdWV1ZSwgX2luc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiBmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIGNvbW1pdE1vdW50KF9pbnN0YW5jZTIsIHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplMiA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBvbkNvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25Db21taXQsIG9uUmVuZGVyID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vblJlbmRlcjsKICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgdmFyIGNvbW1pdFRpbWUyID0gZ2V0Q29tbWl0VGltZSgpOwogICAgICAgICAgICAgICAgICB2YXIgcGhhc2UgPSBjdXJyZW50NCA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25SZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBvblJlbmRlcihmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGZpbmlzaGVkV29yay5hY3R1YWxEdXJhdGlvbiwgZmluaXNoZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24sIGZpbmlzaGVkV29yay5hY3R1YWxTdGFydFRpbWUsIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbkNvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgb25Db21taXQoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBlZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24obm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChub2RlLCBub2RlLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzYWZlbHlBdHRhY2hSZWYobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4oZmluaXNoZWRXb3JrLCBpc0hpZGRlbikgewogICAgICAgICAgdmFyIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaGlkZUluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdW5oaWRlSW5zdGFuY2Uobm9kZS5zdGF0ZU5vZGUsIG5vZGUubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlVGV4dEluc3RhbmNlKF9pbnN0YW5jZTMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMywgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKG5vZGUudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgfHwgbm9kZS50YWcgPT09IExlZ2FjeUhpZGRlbkNvbXBvbmVudCkgJiYgbm9kZS5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIG5vZGUgIT09IGZpbmlzaGVkV29yaykgOwogICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbm9kZSkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgcmVmID0gZmluaXNoZWRXb3JrLnJlZjsKICAgICAgICAgIGlmIChyZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlVG9Vc2U7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIGluc3RhbmNlVG9Vc2UgPSBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghcmVmLmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmVmIG9iamVjdCBwcm92aWRlZCBmb3IgJXMuIFVzZSBlaXRoZXIgYSByZWYtc2V0dGVyIGZ1bmN0aW9uIG9yIFJlYWN0LmNyZWF0ZVJlZigpLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaWJlck11dGF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUucmV0dXJuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZpYmVyLnJldHVybiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhhbHRlcm5hdGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXRhY2hEZWxldGVkSW5zdGFuY2UoaG9zdEluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFBhcmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgfHwgZmliZXIudGFnID09PSBIb3N0UG9ydGFsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0U2libGluZyhmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHNpYmxpbmdzOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IGlzSG9zdFBhcmVudChub2RlLnJldHVybikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAobm9kZS50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgbm9kZS50YWcgIT09IEhvc3RUZXh0ICYmIG5vZGUudGFnICE9PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5mbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICAgICAgY29udGludWUgc2libGluZ3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkID09PSBudWxsIHx8IG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKG5vZGUuZmxhZ3MgJiBQbGFjZW1lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGdldEhvc3RQYXJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50RmliZXIuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQocGFyZW50KTsKICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyLmZsYWdzICY9IH5Db250ZW50UmVzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBiZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShmaW5pc2hlZFdvcmssIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB2YXIgX3BhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHZhciBfYmVmb3JlID0gZ2V0SG9zdFNpYmxpbmcoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGZpbmlzaGVkV29yaywgX2JlZm9yZSwgX3BhcmVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9zdCBwYXJlbnQgZmliZXIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnQsIHN0YXRlTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudCwgc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFwcGVuZENoaWxkKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUoY2hpbGQsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgd2hpbGUgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgdmFyIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGZpbmRQYXJlbnQ6IHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudC50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdFBhcmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIocm9vdDMsIHJldHVybkZpYmVyLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkZXRhY2hGaWJlck11dGF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgY2hpbGQpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpIHsKICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChkZWxldGVkRmliZXIpOwogICAgICAgICAgc3dpdGNoIChkZWxldGVkRmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIHByZXZIb3N0UGFyZW50SXNDb250YWluZXIgPSBob3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50SXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2hpbGQoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZIb3N0UGFyZW50ID0gaG9zdFBhcmVudDsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gX3ByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gX3ByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZGVsZXRlZEZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfZWZmZWN0ID0gZWZmZWN0LCBkZXN0cm95ID0gX2VmZmVjdC5kZXN0cm95LCB0YWcgPSBfZWZmZWN0LnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCh0YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRGaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGRlbGV0ZWRGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgZGVsZXRlZEZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV3U3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9IG5ldyBQb3NzaWJseVdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZXMuZm9yRWFjaChmdW5jdGlvbih3YWtlYWJsZSkgewogICAgICAgICAgICAgIHZhciByZXRyeSA9IHJlc29sdmVSZXRyeVdha2VhYmxlLmJpbmQobnVsbCwgZmluaXNoZWRXb3JrLCB3YWtlYWJsZSk7CiAgICAgICAgICAgICAgaWYgKCFyZXRyeUNhY2hlLmhhcyh3YWtlYWJsZSkpIHsKICAgICAgICAgICAgICAgIHJldHJ5Q2FjaGUuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluUHJvZ3Jlc3NMYW5lcyAhPT0gbnVsbCAmJiBpblByb2dyZXNzUm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhpblByb2dyZXNzUm9vdCwgaW5Qcm9ncmVzc0xhbmVzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIGZpbmlzaGVkIHJvb3QgYW5kIGxhbmVzIHRvIGJlIHNldC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdha2VhYmxlLnRoZW4ocmV0cnksIHJldHJ5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzKTsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcGFyZW50RmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGV0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGNoaWxkVG9EZWxldGUsIHBhcmVudEZpYmVyLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZEZWJ1Z0ZpYmVyID0gZ2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICBpZiAocGFyZW50RmliZXIuc3VidHJlZUZsYWdzICYgTXV0YXRpb25NYXNrKSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEZpYmVyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoY2hpbGQpOwogICAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoY2hpbGQsIHJvb3QzKTsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2RGVidWdGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChfaW5zdGFuY2U0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiBuZXdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZShfaW5zdGFuY2U0LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHNob3VsZCBoYXZlIGEgdGV4dCBub2RlIGluaXRpYWxpemVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1RleHQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlJvb3RTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZSb290U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZENvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuRmliZXIgPSBmaW5pc2hlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlbkZpYmVyLmZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkluc3RhbmNlID0gb2Zmc2NyZWVuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gb2Zmc2NyZWVuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IG5ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBpc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlICE9PSBudWxsICYmIG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZS5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoIXdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF93YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBfd2FzSGlkZGVuOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5JbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgX25ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX2lzSGlkZGVuID0gX25ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkJvdW5kYXJ5ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgICAgX29mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gX2lzSGlkZGVuOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoX2lzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFfd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9mZnNjcmVlbkJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQm91bmRhcnk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkJvdW5kYXJ5LmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAob2Zmc2NyZWVuQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQ2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihvZmZzY3JlZW5DaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5DaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGhpZGVPclVuaGlkZUFsbENoaWxkcmVuKG9mZnNjcmVlbkJvdW5kYXJ5LCBfaXNIaWRkZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKGZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gflBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmbGFncyAmIEh5ZHJhdGluZykgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gfkh5ZHJhdGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gKHN1YnRyZWVSb290Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCAmJiBpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBpc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgaWYgKG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbikgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSB3YXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gJiYgIXByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKAogICAgICAgICAgICAgICAgICAgIGNoaWxkLAogICAgICAgICAgICAgICAgICAgIC8vIE5ldyByb290OyBidWJibGUgYmFjayB1cCB0byBoZXJlIGFuZCBzdG9wLgogICAgICAgICAgICAgICAgICAgIHJvb3QzLAogICAgICAgICAgICAgICAgICAgIGNvbW1pdHRlZExhbmVzCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgZmliZXIsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhmaXJzdENoaWxkKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfYmVnaW4oKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKChuZXh0RWZmZWN0LmZsYWdzICYgQ2hpbGREZWxldGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gZmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaWJlclRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXJUb0RlbGV0ZTsKICAgICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihmaWJlclRvRGVsZXRlLCBmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZENoaWxkID0gcHJldmlvdXNGaWJlci5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGV0YWNoZWRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNGaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZFNpYmxpbmcgPSBkZXRhY2hlZENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQgPSBkZXRhY2hlZFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChkZXRhY2hlZENoaWxkICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfYmVnaW4oZGVsZXRlZFN1YnRyZWVSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihmaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgPT09IGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHJldHVybkZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgc3dpdGNoIChjdXJyZW50NC50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDT01QT05FTlRfVFlQRSA9IDA7CiAgICAgICAgdmFyIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IDE7CiAgICAgICAgdmFyIFJPTEVfVFlQRSA9IDI7CiAgICAgICAgdmFyIFRFU1RfTkFNRV9UWVBFID0gMzsKICAgICAgICB2YXIgVEVYVF9UWVBFID0gNDsKICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wuZm9yKSB7CiAgICAgICAgICB2YXIgc3ltYm9sRm9yID0gU3ltYm9sLmZvcjsKICAgICAgICAgIENPTVBPTkVOVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5jb21wb25lbnQiKTsKICAgICAgICAgIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IuaGFzX3BzZXVkb19jbGFzcyIpOwogICAgICAgICAgUk9MRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5yb2xlIik7CiAgICAgICAgICBURVNUX05BTUVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IudGVzdF9pZCIpOwogICAgICAgICAgVEVYVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXh0Iik7CiAgICAgICAgfQogICAgICAgIHZhciBjb21taXRIb29rcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdCQxKCkgewogICAgICAgICAgewogICAgICAgICAgICBjb21taXRIb29rcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbW1pdEhvb2spIHsKICAgICAgICAgICAgICByZXR1cm4gY29tbWl0SG9vaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgZnVuY3Rpb24gaXNMZWdhY3lBY3RFbnZpcm9ubWVudChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHZhciBqZXN0SXNEZWZpbmVkID0gdHlwZW9mIGplc3QgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICByZXR1cm4gamVzdElzRGVmaW5lZCAmJiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgIT09IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAvLyAkRmxvd0V4cGVjdGVkRXJyb3Ig4oCTIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCBnbG9iYWwKICAgICAgICAgICAgICB0eXBlb2YgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UICE9PSAidW5kZWZpbmVkIiA/IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCA6IHZvaWQgMAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBjdXJyZW50IHRlc3RpbmcgZW52aXJvbm1lbnQgaXMgbm90IGNvbmZpZ3VyZWQgdG8gc3VwcG9ydCBhY3QoLi4uKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjZWlsID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDQubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yczMpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IGVycm9yczM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycy5wdXNoLmFwcGx5KHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCBlcnJvcnMzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYSkgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oYSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzY3JldGVVcGRhdGVzKGZuLCBhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiLCBjLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yKHJvb3QzLCB0aHJvd25WYWx1ZSkgewogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoZXJyb3JlZFdvcmsgPT09IG51bGwgfHwgZXJyb3JlZFdvcmsucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEZhdGFsRXJyb3JlZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZXJyb3JlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGVycm9yZWRXb3JrLCB0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICAgIGlmICh0aHJvd25WYWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdGhyb3duVmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB0aHJvd25WYWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGVycm9yZWRXb3JrLCB3YWtlYWJsZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudEVycm9yZWQoZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93RXhjZXB0aW9uKHJvb3QzLCBlcnJvcmVkV29yay5yZXR1cm4sIGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGNvbXBsZXRlVW5pdE9mV29yayhlcnJvcmVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKHlldEFub3RoZXJUaHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIHRocm93blZhbHVlID0geWV0QW5vdGhlclRocm93blZhbHVlOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyA9PT0gZXJyb3JlZFdvcmsgJiYgZXJyb3JlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gZXJyb3JlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBlcnJvcmVkV29yazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQ7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChwcmV2RGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BEaXNwYXRjaGVyKHByZXZEaXNwYXRjaGVyKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKSB7CiAgICAgICAgICBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gbm93KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobGFuZSkgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gbWVyZ2VMYW5lcyhsYW5lLCB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSBudWxsICYmIChpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcykgfHwgaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcykpKSB7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEod29ya0luUHJvZ3Jlc3NSb290LCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgIT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RFcnJvcmVkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckhhc05vdFN1c3BlbmRlZFlldCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BTeW5jKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCBhbiBpbmNvbXBsZXRlIHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wU3luYygpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BDb25jdXJyZW50KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50NCwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwodGltZUVsYXBzZWQgLyAxOTYwKSAqIDE5NjA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yTmVzdGVkVXBkYXRlcygpIHsKICAgICAgICAgIGlmIChuZXN0ZWRVcGRhdGVDb3VudCA+IE5FU1RFRF9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yIGNvbXBvbmVudERpZFVwZGF0ZS4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgbmVzdGVkIHVwZGF0ZXMgdG8gcHJldmVudCBpbmZpbml0ZSBsb29wcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA+IE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgICAgZXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgdXNlRWZmZWN0LCBidXQgdXNlRWZmZWN0IGVpdGhlciBkb2Vzbid0IGhhdmUgYSBkZXBlbmRlbmN5IGFycmF5LCBvciBvbmUgb2YgdGhlIGRlcGVuZGVuY2llcyBjaGFuZ2VzIG9uIGV2ZXJ5IHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKGZpYmVyLCBoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlRWZmZWN0c0luRGV2KGZpcnN0Q2hpbGQsIGZpYmVyRmxhZ3MsIGludm9rZUVmZmVjdEZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBzdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmltYXJ5U3VidHJlZUZsYWcgPSBjdXJyZW50NC5zdWJ0cmVlRmxhZ3MgJiBmaWJlckZsYWdzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gc3VidHJlZVJvb3QgJiYgY3VycmVudDQuY2hpbGQgIT09IG51bGwgJiYgcHJpbWFyeVN1YnRyZWVGbGFnICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgZmliZXJGbGFncykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlRWZmZWN0Rm4oY3VycmVudDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBzdWJ0cmVlUm9vdCA9IGN1cnJlbnQ0LnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWc7CiAgICAgICAgICAgIGlmICh0YWcgIT09IEluZGV0ZXJtaW5hdGVDb21wb25lbnQgJiYgdGFnICE9PSBIb3N0Um9vdCAmJiB0YWcgIT09IENsYXNzQ29tcG9uZW50ICYmIHRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgdGFnICE9PSBGb3J3YXJkUmVmMiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtjb21wb25lbnROYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGVycm9yKCJDYW4ndCBwZXJmb3JtIGEgUmVhY3Qgc3RhdGUgdXBkYXRlIG9uIGEgY29tcG9uZW50IHRoYXQgaGFzbid0IG1vdW50ZWQgeWV0LiBUaGlzIGluZGljYXRlcyB0aGF0IHlvdSBoYXZlIGEgc2lkZS1lZmZlY3QgaW4geW91ciByZW5kZXIgZnVuY3Rpb24gdGhhdCBhc3luY2hyb25vdXNseSBsYXRlciBjYWxscyB0cmllcyB0byB1cGRhdGUgdGhlIGNvbXBvbmVudC4gTW92ZSB0aGlzIHdvcmsgdG8gdXNlRWZmZWN0IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiZWdpbldvcmskMTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZHVtbXlGaWJlciA9IG51bGw7CiAgICAgICAgICBiZWdpbldvcmskMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkgPSBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVihkdW1teUZpYmVyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKG9yaWdpbmFsRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHx8IG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih1bml0T2ZXb3JrLCBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSk7CiAgICAgICAgICAgICAgaWYgKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBiZWdpbldvcmssIG51bGwsIGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgIHZhciByZXBsYXlFcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwbGF5RXJyb3IgPT09ICJvYmplY3QiICYmIHJlcGxheUVycm9yICE9PSBudWxsICYmIHJlcGxheUVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgIW9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiAhZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUgPSB3b3JrSW5Qcm9ncmVzcyAmJiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgIHZhciBkZWR1cGVLZXkgPSByZW5kZXJpbmdDb21wb25lbnROYW1lOwogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5oYXMoZGVkdXBlS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5hZGQoZGVkdXBlS2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0U3RhdGVDb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGEgY29tcG9uZW50IChgJXNgKSB3aGlsZSByZW5kZXJpbmcgYSBkaWZmZXJlbnQgY29tcG9uZW50IChgJXNgKS4gVG8gbG9jYXRlIHRoZSBiYWQgc2V0U3RhdGUoKSBjYWxsIGluc2lkZSBgJXNgLCBmb2xsb3cgdGhlIHN0YWNrIHRyYWNlIGFzIGRlc2NyaWJlZCBpbiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc2V0c3RhdGUtaW4tcmVuZGVyIiwgc2V0U3RhdGVDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlcikgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGR1cmluZyBhbiBleGlzdGluZyBzdGF0ZSB0cmFuc2l0aW9uIChzdWNoIGFzIHdpdGhpbiBgcmVuZGVyYCkuIFJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihzY2hlZHVsaW5nRmliZXIpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290Mywgc2NoZWR1bGluZ0ZpYmVyLCBsYW5lcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZha2VBY3RDYWxsYmFja05vZGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrJDEocHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50OwogICAgICAgICAgICBpZiAoYWN0UXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhY3RRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICByZXR1cm4gZmFrZUFjdENhbGxiYWNrTm9kZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbGJhY2skMShjYWxsYmFja05vZGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFja05vZGUgPT09IGZha2VBY3RDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhbmNlbENhbGxiYWNrKGNhbGxiYWNrTm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaXNMZWdhY3lBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgZmliZXIudGFnICE9PSBGb3J3YXJkUmVmMiAmJiBmaWJlci50YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIHRvICVzIGluc2lkZSBhIHRlc3Qgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCBjYXVzZXMgUmVhY3Qgc3RhdGUgdXBkYXRlcyBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaXJlIGV2ZW50cyB0aGF0IHVwZGF0ZSBzdGF0ZSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0IiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyAhPT0gTGVnYWN5Um9vdCAmJiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJBIHN1c3BlbmRlZCByZXNvdXJjZSBmaW5pc2hlZCBsb2FkaW5nIGluc2lkZSBhIHRlc3QsIGJ1dCB0aGUgZXZlbnQgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCByZXNvbHZlcyBzdXNwZW5kZWQgZGF0YSBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaW5pc2ggbG9hZGluZyBzdXNwZW5kZWQgZGF0YSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGlzUnVubmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBpc1J1bm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXNvbHZlRmFtaWx5ID0gbnVsbDsKICAgICAgICB2YXIgZmFpbGVkQm91bmRhcmllcyA9IG51bGw7CiAgICAgICAgdmFyIHNldFJlZnJlc2hIYW5kbGVyID0gZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgICAgewogICAgICAgICAgICByZXNvbHZlRmFtaWx5ID0gaGFuZGxlcjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkodHlwZSk7CiAgICAgICAgICAgIGlmIChmYW1pbHkgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGUgIT09IG51bGwgJiYgdHlwZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB0eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZW5kZXIgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUucmVuZGVyICE9PSBjdXJyZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzeW50aGV0aWNUeXBlID0gewogICAgICAgICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgICAgICAgICByZW5kZXI6IGN1cnJlbnRSZW5kZXIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUuZGlzcGxheU5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN5bnRoZXRpY1R5cGUuZGlzcGxheU5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50aGV0aWNUeXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhmaWJlciwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldlR5cGUgPSBmaWJlci5lbGVtZW50VHlwZTsKICAgICAgICAgICAgdmFyIG5leHRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICB2YXIgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSBmYWxzZTsKICAgICAgICAgICAgdmFyICQkdHlwZW9mTmV4dFR5cGUgPSB0eXBlb2YgbmV4dFR5cGUgPT09ICJvYmplY3QiICYmIG5leHRUeXBlICE9PSBudWxsID8gbmV4dFR5cGUuJCR0eXBlb2YgOiBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzQ29tcGFyZUZhbWlsaWVzKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZGYW1pbHkgPSByZXNvbHZlRmFtaWx5KHByZXZUeXBlKTsKICAgICAgICAgICAgICBpZiAocHJldkZhbWlseSAhPT0gdm9pZCAwICYmIHByZXZGYW1pbHkgPT09IHJlc29sdmVGYW1pbHkobmV4dFR5cGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIFdlYWtTZXQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcy5hZGQoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIHVwZGF0ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhbGVGYW1pbGllcyA9IHVwZGF0ZS5zdGFsZUZhbWlsaWVzLCB1cGRhdGVkRmFtaWxpZXMgPSB1cGRhdGUudXBkYXRlZEZhbWlsaWVzOwogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUm9vdCA9IGZ1bmN0aW9uKHJvb3QzLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyb290My5jb250ZXh0ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGZpYmVyLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZSwgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlc29sdmVGYW1pbHkgdG8gYmUgc2V0IGR1cmluZyBob3QgcmVsb2FkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZWVkc1JlbmRlciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkoY2FuZGlkYXRlVHlwZSk7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1cGRhdGVkRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdOZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQgfHwgbmVlZHNSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3QgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihfcm9vdCwgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiAhbmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShjaGlsZCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoc2libGluZywgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIHJldHVybiBob3N0SW5zdGFuY2VzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGZpYmVyLCB0eXBlcywgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpZE1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVzLmhhcyhjYW5kaWRhdGVUeXBlKSkgewogICAgICAgICAgICAgICAgZGlkTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkTWF0Y2gpIHsKICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShjaGlsZCwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShzaWJsaW5nLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgaWYgKGZvdW5kSG9zdEluc3RhbmNlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gcmVhY2ggcm9vdCBmaXJzdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBmb3VuZEhvc3RJbnN0YW5jZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmRIb3N0SW5zdGFuY2VzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNCYWRNYXBQb2x5ZmlsbDsKICAgICAgICB7CiAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5vbkV4dGVuc2libGVPYmplY3QgPSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMoe30pOwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW25vbkV4dGVuc2libGVPYmplY3QsIG51bGxdXSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtub25FeHRlbnNpYmxlT2JqZWN0XSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLmVsZW1lbnRUeXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMudHlwZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnJldHVybiA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2libGluZyA9IG51bGw7CiAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgIHRoaXMucmVmID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgICAgdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgIHRoaXMudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgdGhpcy5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgIHRoaXMubW9kZSA9IG1vZGU7CiAgICAgICAgICB0aGlzLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIHRoaXMubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnU291cmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdPd25lciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnTmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnSG9va1R5cGVzID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNCYWRNYXBQb2x5ZmlsbCAmJiB0eXBlb2YgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVGaWJlciA9IGZ1bmN0aW9uKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiAmJiAhc2hvdWxkQ29uc3RydWN0JDEodHlwZSkgJiYgdHlwZS5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KSB7CiAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSA/IENsYXNzQ29tcG9uZW50IDogRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKENvbXBvbmVudCAhPT0gdm9pZCAwICYmIENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgJCR0eXBlb2YgPSBDb21wb25lbnQuJCR0eXBlb2Y7CiAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50NCwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gY3VycmVudDQuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSBjcmVhdGVGaWJlcihjdXJyZW50NC50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudDQua2V5LCBjdXJyZW50NC5tb2RlKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID0gY3VycmVudDQuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGN1cnJlbnQ0LnN0YXRlTm9kZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2UgPSBjdXJyZW50NC5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyID0gY3VycmVudDQuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGN1cnJlbnQ0Ll9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gY3VycmVudDQ7CiAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGN1cnJlbnQ0LmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zaWJsaW5nID0gY3VycmVudDQuc2libGluZzsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5pbmRleCA9IGN1cnJlbnQ0LmluZGV4OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnJlZiA9IGN1cnJlbnQ0LnJlZjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgPSBjdXJyZW50NC5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IFN0YXRpY01hc2sgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUpIHsKICAgICAgICAgIHZhciBtb2RlOwogICAgICAgICAgaWYgKHRhZyA9PT0gQ29uY3VycmVudFJvb3QpIHsKICAgICAgICAgICAgbW9kZSA9IENvbmN1cnJlbnRNb2RlOwogICAgICAgICAgICBpZiAoaXNTdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtb2RlID0gTm9Nb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIG1vZGUgfD0gUHJvZmlsZU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXIoSG9zdFJvb3QsIG51bGwsIG51bGwsIG1vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyVGFnID0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSkgewogICAgICAgICAgICAgIGZpYmVyVGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZmliZXJUYWcgPSBIb3N0Q29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0VGFnOiBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQocGVuZGluZ1Byb3BzLmNoaWxkcmVuLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1vZGU7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9PRkZTQ1JFRU5fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xFR0FDWV9ISURERU5fVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NDT1BFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUNIRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFOgogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRQcm92aWRlcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dENvbnN1bWVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IEZvcndhcmRSZWYyOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTGF6eUNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSAiICsgKCJidXQgZ290OiAiICsgKHR5cGUgPT0gbnVsbCA/IHR5cGUgOiB0eXBlb2YgdHlwZSkgKyAiLiIgKyBpbmZvKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihmaWJlclRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSB0eXBlOwogICAgICAgICAgZmliZXIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBvd25lciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBlbGVtZW50LnByb3BzOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihGcmFnbWVudDEwLCBlbGVtZW50cywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHBlbmRpbmdQcm9wcy5pZCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBlcnJvcignUHJvZmlsZXIgbXVzdCBzcGVjaWZ5IGFuICJpZCIgb2YgdHlwZSBgc3RyaW5nYCBhcyBhIHByb3AuIFJlY2VpdmVkIHRoZSB0eXBlIGAlc2AgaW5zdGVhZC4nLCB0eXBlb2YgcGVuZGluZ1Byb3BzLmlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoUHJvZmlsZXIsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlIHwgUHJvZmlsZU1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICAgIGVmZmVjdER1cmF0aW9uOiAwLAogICAgICAgICAgICAgIHBhc3NpdmVFZmZlY3REdXJhdGlvbjogMAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZShwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFN1c3BlbnNlQ29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUxpc3RDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoT2Zmc2NyZWVuQ29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX09GRlNDUkVFTl9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRJbnN0YW5jZSA9IHsKICAgICAgICAgICAgaXNIaWRkZW46IGZhbHNlCiAgICAgICAgICB9OwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gcHJpbWFyeUNoaWxkSW5zdGFuY2U7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVRleHQoY29udGVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RUZXh0LCBjb250ZW50LCBudWxsLCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdENvbXBvbmVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gIkRFTEVURUQiOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoZGVoeWRyYXRlZE5vZGUpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKERlaHlkcmF0ZWRGcmFnbWVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGRlaHlkcmF0ZWROb2RlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IHBvcnRhbC5jaGlsZHJlbiAhPT0gbnVsbCA/IHBvcnRhbC5jaGlsZHJlbiA6IFtdOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdFBvcnRhbCwgcGVuZGluZ1Byb3BzLCBwb3J0YWwua2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB7CiAgICAgICAgICAgIGNvbnRhaW5lckluZm86IHBvcnRhbC5jb250YWluZXJJbmZvLAogICAgICAgICAgICBwZW5kaW5nQ2hpbGRyZW46IG51bGwsCiAgICAgICAgICAgIC8vIFVzZWQgYnkgcGVyc2lzdGVudCB1cGRhdGVzCiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBwb3J0YWwuaW1wbGVtZW50YXRpb24KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHRhcmdldCwgc291cmNlKSB7CiAgICAgICAgICBpZiAodGFyZ2V0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRhcmdldCA9IGNyZWF0ZUZpYmVyKEluZGV0ZXJtaW5hdGVDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQudGFnID0gc291cmNlLnRhZzsKICAgICAgICAgIHRhcmdldC5rZXkgPSBzb3VyY2Uua2V5OwogICAgICAgICAgdGFyZ2V0LmVsZW1lbnRUeXBlID0gc291cmNlLmVsZW1lbnRUeXBlOwogICAgICAgICAgdGFyZ2V0LnR5cGUgPSBzb3VyY2UudHlwZTsKICAgICAgICAgIHRhcmdldC5zdGF0ZU5vZGUgPSBzb3VyY2Uuc3RhdGVOb2RlOwogICAgICAgICAgdGFyZ2V0LnJldHVybiA9IHNvdXJjZS5yZXR1cm47CiAgICAgICAgICB0YXJnZXQuY2hpbGQgPSBzb3VyY2UuY2hpbGQ7CiAgICAgICAgICB0YXJnZXQuc2libGluZyA9IHNvdXJjZS5zaWJsaW5nOwogICAgICAgICAgdGFyZ2V0LmluZGV4ID0gc291cmNlLmluZGV4OwogICAgICAgICAgdGFyZ2V0LnJlZiA9IHNvdXJjZS5yZWY7CiAgICAgICAgICB0YXJnZXQucGVuZGluZ1Byb3BzID0gc291cmNlLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHRhcmdldC5tZW1vaXplZFByb3BzID0gc291cmNlLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB0YXJnZXQudXBkYXRlUXVldWUgPSBzb3VyY2UudXBkYXRlUXVldWU7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRTdGF0ZSA9IHNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdGFyZ2V0LmRlcGVuZGVuY2llcyA9IHNvdXJjZS5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB0YXJnZXQubW9kZSA9IHNvdXJjZS5tb2RlOwogICAgICAgICAgdGFyZ2V0LmZsYWdzID0gc291cmNlLmZsYWdzOwogICAgICAgICAgdGFyZ2V0LnN1YnRyZWVGbGFncyA9IHNvdXJjZS5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB0YXJnZXQuZGVsZXRpb25zID0gc291cmNlLmRlbGV0aW9uczsKICAgICAgICAgIHRhcmdldC5sYW5lcyA9IHNvdXJjZS5sYW5lczsKICAgICAgICAgIHRhcmdldC5jaGlsZExhbmVzID0gc291cmNlLmNoaWxkTGFuZXM7CiAgICAgICAgICB0YXJnZXQuYWx0ZXJuYXRlID0gc291cmNlLmFsdGVybmF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbER1cmF0aW9uID0gc291cmNlLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICB0YXJnZXQuYWN0dWFsU3RhcnRUaW1lID0gc291cmNlLmFjdHVhbFN0YXJ0VGltZTsKICAgICAgICAgICAgdGFyZ2V0LnNlbGZCYXNlRHVyYXRpb24gPSBzb3VyY2Uuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LnRyZWVCYXNlRHVyYXRpb24gPSBzb3VyY2UudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC5fZGVidWdTb3VyY2UgPSBzb3VyY2UuX2RlYnVnU291cmNlOwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z093bmVyID0gc291cmNlLl9kZWJ1Z093bmVyOwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z05lZWRzUmVtb3VudCA9IHNvdXJjZS5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnSG9va1R5cGVzID0gc291cmNlLl9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIEZpYmVyUm9vdE5vZGUoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgICAgIHRoaXMuY29udGFpbmVySW5mbyA9IGNvbnRhaW5lckluZm87CiAgICAgICAgICB0aGlzLnBlbmRpbmdDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgdGhpcy5waW5nQ2FjaGUgPSBudWxsOwogICAgICAgICAgdGhpcy5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgdGhpcy50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ0NvbnRleHQgPSBudWxsOwogICAgICAgICAgdGhpcy5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgdGhpcy5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgdGhpcy5ldmVudFRpbWVzID0gY3JlYXRlTGFuZU1hcChOb0xhbmVzKTsKICAgICAgICAgIHRoaXMuZXhwaXJhdGlvblRpbWVzID0gY3JlYXRlTGFuZU1hcChOb1RpbWVzdGFtcCk7CiAgICAgICAgICB0aGlzLnBlbmRpbmdMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5leHBpcmVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5tdXRhYmxlUmVhZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZmluaXNoZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZW50YW5nbGVtZW50cyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmlkZW50aWZpZXJQcmVmaXggPSBpZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdGhpcy5vblJlY292ZXJhYmxlRXJyb3IgPSBvblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubWVtb2l6ZWRVcGRhdGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gdGhpcy5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBUb3RhbExhbmVzOyBfaSsrKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcC5wdXNoKC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDb25jdXJyZW50Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlUm9vdCgpIiA6ICJjcmVhdGVSb290KCkiOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lSb290OgogICAgICAgICAgICAgICAgdGhpcy5fZGVidWdSb290VHlwZSA9IGh5ZHJhdGUyID8gImh5ZHJhdGUoKSIgOiAicmVuZGVyKCkiOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIHJvb3QzID0gbmV3IEZpYmVyUm9vdE5vZGUoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHZhciB1bmluaXRpYWxpemVkRmliZXIgPSBjcmVhdGVIb3N0Um9vdEZpYmVyKHRhZywgaXNTdHJpY3RNb2RlKTsKICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSB1bmluaXRpYWxpemVkRmliZXI7CiAgICAgICAgICB1bmluaXRpYWxpemVkRmliZXIuc3RhdGVOb2RlID0gcm9vdDM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfaW5pdGlhbFN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IGluaXRpYWxDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGh5ZHJhdGUyLAogICAgICAgICAgICAgIGNhY2hlOiBudWxsLAogICAgICAgICAgICAgIC8vIG5vdCBlbmFibGVkIHlldAogICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsLAogICAgICAgICAgICAgIHBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXM6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLm1lbW9pemVkU3RhdGUgPSBfaW5pdGlhbFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHVuaW5pdGlhbGl6ZWRGaWJlcik7CiAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFZlcnNpb24gPSAiMTguMy4xIjsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwzKGNoaWxkcmVuLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICAgIGtleToga2V5ID09IG51bGwgPyBudWxsIDogIiIgKyBrZXksCiAgICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXJJbmZvLAogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgaWYgKCFwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldDUocGFyZW50Q29tcG9uZW50KTsKICAgICAgICAgIHZhciBwYXJlbnRDb250ZXh0ID0gZmluZEN1cnJlbnRVbm1hc2tlZENvbnRleHQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIENvbXBvbmVudCwgcGFyZW50Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlV2l0aFdhcm5pbmcoY29tcG9uZW50LCBtZXRob2ROYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoY29tcG9uZW50KTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbXBvbmVudC5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGNvbXBvbmVudCkuam9pbigiLCIpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudCBhcHBlYXJzIHRvIG5vdCBiZSBhIFJlYWN0Q29tcG9uZW50LiBLZXlzOiAiICsga2V5cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdEZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQzOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggaXMgaW5zaWRlIFN0cmljdE1vZGUuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggcmVuZGVycyBTdHJpY3RNb2RlIGNoaWxkcmVuLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldmlvdXNGaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaW5pdGlhbENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgY2FsbGJhY2ssIGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgcm9vdDMuY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKG51bGwpOwogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQ0KTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwgPyBjYWxsYmFjayA6IG51bGw7CiAgICAgICAgICBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQ0LCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIyLCBlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIyLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wZW5kaW5nQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiBjdXJyZW50MyAhPT0gbnVsbCAmJiAhZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcykgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJSZW5kZXIgbWV0aG9kcyBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZTsgdHJpZ2dlcmluZyBuZXN0ZWQgY29tcG9uZW50IHVwZGF0ZXMgZnJvbSByZW5kZXIgaXMgbm90IGFsbG93ZWQuIElmIG5lY2Vzc2FyeSwgdHJpZ2dlciBuZXN0ZWQgdXBkYXRlcyBpbiBjb21wb25lbnREaWRVcGRhdGUuXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mICVzLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDMpIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gewogICAgICAgICAgICBlbGVtZW50CiAgICAgICAgICB9OwogICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayA9PT0gdm9pZCAwID8gbnVsbCA6IGNhbGxiYWNrOwogICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoY3VycmVudCQxLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudCQxLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBjdXJyZW50JDEsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFB1YmxpY1Jvb3RJbnN0YW5jZShjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIgY29udGFpbmVyRmliZXIgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICBpZiAoIWNvbnRhaW5lckZpYmVyLmNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChjb250YWluZXJGaWJlci5jaGlsZC50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBnZXRQdWJsaWNJbnN0YW5jZShjb250YWluZXJGaWJlci5jaGlsZC5zdGF0ZU5vZGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBjb250YWluZXJGaWJlci5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgdmFyIGxhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKTsKICAgICAgICAgICAgICAgIGZsdXNoUm9vdChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3Q0ID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3Q0LCBmaWJlciwgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IFN5bmNMYW5lOwogICAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSA9IGhpZ2hlclByaW9yaXR5TGFuZShzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSwgcmV0cnlMYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoZmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSkgewogICAgICAgICAgICBtYXJrUmV0cnlMYW5lSW1wbChhbHRlcm5hdGUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gU2VsZWN0aXZlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5JDEoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhmaWJlcikgewogICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhmaWJlcik7CiAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBzaG91bGRFcnJvckltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRFcnJvcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZEVycm9ySW1wbChmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBzaG91bGRTdXNwZW5kSW1wbCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRTdXNwZW5kKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gc2hvdWxkU3VzcGVuZEltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGUgPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGggPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGggPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIHNjaGVkdWxlVXBkYXRlID0gbnVsbDsKICAgICAgICB2YXIgc2V0RXJyb3JIYW5kbGVyID0gbnVsbDsKICAgICAgICB2YXIgc2V0U3VzcGVuc2VIYW5kbGVyID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGVJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoMiwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoMltpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkyKG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbjIoe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBwYXRoMi5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIodXBkYXRlZCkpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKGtleSwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB1cGRhdGVkW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoRGVsZXRlSW1wbChvYmpba2V5XSwgcGF0aDIsIGluZGV4MiArIDEpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGUgPSBmdW5jdGlvbihvYmosIHBhdGgyKSB7CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aERlbGV0ZUltcGwob2JqLCBwYXRoMiwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoUmVuYW1lSW1wbCA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBvbGRLZXkgPSBvbGRQYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgaWYgKGluZGV4MiArIDEgPT09IG9sZFBhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0tleSA9IG5ld1BhdGhbaW5kZXgyXTsKICAgICAgICAgICAgICB1cGRhdGVkW25ld0tleV0gPSB1cGRhdGVkW29sZEtleV07CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShvbGRLZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtvbGRLZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGVkW29sZEtleV0gPSBjb3B5V2l0aFJlbmFtZUltcGwoCiAgICAgICAgICAgICAgICAvLyAkRmxvd0ZpeE1lIG51bWJlciBvciBzdHJpbmcgaXMgZmluZSBoZXJlCiAgICAgICAgICAgICAgICBvYmpbb2xkS2V5XSwKICAgICAgICAgICAgICAgIG9sZFBhdGgsCiAgICAgICAgICAgICAgICBuZXdQYXRoLAogICAgICAgICAgICAgICAgaW5kZXgyICsgMQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoUmVuYW1lID0gZnVuY3Rpb24ob2JqLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIGlmIChvbGRQYXRoLmxlbmd0aCAhPT0gbmV3UGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB3YXJuMygiY29weVdpdGhSZW5hbWUoKSBleHBlY3RzIHBhdGhzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld1BhdGgubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUGF0aFtpXSAhPT0gbmV3UGF0aFtpXSkgewogICAgICAgICAgICAgICAgICB3YXJuMygiY29weVdpdGhSZW5hbWUoKSBleHBlY3RzIHBhdGhzIHRvIGJlIHRoZSBzYW1lIGV4Y2VwdCBmb3IgdGhlIGRlZXBlc3Qga2V5Iik7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoUmVuYW1lSW1wbChvYmosIG9sZFBhdGgsIG5ld1BhdGgsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFNldEltcGwgPSBmdW5jdGlvbihvYmosIHBhdGgyLCBpbmRleDIsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpbmRleDIgPj0gcGF0aDIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoMltpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkyKG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbjIoe30sIG9iaik7CiAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoU2V0SW1wbChvYmpba2V5XSwgcGF0aDIsIGluZGV4MiArIDEsIHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0ID0gZnVuY3Rpb24ob2JqLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoU2V0SW1wbChvYmosIHBhdGgyLCAwLCB2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZpbmRIb29rID0gZnVuY3Rpb24oZmliZXIsIGlkKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SG9vazIgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudEhvb2syICE9PSBudWxsICYmIGlkID4gMCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rMiA9IGN1cnJlbnRIb29rMi5uZXh0OwogICAgICAgICAgICAgIGlkLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRIb29rMjsKICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aDIsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aFNldChob29rLm1lbW9pemVkU3RhdGUsIHBhdGgyLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aDIpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoRGVsZXRlKGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aDIpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbjIoe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoUmVuYW1lKGhvb2subWVtb2l6ZWRTdGF0ZSwgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHMgPSBmdW5jdGlvbihmaWJlciwgcGF0aDIsIHZhbHVlKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoU2V0KGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgyLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgcGF0aDIpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhEZWxldGUoZmliZXIubWVtb2l6ZWRQcm9wcywgcGF0aDIpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gZnVuY3Rpb24oZmliZXIsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhSZW5hbWUoZmliZXIubWVtb2l6ZWRQcm9wcywgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2NoZWR1bGVVcGRhdGUgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNldEVycm9ySGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZEVycm9ySW1wbCkgewogICAgICAgICAgICBzaG91bGRFcnJvckltcGwgPSBuZXdTaG91bGRFcnJvckltcGw7CiAgICAgICAgICB9OwogICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkU3VzcGVuZEltcGwpIHsKICAgICAgICAgICAgc2hvdWxkU3VzcGVuZEltcGwgPSBuZXdTaG91bGRTdXNwZW5kSW1wbDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbXB0eUZpbmRGaWJlckJ5SG9zdEluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyRm9yRGV2VG9vbHMoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdEludG9EZXZUb29scyhkZXZUb29sc0NvbmZpZykgewogICAgICAgICAgdmFyIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlID0gZGV2VG9vbHNDb25maWcuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U7CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgICAgcmV0dXJuIGluamVjdEludGVybmFscyh7CiAgICAgICAgICAgIGJ1bmRsZVR5cGU6IGRldlRvb2xzQ29uZmlnLmJ1bmRsZVR5cGUsCiAgICAgICAgICAgIHZlcnNpb246IGRldlRvb2xzQ29uZmlnLnZlcnNpb24sCiAgICAgICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyUGFja2FnZU5hbWUsCiAgICAgICAgICAgIHJlbmRlcmVyQ29uZmlnOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlckNvbmZpZywKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGUsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzLAogICAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGgsCiAgICAgICAgICAgIHNldEVycm9ySGFuZGxlciwKICAgICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyLAogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSwKICAgICAgICAgICAgY3VycmVudERpc3BhdGNoZXJSZWY6IFJlYWN0Q3VycmVudERpc3BhdGNoZXIyLAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlQnlGaWJlciwKICAgICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlIHx8IGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UsCiAgICAgICAgICAgIC8vIFJlYWN0IFJlZnJlc2gKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoLAogICAgICAgICAgICBzY2hlZHVsZVJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUm9vdCwKICAgICAgICAgICAgc2V0UmVmcmVzaEhhbmRsZXIsCiAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gYXBwZW5kIG93bmVyIHN0YWNrcyB0byBlcnJvciBtZXNzYWdlcyBpbiBERVYgbW9kZS4KICAgICAgICAgICAgZ2V0Q3VycmVudEZpYmVyOiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scywKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBkZXRlY3QgcmVjb25jaWxlciB2ZXJzaW9uIHJhdGhlciB0aGFuIHJlbmRlcmVyIHZlcnNpb24KICAgICAgICAgICAgLy8gd2hpY2ggbWF5IG5vdCBtYXRjaCBmb3IgdGhpcmQgcGFydHkgcmVuZGVyZXJzLgogICAgICAgICAgICByZWNvbmNpbGVyVmVyc2lvbjogUmVhY3RWZXJzaW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3IgPSB0eXBlb2YgcmVwb3J0RXJyb3IgPT09ICJmdW5jdGlvbiIgPyAoCiAgICAgICAgICAvLyBJbiBtb2Rlcm4gYnJvd3NlcnMsIHJlcG9ydEVycm9yIHdpbGwgZGlzcGF0Y2ggYW4gZXJyb3IgZXZlbnQsCiAgICAgICAgICAvLyBlbXVsYXRpbmcgYW4gdW5jYXVnaHQgSmF2YVNjcmlwdCBlcnJvci4KICAgICAgICAgIHJlcG9ydEVycm9yCiAgICAgICAgKSA6IGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gUmVhY3RET01Sb290KGludGVybmFsUm9vdCkgewogICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgIH0KICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnJlbmRlciA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB1cGRhdGUgYW4gdW5tb3VudGVkIHJvb3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBkb2VzIG5vdCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gYSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRDb250YWluZXIoYXJndW1lbnRzWzFdKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgY29udGFpbmVyIHRvIHRoZSBzZWNvbmQgYXJndW1lbnQgb2Ygcm9vdC5yZW5kZXIoLi4uKS4gWW91IGRvbid0IG5lZWQgdG8gcGFzcyBpdCBhZ2FpbiBzaW5jZSB5b3UgYWxyZWFkeSBwYXNzZWQgaXQgdG8gY3JlYXRlIHRoZSByb290LiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBzZWNvbmQgYXJndW1lbnQgdG8gcm9vdC5yZW5kZXIoLi4uKSBidXQgaXQgb25seSBhY2NlcHRzIG9uZSBhcmd1bWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGUgcm9vdCBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCByb290LnVubW91bnQoKSB0byBlbXB0eSBhIHJvb3QncyBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4sIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICB9OwogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50KC4uLik6IGRvZXMgbm90IHN1cHBvcnQgYSBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJBdHRlbXB0ZWQgdG8gc3luY2hyb25vdXNseSB1bm1vdW50IGEgcm9vdCB3aGlsZSBSZWFjdCB3YXMgYWxyZWFkeSByZW5kZXJpbmcuIFJlYWN0IGNhbm5vdCBmaW5pc2ggdW5tb3VudGluZyB0aGUgcm9vdCB1bnRpbCB0aGUgY3VycmVudCByZW5kZXIgaGFzIGNvbXBsZXRlZCwgd2hpY2ggbWF5IGxlYWQgdG8gYSByYWNlIGNvbmRpdGlvbi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihudWxsLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1bm1hcmtDb250YWluZXJBc1Jvb3QoY29udGFpbmVyMik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290Mihjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY3JlYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9ICIiOwogICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG51bGw7CiAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmh5ZHJhdGUpIHsKICAgICAgICAgICAgICAgIHdhcm4zKCJoeWRyYXRlIHRocm91Z2ggY3JlYXRlUm9vdCBpcyBkZXByZWNhdGVkLiBVc2UgUmVhY3RET01DbGllbnQuaHlkcmF0ZVJvb3QoY29udGFpbmVyLCA8QXBwIC8+KSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMyID09PSAib2JqZWN0IiAmJiBvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMi4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgSlNYIGVsZW1lbnQgdG8gY3JlYXRlUm9vdC4gWW91IHByb2JhYmx5IG1lYW50IHRvIGNhbGwgcm9vdC5yZW5kZXIgaW5zdGVhZC4gRXhhbXBsZSB1c2FnZTpcblxuICBsZXQgcm9vdCA9IGNyZWF0ZVJvb3QoZG9tQ29udGFpbmVyKTtcbiAgcm9vdC5yZW5kZXIoPEFwcCAvPik7Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi51bnN0YWJsZV9zdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgaXNTdHJpY3RNb2RlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIuaWRlbnRpZmllclByZWZpeCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWRlbnRpZmllclByZWZpeCA9IG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgb25SZWNvdmVyYWJsZUVycm9yID0gb3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIudHJhbnNpdGlvbkNhbGxiYWNrczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBudWxsLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHJldHVybiBuZXcgUmVhY3RET01Sb290KHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUmVhY3RET01IeWRyYXRpb25Sb290KGludGVybmFsUm9vdCkgewogICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUh5ZHJhdGlvbih0YXJnZXQpIHsKICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnVuc3RhYmxlX3NjaGVkdWxlSHlkcmF0aW9uID0gc2NoZWR1bGVIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiaHlkcmF0ZVJvb3QoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbml0aWFsQ2hpbGRyZW4gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGVycm9yKCJNdXN0IHByb3ZpZGUgaW5pdGlhbCBjaGlsZHJlbiBhcyBzZWNvbmQgYXJndW1lbnQgdG8gaHlkcmF0ZVJvb3QuIEV4YW1wbGUgdXNhZ2U6IGh5ZHJhdGVSb290KGRvbUNvbnRhaW5lciwgPEFwcCAvPikiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGh5ZHJhdGlvbkNhbGxiYWNrcyA9IG9wdGlvbnMyICE9IG51bGwgPyBvcHRpb25zMiA6IG51bGw7CiAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZXMgPSBvcHRpb25zMiAhPSBudWxsICYmIG9wdGlvbnMyLmh5ZHJhdGVkU291cmNlcyB8fCBudWxsOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChvcHRpb25zMi51bnN0YWJsZV9zdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgaXNTdHJpY3RNb2RlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIuaWRlbnRpZmllclByZWZpeCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWRlbnRpZmllclByZWZpeCA9IG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgb25SZWNvdmVyYWJsZUVycm9yID0gb3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBudWxsLCBjb250YWluZXIyLCBDb25jdXJyZW50Um9vdCwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMoY29udGFpbmVyMik7CiAgICAgICAgICBpZiAobXV0YWJsZVNvdXJjZXMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtdXRhYmxlU291cmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gbXV0YWJsZVNvdXJjZXNbaV07CiAgICAgICAgICAgICAgcmVnaXN0ZXJNdXRhYmxlU291cmNlRm9ySHlkcmF0aW9uKHJvb3QzLCBtdXRhYmxlU291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTUh5ZHJhdGlvblJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8ICFkaXNhYmxlQ29tbWVudHNBc0RPTUNvbnRhaW5lcnMpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZENvbnRhaW5lckxlZ2FjeShub2RlKSB7CiAgICAgICAgICByZXR1cm4gISEobm9kZSAmJiAobm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfRlJBR01FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgbm9kZS5ub2RlVmFsdWUgPT09ICIgcmVhY3QtbW91bnQtcG9pbnQtdW5zdGFibGUgIikpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSAmJiBjb250YWluZXIyLnRhZ05hbWUgJiYgY29udGFpbmVyMi50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJCT0RZIikgewogICAgICAgICAgICAgIGVycm9yKCJjcmVhdGVSb290KCk6IENyZWF0aW5nIHJvb3RzIGRpcmVjdGx5IHdpdGggZG9jdW1lbnQuYm9keSBpcyBkaXNjb3VyYWdlZCwgc2luY2UgaXRzIGNoaWxkcmVuIGFyZSBvZnRlbiBtYW5pcHVsYXRlZCBieSB0aGlyZC1wYXJ0eSBzY3JpcHRzIGFuZCBicm93c2VyIGV4dGVuc2lvbnMuIFRoaXMgbWF5IGxlYWQgdG8gc3VidGxlIHJlY29uY2lsaWF0aW9uIGlzc3Vlcy4gVHJ5IHVzaW5nIGEgY29udGFpbmVyIGVsZW1lbnQgY3JlYXRlZCBmb3IgeW91ciBhcHAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET00ucmVuZGVyKCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkgb24gYSBjb250YWluZXIgdGhhdCBoYXMgYWxyZWFkeSBiZWVuIHBhc3NlZCB0byBjcmVhdGVSb290KCkgYmVmb3JlLiBJbnN0ZWFkLCBjYWxsIHJvb3QucmVuZGVyKCkgb24gdGhlIGV4aXN0aW5nIHJvb3QgaW5zdGVhZCBpZiB5b3Ugd2FudCB0byB1cGRhdGUgaXQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciQzID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIHRvcExldmVsVXBkYXRlV2FybmluZ3M7CiAgICAgICAgewogICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyA9IGZ1bmN0aW9uKGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciAmJiBjb250YWluZXIyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyMikgewogICAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEl0IGxvb2tzIGxpa2UgdGhlIFJlYWN0LXJlbmRlcmVkIGNvbnRlbnQgb2YgdGhpcyBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlIHRvIGVtcHR5IGEgY29udGFpbmVyLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNSb290UmVuZGVyZWRCeVNvbWVSZWFjdCA9ICEhY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICB2YXIgaGFzTm9uUm9vdFJlYWN0Q2hpbGQgPSAhIShyb290RWwgJiYgZ2V0SW5zdGFuY2VGcm9tTm9kZShyb290RWwpKTsKICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkICYmICFpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0KSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBSZXBsYWNpbmcgUmVhY3QtcmVuZGVyZWQgY2hpbGRyZW4gd2l0aCBhIG5ldyByb290IGNvbXBvbmVudC4gSWYgeW91IGludGVuZGVkIHRvIHVwZGF0ZSB0aGUgY2hpbGRyZW4gb2YgdGhpcyBub2RlLCB5b3Ugc2hvdWxkIGluc3RlYWQgaGF2ZSB0aGUgZXhpc3RpbmcgY2hpbGRyZW4gdXBkYXRlIHRoZWlyIHN0YXRlIGFuZCByZW5kZXIgdGhlIG5ldyBjb21wb25lbnRzIGluc3RlYWQgb2YgY2FsbGluZyBSZWFjdERPTS5yZW5kZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSAmJiBjb250YWluZXIyLnRhZ05hbWUgJiYgY29udGFpbmVyMi50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJCT0RZIikgewogICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoKTogUmVuZGVyaW5nIGNvbXBvbmVudHMgZGlyZWN0bHkgaW50byBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgcmVuZGVyaW5nIGludG8gYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmICghY29udGFpbmVyMikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXIyLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXIyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3BPblJlY292ZXJhYmxlRXJyb3IoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeUNyZWF0ZVJvb3RGcm9tRE9NQ29udGFpbmVyKGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaywgaXNIeWRyYXRpb25Db250YWluZXIpIHsKICAgICAgICAgIGlmIChpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICAgICAgICAgIG9yaWdpbmFsQ2FsbGJhY2suY2FsbChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoCiAgICAgICAgICAgICAgaW5pdGlhbENoaWxkcmVuLAogICAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gcm9vdDM7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciByb290Q29udGFpbmVyRWxlbWVudCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lcjIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgZmx1c2hTeW5jKCk7CiAgICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByb290U2libGluZzsKICAgICAgICAgICAgd2hpbGUgKHJvb3RTaWJsaW5nID0gY29udGFpbmVyMi5sYXN0Q2hpbGQpIHsKICAgICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKHJvb3RTaWJsaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9vcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShfcm9vdCk7CiAgICAgICAgICAgICAgICBfb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfcm9vdCA9IGNyZWF0ZUNvbnRhaW5lcigKICAgICAgICAgICAgICBjb250YWluZXIyLAogICAgICAgICAgICAgIExlZ2FjeVJvb3QsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBoeWRyYXRpb25DYWxsYmFja3MKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBpc1N0cmljdE1vZGUKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLAogICAgICAgICAgICAgICIiLAogICAgICAgICAgICAgIC8vIGlkZW50aWZpZXJQcmVmaXgKICAgICAgICAgICAgICBub29wT25SZWNvdmVyYWJsZUVycm9yCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9IF9yb290OwogICAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KF9yb290LmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMoX3Jvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIF9yb290LCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBfcm9vdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsICYmIHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxlck5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGNoaWxkcmVuLCBjb250YWluZXIyLCBmb3JjZUh5ZHJhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRvcExldmVsVXBkYXRlV2FybmluZ3MoY29udGFpbmVyMik7CiAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayQxKGNhbGxiYWNrID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2ssICJyZW5kZXIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZVJvb3QgPSBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICB2YXIgcm9vdDM7CiAgICAgICAgICBpZiAoIW1heWJlUm9vdCkgewogICAgICAgICAgICByb290MyA9IGxlZ2FjeUNyZWF0ZVJvb3RGcm9tRE9NQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBmb3JjZUh5ZHJhdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMgPSBtYXliZVJvb3Q7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGZpbmRET01Ob2RlKGNvbXBvbmVudE9yRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZpbmRET01Ob2RlKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZERPTU5vZGUgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJmaW5kRE9NTm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIkMy5jdXJyZW50OwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgb3duZXIuc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHdhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gb3duZXIuc3RhdGVOb2RlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcjsKICAgICAgICAgICAgICBpZiAoIXdhcm5lZEFib3V0UmVmc0luUmVuZGVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgYWNjZXNzaW5nIGZpbmRET01Ob2RlIGluc2lkZSBpdHMgcmVuZGVyKCkuIHJlbmRlcigpIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiBJdCBzaG91bGQgbmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgcmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50RGlkVXBkYXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG93bmVyLnR5cGUpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbXBvbmVudE9yRWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbXBvbmVudE9yRWxlbWVudC5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wb25lbnRPckVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmaW5kSG9zdEluc3RhbmNlV2l0aFdhcm5pbmcoY29tcG9uZW50T3JFbGVtZW50LCAiZmluZERPTU5vZGUiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00uaHlkcmF0ZSBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBVc2UgaHlkcmF0ZVJvb3QgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgbmV3IEFQSSwgeW91ciBhcHAgd2lsbCBiZWhhdmUgYXMgaWYgaXQncyBydW5uaW5nIFJlYWN0IDE3LiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00uaHlkcmF0ZSgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCBoeWRyYXRlUm9vdChjb250YWluZXIsIGVsZW1lbnQpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgZWxlbWVudCwgY29udGFpbmVyMiwgdHJ1ZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXIoZWxlbWVudCwgY29udGFpbmVyMiwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnJlbmRlciBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBVc2UgY3JlYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5yZW5kZXIoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgcm9vdC5yZW5kZXIoZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcigpIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIENvbnNpZGVyIHVzaW5nIGEgcG9ydGFsIGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIGNyZWF0ZVJvb3QgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJlbnRDb21wb25lbnQgPT0gbnVsbCB8fCAhaGFzMyhwYXJlbnRDb21wb25lbnQpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigicGFyZW50Q29tcG9uZW50IG11c3QgYmUgYSB2YWxpZCBSZWFjdCBDb21wb25lbnQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdW5tb3VudENvbXBvbmVudEF0Tm9kZShjb250YWluZXIyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUgPSB0cnVlOwogICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBTd2l0Y2ggdG8gdGhlIGNyZWF0ZVJvb3QgQVBJLiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgcm9vdC51bm1vdW50KCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkQnlEaWZmZXJlbnRSZWFjdCA9IHJvb3RFbCAmJiAhZ2V0SW5zdGFuY2VGcm9tTm9kZShyb290RWwpOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKCk6IFRoZSBub2RlIHlvdSdyZSBhdHRlbXB0aW5nIHRvIHVubW91bnQgd2FzIHJlbmRlcmVkIGJ5IGFub3RoZXIgY29weSBvZiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIG51bGwsIGNvbnRhaW5lcjIsIGZhbHNlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9IG51bGw7CiAgICAgICAgICAgICAgICB1bm1hcmtDb250YWluZXJBc1Jvb3QoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgICB2YXIgaGFzTm9uUm9vdFJlYWN0Q2hpbGQgPSAhIShfcm9vdEVsICYmIGdldEluc3RhbmNlRnJvbU5vZGUoX3Jvb3RFbCkpOwogICAgICAgICAgICAgIHZhciBpc0NvbnRhaW5lclJlYWN0Um9vdCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSAmJiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIucGFyZW50Tm9kZSkgJiYgISFjb250YWluZXIyLnBhcmVudE5vZGUuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKCk6IFRoZSBub2RlIHlvdSdyZSBhdHRlbXB0aW5nIHRvIHVubW91bnQgd2FzIHJlbmRlcmVkIGJ5IFJlYWN0IGFuZCBpcyBub3QgYSB0b3AtbGV2ZWwgY29udGFpbmVyLiAlcyIsIGlzQ29udGFpbmVyUmVhY3RSb290ID8gIllvdSBtYXkgaGF2ZSBhY2NpZGVudGFsbHkgcGFzc2VkIGluIGEgUmVhY3Qgcm9vdCBub2RlIGluc3RlYWQgb2YgaXRzIGNvbnRhaW5lci4iIDogIkluc3RlYWQsIGhhdmUgdGhlIHBhcmVudCBjb21wb25lbnQgdXBkYXRlIGl0cyBzdGF0ZSBhbmQgcmVyZW5kZXIgaW4gb3JkZXIgdG8gcmVtb3ZlIHRoaXMgY29tcG9uZW50LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldEF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMSk7CiAgICAgICAgc2V0QXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24kMSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKTsKICAgICAgICBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KTsKICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShydW5XaXRoUHJpb3JpdHkpOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2YgTWFwICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgTWFwIGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIE1hcC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgTWFwLnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBTZXQgIT09ICJmdW5jdGlvbiIgfHwgLy8gJEZsb3dJc3N1ZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBTZXQgaGFzIG5vIHByb3RvdHlwZQogICAgICAgICAgU2V0LnByb3RvdHlwZSA9PSBudWxsIHx8IHR5cGVvZiBTZXQucHJvdG90eXBlLmNsZWFyICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBTZXQucHJvdG90eXBlLmZvckVhY2ggIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGRlcGVuZHMgb24gTWFwIGFuZCBTZXQgYnVpbHQtaW4gdHlwZXMuIE1ha2Ugc3VyZSB0aGF0IHlvdSBsb2FkIGEgcG9seWZpbGwgaW4gb2xkZXIgYnJvd3NlcnMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1wb2x5ZmlsbHMiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMyk7CiAgICAgICAgc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihiYXRjaGVkVXBkYXRlcyQxLCBkaXNjcmV0ZVVwZGF0ZXMsIGZsdXNoU3luYyk7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsJDEoY2hpbGRyZW4sIGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHZhciBrZXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IG51bGw7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVBvcnRhbDMoY2hpbGRyZW4sIGNvbnRhaW5lcjIsIG51bGwsIGtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIEludGVybmFscyA9IHsKICAgICAgICAgIHVzaW5nQ2xpZW50RW50cnlQb2ludDogZmFsc2UsCiAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgZm9yIGJldHRlciBtaW5pZmljYXRpb24uCiAgICAgICAgICBFdmVudHM6IFtnZXRJbnN0YW5jZUZyb21Ob2RlLCBnZXROb2RlRnJvbUluc3RhbmNlLCBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlLCBlbnF1ZXVlU3RhdGVSZXN0b3JlLCByZXN0b3JlU3RhdGVJZk5lZWRlZCwgYmF0Y2hlZFVwZGF0ZXMkMV0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QkMShjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBjcmVhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGh5ZHJhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMkMShmbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBSZWFjdCBjYW5ub3QgZmx1c2ggd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4gQ29uc2lkZXIgbW92aW5nIHRoaXMgY2FsbCB0byBhIHNjaGVkdWxlciB0YXNrIG9yIG1pY3JvIHRhc2suIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbHVzaFN5bmMoZm4pOwogICAgICAgIH0KICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUsCiAgICAgICAgICBidW5kbGVUeXBlOiAxLAogICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LWRvbSIKICAgICAgICB9KTsKICAgICAgICB7CiAgICAgICAgICBpZiAoIWZvdW5kRGV2VG9vbHMgJiYgY2FuVXNlRE9NMiAmJiB3aW5kb3cudG9wID09PSB3aW5kb3cuc2VsZikgewogICAgICAgICAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSA+IC0xICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRWRnZSIpID09PSAtMSB8fCBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSA+IC0xKSB7CiAgICAgICAgICAgICAgdmFyIHByb3RvY29sID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sOwogICAgICAgICAgICAgIGlmICgvXihodHRwcz98ZmlsZSk6JC8udGVzdChwcm90b2NvbCkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbygiJWNEb3dubG9hZCB0aGUgUmVhY3QgRGV2VG9vbHMgZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIgKyAocHJvdG9jb2wgPT09ICJmaWxlOiIgPyAiXG5Zb3UgbWlnaHQgbmVlZCB0byB1c2UgYSBsb2NhbCBIVFRQIHNlcnZlciAoaW5zdGVhZCBvZiBmaWxlOi8vKTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzLWZhcSIgOiAiIiksICJmb250LXdlaWdodDpib2xkIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cG9ydHMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBJbnRlcm5hbHM7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVQb3J0YWwgPSBjcmVhdGVQb3J0YWwkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBjcmVhdGVSb290JDE7CiAgICAgICAgZXhwb3J0cy5maW5kRE9NTm9kZSA9IGZpbmRET01Ob2RlOwogICAgICAgIGV4cG9ydHMuZmx1c2hTeW5jID0gZmx1c2hTeW5jJDE7CiAgICAgICAgZXhwb3J0cy5oeWRyYXRlID0gaHlkcmF0ZTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gaHlkcmF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLnJlbmRlciA9IHJlbmRlcjsKICAgICAgICBleHBvcnRzLnVubW91bnRDb21wb25lbnRBdE5vZGUgPSB1bm1vdW50Q29tcG9uZW50QXROb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYmF0Y2hlZFVwZGF0ZXMgPSBiYXRjaGVkVXBkYXRlcyQxOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIgPSByZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcjsKICAgICAgICBleHBvcnRzLnZlcnNpb24gPSBSZWFjdFZlcnNpb247CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb20gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGNoZWNrRENFKCk7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzCnZhciByZXF1aXJlX2NsaWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBtID0gcmVxdWlyZV9yZWFjdF9kb20oKTsKICAgIGlmIChmYWxzZSkgewogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBtLmNyZWF0ZVJvb3Q7CiAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBtLmh5ZHJhdGVSb290OwogICAgfSBlbHNlIHsKICAgICAgaSA9IG0uX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmNyZWF0ZVJvb3QoYywgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gZnVuY3Rpb24oYywgaCwgbykgewogICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG0uaHlkcmF0ZVJvb3QoYywgaCwgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgdmFyIGk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L19pbnRlcm5hbC9pc1Vuc2FmZVByb3BlcnR5LmpzCnZhciByZXF1aXJlX2lzVW5zYWZlUHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvX2ludGVybmFsL2lzVW5zYWZlUHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNVbnNhZmVQcm9wZXJ0eShrZXkpIHsKICAgICAgcmV0dXJuIGtleSA9PT0gIl9fcHJvdG9fXyI7CiAgICB9CiAgICBleHBvcnRzLmlzVW5zYWZlUHJvcGVydHkgPSBpc1Vuc2FmZVByb3BlcnR5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcwp2YXIgcmVxdWlyZV9pc0RlZXBLZXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0RlZXBLZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNEZWVwS2V5KGtleSkgewogICAgICBzd2l0Y2ggKHR5cGVvZiBrZXkpIHsKICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgIGNhc2UgInN5bWJvbCI6IHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3RyaW5nIjogewogICAgICAgICAgcmV0dXJuIGtleS5pbmNsdWRlcygiLiIpIHx8IGtleS5pbmNsdWRlcygiWyIpIHx8IGtleS5pbmNsdWRlcygiXSIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZXhwb3J0cy5pc0RlZXBLZXkgPSBpc0RlZXBLZXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9LZXkuanMKdmFyIHJlcXVpcmVfdG9LZXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0tleSh2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChPYmplY3QuaXModmFsdWU/LnZhbHVlT2Y/LigpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9LZXkgPSB0b0tleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9TdHJpbmcuanMKdmFyIHJlcXVpcmVfdG9TdHJpbmcgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9TdHJpbmcuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gIiI7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh0b1N0cmluZykuam9pbigiLCIpOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdCA9IFN0cmluZyh2YWx1ZSk7CiAgICAgIGlmIChyZXN1bHQgPT09ICIwIiAmJiBPYmplY3QuaXMoTnVtYmVyKHZhbHVlKSwgLTApKSB7CiAgICAgICAgcmV0dXJuICItMCI7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMudG9TdHJpbmcgPSB0b1N0cmluZzsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9QYXRoLmpzCnZhciByZXF1aXJlX3RvUGF0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1BhdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHRvU3RyaW5nID0gcmVxdWlyZV90b1N0cmluZygpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgZnVuY3Rpb24gdG9QYXRoKGRlZXBLZXkpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGVlcEtleSkpIHsKICAgICAgICByZXR1cm4gZGVlcEtleS5tYXAodG9LZXkudG9LZXkpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgZGVlcEtleSA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gW2RlZXBLZXldOwogICAgICB9CiAgICAgIGRlZXBLZXkgPSB0b1N0cmluZy50b1N0cmluZyhkZWVwS2V5KTsKICAgICAgY29uc3QgcmVzdWx0ID0gW107CiAgICAgIGNvbnN0IGxlbmd0aCA9IGRlZXBLZXkubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBsZXQgaW5kZXggPSAwOwogICAgICBsZXQga2V5ID0gIiI7CiAgICAgIGxldCBxdW90ZUNoYXIgPSAiIjsKICAgICAgbGV0IGJyYWNrZXQgPSBmYWxzZTsKICAgICAgaWYgKGRlZXBLZXkuY2hhckNvZGVBdCgwKSA9PT0gNDYpIHsKICAgICAgICByZXN1bHQucHVzaCgiIik7CiAgICAgICAgaW5kZXgrKzsKICAgICAgfQogICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBjb25zdCBjaGFyID0gZGVlcEtleVtpbmRleF07CiAgICAgICAgaWYgKHF1b3RlQ2hhcikgewogICAgICAgICAgaWYgKGNoYXIgPT09ICJcXCIgJiYgaW5kZXggKyAxIDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGtleSArPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gcXVvdGVDaGFyKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChicmFja2V0KSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICBxdW90ZUNoYXIgPSBjaGFyOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAiXSIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IGZhbHNlOwogICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSArPSBjaGFyOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlsiKSB7CiAgICAgICAgICAgIGJyYWNrZXQgPSB0cnVlOwogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAiLiIpIHsKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgICAga2V5ID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSArPSBjaGFyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIGlmIChrZXkpIHsKICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnRvUGF0aCA9IHRvUGF0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9nZXQuanMKdmFyIHJlcXVpcmVfZ2V0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1Vuc2FmZVByb3BlcnR5ID0gcmVxdWlyZV9pc1Vuc2FmZVByb3BlcnR5KCk7CiAgICB2YXIgaXNEZWVwS2V5ID0gcmVxdWlyZV9pc0RlZXBLZXkoKTsKICAgIHZhciB0b0tleSA9IHJlcXVpcmVfdG9LZXkoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gZ2V0NShvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKG9iamVjdCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBwYXRoMikgewogICAgICAgIGNhc2UgInN0cmluZyI6IHsKICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSkgewogICAgICAgICAgICAgIHJldHVybiBnZXQ1KG9iamVjdCwgdG9QYXRoLnRvUGF0aChwYXRoMiksIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICBjYXNlICJzeW1ib2wiOiB7CiAgICAgICAgICBpZiAodHlwZW9mIHBhdGgyID09PSAibnVtYmVyIikgewogICAgICAgICAgICBwYXRoMiA9IHRvS2V5LnRvS2V5KHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChPYmplY3QuaXMocGF0aDI/LnZhbHVlT2YoKSwgLTApKSB7CiAgICAgICAgICAgIHBhdGgyID0gIi0wIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhdGgyID0gU3RyaW5nKHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmIChwYXRoMi5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHBhdGgyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIGlmIChjdXJyZW50MyA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoaXNVbnNhZmVQcm9wZXJ0eS5pc1Vuc2FmZVByb3BlcnR5KHBhdGgyW2luZGV4XSkpIHsKICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNbcGF0aDJbaW5kZXhdXTsKICAgICAgfQogICAgICBpZiAoY3VycmVudDMgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgfQogICAgZXhwb3J0cy5nZXQgPSBnZXQ1OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2dldC5qcwp2YXIgcmVxdWlyZV9nZXQyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvZ2V0LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9nZXQoKS5nZXQ7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvdW5pcUJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHVuaXFCeTIoYXJyLCBtYXBwZXIpIHsKICAgICAgY29uc3QgbWFwMyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IGFycltpXTsKICAgICAgICBjb25zdCBrZXkgPSBtYXBwZXIoaXRlbSk7CiAgICAgICAgaWYgKCFtYXAzLmhhcyhrZXkpKSB7CiAgICAgICAgICBtYXAzLnNldChrZXksIGl0ZW0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gQXJyYXkuZnJvbShtYXAzLnZhbHVlcygpKTsKICAgIH0KICAgIGV4cG9ydHMudW5pcUJ5ID0gdW5pcUJ5MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vaWRlbnRpdHkuanMKdmFyIHJlcXVpcmVfaWRlbnRpdHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vaWRlbnRpdHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaWRlbnRpdHk0KHgyKSB7CiAgICAgIHJldHVybiB4MjsKICAgIH0KICAgIGV4cG9ydHMuaWRlbnRpdHkgPSBpZGVudGl0eTQ7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc0xlbmd0aC5qcwp2YXIgcmVxdWlyZV9pc0xlbmd0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNMZW5ndGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNMZW5ndGgodmFsdWUpIHsKICAgICAgcmV0dXJuIE51bWJlci5pc1NhZmVJbnRlZ2VyKHZhbHVlKSAmJiB2YWx1ZSA+PSAwOwogICAgfQogICAgZXhwb3J0cy5pc0xlbmd0aCA9IGlzTGVuZ3RoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlLmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTGVuZ3RoID0gcmVxdWlyZV9pc0xlbmd0aCgpOwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iICYmIGlzTGVuZ3RoLmlzTGVuZ3RoKHZhbHVlLmxlbmd0aCk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlID0gaXNBcnJheUxpa2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNPYmplY3RMaWtlLmpzCnZhciByZXF1aXJlX2lzT2JqZWN0TGlrZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdExpa2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGw7CiAgICB9CiAgICBleHBvcnRzLmlzT2JqZWN0TGlrZSA9IGlzT2JqZWN0TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZU9iamVjdC5qcwp2YXIgcmVxdWlyZV9pc0FycmF5TGlrZU9iamVjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlT2JqZWN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0FycmF5TGlrZSA9IHJlcXVpcmVfaXNBcnJheUxpa2UoKTsKICAgIHZhciBpc09iamVjdExpa2UgPSByZXF1aXJlX2lzT2JqZWN0TGlrZSgpOwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2VPYmplY3QodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0TGlrZS5pc09iamVjdExpa2UodmFsdWUpICYmIGlzQXJyYXlMaWtlLmlzQXJyYXlMaWtlKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheUxpa2VPYmplY3QgPSBpc0FycmF5TGlrZU9iamVjdDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9wcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9wcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L3Byb3BlcnR5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXQ1ID0gcmVxdWlyZV9nZXQoKTsKICAgIGZ1bmN0aW9uIHByb3BlcnR5KHBhdGgyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gZ2V0NS5nZXQob2JqZWN0LCBwYXRoMik7CiAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLnByb3BlcnR5ID0gcHJvcGVydHk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNPYmplY3QuanMKdmFyIHJlcXVpcmVfaXNPYmplY3QgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKICAgIH0KICAgIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzUHJpbWl0aXZlLmpzCnZhciByZXF1aXJlX2lzUHJpbWl0aXZlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc1ByaW1pdGl2ZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1ByaW1pdGl2ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZSAhPT0gImZ1bmN0aW9uIjsKICAgIH0KICAgIGV4cG9ydHMuaXNQcmltaXRpdmUgPSBpc1ByaW1pdGl2ZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvZXEuanMKdmFyIHJlcXVpcmVfZXEgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvZXEuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZXEodmFsdWUsIG90aGVyKSB7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gb3RoZXIgfHwgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4ob3RoZXIpOwogICAgfQogICAgZXhwb3J0cy5lcSA9IGVxOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzTWF0Y2hXaXRoLmpzCnZhciByZXF1aXJlX2lzTWF0Y2hXaXRoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGlzUHJpbWl0aXZlID0gcmVxdWlyZV9pc1ByaW1pdGl2ZSgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUpIHsKICAgICAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgICB9CiAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgc291cmNlLCBmdW5jdGlvbiBkb2VzTWF0Y2gob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlMiwgc3RhY2spIHsKICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZShvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UyLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIEJvb2xlYW4oaXNFcXVhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKG9ialZhbHVlLCBzcmNWYWx1ZSwgZG9lc01hdGNoLCBzdGFjayk7CiAgICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgfQogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PT0gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygc291cmNlKSB7CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgICAgICBjb25zdCBzb3VyY2VLZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgICAgIGlmIChzb3VyY2VLZXlzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCB7IC4uLnNvdXJjZSB9LCBjb21wYXJlLCBzdGFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXEuZXEodGFyZ2V0LCBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KHRhcmdldCkpIHsKICAgICAgICAgICAgcmV0dXJuIGVxLmVxKHRhcmdldCwgc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gc291cmNlID09PSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNPYmplY3RNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc291cmNlKSkgewogICAgICAgIHJldHVybiBpc0FycmF5TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgcmV0dXJuIGlzTWFwTWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgU2V0KSB7CiAgICAgICAgcmV0dXJuIGlzU2V0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgaWYgKHRhcmdldCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGtleXMubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChzdGFjaz8uaGFzKHNvdXJjZSkpIHsKICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHNvdXJjZSkgPT09IHRhcmdldDsKICAgICAgfQogICAgICBzdGFjaz8uc2V0KHNvdXJjZSwgdGFyZ2V0KTsKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgICBpZiAoIWlzUHJpbWl0aXZlLmlzUHJpbWl0aXZlKHRhcmdldCkgJiYgIShrZXkgaW4gdGFyZ2V0KSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlW2tleV0gPT09IHZvaWQgMCAmJiB0YXJnZXRba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzb3VyY2Vba2V5XSA9PT0gbnVsbCAmJiB0YXJnZXRba2V5XSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRba2V5XSwgc291cmNlW2tleV0sIGtleSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICAgIGlmICghaXNFcXVhbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHN0YWNrPy5kZWxldGUoc291cmNlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNNYXBNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZS5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCEodGFyZ2V0IGluc3RhbmNlb2YgTWFwKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IFtrZXksIHNvdXJjZVZhbHVlXSBvZiBzb3VyY2UuZW50cmllcygpKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSB0YXJnZXQuZ2V0KGtleSk7CiAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUodGFyZ2V0VmFsdWUsIHNvdXJjZVZhbHVlLCBrZXksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gaXNBcnJheU1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGNvbnN0IGNvdW50ZWRJbmRleCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc291cmNlSXRlbSA9IHNvdXJjZVtpXTsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRhcmdldC5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGNvdW50ZWRJbmRleC5oYXMoaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGFyZ2V0W2pdOwogICAgICAgICAgbGV0IG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRJdGVtLCBzb3VyY2VJdGVtLCBpLCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgICAgaWYgKGlzRXF1YWwpIHsKICAgICAgICAgICAgbWF0Y2hlczIgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoZXMyKSB7CiAgICAgICAgICAgIGNvdW50ZWRJbmRleC5hZGQoaik7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NldE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBTZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBpc0FycmF5TWF0Y2goWy4uLnRhcmdldF0sIFsuLi5zb3VyY2VdLCBjb21wYXJlLCBzdGFjayk7CiAgICB9CiAgICBleHBvcnRzLmlzTWF0Y2hXaXRoID0gaXNNYXRjaFdpdGg7CiAgICBleHBvcnRzLmlzU2V0TWF0Y2ggPSBpc1NldE1hdGNoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzTWF0Y2guanMKdmFyIHJlcXVpcmVfaXNNYXRjaCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzTWF0Y2guanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2hXaXRoID0gcmVxdWlyZV9pc01hdGNoV2l0aCgpOwogICAgZnVuY3Rpb24gaXNNYXRjaCh0YXJnZXQsIHNvdXJjZSkgewogICAgICByZXR1cm4gaXNNYXRjaFdpdGguaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsICgpID0+IHZvaWQgMCk7CiAgICB9CiAgICBleHBvcnRzLmlzTWF0Y2ggPSBpc01hdGNoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFN5bWJvbHMuanMKdmFyIHJlcXVpcmVfZ2V0U3ltYm9scyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFN5bWJvbHMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0U3ltYm9scyhvYmplY3QpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMob2JqZWN0KS5maWx0ZXIoKHN5bWJvbCkgPT4gT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKG9iamVjdCwgc3ltYm9sKSk7CiAgICB9CiAgICBleHBvcnRzLmdldFN5bWJvbHMgPSBnZXRTeW1ib2xzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFRhZy5qcwp2YXIgcmVxdWlyZV9nZXRUYWcgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0VGFnKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB2b2lkIDAgPyAiW29iamVjdCBVbmRlZmluZWRdIiA6ICJbb2JqZWN0IE51bGxdIjsKICAgICAgfQogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0VGFnID0gZ2V0VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RhZ3MuanMKdmFyIHJlcXVpcmVfdGFncyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RhZ3MuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHJlZ2V4cFRhZyA9ICJbb2JqZWN0IFJlZ0V4cF0iOwogICAgdmFyIHN0cmluZ1RhZyA9ICJbb2JqZWN0IFN0cmluZ10iOwogICAgdmFyIG51bWJlclRhZyA9ICJbb2JqZWN0IE51bWJlcl0iOwogICAgdmFyIGJvb2xlYW5UYWcgPSAiW29iamVjdCBCb29sZWFuXSI7CiAgICB2YXIgYXJndW1lbnRzVGFnID0gIltvYmplY3QgQXJndW1lbnRzXSI7CiAgICB2YXIgc3ltYm9sVGFnID0gIltvYmplY3QgU3ltYm9sXSI7CiAgICB2YXIgZGF0ZVRhZyA9ICJbb2JqZWN0IERhdGVdIjsKICAgIHZhciBtYXBUYWcgPSAiW29iamVjdCBNYXBdIjsKICAgIHZhciBzZXRUYWcgPSAiW29iamVjdCBTZXRdIjsKICAgIHZhciBhcnJheVRhZyA9ICJbb2JqZWN0IEFycmF5XSI7CiAgICB2YXIgZnVuY3Rpb25UYWcgPSAiW29iamVjdCBGdW5jdGlvbl0iOwogICAgdmFyIGFycmF5QnVmZmVyVGFnID0gIltvYmplY3QgQXJyYXlCdWZmZXJdIjsKICAgIHZhciBvYmplY3RUYWcgPSAiW29iamVjdCBPYmplY3RdIjsKICAgIHZhciBlcnJvclRhZyA9ICJbb2JqZWN0IEVycm9yXSI7CiAgICB2YXIgZGF0YVZpZXdUYWcgPSAiW29iamVjdCBEYXRhVmlld10iOwogICAgdmFyIHVpbnQ4QXJyYXlUYWcgPSAiW29iamVjdCBVaW50OEFycmF5XSI7CiAgICB2YXIgdWludDhDbGFtcGVkQXJyYXlUYWcgPSAiW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0iOwogICAgdmFyIHVpbnQxNkFycmF5VGFnID0gIltvYmplY3QgVWludDE2QXJyYXldIjsKICAgIHZhciB1aW50MzJBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQzMkFycmF5XSI7CiAgICB2YXIgYmlnVWludDY0QXJyYXlUYWcgPSAiW29iamVjdCBCaWdVaW50NjRBcnJheV0iOwogICAgdmFyIGludDhBcnJheVRhZyA9ICJbb2JqZWN0IEludDhBcnJheV0iOwogICAgdmFyIGludDE2QXJyYXlUYWcgPSAiW29iamVjdCBJbnQxNkFycmF5XSI7CiAgICB2YXIgaW50MzJBcnJheVRhZyA9ICJbb2JqZWN0IEludDMyQXJyYXldIjsKICAgIHZhciBiaWdJbnQ2NEFycmF5VGFnID0gIltvYmplY3QgQmlnSW50NjRBcnJheV0iOwogICAgdmFyIGZsb2F0MzJBcnJheVRhZyA9ICJbb2JqZWN0IEZsb2F0MzJBcnJheV0iOwogICAgdmFyIGZsb2F0NjRBcnJheVRhZyA9ICJbb2JqZWN0IEZsb2F0NjRBcnJheV0iOwogICAgZXhwb3J0cy5hcmd1bWVudHNUYWcgPSBhcmd1bWVudHNUYWc7CiAgICBleHBvcnRzLmFycmF5QnVmZmVyVGFnID0gYXJyYXlCdWZmZXJUYWc7CiAgICBleHBvcnRzLmFycmF5VGFnID0gYXJyYXlUYWc7CiAgICBleHBvcnRzLmJpZ0ludDY0QXJyYXlUYWcgPSBiaWdJbnQ2NEFycmF5VGFnOwogICAgZXhwb3J0cy5iaWdVaW50NjRBcnJheVRhZyA9IGJpZ1VpbnQ2NEFycmF5VGFnOwogICAgZXhwb3J0cy5ib29sZWFuVGFnID0gYm9vbGVhblRhZzsKICAgIGV4cG9ydHMuZGF0YVZpZXdUYWcgPSBkYXRhVmlld1RhZzsKICAgIGV4cG9ydHMuZGF0ZVRhZyA9IGRhdGVUYWc7CiAgICBleHBvcnRzLmVycm9yVGFnID0gZXJyb3JUYWc7CiAgICBleHBvcnRzLmZsb2F0MzJBcnJheVRhZyA9IGZsb2F0MzJBcnJheVRhZzsKICAgIGV4cG9ydHMuZmxvYXQ2NEFycmF5VGFnID0gZmxvYXQ2NEFycmF5VGFnOwogICAgZXhwb3J0cy5mdW5jdGlvblRhZyA9IGZ1bmN0aW9uVGFnOwogICAgZXhwb3J0cy5pbnQxNkFycmF5VGFnID0gaW50MTZBcnJheVRhZzsKICAgIGV4cG9ydHMuaW50MzJBcnJheVRhZyA9IGludDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLmludDhBcnJheVRhZyA9IGludDhBcnJheVRhZzsKICAgIGV4cG9ydHMubWFwVGFnID0gbWFwVGFnOwogICAgZXhwb3J0cy5udW1iZXJUYWcgPSBudW1iZXJUYWc7CiAgICBleHBvcnRzLm9iamVjdFRhZyA9IG9iamVjdFRhZzsKICAgIGV4cG9ydHMucmVnZXhwVGFnID0gcmVnZXhwVGFnOwogICAgZXhwb3J0cy5zZXRUYWcgPSBzZXRUYWc7CiAgICBleHBvcnRzLnN0cmluZ1RhZyA9IHN0cmluZ1RhZzsKICAgIGV4cG9ydHMuc3ltYm9sVGFnID0gc3ltYm9sVGFnOwogICAgZXhwb3J0cy51aW50MTZBcnJheVRhZyA9IHVpbnQxNkFycmF5VGFnOwogICAgZXhwb3J0cy51aW50MzJBcnJheVRhZyA9IHVpbnQzMkFycmF5VGFnOwogICAgZXhwb3J0cy51aW50OEFycmF5VGFnID0gdWludDhBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDhDbGFtcGVkQXJyYXlUYWcgPSB1aW50OENsYW1wZWRBcnJheVRhZzsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzVHlwZWRBcnJheS5qcwp2YXIgcmVxdWlyZV9pc1R5cGVkQXJyYXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzVHlwZWRBcnJheS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1R5cGVkQXJyYXkoeDIpIHsKICAgICAgcmV0dXJuIEFycmF5QnVmZmVyLmlzVmlldyh4MikgJiYgISh4MiBpbnN0YW5jZW9mIERhdGFWaWV3KTsKICAgIH0KICAgIGV4cG9ydHMuaXNUeXBlZEFycmF5ID0gaXNUeXBlZEFycmF5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXBXaXRoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXRTeW1ib2xzID0gcmVxdWlyZV9nZXRTeW1ib2xzKCk7CiAgICB2YXIgZ2V0VGFnID0gcmVxdWlyZV9nZXRUYWcoKTsKICAgIHZhciB0YWdzID0gcmVxdWlyZV90YWdzKCk7CiAgICB2YXIgaXNQcmltaXRpdmUgPSByZXF1aXJlX2lzUHJpbWl0aXZlKCk7CiAgICB2YXIgaXNUeXBlZEFycmF5ID0gcmVxdWlyZV9pc1R5cGVkQXJyYXkoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGgob2JqLCBjbG9uZVZhbHVlKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlVG9DbG9uZSwga2V5VG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlID0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVmFsdWU/Lih2YWx1ZVRvQ2xvbmUsIGtleVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrKTsKICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGNsb25lZDsKICAgICAgfQogICAgICBpZiAoaXNQcmltaXRpdmUuaXNQcmltaXRpdmUodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICAgIH0KICAgICAgaWYgKHN0YWNrLmhhcyh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrLmdldCh2YWx1ZVRvQ2xvbmUpOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGlmIChPYmplY3QuaGFzT3duKHZhbHVlVG9DbG9uZSwgImluZGV4IikpIHsKICAgICAgICAgIHJlc3VsdC5pbmRleCA9IHZhbHVlVG9DbG9uZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgaWYgKE9iamVjdC5oYXNPd24odmFsdWVUb0Nsb25lLCAiaW5wdXQiKSkgewogICAgICAgICAgcmVzdWx0LmlucHV0ID0gdmFsdWVUb0Nsb25lLmlucHV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlVG9DbG9uZS5nZXRUaW1lKCkpOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgUmVnRXhwKHZhbHVlVG9DbG9uZS5zb3VyY2UsIHZhbHVlVG9DbG9uZS5mbGFncyk7CiAgICAgICAgcmVzdWx0Lmxhc3RJbmRleCA9IHZhbHVlVG9DbG9uZS5sYXN0SW5kZXg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LnNldChrZXksIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlLCBrZXksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFNldCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LmFkZChjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZSwgdm9pZCAwLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgQnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiBCdWZmZXIuaXNCdWZmZXIodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmUuc3ViYXJyYXkoKTsKICAgICAgfQogICAgICBpZiAoaXNUeXBlZEFycmF5LmlzVHlwZWRBcnJheSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IChPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVUb0Nsb25lKSkuY29uc3RydWN0b3IodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IHR5cGVvZiBTaGFyZWRBcnJheUJ1ZmZlciAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU2hhcmVkQXJyYXlCdWZmZXIpIHsKICAgICAgICByZXR1cm4gdmFsdWVUb0Nsb25lLnNsaWNlKDApOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRhVmlldykgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBEYXRhVmlldyh2YWx1ZVRvQ2xvbmUuYnVmZmVyLnNsaWNlKDApLCB2YWx1ZVRvQ2xvbmUuYnl0ZU9mZnNldCwgdmFsdWVUb0Nsb25lLmJ5dGVMZW5ndGgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgRmlsZSAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRmlsZSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBGaWxlKFt2YWx1ZVRvQ2xvbmVdLCB2YWx1ZVRvQ2xvbmUubmFtZSwgewogICAgICAgICAgdHlwZTogdmFsdWVUb0Nsb25lLnR5cGUKICAgICAgICB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQmxvYihbdmFsdWVUb0Nsb25lXSwgeyB0eXBlOiB2YWx1ZVRvQ2xvbmUudHlwZSB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgdmFsdWVUb0Nsb25lLmNvbnN0cnVjdG9yKCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICByZXN1bHQubWVzc2FnZSA9IHZhbHVlVG9DbG9uZS5tZXNzYWdlOwogICAgICAgIHJlc3VsdC5uYW1lID0gdmFsdWVUb0Nsb25lLm5hbWU7CiAgICAgICAgcmVzdWx0LnN0YWNrID0gdmFsdWVUb0Nsb25lLnN0YWNrOwogICAgICAgIHJlc3VsdC5jYXVzZSA9IHZhbHVlVG9DbG9uZS5jYXVzZTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJvb2xlYW4pIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQm9vbGVhbih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTnVtYmVyKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IE51bWJlcih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFN0cmluZyh2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlVG9DbG9uZSA9PT0gIm9iamVjdCIgJiYgaXNDbG9uZWFibGVPYmplY3QodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlVG9DbG9uZSkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICB9CiAgICBmdW5jdGlvbiBjb3B5UHJvcGVydGllcyh0YXJnZXQsIHNvdXJjZSwgb2JqZWN0VG9DbG9uZSA9IHRhcmdldCwgc3RhY2ssIGNsb25lVmFsdWUpIHsKICAgICAgY29uc3Qga2V5cyA9IFsuLi5PYmplY3Qua2V5cyhzb3VyY2UpLCAuLi5nZXRTeW1ib2xzLmdldFN5bWJvbHMoc291cmNlKV07CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpOwogICAgICAgIGlmIChkZXNjcmlwdG9yID09IG51bGwgfHwgZGVzY3JpcHRvci53cml0YWJsZSkgewogICAgICAgICAgdGFyZ2V0W2tleV0gPSBjbG9uZURlZXBXaXRoSW1wbChzb3VyY2Vba2V5XSwga2V5LCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0Nsb25lYWJsZU9iamVjdChvYmplY3QpIHsKICAgICAgc3dpdGNoIChnZXRUYWcuZ2V0VGFnKG9iamVjdCkpIHsKICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOgogICAgICAgIGNhc2UgdGFncy5hcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuYXJyYXlCdWZmZXJUYWc6CiAgICAgICAgY2FzZSB0YWdzLmRhdGFWaWV3VGFnOgogICAgICAgIGNhc2UgdGFncy5ib29sZWFuVGFnOgogICAgICAgIGNhc2UgdGFncy5kYXRlVGFnOgogICAgICAgIGNhc2UgdGFncy5mbG9hdDMyQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmZsb2F0NjRBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuaW50OEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQxNkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQzMkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5tYXBUYWc6CiAgICAgICAgY2FzZSB0YWdzLm51bWJlclRhZzoKICAgICAgICBjYXNlIHRhZ3Mub2JqZWN0VGFnOgogICAgICAgIGNhc2UgdGFncy5yZWdleHBUYWc6CiAgICAgICAgY2FzZSB0YWdzLnNldFRhZzoKICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgIGNhc2UgdGFncy5zeW1ib2xUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50MTZBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDMyQXJyYXlUYWc6IHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGggPSBjbG9uZURlZXBXaXRoOwogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoSW1wbCA9IGNsb25lRGVlcFdpdGhJbXBsOwogICAgZXhwb3J0cy5jb3B5UHJvcGVydGllcyA9IGNvcHlQcm9wZXJ0aWVzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9vYmplY3QvY2xvbmVEZWVwLmpzCnZhciByZXF1aXJlX2Nsb25lRGVlcCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9vYmplY3QvY2xvbmVEZWVwLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjbG9uZURlZXBXaXRoID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoKCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXAob2JqKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoLmNsb25lRGVlcFdpdGhJbXBsKG9iaiwgdm9pZCAwLCBvYmosIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksIHZvaWQgMCk7CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzLmpzCnZhciByZXF1aXJlX21hdGNoZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc01hdGNoID0gcmVxdWlyZV9pc01hdGNoKCk7CiAgICB2YXIgY2xvbmVEZWVwID0gcmVxdWlyZV9jbG9uZURlZXAoKTsKICAgIGZ1bmN0aW9uIG1hdGNoZXMyKHNvdXJjZSkgewogICAgICBzb3VyY2UgPSBjbG9uZURlZXAuY2xvbmVEZWVwKHNvdXJjZSk7CiAgICAgIHJldHVybiAodGFyZ2V0KSA9PiB7CiAgICAgICAgcmV0dXJuIGlzTWF0Y2guaXNNYXRjaCh0YXJnZXQsIHNvdXJjZSk7CiAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLm1hdGNoZXMgPSBtYXRjaGVzMjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzCnZhciByZXF1aXJlX2Nsb25lRGVlcFdpdGgyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCQxID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoKCk7CiAgICB2YXIgdGFncyA9IHJlcXVpcmVfdGFncygpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aChvYmosIGN1c3RvbWl6ZXIpIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGgkMS5jbG9uZURlZXBXaXRoKG9iaiwgKHZhbHVlLCBrZXksIG9iamVjdCwgc3RhY2spID0+IHsKICAgICAgICBjb25zdCBjbG9uZWQgPSBjdXN0b21pemVyPy4odmFsdWUsIGtleSwgb2JqZWN0LCBzdGFjayk7CiAgICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gY2xvbmVkOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgIGNhc2UgdGFncy5udW1iZXJUYWc6CiAgICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgICAgY2FzZSB0YWdzLmJvb2xlYW5UYWc6IHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IG9iai5jb25zdHJ1Y3RvcihvYmo/LnZhbHVlT2YoKSk7CiAgICAgICAgICAgIGNsb25lRGVlcFdpdGgkMS5jb3B5UHJvcGVydGllcyhyZXN1bHQsIG9iaik7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOiB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgICAgICAgICBjbG9uZURlZXBXaXRoJDEuY29weVByb3BlcnRpZXMocmVzdWx0LCBvYmopOwogICAgICAgICAgICByZXN1bHQubGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0W1N5bWJvbC5pdGVyYXRvcl0gPSBvYmpbU3ltYm9sLml0ZXJhdG9yXTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoID0gY2xvbmVEZWVwV2l0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCA9IHJlcXVpcmVfY2xvbmVEZWVwV2l0aDIoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcChvYmopIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGguY2xvbmVEZWVwV2l0aChvYmopOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXAgPSBjbG9uZURlZXA7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJbmRleC5qcwp2YXIgcmVxdWlyZV9pc0luZGV4ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJbmRleC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgSVNfVU5TSUdORURfSU5URUdFUiA9IC9eKD86MHxbMS05XVxkKikkLzsKICAgIGZ1bmN0aW9uIGlzSW5kZXgodmFsdWUsIGxlbmd0aCA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIodmFsdWUpICYmIHZhbHVlID49IDAgJiYgdmFsdWUgPCBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNhc2UgInN5bWJvbCI6IHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3RyaW5nIjogewogICAgICAgICAgcmV0dXJuIElTX1VOU0lHTkVEX0lOVEVHRVIudGVzdCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzSW5kZXggPSBpc0luZGV4OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJndW1lbnRzLmpzCnZhciByZXF1aXJlX2lzQXJndW1lbnRzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldFRhZyA9IHJlcXVpcmVfZ2V0VGFnKCk7CiAgICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiBnZXRUYWcuZ2V0VGFnKHZhbHVlKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSI7CiAgICB9CiAgICBleHBvcnRzLmlzQXJndW1lbnRzID0gaXNBcmd1bWVudHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvaGFzLmpzCnZhciByZXF1aXJlX2hhcyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2hhcy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNEZWVwS2V5ID0gcmVxdWlyZV9pc0RlZXBLZXkoKTsKICAgIHZhciBpc0luZGV4ID0gcmVxdWlyZV9pc0luZGV4KCk7CiAgICB2YXIgaXNBcmd1bWVudHMgPSByZXF1aXJlX2lzQXJndW1lbnRzKCk7CiAgICB2YXIgdG9QYXRoID0gcmVxdWlyZV90b1BhdGgoKTsKICAgIGZ1bmN0aW9uIGhhczMob2JqZWN0LCBwYXRoMikgewogICAgICBsZXQgcmVzb2x2ZWRQYXRoOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShwYXRoMikpIHsKICAgICAgICByZXNvbHZlZFBhdGggPSBwYXRoMjsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGF0aDIgPT09ICJzdHJpbmciICYmIGlzRGVlcEtleS5pc0RlZXBLZXkocGF0aDIpICYmIG9iamVjdD8uW3BhdGgyXSA9PSBudWxsKSB7CiAgICAgICAgcmVzb2x2ZWRQYXRoID0gdG9QYXRoLnRvUGF0aChwYXRoMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzb2x2ZWRQYXRoID0gW3BhdGgyXTsKICAgICAgfQogICAgICBpZiAocmVzb2x2ZWRQYXRoLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBsZXQgY3VycmVudDMgPSBvYmplY3Q7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzb2x2ZWRQYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qga2V5ID0gcmVzb2x2ZWRQYXRoW2ldOwogICAgICAgIGlmIChjdXJyZW50MyA9PSBudWxsIHx8ICFPYmplY3QuaGFzT3duKGN1cnJlbnQzLCBrZXkpKSB7CiAgICAgICAgICBjb25zdCBpc1NwYXJzZUluZGV4ID0gKEFycmF5LmlzQXJyYXkoY3VycmVudDMpIHx8IGlzQXJndW1lbnRzLmlzQXJndW1lbnRzKGN1cnJlbnQzKSkgJiYgaXNJbmRleC5pc0luZGV4KGtleSkgJiYga2V5IDwgY3VycmVudDMubGVuZ3RoOwogICAgICAgICAgaWYgKCFpc1NwYXJzZUluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY3VycmVudDMgPSBjdXJyZW50M1trZXldOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZXhwb3J0cy5oYXMgPSBoYXMzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9tYXRjaGVzUHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzUHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciB0b0tleSA9IHJlcXVpcmVfdG9LZXkoKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcDIoKTsKICAgIHZhciBnZXQ1ID0gcmVxdWlyZV9nZXQoKTsKICAgIHZhciBoYXMzID0gcmVxdWlyZV9oYXMoKTsKICAgIGZ1bmN0aW9uIG1hdGNoZXNQcm9wZXJ0eShwcm9wZXJ0eSwgc291cmNlKSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BlcnR5KSB7CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgaWYgKE9iamVjdC5pcyhwcm9wZXJ0eT8udmFsdWVPZigpLCAtMCkpIHsKICAgICAgICAgICAgcHJvcGVydHkgPSAiLTAiOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm51bWJlciI6IHsKICAgICAgICAgIHByb3BlcnR5ID0gdG9LZXkudG9LZXkocHJvcGVydHkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRhcmdldCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGdldDUuZ2V0KHRhcmdldCwgcHJvcGVydHkpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIGhhczMuaGFzKHRhcmdldCwgcHJvcGVydHkpOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlID09PSB2b2lkIDApIHsKICAgICAgICAgIHJldHVybiByZXN1bHQgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzTWF0Y2guaXNNYXRjaChyZXN1bHQsIHNvdXJjZSk7CiAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLm1hdGNoZXNQcm9wZXJ0eSA9IG1hdGNoZXNQcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvaXRlcmF0ZWUuanMKdmFyIHJlcXVpcmVfaXRlcmF0ZWUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvaXRlcmF0ZWUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBwcm9wZXJ0eSA9IHJlcXVpcmVfcHJvcGVydHkoKTsKICAgIHZhciBtYXRjaGVzMiA9IHJlcXVpcmVfbWF0Y2hlcygpOwogICAgdmFyIG1hdGNoZXNQcm9wZXJ0eSA9IHJlcXVpcmVfbWF0Y2hlc1Byb3BlcnR5KCk7CiAgICBmdW5jdGlvbiBpdGVyYXRlZSh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBpZGVudGl0eTQuaWRlbnRpdHk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlc1Byb3BlcnR5Lm1hdGNoZXNQcm9wZXJ0eSh2YWx1ZVswXSwgdmFsdWVbMV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoZXMyLm1hdGNoZXModmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcmV0dXJuIHByb3BlcnR5LnByb3BlcnR5KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXRlcmF0ZWUgPSBpdGVyYXRlZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS91bmlxQnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHVuaXFCeSQxID0gcmVxdWlyZV91bmlxQnkoKTsKICAgIHZhciBpZGVudGl0eTQgPSByZXF1aXJlX2lkZW50aXR5KCk7CiAgICB2YXIgaXNBcnJheUxpa2VPYmplY3QgPSByZXF1aXJlX2lzQXJyYXlMaWtlT2JqZWN0KCk7CiAgICB2YXIgaXRlcmF0ZWUgPSByZXF1aXJlX2l0ZXJhdGVlKCk7CiAgICBmdW5jdGlvbiB1bmlxQnkyKGFycmF5LCBpdGVyYXRlZSQxID0gaWRlbnRpdHk0LmlkZW50aXR5KSB7CiAgICAgIGlmICghaXNBcnJheUxpa2VPYmplY3QuaXNBcnJheUxpa2VPYmplY3QoYXJyYXkpKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHJldHVybiB1bmlxQnkkMS51bmlxQnkoQXJyYXkuZnJvbShhcnJheSksIGl0ZXJhdGVlLml0ZXJhdGVlKGl0ZXJhdGVlJDEpKTsKICAgIH0KICAgIGV4cG9ydHMudW5pcUJ5ID0gdW5pcUJ5MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC91bmlxQnkuanMKdmFyIHJlcXVpcmVfdW5pcUJ5MyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3VuaXFCeS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdW5pcUJ5MigpLnVuaXFCeTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfc2hpbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdXNlU3luY0V4dGVybmFsU3RvcmUkMihzdWJzY3JpYmUsIGdldFNuYXBzaG90KSB7CiAgICAgICAgZGlkV2Fybk9sZDE4QWxwaGEgfHwgdm9pZCAwID09PSBSZWFjdDM5LnN0YXJ0VHJhbnNpdGlvbiB8fCAoZGlkV2Fybk9sZDE4QWxwaGEgPSB0cnVlLCBjb25zb2xlLmVycm9yKAogICAgICAgICAgIllvdSBhcmUgdXNpbmcgYW4gb3V0ZGF0ZWQsIHByZS1yZWxlYXNlIGFscGhhIG9mIFJlYWN0IDE4IHRoYXQgZG9lcyBub3Qgc3VwcG9ydCB1c2VTeW5jRXh0ZXJuYWxTdG9yZS4gVGhlIHVzZS1zeW5jLWV4dGVybmFsLXN0b3JlIHNoaW0gd2lsbCBub3Qgd29yayBjb3JyZWN0bHkuIFVwZ3JhZGUgdG8gYSBuZXdlciBwcmUtcmVsZWFzZS4iCiAgICAgICAgKSk7CiAgICAgICAgdmFyIHZhbHVlID0gZ2V0U25hcHNob3QoKTsKICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgY2FjaGVkVmFsdWUgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgb2JqZWN0SXModmFsdWUsIGNhY2hlZFZhbHVlKSB8fCAoY29uc29sZS5lcnJvcigKICAgICAgICAgICAgIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIgogICAgICAgICAgKSwgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlKTsKICAgICAgICB9CiAgICAgICAgY2FjaGVkVmFsdWUgPSB1c2VTdGF0ZTEyKHsKICAgICAgICAgIGluc3Q6IHsgdmFsdWUsIGdldFNuYXBzaG90IH0KICAgICAgICB9KTsKICAgICAgICB2YXIgaW5zdCA9IGNhY2hlZFZhbHVlWzBdLmluc3QsIGZvcmNlVXBkYXRlID0gY2FjaGVkVmFsdWVbMV07CiAgICAgICAgdXNlTGF5b3V0RWZmZWN0OSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnN0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGluc3QuZ2V0U25hcHNob3QgPSBnZXRTbmFwc2hvdDsKICAgICAgICAgICAgY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSAmJiBmb3JjZVVwZGF0ZSh7IGluc3QgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgW3N1YnNjcmliZSwgdmFsdWUsIGdldFNuYXBzaG90XQogICAgICAgICk7CiAgICAgICAgdXNlRWZmZWN0MTUoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSAmJiBmb3JjZVVwZGF0ZSh7IGluc3QgfSk7CiAgICAgICAgICAgIHJldHVybiBzdWJzY3JpYmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSAmJiBmb3JjZVVwZGF0ZSh7IGluc3QgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIFtzdWJzY3JpYmVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgewogICAgICAgIHZhciBsYXRlc3RHZXRTbmFwc2hvdCA9IGluc3QuZ2V0U25hcHNob3Q7CiAgICAgICAgaW5zdCA9IGluc3QudmFsdWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBsYXRlc3RHZXRTbmFwc2hvdCgpOwogICAgICAgICAgcmV0dXJuICFvYmplY3RJcyhpbnN0LCBuZXh0VmFsdWUpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdXNlU3luY0V4dGVybmFsU3RvcmUkMShzdWJzY3JpYmUsIGdldFNuYXBzaG90KSB7CiAgICAgICAgcmV0dXJuIGdldFNuYXBzaG90KCk7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzkgPSByZXF1aXJlX3JlYWN0KCksIG9iamVjdElzID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIE9iamVjdC5pcyA/IE9iamVjdC5pcyA6IGlzNCwgdXNlU3RhdGUxMiA9IFJlYWN0MzkudXNlU3RhdGUsIHVzZUVmZmVjdDE1ID0gUmVhY3QzOS51c2VFZmZlY3QsIHVzZUxheW91dEVmZmVjdDkgPSBSZWFjdDM5LnVzZUxheW91dEVmZmVjdCwgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM5LnVzZURlYnVnVmFsdWUsIGRpZFdhcm5PbGQxOEFscGhhID0gZmFsc2UsIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gZmFsc2UsIHNoaW0gPSAidW5kZWZpbmVkIiA9PT0gdHlwZW9mIHdpbmRvdyB8fCAidW5kZWZpbmVkIiA9PT0gdHlwZW9mIHdpbmRvdy5kb2N1bWVudCB8fCAidW5kZWZpbmVkIiA9PT0gdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ID8gdXNlU3luY0V4dGVybmFsU3RvcmUkMSA6IHVzZVN5bmNFeHRlcm5hbFN0b3JlJDI7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmUgPSB2b2lkIDAgIT09IFJlYWN0MzkudXNlU3luY0V4dGVybmFsU3RvcmUgPyBSZWFjdDM5LnVzZVN5bmNFeHRlcm5hbFN0b3JlIDogc2hpbTsKICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AoRXJyb3IoKSk7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL2luZGV4LmpzCnZhciByZXF1aXJlX3NoaW0gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3NoaW1fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpLCBzaGltID0gcmVxdWlyZV9zaGltKCksIG9iamVjdElzID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIE9iamVjdC5pcyA/IE9iamVjdC5pcyA6IGlzNCwgdXNlU3luY0V4dGVybmFsU3RvcmUyID0gc2hpbS51c2VTeW5jRXh0ZXJuYWxTdG9yZSwgdXNlUmVmMTUgPSBSZWFjdDM5LnVzZVJlZiwgdXNlRWZmZWN0MTUgPSBSZWFjdDM5LnVzZUVmZmVjdCwgdXNlTWVtbzggPSBSZWFjdDM5LnVzZU1lbW8sIHVzZURlYnVnVmFsdWUyID0gUmVhY3QzOS51c2VEZWJ1Z1ZhbHVlOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yID0gZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsKSB7CiAgICAgICAgdmFyIGluc3RSZWYgPSB1c2VSZWYxNShudWxsKTsKICAgICAgICBpZiAobnVsbCA9PT0gaW5zdFJlZi5jdXJyZW50KSB7CiAgICAgICAgICB2YXIgaW5zdCA9IHsgaGFzVmFsdWU6IGZhbHNlLCB2YWx1ZTogbnVsbCB9OwogICAgICAgICAgaW5zdFJlZi5jdXJyZW50ID0gaW5zdDsKICAgICAgICB9IGVsc2UgaW5zdCA9IGluc3RSZWYuY3VycmVudDsKICAgICAgICBpbnN0UmVmID0gdXNlTWVtbzgoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gbWVtb2l6ZWRTZWxlY3RvcihuZXh0U25hcHNob3QpIHsKICAgICAgICAgICAgICBpZiAoIWhhc01lbW8pIHsKICAgICAgICAgICAgICAgIGhhc01lbW8gPSB0cnVlOwogICAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGluc3QuaGFzVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBpbnN0LnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRTZWxlY3Rpb24gPSBtZW1vaXplZFNlbGVjdGlvbjsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMobWVtb2l6ZWRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIHZhciBuZXh0U2VsZWN0aW9uID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNlbGVjdGlvbikpCiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdCwgY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTZWxlY3Rpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc01lbW8gPSBmYWxzZSwgbWVtb2l6ZWRTbmFwc2hvdCwgbWVtb2l6ZWRTZWxlY3Rpb24sIG1heWJlR2V0U2VydmVyU25hcHNob3QgPSB2b2lkIDAgPT09IGdldFNlcnZlclNuYXBzaG90ID8gbnVsbCA6IGdldFNlcnZlclNuYXBzaG90OwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IoZ2V0U25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBudWxsID09PSBtYXliZUdldFNlcnZlclNuYXBzaG90ID8gdm9pZCAwIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihtYXliZUdldFNlcnZlclNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICAgIH0sCiAgICAgICAgICBbZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbF0KICAgICAgICApOwogICAgICAgIHZhciB2YWx1ZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGluc3RSZWZbMF0sIGluc3RSZWZbMV0pOwogICAgICAgIHVzZUVmZmVjdDE1KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QuaGFzVmFsdWUgPSB0cnVlOwogICAgICAgICAgICBpbnN0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9LAogICAgICAgICAgW3ZhbHVlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AoRXJyb3IoKSk7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL3dpdGgtc2VsZWN0b3IuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3RvciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL3dpdGgtc2VsZWN0b3IuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvY29tcGFyZVZhbHVlcy5qcwp2YXIgcmVxdWlyZV9jb21wYXJlVmFsdWVzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvY29tcGFyZVZhbHVlcy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRQcmlvcml0eShhKSB7CiAgICAgIGlmICh0eXBlb2YgYSA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiAyOwogICAgICB9CiAgICAgIGlmIChhID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gMzsKICAgICAgfQogICAgICBpZiAoYSAhPT0gYSkgewogICAgICAgIHJldHVybiA0OwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfQogICAgdmFyIGNvbXBhcmVWYWx1ZXMgPSAoYSwgYiwgb3JkZXIpID0+IHsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBjb25zdCBhUHJpb3JpdHkgPSBnZXRQcmlvcml0eShhKTsKICAgICAgICBjb25zdCBiUHJpb3JpdHkgPSBnZXRQcmlvcml0eShiKTsKICAgICAgICBpZiAoYVByaW9yaXR5ID09PSBiUHJpb3JpdHkgJiYgYVByaW9yaXR5ID09PSAwKSB7CiAgICAgICAgICBpZiAoYSA8IGIpIHsKICAgICAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyAxIDogLTE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYSA+IGIpIHsKICAgICAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyAtMSA6IDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvcmRlciA9PT0gImRlc2MiID8gYlByaW9yaXR5IC0gYVByaW9yaXR5IDogYVByaW9yaXR5IC0gYlByaW9yaXR5OwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfTsKICAgIGV4cG9ydHMuY29tcGFyZVZhbHVlcyA9IGNvbXBhcmVWYWx1ZXM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNTeW1ib2wuanMKdmFyIHJlcXVpcmVfaXNTeW1ib2wgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1N5bWJvbCh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3ltYm9sIiB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN5bWJvbDsKICAgIH0KICAgIGV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0tleS5qcwp2YXIgcmVxdWlyZV9pc0tleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzS2V5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1N5bWJvbCA9IHJlcXVpcmVfaXNTeW1ib2woKTsKICAgIHZhciByZWdleElzRGVlcFByb3AgPSAvXC58XFsoPzpbXltcXV0qfChbIiddKSg/Oig/IVwxKVteXFxdfFxcLikqP1wxKVxdLzsKICAgIHZhciByZWdleElzUGxhaW5Qcm9wID0gL15cdyokLzsKICAgIGZ1bmN0aW9uIGlzS2V5KHZhbHVlLCBvYmplY3QpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImJvb2xlYW4iIHx8IHZhbHVlID09IG51bGwgfHwgaXNTeW1ib2wuaXNTeW1ib2wodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgKHJlZ2V4SXNQbGFpblByb3AudGVzdCh2YWx1ZSkgfHwgIXJlZ2V4SXNEZWVwUHJvcC50ZXN0KHZhbHVlKSkgfHwgb2JqZWN0ICE9IG51bGwgJiYgT2JqZWN0Lmhhc093bihvYmplY3QsIHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMuaXNLZXkgPSBpc0tleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L29yZGVyQnkuanMKdmFyIHJlcXVpcmVfb3JkZXJCeSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvb3JkZXJCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IHJlcXVpcmVfY29tcGFyZVZhbHVlcygpOwogICAgdmFyIGlzS2V5ID0gcmVxdWlyZV9pc0tleSgpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBvcmRlckJ5KGNvbGxlY3Rpb24sIGNyaXRlcmlhLCBvcmRlcnMsIGd1YXJkKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uID09IG51bGwpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgb3JkZXJzID0gZ3VhcmQgPyB2b2lkIDAgOiBvcmRlcnM7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIGNvbGxlY3Rpb24gPSBPYmplY3QudmFsdWVzKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjcml0ZXJpYSkpIHsKICAgICAgICBjcml0ZXJpYSA9IGNyaXRlcmlhID09IG51bGwgPyBbbnVsbF0gOiBbY3JpdGVyaWFdOwogICAgICB9CiAgICAgIGlmIChjcml0ZXJpYS5sZW5ndGggPT09IDApIHsKICAgICAgICBjcml0ZXJpYSA9IFtudWxsXTsKICAgICAgfQogICAgICBpZiAoIUFycmF5LmlzQXJyYXkob3JkZXJzKSkgewogICAgICAgIG9yZGVycyA9IG9yZGVycyA9PSBudWxsID8gW10gOiBbb3JkZXJzXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBvcmRlcnMubWFwKChvcmRlcikgPT4gU3RyaW5nKG9yZGVyKSk7CiAgICAgIGNvbnN0IGdldFZhbHVlQnlOZXN0ZWRQYXRoID0gKG9iamVjdCwgcGF0aDIpID0+IHsKICAgICAgICBsZXQgdGFyZ2V0ID0gb2JqZWN0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aDIubGVuZ3RoICYmIHRhcmdldCAhPSBudWxsOyArK2kpIHsKICAgICAgICAgIHRhcmdldCA9IHRhcmdldFtwYXRoMltpXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH07CiAgICAgIGNvbnN0IGdldFZhbHVlQnlDcml0ZXJpb24gPSAoY3JpdGVyaW9uLCBvYmplY3QpID0+IHsKICAgICAgICBpZiAob2JqZWN0ID09IG51bGwgfHwgY3JpdGVyaW9uID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY3JpdGVyaW9uID09PSAib2JqZWN0IiAmJiAia2V5IiBpbiBjcml0ZXJpb24pIHsKICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duKG9iamVjdCwgY3JpdGVyaW9uLmtleSkpIHsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdFtjcml0ZXJpb24ua2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRWYWx1ZUJ5TmVzdGVkUGF0aChvYmplY3QsIGNyaXRlcmlvbi5wYXRoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJldHVybiBjcml0ZXJpb24ob2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSkgewogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH07CiAgICAgIGNvbnN0IHByZXBhcmVkQ3JpdGVyaWEgPSBjcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNyaXRlcmlvbikgJiYgY3JpdGVyaW9uLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY3JpdGVyaW9uID0gY3JpdGVyaW9uWzBdOwogICAgICAgIH0KICAgICAgICBpZiAoY3JpdGVyaW9uID09IG51bGwgfHwgdHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIiB8fCBBcnJheS5pc0FycmF5KGNyaXRlcmlvbikgfHwgaXNLZXkuaXNLZXkoY3JpdGVyaW9uKSkgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsga2V5OiBjcml0ZXJpb24sIHBhdGg6IHRvUGF0aC50b1BhdGgoY3JpdGVyaW9uKSB9OwogICAgICB9KTsKICAgICAgY29uc3QgcHJlcGFyZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5tYXAoKGl0ZW0pID0+ICh7CiAgICAgICAgb3JpZ2luYWw6IGl0ZW0sCiAgICAgICAgY3JpdGVyaWE6IHByZXBhcmVkQ3JpdGVyaWEubWFwKChjcml0ZXJpb24pID0+IGdldFZhbHVlQnlDcml0ZXJpb24oY3JpdGVyaW9uLCBpdGVtKSkKICAgICAgfSkpOwogICAgICByZXR1cm4gcHJlcGFyZWRDb2xsZWN0aW9uLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJlcGFyZWRDcml0ZXJpYS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgY29tcGFyZWRSZXN1bHQgPSBjb21wYXJlVmFsdWVzLmNvbXBhcmVWYWx1ZXMoYS5jcml0ZXJpYVtpXSwgYi5jcml0ZXJpYVtpXSwgb3JkZXJzW2ldKTsKICAgICAgICAgIGlmIChjb21wYXJlZFJlc3VsdCAhPT0gMCkgewogICAgICAgICAgICByZXR1cm4gY29tcGFyZWRSZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9KS5tYXAoKGl0ZW0pID0+IGl0ZW0ub3JpZ2luYWwpOwogICAgfQogICAgZXhwb3J0cy5vcmRlckJ5ID0gb3JkZXJCeTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvZmxhdHRlbi5qcwp2YXIgcmVxdWlyZV9mbGF0dGVuID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZmxhdHRlbihhcnIsIGRlcHRoID0gMSkgewogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgZmxvb3JlZERlcHRoID0gTWF0aC5mbG9vcihkZXB0aCk7CiAgICAgIGNvbnN0IHJlY3Vyc2l2ZSA9IChhcnIyLCBjdXJyZW50RGVwdGgpID0+IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycjIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBhcnIyW2ldOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgJiYgY3VycmVudERlcHRoIDwgZmxvb3JlZERlcHRoKSB7CiAgICAgICAgICAgIHJlY3Vyc2l2ZShpdGVtLCBjdXJyZW50RGVwdGggKyAxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmVjdXJzaXZlKGFyciwgMCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmZsYXR0ZW4gPSBmbGF0dGVuOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzSXRlcmF0ZWVDYWxsLmpzCnZhciByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJdGVyYXRlZUNhbGwuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzSW5kZXggPSByZXF1aXJlX2lzSW5kZXgoKTsKICAgIHZhciBpc0FycmF5TGlrZSA9IHJlcXVpcmVfaXNBcnJheUxpa2UoKTsKICAgIHZhciBpc09iamVjdCA9IHJlcXVpcmVfaXNPYmplY3QoKTsKICAgIHZhciBlcSA9IHJlcXVpcmVfZXEoKTsKICAgIGZ1bmN0aW9uIGlzSXRlcmF0ZWVDYWxsKHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgIGlmICghaXNPYmplY3QuaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAibnVtYmVyIiAmJiBpc0FycmF5TGlrZS5pc0FycmF5TGlrZShvYmplY3QpICYmIGlzSW5kZXguaXNJbmRleChpbmRleCkgJiYgaW5kZXggPCBvYmplY3QubGVuZ3RoIHx8IHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgJiYgaW5kZXggaW4gb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGVxLmVxKG9iamVjdFtpbmRleF0sIHZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzSXRlcmF0ZWVDYWxsID0gaXNJdGVyYXRlZUNhbGw7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9zb3J0QnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIG9yZGVyQnkgPSByZXF1aXJlX29yZGVyQnkoKTsKICAgIHZhciBmbGF0dGVuID0gcmVxdWlyZV9mbGF0dGVuKCk7CiAgICB2YXIgaXNJdGVyYXRlZUNhbGwgPSByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsKCk7CiAgICBmdW5jdGlvbiBzb3J0Qnk1KGNvbGxlY3Rpb24sIC4uLmNyaXRlcmlhKSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IGNyaXRlcmlhLmxlbmd0aDsKICAgICAgaWYgKGxlbmd0aCA+IDEgJiYgaXNJdGVyYXRlZUNhbGwuaXNJdGVyYXRlZUNhbGwoY29sbGVjdGlvbiwgY3JpdGVyaWFbMF0sIGNyaXRlcmlhWzFdKSkgewogICAgICAgIGNyaXRlcmlhID0gW107CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID4gMiAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0sIGNyaXRlcmlhWzJdKSkgewogICAgICAgIGNyaXRlcmlhID0gW2NyaXRlcmlhWzBdXTsKICAgICAgfQogICAgICByZXR1cm4gb3JkZXJCeS5vcmRlckJ5KGNvbGxlY3Rpb24sIGZsYXR0ZW4uZmxhdHRlbihjcml0ZXJpYSksIFsiYXNjIl0pOwogICAgfQogICAgZXhwb3J0cy5zb3J0QnkgPSBzb3J0Qnk1OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3NvcnRCeS5qcwp2YXIgcmVxdWlyZV9zb3J0QnkyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9zb3J0QnkoKS5zb3J0Qnk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2RlYm91bmNlLmpzCnZhciByZXF1aXJlX2RlYm91bmNlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2RlYm91bmNlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGRlYm91bmNlKGZ1bmMsIGRlYm91bmNlTXMsIHsgc2lnbmFsLCBlZGdlcyB9ID0ge30pIHsKICAgICAgbGV0IHBlbmRpbmdUaGlzID0gdm9pZCAwOwogICAgICBsZXQgcGVuZGluZ0FyZ3MgPSBudWxsOwogICAgICBjb25zdCBsZWFkaW5nID0gZWRnZXMgIT0gbnVsbCAmJiBlZGdlcy5pbmNsdWRlcygibGVhZGluZyIpOwogICAgICBjb25zdCB0cmFpbGluZyA9IGVkZ2VzID09IG51bGwgfHwgZWRnZXMuaW5jbHVkZXMoInRyYWlsaW5nIik7CiAgICAgIGNvbnN0IGludm9rZSA9ICgpID0+IHsKICAgICAgICBpZiAocGVuZGluZ0FyZ3MgIT09IG51bGwpIHsKICAgICAgICAgIGZ1bmMuYXBwbHkocGVuZGluZ1RoaXMsIHBlbmRpbmdBcmdzKTsKICAgICAgICAgIHBlbmRpbmdUaGlzID0gdm9pZCAwOwogICAgICAgICAgcGVuZGluZ0FyZ3MgPSBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3Qgb25UaW1lckVuZCA9ICgpID0+IHsKICAgICAgICBpZiAodHJhaWxpbmcpIHsKICAgICAgICAgIGludm9rZSgpOwogICAgICAgIH0KICAgICAgICBjYW5jZWwoKTsKICAgICAgfTsKICAgICAgbGV0IHRpbWVvdXRJZCA9IG51bGw7CiAgICAgIGNvbnN0IHNjaGVkdWxlID0gKCkgPT4gewogICAgICAgIGlmICh0aW1lb3V0SWQgIT0gbnVsbCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgfQogICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgICAgIG9uVGltZXJFbmQoKTsKICAgICAgICB9LCBkZWJvdW5jZU1zKTsKICAgICAgfTsKICAgICAgY29uc3QgY2FuY2VsVGltZXIgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRpbWVvdXRJZCAhPT0gbnVsbCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgY2FuY2VsID0gKCkgPT4gewogICAgICAgIGNhbmNlbFRpbWVyKCk7CiAgICAgICAgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgICAgcGVuZGluZ0FyZ3MgPSBudWxsOwogICAgICB9OwogICAgICBjb25zdCBmbHVzaCA9ICgpID0+IHsKICAgICAgICBpbnZva2UoKTsKICAgICAgfTsKICAgICAgY29uc3QgZGVib3VuY2VkID0gZnVuY3Rpb24oLi4uYXJncykgewogICAgICAgIGlmIChzaWduYWw/LmFib3J0ZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcGVuZGluZ1RoaXMgPSB0aGlzOwogICAgICAgIHBlbmRpbmdBcmdzID0gYXJnczsKICAgICAgICBjb25zdCBpc0ZpcnN0Q2FsbCA9IHRpbWVvdXRJZCA9PSBudWxsOwogICAgICAgIHNjaGVkdWxlKCk7CiAgICAgICAgaWYgKGxlYWRpbmcgJiYgaXNGaXJzdENhbGwpIHsKICAgICAgICAgIGludm9rZSgpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZGVib3VuY2VkLnNjaGVkdWxlID0gc2NoZWR1bGU7CiAgICAgIGRlYm91bmNlZC5jYW5jZWwgPSBjYW5jZWw7CiAgICAgIGRlYm91bmNlZC5mbHVzaCA9IGZsdXNoOwogICAgICBzaWduYWw/LmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgY2FuY2VsLCB7IG9uY2U6IHRydWUgfSk7CiAgICAgIHJldHVybiBkZWJvdW5jZWQ7CiAgICB9CiAgICBleHBvcnRzLmRlYm91bmNlID0gZGVib3VuY2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi9kZWJvdW5jZS5qcwp2YXIgcmVxdWlyZV9kZWJvdW5jZTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL2RlYm91bmNlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBkZWJvdW5jZSQxID0gcmVxdWlyZV9kZWJvdW5jZSgpOwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgZGVib3VuY2VNcyA9IDAsIG9wdGlvbnMgPSB7fSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CiAgICAgIGNvbnN0IHsgbGVhZGluZyA9IGZhbHNlLCB0cmFpbGluZyA9IHRydWUsIG1heFdhaXQgfSA9IG9wdGlvbnM7CiAgICAgIGNvbnN0IGVkZ2VzID0gQXJyYXkoMik7CiAgICAgIGlmIChsZWFkaW5nKSB7CiAgICAgICAgZWRnZXNbMF0gPSAibGVhZGluZyI7CiAgICAgIH0KICAgICAgaWYgKHRyYWlsaW5nKSB7CiAgICAgICAgZWRnZXNbMV0gPSAidHJhaWxpbmciOwogICAgICB9CiAgICAgIGxldCByZXN1bHQgPSB2b2lkIDA7CiAgICAgIGxldCBwZW5kaW5nQXQgPSBudWxsOwogICAgICBjb25zdCBfZGVib3VuY2VkID0gZGVib3VuY2UkMS5kZWJvdW5jZShmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICBwZW5kaW5nQXQgPSBudWxsOwogICAgICB9LCBkZWJvdW5jZU1zLCB7IGVkZ2VzIH0pOwogICAgICBjb25zdCBkZWJvdW5jZWQgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgaWYgKG1heFdhaXQgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHBlbmRpbmdBdCA9PT0gbnVsbCkgewogICAgICAgICAgICBwZW5kaW5nQXQgPSBEYXRlLm5vdygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKERhdGUubm93KCkgLSBwZW5kaW5nQXQgPj0gbWF4V2FpdCkgewogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICBwZW5kaW5nQXQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBfZGVib3VuY2VkLmNhbmNlbCgpOwogICAgICAgICAgICBfZGVib3VuY2VkLnNjaGVkdWxlKCk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIF9kZWJvdW5jZWQuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgY29uc3QgZmx1c2ggPSAoKSA9PiB7CiAgICAgICAgX2RlYm91bmNlZC5mbHVzaCgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlYm91bmNlZC5jYW5jZWwgPSBfZGVib3VuY2VkLmNhbmNlbDsKICAgICAgZGVib3VuY2VkLmZsdXNoID0gZmx1c2g7CiAgICAgIHJldHVybiBkZWJvdW5jZWQ7CiAgICB9CiAgICBleHBvcnRzLmRlYm91bmNlID0gZGVib3VuY2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi90aHJvdHRsZS5qcwp2YXIgcmVxdWlyZV90aHJvdHRsZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlID0gcmVxdWlyZV9kZWJvdW5jZTIoKTsKICAgIGZ1bmN0aW9uIHRocm90dGxlMihmdW5jLCB0aHJvdHRsZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGNvbnN0IHsgbGVhZGluZyA9IHRydWUsIHRyYWlsaW5nID0gdHJ1ZSB9ID0gb3B0aW9uczsKICAgICAgcmV0dXJuIGRlYm91bmNlLmRlYm91bmNlKGZ1bmMsIHRocm90dGxlTXMsIHsKICAgICAgICBsZWFkaW5nLAogICAgICAgIG1heFdhaXQ6IHRocm90dGxlTXMsCiAgICAgICAgdHJhaWxpbmcKICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLnRocm90dGxlID0gdGhyb3R0bGUyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3Rocm90dGxlLmpzCnZhciByZXF1aXJlX3Rocm90dGxlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3Rocm90dGxlLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV90aHJvdHRsZSgpLnRocm90dGxlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b051bWJlci5qcwp2YXIgcmVxdWlyZV90b051bWJlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b051bWJlci5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNTeW1ib2wgPSByZXF1aXJlX2lzU3ltYm9sKCk7CiAgICBmdW5jdGlvbiB0b051bWJlcih2YWx1ZSkgewogICAgICBpZiAoaXNTeW1ib2wuaXNTeW1ib2wodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE5hTjsKICAgICAgfQogICAgICByZXR1cm4gTnVtYmVyKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9OdW1iZXIgPSB0b051bWJlcjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9GaW5pdGUuanMKdmFyIHJlcXVpcmVfdG9GaW5pdGUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9GaW5pdGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHRvTnVtYmVyID0gcmVxdWlyZV90b051bWJlcigpOwogICAgZnVuY3Rpb24gdG9GaW5pdGUodmFsdWUpIHsKICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gMCA/IHZhbHVlIDogMDsKICAgICAgfQogICAgICB2YWx1ZSA9IHRvTnVtYmVyLnRvTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSB8fCB2YWx1ZSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgY29uc3Qgc2lnbjIgPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgICAgcmV0dXJuIHNpZ24yICogTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQogICAgZXhwb3J0cy50b0Zpbml0ZSA9IHRvRmluaXRlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcwp2YXIgcmVxdWlyZV9yYW5nZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNJdGVyYXRlZUNhbGwgPSByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsKCk7CiAgICB2YXIgdG9GaW5pdGUgPSByZXF1aXJlX3RvRmluaXRlKCk7CiAgICBmdW5jdGlvbiByYW5nZTQoc3RhcnQsIGVuZCwgc3RlcCkgewogICAgICBpZiAoc3RlcCAmJiB0eXBlb2Ygc3RlcCAhPT0gIm51bWJlciIgJiYgaXNJdGVyYXRlZUNhbGwuaXNJdGVyYXRlZUNhbGwoc3RhcnQsIGVuZCwgc3RlcCkpIHsKICAgICAgICBlbmQgPSBzdGVwID0gdm9pZCAwOwogICAgICB9CiAgICAgIHN0YXJ0ID0gdG9GaW5pdGUudG9GaW5pdGUoc3RhcnQpOwogICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICBzdGFydCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5kID0gdG9GaW5pdGUudG9GaW5pdGUoZW5kKTsKICAgICAgfQogICAgICBzdGVwID0gc3RlcCA9PT0gdm9pZCAwID8gc3RhcnQgPCBlbmQgPyAxIDogLTEgOiB0b0Zpbml0ZS50b0Zpbml0ZShzdGVwKTsKICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChlbmQgLSBzdGFydCkgLyAoc3RlcCB8fCAxKSksIDApOwogICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBzdGFydDsKICAgICAgICBzdGFydCArPSBzdGVwOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnJhbmdlID0gcmFuZ2U0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yYW5nZSgpLnJhbmdlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZGVjaW1hbC5qcy1saWdodEAyLjUuMS9ub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzCnZhciByZXF1aXJlX2RlY2ltYWwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2RlY2ltYWwuanMtbGlnaHRAMi41LjEvbm9kZV9tb2R1bGVzL2RlY2ltYWwuanMtbGlnaHQvZGVjaW1hbC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAoZnVuY3Rpb24oZ2xvYmFsU2NvcGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgTUFYX0RJR0lUUyA9IDFlOSwgRGVjaW1hbDMgPSB7CiAgICAgICAgLy8gVGhlc2UgdmFsdWVzIG11c3QgYmUgaW50ZWdlcnMgd2l0aGluIHRoZSBzdGF0ZWQgcmFuZ2VzIChpbmNsdXNpdmUpLgogICAgICAgIC8vIE1vc3Qgb2YgdGhlc2UgdmFsdWVzIGNhbiBiZSBjaGFuZ2VkIGR1cmluZyBydW4tdGltZSB1c2luZyBgRGVjaW1hbC5jb25maWdgLgogICAgICAgIC8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBzaWduaWZpY2FudCBkaWdpdHMgb2YgdGhlIHJlc3VsdCBvZiBhIGNhbGN1bGF0aW9uIG9yIGJhc2UgY29udmVyc2lvbi4KICAgICAgICAvLyBFLmcuIGBEZWNpbWFsLmNvbmZpZyh7IHByZWNpc2lvbjogMjAgfSk7YAogICAgICAgIHByZWNpc2lvbjogMjAsCiAgICAgICAgLy8gMSB0byBNQVhfRElHSVRTCiAgICAgICAgLy8gVGhlIHJvdW5kaW5nIG1vZGUgdXNlZCBieSBkZWZhdWx0IGJ5IGB0b0ludGVnZXJgLCBgdG9EZWNpbWFsUGxhY2VzYCwgYHRvRXhwb25lbnRpYWxgLAogICAgICAgIC8vIGB0b0ZpeGVkYCwgYHRvUHJlY2lzaW9uYCBhbmQgYHRvU2lnbmlmaWNhbnREaWdpdHNgLgogICAgICAgIC8vCiAgICAgICAgLy8gUk9VTkRfVVAgICAgICAgICAwIEF3YXkgZnJvbSB6ZXJvLgogICAgICAgIC8vIFJPVU5EX0RPV04gICAgICAgMSBUb3dhcmRzIHplcm8uCiAgICAgICAgLy8gUk9VTkRfQ0VJTCAgICAgICAyIFRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0ZMT09SICAgICAgMyBUb3dhcmRzIC1JbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX1VQICAgIDQgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHVwLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRE9XTiAgNSBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgZG93bi4KICAgICAgICAvLyBST1VORF9IQUxGX0VWRU4gIDYgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgZXZlbiBuZWlnaGJvdXIuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9DRUlMICA3IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCB0b3dhcmRzICtJbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX0ZMT09SIDggVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vCiAgICAgICAgLy8gRS5nLgogICAgICAgIC8vIGBEZWNpbWFsLnJvdW5kaW5nID0gNDtgCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSBEZWNpbWFsLlJPVU5EX0hBTEZfVVA7YAogICAgICAgIHJvdW5kaW5nOiA0LAogICAgICAgIC8vIDAgdG8gOAogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYmVuZWF0aCB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAtNwogICAgICAgIHRvRXhwTmVnOiAtNywKICAgICAgICAvLyAwIHRvIC1NQVhfRQogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYWJvdmUgd2hpY2ggYHRvU3RyaW5nYCByZXR1cm5zIGV4cG9uZW50aWFsIG5vdGF0aW9uLgogICAgICAgIC8vIEphdmFTY3JpcHQgbnVtYmVyczogMjEKICAgICAgICB0b0V4cFBvczogMjEsCiAgICAgICAgLy8gMCB0byBNQVhfRQogICAgICAgIC8vIFRoZSBuYXR1cmFsIGxvZ2FyaXRobSBvZiAxMC4KICAgICAgICAvLyAxMTUgZGlnaXRzCiAgICAgICAgTE4xMDogIjIuMzAyNTg1MDkyOTk0MDQ1Njg0MDE3OTkxNDU0Njg0MzY0MjA3NjAxMTAxNDg4NjI4NzcyOTc2MDMzMzI3OTAwOTY3NTcyNjA5Njc3MzUyNDgwMjM1OTk3MjA1MDg5NTk4Mjk4MzQxOTY3Nzg0MDQyMjg2IgogICAgICB9LCBleHRlcm5hbCA9IHRydWUsIGRlY2ltYWxFcnJvciA9ICJbRGVjaW1hbEVycm9yXSAiLCBpbnZhbGlkQXJndW1lbnQgPSBkZWNpbWFsRXJyb3IgKyAiSW52YWxpZCBhcmd1bWVudDogIiwgZXhwb25lbnRPdXRPZlJhbmdlID0gZGVjaW1hbEVycm9yICsgIkV4cG9uZW50IG91dCBvZiByYW5nZTogIiwgbWF0aGZsb29yID0gTWF0aC5mbG9vciwgbWF0aHBvdyA9IE1hdGgucG93LCBpc0RlY2ltYWwgPSAvXihcZCsoXC5cZCopP3xcLlxkKykoZVsrLV0/XGQrKT8kL2ksIE9ORSwgQkFTRSA9IDFlNywgTE9HX0JBU0UgPSA3LCBNQVhfU0FGRV9JTlRFR0VSID0gOTAwNzE5OTI1NDc0MDk5MSwgTUFYX0UgPSBtYXRoZmxvb3IoTUFYX1NBRkVfSU5URUdFUiAvIExPR19CQVNFKSwgUCA9IHt9OwogICAgICBQLmFic29sdXRlVmFsdWUgPSBQLmFicyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMpOwogICAgICAgIGlmICh4Mi5zKSB4Mi5zID0gMTsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAuY29tcGFyZWRUbyA9IFAuY21wID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgaSwgaiwgeGRMLCB5ZEwsIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgaWYgKHgyLnMgIT09IHkyLnMpIHJldHVybiB4Mi5zIHx8IC15Mi5zOwogICAgICAgIGlmICh4Mi5lICE9PSB5Mi5lKSByZXR1cm4geDIuZSA+IHkyLmUgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB4ZEwgPSB4Mi5kLmxlbmd0aDsKICAgICAgICB5ZEwgPSB5Mi5kLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwLCBqID0geGRMIDwgeWRMID8geGRMIDogeWRMOyBpIDwgajsgKytpKSB7CiAgICAgICAgICBpZiAoeDIuZFtpXSAhPT0geTIuZFtpXSkgcmV0dXJuIHgyLmRbaV0gPiB5Mi5kW2ldIF4geDIucyA8IDAgPyAxIDogLTE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB4ZEwgPT09IHlkTCA/IDAgOiB4ZEwgPiB5ZEwgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgfTsKICAgICAgUC5kZWNpbWFsUGxhY2VzID0gUC5kcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIHcgPSB4Mi5kLmxlbmd0aCAtIDEsIGRwID0gKHcgLSB4Mi5lKSAqIExPR19CQVNFOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIGRwLS07CiAgICAgICAgcmV0dXJuIGRwIDwgMCA/IDAgOiBkcDsKICAgICAgfTsKICAgICAgUC5kaXZpZGVkQnkgPSBQLmRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIGRpdmlkZSh0aGlzLCBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih5MikpOwogICAgICB9OwogICAgICBQLmRpdmlkZWRUb0ludGVnZXJCeSA9IFAuaWRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChkaXZpZGUoeDIsIG5ldyBDdG9yKHkyKSwgMCwgMSksIEN0b3IucHJlY2lzaW9uKTsKICAgICAgfTsKICAgICAgUC5lcXVhbHMgPSBQLmVxID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gIXRoaXMuY21wKHkyKTsKICAgICAgfTsKICAgICAgUC5leHBvbmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRCYXNlMTBFeHBvbmVudCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5ncmVhdGVyVGhhbiA9IFAuZ3QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPiAwOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuT3JFcXVhbFRvID0gUC5ndGUgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPj0gMDsKICAgICAgfTsKICAgICAgUC5pc0ludGVnZXIgPSBQLmlzaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZSA+IHRoaXMuZC5sZW5ndGggLSAyOwogICAgICB9OwogICAgICBQLmlzTmVnYXRpdmUgPSBQLmlzbmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucyA8IDA7CiAgICAgIH07CiAgICAgIFAuaXNQb3NpdGl2ZSA9IFAuaXNwb3MgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID4gMDsKICAgICAgfTsKICAgICAgUC5pc1plcm8gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID09PSAwOwogICAgICB9OwogICAgICBQLmxlc3NUaGFuID0gUC5sdCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW5PckVxdWFsVG8gPSBQLmx0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDE7CiAgICAgIH07CiAgICAgIFAubG9nYXJpdGhtID0gUC5sb2cgPSBmdW5jdGlvbihiYXNlKSB7CiAgICAgICAgdmFyIHIyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbiwgd3ByID0gcHIgKyA1OwogICAgICAgIGlmIChiYXNlID09PSB2b2lkIDApIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcigxMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcihiYXNlKTsKICAgICAgICAgIGlmIChiYXNlLnMgPCAxIHx8IGJhc2UuZXEoT05FKSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0KICAgICAgICBpZiAoeDIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4Mi5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4Mi5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICByMiA9IGRpdmlkZShsbih4Miwgd3ByKSwgbG4oYmFzZSwgd3ByKSwgd3ByKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJvdW5kKHIyLCBwcik7CiAgICAgIH07CiAgICAgIFAubWludXMgPSBQLnN1YiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IHN1YnRyYWN0KHgyLCB5MikgOiBhZGQoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAubW9kdWxvID0gUC5tb2QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBxLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICB5MiA9IG5ldyBDdG9yKHkyKTsKICAgICAgICBpZiAoIXkyLnMpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICBpZiAoIXgyLnMpIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHByKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHEgPSBkaXZpZGUoeDIsIHkyLCAwLCAxKS50aW1lcyh5Mik7CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiB4Mi5taW51cyhxKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsRXhwb25lbnRpYWwgPSBQLmV4cCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBleHAodGhpcyk7CiAgICAgIH07CiAgICAgIFAubmF0dXJhbExvZ2FyaXRobSA9IFAubG4gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbG4odGhpcyk7CiAgICAgIH07CiAgICAgIFAubmVnYXRlZCA9IFAubmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgeDIucyA9IC14Mi5zIHx8IDA7CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9OwogICAgICBQLnBsdXMgPSBQLmFkZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IGFkZCh4MiwgeTIpIDogc3VidHJhY3QoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAucHJlY2lzaW9uID0gUC5zZCA9IGZ1bmN0aW9uKHopIHsKICAgICAgICB2YXIgZSwgc2QsIHcsIHgyID0gdGhpczsKICAgICAgICBpZiAoeiAhPT0gdm9pZCAwICYmIHogIT09ICEheiAmJiB6ICE9PSAxICYmIHogIT09IDApIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHopOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxOwogICAgICAgIHcgPSB4Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgc2QgPSB3ICogTE9HX0JBU0UgKyAxOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSB7CiAgICAgICAgICBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIHNkLS07CiAgICAgICAgICBmb3IgKHcgPSB4Mi5kWzBdOyB3ID49IDEwOyB3IC89IDEwKSBzZCsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4geiAmJiBlID4gc2QgPyBlIDogc2Q7CiAgICAgIH07CiAgICAgIFAuc3F1YXJlUm9vdCA9IFAuc3FydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlLCBuLCBwciwgcjIsIHMsIHQsIHdwciwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHgyLnMgPCAxKSB7CiAgICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICB9CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHMgPSBNYXRoLnNxcnQoK3gyKTsKICAgICAgICBpZiAocyA9PSAwIHx8IHMgPT0gMSAvIDApIHsKICAgICAgICAgIG4gPSBkaWdpdHNUb1N0cmluZyh4Mi5kKTsKICAgICAgICAgIGlmICgobi5sZW5ndGggKyBlKSAlIDIgPT0gMCkgbiArPSAiMCI7CiAgICAgICAgICBzID0gTWF0aC5zcXJ0KG4pOwogICAgICAgICAgZSA9IG1hdGhmbG9vcigoZSArIDEpIC8gMikgLSAoZSA8IDAgfHwgZSAlIDIpOwogICAgICAgICAgaWYgKHMgPT0gMSAvIDApIHsKICAgICAgICAgICAgbiA9ICI1ZSIgKyBlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbiA9IHMudG9FeHBvbmVudGlhbCgpOwogICAgICAgICAgICBuID0gbi5zbGljZSgwLCBuLmluZGV4T2YoImUiKSArIDEpICsgZTsKICAgICAgICAgIH0KICAgICAgICAgIHIyID0gbmV3IEN0b3Iobik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHIyID0gbmV3IEN0b3Iocy50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBzID0gd3ByID0gcHIgKyAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgdCA9IHIyOwogICAgICAgICAgcjIgPSB0LnBsdXMoZGl2aWRlKHgyLCB0LCB3cHIgKyAyKSkudGltZXMoMC41KTsKICAgICAgICAgIGlmIChkaWdpdHNUb1N0cmluZyh0LmQpLnNsaWNlKDAsIHdwcikgPT09IChuID0gZGlnaXRzVG9TdHJpbmcocjIuZCkpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgbiA9IG4uc2xpY2Uod3ByIC0gMywgd3ByICsgMSk7CiAgICAgICAgICAgIGlmIChzID09IHdwciAmJiBuID09ICI0OTk5IikgewogICAgICAgICAgICAgIHJvdW5kKHQsIHByICsgMSwgMCk7CiAgICAgICAgICAgICAgaWYgKHQudGltZXModCkuZXEoeDIpKSB7CiAgICAgICAgICAgICAgICByMiA9IHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobiAhPSAiOTk5OSIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cHIgKz0gNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiByb3VuZChyMiwgcHIpOwogICAgICB9OwogICAgICBQLnRpbWVzID0gUC5tdWwgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBjYXJyeSwgZSwgaSwgaywgcjIsIHJMLCB0LCB4ZEwsIHlkTCwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHhkID0geDIuZCwgeWQgPSAoeTIgPSBuZXcgQ3Rvcih5MikpLmQ7CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgeTIucyAqPSB4Mi5zOwogICAgICAgIGUgPSB4Mi5lICsgeTIuZTsKICAgICAgICB4ZEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgeWRMID0geWQubGVuZ3RoOwogICAgICAgIGlmICh4ZEwgPCB5ZEwpIHsKICAgICAgICAgIHIyID0geGQ7CiAgICAgICAgICB4ZCA9IHlkOwogICAgICAgICAgeWQgPSByMjsKICAgICAgICAgIHJMID0geGRMOwogICAgICAgICAgeGRMID0geWRMOwogICAgICAgICAgeWRMID0gckw7CiAgICAgICAgfQogICAgICAgIHIyID0gW107CiAgICAgICAgckwgPSB4ZEwgKyB5ZEw7CiAgICAgICAgZm9yIChpID0gckw7IGktLTsgKSByMi5wdXNoKDApOwogICAgICAgIGZvciAoaSA9IHlkTDsgLS1pID49IDA7ICkgewogICAgICAgICAgY2FycnkgPSAwOwogICAgICAgICAgZm9yIChrID0geGRMICsgaTsgayA+IGk7ICkgewogICAgICAgICAgICB0ID0gcjJba10gKyB5ZFtpXSAqIHhkW2sgLSBpIC0gMV0gKyBjYXJyeTsKICAgICAgICAgICAgcjJbay0tXSA9IHQgJSBCQVNFIHwgMDsKICAgICAgICAgICAgY2FycnkgPSB0IC8gQkFTRSB8IDA7CiAgICAgICAgICB9CiAgICAgICAgICByMltrXSA9IChyMltrXSArIGNhcnJ5KSAlIEJBU0UgfCAwOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgIXIyWy0tckxdOyApIHIyLnBvcCgpOwogICAgICAgIGlmIChjYXJyeSkgKytlOwogICAgICAgIGVsc2UgcjIuc2hpZnQoKTsKICAgICAgICB5Mi5kID0gcjI7CiAgICAgICAgeTIuZSA9IGU7CiAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIEN0b3IucHJlY2lzaW9uKSA6IHkyOwogICAgICB9OwogICAgICBQLnRvRGVjaW1hbFBsYWNlcyA9IFAudG9kcCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICB4MiA9IG5ldyBDdG9yKHgyKTsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHgyOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICByZXR1cm4gcm91bmQoeDIsIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICB9OwogICAgICBQLnRvRXhwb25lbnRpYWwgPSBmdW5jdGlvbihkcCwgcm0pIHsKICAgICAgICB2YXIgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgewogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgMSwgcm0pOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUsIGRwICsgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9GaXhlZCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHkyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHRvU3RyaW5nKHgyKTsKICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgeTIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICAgIHN0ciA9IHRvU3RyaW5nKHkyLmFicygpLCBmYWxzZSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh5MikgKyAxKTsKICAgICAgICByZXR1cm4geDIuaXNuZWcoKSAmJiAheDIuaXNaZXJvKCkgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9JbnRlZ2VyID0gUC50b2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICByZXR1cm4gcm91bmQobmV3IEN0b3IoeDIpLCBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBDdG9yLnJvdW5kaW5nKTsKICAgICAgfTsKICAgICAgUC50b051bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiArdGhpczsKICAgICAgfTsKICAgICAgUC50b1Bvd2VyID0gUC5wb3cgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBlLCBrLCBwciwgcjIsIHNpZ24yLCB5SXNJbnQsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBndWFyZCA9IDEyLCB5biA9ICsoeTIgPSBuZXcgQ3Rvcih5MikpOwogICAgICAgIGlmICgheTIucykgcmV0dXJuIG5ldyBDdG9yKE9ORSk7CiAgICAgICAgeDIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgaWYgKCF4Mi5zKSB7CiAgICAgICAgICBpZiAoeTIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJJbmZpbml0eSIpOwogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoeDIuZXEoT05FKSkgcmV0dXJuIHgyOwogICAgICAgIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKHkyLmVxKE9ORSkpIHJldHVybiByb3VuZCh4MiwgcHIpOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIGsgPSB5Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgeUlzSW50ID0gZSA+PSBrOwogICAgICAgIHNpZ24yID0geDIuczsKICAgICAgICBpZiAoIXlJc0ludCkgewogICAgICAgICAgaWYgKHNpZ24yIDwgMCkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0gZWxzZSBpZiAoKGsgPSB5biA8IDAgPyAteW4gOiB5bikgPD0gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihPTkUpOwogICAgICAgICAgZSA9IE1hdGguY2VpbChwciAvIExPR19CQVNFICsgNCk7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgIGlmIChrICUgMikgewogICAgICAgICAgICAgIHIyID0gcjIudGltZXMoeDIpOwogICAgICAgICAgICAgIHRydW5jYXRlKHIyLmQsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGsgPSBtYXRoZmxvb3IoayAvIDIpOwogICAgICAgICAgICBpZiAoayA9PT0gMCkgYnJlYWs7CiAgICAgICAgICAgIHgyID0geDIudGltZXMoeDIpOwogICAgICAgICAgICB0cnVuY2F0ZSh4Mi5kLCBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB5Mi5zIDwgMCA/IG5ldyBDdG9yKE9ORSkuZGl2KHIyKSA6IHJvdW5kKHIyLCBwcik7CiAgICAgICAgfQogICAgICAgIHNpZ24yID0gc2lnbjIgPCAwICYmIHkyLmRbTWF0aC5tYXgoZSwgayldICYgMSA/IC0xIDogMTsKICAgICAgICB4Mi5zID0gMTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0geTIudGltZXMobG4oeDIsIHByICsgZ3VhcmQpKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcjIgPSBleHAocjIpOwogICAgICAgIHIyLnMgPSBzaWduMjsKICAgICAgICByZXR1cm4gcjI7CiAgICAgIH07CiAgICAgIFAudG9QcmVjaXNpb24gPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgZSwgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICAgIHgyID0gcm91bmQobmV3IEN0b3IoeDIpLCBzZCwgcm0pOwogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBzZCA8PSBlIHx8IGUgPD0gQ3Rvci50b0V4cE5lZywgc2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBQLnRvU2lnbmlmaWNhbnREaWdpdHMgPSBQLnRvc2QgPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHNkID09PSB2b2lkIDApIHsKICAgICAgICAgIHNkID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgICBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoc2QsIDEsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9TdHJpbmcgPSBQLnZhbHVlT2YgPSBQLnZhbCA9IFAudG9KU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiB0b1N0cmluZyh4MiwgZSA8PSBDdG9yLnRvRXhwTmVnIHx8IGUgPj0gQ3Rvci50b0V4cFBvcyk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGFkZCh4MiwgeTIpIHsKICAgICAgICB2YXIgY2FycnksIGQsIGUsIGksIGssIGxlbiwgeGQsIHlkLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSB7CiAgICAgICAgICBpZiAoIXkyLnMpIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGsgPSB4Mi5lOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBpID0gayAtIGU7CiAgICAgICAgaWYgKGkpIHsKICAgICAgICAgIGlmIChpIDwgMCkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGkgPSAtaTsKICAgICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZCA9IHlkOwogICAgICAgICAgICBlID0gazsKICAgICAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgayA9IE1hdGguY2VpbChwciAvIExPR19CQVNFKTsKICAgICAgICAgIGxlbiA9IGsgPiBsZW4gPyBrICsgMSA6IGxlbiArIDE7CiAgICAgICAgICBpZiAoaSA+IGxlbikgewogICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBpID0geWQubGVuZ3RoOwogICAgICAgIGlmIChsZW4gLSBpIDwgMCkgewogICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgIHlkID0geGQ7CiAgICAgICAgICB4ZCA9IGQ7CiAgICAgICAgfQogICAgICAgIGZvciAoY2FycnkgPSAwOyBpOyApIHsKICAgICAgICAgIGNhcnJ5ID0gKHhkWy0taV0gPSB4ZFtpXSArIHlkW2ldICsgY2FycnkpIC8gQkFTRSB8IDA7CiAgICAgICAgICB4ZFtpXSAlPSBCQVNFOwogICAgICAgIH0KICAgICAgICBpZiAoY2FycnkpIHsKICAgICAgICAgIHhkLnVuc2hpZnQoY2FycnkpOwogICAgICAgICAgKytlOwogICAgICAgIH0KICAgICAgICBmb3IgKGxlbiA9IHhkLmxlbmd0aDsgeGRbLS1sZW5dID09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0ludDMyKGksIG1pbjIsIG1heDIpIHsKICAgICAgICBpZiAoaSAhPT0gfn5pIHx8IGkgPCBtaW4yIHx8IGkgPiBtYXgyKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyBpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZGlnaXRzVG9TdHJpbmcoZCkgewogICAgICAgIHZhciBpLCBrLCB3cywgaW5kZXhPZkxhc3RXb3JkID0gZC5sZW5ndGggLSAxLCBzdHIgPSAiIiwgdyA9IGRbMF07CiAgICAgICAgaWYgKGluZGV4T2ZMYXN0V29yZCA+IDApIHsKICAgICAgICAgIHN0ciArPSB3OwogICAgICAgICAgZm9yIChpID0gMTsgaSA8IGluZGV4T2ZMYXN0V29yZDsgaSsrKSB7CiAgICAgICAgICAgIHdzID0gZFtpXSArICIiOwogICAgICAgICAgICBrID0gTE9HX0JBU0UgLSB3cy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICAgICAgc3RyICs9IHdzOwogICAgICAgICAgfQogICAgICAgICAgdyA9IGRbaV07CiAgICAgICAgICB3cyA9IHcgKyAiIjsKICAgICAgICAgIGsgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICB9IGVsc2UgaWYgKHcgPT09IDApIHsKICAgICAgICAgIHJldHVybiAiMCI7CiAgICAgICAgfQogICAgICAgIGZvciAoOyB3ICUgMTAgPT09IDA7ICkgdyAvPSAxMDsKICAgICAgICByZXR1cm4gc3RyICsgdzsKICAgICAgfQogICAgICB2YXIgZGl2aWRlID0gLyogQF9fUFVSRV9fICovIGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmN0aW9uIG11bHRpcGx5SW50ZWdlcih4MiwgaykgewogICAgICAgICAgdmFyIHRlbXAsIGNhcnJ5ID0gMCwgaSA9IHgyLmxlbmd0aDsKICAgICAgICAgIGZvciAoeDIgPSB4Mi5zbGljZSgpOyBpLS07ICkgewogICAgICAgICAgICB0ZW1wID0geDJbaV0gKiBrICsgY2Fycnk7CiAgICAgICAgICAgIHgyW2ldID0gdGVtcCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHRlbXAgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYXJyeSkgeDIudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYSwgYiwgYUwsIGJMKSB7CiAgICAgICAgICB2YXIgaSwgcjI7CiAgICAgICAgICBpZiAoYUwgIT0gYkwpIHsKICAgICAgICAgICAgcjIgPSBhTCA+IGJMID8gMSA6IC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gcjIgPSAwOyBpIDwgYUw7IGkrKykgewogICAgICAgICAgICAgIGlmIChhW2ldICE9IGJbaV0pIHsKICAgICAgICAgICAgICAgIHIyID0gYVtpXSA+IGJbaV0gPyAxIDogLTE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3VidHJhY3QyKGEsIGIsIGFMKSB7CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICBmb3IgKDsgYUwtLTsgKSB7CiAgICAgICAgICAgIGFbYUxdIC09IGk7CiAgICAgICAgICAgIGkgPSBhW2FMXSA8IGJbYUxdID8gMSA6IDA7CiAgICAgICAgICAgIGFbYUxdID0gaSAqIEJBU0UgKyBhW2FMXSAtIGJbYUxdOwogICAgICAgICAgfQogICAgICAgICAgZm9yICg7ICFhWzBdICYmIGEubGVuZ3RoID4gMTsgKSBhLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbih4MiwgeTIsIHByLCBkcCkgewogICAgICAgICAgdmFyIGNtcCwgZSwgaSwgaywgcHJvZCwgcHJvZEwsIHEsIHFkLCByZW0sIHJlbUwsIHJlbTAsIHNkLCB0LCB4aSwgeEwsIHlkMCwgeUwsIHl6LCBDdG9yID0geDIuY29uc3RydWN0b3IsIHNpZ24yID0geDIucyA9PSB5Mi5zID8gMSA6IC0xLCB4ZCA9IHgyLmQsIHlkID0geTIuZDsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKHgyKTsKICAgICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkRpdmlzaW9uIGJ5IHplcm8iKTsKICAgICAgICAgIGUgPSB4Mi5lIC0geTIuZTsKICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBxID0gbmV3IEN0b3Ioc2lnbjIpOwogICAgICAgICAgcWQgPSBxLmQgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDA7IHlkW2ldID09ICh4ZFtpXSB8fCAwKTsgKSArK2k7CiAgICAgICAgICBpZiAoeWRbaV0gPiAoeGRbaV0gfHwgMCkpIC0tZTsKICAgICAgICAgIGlmIChwciA9PSBudWxsKSB7CiAgICAgICAgICAgIHNkID0gcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIH0gZWxzZSBpZiAoZHApIHsKICAgICAgICAgICAgc2QgPSBwciArIChnZXRCYXNlMTBFeHBvbmVudCh4MikgLSBnZXRCYXNlMTBFeHBvbmVudCh5MikpICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNkID0gcHI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2QgPCAwKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgICBzZCA9IHNkIC8gTE9HX0JBU0UgKyAyIHwgMDsKICAgICAgICAgIGkgPSAwOwogICAgICAgICAgaWYgKHlMID09IDEpIHsKICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgIHlkID0geWRbMF07CiAgICAgICAgICAgIHNkKys7CiAgICAgICAgICAgIGZvciAoOyAoaSA8IHhMIHx8IGspICYmIHNkLS07IGkrKykgewogICAgICAgICAgICAgIHQgPSBrICogQkFTRSArICh4ZFtpXSB8fCAwKTsKICAgICAgICAgICAgICBxZFtpXSA9IHQgLyB5ZCB8IDA7CiAgICAgICAgICAgICAgayA9IHQgJSB5ZCB8IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGsgPSBCQVNFIC8gKHlkWzBdICsgMSkgfCAwOwogICAgICAgICAgICBpZiAoayA+IDEpIHsKICAgICAgICAgICAgICB5ZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgayk7CiAgICAgICAgICAgICAgeGQgPSBtdWx0aXBseUludGVnZXIoeGQsIGspOwogICAgICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgICAgIHhMID0geGQubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHhpID0geUw7CiAgICAgICAgICAgIHJlbSA9IHhkLnNsaWNlKDAsIHlMKTsKICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyByZW1MIDwgeUw7ICkgcmVtW3JlbUwrK10gPSAwOwogICAgICAgICAgICB5eiA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgIHl6LnVuc2hpZnQoMCk7CiAgICAgICAgICAgIHlkMCA9IHlkWzBdOwogICAgICAgICAgICBpZiAoeWRbMV0gPj0gQkFTRSAvIDIpICsreWQwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgICAgY21wID0gY29tcGFyZSh5ZCwgcmVtLCB5TCwgcmVtTCk7CiAgICAgICAgICAgICAgaWYgKGNtcCA8IDApIHsKICAgICAgICAgICAgICAgIHJlbTAgPSByZW1bMF07CiAgICAgICAgICAgICAgICBpZiAoeUwgIT0gcmVtTCkgcmVtMCA9IHJlbTAgKiBCQVNFICsgKHJlbVsxXSB8fCAwKTsKICAgICAgICAgICAgICAgIGsgPSByZW0wIC8geWQwIHwgMDsKICAgICAgICAgICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgICAgICAgICBpZiAoayA+PSBCQVNFKSBrID0gQkFTRSAtIDE7CiAgICAgICAgICAgICAgICAgIHByb2QgPSBtdWx0aXBseUludGVnZXIoeWQsIGspOwogICAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgY21wID0gY29tcGFyZShwcm9kLCByZW0sIHByb2RMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgay0tOwogICAgICAgICAgICAgICAgICAgIHN1YnRyYWN0Mihwcm9kLCB5TCA8IHByb2RMID8geXogOiB5ZCwgcHJvZEwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoayA9PSAwKSBjbXAgPSBrID0gMTsKICAgICAgICAgICAgICAgICAgcHJvZCA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHByb2RMIDwgcmVtTCkgcHJvZC51bnNoaWZ0KDApOwogICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgcHJvZCwgcmVtTCk7CiAgICAgICAgICAgICAgICBpZiAoY21wID09IC0xKSB7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHlkLCByZW0sIHlMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgeUwgPCByZW1MID8geXogOiB5ZCwgcmVtTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY21wID09PSAwKSB7CiAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICByZW0gPSBbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHFkW2krK10gPSBrOwogICAgICAgICAgICAgIGlmIChjbXAgJiYgcmVtWzBdKSB7CiAgICAgICAgICAgICAgICByZW1bcmVtTCsrXSA9IHhkW3hpXSB8fCAwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZW0gPSBbeGRbeGldXTsKICAgICAgICAgICAgICAgIHJlbUwgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKHhpKysgPCB4TCB8fCByZW1bMF0gIT09IHZvaWQgMCkgJiYgc2QtLSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXFkWzBdKSBxZC5zaGlmdCgpOwogICAgICAgICAgcS5lID0gZTsKICAgICAgICAgIHJldHVybiByb3VuZChxLCBkcCA/IHByICsgZ2V0QmFzZTEwRXhwb25lbnQocSkgKyAxIDogcHIpOwogICAgICAgIH07CiAgICAgIH0oKTsKICAgICAgZnVuY3Rpb24gZXhwKHgyLCBzZCkgewogICAgICAgIHZhciBkZW5vbWluYXRvciwgZ3VhcmQsIHBvdzIsIHN1bSwgdCwgd3ByLCBpID0gMCwgayA9IDAsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoZ2V0QmFzZTEwRXhwb25lbnQoeDIpID4gMTYpIHRocm93IEVycm9yKGV4cG9uZW50T3V0T2ZSYW5nZSArIGdldEJhc2UxMEV4cG9uZW50KHgyKSk7CiAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgdCA9IG5ldyBDdG9yKDAuMDMxMjUpOwogICAgICAgIHdoaWxlICh4Mi5hYnMoKS5ndGUoMC4xKSkgewogICAgICAgICAgeDIgPSB4Mi50aW1lcyh0KTsKICAgICAgICAgIGsgKz0gNTsKICAgICAgICB9CiAgICAgICAgZ3VhcmQgPSBNYXRoLmxvZyhtYXRocG93KDIsIGspKSAvIE1hdGguTE4xMCAqIDIgKyA1IHwgMDsKICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgZGVub21pbmF0b3IgPSBwb3cyID0gc3VtID0gbmV3IEN0b3IoT05FKTsKICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHdwcjsKICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgIHBvdzIgPSByb3VuZChwb3cyLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIGRlbm9taW5hdG9yID0gZGVub21pbmF0b3IudGltZXMoKytpKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUocG93MiwgZGVub21pbmF0b3IsIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgd2hpbGUgKGstLSkgc3VtID0gcm91bmQoc3VtLnRpbWVzKHN1bSksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0QmFzZTEwRXhwb25lbnQoeDIpIHsKICAgICAgICB2YXIgZSA9IHgyLmUgKiBMT0dfQkFTRSwgdyA9IHgyLmRbMF07CiAgICAgICAgZm9yICg7IHcgPj0gMTA7IHcgLz0gMTApIGUrKzsKICAgICAgICByZXR1cm4gZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRMbjEwKEN0b3IsIHNkLCBwcikgewogICAgICAgIGlmIChzZCA+IEN0b3IuTE4xMC5zZCgpKSB7CiAgICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICBpZiAocHIpIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTE4xMCBwcmVjaXNpb24gbGltaXQgZXhjZWVkZWQiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKEN0b3IuTE4xMCksIHNkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRaZXJvU3RyaW5nKGspIHsKICAgICAgICB2YXIgenMgPSAiIjsKICAgICAgICBmb3IgKDsgay0tOyApIHpzICs9ICIwIjsKICAgICAgICByZXR1cm4genM7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbG4oeTIsIHNkKSB7CiAgICAgICAgdmFyIGMsIGMwLCBkZW5vbWluYXRvciwgZSwgbnVtZXJhdG9yLCBzdW0sIHQsIHdwciwgeDIsIG4gPSAxLCBndWFyZCA9IDEwLCB4MyA9IHkyLCB4ZCA9IHgzLmQsIEN0b3IgPSB4My5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeDMucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4My5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4My5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgaWYgKHNkID09IG51bGwpIHsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICB3cHIgPSBwcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3ByID0gc2Q7CiAgICAgICAgfQogICAgICAgIGlmICh4My5lcSgxMCkpIHsKICAgICAgICAgIGlmIChzZCA9PSBudWxsKSBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gZ2V0TG4xMChDdG9yLCB3cHIpOwogICAgICAgIH0KICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSB3cHI7CiAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHhkKTsKICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgaWYgKE1hdGguYWJzKGUpIDwgMTVlMTQpIHsKICAgICAgICAgIHdoaWxlIChjMCA8IDcgJiYgYzAgIT0gMSB8fCBjMCA9PSAxICYmIGMuY2hhckF0KDEpID4gMykgewogICAgICAgICAgICB4MyA9IHgzLnRpbWVzKHkyKTsKICAgICAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHgzLmQpOwogICAgICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgICAgICBuKys7CiAgICAgICAgICB9CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDMpOwogICAgICAgICAgaWYgKGMwID4gMSkgewogICAgICAgICAgICB4MyA9IG5ldyBDdG9yKCIwLiIgKyBjKTsKICAgICAgICAgICAgZSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDMgPSBuZXcgQ3RvcihjMCArICIuIiArIGMuc2xpY2UoMSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0ID0gZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKTsKICAgICAgICAgIHgzID0gbG4obmV3IEN0b3IoYzAgKyAiLiIgKyBjLnNsaWNlKDEpKSwgd3ByIC0gZ3VhcmQpLnBsdXModCk7CiAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgcmV0dXJuIHNkID09IG51bGwgPyAoZXh0ZXJuYWwgPSB0cnVlLCByb3VuZCh4MywgcHIpKSA6IHgzOwogICAgICAgIH0KICAgICAgICBzdW0gPSBudW1lcmF0b3IgPSB4MyA9IGRpdmlkZSh4My5taW51cyhPTkUpLCB4My5wbHVzKE9ORSksIHdwcik7CiAgICAgICAgeDIgPSByb3VuZCh4My50aW1lcyh4MyksIHdwcik7CiAgICAgICAgZGVub21pbmF0b3IgPSAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgbnVtZXJhdG9yID0gcm91bmQobnVtZXJhdG9yLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUobnVtZXJhdG9yLCBuZXcgQ3RvcihkZW5vbWluYXRvciksIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgc3VtID0gc3VtLnRpbWVzKDIpOwogICAgICAgICAgICBpZiAoZSAhPT0gMCkgc3VtID0gc3VtLnBsdXMoZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKSk7CiAgICAgICAgICAgIHN1bSA9IGRpdmlkZShzdW0sIG5ldyBDdG9yKG4pLCB3cHIpOwogICAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHN1bSwgcHIpKSA6IHN1bTsKICAgICAgICAgIH0KICAgICAgICAgIHN1bSA9IHQ7CiAgICAgICAgICBkZW5vbWluYXRvciArPSAyOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZURlY2ltYWwoeDIsIHN0cikgewogICAgICAgIHZhciBlLCBpLCBsZW47CiAgICAgICAgaWYgKChlID0gc3RyLmluZGV4T2YoIi4iKSkgPiAtMSkgc3RyID0gc3RyLnJlcGxhY2UoIi4iLCAiIik7CiAgICAgICAgaWYgKChpID0gc3RyLnNlYXJjaCgvZS9pKSkgPiAwKSB7CiAgICAgICAgICBpZiAoZSA8IDApIGUgPSBpOwogICAgICAgICAgZSArPSArc3RyLnNsaWNlKGkgKyAxKTsKICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgaSk7CiAgICAgICAgfSBlbHNlIGlmIChlIDwgMCkgewogICAgICAgICAgZSA9IHN0ci5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IHN0ci5jaGFyQ29kZUF0KGkpID09PSA0ODsgKSArK2k7CiAgICAgICAgZm9yIChsZW4gPSBzdHIubGVuZ3RoOyBzdHIuY2hhckNvZGVBdChsZW4gLSAxKSA9PT0gNDg7ICkgLS1sZW47CiAgICAgICAgc3RyID0gc3RyLnNsaWNlKGksIGxlbik7CiAgICAgICAgaWYgKHN0cikgewogICAgICAgICAgbGVuIC09IGk7CiAgICAgICAgICBlID0gZSAtIGkgLSAxOwogICAgICAgICAgeDIuZSA9IG1hdGhmbG9vcihlIC8gTE9HX0JBU0UpOwogICAgICAgICAgeDIuZCA9IFtdOwogICAgICAgICAgaSA9IChlICsgMSkgJSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChlIDwgMCkgaSArPSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChpIDwgbGVuKSB7CiAgICAgICAgICAgIGlmIChpKSB4Mi5kLnB1c2goK3N0ci5zbGljZSgwLCBpKSk7CiAgICAgICAgICAgIGZvciAobGVuIC09IExPR19CQVNFOyBpIDwgbGVuOyApIHgyLmQucHVzaCgrc3RyLnNsaWNlKGksIGkgKz0gTE9HX0JBU0UpKTsKICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKGkpOwogICAgICAgICAgICBpID0gTE9HX0JBU0UgLSBzdHIubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaSAtPSBsZW47CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgaS0tOyApIHN0ciArPSAiMCI7CiAgICAgICAgICB4Mi5kLnB1c2goK3N0cik7CiAgICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHgyLnMgPSAwOwogICAgICAgICAgeDIuZSA9IDA7CiAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4geDI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcm91bmQoeDIsIHNkLCBybSkgewogICAgICAgIHZhciBpLCBqLCBrLCBuLCByZCwgZG9Sb3VuZCwgdywgeGRpLCB4ZCA9IHgyLmQ7CiAgICAgICAgZm9yIChuID0gMSwgayA9IHhkWzBdOyBrID49IDEwOyBrIC89IDEwKSBuKys7CiAgICAgICAgaSA9IHNkIC0gbjsKICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgIGkgKz0gTE9HX0JBU0U7CiAgICAgICAgICBqID0gc2Q7CiAgICAgICAgICB3ID0geGRbeGRpID0gMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHhkaSA9IE1hdGguY2VpbCgoaSArIDEpIC8gTE9HX0JBU0UpOwogICAgICAgICAgayA9IHhkLmxlbmd0aDsKICAgICAgICAgIGlmICh4ZGkgPj0gaykgcmV0dXJuIHgyOwogICAgICAgICAgdyA9IGsgPSB4ZFt4ZGldOwogICAgICAgICAgZm9yIChuID0gMTsgayA+PSAxMDsgayAvPSAxMCkgbisrOwogICAgICAgICAgaSAlPSBMT0dfQkFTRTsKICAgICAgICAgIGogPSBpIC0gTE9HX0JBU0UgKyBuOwogICAgICAgIH0KICAgICAgICBpZiAocm0gIT09IHZvaWQgMCkgewogICAgICAgICAgayA9IG1hdGhwb3coMTAsIG4gLSBqIC0gMSk7CiAgICAgICAgICByZCA9IHcgLyBrICUgMTAgfCAwOwogICAgICAgICAgZG9Sb3VuZCA9IHNkIDwgMCB8fCB4ZFt4ZGkgKyAxXSAhPT0gdm9pZCAwIHx8IHcgJSBrOwogICAgICAgICAgZG9Sb3VuZCA9IHJtIDwgNCA/IChyZCB8fCBkb1JvdW5kKSAmJiAocm0gPT0gMCB8fCBybSA9PSAoeDIucyA8IDAgPyAzIDogMikpIDogcmQgPiA1IHx8IHJkID09IDUgJiYgKHJtID09IDQgfHwgZG9Sb3VuZCB8fCBybSA9PSA2ICYmIC8vIENoZWNrIHdoZXRoZXIgdGhlIGRpZ2l0IHRvIHRoZSBsZWZ0IG9mIHRoZSByb3VuZGluZyBkaWdpdCBpcyBvZGQuCiAgICAgICAgICAoaSA+IDAgPyBqID4gMCA/IHcgLyBtYXRocG93KDEwLCBuIC0gaikgOiAwIDogeGRbeGRpIC0gMV0pICUgMTAgJiAxIHx8IHJtID09ICh4Mi5zIDwgMCA/IDggOiA3KSk7CiAgICAgICAgfQogICAgICAgIGlmIChzZCA8IDEgfHwgIXhkWzBdKSB7CiAgICAgICAgICBpZiAoZG9Sb3VuZCkgewogICAgICAgICAgICBrID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICBzZCA9IHNkIC0gayAtIDE7CiAgICAgICAgICAgIHhkWzBdID0gbWF0aHBvdygxMCwgKExPR19CQVNFIC0gc2QgJSBMT0dfQkFTRSkgJSBMT0dfQkFTRSk7CiAgICAgICAgICAgIHgyLmUgPSBtYXRoZmxvb3IoLXNkIC8gTE9HX0JBU0UpIHx8IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICB4ZFswXSA9IHgyLmUgPSB4Mi5zID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB4MjsKICAgICAgICB9CiAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpOwogICAgICAgICAgayA9IDE7CiAgICAgICAgICB4ZGktLTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpICsgMTsKICAgICAgICAgIGsgPSBtYXRocG93KDEwLCBMT0dfQkFTRSAtIGkpOwogICAgICAgICAgeGRbeGRpXSA9IGogPiAwID8gKHcgLyBtYXRocG93KDEwLCBuIC0gaikgJSBtYXRocG93KDEwLCBqKSB8IDApICogayA6IDA7CiAgICAgICAgfQogICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgaWYgKHhkaSA9PSAwKSB7CiAgICAgICAgICAgICAgaWYgKCh4ZFswXSArPSBrKSA9PSBCQVNFKSB7CiAgICAgICAgICAgICAgICB4ZFswXSA9IDE7CiAgICAgICAgICAgICAgICArK3gyLmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHhkW3hkaV0gKz0gazsKICAgICAgICAgICAgICBpZiAoeGRbeGRpXSAhPSBCQVNFKSBicmVhazsKICAgICAgICAgICAgICB4ZFt4ZGktLV0gPSAwOwogICAgICAgICAgICAgIGsgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IHhkLmxlbmd0aDsgeGRbLS1pXSA9PT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgewogICAgICAgICAgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN1YnRyYWN0KHgyLCB5MikgewogICAgICAgIHZhciBkLCBlLCBpLCBqLCBrLCBsZW4sIHhkLCB4ZSwgeExUeSwgeWQsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHsKICAgICAgICAgIGlmICh5Mi5zKSB5Mi5zID0gLXkyLnM7CiAgICAgICAgICBlbHNlIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhlID0geDIuZTsKICAgICAgICB4ZCA9IHhkLnNsaWNlKCk7CiAgICAgICAgayA9IHhlIC0gZTsKICAgICAgICBpZiAoaykgewogICAgICAgICAgeExUeSA9IGsgPCAwOwogICAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgICAgZCA9IHhkOwogICAgICAgICAgICBrID0gLWs7CiAgICAgICAgICAgIGxlbiA9IHlkLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgICAgZSA9IHhlOwogICAgICAgICAgICBsZW4gPSB4ZC5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBpID0gTWF0aC5tYXgoTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UpLCBsZW4pICsgMjsKICAgICAgICAgIGlmIChrID4gaSkgewogICAgICAgICAgICBrID0gaTsKICAgICAgICAgICAgZC5sZW5ndGggPSAxOwogICAgICAgICAgfQogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgICBmb3IgKGkgPSBrOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB4TFR5ID0gaSA8IGxlbjsKICAgICAgICAgIGlmICh4TFR5KSBsZW4gPSBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICh4ZFtpXSAhPSB5ZFtpXSkgewogICAgICAgICAgICAgIHhMVHkgPSB4ZFtpXSA8IHlkW2ldOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBrID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgIHhkID0geWQ7CiAgICAgICAgICB5ZCA9IGQ7CiAgICAgICAgICB5Mi5zID0gLXkyLnM7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGggLSBsZW47IGkgPiAwOyAtLWkpIHhkW2xlbisrXSA9IDA7CiAgICAgICAgZm9yIChpID0geWQubGVuZ3RoOyBpID4gazsgKSB7CiAgICAgICAgICBpZiAoeGRbLS1pXSA8IHlkW2ldKSB7CiAgICAgICAgICAgIGZvciAoaiA9IGk7IGogJiYgeGRbLS1qXSA9PT0gMDsgKSB4ZFtqXSA9IEJBU0UgLSAxOwogICAgICAgICAgICAtLXhkW2pdOwogICAgICAgICAgICB4ZFtpXSArPSBCQVNFOwogICAgICAgICAgfQogICAgICAgICAgeGRbaV0gLT0geWRbaV07CiAgICAgICAgfQogICAgICAgIGZvciAoOyB4ZFstLWxlbl0gPT09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgZm9yICg7IHhkWzBdID09PSAwOyB4ZC5zaGlmdCgpKSAtLWU7CiAgICAgICAgaWYgKCF4ZFswXSkgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgIHkyLmQgPSB4ZDsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9TdHJpbmcoeDIsIGlzRXhwLCBzZCkgewogICAgICAgIHZhciBrLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBzdHIgPSBkaWdpdHNUb1N0cmluZyh4Mi5kKSwgbGVuID0gc3RyLmxlbmd0aDsKICAgICAgICBpZiAoaXNFeHApIHsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKSArIGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0ciA9IHN0ciArIChlIDwgMCA/ICJlIiA6ICJlKyIpICsgZTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBzdHIgPSAiMC4iICsgZ2V0WmVyb1N0cmluZygtZSAtIDEpICsgc3RyOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgc3RyICs9IGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgfSBlbHNlIGlmIChlID49IGxlbikgewogICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoZSArIDEgLSBsZW4pOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBlIC0gMSkgPiAwKSBzdHIgPSBzdHIgKyAiLiIgKyBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoKGsgPSBlICsgMSkgPCBsZW4pIHN0ciA9IHN0ci5zbGljZSgwLCBrKSArICIuIiArIHN0ci5zbGljZShrKTsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgaWYgKGUgKyAxID09PSBsZW4pIHN0ciArPSAiLiI7CiAgICAgICAgICAgIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4geDIucyA8IDAgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJ1bmNhdGUoYXJyLCBsZW4pIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA+IGxlbikgewogICAgICAgICAgYXJyLmxlbmd0aCA9IGxlbjsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICB2YXIgaSwgcCwgcHM7CiAgICAgICAgZnVuY3Rpb24gRGVjaW1hbDQodmFsdWUpIHsKICAgICAgICAgIHZhciB4MiA9IHRoaXM7CiAgICAgICAgICBpZiAoISh4MiBpbnN0YW5jZW9mIERlY2ltYWw0KSkgcmV0dXJuIG5ldyBEZWNpbWFsNCh2YWx1ZSk7CiAgICAgICAgICB4Mi5jb25zdHJ1Y3RvciA9IERlY2ltYWw0OwogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGVjaW1hbDQpIHsKICAgICAgICAgICAgeDIucyA9IHZhbHVlLnM7CiAgICAgICAgICAgIHgyLmUgPSB2YWx1ZS5lOwogICAgICAgICAgICB4Mi5kID0gKHZhbHVlID0gdmFsdWUuZCkgPyB2YWx1ZS5zbGljZSgpIDogdmFsdWU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAqIDAgIT09IDApIHsKICAgICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhbHVlID0gLXZhbHVlOwogICAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4Mi5zID0gMDsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09IH5+dmFsdWUgJiYgdmFsdWUgPCAxZTcpIHsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gW3ZhbHVlXTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcnNlRGVjaW1hbCh4MiwgdmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlLmNoYXJDb2RlQXQoMCkgPT09IDQ1KSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVjaW1hbC50ZXN0KHZhbHVlKSkgcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZSk7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQucHJvdG90eXBlID0gUDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9VUCA9IDA7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRE9XTiA9IDE7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfQ0VJTCA9IDI7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRkxPT1IgPSAzOwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfVVAgPSA0OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRE9XTiA9IDU7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9FVkVOID0gNjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0NFSUwgPSA3OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRkxPT1IgPSA4OwogICAgICAgIERlY2ltYWw0LmNsb25lID0gY2xvbmU7CiAgICAgICAgRGVjaW1hbDQuY29uZmlnID0gRGVjaW1hbDQuc2V0ID0gY29uZmlnOwogICAgICAgIGlmIChvYmogPT09IHZvaWQgMCkgb2JqID0ge307CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgcHMgPSBbInByZWNpc2lvbiIsICJyb3VuZGluZyIsICJ0b0V4cE5lZyIsICJ0b0V4cFBvcyIsICJMTjEwIl07CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyApIGlmICghb2JqLmhhc093blByb3BlcnR5KHAgPSBwc1tpKytdKSkgb2JqW3BdID0gdGhpc1twXTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQuY29uZmlnKG9iaik7CiAgICAgICAgcmV0dXJuIERlY2ltYWw0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbmZpZyhvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk9iamVjdCBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICB2YXIgaSwgcCwgdiwgcHMgPSBbCiAgICAgICAgICAicHJlY2lzaW9uIiwKICAgICAgICAgIDEsCiAgICAgICAgICBNQVhfRElHSVRTLAogICAgICAgICAgInJvdW5kaW5nIiwKICAgICAgICAgIDAsCiAgICAgICAgICA4LAogICAgICAgICAgInRvRXhwTmVnIiwKICAgICAgICAgIC0xIC8gMCwKICAgICAgICAgIDAsCiAgICAgICAgICAidG9FeHBQb3MiLAogICAgICAgICAgMCwKICAgICAgICAgIDEgLyAwCiAgICAgICAgXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGlmICgodiA9IG9ialtwID0gcHNbaV1dKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChtYXRoZmxvb3IodikgPT09IHYgJiYgdiA+PSBwc1tpICsgMV0gJiYgdiA8PSBwc1tpICsgMl0pIHRoaXNbcF0gPSB2OwogICAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgodiA9IG9ialtwID0gIkxOMTAiXSkgIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHYgPT0gTWF0aC5MTjEwKSB0aGlzW3BdID0gbmV3IHRoaXModik7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIERlY2ltYWwzID0gY2xvbmUoRGVjaW1hbDMpOwogICAgICBEZWNpbWFsM1siZGVmYXVsdCJdID0gRGVjaW1hbDMuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICBPTkUgPSBuZXcgRGVjaW1hbDMoMSk7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBEZWNpbWFsMzsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBEZWNpbWFsMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWdsb2JhbFNjb3BlKSB7CiAgICAgICAgICBnbG9iYWxTY29wZSA9IHR5cGVvZiBzZWxmICE9ICJ1bmRlZmluZWQiICYmIHNlbGYgJiYgc2VsZi5zZWxmID09IHNlbGYgPyBzZWxmIDogRnVuY3Rpb24oInJldHVybiB0aGlzIikoKTsKICAgICAgICB9CiAgICAgICAgZ2xvYmFsU2NvcGUuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICB9CiAgICB9KShleHBvcnRzKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2V2ZW50ZW1pdHRlcjNANS4wLjEvbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXguanMKdmFyIHJlcXVpcmVfZXZlbnRlbWl0dGVyMyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXZlbnRlbWl0dGVyM0A1LjAuMS9ub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgaGFzMyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgcHJlZml4ID0gIn4iOwogICAgZnVuY3Rpb24gRXZlbnRzKCkgewogICAgfQogICAgaWYgKE9iamVjdC5jcmVhdGUpIHsKICAgICAgRXZlbnRzLnByb3RvdHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gRUUoZm4sIGNvbnRleHQsIG9uY2UpIHsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICB0aGlzLm9uY2UgPSBvbmNlIHx8IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gYWRkTGlzdGVuZXIyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICB9CiAgICAgIHZhciBsaXN0ZW5lcjIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSksIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrOwogICAgICBlbHNlIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0uZm4pIGVtaXR0ZXIuX2V2ZW50c1tldnRdLnB1c2gobGlzdGVuZXIyKTsKICAgICAgZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXIyXTsKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckV2ZW50KGVtaXR0ZXIsIGV2dCkgewogICAgICBpZiAoLS1lbWl0dGVyLl9ldmVudHNDb3VudCA9PT0gMCkgZW1pdHRlci5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTsKICAgIH0KICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcjIoKSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgfQogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICAgIHZhciBuYW1lcyA9IFtdLCBldmVudHMsIG5hbWU7CiAgICAgIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzOwogICAgICBmb3IgKG5hbWUgaW4gZXZlbnRzID0gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGhhczMuY2FsbChldmVudHMsIG5hbWUpKSBuYW1lcy5wdXNoKHByZWZpeCA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lKTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWhhbmRsZXJzKSByZXR1cm4gW107CiAgICAgIGlmIChoYW5kbGVycy5mbikgcmV0dXJuIFtoYW5kbGVycy5mbl07CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykgewogICAgICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47CiAgICAgIH0KICAgICAgcmV0dXJuIGVlOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTsKICAgICAgcmV0dXJuIGxpc3RlbmVycy5sZW5ndGg7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF0sIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MsIGk7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVycy5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExKSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlOwogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0KSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnNbaV0uZm4sIHZvaWQgMCwgdHJ1ZSk7CiAgICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMiwgYTMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLSAxKTsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIGZhbHNlKTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIHRydWUpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIyKGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghZm4pIHsKICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgICAgaWYgKGxpc3RlbmVycy5mbiA9PT0gZm4gJiYgKCFvbmNlIHx8IGxpc3RlbmVycy5vbmNlKSAmJiAoIWNvbnRleHQgfHwgbGlzdGVuZXJzLmNvbnRleHQgPT09IGNvbnRleHQpKSB7CiAgICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fCBvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSB8fCBjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGV2ZW50cy5wdXNoKGxpc3RlbmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudHMubGVuZ3RoKSB0aGlzLl9ldmVudHNbZXZ0XSA9IGV2ZW50cy5sZW5ndGggPT09IDEgPyBldmVudHNbMF0gOiBldmVudHM7CiAgICAgICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQ7CiAgICAgIGlmIChldmVudCkgewogICAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgICAgaWYgKHRoaXMuX2V2ZW50c1tldnRdKSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vZmYgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub247CiAgICBFdmVudEVtaXR0ZXIyLnByZWZpeGVkID0gcHJlZml4OwogICAgRXZlbnRFbWl0dGVyMi5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXIyOwogICAgaWYgKCJ1bmRlZmluZWQiICE9PSB0eXBlb2YgbW9kdWxlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyMjsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyKSB7CiAgICAgIHJldHVybiBhcnJbYXJyLmxlbmd0aCAtIDFdOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcwp2YXIgcmVxdWlyZV90b0FycmF5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0FycmF5KHZhbHVlKSB7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogQXJyYXkuZnJvbSh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLnRvQXJyYXkgPSB0b0FycmF5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvbGFzdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgbGFzdCQxID0gcmVxdWlyZV9sYXN0KCk7CiAgICB2YXIgdG9BcnJheSA9IHJlcXVpcmVfdG9BcnJheSgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyYXkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZS5pc0FycmF5TGlrZShhcnJheSkpIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0JDEubGFzdCh0b0FycmF5LnRvQXJyYXkoYXJyYXkpKTsKICAgIH0KICAgIGV4cG9ydHMubGFzdCA9IGxhc3QyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2xhc3QuanMKdmFyIHJlcXVpcmVfbGFzdDMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9sYXN0MigpLmxhc3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpLCBvYmplY3RJcyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBPYmplY3QuaXMgPyBPYmplY3QuaXMgOiBpczQsIHVzZVN5bmNFeHRlcm5hbFN0b3JlMiA9IFJlYWN0MzkudXNlU3luY0V4dGVybmFsU3RvcmUsIHVzZVJlZjE1ID0gUmVhY3QzOS51c2VSZWYsIHVzZUVmZmVjdDE1ID0gUmVhY3QzOS51c2VFZmZlY3QsIHVzZU1lbW84ID0gUmVhY3QzOS51c2VNZW1vLCB1c2VEZWJ1Z1ZhbHVlMiA9IFJlYWN0MzkudXNlRGVidWdWYWx1ZTsKICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZVdpdGhTZWxlY3RvciA9IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbCkgewogICAgICAgIHZhciBpbnN0UmVmID0gdXNlUmVmMTUobnVsbCk7CiAgICAgICAgaWYgKG51bGwgPT09IGluc3RSZWYuY3VycmVudCkgewogICAgICAgICAgdmFyIGluc3QgPSB7IGhhc1ZhbHVlOiBmYWxzZSwgdmFsdWU6IG51bGwgfTsKICAgICAgICAgIGluc3RSZWYuY3VycmVudCA9IGluc3Q7CiAgICAgICAgfSBlbHNlIGluc3QgPSBpbnN0UmVmLmN1cnJlbnQ7CiAgICAgICAgaW5zdFJlZiA9IHVzZU1lbW84KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIG1lbW9pemVkU2VsZWN0b3IobmV4dFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgaWYgKCFoYXNNZW1vKSB7CiAgICAgICAgICAgICAgICBoYXNNZW1vID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgICBuZXh0U25hcHNob3QgPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gaXNFcXVhbCAmJiBpbnN0Lmhhc1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2VsZWN0aW9uID0gaW5zdC52YWx1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50U2VsZWN0aW9uID0gbWVtb2l6ZWRTZWxlY3Rpb247CiAgICAgICAgICAgICAgaWYgKG9iamVjdElzKG1lbW9pemVkU25hcHNob3QsIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICB2YXIgbmV4dFNlbGVjdGlvbiA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gaXNFcXVhbCAmJiBpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTZWxlY3Rpb24pKQogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3QsIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U2VsZWN0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNNZW1vID0gZmFsc2UsIG1lbW9pemVkU25hcHNob3QsIG1lbW9pemVkU2VsZWN0aW9uLCBtYXliZUdldFNlcnZlclNuYXBzaG90ID0gdm9pZCAwID09PSBnZXRTZXJ2ZXJTbmFwc2hvdCA/IG51bGwgOiBnZXRTZXJ2ZXJTbmFwc2hvdDsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKGdldFNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbnVsbCA9PT0gbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA/IHZvaWQgMCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IobWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF07CiAgICAgICAgICB9LAogICAgICAgICAgW2dldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWxdCiAgICAgICAgKTsKICAgICAgICB2YXIgdmFsdWUgPSB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIoc3Vic2NyaWJlLCBpbnN0UmVmWzBdLCBpbnN0UmVmWzFdKTsKICAgICAgICB1c2VFZmZlY3QxNSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnN0Lmhhc1ZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgfSwKICAgICAgICAgIFt2YWx1ZV0KICAgICAgICApOwogICAgICAgIHVzZURlYnVnVmFsdWUyKHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH07CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKEVycm9yKCkpOwogICAgfSkoKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS93aXRoLXNlbGVjdG9yLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfanN4X3J1bnRpbWVfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzkuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0U7CiAgICAgICAgewogICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IGVuYWJsZURlYnVnVHJhY2luZyB8fCB0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbiB8fCB0eXBlID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkyKGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgIHJlZjogdHJ1ZSwKICAgICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgInJlZiIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZEtleShjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAia2V5IikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJrZXkiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcsIHNlbGYyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBzZWxmMiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZjIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ0tleSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ0tleS5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAicmVmIiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZjIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICAgIGlmIChtYXliZUtleSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihtYXliZUtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgbWF5YmVLZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcsIHNlbGYyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlICYmIHR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNihvYmplY3QpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiICYmIG9iamVjdCAhPT0gbnVsbCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG5hbWUgKyAiYC4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKHNvdXJjZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICAgIHZhciBsaW5lTnVtYmVyID0gc291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvID0gIlxuXG5DaGVjayB0aGUgdG9wLWxldmVsIHJlbmRlciBjYWxsIHVzaW5nIDwiICsgcGFyZW50TmFtZSArICI+LiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbmZvOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUV4cGxpY2l0S2V5KGVsZW1lbnQsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9IGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSk7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIgIT09IFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuJXMlcyBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nLCBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvLCBjaGlsZE93bmVyKTsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDaGlsZEtleXMobm9kZSwgcGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIG5vZGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0FycmF5Mihub2RlKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE2KGNoaWxkKSkgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNihub2RlKSkgewogICAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE2KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BUeXBlcykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3BUeXBlcywgZWxlbWVudC5wcm9wcywgInByb3AiLCBuYW1lLCBlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlLlByb3BUeXBlcyAhPT0gdm9pZCAwICYmICFwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgX25hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbXBvbmVudCAlcyBkZWNsYXJlZCBgUHJvcFR5cGVzYCBpbnN0ZWFkIG9mIGBwcm9wVHlwZXNgLiBEaWQgeW91IG1pc3NwZWxsIHRoZSBwcm9wZXJ0eSBhc3NpZ25tZW50PyIsIF9uYW1lIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLmdldERlZmF1bHRQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiAhdHlwZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0RGVmYXVsdFByb3BzIGlzIG9ubHkgdXNlZCBvbiBjbGFzc2ljIFJlYWN0LmNyZWF0ZUNsYXNzIGRlZmluaXRpb25zLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgbmFtZWQgYGRlZmF1bHRQcm9wc2AgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZnJhZ21lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhmcmFnbWVudC5wcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIGlmIChrZXkgIT09ICJjaGlsZHJlbiIgJiYga2V5ICE9PSAia2V5IikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBwcm9wIGAlc2Agc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4gUmVhY3QuRnJhZ21lbnQgY2FuIG9ubHkgaGF2ZSBga2V5YCBhbmQgYGNoaWxkcmVuYCBwcm9wcy4iLCBrZXkpOwogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZnJhZ21lbnQucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXR0cmlidXRlIGByZWZgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIik7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0S2V5U3ByZWFkID0ge307CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgaXNTdGF0aWNDaGlsZHJlbiwgc291cmNlLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpOwogICAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiYXJyYXkiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSAhPT0gdm9pZCAwICYmIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgICBpbmZvID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBleHBvcnQgYSBKU1ggbGl0ZXJhbCBpbnN0ZWFkIG9mIGEgY29tcG9uZW50PyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmpzeDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganN4REVWKHR5cGUsIHByb3BzLCBrZXksIHNvdXJjZSwgc2VsZjIpOwogICAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIGlmIChjaGlsZHJlbiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdGF0aWNDaGlsZHJlbikgewogICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoY2hpbGRyZW5baV0sIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IFN0YXRpYyBjaGlsZHJlbiBzaG91bGQgYWx3YXlzIGJlIGFuIGFycmF5LiBZb3UgYXJlIGxpa2VseSBleHBsaWNpdGx5IGNhbGxpbmcgUmVhY3QuanN4cyBvciBSZWFjdC5qc3hERVYuIFVzZSB0aGUgQmFiZWwgdHJhbnNmb3JtIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3BzLCAia2V5IikpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wcykuZmlsdGVyKGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGsgIT09ICJrZXkiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7a2V5OiBzb21lS2V5LCAiICsga2V5cy5qb2luKCI6IC4uLiwgIikgKyAiOiAuLi59IiA6ICJ7a2V5OiBzb21lS2V5fSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0pIHsKICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7IiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie30iOwogICAgICAgICAgICAgICAgICBlcnJvcignQSBwcm9wcyBvYmplY3QgY29udGFpbmluZyBhICJrZXkiIHByb3AgaXMgYmVpbmcgc3ByZWFkIGludG8gSlNYOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIHsuLi5wcm9wc30gLz5cblJlYWN0IGtleXMgbXVzdCBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gSlNYIHdpdGhvdXQgdXNpbmcgc3ByZWFkOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIGtleT17c29tZUtleX0gey4uLnByb3BzfSAvPicsIGJlZm9yZUV4YW1wbGUsIGNvbXBvbmVudE5hbWUsIGFmdGVyRXhhbXBsZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb25TdGF0aWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYyh0eXBlLCBwcm9wcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqc3gzID0ganN4V2l0aFZhbGlkYXRpb25EeW5hbWljOwogICAgICAgIHZhciBqc3hzMyA9IGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljOwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuanN4ID0ganN4MzsKICAgICAgICBleHBvcnRzLmpzeHMgPSBqc3hzMzsKICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvanN4LXJ1bnRpbWUuanMKdmFyIHJlcXVpcmVfanN4X3J1bnRpbWUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvanN4LXJ1bnRpbWUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9yZWFjdDUzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCksIDEpOwp2YXIgaW1wb3J0X2NsaWVudCA9IF9fdG9FU00ocmVxdWlyZV9jbGllbnQoKSwgMSk7CgovLyBzcmMvY29tcG9uZW50LnRzeAp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzCnZhciB0b0tlYmFiQ2FzZSA9IChzdHJpbmcpID0+IHN0cmluZy5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAiJDEtJDIiKS50b0xvd2VyQ2FzZSgpOwp2YXIgdG9DYW1lbENhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgKICAvXihbQS1aXSl8W1xzLV9dKyhcdykvZywKICAobWF0Y2gsIHAxLCBwMikgPT4gcDIgPyBwMi50b1VwcGVyQ2FzZSgpIDogcDEudG9Mb3dlckNhc2UoKQopOwp2YXIgdG9QYXNjYWxDYXNlID0gKHN0cmluZykgPT4gewogIGNvbnN0IGNhbWVsQ2FzZSA9IHRvQ2FtZWxDYXNlKHN0cmluZyk7CiAgcmV0dXJuIGNhbWVsQ2FzZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGNhbWVsQ2FzZS5zbGljZSgxKTsKfTsKdmFyIG1lcmdlQ2xhc3NlcyA9ICguLi5jbGFzc2VzKSA9PiBjbGFzc2VzLmZpbHRlcigoY2xhc3NOYW1lLCBpbmRleCwgYXJyYXkpID0+IHsKICByZXR1cm4gQm9vbGVhbihjbGFzc05hbWUpICYmIGNsYXNzTmFtZS50cmltKCkgIT09ICIiICYmIGFycmF5LmluZGV4T2YoY2xhc3NOYW1lKSA9PT0gaW5kZXg7Cn0pLmpvaW4oIiAiKS50cmltKCk7CnZhciBoYXNBMTF5UHJvcCA9IChwcm9wcykgPT4gewogIGZvciAoY29uc3QgcHJvcCBpbiBwcm9wcykgewogICAgaWYgKHByb3Auc3RhcnRzV2l0aCgiYXJpYS0iKSB8fCBwcm9wID09PSAicm9sZSIgfHwgcHJvcCA9PT0gInRpdGxlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgSWNvbiA9ICgwLCBpbXBvcnRfcmVhY3QuZm9yd2FyZFJlZikoCiAgKHsKICAgIGNvbG9yOiBjb2xvcjIgPSAiY3VycmVudENvbG9yIiwKICAgIHNpemUgPSAyNCwKICAgIHN0cm9rZVdpZHRoID0gMiwKICAgIGFic29sdXRlU3Ryb2tlV2lkdGgsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIGNoaWxkcmVuLAogICAgaWNvbk5vZGUsCiAgICAuLi5yZXN0CiAgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0LmNyZWF0ZUVsZW1lbnQpKAogICAgInN2ZyIsCiAgICB7CiAgICAgIHJlZiwKICAgICAgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsCiAgICAgIHdpZHRoOiBzaXplLAogICAgICBoZWlnaHQ6IHNpemUsCiAgICAgIHN0cm9rZTogY29sb3IyLAogICAgICBzdHJva2VXaWR0aDogYWJzb2x1dGVTdHJva2VXaWR0aCA/IE51bWJlcihzdHJva2VXaWR0aCkgKiAyNCAvIE51bWJlcihzaXplKSA6IHN0cm9rZVdpZHRoLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygibHVjaWRlIiwgY2xhc3NOYW1lKSwKICAgICAgLi4uIWNoaWxkcmVuICYmICFoYXNBMTF5UHJvcChyZXN0KSAmJiB7ICJhcmlhLWhpZGRlbiI6ICJ0cnVlIiB9LAogICAgICAuLi5yZXN0CiAgICB9LAogICAgWwogICAgICAuLi5pY29uTm9kZS5tYXAoKFt0YWcsIGF0dHJzXSkgPT4gKDAsIGltcG9ydF9yZWFjdC5jcmVhdGVFbGVtZW50KSh0YWcsIGF0dHJzKSksCiAgICAgIC4uLkFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gY2hpbGRyZW4gOiBbY2hpbGRyZW5dCiAgICBdCiAgKQopOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanMKdmFyIGNyZWF0ZUx1Y2lkZUljb24gPSAoaWNvbk5hbWUsIGljb25Ob2RlKSA9PiB7CiAgY29uc3QgQ29tcG9uZW50ID0gKDAsIGltcG9ydF9yZWFjdDIuZm9yd2FyZFJlZikoCiAgICAoeyBjbGFzc05hbWUsIC4uLnByb3BzIH0sIHJlZikgPT4gKDAsIGltcG9ydF9yZWFjdDIuY3JlYXRlRWxlbWVudCkoSWNvbiwgewogICAgICByZWYsCiAgICAgIGljb25Ob2RlLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygKICAgICAgICBgbHVjaWRlLSR7dG9LZWJhYkNhc2UodG9QYXNjYWxDYXNlKGljb25OYW1lKSl9YCwKICAgICAgICBgbHVjaWRlLSR7aWNvbk5hbWV9YCwKICAgICAgICBjbGFzc05hbWUKICAgICAgKSwKICAgICAgLi4ucHJvcHMKICAgIH0pCiAgKTsKICBDb21wb25lbnQuZGlzcGxheU5hbWUgPSB0b1Bhc2NhbENhc2UoaWNvbk5hbWUpOwogIHJldHVybiBDb21wb25lbnQ7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1kb3duLmpzCnZhciBfX2ljb25Ob2RlID0gW1sicGF0aCIsIHsgZDogIm02IDkgNiA2IDYtNiIsIGtleTogInFydW5zbCIgfV1dOwp2YXIgQ2hldnJvbkRvd24gPSBjcmVhdGVMdWNpZGVJY29uKCJjaGV2cm9uLWRvd24iLCBfX2ljb25Ob2RlKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtcXVlc3Rpb24tbWFyay5qcwp2YXIgX19pY29uTm9kZTIgPSBbCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjEwIiwga2V5OiAiMW1nbGF5IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOS4wOSA5YTMgMyAwIDAgMSA1LjgzIDFjMCAyLTMgMy0zIDMiLCBrZXk6ICIxdTc3M3MiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiAxN2guMDEiLCBrZXk6ICJwMzJwMDUiIH1dCl07CnZhciBDaXJjbGVRdWVzdGlvbk1hcmsgPSBjcmVhdGVMdWNpZGVJY29uKCJjaXJjbGUtcXVlc3Rpb24tbWFyayIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9oZWFydC5qcwp2YXIgX19pY29uTm9kZTMgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIgOS41YTUuNSA1LjUgMCAwIDEgOS41OTEtMy42NzYuNTYuNTYgMCAwIDAgLjgxOCAwQTUuNDkgNS40OSAwIDAgMSAyMiA5LjVjMCAyLjI5LTEuNSA0LTMgNS41bC01LjQ5MiA1LjMxM2EyIDIgMCAwIDEtMyAuMDE5TDUgMTVjLTEuNS0xLjUtMy0zLjItMy01LjUiLAogICAgICBrZXk6ICJtdnIxYTAiCiAgICB9CiAgXQpdOwp2YXIgSGVhcnQgPSBjcmVhdGVMdWNpZGVJY29uKCJoZWFydCIsIF9faWNvbk5vZGUzKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9sb2FkZXIuanMKdmFyIF9faWNvbk5vZGU0ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMiAydjQiLCBrZXk6ICIzNDI3aWMiIH1dLAogIFsicGF0aCIsIHsgZDogIm0xNi4yIDcuOCAyLjktMi45Iiwga2V5OiAicjcwMGFvIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTggMTJoNCIsIGtleTogIndqOXlraCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTE2LjIgMTYuMiAyLjkgMi45Iiwga2V5OiAiMWJ4ZzV0IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgMTh2NCIsIGtleTogImphZG12eiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTQuOSAxOS4xIDIuOS0yLjkiLCBrZXk6ICJid2l4OXEiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yIDEyaDQiLCBrZXk6ICJqMDlzaWkiIH1dLAogIFsicGF0aCIsIHsgZDogIm00LjkgNC45IDIuOSAyLjkiLCBrZXk6ICJnaXl1ZnIiIH1dCl07CnZhciBMb2FkZXIgPSBjcmVhdGVMdWNpZGVJY29uKCJsb2FkZXIiLCBfX2ljb25Ob2RlNCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWFpbC5qcwp2YXIgX19pY29uTm9kZTUgPSBbCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC45OTEgNS43MjdhMiAyIDAgMCAxLTIuMDA5IDBMMiA3Iiwga2V5OiAiMTMycTdxIiB9XSwKICBbInJlY3QiLCB7IHg6ICIyIiwgeTogIjQiLCB3aWR0aDogIjIwIiwgaGVpZ2h0OiAiMTYiLCByeDogIjIiLCBrZXk6ICJpenhsYW8iIH1dCl07CnZhciBNYWlsID0gY3JlYXRlTHVjaWRlSWNvbigibWFpbCIsIF9faWNvbk5vZGU1KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qcwp2YXIgX19pY29uTm9kZTYgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIyIDE3YTIgMiAwIDAgMS0yIDJINi44MjhhMiAyIDAgMCAwLTEuNDE0LjU4NmwtMi4yMDIgMi4yMDJBLjcxLjcxIDAgMCAxIDIgMjEuMjg2VjVhMiAyIDAgMCAxIDItMmgxNmEyIDIgMCAwIDEgMiAyeiIsCiAgICAgIGtleTogIjE4ODg3cCIKICAgIH0KICBdCl07CnZhciBNZXNzYWdlU3F1YXJlID0gY3JlYXRlTHVjaWRlSWNvbigibWVzc2FnZS1zcXVhcmUiLCBfX2ljb25Ob2RlNik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWludXMuanMKdmFyIF9faWNvbk5vZGU3ID0gW1sicGF0aCIsIHsgZDogIk01IDEyaDE0Iiwga2V5OiAiMWF5czBoIiB9XV07CnZhciBNaW51cyA9IGNyZWF0ZUx1Y2lkZUljb24oIm1pbnVzIiwgX19pY29uTm9kZTcpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsYXkuanMKdmFyIF9faWNvbk5vZGU4ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk01IDVhMiAyIDAgMCAxIDMuMDA4LTEuNzI4bDExLjk5NyA2Ljk5OGEyIDIgMCAwIDEgLjAwMyAzLjQ1OGwtMTIgN0EyIDIgMCAwIDEgNSAxOXoiLAogICAgICBrZXk6ICIxMGlrZjEiCiAgICB9CiAgXQpdOwp2YXIgUGxheSA9IGNyZWF0ZUx1Y2lkZUljb24oInBsYXkiLCBfX2ljb25Ob2RlOCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qcwp2YXIgX19pY29uTm9kZTkgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiA1djE0Iiwga2V5OiAiczY5OWxlIiB9XQpdOwp2YXIgUGx1cyA9IGNyZWF0ZUx1Y2lkZUljb24oInBsdXMiLCBfX2ljb25Ob2RlOSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcHJpbnRlci5qcwp2YXIgX19pY29uTm9kZTEwID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDE4SDRhMiAyIDAgMCAxLTItMnYtNWEyIDIgMCAwIDEgMi0yaDE2YTIgMiAwIDAgMSAyIDJ2NWEyIDIgMCAwIDEtMiAyaC0yIiwKICAgICAga2V5OiAiMTQzd3lkIgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTYgOVYzYTEgMSAwIDAgMSAxLTFoMTBhMSAxIDAgMCAxIDEgMXY2Iiwga2V5OiAiMWl0bmU3IiB9XSwKICBbInJlY3QiLCB7IHg6ICI2IiwgeTogIjE0Iiwgd2lkdGg6ICIxMiIsIGhlaWdodDogIjgiLCByeDogIjEiLCBrZXk6ICIxdWUwdGciIH1dCl07CnZhciBQcmludGVyID0gY3JlYXRlTHVjaWRlSWNvbigicHJpbnRlciIsIF9faWNvbk5vZGUxMCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvU3VyZmFjZS5qcwp2YXIgUmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2Nsc3hAMi4xLjEvbm9kZV9tb2R1bGVzL2Nsc3gvZGlzdC9jbHN4Lm1qcwpmdW5jdGlvbiByKGUpIHsKICB2YXIgdCwgZiwgbiA9ICIiOwogIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgZSB8fCAibnVtYmVyIiA9PSB0eXBlb2YgZSkgbiArPSBlOwogIGVsc2UgaWYgKCJvYmplY3QiID09IHR5cGVvZiBlKSBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgdmFyIG8gPSBlLmxlbmd0aDsKICAgIGZvciAodCA9IDA7IHQgPCBvOyB0KyspIGVbdF0gJiYgKGYgPSByKGVbdF0pKSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIH0gZWxzZSBmb3IgKGYgaW4gZSkgZVtmXSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIHJldHVybiBuOwp9CmZ1bmN0aW9uIGNsc3goKSB7CiAgZm9yICh2YXIgZSwgdCwgZiA9IDAsIG4gPSAiIiwgbyA9IGFyZ3VtZW50cy5sZW5ndGg7IGYgPCBvOyBmKyspIChlID0gYXJndW1lbnRzW2ZdKSAmJiAodCA9IHIoZSkpICYmIChuICYmIChuICs9ICIgIiksIG4gKz0gdCk7CiAgcmV0dXJuIG47Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc0FuZEV2ZW50cy5qcwp2YXIgaW1wb3J0X3JlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZXhjbHVkZUV2ZW50UHJvcHMuanMKdmFyIEV2ZW50S2V5cyA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAib25Db3B5IiwgIm9uQ29weUNhcHR1cmUiLCAib25DdXQiLCAib25DdXRDYXB0dXJlIiwgIm9uUGFzdGUiLCAib25QYXN0ZUNhcHR1cmUiLCAib25Db21wb3NpdGlvbkVuZCIsICJvbkNvbXBvc2l0aW9uRW5kQ2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uU3RhcnQiLCAib25Db21wb3NpdGlvblN0YXJ0Q2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgIm9uQ29tcG9zaXRpb25VcGRhdGVDYXB0dXJlIiwgIm9uRm9jdXMiLCAib25Gb2N1c0NhcHR1cmUiLCAib25CbHVyIiwgIm9uQmx1ckNhcHR1cmUiLCAib25DaGFuZ2UiLCAib25DaGFuZ2VDYXB0dXJlIiwgIm9uQmVmb3JlSW5wdXQiLCAib25CZWZvcmVJbnB1dENhcHR1cmUiLCAib25JbnB1dCIsICJvbklucHV0Q2FwdHVyZSIsICJvblJlc2V0IiwgIm9uUmVzZXRDYXB0dXJlIiwgIm9uU3VibWl0IiwgIm9uU3VibWl0Q2FwdHVyZSIsICJvbkludmFsaWQiLCAib25JbnZhbGlkQ2FwdHVyZSIsICJvbkxvYWQiLCAib25Mb2FkQ2FwdHVyZSIsICJvbkVycm9yIiwgIm9uRXJyb3JDYXB0dXJlIiwgIm9uS2V5RG93biIsICJvbktleURvd25DYXB0dXJlIiwgIm9uS2V5UHJlc3MiLCAib25LZXlQcmVzc0NhcHR1cmUiLCAib25LZXlVcCIsICJvbktleVVwQ2FwdHVyZSIsICJvbkFib3J0IiwgIm9uQWJvcnRDYXB0dXJlIiwgIm9uQ2FuUGxheSIsICJvbkNhblBsYXlDYXB0dXJlIiwgIm9uQ2FuUGxheVRocm91Z2giLCAib25DYW5QbGF5VGhyb3VnaENhcHR1cmUiLCAib25EdXJhdGlvbkNoYW5nZSIsICJvbkR1cmF0aW9uQ2hhbmdlQ2FwdHVyZSIsICJvbkVtcHRpZWQiLCAib25FbXB0aWVkQ2FwdHVyZSIsICJvbkVuY3J5cHRlZCIsICJvbkVuY3J5cHRlZENhcHR1cmUiLCAib25FbmRlZCIsICJvbkVuZGVkQ2FwdHVyZSIsICJvbkxvYWRlZERhdGEiLCAib25Mb2FkZWREYXRhQ2FwdHVyZSIsICJvbkxvYWRlZE1ldGFkYXRhIiwgIm9uTG9hZGVkTWV0YWRhdGFDYXB0dXJlIiwgIm9uTG9hZFN0YXJ0IiwgIm9uTG9hZFN0YXJ0Q2FwdHVyZSIsICJvblBhdXNlIiwgIm9uUGF1c2VDYXB0dXJlIiwgIm9uUGxheSIsICJvblBsYXlDYXB0dXJlIiwgIm9uUGxheWluZyIsICJvblBsYXlpbmdDYXB0dXJlIiwgIm9uUHJvZ3Jlc3MiLCAib25Qcm9ncmVzc0NhcHR1cmUiLCAib25SYXRlQ2hhbmdlIiwgIm9uUmF0ZUNoYW5nZUNhcHR1cmUiLCAib25TZWVrZWQiLCAib25TZWVrZWRDYXB0dXJlIiwgIm9uU2Vla2luZyIsICJvblNlZWtpbmdDYXB0dXJlIiwgIm9uU3RhbGxlZCIsICJvblN0YWxsZWRDYXB0dXJlIiwgIm9uU3VzcGVuZCIsICJvblN1c3BlbmRDYXB0dXJlIiwgIm9uVGltZVVwZGF0ZSIsICJvblRpbWVVcGRhdGVDYXB0dXJlIiwgIm9uVm9sdW1lQ2hhbmdlIiwgIm9uVm9sdW1lQ2hhbmdlQ2FwdHVyZSIsICJvbldhaXRpbmciLCAib25XYWl0aW5nQ2FwdHVyZSIsICJvbkF1eENsaWNrIiwgIm9uQXV4Q2xpY2tDYXB0dXJlIiwgIm9uQ2xpY2siLCAib25DbGlja0NhcHR1cmUiLCAib25Db250ZXh0TWVudSIsICJvbkNvbnRleHRNZW51Q2FwdHVyZSIsICJvbkRvdWJsZUNsaWNrIiwgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIiwgIm9uRHJhZyIsICJvbkRyYWdDYXB0dXJlIiwgIm9uRHJhZ0VuZCIsICJvbkRyYWdFbmRDYXB0dXJlIiwgIm9uRHJhZ0VudGVyIiwgIm9uRHJhZ0VudGVyQ2FwdHVyZSIsICJvbkRyYWdFeGl0IiwgIm9uRHJhZ0V4aXRDYXB0dXJlIiwgIm9uRHJhZ0xlYXZlIiwgIm9uRHJhZ0xlYXZlQ2FwdHVyZSIsICJvbkRyYWdPdmVyIiwgIm9uRHJhZ092ZXJDYXB0dXJlIiwgIm9uRHJhZ1N0YXJ0IiwgIm9uRHJhZ1N0YXJ0Q2FwdHVyZSIsICJvbkRyb3AiLCAib25Ecm9wQ2FwdHVyZSIsICJvbk1vdXNlRG93biIsICJvbk1vdXNlRG93bkNhcHR1cmUiLCAib25Nb3VzZUVudGVyIiwgIm9uTW91c2VMZWF2ZSIsICJvbk1vdXNlTW92ZSIsICJvbk1vdXNlTW92ZUNhcHR1cmUiLCAib25Nb3VzZU91dCIsICJvbk1vdXNlT3V0Q2FwdHVyZSIsICJvbk1vdXNlT3ZlciIsICJvbk1vdXNlT3ZlckNhcHR1cmUiLCAib25Nb3VzZVVwIiwgIm9uTW91c2VVcENhcHR1cmUiLCAib25TZWxlY3QiLCAib25TZWxlY3RDYXB0dXJlIiwgIm9uVG91Y2hDYW5jZWwiLCAib25Ub3VjaENhbmNlbENhcHR1cmUiLCAib25Ub3VjaEVuZCIsICJvblRvdWNoRW5kQ2FwdHVyZSIsICJvblRvdWNoTW92ZSIsICJvblRvdWNoTW92ZUNhcHR1cmUiLCAib25Ub3VjaFN0YXJ0IiwgIm9uVG91Y2hTdGFydENhcHR1cmUiLCAib25Qb2ludGVyRG93biIsICJvblBvaW50ZXJEb3duQ2FwdHVyZSIsICJvblBvaW50ZXJNb3ZlIiwgIm9uUG9pbnRlck1vdmVDYXB0dXJlIiwgIm9uUG9pbnRlclVwIiwgIm9uUG9pbnRlclVwQ2FwdHVyZSIsICJvblBvaW50ZXJDYW5jZWwiLCAib25Qb2ludGVyQ2FuY2VsQ2FwdHVyZSIsICJvblBvaW50ZXJFbnRlciIsICJvblBvaW50ZXJFbnRlckNhcHR1cmUiLCAib25Qb2ludGVyTGVhdmUiLCAib25Qb2ludGVyTGVhdmVDYXB0dXJlIiwgIm9uUG9pbnRlck92ZXIiLCAib25Qb2ludGVyT3ZlckNhcHR1cmUiLCAib25Qb2ludGVyT3V0IiwgIm9uUG9pbnRlck91dENhcHR1cmUiLCAib25Hb3RQb2ludGVyQ2FwdHVyZSIsICJvbkdvdFBvaW50ZXJDYXB0dXJlQ2FwdHVyZSIsICJvbkxvc3RQb2ludGVyQ2FwdHVyZSIsICJvbkxvc3RQb2ludGVyQ2FwdHVyZUNhcHR1cmUiLCAib25TY3JvbGwiLCAib25TY3JvbGxDYXB0dXJlIiwgIm9uV2hlZWwiLCAib25XaGVlbENhcHR1cmUiLCAib25BbmltYXRpb25TdGFydCIsICJvbkFuaW1hdGlvblN0YXJ0Q2FwdHVyZSIsICJvbkFuaW1hdGlvbkVuZCIsICJvbkFuaW1hdGlvbkVuZENhcHR1cmUiLCAib25BbmltYXRpb25JdGVyYXRpb24iLCAib25BbmltYXRpb25JdGVyYXRpb25DYXB0dXJlIiwgIm9uVHJhbnNpdGlvbkVuZCIsICJvblRyYW5zaXRpb25FbmRDYXB0dXJlIl07CmZ1bmN0aW9uIGlzRXZlbnRLZXkoa2V5KSB7CiAgaWYgKHR5cGVvZiBrZXkgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBhbGxvd2VkRXZlbnRLZXlzID0gRXZlbnRLZXlzOwogIHJldHVybiBhbGxvd2VkRXZlbnRLZXlzLmluY2x1ZGVzKGtleSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc05vRXZlbnRzLmpzCnZhciBpbXBvcnRfcmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgU1ZHRWxlbWVudFByb3BLZXlzID0gWwogICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLAogICJhcmlhLWF0b21pYyIsCiAgImFyaWEtYXV0b2NvbXBsZXRlIiwKICAiYXJpYS1idXN5IiwKICAiYXJpYS1jaGVja2VkIiwKICAiYXJpYS1jb2xjb3VudCIsCiAgImFyaWEtY29saW5kZXgiLAogICJhcmlhLWNvbHNwYW4iLAogICJhcmlhLWNvbnRyb2xzIiwKICAiYXJpYS1jdXJyZW50IiwKICAiYXJpYS1kZXNjcmliZWRieSIsCiAgImFyaWEtZGV0YWlscyIsCiAgImFyaWEtZGlzYWJsZWQiLAogICJhcmlhLWVycm9ybWVzc2FnZSIsCiAgImFyaWEtZXhwYW5kZWQiLAogICJhcmlhLWZsb3d0byIsCiAgImFyaWEtaGFzcG9wdXAiLAogICJhcmlhLWhpZGRlbiIsCiAgImFyaWEtaW52YWxpZCIsCiAgImFyaWEta2V5c2hvcnRjdXRzIiwKICAiYXJpYS1sYWJlbCIsCiAgImFyaWEtbGFiZWxsZWRieSIsCiAgImFyaWEtbGV2ZWwiLAogICJhcmlhLWxpdmUiLAogICJhcmlhLW1vZGFsIiwKICAiYXJpYS1tdWx0aWxpbmUiLAogICJhcmlhLW11bHRpc2VsZWN0YWJsZSIsCiAgImFyaWEtb3JpZW50YXRpb24iLAogICJhcmlhLW93bnMiLAogICJhcmlhLXBsYWNlaG9sZGVyIiwKICAiYXJpYS1wb3NpbnNldCIsCiAgImFyaWEtcHJlc3NlZCIsCiAgImFyaWEtcmVhZG9ubHkiLAogICJhcmlhLXJlbGV2YW50IiwKICAiYXJpYS1yZXF1aXJlZCIsCiAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIiwKICAiYXJpYS1yb3djb3VudCIsCiAgImFyaWEtcm93aW5kZXgiLAogICJhcmlhLXJvd3NwYW4iLAogICJhcmlhLXNlbGVjdGVkIiwKICAiYXJpYS1zZXRzaXplIiwKICAiYXJpYS1zb3J0IiwKICAiYXJpYS12YWx1ZW1heCIsCiAgImFyaWEtdmFsdWVtaW4iLAogICJhcmlhLXZhbHVlbm93IiwKICAiYXJpYS12YWx1ZXRleHQiLAogICJjbGFzc05hbWUiLAogICJjb2xvciIsCiAgImhlaWdodCIsCiAgImlkIiwKICAibGFuZyIsCiAgIm1heCIsCiAgIm1lZGlhIiwKICAibWV0aG9kIiwKICAibWluIiwKICAibmFtZSIsCiAgInN0eWxlIiwKICAvKgogICAqIHJlbW92ZWQgJ3R5cGUnIFNWR0VsZW1lbnRQcm9wS2V5IGJlY2F1c2Ugd2UgZG8gbm90IGN1cnJlbnRseSB1c2UgYW55IFNWRyBlbGVtZW50cwogICAqIHRoYXQgY2FuIHVzZSBpdCwgYW5kIGl0IGNvbmZsaWN0cyB3aXRoIHRoZSByZWNoYXJ0cyBwcm9wICd0eXBlJwogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzMzMjcKICAgKiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9TVkcvQXR0cmlidXRlL3R5cGUKICAgKi8KICAvLyAndHlwZScsCiAgInRhcmdldCIsCiAgIndpZHRoIiwKICAicm9sZSIsCiAgInRhYkluZGV4IiwKICAiYWNjZW50SGVpZ2h0IiwKICAiYWNjdW11bGF0ZSIsCiAgImFkZGl0aXZlIiwKICAiYWxpZ25tZW50QmFzZWxpbmUiLAogICJhbGxvd1Jlb3JkZXIiLAogICJhbHBoYWJldGljIiwKICAiYW1wbGl0dWRlIiwKICAiYXJhYmljRm9ybSIsCiAgImFzY2VudCIsCiAgImF0dHJpYnV0ZU5hbWUiLAogICJhdHRyaWJ1dGVUeXBlIiwKICAiYXV0b1JldmVyc2UiLAogICJhemltdXRoIiwKICAiYmFzZUZyZXF1ZW5jeSIsCiAgImJhc2VsaW5lU2hpZnQiLAogICJiYXNlUHJvZmlsZSIsCiAgImJib3giLAogICJiZWdpbiIsCiAgImJpYXMiLAogICJieSIsCiAgImNhbGNNb2RlIiwKICAiY2FwSGVpZ2h0IiwKICAiY2xpcCIsCiAgImNsaXBQYXRoIiwKICAiY2xpcFBhdGhVbml0cyIsCiAgImNsaXBSdWxlIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgImNvbG9yUHJvZmlsZSIsCiAgImNvbG9yUmVuZGVyaW5nIiwKICAiY29udGVudFNjcmlwdFR5cGUiLAogICJjb250ZW50U3R5bGVUeXBlIiwKICAiY3Vyc29yIiwKICAiY3giLAogICJjeSIsCiAgImQiLAogICJkZWNlbGVyYXRlIiwKICAiZGVzY2VudCIsCiAgImRpZmZ1c2VDb25zdGFudCIsCiAgImRpcmVjdGlvbiIsCiAgImRpc3BsYXkiLAogICJkaXZpc29yIiwKICAiZG9taW5hbnRCYXNlbGluZSIsCiAgImR1ciIsCiAgImR4IiwKICAiZHkiLAogICJlZGdlTW9kZSIsCiAgImVsZXZhdGlvbiIsCiAgImVuYWJsZUJhY2tncm91bmQiLAogICJlbmQiLAogICJleHBvbmVudCIsCiAgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICJmaWxsIiwKICAiZmlsbE9wYWNpdHkiLAogICJmaWxsUnVsZSIsCiAgImZpbHRlciIsCiAgImZpbHRlclJlcyIsCiAgImZpbHRlclVuaXRzIiwKICAiZmxvb2RDb2xvciIsCiAgImZsb29kT3BhY2l0eSIsCiAgImZvY3VzYWJsZSIsCiAgImZvbnRGYW1pbHkiLAogICJmb250U2l6ZSIsCiAgImZvbnRTaXplQWRqdXN0IiwKICAiZm9udFN0cmV0Y2giLAogICJmb250U3R5bGUiLAogICJmb250VmFyaWFudCIsCiAgImZvbnRXZWlnaHQiLAogICJmb3JtYXQiLAogICJmcm9tIiwKICAiZngiLAogICJmeSIsCiAgImcxIiwKICAiZzIiLAogICJnbHlwaE5hbWUiLAogICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgImdseXBoUmVmIiwKICAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICJncmFkaWVudFVuaXRzIiwKICAiaGFuZ2luZyIsCiAgImhvcml6QWR2WCIsCiAgImhvcml6T3JpZ2luWCIsCiAgImhyZWYiLAogICJpZGVvZ3JhcGhpYyIsCiAgImltYWdlUmVuZGVyaW5nIiwKICAiaW4yIiwKICAiaW4iLAogICJpbnRlcmNlcHQiLAogICJrMSIsCiAgImsyIiwKICAiazMiLAogICJrNCIsCiAgImsiLAogICJrZXJuZWxNYXRyaXgiLAogICJrZXJuZWxVbml0TGVuZ3RoIiwKICAia2VybmluZyIsCiAgImtleVBvaW50cyIsCiAgImtleVNwbGluZXMiLAogICJrZXlUaW1lcyIsCiAgImxlbmd0aEFkanVzdCIsCiAgImxldHRlclNwYWNpbmciLAogICJsaWdodGluZ0NvbG9yIiwKICAibGltaXRpbmdDb25lQW5nbGUiLAogICJsb2NhbCIsCiAgIm1hcmtlckVuZCIsCiAgIm1hcmtlckhlaWdodCIsCiAgIm1hcmtlck1pZCIsCiAgIm1hcmtlclN0YXJ0IiwKICAibWFya2VyVW5pdHMiLAogICJtYXJrZXJXaWR0aCIsCiAgIm1hc2siLAogICJtYXNrQ29udGVudFVuaXRzIiwKICAibWFza1VuaXRzIiwKICAibWF0aGVtYXRpY2FsIiwKICAibW9kZSIsCiAgIm51bU9jdGF2ZXMiLAogICJvZmZzZXQiLAogICJvcGFjaXR5IiwKICAib3BlcmF0b3IiLAogICJvcmRlciIsCiAgIm9yaWVudCIsCiAgIm9yaWVudGF0aW9uIiwKICAib3JpZ2luIiwKICAib3ZlcmZsb3ciLAogICJvdmVybGluZVBvc2l0aW9uIiwKICAib3ZlcmxpbmVUaGlja25lc3MiLAogICJwYWludE9yZGVyIiwKICAicGFub3NlMSIsCiAgInBhdGhMZW5ndGgiLAogICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAicGF0dGVyblRyYW5zZm9ybSIsCiAgInBhdHRlcm5Vbml0cyIsCiAgInBvaW50ZXJFdmVudHMiLAogICJwb2ludHNBdFgiLAogICJwb2ludHNBdFkiLAogICJwb2ludHNBdFoiLAogICJwcmVzZXJ2ZUFscGhhIiwKICAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgInByaW1pdGl2ZVVuaXRzIiwKICAiciIsCiAgInJhZGl1cyIsCiAgInJlZlgiLAogICJyZWZZIiwKICAicmVuZGVyaW5nSW50ZW50IiwKICAicmVwZWF0Q291bnQiLAogICJyZXBlYXREdXIiLAogICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICJyZXF1aXJlZEZlYXR1cmVzIiwKICAicmVzdGFydCIsCiAgInJlc3VsdCIsCiAgInJvdGF0ZSIsCiAgInJ4IiwKICAicnkiLAogICJzZWVkIiwKICAic2hhcGVSZW5kZXJpbmciLAogICJzbG9wZSIsCiAgInNwYWNpbmciLAogICJzcGVjdWxhckNvbnN0YW50IiwKICAic3BlY3VsYXJFeHBvbmVudCIsCiAgInNwZWVkIiwKICAic3ByZWFkTWV0aG9kIiwKICAic3RhcnRPZmZzZXQiLAogICJzdGREZXZpYXRpb24iLAogICJzdGVtaCIsCiAgInN0ZW12IiwKICAic3RpdGNoVGlsZXMiLAogICJzdG9wQ29sb3IiLAogICJzdG9wT3BhY2l0eSIsCiAgInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICJzdHJpbmciLAogICJzdHJva2UiLAogICJzdHJva2VEYXNoYXJyYXkiLAogICJzdHJva2VEYXNob2Zmc2V0IiwKICAic3Ryb2tlTGluZWNhcCIsCiAgInN0cm9rZUxpbmVqb2luIiwKICAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgInN0cm9rZU9wYWNpdHkiLAogICJzdHJva2VXaWR0aCIsCiAgInN1cmZhY2VTY2FsZSIsCiAgInN5c3RlbUxhbmd1YWdlIiwKICAidGFibGVWYWx1ZXMiLAogICJ0YXJnZXRYIiwKICAidGFyZ2V0WSIsCiAgInRleHRBbmNob3IiLAogICJ0ZXh0RGVjb3JhdGlvbiIsCiAgInRleHRMZW5ndGgiLAogICJ0ZXh0UmVuZGVyaW5nIiwKICAidG8iLAogICJ0cmFuc2Zvcm0iLAogICJ1MSIsCiAgInUyIiwKICAidW5kZXJsaW5lUG9zaXRpb24iLAogICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICJ1bmljb2RlIiwKICAidW5pY29kZUJpZGkiLAogICJ1bmljb2RlUmFuZ2UiLAogICJ1bml0c1BlckVtIiwKICAidkFscGhhYmV0aWMiLAogICJ2YWx1ZXMiLAogICJ2ZWN0b3JFZmZlY3QiLAogICJ2ZXJzaW9uIiwKICAidmVydEFkdlkiLAogICJ2ZXJ0T3JpZ2luWCIsCiAgInZlcnRPcmlnaW5ZIiwKICAidkhhbmdpbmciLAogICJ2SWRlb2dyYXBoaWMiLAogICJ2aWV3VGFyZ2V0IiwKICAidmlzaWJpbGl0eSIsCiAgInZNYXRoZW1hdGljYWwiLAogICJ3aWR0aHMiLAogICJ3b3JkU3BhY2luZyIsCiAgIndyaXRpbmdNb2RlIiwKICAieDEiLAogICJ4MiIsCiAgIngiLAogICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAieEhlaWdodCIsCiAgInhsaW5rQWN0dWF0ZSIsCiAgInhsaW5rQXJjcm9sZSIsCiAgInhsaW5rSHJlZiIsCiAgInhsaW5rUm9sZSIsCiAgInhsaW5rU2hvdyIsCiAgInhsaW5rVGl0bGUiLAogICJ4bGlua1R5cGUiLAogICJ4bWxCYXNlIiwKICAieG1sTGFuZyIsCiAgInhtbG5zIiwKICAieG1sbnNYbGluayIsCiAgInhtbFNwYWNlIiwKICAieTEiLAogICJ5MiIsCiAgInkiLAogICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAieiIsCiAgInpvb21BbmRQYW4iLAogICJyZWYiLAogICJrZXkiLAogICJhbmdsZSIKXTsKdmFyIFNWR0VsZW1lbnRQcm9wS2V5U2V0ID0gbmV3IFNldChTVkdFbGVtZW50UHJvcEtleXMpOwpmdW5jdGlvbiBpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gU1ZHRWxlbWVudFByb3BLZXlTZXQuaGFzKGtleSk7Cn0KZnVuY3Rpb24gaXNEYXRhQXR0cmlidXRlKGtleSkgewogIHJldHVybiB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiAmJiBrZXkuc3RhcnRzV2l0aCgiZGF0YS0iKTsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkgewogICAgcmV0dXJuIHt9OwogIH0KICB2YXIgcmVzdWx0ID0ge307CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgaWYgKGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB8fCBpc0RhdGFBdHRyaWJ1dGUoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gb2JqW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0My5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpICYmIHR5cGVvZiBpbnB1dC5wcm9wcyA9PT0gIm9iamVjdCIgJiYgaW5wdXQucHJvcHMgIT09IG51bGwpIHsKICAgIHZhciBwID0gaW5wdXQucHJvcHM7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc05vRXZlbnRzKHApOwogIH0KICBpZiAodHlwZW9mIGlucHV0ID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdmdQcm9wZXJ0aWVzQW5kRXZlbnRzLmpzCmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob2JqKSB7CiAgdmFyIHJlc3VsdCA9IHt9OwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7CiAgICAgIGlmIChpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgfHwgaXNEYXRhQXR0cmlidXRlKGtleSkgfHwgaXNFdmVudEtleShrZXkpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NC5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhpbnB1dC5wcm9wcyk7CiAgfQogIGlmICh0eXBlb2YgaW5wdXQgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KGlucHV0KSkgewogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1N1cmZhY2UuanMKdmFyIF9leGNsdWRlZCA9IFsiY2hpbGRyZW4iLCAid2lkdGgiLCAiaGVpZ2h0IiwgInZpZXdCb3giLCAiY2xhc3NOYW1lIiwgInN0eWxlIiwgInRpdGxlIiwgImRlc2MiXTsKZnVuY3Rpb24gX2V4dGVuZHMoKSB7CiAgcmV0dXJuIF9leHRlbmRzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgU3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NS5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdmlld0JveCwKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMocHJvcHMsIF9leGNsdWRlZCk7CiAgdmFyIHN2Z1ZpZXcgPSB2aWV3Qm94IHx8IHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeDogMCwKICAgIHk6IDAKICB9OwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtc3VyZmFjZSIsIGNsYXNzTmFtZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJzdmciLCBfZXh0ZW5kcyh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN0eWxlLAogICAgdmlld0JveDogIiIuY29uY2F0KHN2Z1ZpZXcueCwgIiAiKS5jb25jYXQoc3ZnVmlldy55LCAiICIpLmNvbmNhdChzdmdWaWV3LndpZHRoLCAiICIpLmNvbmNhdChzdmdWaWV3LmhlaWdodCksCiAgICByZWYKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoInRpdGxlIiwgbnVsbCwgdGl0bGUpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgiZGVzYyIsIG51bGwsIGRlc2MpLCBjaGlsZHJlbik7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL0xheWVyLmpzCnZhciBSZWFjdDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQyID0gWyJjaGlsZHJlbiIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHMyKCkgewogIHJldHVybiBfZXh0ZW5kczIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgTGF5ZXIgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmZvcndhcmRSZWYoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczIocHJvcHMsIF9leGNsdWRlZDIpOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtbGF5ZXIiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmNyZWF0ZUVsZW1lbnQoImciLCBfZXh0ZW5kczIoewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzCiAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICByZWYKICB9KSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvbGVnZW5kUG9ydGFsQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIExlZ2VuZFBvcnRhbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDYuY3JlYXRlQ29udGV4dCkobnVsbCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jb25zdGFudC5qcwpmdW5jdGlvbiBjb25zdGFudF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbnN0YW50KCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1wYXRoQDMuMS4wL25vZGVfbW9kdWxlcy9kMy1wYXRoL3NyYy9wYXRoLmpzCnZhciBwaSA9IE1hdGguUEk7CnZhciB0YXUgPSAyICogcGk7CnZhciBlcHNpbG9uID0gMWUtNjsKdmFyIHRhdUVwc2lsb24gPSB0YXUgLSBlcHNpbG9uOwpmdW5jdGlvbiBhcHBlbmQoc3RyaW5ncykgewogIHRoaXMuXyArPSBzdHJpbmdzWzBdOwogIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgIHRoaXMuXyArPSBhcmd1bWVudHNbaV0gKyBzdHJpbmdzW2ldOwogIH0KfQpmdW5jdGlvbiBhcHBlbmRSb3VuZChkaWdpdHMpIHsKICBsZXQgZCA9IE1hdGguZmxvb3IoZGlnaXRzKTsKICBpZiAoIShkID49IDApKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgZGlnaXRzOiAke2RpZ2l0c31gKTsKICBpZiAoZCA+IDE1KSByZXR1cm4gYXBwZW5kOwogIGNvbnN0IGsgPSAxMCAqKiBkOwogIHJldHVybiBmdW5jdGlvbihzdHJpbmdzKSB7CiAgICB0aGlzLl8gKz0gc3RyaW5nc1swXTsKICAgIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgICAgdGhpcy5fICs9IE1hdGgucm91bmQoYXJndW1lbnRzW2ldICogaykgLyBrICsgc3RyaW5nc1tpXTsKICAgIH0KICB9Owp9CnZhciBQYXRoID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGRpZ2l0cykgewogICAgdGhpcy5feDAgPSB0aGlzLl95MCA9IC8vIHN0YXJ0IG9mIGN1cnJlbnQgc3VicGF0aAogICAgdGhpcy5feDEgPSB0aGlzLl95MSA9IG51bGw7CiAgICB0aGlzLl8gPSAiIjsKICAgIHRoaXMuX2FwcGVuZCA9IGRpZ2l0cyA9PSBudWxsID8gYXBwZW5kIDogYXBwZW5kUm91bmQoZGlnaXRzKTsKICB9CiAgbW92ZVRvKHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBjbG9zZVBhdGgoKSB7CiAgICBpZiAodGhpcy5feDEgIT09IG51bGwpIHsKICAgICAgdGhpcy5feDEgPSB0aGlzLl94MCwgdGhpcy5feTEgPSB0aGlzLl95MDsKICAgICAgdGhpcy5fYXBwZW5kYFpgOwogICAgfQogIH0KICBsaW5lVG8oeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgTCR7dGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTEgPSAreTJ9YDsKICB9CiAgcXVhZHJhdGljQ3VydmVUbyh4MSwgeTEsIHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYFEkeyt4MX0sJHsreTF9LCR7dGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTEgPSAreTJ9YDsKICB9CiAgYmV6aWVyQ3VydmVUbyh4MSwgeTEsIHgyLCB5MiwgeDMsIHkzKSB7CiAgICB0aGlzLl9hcHBlbmRgQyR7K3gxfSwkeyt5MX0sJHsreDJ9LCR7K3kyfSwke3RoaXMuX3gxID0gK3gzfSwke3RoaXMuX3kxID0gK3kzfWA7CiAgfQogIGFyY1RvKHgxLCB5MSwgeDIsIHkyLCByMikgewogICAgeDEgPSAreDEsIHkxID0gK3kxLCB4MiA9ICt4MiwgeTIgPSAreTIsIHIyID0gK3IyOwogICAgaWYgKHIyIDwgMCkgdGhyb3cgbmV3IEVycm9yKGBuZWdhdGl2ZSByYWRpdXM6ICR7cjJ9YCk7CiAgICBsZXQgeDAgPSB0aGlzLl94MSwgeTAgPSB0aGlzLl95MSwgeDIxID0geDIgLSB4MSwgeTIxID0geTIgLSB5MSwgeDAxID0geDAgLSB4MSwgeTAxID0geTAgLSB5MSwgbDAxXzIgPSB4MDEgKiB4MDEgKyB5MDEgKiB5MDE7CiAgICBpZiAodGhpcy5feDEgPT09IG51bGwpIHsKICAgICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gxID0geDF9LCR7dGhpcy5feTEgPSB5MX1gOwogICAgfSBlbHNlIGlmICghKGwwMV8yID4gZXBzaWxvbikpIDsKICAgIGVsc2UgaWYgKCEoTWF0aC5hYnMoeTAxICogeDIxIC0geTIxICogeDAxKSA+IGVwc2lsb24pIHx8ICFyMikgewogICAgICB0aGlzLl9hcHBlbmRgTCR7dGhpcy5feDEgPSB4MX0sJHt0aGlzLl95MSA9IHkxfWA7CiAgICB9IGVsc2UgewogICAgICBsZXQgeDIwID0geDIgLSB4MCwgeTIwID0geTIgLSB5MCwgbDIxXzIgPSB4MjEgKiB4MjEgKyB5MjEgKiB5MjEsIGwyMF8yID0geDIwICogeDIwICsgeTIwICogeTIwLCBsMjEgPSBNYXRoLnNxcnQobDIxXzIpLCBsMDEgPSBNYXRoLnNxcnQobDAxXzIpLCBsID0gcjIgKiBNYXRoLnRhbigocGkgLSBNYXRoLmFjb3MoKGwyMV8yICsgbDAxXzIgLSBsMjBfMikgLyAoMiAqIGwyMSAqIGwwMSkpKSAvIDIpLCB0MDEgPSBsIC8gbDAxLCB0MjEgPSBsIC8gbDIxOwogICAgICBpZiAoTWF0aC5hYnModDAxIC0gMSkgPiBlcHNpbG9uKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kYEwke3gxICsgdDAxICogeDAxfSwke3kxICsgdDAxICogeTAxfWA7CiAgICAgIH0KICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDAsJHsrKHkwMSAqIHgyMCA+IHgwMSAqIHkyMCl9LCR7dGhpcy5feDEgPSB4MSArIHQyMSAqIHgyMX0sJHt0aGlzLl95MSA9IHkxICsgdDIxICogeTIxfWA7CiAgICB9CiAgfQogIGFyYyh4MiwgeTIsIHIyLCBhMCwgYTEsIGNjdykgewogICAgeDIgPSAreDIsIHkyID0gK3kyLCByMiA9ICtyMiwgY2N3ID0gISFjY3c7CiAgICBpZiAocjIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5lZ2F0aXZlIHJhZGl1czogJHtyMn1gKTsKICAgIGxldCBkeCA9IHIyICogTWF0aC5jb3MoYTApLCBkeSA9IHIyICogTWF0aC5zaW4oYTApLCB4MCA9IHgyICsgZHgsIHkwID0geTIgKyBkeSwgY3cgPSAxIF4gY2N3LCBkYSA9IGNjdyA/IGEwIC0gYTEgOiBhMSAtIGEwOwogICAgaWYgKHRoaXMuX3gxID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBNJHt4MH0sJHt5MH1gOwogICAgfSBlbHNlIGlmIChNYXRoLmFicyh0aGlzLl94MSAtIHgwKSA+IGVwc2lsb24gfHwgTWF0aC5hYnModGhpcy5feTEgLSB5MCkgPiBlcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBMJHt4MH0sJHt5MH1gOwogICAgfQogICAgaWYgKCFyMikgcmV0dXJuOwogICAgaWYgKGRhIDwgMCkgZGEgPSBkYSAlIHRhdSArIHRhdTsKICAgIGlmIChkYSA+IHRhdUVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDEsJHtjd30sJHt4MiAtIGR4fSwke3kyIC0gZHl9QSR7cjJ9LCR7cjJ9LDAsMSwke2N3fSwke3RoaXMuX3gxID0geDB9LCR7dGhpcy5feTEgPSB5MH1gOwogICAgfSBlbHNlIGlmIChkYSA+IGVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLCR7KyhkYSA+PSBwaSl9LCR7Y3d9LCR7dGhpcy5feDEgPSB4MiArIHIyICogTWF0aC5jb3MoYTEpfSwke3RoaXMuX3kxID0geTIgKyByMiAqIE1hdGguc2luKGExKX1gOwogICAgfQogIH0KICByZWN0KHgyLCB5MiwgdywgaCkgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1oJHt3ID0gK3d9diR7K2h9aCR7LXd9WmA7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuXzsKICB9Cn07CmZ1bmN0aW9uIHBhdGgoKSB7CiAgcmV0dXJuIG5ldyBQYXRoKCk7Cn0KcGF0aC5wcm90b3R5cGUgPSBQYXRoLnByb3RvdHlwZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3BhdGguanMKZnVuY3Rpb24gd2l0aFBhdGgoc2hhcGUpIHsKICBsZXQgZGlnaXRzID0gMzsKICBzaGFwZS5kaWdpdHMgPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkaWdpdHM7CiAgICBpZiAoXyA9PSBudWxsKSB7CiAgICAgIGRpZ2l0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBkID0gTWF0aC5mbG9vcihfKTsKICAgICAgaWYgKCEoZCA+PSAwKSkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoYGludmFsaWQgZGlnaXRzOiAke199YCk7CiAgICAgIGRpZ2l0cyA9IGQ7CiAgICB9CiAgICByZXR1cm4gc2hhcGU7CiAgfTsKICByZXR1cm4gKCkgPT4gbmV3IFBhdGgoZGlnaXRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJyYXkuanMKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwpmdW5jdGlvbiBhcnJheV9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gIm9iamVjdCIgJiYgImxlbmd0aCIgaW4geDIgPyB4MiA6IEFycmF5LmZyb20oeDIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXIuanMKZnVuY3Rpb24gTGluZWFyKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXIucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXIoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3BvaW50LmpzCmZ1bmN0aW9uIHgocCkgewogIHJldHVybiBwWzBdOwp9CmZ1bmN0aW9uIHkocCkgewogIHJldHVybiBwWzFdOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9saW5lLmpzCmZ1bmN0aW9uIGxpbmVfZGVmYXVsdCh4MiwgeTIpIHsKICB2YXIgZGVmaW5lZDIgPSBjb25zdGFudF9kZWZhdWx0KHRydWUpLCBjb250ZXh0ID0gbnVsbCwgY3VydmUgPSBsaW5lYXJfZGVmYXVsdCwgb3V0cHV0ID0gbnVsbCwgcGF0aDIgPSB3aXRoUGF0aChsaW5lKTsKICB4MiA9IHR5cGVvZiB4MiA9PT0gImZ1bmN0aW9uIiA/IHgyIDogeDIgPT09IHZvaWQgMCA/IHggOiBjb25zdGFudF9kZWZhdWx0KHgyKTsKICB5MiA9IHR5cGVvZiB5MiA9PT0gImZ1bmN0aW9uIiA/IHkyIDogeTIgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KHkyKTsKICBmdW5jdGlvbiBsaW5lKGRhdGEpIHsKICAgIHZhciBpLCBuID0gKGRhdGEgPSBhcnJheV9kZWZhdWx0KGRhdGEpKS5sZW5ndGgsIGQsIGRlZmluZWQwID0gZmFsc2UsIGJ1ZmZlcjsKICAgIGlmIChjb250ZXh0ID09IG51bGwpIG91dHB1dCA9IGN1cnZlKGJ1ZmZlciA9IHBhdGgyKCkpOwogICAgZm9yIChpID0gMDsgaSA8PSBuOyArK2kpIHsKICAgICAgaWYgKCEoaSA8IG4gJiYgZGVmaW5lZDIoZCA9IGRhdGFbaV0sIGksIGRhdGEpKSA9PT0gZGVmaW5lZDApIHsKICAgICAgICBpZiAoZGVmaW5lZDAgPSAhZGVmaW5lZDApIG91dHB1dC5saW5lU3RhcnQoKTsKICAgICAgICBlbHNlIG91dHB1dC5saW5lRW5kKCk7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQwKSBvdXRwdXQucG9pbnQoK3gyKGQsIGksIGRhdGEpLCAreTIoZCwgaSwgZGF0YSkpOwogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGxpbmUueCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGxpbmUpIDogeDI7CiAgfTsKICBsaW5lLnkgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBsaW5lKSA6IHkyOwogIH07CiAgbGluZS5kZWZpbmVkID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGVmaW5lZDIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCEhXyksIGxpbmUpIDogZGVmaW5lZDI7CiAgfTsKICBsaW5lLmN1cnZlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY3VydmUgPSBfLCBjb250ZXh0ICE9IG51bGwgJiYgKG91dHB1dCA9IGN1cnZlKGNvbnRleHQpKSwgbGluZSkgOiBjdXJ2ZTsKICB9OwogIGxpbmUuY29udGV4dCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKF8gPT0gbnVsbCA/IGNvbnRleHQgPSBvdXRwdXQgPSBudWxsIDogb3V0cHV0ID0gY3VydmUoY29udGV4dCA9IF8pLCBsaW5lKSA6IGNvbnRleHQ7CiAgfTsKICByZXR1cm4gbGluZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJlYS5qcwpmdW5jdGlvbiBhcmVhX2RlZmF1bHQoeDAsIHkwLCB5MSkgewogIHZhciB4MSA9IG51bGwsIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgoYXJlYSk7CiAgeDAgPSB0eXBlb2YgeDAgPT09ICJmdW5jdGlvbiIgPyB4MCA6IHgwID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCgreDApOwogIHkwID0gdHlwZW9mIHkwID09PSAiZnVuY3Rpb24iID8geTAgOiB5MCA9PT0gdm9pZCAwID8gY29uc3RhbnRfZGVmYXVsdCgwKSA6IGNvbnN0YW50X2RlZmF1bHQoK3kwKTsKICB5MSA9IHR5cGVvZiB5MSA9PT0gImZ1bmN0aW9uIiA/IHkxIDogeTEgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KCt5MSk7CiAgZnVuY3Rpb24gYXJlYShkYXRhKSB7CiAgICB2YXIgaSwgaiwgaywgbiA9IChkYXRhID0gYXJyYXlfZGVmYXVsdChkYXRhKSkubGVuZ3RoLCBkLCBkZWZpbmVkMCA9IGZhbHNlLCBidWZmZXIsIHgweiA9IG5ldyBBcnJheShuKSwgeTB6ID0gbmV3IEFycmF5KG4pOwogICAgaWYgKGNvbnRleHQgPT0gbnVsbCkgb3V0cHV0ID0gY3VydmUoYnVmZmVyID0gcGF0aDIoKSk7CiAgICBmb3IgKGkgPSAwOyBpIDw9IG47ICsraSkgewogICAgICBpZiAoIShpIDwgbiAmJiBkZWZpbmVkMihkID0gZGF0YVtpXSwgaSwgZGF0YSkpID09PSBkZWZpbmVkMCkgewogICAgICAgIGlmIChkZWZpbmVkMCA9ICFkZWZpbmVkMCkgewogICAgICAgICAgaiA9IGk7CiAgICAgICAgICBvdXRwdXQuYXJlYVN0YXJ0KCk7CiAgICAgICAgICBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgICBmb3IgKGsgPSBpIC0gMTsgayA+PSBqOyAtLWspIHsKICAgICAgICAgICAgb3V0cHV0LnBvaW50KHgweltrXSwgeTB6W2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQuYXJlYUVuZCgpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZDApIHsKICAgICAgICB4MHpbaV0gPSAreDAoZCwgaSwgZGF0YSksIHkweltpXSA9ICt5MChkLCBpLCBkYXRhKTsKICAgICAgICBvdXRwdXQucG9pbnQoeDEgPyAreDEoZCwgaSwgZGF0YSkgOiB4MHpbaV0sIHkxID8gK3kxKGQsIGksIGRhdGEpIDogeTB6W2ldKTsKICAgICAgfQogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGZ1bmN0aW9uIGFyZWFsaW5lKCkgewogICAgcmV0dXJuIGxpbmVfZGVmYXVsdCgpLmRlZmluZWQoZGVmaW5lZDIpLmN1cnZlKGN1cnZlKS5jb250ZXh0KGNvbnRleHQpOwogIH0KICBhcmVhLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCB4MSA9IG51bGwsIGFyZWEpIDogeDA7CiAgfTsKICBhcmVhLngwID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MDsKICB9OwogIGFyZWEueDEgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MSA9IF8gPT0gbnVsbCA/IG51bGwgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MTsKICB9OwogIGFyZWEueSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHkxID0gbnVsbCwgYXJlYSkgOiB5MDsKICB9OwogIGFyZWEueTAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkwOwogIH07CiAgYXJlYS55MSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkxID0gXyA9PSBudWxsID8gbnVsbCA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkxOwogIH07CiAgYXJlYS5saW5lWDAgPSBhcmVhLmxpbmVZMCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MCk7CiAgfTsKICBhcmVhLmxpbmVZMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MSk7CiAgfTsKICBhcmVhLmxpbmVYMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MSkueSh5MCk7CiAgfTsKICBhcmVhLmRlZmluZWQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkZWZpbmVkMiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoISFfKSwgYXJlYSkgOiBkZWZpbmVkMjsKICB9OwogIGFyZWEuY3VydmUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjdXJ2ZSA9IF8sIGNvbnRleHQgIT0gbnVsbCAmJiAob3V0cHV0ID0gY3VydmUoY29udGV4dCkpLCBhcmVhKSA6IGN1cnZlOwogIH07CiAgYXJlYS5jb250ZXh0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoXyA9PSBudWxsID8gY29udGV4dCA9IG91dHB1dCA9IG51bGwgOiBvdXRwdXQgPSBjdXJ2ZShjb250ZXh0ID0gXyksIGFyZWEpIDogY29udGV4dDsKICB9OwogIHJldHVybiBhcmVhOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9idW1wLmpzCnZhciBCdW1wID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvbnRleHQsIHgyKSB7CiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKICAgIHRoaXMuX3ggPSB4MjsKICB9CiAgYXJlYVN0YXJ0KCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfQogIGFyZWFFbmQoKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0KICBsaW5lU3RhcnQoKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfQogIGxpbmVFbmQoKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0KICBwb2ludCh4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOiB7CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIGlmICh0aGlzLl9saW5lKSB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIGVsc2UgdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OiB7CiAgICAgICAgaWYgKHRoaXMuX3gpIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh0aGlzLl94MCA9ICh0aGlzLl94MCArIHgyKSAvIDIsIHRoaXMuX3kwLCB0aGlzLl94MCwgeTIsIHgyLCB5Mik7CiAgICAgICAgZWxzZSB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8odGhpcy5feDAsIHRoaXMuX3kwID0gKHRoaXMuX3kwICsgeTIpIC8gMiwgeDIsIHRoaXMuX3kwLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLl94MCA9IHgyLCB0aGlzLl95MCA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYnVtcFgoY29udGV4dCkgewogIHJldHVybiBuZXcgQnVtcChjb250ZXh0LCB0cnVlKTsKfQpmdW5jdGlvbiBidW1wWShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCdW1wKGNvbnRleHQsIGZhbHNlKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbm9vcC5qcwpmdW5jdGlvbiBub29wX2RlZmF1bHQoKSB7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzLmpzCmZ1bmN0aW9uIHBvaW50KHRoYXQsIHgyLCB5MikgewogIHRoYXQuX2NvbnRleHQuYmV6aWVyQ3VydmVUbygKICAgICgyICogdGhhdC5feDAgKyB0aGF0Ll94MSkgLyAzLAogICAgKDIgKiB0aGF0Ll95MCArIHRoYXQuX3kxKSAvIDMsCiAgICAodGhhdC5feDAgKyAyICogdGhhdC5feDEpIC8gMywKICAgICh0aGF0Ll95MCArIDIgKiB0aGF0Ll95MSkgLyAzLAogICAgKHRoYXQuX3gwICsgNCAqIHRoYXQuX3gxICsgeDIpIC8gNiwKICAgICh0aGF0Ll95MCArIDQgKiB0aGF0Ll95MSArIHkyKSAvIDYKICApOwp9CmZ1bmN0aW9uIEJhc2lzKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpcy5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludCh0aGlzLCB0aGlzLl94MSwgdGhpcy5feTEpOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8odGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCg1ICogdGhpcy5feDAgKyB0aGlzLl94MSkgLyA2LCAoNSAqIHRoaXMuX3kwICsgdGhpcy5feTEpIC8gNik7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCYXNpcyhjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXNDbG9zZWQuanMKZnVuY3Rpb24gQmFzaXNDbG9zZWQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl94MiA9IHRoaXMuX3gzID0gdGhpcy5feDQgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5feTIgPSB0aGlzLl95MyA9IHRoaXMuX3k0ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMTogewogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbygodGhpcy5feDIgKyAyICogdGhpcy5feDMpIC8gMywgKHRoaXMuX3kyICsgMiAqIHRoaXMuX3kzKSAvIDMpOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCh0aGlzLl94MyArIDIgKiB0aGlzLl94MikgLyAzLCAodGhpcy5feTMgKyAyICogdGhpcy5feTIpIC8gMyk7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDM6IHsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94MywgdGhpcy5feTMpOwogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDQsIHRoaXMuX3k0KTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX3gyID0geDIsIHRoaXMuX3kyID0geTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgdGhpcy5feDMgPSB4MiwgdGhpcy5feTMgPSB5MjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl94NCA9IHgyLCB0aGlzLl95NCA9IHkyOwogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKCh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsICh0aGlzLl95MCArIDQgKiB0aGlzLl95MSArIHkyKSAvIDYpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzT3Blbi5qcwpmdW5jdGlvbiBCYXNpc09wZW4oY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzT3Blbi5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAzKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHZhciB4MCA9ICh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsIHkwID0gKHRoaXMuX3kwICsgNCAqIHRoaXMuX3kxICsgeTIpIC8gNjsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDAsIHkwKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgwLCB5MCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLl9wb2ludCA9IDQ7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNPcGVuX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNPcGVuKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXJDbG9zZWQuanMKZnVuY3Rpb24gTGluZWFyQ2xvc2VkKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXJDbG9zZWQucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogbm9vcF9kZWZhdWx0LAogIGFyZWFFbmQ6IG5vb3BfZGVmYXVsdCwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fcG9pbnQpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAodGhpcy5fcG9pbnQpIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICBlbHNlIHRoaXMuX3BvaW50ID0gMSwgdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICB9Cn07CmZ1bmN0aW9uIGxpbmVhckNsb3NlZF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IExpbmVhckNsb3NlZChjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbW9ub3RvbmUuanMKZnVuY3Rpb24gc2lnbih4MikgewogIHJldHVybiB4MiA8IDAgPyAtMSA6IDE7Cn0KZnVuY3Rpb24gc2xvcGUzKHRoYXQsIHgyLCB5MikgewogIHZhciBoMCA9IHRoYXQuX3gxIC0gdGhhdC5feDAsIGgxID0geDIgLSB0aGF0Ll94MSwgczAgPSAodGhhdC5feTEgLSB0aGF0Ll95MCkgLyAoaDAgfHwgaDEgPCAwICYmIC0wKSwgczEgPSAoeTIgLSB0aGF0Ll95MSkgLyAoaDEgfHwgaDAgPCAwICYmIC0wKSwgcCA9IChzMCAqIGgxICsgczEgKiBoMCkgLyAoaDAgKyBoMSk7CiAgcmV0dXJuIChzaWduKHMwKSArIHNpZ24oczEpKSAqIE1hdGgubWluKE1hdGguYWJzKHMwKSwgTWF0aC5hYnMoczEpLCAwLjUgKiBNYXRoLmFicyhwKSkgfHwgMDsKfQpmdW5jdGlvbiBzbG9wZTIodGhhdCwgdCkgewogIHZhciBoID0gdGhhdC5feDEgLSB0aGF0Ll94MDsKICByZXR1cm4gaCA/ICgzICogKHRoYXQuX3kxIC0gdGhhdC5feTApIC8gaCAtIHQpIC8gMiA6IHQ7Cn0KZnVuY3Rpb24gcG9pbnQyKHRoYXQsIHQwMiwgdDEyKSB7CiAgdmFyIHgwID0gdGhhdC5feDAsIHkwID0gdGhhdC5feTAsIHgxID0gdGhhdC5feDEsIHkxID0gdGhhdC5feTEsIGR4ID0gKHgxIC0geDApIC8gMzsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oeDAgKyBkeCwgeTAgKyBkeCAqIHQwMiwgeDEgLSBkeCwgeTEgLSBkeCAqIHQxMiwgeDEsIHkxKTsKfQpmdW5jdGlvbiBNb25vdG9uZVgoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9Ck1vbm90b25lWC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5fdDAgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHNsb3BlMih0aGlzLCB0aGlzLl90MCkpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHZhciB0MTIgPSBOYU47CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAoeDIgPT09IHRoaXMuX3gxICYmIHkyID09PSB0aGlzLl95MSkgcmV0dXJuOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICBwb2ludDIodGhpcywgc2xvcGUyKHRoaXMsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKSwgdDEyKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogICAgdGhpcy5fdDAgPSB0MTI7CiAgfQp9OwpmdW5jdGlvbiBNb25vdG9uZVkoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBuZXcgUmVmbGVjdENvbnRleHQoY29udGV4dCk7Cn0KKE1vbm90b25lWS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKE1vbm90b25lWC5wcm90b3R5cGUpKS5wb2ludCA9IGZ1bmN0aW9uKHgyLCB5MikgewogIE1vbm90b25lWC5wcm90b3R5cGUucG9pbnQuY2FsbCh0aGlzLCB5MiwgeDIpOwp9OwpmdW5jdGlvbiBSZWZsZWN0Q29udGV4dChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KUmVmbGVjdENvbnRleHQucHJvdG90eXBlID0gewogIG1vdmVUbzogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbyh5MiwgeDIpOwogIH0sCiAgY2xvc2VQYXRoOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBsaW5lVG86IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5fY29udGV4dC5saW5lVG8oeTIsIHgyKTsKICB9LAogIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh5MSwgeDEsIHkyLCB4MiwgeTMsIHgzKTsKICB9Cn07CmZ1bmN0aW9uIG1vbm90b25lWChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBNb25vdG9uZVgoY29udGV4dCk7Cn0KZnVuY3Rpb24gbW9ub3RvbmVZKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE1vbm90b25lWShjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbmF0dXJhbC5qcwpmdW5jdGlvbiBOYXR1cmFsKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpOYXR1cmFsLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feCA9IFtdOwogICAgdGhpcy5feSA9IFtdOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICB2YXIgeDIgPSB0aGlzLl94LCB5MiA9IHRoaXMuX3ksIG4gPSB4Mi5sZW5ndGg7CiAgICBpZiAobikgewogICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDJbMF0sIHkyWzBdKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyWzBdLCB5MlswXSk7CiAgICAgIGlmIChuID09PSAyKSB7CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDJbMV0sIHkyWzFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHggPSBjb250cm9sUG9pbnRzKHgyKSwgcHkgPSBjb250cm9sUG9pbnRzKHkyKTsKICAgICAgICBmb3IgKHZhciBpMCA9IDAsIGkxID0gMTsgaTEgPCBuOyArK2kwLCArK2kxKSB7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8ocHhbMF1baTBdLCBweVswXVtpMF0sIHB4WzFdW2kwXSwgcHlbMV1baTBdLCB4MltpMV0sIHkyW2kxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIG4gPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgICB0aGlzLl94ID0gdGhpcy5feSA9IG51bGw7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl94LnB1c2goK3gyKTsKICAgIHRoaXMuX3kucHVzaCgreTIpOwogIH0KfTsKZnVuY3Rpb24gY29udHJvbFBvaW50cyh4MikgewogIHZhciBpLCBuID0geDIubGVuZ3RoIC0gMSwgbSwgYSA9IG5ldyBBcnJheShuKSwgYiA9IG5ldyBBcnJheShuKSwgcjIgPSBuZXcgQXJyYXkobik7CiAgYVswXSA9IDAsIGJbMF0gPSAyLCByMlswXSA9IHgyWzBdICsgMiAqIHgyWzFdOwogIGZvciAoaSA9IDE7IGkgPCBuIC0gMTsgKytpKSBhW2ldID0gMSwgYltpXSA9IDQsIHIyW2ldID0gNCAqIHgyW2ldICsgMiAqIHgyW2kgKyAxXTsKICBhW24gLSAxXSA9IDIsIGJbbiAtIDFdID0gNywgcjJbbiAtIDFdID0gOCAqIHgyW24gLSAxXSArIHgyW25dOwogIGZvciAoaSA9IDE7IGkgPCBuOyArK2kpIG0gPSBhW2ldIC8gYltpIC0gMV0sIGJbaV0gLT0gbSwgcjJbaV0gLT0gbSAqIHIyW2kgLSAxXTsKICBhW24gLSAxXSA9IHIyW24gLSAxXSAvIGJbbiAtIDFdOwogIGZvciAoaSA9IG4gLSAyOyBpID49IDA7IC0taSkgYVtpXSA9IChyMltpXSAtIGFbaSArIDFdKSAvIGJbaV07CiAgYltuIC0gMV0gPSAoeDJbbl0gKyBhW24gLSAxXSkgLyAyOwogIGZvciAoaSA9IDA7IGkgPCBuIC0gMTsgKytpKSBiW2ldID0gMiAqIHgyW2kgKyAxXSAtIGFbaSArIDFdOwogIHJldHVybiBbYSwgYl07Cn0KZnVuY3Rpb24gbmF0dXJhbF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE5hdHVyYWwoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL3N0ZXAuanMKZnVuY3Rpb24gU3RlcChjb250ZXh0LCB0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgdGhpcy5fdCA9IHQ7Cn0KU3RlcC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ggPSB0aGlzLl95ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAoMCA8IHRoaXMuX3QgJiYgdGhpcy5fdCA8IDEgJiYgdGhpcy5fcG9pbnQgPT09IDIpIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHRoaXMuX3kpOwogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIGlmICh0aGlzLl9saW5lID49IDApIHRoaXMuX3QgPSAxIC0gdGhpcy5fdCwgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDogewogICAgICAgIGlmICh0aGlzLl90IDw9IDApIHsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHkyKTsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciB4MSA9IHRoaXMuX3ggKiAoMSAtIHRoaXMuX3QpICsgeDIgKiB0aGlzLl90OwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHRoaXMuX3kpOwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHkyKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3ggPSB4MiwgdGhpcy5feSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gc3RlcF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMC41KTsKfQpmdW5jdGlvbiBzdGVwQmVmb3JlKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMCk7Cn0KZnVuY3Rpb24gc3RlcEFmdGVyKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9ub25lLmpzCmZ1bmN0aW9uIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDEpKSByZXR1cm47CiAgZm9yICh2YXIgaSA9IDEsIGosIHMwLCBzMSA9IHNlcmllc1tvcmRlclswXV0sIG4sIG0gPSBzMS5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgIHMwID0gczEsIHMxID0gc2VyaWVzW29yZGVyW2ldXTsKICAgIGZvciAoaiA9IDA7IGogPCBtOyArK2opIHsKICAgICAgczFbal1bMV0gKz0gczFbal1bMF0gPSBpc05hTihzMFtqXVsxXSkgPyBzMFtqXVswXSA6IHMwW2pdWzFdOwogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb3JkZXIvbm9uZS5qcwpmdW5jdGlvbiBub25lX2RlZmF1bHQyKHNlcmllcykgewogIHZhciBuID0gc2VyaWVzLmxlbmd0aCwgbyA9IG5ldyBBcnJheShuKTsKICB3aGlsZSAoLS1uID49IDApIG9bbl0gPSBuOwogIHJldHVybiBvOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9zdGFjay5qcwpmdW5jdGlvbiBzdGFja1ZhbHVlKGQsIGtleSkgewogIHJldHVybiBkW2tleV07Cn0KZnVuY3Rpb24gc3RhY2tTZXJpZXMoa2V5KSB7CiAgY29uc3Qgc2VyaWVzID0gW107CiAgc2VyaWVzLmtleSA9IGtleTsKICByZXR1cm4gc2VyaWVzOwp9CmZ1bmN0aW9uIHN0YWNrX2RlZmF1bHQoKSB7CiAgdmFyIGtleXMgPSBjb25zdGFudF9kZWZhdWx0KFtdKSwgb3JkZXIgPSBub25lX2RlZmF1bHQyLCBvZmZzZXQgPSBub25lX2RlZmF1bHQsIHZhbHVlID0gc3RhY2tWYWx1ZTsKICBmdW5jdGlvbiBzdGFjayhkYXRhKSB7CiAgICB2YXIgc3ogPSBBcnJheS5mcm9tKGtleXMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgc3RhY2tTZXJpZXMpLCBpLCBuID0gc3oubGVuZ3RoLCBqID0gLTEsIG96OwogICAgZm9yIChjb25zdCBkIG9mIGRhdGEpIHsKICAgICAgZm9yIChpID0gMCwgKytqOyBpIDwgbjsgKytpKSB7CiAgICAgICAgKHN6W2ldW2pdID0gWzAsICt2YWx1ZShkLCBzeltpXS5rZXksIGosIGRhdGEpXSkuZGF0YSA9IGQ7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDAsIG96ID0gYXJyYXlfZGVmYXVsdChvcmRlcihzeikpOyBpIDwgbjsgKytpKSB7CiAgICAgIHN6W296W2ldXS5pbmRleCA9IGk7CiAgICB9CiAgICBvZmZzZXQoc3osIG96KTsKICAgIHJldHVybiBzejsKICB9CiAgc3RhY2sua2V5cyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGtleXMgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KEFycmF5LmZyb20oXykpLCBzdGFjaykgOiBrZXlzOwogIH07CiAgc3RhY2sudmFsdWUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh2YWx1ZSA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBzdGFjaykgOiB2YWx1ZTsKICB9OwogIHN0YWNrLm9yZGVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob3JkZXIgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQyIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdChBcnJheS5mcm9tKF8pKSwgc3RhY2spIDogb3JkZXI7CiAgfTsKICBzdGFjay5vZmZzZXQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChvZmZzZXQgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQgOiBfLCBzdGFjaykgOiBvZmZzZXQ7CiAgfTsKICByZXR1cm4gc3RhY2s7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9leHBhbmQuanMKZnVuY3Rpb24gZXhwYW5kX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIGksIG4sIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aCwgeTI7IGogPCBtOyArK2opIHsKICAgIGZvciAoeTIgPSBpID0gMDsgaSA8IG47ICsraSkgeTIgKz0gc2VyaWVzW2ldW2pdWzFdIHx8IDA7CiAgICBpZiAoeTIpIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHNlcmllc1tpXVtqXVsxXSAvPSB5MjsKICB9CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvc2lsaG91ZXR0ZS5qcwpmdW5jdGlvbiBzaWxob3VldHRlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIGogPSAwLCBzMCA9IHNlcmllc1tvcmRlclswXV0sIG4sIG0gPSBzMC5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCB5MiA9IDA7IGkgPCBuOyArK2kpIHkyICs9IHNlcmllc1tpXVtqXVsxXSB8fCAwOwogICAgczBbal1bMV0gKz0gczBbal1bMF0gPSAteTIgLyAyOwogIH0KICBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC93aWdnbGUuanMKZnVuY3Rpb24gd2lnZ2xlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSB8fCAhKChtID0gKHMwID0gc2VyaWVzW29yZGVyWzBdXSkubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgeTIgPSAwLCBqID0gMSwgczAsIG0sIG47IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCBzMSA9IDAsIHMyID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgc2kgPSBzZXJpZXNbb3JkZXJbaV1dLCBzaWowID0gc2lbal1bMV0gfHwgMCwgc2lqMSA9IHNpW2ogLSAxXVsxXSB8fCAwLCBzMyA9IChzaWowIC0gc2lqMSkgLyAyOwogICAgICBmb3IgKHZhciBrID0gMDsgayA8IGk7ICsraykgewogICAgICAgIHZhciBzayA9IHNlcmllc1tvcmRlcltrXV0sIHNrajAgPSBza1tqXVsxXSB8fCAwLCBza2oxID0gc2tbaiAtIDFdWzFdIHx8IDA7CiAgICAgICAgczMgKz0gc2tqMCAtIHNrajE7CiAgICAgIH0KICAgICAgczEgKz0gc2lqMCwgczIgKz0gczMgKiBzaWowOwogICAgfQogICAgczBbaiAtIDFdWzFdICs9IHMwW2ogLSAxXVswXSA9IHkyOwogICAgaWYgKHMxKSB5MiAtPSBzMiAvIHMxOwogIH0KICBzMFtqIC0gMV1bMV0gKz0gczBbaiAtIDFdWzBdID0geTI7CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0RhdGFVdGlscy5qcwp2YXIgaW1wb3J0X2dldCA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwp2YXIgbWF0aFNpZ24gPSAodmFsdWUpID0+IHsKICBpZiAodmFsdWUgPT09IDApIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAodmFsdWUgPiAwKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIC0xOwp9Owp2YXIgaXNOYW4gPSAodmFsdWUpID0+IHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICJudW1iZXIiICYmIHZhbHVlICE9ICt2YWx1ZTsKfTsKdmFyIGlzUGVyY2VudCA9ICh2YWx1ZSkgPT4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCIlIikgPT09IHZhbHVlLmxlbmd0aCAtIDE7CnZhciBpc051bWJlciA9ICh2YWx1ZSkgPT4gKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdmFsdWUgaW5zdGFuY2VvZiBOdW1iZXIpICYmICFpc05hbih2YWx1ZSk7CnZhciBpc051bU9yU3RyID0gKHZhbHVlKSA9PiBpc051bWJlcih2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIjsKdmFyIGlkQ291bnRlciA9IDA7CnZhciB1bmlxdWVJZCA9IChwcmVmaXgpID0+IHsKICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICByZXR1cm4gIiIuY29uY2F0KHByZWZpeCB8fCAiIikuY29uY2F0KGlkKTsKfTsKdmFyIGdldFBlcmNlbnRWYWx1ZSA9IGZ1bmN0aW9uIGdldFBlcmNlbnRWYWx1ZTIocGVyY2VudCwgdG90YWxWYWx1ZSkgewogIHZhciBkZWZhdWx0VmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IDA7CiAgdmFyIHZhbGlkYXRlID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICBpZiAoIWlzTnVtYmVyKHBlcmNlbnQpICYmIHR5cGVvZiBwZXJjZW50ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICB9CiAgdmFyIHZhbHVlOwogIGlmIChpc1BlcmNlbnQocGVyY2VudCkpIHsKICAgIGlmICh0b3RhbFZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KICAgIHZhciBpbmRleCA9IHBlcmNlbnQuaW5kZXhPZigiJSIpOwogICAgdmFsdWUgPSB0b3RhbFZhbHVlICogcGFyc2VGbG9hdChwZXJjZW50LnNsaWNlKDAsIGluZGV4KSkgLyAxMDA7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gK3BlcmNlbnQ7CiAgfQogIGlmIChpc05hbih2YWx1ZSkpIHsKICAgIHZhbHVlID0gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAodmFsaWRhdGUgJiYgdG90YWxWYWx1ZSAhPSBudWxsICYmIHZhbHVlID4gdG90YWxWYWx1ZSkgewogICAgdmFsdWUgPSB0b3RhbFZhbHVlOwogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciBoYXNEdXBsaWNhdGUgPSAoYXJ5KSA9PiB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFyeSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGxlbiA9IGFyeS5sZW5ndGg7CiAgdmFyIGNhY2hlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgaWYgKCFjYWNoZVthcnlbaV1dKSB7CiAgICAgIGNhY2hlW2FyeVtpXV0gPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKZnVuY3Rpb24gaW50ZXJwb2xhdGUoc3RhcnQsIGVuZCwgdCkgewogIGlmIChpc051bWJlcihzdGFydCkgJiYgaXNOdW1iZXIoZW5kKSkgewogICAgcmV0dXJuIHN0YXJ0ICsgdCAqIChlbmQgLSBzdGFydCk7CiAgfQogIHJldHVybiBlbmQ7Cn0KZnVuY3Rpb24gZmluZEVudHJ5SW5BcnJheShhcnksIHNwZWNpZmllZEtleSwgc3BlY2lmaWVkVmFsdWUpIHsKICBpZiAoIWFyeSB8fCAhYXJ5Lmxlbmd0aCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGFyeS5maW5kKChlbnRyeSkgPT4gZW50cnkgJiYgKHR5cGVvZiBzcGVjaWZpZWRLZXkgPT09ICJmdW5jdGlvbiIgPyBzcGVjaWZpZWRLZXkoZW50cnkpIDogKDAsIGltcG9ydF9nZXQuZGVmYXVsdCkoZW50cnksIHNwZWNpZmllZEtleSkpID09PSBzcGVjaWZpZWRWYWx1ZSk7Cn0KdmFyIGlzTnVsbGlzaCA9ICh2YWx1ZSkgPT4gewogIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiOwp9Owp2YXIgdXBwZXJGaXJzdCA9ICh2YWx1ZSkgPT4gewogIGlmIChpc051bGxpc2godmFsdWUpKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiAiIi5jb25jYXQodmFsdWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkpLmNvbmNhdCh2YWx1ZS5zbGljZSgxKSk7Cn07CmZ1bmN0aW9uIGlzTm90TmlsKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9IG51bGw7Cn0KZnVuY3Rpb24gbm9vcCgpIHsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC90eXBlcy5qcwp2YXIgaW1wb3J0X3JlYWN0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGlzUG9sYXJDb29yZGluYXRlID0gKGMpID0+IHsKICByZXR1cm4gInJhZGl1cyIgaW4gYyAmJiAic3RhcnRBbmdsZSIgaW4gYyAmJiAiZW5kQW5nbGUiIGluIGM7Cn07CnZhciBhZGFwdEV2ZW50SGFuZGxlcnMgPSAocHJvcHMsIG5ld0hhbmRsZXIpID0+IHsKICBpZiAoIXByb3BzIHx8IHR5cGVvZiBwcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgcHJvcHMgPT09ICJib29sZWFuIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBpbnB1dFByb3BzID0gcHJvcHM7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0Ny5pc1ZhbGlkRWxlbWVudCkocHJvcHMpKSB7CiAgICBpbnB1dFByb3BzID0gcHJvcHMucHJvcHM7CiAgfQogIGlmICh0eXBlb2YgaW5wdXRQcm9wcyAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIGlucHV0UHJvcHMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgb3V0ID0ge307CiAgT2JqZWN0LmtleXMoaW5wdXRQcm9wcykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICBpZiAoaXNFdmVudEtleShrZXkpKSB7CiAgICAgIG91dFtrZXldID0gbmV3SGFuZGxlciB8fCAoKGUpID0+IGlucHV0UHJvcHNba2V5XShpbnB1dFByb3BzLCBlKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIG91dDsKfTsKdmFyIGdldEV2ZW50SGFuZGxlck9mQ2hpbGQgPSAob3JpZ2luYWxIYW5kbGVyLCBkYXRhLCBpbmRleCkgPT4gKGUpID0+IHsKICBvcmlnaW5hbEhhbmRsZXIoZGF0YSwgaW5kZXgsIGUpOwogIHJldHVybiBudWxsOwp9Owp2YXIgYWRhcHRFdmVudHNPZkNoaWxkID0gKHByb3BzLCBkYXRhLCBpbmRleCkgPT4gewogIGlmIChwcm9wcyA9PT0gbnVsbCB8fCB0eXBlb2YgcHJvcHMgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9wcyAhPT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvdXQgPSBudWxsOwogIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIHZhciBpdGVtID0gcHJvcHNba2V5XTsKICAgIGlmIChpc0V2ZW50S2V5KGtleSkgJiYgdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCFvdXQpIG91dCA9IHt9OwogICAgICBvdXRba2V5XSA9IGdldEV2ZW50SGFuZGxlck9mQ2hpbGQoaXRlbSwgZGF0YSwgaW5kZXgpOwogICAgfQogIH0pOwogIHJldHVybiBvdXQ7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Jlc29sdmVEZWZhdWx0UHJvcHMuanMKZnVuY3Rpb24gb3duS2V5cyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5cyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiByZXNvbHZlRGVmYXVsdFByb3BzKHJlYWxQcm9wcywgZGVmYXVsdFByb3BzKSB7CiAgdmFyIHJlc29sdmVkUHJvcHMgPSBfb2JqZWN0U3ByZWFkKHt9LCByZWFsUHJvcHMpOwogIHZhciBkcCA9IGRlZmF1bHRQcm9wczsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRlZmF1bHRQcm9wcyk7CiAgdmFyIHdpdGhEZWZhdWx0cyA9IGtleXMucmVkdWNlKChhY2MsIGtleSkgPT4gewogICAgaWYgKGFjY1trZXldID09PSB2b2lkIDAgJiYgZHBba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgIGFjY1trZXldID0gZHBba2V5XTsKICAgIH0KICAgIHJldHVybiBhY2M7CiAgfSwgcmVzb2x2ZWRQcm9wcyk7CiAgcmV0dXJuIHdpdGhEZWZhdWx0czsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9wYXlsb2FkL2dldFVuaXFQYXlsb2FkLmpzCnZhciBpbXBvcnRfdW5pcUJ5ID0gX190b0VTTShyZXF1aXJlX3VuaXFCeTMoKSk7CmZ1bmN0aW9uIGdldFVuaXFQYXlsb2FkKHBheWxvYWQsIG9wdGlvbiwgZGVmYXVsdFVuaXFCeTIpIHsKICBpZiAob3B0aW9uID09PSB0cnVlKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF91bmlxQnkuZGVmYXVsdCkocGF5bG9hZCwgZGVmYXVsdFVuaXFCeTIpOwogIH0KICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuICgwLCBpbXBvcnRfdW5pcUJ5LmRlZmF1bHQpKHBheWxvYWQsIG9wdGlvbik7CiAgfQogIHJldHVybiBwYXlsb2FkOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ob29rcy5qcwp2YXIgaW1wb3J0X3dpdGhfc2VsZWN0b3IgPSBfX3RvRVNNKHJlcXVpcmVfd2l0aF9zZWxlY3RvcigpKTsKdmFyIGltcG9ydF9yZWFjdDkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1JlZHV4Q29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFJlY2hhcnRzUmVkdXhDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q4LmNyZWF0ZUNvbnRleHQpKG51bGwpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvaG9va3MuanMKdmFyIG5vb3BEaXNwYXRjaCA9IChhKSA9PiBhOwp2YXIgdXNlQXBwRGlzcGF0Y2ggPSAoKSA9PiB7CiAgdmFyIGNvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0OS51c2VDb250ZXh0KShSZWNoYXJ0c1JlZHV4Q29udGV4dCk7CiAgaWYgKGNvbnRleHQpIHsKICAgIHJldHVybiBjb250ZXh0LnN0b3JlLmRpc3BhdGNoOwogIH0KICByZXR1cm4gbm9vcERpc3BhdGNoOwp9Owp2YXIgbm9vcDIgPSAoKSA9PiB7Cn07CnZhciBhZGROZXN0ZWRTdWJOb29wID0gKCkgPT4gbm9vcDI7CnZhciByZWZFcXVhbGl0eSA9IChhLCBiKSA9PiBhID09PSBiOwpmdW5jdGlvbiB1c2VBcHBTZWxlY3RvcihzZWxlY3RvcikgewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIHJldHVybiAoMCwgaW1wb3J0X3dpdGhfc2VsZWN0b3IudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IpKGNvbnRleHQgPyBjb250ZXh0LnN1YnNjcmlwdGlvbi5hZGROZXN0ZWRTdWIgOiBhZGROZXN0ZWRTdWJOb29wLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gc2VsZWN0b3IgOiBub29wMiwgcmVmRXF1YWxpdHkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVzZWxlY3RANS4xLjEvbm9kZV9tb2R1bGVzL3Jlc2VsZWN0L2Rpc3QvcmVzZWxlY3QubWpzCnZhciBydW5JZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPSAocmVzdWx0RnVuYywgaW5wdXRTZWxlY3RvcnNSZXN1bHRzLCBvdXRwdXRTZWxlY3RvclJlc3VsdCkgPT4gewogIGlmIChpbnB1dFNlbGVjdG9yc1Jlc3VsdHMubGVuZ3RoID09PSAxICYmIGlucHV0U2VsZWN0b3JzUmVzdWx0c1swXSA9PT0gb3V0cHV0U2VsZWN0b3JSZXN1bHQpIHsKICAgIGxldCBpc0lucHV0U2FtZUFzT3V0cHV0ID0gZmFsc2U7CiAgICB0cnkgewogICAgICBjb25zdCBlbXB0eU9iamVjdCA9IHt9OwogICAgICBpZiAocmVzdWx0RnVuYyhlbXB0eU9iamVjdCkgPT09IGVtcHR5T2JqZWN0KQogICAgICAgIGlzSW5wdXRTYW1lQXNPdXRwdXQgPSB0cnVlOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICBpZiAoaXNJbnB1dFNhbWVBc091dHB1dCkgewogICAgICBsZXQgc3RhY2sgPSB2b2lkIDA7CiAgICAgIHRyeSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICA7CiAgICAgICAgKHsgc3RhY2sgfSA9IGUpOwogICAgICB9CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAiVGhlIHJlc3VsdCBmdW5jdGlvbiByZXR1cm5lZCBpdHMgb3duIGlucHV0cyB3aXRob3V0IG1vZGlmaWNhdGlvbi4gZS5nXG5gY3JlYXRlU2VsZWN0b3IoW3N0YXRlID0+IHN0YXRlLnRvZG9zXSwgdG9kb3MgPT4gdG9kb3MpYFxuVGhpcyBjb3VsZCBsZWFkIHRvIGluZWZmaWNpZW50IG1lbW9pemF0aW9uIGFuZCB1bm5lY2Vzc2FyeSByZS1yZW5kZXJzLlxuRW5zdXJlIHRyYW5zZm9ybWF0aW9uIGxvZ2ljIGlzIGluIHRoZSByZXN1bHQgZnVuY3Rpb24sIGFuZCBleHRyYWN0aW9uIGxvZ2ljIGlzIGluIHRoZSBpbnB1dCBzZWxlY3RvcnMuIiwKICAgICAgICB7IHN0YWNrIH0KICAgICAgKTsKICAgIH0KICB9Cn07CnZhciBydW5JbnB1dFN0YWJpbGl0eUNoZWNrID0gKGlucHV0U2VsZWN0b3JSZXN1bHRzT2JqZWN0LCBvcHRpb25zLCBpbnB1dFNlbGVjdG9yQXJncykgPT4gewogIGNvbnN0IHsgbWVtb2l6ZSwgbWVtb2l6ZU9wdGlvbnMgfSA9IG9wdGlvbnM7CiAgY29uc3QgeyBpbnB1dFNlbGVjdG9yUmVzdWx0cywgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5IH0gPSBpbnB1dFNlbGVjdG9yUmVzdWx0c09iamVjdDsKICBjb25zdCBjcmVhdGVBbkVtcHR5T2JqZWN0ID0gbWVtb2l6ZSgoKSA9PiAoe30pLCAuLi5tZW1vaXplT3B0aW9ucyk7CiAgY29uc3QgYXJlSW5wdXRTZWxlY3RvclJlc3VsdHNFcXVhbCA9IGNyZWF0ZUFuRW1wdHlPYmplY3QuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHMpID09PSBjcmVhdGVBbkVtcHR5T2JqZWN0LmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSk7CiAgaWYgKCFhcmVJbnB1dFNlbGVjdG9yUmVzdWx0c0VxdWFsKSB7CiAgICBsZXQgc3RhY2sgPSB2b2lkIDA7CiAgICB0cnkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgOwogICAgICAoeyBzdGFjayB9ID0gZSk7CiAgICB9CiAgICBjb25zb2xlLndhcm4oCiAgICAgICJBbiBpbnB1dCBzZWxlY3RvciByZXR1cm5lZCBhIGRpZmZlcmVudCByZXN1bHQgd2hlbiBwYXNzZWQgc2FtZSBhcmd1bWVudHMuXG5UaGlzIG1lYW5zIHlvdXIgb3V0cHV0IHNlbGVjdG9yIHdpbGwgbGlrZWx5IHJ1biBtb3JlIGZyZXF1ZW50bHkgdGhhbiBpbnRlbmRlZC5cbkF2b2lkIHJldHVybmluZyBhIG5ldyByZWZlcmVuY2UgaW5zaWRlIHlvdXIgaW5wdXQgc2VsZWN0b3IsIGUuZy5cbmBjcmVhdGVTZWxlY3Rvcihbc3RhdGUgPT4gc3RhdGUudG9kb3MubWFwKHRvZG8gPT4gdG9kby5pZCldLCB0b2RvSWRzID0+IHRvZG9JZHMubGVuZ3RoKWAiLAogICAgICB7CiAgICAgICAgYXJndW1lbnRzOiBpbnB1dFNlbGVjdG9yQXJncywKICAgICAgICBmaXJzdElucHV0czogaW5wdXRTZWxlY3RvclJlc3VsdHMsCiAgICAgICAgc2Vjb25kSW5wdXRzOiBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHksCiAgICAgICAgc3RhY2sKICAgICAgfQogICAgKTsKICB9Cn07CnZhciBnbG9iYWxEZXZNb2RlQ2hlY2tzID0gewogIGlucHV0U3RhYmlsaXR5Q2hlY2s6ICJvbmNlIiwKICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2s6ICJvbmNlIgp9OwpmdW5jdGlvbiBhc3NlcnRJc0Z1bmN0aW9uKGZ1bmMsIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhIGZ1bmN0aW9uLCBpbnN0ZWFkIHJlY2VpdmVkICR7dHlwZW9mIGZ1bmN9YCkgewogIGlmICh0eXBlb2YgZnVuYyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihlcnJvck1lc3NhZ2UpOwogIH0KfQpmdW5jdGlvbiBhc3NlcnRJc09iamVjdChvYmplY3QsIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhbiBvYmplY3QsIGluc3RlYWQgcmVjZWl2ZWQgJHt0eXBlb2Ygb2JqZWN0fWApIHsKICBpZiAodHlwZW9mIG9iamVjdCAhPT0gIm9iamVjdCIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZXJyb3JNZXNzYWdlKTsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0SXNBcnJheU9mRnVuY3Rpb25zKGFycmF5LCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYWxsIGl0ZW1zIHRvIGJlIGZ1bmN0aW9ucywgaW5zdGVhZCByZWNlaXZlZCB0aGUgZm9sbG93aW5nIHR5cGVzOiBgKSB7CiAgaWYgKCFhcnJheS5ldmVyeSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpKSB7CiAgICBjb25zdCBpdGVtVHlwZXMgPSBhcnJheS5tYXAoCiAgICAgIChpdGVtKSA9PiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIiA/IGBmdW5jdGlvbiAke2l0ZW0ubmFtZSB8fCAidW5uYW1lZCJ9KClgIDogdHlwZW9mIGl0ZW0KICAgICkuam9pbigiLCAiKTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYCR7ZXJyb3JNZXNzYWdlfVske2l0ZW1UeXBlc31dYCk7CiAgfQp9CnZhciBlbnN1cmVJc0FycmF5ID0gKGl0ZW0pID0+IHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGl0ZW0gOiBbaXRlbV07Cn07CmZ1bmN0aW9uIGdldERlcGVuZGVuY2llcyhjcmVhdGVTZWxlY3RvckFyZ3MpIHsKICBjb25zdCBkZXBlbmRlbmNpZXMgPSBBcnJheS5pc0FycmF5KGNyZWF0ZVNlbGVjdG9yQXJnc1swXSkgPyBjcmVhdGVTZWxlY3RvckFyZ3NbMF0gOiBjcmVhdGVTZWxlY3RvckFyZ3M7CiAgYXNzZXJ0SXNBcnJheU9mRnVuY3Rpb25zKAogICAgZGVwZW5kZW5jaWVzLAogICAgYGNyZWF0ZVNlbGVjdG9yIGV4cGVjdHMgYWxsIGlucHV0LXNlbGVjdG9ycyB0byBiZSBmdW5jdGlvbnMsIGJ1dCByZWNlaXZlZCB0aGUgZm9sbG93aW5nIHR5cGVzOiBgCiAgKTsKICByZXR1cm4gZGVwZW5kZW5jaWVzOwp9CmZ1bmN0aW9uIGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cyhkZXBlbmRlbmNpZXMsIGlucHV0U2VsZWN0b3JBcmdzKSB7CiAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHMgPSBbXTsKICBjb25zdCB7IGxlbmd0aCB9ID0gZGVwZW5kZW5jaWVzOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIGlucHV0U2VsZWN0b3JSZXN1bHRzLnB1c2goZGVwZW5kZW5jaWVzW2ldLmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JBcmdzKSk7CiAgfQogIHJldHVybiBpbnB1dFNlbGVjdG9yUmVzdWx0czsKfQp2YXIgZ2V0RGV2TW9kZUNoZWNrc0V4ZWN1dGlvbkluZm8gPSAoZmlyc3RSdW4sIGRldk1vZGVDaGVja3MpID0+IHsKICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjaywgaW5wdXRTdGFiaWxpdHlDaGVjayB9ID0gewogICAgLi4uZ2xvYmFsRGV2TW9kZUNoZWNrcywKICAgIC4uLmRldk1vZGVDaGVja3MKICB9OwogIHJldHVybiB7CiAgICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2s6IHsKICAgICAgc2hvdWxkUnVuOiBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPT09ICJhbHdheXMiIHx8IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9PT0gIm9uY2UiICYmIGZpcnN0UnVuLAogICAgICBydW46IHJ1bklkZW50aXR5RnVuY3Rpb25DaGVjawogICAgfSwKICAgIGlucHV0U3RhYmlsaXR5Q2hlY2s6IHsKICAgICAgc2hvdWxkUnVuOiBpbnB1dFN0YWJpbGl0eUNoZWNrID09PSAiYWx3YXlzIiB8fCBpbnB1dFN0YWJpbGl0eUNoZWNrID09PSAib25jZSIgJiYgZmlyc3RSdW4sCiAgICAgIHJ1bjogcnVuSW5wdXRTdGFiaWxpdHlDaGVjawogICAgfQogIH07Cn07CnZhciBSRURVWF9QUk9YWV9MQUJFTCA9IFN5bWJvbCgpOwp2YXIgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yoe30pOwp2YXIgU3Ryb25nUmVmID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfQogIGRlcmVmKCkgewogICAgcmV0dXJuIHRoaXMudmFsdWU7CiAgfQp9Owp2YXIgUmVmID0gdHlwZW9mIFdlYWtSZWYgIT09ICJ1bmRlZmluZWQiID8gV2Vha1JlZiA6IFN0cm9uZ1JlZjsKdmFyIFVOVEVSTUlOQVRFRCA9IDA7CnZhciBURVJNSU5BVEVEID0gMTsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVOb2RlKCkgewogIHJldHVybiB7CiAgICBzOiBVTlRFUk1JTkFURUQsCiAgICB2OiB2b2lkIDAsCiAgICBvOiBudWxsLAogICAgcDogbnVsbAogIH07Cn0KZnVuY3Rpb24gd2Vha01hcE1lbW9pemUoZnVuYywgb3B0aW9ucyA9IHt9KSB7CiAgbGV0IGZuTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogIGNvbnN0IHsgcmVzdWx0RXF1YWxpdHlDaGVjayB9ID0gb3B0aW9uczsKICBsZXQgbGFzdFJlc3VsdDsKICBsZXQgcmVzdWx0c0NvdW50ID0gMDsKICBmdW5jdGlvbiBtZW1vaXplZCgpIHsKICAgIGxldCBjYWNoZU5vZGUgPSBmbk5vZGU7CiAgICBjb25zdCB7IGxlbmd0aCB9ID0gYXJndW1lbnRzOwogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBsZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgY29uc3QgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICBpZiAodHlwZW9mIGFyZyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgYXJnID09PSAib2JqZWN0IiAmJiBhcmcgIT09IG51bGwpIHsKICAgICAgICBsZXQgb2JqZWN0Q2FjaGUgPSBjYWNoZU5vZGUubzsKICAgICAgICBpZiAob2JqZWN0Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlTm9kZS5vID0gb2JqZWN0Q2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2JqZWN0Tm9kZSA9IG9iamVjdENhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChvYmplY3ROb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgb2JqZWN0Q2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gb2JqZWN0Tm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IHByaW1pdGl2ZUNhY2hlID0gY2FjaGVOb2RlLnA7CiAgICAgICAgaWYgKHByaW1pdGl2ZUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZU5vZGUucCA9IHByaW1pdGl2ZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJpbWl0aXZlTm9kZSA9IHByaW1pdGl2ZUNhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChwcmltaXRpdmVOb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgcHJpbWl0aXZlQ2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gcHJpbWl0aXZlTm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRlcm1pbmF0ZWROb2RlID0gY2FjaGVOb2RlOwogICAgbGV0IHJlc3VsdDsKICAgIGlmIChjYWNoZU5vZGUucyA9PT0gVEVSTUlOQVRFRCkgewogICAgICByZXN1bHQgPSBjYWNoZU5vZGUudjsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgcmVzdWx0c0NvdW50Kys7CiAgICAgIGlmIChyZXN1bHRFcXVhbGl0eUNoZWNrKSB7CiAgICAgICAgY29uc3QgbGFzdFJlc3VsdFZhbHVlID0gbGFzdFJlc3VsdD8uZGVyZWY/LigpID8/IGxhc3RSZXN1bHQ7CiAgICAgICAgaWYgKGxhc3RSZXN1bHRWYWx1ZSAhPSBudWxsICYmIHJlc3VsdEVxdWFsaXR5Q2hlY2sobGFzdFJlc3VsdFZhbHVlLCByZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBsYXN0UmVzdWx0VmFsdWU7CiAgICAgICAgICByZXN1bHRzQ291bnQgIT09IDAgJiYgcmVzdWx0c0NvdW50LS07CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5lZWRzV2Vha1JlZiA9IHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiICYmIHJlc3VsdCAhPT0gbnVsbCB8fCB0eXBlb2YgcmVzdWx0ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGxhc3RSZXN1bHQgPSBuZWVkc1dlYWtSZWYgPyBuZXcgUmVmKHJlc3VsdCkgOiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIHRlcm1pbmF0ZWROb2RlLnMgPSBURVJNSU5BVEVEOwogICAgdGVybWluYXRlZE5vZGUudiA9IHJlc3VsdDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIG1lbW9pemVkLmNsZWFyQ2FjaGUgPSAoKSA9PiB7CiAgICBmbk5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgIG1lbW9pemVkLnJlc2V0UmVzdWx0c0NvdW50KCk7CiAgfTsKICBtZW1vaXplZC5yZXN1bHRzQ291bnQgPSAoKSA9PiByZXN1bHRzQ291bnQ7CiAgbWVtb2l6ZWQucmVzZXRSZXN1bHRzQ291bnQgPSAoKSA9PiB7CiAgICByZXN1bHRzQ291bnQgPSAwOwogIH07CiAgcmV0dXJuIG1lbW9pemVkOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlbGVjdG9yQ3JlYXRvcihtZW1vaXplT3JPcHRpb25zLCAuLi5tZW1vaXplT3B0aW9uc0Zyb21BcmdzKSB7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucyA9IHR5cGVvZiBtZW1vaXplT3JPcHRpb25zID09PSAiZnVuY3Rpb24iID8gewogICAgbWVtb2l6ZTogbWVtb2l6ZU9yT3B0aW9ucywKICAgIG1lbW9pemVPcHRpb25zOiBtZW1vaXplT3B0aW9uc0Zyb21BcmdzCiAgfSA6IG1lbW9pemVPck9wdGlvbnM7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3IyID0gKC4uLmNyZWF0ZVNlbGVjdG9yQXJncykgPT4gewogICAgbGV0IHJlY29tcHV0YXRpb25zID0gMDsKICAgIGxldCBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMgPSAwOwogICAgbGV0IGxhc3RSZXN1bHQ7CiAgICBsZXQgZGlyZWN0bHlQYXNzZWRPcHRpb25zID0ge307CiAgICBsZXQgcmVzdWx0RnVuYyA9IGNyZWF0ZVNlbGVjdG9yQXJncy5wb3AoKTsKICAgIGlmICh0eXBlb2YgcmVzdWx0RnVuYyA9PT0gIm9iamVjdCIpIHsKICAgICAgZGlyZWN0bHlQYXNzZWRPcHRpb25zID0gcmVzdWx0RnVuYzsKICAgICAgcmVzdWx0RnVuYyA9IGNyZWF0ZVNlbGVjdG9yQXJncy5wb3AoKTsKICAgIH0KICAgIGFzc2VydElzRnVuY3Rpb24oCiAgICAgIHJlc3VsdEZ1bmMsCiAgICAgIGBjcmVhdGVTZWxlY3RvciBleHBlY3RzIGFuIG91dHB1dCBmdW5jdGlvbiBhZnRlciB0aGUgaW5wdXRzLCBidXQgcmVjZWl2ZWQ6IFske3R5cGVvZiByZXN1bHRGdW5jfV1gCiAgICApOwogICAgY29uc3QgY29tYmluZWRPcHRpb25zID0gewogICAgICAuLi5jcmVhdGVTZWxlY3RvckNyZWF0b3JPcHRpb25zLAogICAgICAuLi5kaXJlY3RseVBhc3NlZE9wdGlvbnMKICAgIH07CiAgICBjb25zdCB7CiAgICAgIG1lbW9pemUsCiAgICAgIG1lbW9pemVPcHRpb25zID0gW10sCiAgICAgIGFyZ3NNZW1vaXplID0gd2Vha01hcE1lbW9pemUsCiAgICAgIGFyZ3NNZW1vaXplT3B0aW9ucyA9IFtdLAogICAgICBkZXZNb2RlQ2hlY2tzID0ge30KICAgIH0gPSBjb21iaW5lZE9wdGlvbnM7CiAgICBjb25zdCBmaW5hbE1lbW9pemVPcHRpb25zID0gZW5zdXJlSXNBcnJheShtZW1vaXplT3B0aW9ucyk7CiAgICBjb25zdCBmaW5hbEFyZ3NNZW1vaXplT3B0aW9ucyA9IGVuc3VyZUlzQXJyYXkoYXJnc01lbW9pemVPcHRpb25zKTsKICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGdldERlcGVuZGVuY2llcyhjcmVhdGVTZWxlY3RvckFyZ3MpOwogICAgY29uc3QgbWVtb2l6ZWRSZXN1bHRGdW5jID0gbWVtb2l6ZShmdW5jdGlvbiByZWNvbXB1dGF0aW9uV3JhcHBlcigpIHsKICAgICAgcmVjb21wdXRhdGlvbnMrKzsKICAgICAgcmV0dXJuIHJlc3VsdEZ1bmMuYXBwbHkoCiAgICAgICAgbnVsbCwKICAgICAgICBhcmd1bWVudHMKICAgICAgKTsKICAgIH0sIC4uLmZpbmFsTWVtb2l6ZU9wdGlvbnMpOwogICAgbGV0IGZpcnN0UnVuID0gdHJ1ZTsKICAgIGNvbnN0IHNlbGVjdG9yID0gYXJnc01lbW9pemUoZnVuY3Rpb24gZGVwZW5kZW5jaWVzQ2hlY2tlcigpIHsKICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zKys7CiAgICAgIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgIGRlcGVuZGVuY2llcywKICAgICAgICBhcmd1bWVudHMKICAgICAgKTsKICAgICAgbGFzdFJlc3VsdCA9IG1lbW9pemVkUmVzdWx0RnVuYy5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0cyk7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2ssIGlucHV0U3RhYmlsaXR5Q2hlY2sgfSA9IGdldERldk1vZGVDaGVja3NFeGVjdXRpb25JbmZvKGZpcnN0UnVuLCBkZXZNb2RlQ2hlY2tzKTsKICAgICAgICBpZiAoaWRlbnRpdHlGdW5jdGlvbkNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLnJ1bigKICAgICAgICAgICAgcmVzdWx0RnVuYywKICAgICAgICAgICAgaW5wdXRTZWxlY3RvclJlc3VsdHMsCiAgICAgICAgICAgIGxhc3RSZXN1bHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChpbnB1dFN0YWJpbGl0eUNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5ID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgKTsKICAgICAgICAgIGlucHV0U3RhYmlsaXR5Q2hlY2sucnVuKAogICAgICAgICAgICB7IGlucHV0U2VsZWN0b3JSZXN1bHRzLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgfSwKICAgICAgICAgICAgeyBtZW1vaXplLCBtZW1vaXplT3B0aW9uczogZmluYWxNZW1vaXplT3B0aW9ucyB9LAogICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChmaXJzdFJ1bikKICAgICAgICAgIGZpcnN0UnVuID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RSZXN1bHQ7CiAgICB9LCAuLi5maW5hbEFyZ3NNZW1vaXplT3B0aW9ucyk7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihzZWxlY3RvciwgewogICAgICByZXN1bHRGdW5jLAogICAgICBtZW1vaXplZFJlc3VsdEZ1bmMsCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zOiAoKSA9PiBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMsCiAgICAgIHJlc2V0RGVwZW5kZW5jeVJlY29tcHV0YXRpb25zOiAoKSA9PiB7CiAgICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zID0gMDsKICAgICAgfSwKICAgICAgbGFzdFJlc3VsdDogKCkgPT4gbGFzdFJlc3VsdCwKICAgICAgcmVjb21wdXRhdGlvbnM6ICgpID0+IHJlY29tcHV0YXRpb25zLAogICAgICByZXNldFJlY29tcHV0YXRpb25zOiAoKSA9PiB7CiAgICAgICAgcmVjb21wdXRhdGlvbnMgPSAwOwogICAgICB9LAogICAgICBtZW1vaXplLAogICAgICBhcmdzTWVtb2l6ZQogICAgfSk7CiAgfTsKICBPYmplY3QuYXNzaWduKGNyZWF0ZVNlbGVjdG9yMiwgewogICAgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVTZWxlY3RvcjIKICB9KTsKICByZXR1cm4gY3JlYXRlU2VsZWN0b3IyOwp9CnZhciBjcmVhdGVTZWxlY3RvciA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVTZWxlY3RvckNyZWF0b3Iod2Vha01hcE1lbW9pemUpOwp2YXIgY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yID0gT2JqZWN0LmFzc2lnbigKICAoaW5wdXRTZWxlY3RvcnNPYmplY3QsIHNlbGVjdG9yQ3JlYXRvciA9IGNyZWF0ZVNlbGVjdG9yKSA9PiB7CiAgICBhc3NlcnRJc09iamVjdCgKICAgICAgaW5wdXRTZWxlY3RvcnNPYmplY3QsCiAgICAgIGBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgZXhwZWN0cyBmaXJzdCBhcmd1bWVudCB0byBiZSBhbiBvYmplY3Qgd2hlcmUgZWFjaCBwcm9wZXJ0eSBpcyBhIHNlbGVjdG9yLCBpbnN0ZWFkIHJlY2VpdmVkIGEgJHt0eXBlb2YgaW5wdXRTZWxlY3RvcnNPYmplY3R9YAogICAgKTsKICAgIGNvbnN0IGlucHV0U2VsZWN0b3JLZXlzID0gT2JqZWN0LmtleXMoaW5wdXRTZWxlY3RvcnNPYmplY3QpOwogICAgY29uc3QgZGVwZW5kZW5jaWVzID0gaW5wdXRTZWxlY3RvcktleXMubWFwKAogICAgICAoa2V5KSA9PiBpbnB1dFNlbGVjdG9yc09iamVjdFtrZXldCiAgICApOwogICAgY29uc3Qgc3RydWN0dXJlZFNlbGVjdG9yID0gc2VsZWN0b3JDcmVhdG9yKAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICguLi5pbnB1dFNlbGVjdG9yUmVzdWx0cykgPT4gewogICAgICAgIHJldHVybiBpbnB1dFNlbGVjdG9yUmVzdWx0cy5yZWR1Y2UoKGNvbXBvc2l0aW9uLCB2YWx1ZSwgaW5kZXgpID0+IHsKICAgICAgICAgIGNvbXBvc2l0aW9uW2lucHV0U2VsZWN0b3JLZXlzW2luZGV4XV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiBjb21wb3NpdGlvbjsKICAgICAgICB9LCB7fSk7CiAgICAgIH0KICAgICk7CiAgICByZXR1cm4gc3RydWN0dXJlZFNlbGVjdG9yOwogIH0sCiAgeyB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciB9Cik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvbGVnZW5kU2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfc29ydEJ5ID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CnZhciBzZWxlY3RMZWdlbmRTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnNldHRpbmdzOwp2YXIgc2VsZWN0TGVnZW5kU2l6ZSA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnNpemU7CnZhciBzZWxlY3RBbGxMZWdlbmRQYXlsb2FkMkRBcnJheSA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnBheWxvYWQ7CnZhciBzZWxlY3RMZWdlbmRQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbExlZ2VuZFBheWxvYWQyREFycmF5LCBzZWxlY3RMZWdlbmRTZXR0aW5nc10sIChwYXlsb2FkcywgX3JlZjIpID0+IHsKICB2YXIgewogICAgaXRlbVNvcnRlcgogIH0gPSBfcmVmMjsKICB2YXIgZmxhdCA9IHBheWxvYWRzLmZsYXQoMSk7CiAgcmV0dXJuIGl0ZW1Tb3J0ZXIgPyAoMCwgaW1wb3J0X3NvcnRCeS5kZWZhdWx0KShmbGF0LCBpdGVtU29ydGVyKSA6IGZsYXQ7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VFbGVtZW50T2Zmc2V0LmpzCnZhciBpbXBvcnRfcmVhY3QxMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIEVQUyA9IDE7CmZ1bmN0aW9uIHVzZUVsZW1lbnRPZmZzZXQoKSB7CiAgdmFyIGV4dHJhRGVwZW5kZW5jaWVzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiBbXTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgc2V0TGFzdEJvdW5kaW5nQm94XSA9ICgwLCBpbXBvcnRfcmVhY3QxMC51c2VTdGF0ZSkoewogICAgaGVpZ2h0OiAwLAogICAgbGVmdDogMCwKICAgIHRvcDogMCwKICAgIHdpZHRoOiAwCiAgfSk7CiAgdmFyIHVwZGF0ZUJvdW5kaW5nQm94ID0gKDAsIGltcG9ydF9yZWFjdDEwLnVzZUNhbGxiYWNrKSgKICAgIChub2RlKSA9PiB7CiAgICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgICB2YXIgcmVjdCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgdmFyIGJveCA9IHsKICAgICAgICAgIGhlaWdodDogcmVjdC5oZWlnaHQsCiAgICAgICAgICBsZWZ0OiByZWN0LmxlZnQsCiAgICAgICAgICB0b3A6IHJlY3QudG9wLAogICAgICAgICAgd2lkdGg6IHJlY3Qud2lkdGgKICAgICAgICB9OwogICAgICAgIGlmIChNYXRoLmFicyhib3guaGVpZ2h0IC0gbGFzdEJvdW5kaW5nQm94LmhlaWdodCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LmxlZnQgLSBsYXN0Qm91bmRpbmdCb3gubGVmdCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LnRvcCAtIGxhc3RCb3VuZGluZ0JveC50b3ApID4gRVBTIHx8IE1hdGguYWJzKGJveC53aWR0aCAtIGxhc3RCb3VuZGluZ0JveC53aWR0aCkgPiBFUFMpIHsKICAgICAgICAgIHNldExhc3RCb3VuZGluZ0JveCh7CiAgICAgICAgICAgIGhlaWdodDogYm94LmhlaWdodCwKICAgICAgICAgICAgbGVmdDogYm94LmxlZnQsCiAgICAgICAgICAgIHRvcDogYm94LnRvcCwKICAgICAgICAgICAgd2lkdGg6IGJveC53aWR0aAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwcwogICAgW2xhc3RCb3VuZGluZ0JveC53aWR0aCwgbGFzdEJvdW5kaW5nQm94LmhlaWdodCwgbGFzdEJvdW5kaW5nQm94LnRvcCwgbGFzdEJvdW5kaW5nQm94LmxlZnQsIC4uLmV4dHJhRGVwZW5kZW5jaWVzXQogICk7CiAgcmV0dXJuIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydExheW91dENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDEzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWR1eC9kaXN0L3JlZHV4Lm1qcwp2YXIgJCRvYnNlcnZhYmxlID0gLyogQF9fUFVSRV9fICovICgoKSA9PiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5vYnNlcnZhYmxlIHx8ICJAQG9ic2VydmFibGUiKSgpOwp2YXIgc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdCA9ICQkb2JzZXJ2YWJsZTsKdmFyIHJhbmRvbVN0cmluZyA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KS5zcGxpdCgiIikuam9pbigiLiIpOwp2YXIgQWN0aW9uVHlwZXMgPSB7CiAgSU5JVDogYEBAcmVkdXgvSU5JVCR7LyogQF9fUFVSRV9fICovIHJhbmRvbVN0cmluZygpfWAsCiAgUkVQTEFDRTogYEBAcmVkdXgvUkVQTEFDRSR7LyogQF9fUFVSRV9fICovIHJhbmRvbVN0cmluZygpfWAsCiAgUFJPQkVfVU5LTk9XTl9BQ1RJT046ICgpID0+IGBAQHJlZHV4L1BST0JFX1VOS05PV05fQUNUSU9OJHtyYW5kb21TdHJpbmcoKX1gCn07CnZhciBhY3Rpb25UeXBlc19kZWZhdWx0ID0gQWN0aW9uVHlwZXM7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkKICAgIHJldHVybiBmYWxzZTsKICBsZXQgcHJvdG8yID0gb2JqOwogIHdoaWxlIChPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8yKSAhPT0gbnVsbCkgewogICAgcHJvdG8yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgfQogIHJldHVybiBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gcHJvdG8yIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopID09PSBudWxsOwp9CmZ1bmN0aW9uIG1pbmlLaW5kT2YodmFsKSB7CiAgaWYgKHZhbCA9PT0gdm9pZCAwKQogICAgcmV0dXJuICJ1bmRlZmluZWQiOwogIGlmICh2YWwgPT09IG51bGwpCiAgICByZXR1cm4gIm51bGwiOwogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsOwogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSAiYm9vbGVhbiI6CiAgICBjYXNlICJzdHJpbmciOgogICAgY2FzZSAibnVtYmVyIjoKICAgIGNhc2UgInN5bWJvbCI6CiAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgcmV0dXJuIHR5cGU7CiAgICB9CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHZhbCkpCiAgICByZXR1cm4gImFycmF5IjsKICBpZiAoaXNEYXRlKHZhbCkpCiAgICByZXR1cm4gImRhdGUiOwogIGlmIChpc0Vycm9yKHZhbCkpCiAgICByZXR1cm4gImVycm9yIjsKICBjb25zdCBjb25zdHJ1Y3Rvck5hbWUgPSBjdG9yTmFtZSh2YWwpOwogIHN3aXRjaCAoY29uc3RydWN0b3JOYW1lKSB7CiAgICBjYXNlICJTeW1ib2wiOgogICAgY2FzZSAiUHJvbWlzZSI6CiAgICBjYXNlICJXZWFrTWFwIjoKICAgIGNhc2UgIldlYWtTZXQiOgogICAgY2FzZSAiTWFwIjoKICAgIGNhc2UgIlNldCI6CiAgICAgIHJldHVybiBjb25zdHJ1Y3Rvck5hbWU7CiAgfQogIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccy9nLCAiIik7Cn0KZnVuY3Rpb24gY3Rvck5hbWUodmFsKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWwuY29uc3RydWN0b3IgPT09ICJmdW5jdGlvbiIgPyB2YWwuY29uc3RydWN0b3IubmFtZSA6IG51bGw7Cn0KZnVuY3Rpb24gaXNFcnJvcih2YWwpIHsKICByZXR1cm4gdmFsIGluc3RhbmNlb2YgRXJyb3IgfHwgdHlwZW9mIHZhbC5tZXNzYWdlID09PSAic3RyaW5nIiAmJiB2YWwuY29uc3RydWN0b3IgJiYgdHlwZW9mIHZhbC5jb25zdHJ1Y3Rvci5zdGFja1RyYWNlTGltaXQgPT09ICJudW1iZXIiOwp9CmZ1bmN0aW9uIGlzRGF0ZSh2YWwpIHsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkKICAgIHJldHVybiB0cnVlOwogIHJldHVybiB0eXBlb2YgdmFsLnRvRGF0ZVN0cmluZyA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgdmFsLmdldERhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHZhbC5zZXREYXRlID09PSAiZnVuY3Rpb24iOwp9CmZ1bmN0aW9uIGtpbmRPZih2YWwpIHsKICBsZXQgdHlwZU9mVmFsID0gdHlwZW9mIHZhbDsKICBpZiAodHJ1ZSkgewogICAgdHlwZU9mVmFsID0gbWluaUtpbmRPZih2YWwpOwogIH0KICByZXR1cm4gdHlwZU9mVmFsOwp9CmZ1bmN0aW9uIGNyZWF0ZVN0b3JlKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlLCBlbmhhbmNlcikgewogIGlmICh0eXBlb2YgcmVkdWNlciAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyKSA6IGBFeHBlY3RlZCB0aGUgcm9vdCByZWR1Y2VyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YocmVkdWNlcil9J2ApOwogIH0KICBpZiAodHlwZW9mIHByZWxvYWRlZFN0YXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBlbmhhbmNlciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgZW5oYW5jZXIgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgwKSA6ICJJdCBsb29rcyBsaWtlIHlvdSBhcmUgcGFzc2luZyBzZXZlcmFsIHN0b3JlIGVuaGFuY2VycyB0byBjcmVhdGVTdG9yZSgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEluc3RlYWQsIGNvbXBvc2UgdGhlbSB0b2dldGhlciB0byBhIHNpbmdsZSBmdW5jdGlvbi4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC00LXN0b3JlI2NyZWF0aW5nLWEtc3RvcmUtd2l0aC1lbmhhbmNlcnMgZm9yIGFuIGV4YW1wbGUuIik7CiAgfQogIGlmICh0eXBlb2YgcHJlbG9hZGVkU3RhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGVuaGFuY2VyID09PSAidW5kZWZpbmVkIikgewogICAgZW5oYW5jZXIgPSBwcmVsb2FkZWRTdGF0ZTsKICAgIHByZWxvYWRlZFN0YXRlID0gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIGVuaGFuY2VyICE9PSAidW5kZWZpbmVkIikgewogICAgaWYgKHR5cGVvZiBlbmhhbmNlciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEpIDogYEV4cGVjdGVkIHRoZSBlbmhhbmNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKGVuaGFuY2VyKX0nYCk7CiAgICB9CiAgICByZXR1cm4gZW5oYW5jZXIoY3JlYXRlU3RvcmUpKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKTsKICB9CiAgbGV0IGN1cnJlbnRSZWR1Y2VyID0gcmVkdWNlcjsKICBsZXQgY3VycmVudFN0YXRlID0gcHJlbG9hZGVkU3RhdGU7CiAgbGV0IGN1cnJlbnRMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGxldCBuZXh0TGlzdGVuZXJzID0gY3VycmVudExpc3RlbmVyczsKICBsZXQgbGlzdGVuZXJJZENvdW50ZXIgPSAwOwogIGxldCBpc0Rpc3BhdGNoaW5nID0gZmFsc2U7CiAgZnVuY3Rpb24gZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpIHsKICAgIGlmIChuZXh0TGlzdGVuZXJzID09PSBjdXJyZW50TGlzdGVuZXJzKSB7CiAgICAgIG5leHRMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBjdXJyZW50TGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyMiwga2V5KSA9PiB7CiAgICAgICAgbmV4dExpc3RlbmVycy5zZXQoa2V5LCBsaXN0ZW5lcjIpOwogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0U3RhdGUoKSB7CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMpIDogIllvdSBtYXkgbm90IGNhbGwgc3RvcmUuZ2V0U3RhdGUoKSB3aGlsZSB0aGUgcmVkdWNlciBpcyBleGVjdXRpbmcuIFRoZSByZWR1Y2VyIGhhcyBhbHJlYWR5IHJlY2VpdmVkIHRoZSBzdGF0ZSBhcyBhbiBhcmd1bWVudC4gUGFzcyBpdCBkb3duIGZyb20gdGhlIHRvcCByZWR1Y2VyIGluc3RlYWQgb2YgcmVhZGluZyBpdCBmcm9tIHRoZSBzdG9yZS4iKTsKICAgIH0KICAgIHJldHVybiBjdXJyZW50U3RhdGU7CiAgfQogIGZ1bmN0aW9uIHN1YnNjcmliZShsaXN0ZW5lcjIpIHsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNCkgOiBgRXhwZWN0ZWQgdGhlIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YobGlzdGVuZXIyKX0nYCk7CiAgICB9CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDUpIDogIllvdSBtYXkgbm90IGNhbGwgc3RvcmUuc3Vic2NyaWJlKCkgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBJZiB5b3Ugd291bGQgbGlrZSB0byBiZSBub3RpZmllZCBhZnRlciB0aGUgc3RvcmUgaGFzIGJlZW4gdXBkYXRlZCwgc3Vic2NyaWJlIGZyb20gYSBjb21wb25lbnQgYW5kIGludm9rZSBzdG9yZS5nZXRTdGF0ZSgpIGluIHRoZSBjYWxsYmFjayB0byBhY2Nlc3MgdGhlIGxhdGVzdCBzdGF0ZS4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2FwaS9zdG9yZSNzdWJzY3JpYmVsaXN0ZW5lciBmb3IgbW9yZSBkZXRhaWxzLiIpOwogICAgfQogICAgbGV0IGlzU3Vic2NyaWJlZCA9IHRydWU7CiAgICBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCk7CiAgICBjb25zdCBsaXN0ZW5lcklkID0gbGlzdGVuZXJJZENvdW50ZXIrKzsKICAgIG5leHRMaXN0ZW5lcnMuc2V0KGxpc3RlbmVySWQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gZnVuY3Rpb24gdW5zdWJzY3JpYmUoKSB7CiAgICAgIGlmICghaXNTdWJzY3JpYmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChpc0Rpc3BhdGNoaW5nKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg2KSA6ICJZb3UgbWF5IG5vdCB1bnN1YnNjcmliZSBmcm9tIGEgc3RvcmUgbGlzdGVuZXIgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvYXBpL3N0b3JlI3N1YnNjcmliZWxpc3RlbmVyIGZvciBtb3JlIGRldGFpbHMuIik7CiAgICAgIH0KICAgICAgaXNTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKTsKICAgICAgbmV4dExpc3RlbmVycy5kZWxldGUobGlzdGVuZXJJZCk7CiAgICAgIGN1cnJlbnRMaXN0ZW5lcnMgPSBudWxsOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGlzcGF0Y2goYWN0aW9uKSB7CiAgICBpZiAoIWlzUGxhaW5PYmplY3QoYWN0aW9uKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDcpIDogYEFjdGlvbnMgbXVzdCBiZSBwbGFpbiBvYmplY3RzLiBJbnN0ZWFkLCB0aGUgYWN0dWFsIHR5cGUgd2FzOiAnJHtraW5kT2YoYWN0aW9uKX0nLiBZb3UgbWF5IG5lZWQgdG8gYWRkIG1pZGRsZXdhcmUgdG8geW91ciBzdG9yZSBzZXR1cCB0byBoYW5kbGUgZGlzcGF0Y2hpbmcgb3RoZXIgdmFsdWVzLCBzdWNoIGFzICdyZWR1eC10aHVuaycgdG8gaGFuZGxlIGRpc3BhdGNoaW5nIGZ1bmN0aW9ucy4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC00LXN0b3JlI21pZGRsZXdhcmUgYW5kIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC02LWFzeW5jLWxvZ2ljI3VzaW5nLXRoZS1yZWR1eC10aHVuay1taWRkbGV3YXJlIGZvciBleGFtcGxlcy5gKTsKICAgIH0KICAgIGlmICh0eXBlb2YgYWN0aW9uLnR5cGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoOCkgOiAnQWN0aW9ucyBtYXkgbm90IGhhdmUgYW4gdW5kZWZpbmVkICJ0eXBlIiBwcm9wZXJ0eS4gWW91IG1heSBoYXZlIG1pc3NwZWxsZWQgYW4gYWN0aW9uIHR5cGUgc3RyaW5nIGNvbnN0YW50LicpOwogICAgfQogICAgaWYgKHR5cGVvZiBhY3Rpb24udHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNykgOiBgQWN0aW9uICJ0eXBlIiBwcm9wZXJ0eSBtdXN0IGJlIGEgc3RyaW5nLiBJbnN0ZWFkLCB0aGUgYWN0dWFsIHR5cGUgd2FzOiAnJHtraW5kT2YoYWN0aW9uLnR5cGUpfScuIFZhbHVlIHdhczogJyR7YWN0aW9uLnR5cGV9JyAoc3RyaW5naWZpZWQpYCk7CiAgICB9CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDkpIDogIlJlZHVjZXJzIG1heSBub3QgZGlzcGF0Y2ggYWN0aW9ucy4iKTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGlzRGlzcGF0Y2hpbmcgPSB0cnVlOwogICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50UmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICB9IGZpbmFsbHkgewogICAgICBpc0Rpc3BhdGNoaW5nID0gZmFsc2U7CiAgICB9CiAgICBjb25zdCBsaXN0ZW5lcnMgPSBjdXJyZW50TGlzdGVuZXJzID0gbmV4dExpc3RlbmVyczsKICAgIGxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjIpID0+IHsKICAgICAgbGlzdGVuZXIyKCk7CiAgICB9KTsKICAgIHJldHVybiBhY3Rpb247CiAgfQogIGZ1bmN0aW9uIHJlcGxhY2VSZWR1Y2VyKG5leHRSZWR1Y2VyKSB7CiAgICBpZiAodHlwZW9mIG5leHRSZWR1Y2VyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTApIDogYEV4cGVjdGVkIHRoZSBuZXh0UmVkdWNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKG5leHRSZWR1Y2VyKX1gKTsKICAgIH0KICAgIGN1cnJlbnRSZWR1Y2VyID0gbmV4dFJlZHVjZXI7CiAgICBkaXNwYXRjaCh7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuUkVQTEFDRQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICBjb25zdCBvdXRlclN1YnNjcmliZSA9IHN1YnNjcmliZTsKICAgIHJldHVybiB7CiAgICAgIC8qKgogICAgICAgKiBUaGUgbWluaW1hbCBvYnNlcnZhYmxlIHN1YnNjcmlwdGlvbiBtZXRob2QuCiAgICAgICAqIEBwYXJhbSBvYnNlcnZlciBBbnkgb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgYXMgYW4gb2JzZXJ2ZXIuCiAgICAgICAqIFRoZSBvYnNlcnZlciBvYmplY3Qgc2hvdWxkIGhhdmUgYSBgbmV4dGAgbWV0aG9kLgogICAgICAgKiBAcmV0dXJucyBBbiBvYmplY3Qgd2l0aCBhbiBgdW5zdWJzY3JpYmVgIG1ldGhvZCB0aGF0IGNhbgogICAgICAgKiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlIHRoZSBvYnNlcnZhYmxlIGZyb20gdGhlIHN0b3JlLCBhbmQgcHJldmVudCBmdXJ0aGVyCiAgICAgICAqIGVtaXNzaW9uIG9mIHZhbHVlcyBmcm9tIHRoZSBvYnNlcnZhYmxlLgogICAgICAgKi8KICAgICAgc3Vic2NyaWJlKG9ic2VydmVyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYnNlcnZlciAhPT0gIm9iamVjdCIgfHwgb2JzZXJ2ZXIgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTEpIDogYEV4cGVjdGVkIHRoZSBvYnNlcnZlciB0byBiZSBhbiBvYmplY3QuIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2Yob2JzZXJ2ZXIpfSdgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb2JzZXJ2ZVN0YXRlKCkgewogICAgICAgICAgY29uc3Qgb2JzZXJ2ZXJBc09ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICAgICAgICBpZiAob2JzZXJ2ZXJBc09ic2VydmVyLm5leHQpIHsKICAgICAgICAgICAgb2JzZXJ2ZXJBc09ic2VydmVyLm5leHQoZ2V0U3RhdGUoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG9ic2VydmVTdGF0ZSgpOwogICAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gb3V0ZXJTdWJzY3JpYmUob2JzZXJ2ZVN0YXRlKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdW5zdWJzY3JpYmUKICAgICAgICB9OwogICAgICB9LAogICAgICBbc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdF0oKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH07CiAgfQogIGRpc3BhdGNoKHsKICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVAogIH0pOwogIGNvbnN0IHN0b3JlID0gewogICAgZGlzcGF0Y2gsCiAgICBzdWJzY3JpYmUsCiAgICBnZXRTdGF0ZSwKICAgIHJlcGxhY2VSZWR1Y2VyLAogICAgW3N5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHRdOiBvYnNlcnZhYmxlCiAgfTsKICByZXR1cm4gc3RvcmU7Cn0KZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7CiAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICB9CiAgdHJ5IHsKICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTsKICB9IGNhdGNoIChlKSB7CiAgfQp9CmZ1bmN0aW9uIGdldFVuZXhwZWN0ZWRTdGF0ZVNoYXBlV2FybmluZ01lc3NhZ2UoaW5wdXRTdGF0ZSwgcmVkdWNlcnMsIGFjdGlvbiwgdW5leHBlY3RlZEtleUNhY2hlKSB7CiAgY29uc3QgcmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgY29uc3QgYXJndW1lbnROYW1lID0gYWN0aW9uICYmIGFjdGlvbi50eXBlID09PSBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQgPyAicHJlbG9hZGVkU3RhdGUgYXJndW1lbnQgcGFzc2VkIHRvIGNyZWF0ZVN0b3JlIiA6ICJwcmV2aW91cyBzdGF0ZSByZWNlaXZlZCBieSB0aGUgcmVkdWNlciI7CiAgaWYgKHJlZHVjZXJLZXlzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuICJTdG9yZSBkb2VzIG5vdCBoYXZlIGEgdmFsaWQgcmVkdWNlci4gTWFrZSBzdXJlIHRoZSBhcmd1bWVudCBwYXNzZWQgdG8gY29tYmluZVJlZHVjZXJzIGlzIGFuIG9iamVjdCB3aG9zZSB2YWx1ZXMgYXJlIHJlZHVjZXJzLiI7CiAgfQogIGlmICghaXNQbGFpbk9iamVjdChpbnB1dFN0YXRlKSkgewogICAgcmV0dXJuIGBUaGUgJHthcmd1bWVudE5hbWV9IGhhcyB1bmV4cGVjdGVkIHR5cGUgb2YgIiR7a2luZE9mKGlucHV0U3RhdGUpfSIuIEV4cGVjdGVkIGFyZ3VtZW50IHRvIGJlIGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcga2V5czogIiR7cmVkdWNlcktleXMuam9pbignIiwgIicpfSJgOwogIH0KICBjb25zdCB1bmV4cGVjdGVkS2V5cyA9IE9iamVjdC5rZXlzKGlucHV0U3RhdGUpLmZpbHRlcigoa2V5KSA9PiAhcmVkdWNlcnMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdW5leHBlY3RlZEtleUNhY2hlW2tleV0pOwogIHVuZXhwZWN0ZWRLZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgdW5leHBlY3RlZEtleUNhY2hlW2tleV0gPSB0cnVlOwogIH0pOwogIGlmIChhY3Rpb24gJiYgYWN0aW9uLnR5cGUgPT09IGFjdGlvblR5cGVzX2RlZmF1bHQuUkVQTEFDRSkKICAgIHJldHVybjsKICBpZiAodW5leHBlY3RlZEtleXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGBVbmV4cGVjdGVkICR7dW5leHBlY3RlZEtleXMubGVuZ3RoID4gMSA/ICJrZXlzIiA6ICJrZXkifSAiJHt1bmV4cGVjdGVkS2V5cy5qb2luKCciLCAiJyl9IiBmb3VuZCBpbiAke2FyZ3VtZW50TmFtZX0uIEV4cGVjdGVkIHRvIGZpbmQgb25lIG9mIHRoZSBrbm93biByZWR1Y2VyIGtleXMgaW5zdGVhZDogIiR7cmVkdWNlcktleXMuam9pbignIiwgIicpfSIuIFVuZXhwZWN0ZWQga2V5cyB3aWxsIGJlIGlnbm9yZWQuYDsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0UmVkdWNlclNoYXBlKHJlZHVjZXJzKSB7CiAgT2JqZWN0LmtleXMocmVkdWNlcnMpLmZvckVhY2goKGtleSkgPT4gewogICAgY29uc3QgcmVkdWNlciA9IHJlZHVjZXJzW2tleV07CiAgICBjb25zdCBpbml0aWFsU3RhdGUxMyA9IHJlZHVjZXIodm9pZCAwLCB7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVAogICAgfSk7CiAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZTEzID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEyKSA6IGBUaGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZCBkdXJpbmcgaW5pdGlhbGl6YXRpb24uIElmIHRoZSBzdGF0ZSBwYXNzZWQgdG8gdGhlIHJlZHVjZXIgaXMgdW5kZWZpbmVkLCB5b3UgbXVzdCBleHBsaWNpdGx5IHJldHVybiB0aGUgaW5pdGlhbCBzdGF0ZS4gVGhlIGluaXRpYWwgc3RhdGUgbWF5IG5vdCBiZSB1bmRlZmluZWQuIElmIHlvdSBkb24ndCB3YW50IHRvIHNldCBhIHZhbHVlIGZvciB0aGlzIHJlZHVjZXIsIHlvdSBjYW4gdXNlIG51bGwgaW5zdGVhZCBvZiB1bmRlZmluZWQuYCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHJlZHVjZXIodm9pZCAwLCB7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuUFJPQkVfVU5LTk9XTl9BQ1RJT04oKQogICAgfSkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTMpIDogYFRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkIHdoZW4gcHJvYmVkIHdpdGggYSByYW5kb20gdHlwZS4gRG9uJ3QgdHJ5IHRvIGhhbmRsZSAnJHthY3Rpb25UeXBlc19kZWZhdWx0LklOSVR9JyBvciBvdGhlciBhY3Rpb25zIGluICJyZWR1eC8qIiBuYW1lc3BhY2UuIFRoZXkgYXJlIGNvbnNpZGVyZWQgcHJpdmF0ZS4gSW5zdGVhZCwgeW91IG11c3QgcmV0dXJuIHRoZSBjdXJyZW50IHN0YXRlIGZvciBhbnkgdW5rbm93biBhY3Rpb25zLCB1bmxlc3MgaXQgaXMgdW5kZWZpbmVkLCBpbiB3aGljaCBjYXNlIHlvdSBtdXN0IHJldHVybiB0aGUgaW5pdGlhbCBzdGF0ZSwgcmVnYXJkbGVzcyBvZiB0aGUgYWN0aW9uIHR5cGUuIFRoZSBpbml0aWFsIHN0YXRlIG1heSBub3QgYmUgdW5kZWZpbmVkLCBidXQgY2FuIGJlIG51bGwuYCk7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY29tYmluZVJlZHVjZXJzKHJlZHVjZXJzKSB7CiAgY29uc3QgcmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgY29uc3QgZmluYWxSZWR1Y2VycyA9IHt9OwogIGZvciAobGV0IGkgPSAwOyBpIDwgcmVkdWNlcktleXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGtleSA9IHJlZHVjZXJLZXlzW2ldOwogICAgaWYgKHRydWUpIHsKICAgICAgaWYgKHR5cGVvZiByZWR1Y2Vyc1trZXldID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHdhcm5pbmcoYE5vIHJlZHVjZXIgcHJvdmlkZWQgZm9yIGtleSAiJHtrZXl9ImApOwogICAgICB9CiAgICB9CiAgICBpZiAodHlwZW9mIHJlZHVjZXJzW2tleV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZmluYWxSZWR1Y2Vyc1trZXldID0gcmVkdWNlcnNba2V5XTsKICAgIH0KICB9CiAgY29uc3QgZmluYWxSZWR1Y2VyS2V5cyA9IE9iamVjdC5rZXlzKGZpbmFsUmVkdWNlcnMpOwogIGxldCB1bmV4cGVjdGVkS2V5Q2FjaGU7CiAgaWYgKHRydWUpIHsKICAgIHVuZXhwZWN0ZWRLZXlDYWNoZSA9IHt9OwogIH0KICBsZXQgc2hhcGVBc3NlcnRpb25FcnJvcjsKICB0cnkgewogICAgYXNzZXJ0UmVkdWNlclNoYXBlKGZpbmFsUmVkdWNlcnMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHNoYXBlQXNzZXJ0aW9uRXJyb3IgPSBlOwogIH0KICByZXR1cm4gZnVuY3Rpb24gY29tYmluYXRpb24oc3RhdGUgPSB7fSwgYWN0aW9uKSB7CiAgICBpZiAoc2hhcGVBc3NlcnRpb25FcnJvcikgewogICAgICB0aHJvdyBzaGFwZUFzc2VydGlvbkVycm9yOwogICAgfQogICAgaWYgKHRydWUpIHsKICAgICAgY29uc3Qgd2FybmluZ01lc3NhZ2UgPSBnZXRVbmV4cGVjdGVkU3RhdGVTaGFwZVdhcm5pbmdNZXNzYWdlKHN0YXRlLCBmaW5hbFJlZHVjZXJzLCBhY3Rpb24sIHVuZXhwZWN0ZWRLZXlDYWNoZSk7CiAgICAgIGlmICh3YXJuaW5nTWVzc2FnZSkgewogICAgICAgIHdhcm5pbmcod2FybmluZ01lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgICBsZXQgaGFzQ2hhbmdlZCA9IGZhbHNlOwogICAgY29uc3QgbmV4dFN0YXRlID0ge307CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbmFsUmVkdWNlcktleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0gZmluYWxSZWR1Y2VyS2V5c1tpXTsKICAgICAgY29uc3QgcmVkdWNlciA9IGZpbmFsUmVkdWNlcnNba2V5XTsKICAgICAgY29uc3QgcHJldmlvdXNTdGF0ZUZvcktleSA9IHN0YXRlW2tleV07CiAgICAgIGNvbnN0IG5leHRTdGF0ZUZvcktleSA9IHJlZHVjZXIocHJldmlvdXNTdGF0ZUZvcktleSwgYWN0aW9uKTsKICAgICAgaWYgKHR5cGVvZiBuZXh0U3RhdGVGb3JLZXkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgY29uc3QgYWN0aW9uVHlwZSA9IGFjdGlvbiAmJiBhY3Rpb24udHlwZTsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE0KSA6IGBXaGVuIGNhbGxlZCB3aXRoIGFuIGFjdGlvbiBvZiB0eXBlICR7YWN0aW9uVHlwZSA/IGAiJHtTdHJpbmcoYWN0aW9uVHlwZSl9ImAgOiAiKHVua25vd24gdHlwZSkifSwgdGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQuIFRvIGlnbm9yZSBhbiBhY3Rpb24sIHlvdSBtdXN0IGV4cGxpY2l0bHkgcmV0dXJuIHRoZSBwcmV2aW91cyBzdGF0ZS4gSWYgeW91IHdhbnQgdGhpcyByZWR1Y2VyIHRvIGhvbGQgbm8gdmFsdWUsIHlvdSBjYW4gcmV0dXJuIG51bGwgaW5zdGVhZCBvZiB1bmRlZmluZWQuYCk7CiAgICAgIH0KICAgICAgbmV4dFN0YXRlW2tleV0gPSBuZXh0U3RhdGVGb3JLZXk7CiAgICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IG5leHRTdGF0ZUZvcktleSAhPT0gcHJldmlvdXNTdGF0ZUZvcktleTsKICAgIH0KICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IGZpbmFsUmVkdWNlcktleXMubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhzdGF0ZSkubGVuZ3RoOwogICAgcmV0dXJuIGhhc0NoYW5nZWQgPyBuZXh0U3RhdGUgOiBzdGF0ZTsKICB9Owp9CmZ1bmN0aW9uIGNvbXBvc2UoLi4uZnVuY3MpIHsKICBpZiAoZnVuY3MubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gKGFyZykgPT4gYXJnOwogIH0KICBpZiAoZnVuY3MubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gZnVuY3NbMF07CiAgfQogIHJldHVybiBmdW5jcy5yZWR1Y2UoKGEsIGIpID0+ICguLi5hcmdzKSA9PiBhKGIoLi4uYXJncykpKTsKfQpmdW5jdGlvbiBhcHBseU1pZGRsZXdhcmUoLi4ubWlkZGxld2FyZXMpIHsKICByZXR1cm4gKGNyZWF0ZVN0b3JlMikgPT4gKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKSA9PiB7CiAgICBjb25zdCBzdG9yZSA9IGNyZWF0ZVN0b3JlMihyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgICBsZXQgZGlzcGF0Y2ggPSAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogIkRpc3BhdGNoaW5nIHdoaWxlIGNvbnN0cnVjdGluZyB5b3VyIG1pZGRsZXdhcmUgaXMgbm90IGFsbG93ZWQuIE90aGVyIG1pZGRsZXdhcmUgd291bGQgbm90IGJlIGFwcGxpZWQgdG8gdGhpcyBkaXNwYXRjaC4iKTsKICAgIH07CiAgICBjb25zdCBtaWRkbGV3YXJlQVBJID0gewogICAgICBnZXRTdGF0ZTogc3RvcmUuZ2V0U3RhdGUsCiAgICAgIGRpc3BhdGNoOiAoYWN0aW9uLCAuLi5hcmdzKSA9PiBkaXNwYXRjaChhY3Rpb24sIC4uLmFyZ3MpCiAgICB9OwogICAgY29uc3QgY2hhaW4gPSBtaWRkbGV3YXJlcy5tYXAoKG1pZGRsZXdhcmUpID0+IG1pZGRsZXdhcmUobWlkZGxld2FyZUFQSSkpOwogICAgZGlzcGF0Y2ggPSBjb21wb3NlKC4uLmNoYWluKShzdG9yZS5kaXNwYXRjaCk7CiAgICByZXR1cm4gewogICAgICAuLi5zdG9yZSwKICAgICAgZGlzcGF0Y2gKICAgIH07CiAgfTsKfQpmdW5jdGlvbiBpc0FjdGlvbihhY3Rpb24pIHsKICByZXR1cm4gaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICJ0eXBlIiBpbiBhY3Rpb24gJiYgdHlwZW9mIGFjdGlvbi50eXBlID09PSAic3RyaW5nIjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2ltbWVyQDExLjAuMS9ub2RlX21vZHVsZXMvaW1tZXIvZGlzdC9pbW1lci5tanMKdmFyIE5PVEhJTkcgPSBTeW1ib2wuZm9yKCJpbW1lci1ub3RoaW5nIik7CnZhciBEUkFGVEFCTEUgPSBTeW1ib2wuZm9yKCJpbW1lci1kcmFmdGFibGUiKTsKdmFyIERSQUZUX1NUQVRFID0gU3ltYm9sLmZvcigiaW1tZXItc3RhdGUiKTsKdmFyIGVycm9ycyA9IHRydWUgPyBbCiAgLy8gQWxsIGVycm9yIGNvZGVzLCBzdGFydGluZyBieSAwOgogIGZ1bmN0aW9uKHBsdWdpbikgewogICAgcmV0dXJuIGBUaGUgcGx1Z2luIGZvciAnJHtwbHVnaW59JyBoYXMgbm90IGJlZW4gbG9hZGVkIGludG8gSW1tZXIuIFRvIGVuYWJsZSB0aGUgcGx1Z2luLCBpbXBvcnQgYW5kIGNhbGwgXGBlbmFibGUke3BsdWdpbn0oKVxgIHdoZW4gaW5pdGlhbGl6aW5nIHlvdXIgYXBwbGljYXRpb24uYDsKICB9LAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYHByb2R1Y2UgY2FuIG9ubHkgYmUgY2FsbGVkIG9uIHRoaW5ncyB0aGF0IGFyZSBkcmFmdGFibGU6IHBsYWluIG9iamVjdHMsIGFycmF5cywgTWFwLCBTZXQgb3IgY2xhc3NlcyB0aGF0IGFyZSBtYXJrZWQgd2l0aCAnW2ltbWVyYWJsZV06IHRydWUnLiBHb3QgJyR7dGhpbmd9J2A7CiAgfSwKICAiVGhpcyBvYmplY3QgaGFzIGJlZW4gZnJvemVuIGFuZCBzaG91bGQgbm90IGJlIG11dGF0ZWQiLAogIGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiAiQ2Fubm90IHVzZSBhIHByb3h5IHRoYXQgaGFzIGJlZW4gcmV2b2tlZC4gRGlkIHlvdSBwYXNzIGFuIG9iamVjdCBmcm9tIGluc2lkZSBhbiBpbW1lciBmdW5jdGlvbiB0byBhbiBhc3luYyBwcm9jZXNzPyAiICsgZGF0YTsKICB9LAogICJBbiBpbW1lciBwcm9kdWNlciByZXR1cm5lZCBhIG5ldyB2YWx1ZSAqYW5kKiBtb2RpZmllZCBpdHMgZHJhZnQuIEVpdGhlciByZXR1cm4gYSBuZXcgdmFsdWUgKm9yKiBtb2RpZnkgdGhlIGRyYWZ0LiIsCiAgIkltbWVyIGZvcmJpZHMgY2lyY3VsYXIgcmVmZXJlbmNlcyIsCiAgIlRoZSBmaXJzdCBvciBzZWNvbmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiIsCiAgIlRoZSB0aGlyZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIHVuZGVmaW5lZCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBjcmVhdGVEcmFmdGAgbXVzdCBiZSBhIHBsYWluIG9iamVjdCwgYW4gYXJyYXksIG9yIGFuIGltbWVyYWJsZSBvYmplY3QiLAogICJGaXJzdCBhcmd1bWVudCB0byBgZmluaXNoRHJhZnRgIG11c3QgYmUgYSBkcmFmdCByZXR1cm5lZCBieSBgY3JlYXRlRHJhZnRgIiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnY3VycmVudCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9LAogICJPYmplY3QuZGVmaW5lUHJvcGVydHkoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIk9iamVjdC5zZXRQcm90b3R5cGVPZigpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBkZWxldGluZyBhcnJheSBpbmRpY2VzIiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBzZXR0aW5nIGFycmF5IGluZGljZXMgYW5kIHRoZSAnbGVuZ3RoJyBwcm9wZXJ0eSIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ29yaWdpbmFsJyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0KICAvLyBOb3RlOiBpZiBtb3JlIGVycm9ycyBhcmUgYWRkZWQsIHRoZSBlcnJvck9mZnNldCBpbiBQYXRjaGVzLnRzIHNob3VsZCBiZSBpbmNyZWFzZWQKICAvLyBTZWUgUGF0Y2hlcy50cyBmb3IgYWRkaXRpb25hbCBlcnJvcnMKXSA6IFtdOwpmdW5jdGlvbiBkaWUoZXJyb3IsIC4uLmFyZ3MpIHsKICBpZiAodHJ1ZSkgewogICAgY29uc3QgZSA9IGVycm9yc1tlcnJvcl07CiAgICBjb25zdCBtc2cgPSBpc0Z1bmN0aW9uKGUpID8gZS5hcHBseShudWxsLCBhcmdzKSA6IGU7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtJbW1lcl0gJHttc2d9YCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBbSW1tZXJdIG1pbmlmaWVkIGVycm9yIG5yOiAke2Vycm9yfS4gRnVsbCBlcnJvciBhdDogaHR0cHM6Ly9iaXQubHkvM2NYRUtXZmAKICApOwp9CnZhciBPID0gT2JqZWN0Owp2YXIgZ2V0UHJvdG90eXBlT2YgPSBPLmdldFByb3RvdHlwZU9mOwp2YXIgQ09OU1RSVUNUT1IgPSAiY29uc3RydWN0b3IiOwp2YXIgUFJPVE9UWVBFID0gInByb3RvdHlwZSI7CnZhciBDT05GSUdVUkFCTEUgPSAiY29uZmlndXJhYmxlIjsKdmFyIEVOVU1FUkFCTEUgPSAiZW51bWVyYWJsZSI7CnZhciBXUklUQUJMRSA9ICJ3cml0YWJsZSI7CnZhciBWQUxVRSA9ICJ2YWx1ZSI7CnZhciBpc0RyYWZ0ID0gKHZhbHVlKSA9PiAhIXZhbHVlICYmICEhdmFsdWVbRFJBRlRfU1RBVEVdOwpmdW5jdGlvbiBpc0RyYWZ0YWJsZSh2YWx1ZSkgewogIGlmICghdmFsdWUpCiAgICByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QyKHZhbHVlKSB8fCBpc0FycmF5KHZhbHVlKSB8fCAhIXZhbHVlW0RSQUZUQUJMRV0gfHwgISF2YWx1ZVtDT05TVFJVQ1RPUl0/LltEUkFGVEFCTEVdIHx8IGlzTWFwKHZhbHVlKSB8fCBpc1NldCh2YWx1ZSk7Cn0KdmFyIG9iamVjdEN0b3JTdHJpbmcgPSBPW1BST1RPVFlQRV1bQ09OU1RSVUNUT1JdLnRvU3RyaW5nKCk7CnZhciBjYWNoZWRDdG9yU3RyaW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0Mih2YWx1ZSkgewogIGlmICghdmFsdWUgfHwgIWlzT2JqZWN0aXNoKHZhbHVlKSkKICAgIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgaWYgKHByb3RvMiA9PT0gbnVsbCB8fCBwcm90bzIgPT09IE9bUFJPVE9UWVBFXSkKICAgIHJldHVybiB0cnVlOwogIGNvbnN0IEN0b3IgPSBPLmhhc093blByb3BlcnR5LmNhbGwocHJvdG8yLCBDT05TVFJVQ1RPUikgJiYgcHJvdG8yW0NPTlNUUlVDVE9SXTsKICBpZiAoQ3RvciA9PT0gT2JqZWN0KQogICAgcmV0dXJuIHRydWU7CiAgaWYgKCFpc0Z1bmN0aW9uKEN0b3IpKQogICAgcmV0dXJuIGZhbHNlOwogIGxldCBjdG9yU3RyaW5nID0gY2FjaGVkQ3RvclN0cmluZ3MuZ2V0KEN0b3IpOwogIGlmIChjdG9yU3RyaW5nID09PSB2b2lkIDApIHsKICAgIGN0b3JTdHJpbmcgPSBGdW5jdGlvbi50b1N0cmluZy5jYWxsKEN0b3IpOwogICAgY2FjaGVkQ3RvclN0cmluZ3Muc2V0KEN0b3IsIGN0b3JTdHJpbmcpOwogIH0KICByZXR1cm4gY3RvclN0cmluZyA9PT0gb2JqZWN0Q3RvclN0cmluZzsKfQpmdW5jdGlvbiBlYWNoKG9iaiwgaXRlciwgc3RyaWN0ID0gdHJ1ZSkgewogIGlmIChnZXRBcmNodHlwZShvYmopID09PSAwKSB7CiAgICBjb25zdCBrZXlzID0gc3RyaWN0ID8gUmVmbGVjdC5vd25LZXlzKG9iaikgOiBPLmtleXMob2JqKTsKICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIGl0ZXIoa2V5LCBvYmpba2V5XSwgb2JqKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBvYmouZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiBpdGVyKGluZGV4LCBlbnRyeSwgb2JqKSk7CiAgfQp9CmZ1bmN0aW9uIGdldEFyY2h0eXBlKHRoaW5nKSB7CiAgY29uc3Qgc3RhdGUgPSB0aGluZ1tEUkFGVF9TVEFURV07CiAgcmV0dXJuIHN0YXRlID8gc3RhdGUudHlwZV8gOiBpc0FycmF5KHRoaW5nKSA/IDEgOiBpc01hcCh0aGluZykgPyAyIDogaXNTZXQodGhpbmcpID8gMyA6IDA7Cn0KdmFyIGhhcyA9ICh0aGluZywgcHJvcCwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gdHlwZSA9PT0gMiA/IHRoaW5nLmhhcyhwcm9wKSA6IE9bUFJPVE9UWVBFXS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaW5nLCBwcm9wKTsKdmFyIGdldDIgPSAodGhpbmcsIHByb3AsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+ICgKICAvLyBAdHMtaWdub3JlCiAgdHlwZSA9PT0gMiA/IHRoaW5nLmdldChwcm9wKSA6IHRoaW5nW3Byb3BdCik7CnZhciBzZXQgPSAodGhpbmcsIHByb3BPck9sZFZhbHVlLCB2YWx1ZSwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gewogIGlmICh0eXBlID09PSAyKQogICAgdGhpbmcuc2V0KHByb3BPck9sZFZhbHVlLCB2YWx1ZSk7CiAgZWxzZSBpZiAodHlwZSA9PT0gMykgewogICAgdGhpbmcuYWRkKHZhbHVlKTsKICB9IGVsc2UKICAgIHRoaW5nW3Byb3BPck9sZFZhbHVlXSA9IHZhbHVlOwp9OwpmdW5jdGlvbiBpcyh4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CnZhciBpc01hcCA9ICh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIE1hcDsKdmFyIGlzU2V0ID0gKHRhcmdldCkgPT4gdGFyZ2V0IGluc3RhbmNlb2YgU2V0Owp2YXIgaXNPYmplY3Rpc2ggPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAib2JqZWN0IjsKdmFyIGlzRnVuY3Rpb24gPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAiZnVuY3Rpb24iOwp2YXIgaXNCb29sZWFuID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iOwp2YXIgbGF0ZXN0ID0gKHN0YXRlKSA9PiBzdGF0ZS5jb3B5XyB8fCBzdGF0ZS5iYXNlXzsKdmFyIGdldEZpbmFsVmFsdWUgPSAoc3RhdGUpID0+IHN0YXRlLm1vZGlmaWVkXyA/IHN0YXRlLmNvcHlfIDogc3RhdGUuYmFzZV87CmZ1bmN0aW9uIHNoYWxsb3dDb3B5KGJhc2UsIHN0cmljdCkgewogIGlmIChpc01hcChiYXNlKSkgewogICAgcmV0dXJuIG5ldyBNYXAoYmFzZSk7CiAgfQogIGlmIChpc1NldChiYXNlKSkgewogICAgcmV0dXJuIG5ldyBTZXQoYmFzZSk7CiAgfQogIGlmIChpc0FycmF5KGJhc2UpKQogICAgcmV0dXJuIEFycmF5W1BST1RPVFlQRV0uc2xpY2UuY2FsbChiYXNlKTsKICBjb25zdCBpc1BsYWluMiA9IGlzUGxhaW5PYmplY3QyKGJhc2UpOwogIGlmIChzdHJpY3QgPT09IHRydWUgfHwgc3RyaWN0ID09PSAiY2xhc3Nfb25seSIgJiYgIWlzUGxhaW4yKSB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE8uZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiYXNlKTsKICAgIGRlbGV0ZSBkZXNjcmlwdG9yc1tEUkFGVF9TVEFURV07CiAgICBsZXQga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhkZXNjcmlwdG9ycyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgY29uc3QgZGVzYyA9IGRlc2NyaXB0b3JzW2tleV07CiAgICAgIGlmIChkZXNjW1dSSVRBQkxFXSA9PT0gZmFsc2UpIHsKICAgICAgICBkZXNjW1dSSVRBQkxFXSA9IHRydWU7CiAgICAgICAgZGVzY1tDT05GSUdVUkFCTEVdID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpCiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IHsKICAgICAgICAgIFtDT05GSUdVUkFCTEVdOiB0cnVlLAogICAgICAgICAgW1dSSVRBQkxFXTogdHJ1ZSwKICAgICAgICAgIC8vIGNvdWxkIGxpdmUgd2l0aCAhIWRlc2Muc2V0IGFzIHdlbGwgaGVyZS4uLgogICAgICAgICAgW0VOVU1FUkFCTEVdOiBkZXNjW0VOVU1FUkFCTEVdLAogICAgICAgICAgW1ZBTFVFXTogYmFzZVtrZXldCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPLmNyZWF0ZShnZXRQcm90b3R5cGVPZihiYXNlKSwgZGVzY3JpcHRvcnMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZihiYXNlKTsKICAgIGlmIChwcm90bzIgIT09IG51bGwgJiYgaXNQbGFpbjIpIHsKICAgICAgcmV0dXJuIHsgLi4uYmFzZSB9OwogICAgfQogICAgY29uc3Qgb2JqID0gTy5jcmVhdGUocHJvdG8yKTsKICAgIHJldHVybiBPLmFzc2lnbihvYmosIGJhc2UpOwogIH0KfQpmdW5jdGlvbiBmcmVlemUob2JqLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoaXNGcm96ZW4ob2JqKSB8fCBpc0RyYWZ0KG9iaikgfHwgIWlzRHJhZnRhYmxlKG9iaikpCiAgICByZXR1cm4gb2JqOwogIGlmIChnZXRBcmNodHlwZShvYmopID4gMSkgewogICAgTy5kZWZpbmVQcm9wZXJ0aWVzKG9iaiwgewogICAgICBzZXQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZSwKICAgICAgYWRkOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGNsZWFyOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGRlbGV0ZTogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlCiAgICB9KTsKICB9CiAgTy5mcmVlemUob2JqKTsKICBpZiAoZGVlcCkKICAgIGVhY2goCiAgICAgIG9iaiwKICAgICAgKF9rZXksIHZhbHVlKSA9PiB7CiAgICAgICAgZnJlZXplKHZhbHVlLCB0cnVlKTsKICAgICAgfSwKICAgICAgZmFsc2UKICAgICk7CiAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMoKSB7CiAgZGllKDIpOwp9CnZhciBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUgPSB7CiAgW1ZBTFVFXTogZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zCn07CmZ1bmN0aW9uIGlzRnJvemVuKG9iaikgewogIGlmIChvYmogPT09IG51bGwgfHwgIWlzT2JqZWN0aXNoKG9iaikpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gTy5pc0Zyb3plbihvYmopOwp9CnZhciBQbHVnaW5NYXBTZXQgPSAiTWFwU2V0IjsKdmFyIFBsdWdpblBhdGNoZXMgPSAiUGF0Y2hlcyI7CnZhciBwbHVnaW5zID0ge307CmZ1bmN0aW9uIGdldFBsdWdpbihwbHVnaW5LZXkpIHsKICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zW3BsdWdpbktleV07CiAgaWYgKCFwbHVnaW4pIHsKICAgIGRpZSgwLCBwbHVnaW5LZXkpOwogIH0KICByZXR1cm4gcGx1Z2luOwp9CnZhciBpc1BsdWdpbkxvYWRlZCA9IChwbHVnaW5LZXkpID0+ICEhcGx1Z2luc1twbHVnaW5LZXldOwp2YXIgY3VycmVudFNjb3BlOwp2YXIgZ2V0Q3VycmVudFNjb3BlID0gKCkgPT4gY3VycmVudFNjb3BlOwp2YXIgY3JlYXRlU2NvcGUgPSAocGFyZW50XywgaW1tZXJfKSA9PiAoewogIGRyYWZ0c186IFtdLAogIHBhcmVudF8sCiAgaW1tZXJfLAogIC8vIFdoZW5ldmVyIHRoZSBtb2RpZmllZCBkcmFmdCBjb250YWlucyBhIGRyYWZ0IGZyb20gYW5vdGhlciBzY29wZSwgd2UKICAvLyBuZWVkIHRvIHByZXZlbnQgYXV0by1mcmVlemluZyBzbyB0aGUgdW5vd25lZCBkcmFmdCBjYW4gYmUgZmluYWxpemVkLgogIGNhbkF1dG9GcmVlemVfOiB0cnVlLAogIHVuZmluYWxpemVkRHJhZnRzXzogMCwKICBoYW5kbGVkU2V0XzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICBwcm9jZXNzZWRGb3JQYXRjaGVzXzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICBtYXBTZXRQbHVnaW5fOiBpc1BsdWdpbkxvYWRlZChQbHVnaW5NYXBTZXQpID8gZ2V0UGx1Z2luKFBsdWdpbk1hcFNldCkgOiB2b2lkIDAKfSk7CmZ1bmN0aW9uIHVzZVBhdGNoZXNJblNjb3BlKHNjb3BlLCBwYXRjaExpc3RlbmVyKSB7CiAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgIHNjb3BlLnBhdGNoUGx1Z2luXyA9IGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKTsKICAgIHNjb3BlLnBhdGNoZXNfID0gW107CiAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfID0gcGF0Y2hMaXN0ZW5lcjsKICB9Cn0KZnVuY3Rpb24gcmV2b2tlU2NvcGUoc2NvcGUpIHsKICBsZWF2ZVNjb3BlKHNjb3BlKTsKICBzY29wZS5kcmFmdHNfLmZvckVhY2gocmV2b2tlRHJhZnQpOwogIHNjb3BlLmRyYWZ0c18gPSBudWxsOwp9CmZ1bmN0aW9uIGxlYXZlU2NvcGUoc2NvcGUpIHsKICBpZiAoc2NvcGUgPT09IGN1cnJlbnRTY29wZSkgewogICAgY3VycmVudFNjb3BlID0gc2NvcGUucGFyZW50XzsKICB9Cn0KdmFyIGVudGVyU2NvcGUgPSAoaW1tZXIyMikgPT4gY3VycmVudFNjb3BlID0gY3JlYXRlU2NvcGUoY3VycmVudFNjb3BlLCBpbW1lcjIyKTsKZnVuY3Rpb24gcmV2b2tlRHJhZnQoZHJhZnQpIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFXTsKICBpZiAoc3RhdGUudHlwZV8gPT09IDAgfHwgc3RhdGUudHlwZV8gPT09IDEpCiAgICBzdGF0ZS5yZXZva2VfKCk7CiAgZWxzZQogICAgc3RhdGUucmV2b2tlZF8gPSB0cnVlOwp9CmZ1bmN0aW9uIHByb2Nlc3NSZXN1bHQocmVzdWx0LCBzY29wZSkgewogIHNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA9IHNjb3BlLmRyYWZ0c18ubGVuZ3RoOwogIGNvbnN0IGJhc2VEcmFmdCA9IHNjb3BlLmRyYWZ0c19bMF07CiAgY29uc3QgaXNSZXBsYWNlZCA9IHJlc3VsdCAhPT0gdm9pZCAwICYmIHJlc3VsdCAhPT0gYmFzZURyYWZ0OwogIGlmIChpc1JlcGxhY2VkKSB7CiAgICBpZiAoYmFzZURyYWZ0W0RSQUZUX1NUQVRFXS5tb2RpZmllZF8pIHsKICAgICAgcmV2b2tlU2NvcGUoc2NvcGUpOwogICAgICBkaWUoNCk7CiAgICB9CiAgICBpZiAoaXNEcmFmdGFibGUocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBmaW5hbGl6ZShzY29wZSwgcmVzdWx0KTsKICAgIH0KICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSBzY29wZTsKICAgIGlmIChwYXRjaFBsdWdpbl8pIHsKICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXygKICAgICAgICBiYXNlRHJhZnRbRFJBRlRfU1RBVEVdLmJhc2VfLAogICAgICAgIHJlc3VsdCwKICAgICAgICBzY29wZQogICAgICApOwogICAgfQogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBmaW5hbGl6ZShzY29wZSwgYmFzZURyYWZ0KTsKICB9CiAgbWF5YmVGcmVlemUoc2NvcGUsIHJlc3VsdCwgdHJ1ZSk7CiAgcmV2b2tlU2NvcGUoc2NvcGUpOwogIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8oc2NvcGUucGF0Y2hlc18sIHNjb3BlLmludmVyc2VQYXRjaGVzXyk7CiAgfQogIHJldHVybiByZXN1bHQgIT09IE5PVEhJTkcgPyByZXN1bHQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZmluYWxpemUocm9vdFNjb3BlLCB2YWx1ZSkgewogIGlmIChpc0Zyb3plbih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgaWYgKCFzdGF0ZSkgewogICAgY29uc3QgZmluYWxWYWx1ZSA9IGhhbmRsZVZhbHVlKHZhbHVlLCByb290U2NvcGUuaGFuZGxlZFNldF8sIHJvb3RTY29wZSk7CiAgICByZXR1cm4gZmluYWxWYWx1ZTsKICB9CiAgaWYgKCFpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogIH0KICBpZiAoIXN0YXRlLmZpbmFsaXplZF8pIHsKICAgIGNvbnN0IHsgY2FsbGJhY2tzXyB9ID0gc3RhdGU7CiAgICBpZiAoY2FsbGJhY2tzXykgewogICAgICB3aGlsZSAoY2FsbGJhY2tzXy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSBjYWxsYmFja3NfLnBvcCgpOwogICAgICAgIGNhbGxiYWNrKHJvb3RTY29wZSk7CiAgICAgIH0KICAgIH0KICAgIGdlbmVyYXRlUGF0Y2hlc0FuZEZpbmFsaXplKHN0YXRlLCByb290U2NvcGUpOwogIH0KICByZXR1cm4gc3RhdGUuY29weV87Cn0KZnVuY3Rpb24gbWF5YmVGcmVlemUoc2NvcGUsIHZhbHVlLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoIXNjb3BlLnBhcmVudF8gJiYgc2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHNjb3BlLmNhbkF1dG9GcmVlemVfKSB7CiAgICBmcmVlemUodmFsdWUsIGRlZXApOwogIH0KfQpmdW5jdGlvbiBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpIHsKICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICBzdGF0ZS5zY29wZV8udW5maW5hbGl6ZWREcmFmdHNfLS07Cn0KdmFyIGlzU2FtZVNjb3BlID0gKHN0YXRlLCByb290U2NvcGUpID0+IHN0YXRlLnNjb3BlXyA9PT0gcm9vdFNjb3BlOwp2YXIgRU1QVFlfTE9DQVRJT05TX1JFU1VMVCA9IFtdOwpmdW5jdGlvbiB1cGRhdGVEcmFmdEluUGFyZW50KHBhcmVudCwgZHJhZnRWYWx1ZSwgZmluYWxpemVkVmFsdWUsIG9yaWdpbmFsS2V5KSB7CiAgY29uc3QgcGFyZW50Q29weSA9IGxhdGVzdChwYXJlbnQpOwogIGNvbnN0IHBhcmVudFR5cGUgPSBwYXJlbnQudHlwZV87CiAgaWYgKG9yaWdpbmFsS2V5ICE9PSB2b2lkIDApIHsKICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGdldDIocGFyZW50Q29weSwgb3JpZ2luYWxLZXksIHBhcmVudFR5cGUpOwogICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gZHJhZnRWYWx1ZSkgewogICAgICBzZXQocGFyZW50Q29weSwgb3JpZ2luYWxLZXksIGZpbmFsaXplZFZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgcmV0dXJuOwogICAgfQogIH0KICBpZiAoIXBhcmVudC5kcmFmdExvY2F0aW9uc18pIHsKICAgIGNvbnN0IGRyYWZ0TG9jYXRpb25zID0gcGFyZW50LmRyYWZ0TG9jYXRpb25zXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBlYWNoKHBhcmVudENvcHksIChrZXksIHZhbHVlKSA9PiB7CiAgICAgIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgICAgIGNvbnN0IGtleXMgPSBkcmFmdExvY2F0aW9ucy5nZXQodmFsdWUpIHx8IFtdOwogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgIGRyYWZ0TG9jYXRpb25zLnNldCh2YWx1ZSwga2V5cyk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb25zdCBsb2NhdGlvbnMgPSBwYXJlbnQuZHJhZnRMb2NhdGlvbnNfLmdldChkcmFmdFZhbHVlKSA/PyBFTVBUWV9MT0NBVElPTlNfUkVTVUxUOwogIGZvciAoY29uc3QgbG9jYXRpb24gb2YgbG9jYXRpb25zKSB7CiAgICBzZXQocGFyZW50Q29weSwgbG9jYXRpb24sIGZpbmFsaXplZFZhbHVlLCBwYXJlbnRUeXBlKTsKICB9Cn0KZnVuY3Rpb24gcmVnaXN0ZXJDaGlsZEZpbmFsaXphdGlvbkNhbGxiYWNrKHBhcmVudCwgY2hpbGQsIGtleSkgewogIHBhcmVudC5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gY2hpbGRDbGVhbnVwKHJvb3RTY29wZSkgewogICAgY29uc3Qgc3RhdGUgPSBjaGlsZDsKICAgIGlmICghc3RhdGUgfHwgIWlzU2FtZVNjb3BlKHN0YXRlLCByb290U2NvcGUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJvb3RTY29wZS5tYXBTZXRQbHVnaW5fPy5maXhTZXRDb250ZW50cyhzdGF0ZSk7CiAgICBjb25zdCBmaW5hbGl6ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgdXBkYXRlRHJhZnRJblBhcmVudChwYXJlbnQsIHN0YXRlLmRyYWZ0XyA/PyBzdGF0ZSwgZmluYWxpemVkVmFsdWUsIGtleSk7CiAgICBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKTsKICB9KTsKfQpmdW5jdGlvbiBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKSB7CiAgY29uc3Qgc2hvdWxkRmluYWxpemUgPSBzdGF0ZS5tb2RpZmllZF8gJiYgIXN0YXRlLmZpbmFsaXplZF8gJiYgKHN0YXRlLnR5cGVfID09PSAzIHx8IChzdGF0ZS5hc3NpZ25lZF8/LnNpemUgPz8gMCkgPiAwKTsKICBpZiAoc2hvdWxkRmluYWxpemUpIHsKICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSByb290U2NvcGU7CiAgICBpZiAocGF0Y2hQbHVnaW5fKSB7CiAgICAgIGNvbnN0IGJhc2VQYXRoID0gcGF0Y2hQbHVnaW5fLmdldFBhdGgoc3RhdGUpOwogICAgICBpZiAoYmFzZVBhdGgpIHsKICAgICAgICBwYXRjaFBsdWdpbl8uZ2VuZXJhdGVQYXRjaGVzXyhzdGF0ZSwgYmFzZVBhdGgsIHJvb3RTY29wZSk7CiAgICAgIH0KICAgIH0KICAgIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSk7CiAgfQp9CmZ1bmN0aW9uIGhhbmRsZUNyb3NzUmVmZXJlbmNlKHRhcmdldCwga2V5LCB2YWx1ZSkgewogIGNvbnN0IHsgc2NvcGVfIH0gPSB0YXJnZXQ7CiAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFXTsKICAgIGlmIChpc1NhbWVTY29wZShzdGF0ZSwgc2NvcGVfKSkgewogICAgICBzdGF0ZS5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gY3Jvc3NSZWZlcmVuY2VDbGVhbnVwKCkgewogICAgICAgIHByZXBhcmVDb3B5KHRhcmdldCk7CiAgICAgICAgY29uc3QgZmluYWxpemVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgICAgICB1cGRhdGVEcmFmdEluUGFyZW50KHRhcmdldCwgdmFsdWUsIGZpbmFsaXplZFZhbHVlLCBrZXkpOwogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgdGFyZ2V0LmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiBuZXN0ZWREcmFmdENsZWFudXAoKSB7CiAgICAgIGNvbnN0IHRhcmdldENvcHkgPSBsYXRlc3QodGFyZ2V0KTsKICAgICAgaWYgKGdldDIodGFyZ2V0Q29weSwga2V5LCB0YXJnZXQudHlwZV8pID09PSB2YWx1ZSkgewogICAgICAgIGlmIChzY29wZV8uZHJhZnRzXy5sZW5ndGggPiAxICYmICh0YXJnZXQuYXNzaWduZWRfLmdldChrZXkpID8/IGZhbHNlKSA9PT0gdHJ1ZSAmJiB0YXJnZXQuY29weV8pIHsKICAgICAgICAgIGhhbmRsZVZhbHVlKAogICAgICAgICAgICBnZXQyKHRhcmdldC5jb3B5Xywga2V5LCB0YXJnZXQudHlwZV8pLAogICAgICAgICAgICBzY29wZV8uaGFuZGxlZFNldF8sCiAgICAgICAgICAgIHNjb3BlXwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KfQpmdW5jdGlvbiBoYW5kbGVWYWx1ZSh0YXJnZXQsIGhhbmRsZWRTZXQsIHJvb3RTY29wZSkgewogIGlmICghcm9vdFNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiByb290U2NvcGUudW5maW5hbGl6ZWREcmFmdHNfIDwgMSkgewogICAgcmV0dXJuIHRhcmdldDsKICB9CiAgaWYgKGlzRHJhZnQodGFyZ2V0KSB8fCBoYW5kbGVkU2V0Lmhhcyh0YXJnZXQpIHx8ICFpc0RyYWZ0YWJsZSh0YXJnZXQpIHx8IGlzRnJvemVuKHRhcmdldCkpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGhhbmRsZWRTZXQuYWRkKHRhcmdldCk7CiAgZWFjaCh0YXJnZXQsIChrZXksIHZhbHVlKSA9PiB7CiAgICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgICAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgICAgIGlmIChpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgICAgIGNvbnN0IHVwZGF0ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgICAgIHNldCh0YXJnZXQsIGtleSwgdXBkYXRlZFZhbHVlLCB0YXJnZXQudHlwZV8pOwogICAgICAgIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNEcmFmdGFibGUodmFsdWUpKSB7CiAgICAgIGhhbmRsZVZhbHVlKHZhbHVlLCBoYW5kbGVkU2V0LCByb290U2NvcGUpOwogICAgfQogIH0pOwogIHJldHVybiB0YXJnZXQ7Cn0KZnVuY3Rpb24gY3JlYXRlUHJveHlQcm94eShiYXNlLCBwYXJlbnQpIHsKICBjb25zdCBiYXNlSXNBcnJheSA9IGlzQXJyYXkoYmFzZSk7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB0eXBlXzogYmFzZUlzQXJyYXkgPyAxIDogMCwKICAgIC8vIFRyYWNrIHdoaWNoIHByb2R1Y2UgY2FsbCB0aGlzIGlzIGFzc29jaWF0ZWQgd2l0aC4KICAgIHNjb3BlXzogcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZSgpLAogICAgLy8gVHJ1ZSBmb3IgYm90aCBzaGFsbG93IGFuZCBkZWVwIGNoYW5nZXMuCiAgICBtb2RpZmllZF86IGZhbHNlLAogICAgLy8gVXNlZCBkdXJpbmcgZmluYWxpemF0aW9uLgogICAgZmluYWxpemVkXzogZmFsc2UsCiAgICAvLyBUcmFjayB3aGljaCBwcm9wZXJ0aWVzIGhhdmUgYmVlbiBhc3NpZ25lZCAodHJ1ZSkgb3IgZGVsZXRlZCAoZmFsc2UpLgogICAgLy8gYWN0dWFsbHkgaW5zdGFudGlhdGVkIGluIGBwcmVwYXJlQ29weSgpYAogICAgYXNzaWduZWRfOiB2b2lkIDAsCiAgICAvLyBUaGUgcGFyZW50IGRyYWZ0IHN0YXRlLgogICAgcGFyZW50XzogcGFyZW50LAogICAgLy8gVGhlIGJhc2Ugc3RhdGUuCiAgICBiYXNlXzogYmFzZSwKICAgIC8vIFRoZSBiYXNlIHByb3h5LgogICAgZHJhZnRfOiBudWxsLAogICAgLy8gc2V0IGJlbG93CiAgICAvLyBUaGUgYmFzZSBjb3B5IHdpdGggYW55IHVwZGF0ZWQgdmFsdWVzLgogICAgY29weV86IG51bGwsCiAgICAvLyBDYWxsZWQgYnkgdGhlIGBwcm9kdWNlYCBmdW5jdGlvbi4KICAgIHJldm9rZV86IG51bGwsCiAgICBpc01hbnVhbF86IGZhbHNlLAogICAgLy8gYGNhbGxiYWNrc2AgYWN0dWFsbHkgZ2V0cyBhc3NpZ25lZCBpbiBgY3JlYXRlUHJveHlgCiAgICBjYWxsYmFja3NfOiB2b2lkIDAKICB9OwogIGxldCB0YXJnZXQgPSBzdGF0ZTsKICBsZXQgdHJhcHMgPSBvYmplY3RUcmFwczsKICBpZiAoYmFzZUlzQXJyYXkpIHsKICAgIHRhcmdldCA9IFtzdGF0ZV07CiAgICB0cmFwcyA9IGFycmF5VHJhcHM7CiAgfQogIGNvbnN0IHsgcmV2b2tlLCBwcm94eSB9ID0gUHJveHkucmV2b2NhYmxlKHRhcmdldCwgdHJhcHMpOwogIHN0YXRlLmRyYWZ0XyA9IHByb3h5OwogIHN0YXRlLnJldm9rZV8gPSByZXZva2U7CiAgcmV0dXJuIFtwcm94eSwgc3RhdGVdOwp9CnZhciBvYmplY3RUcmFwcyA9IHsKICBnZXQoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwcm9wID09PSBEUkFGVF9TVEFURSkKICAgICAgcmV0dXJuIHN0YXRlOwogICAgY29uc3Qgc291cmNlID0gbGF0ZXN0KHN0YXRlKTsKICAgIGlmICghaGFzKHNvdXJjZSwgcHJvcCwgc3RhdGUudHlwZV8pKSB7CiAgICAgIHJldHVybiByZWFkUHJvcEZyb21Qcm90byhzdGF0ZSwgc291cmNlLCBwcm9wKTsKICAgIH0KICAgIGNvbnN0IHZhbHVlID0gc291cmNlW3Byb3BdOwogICAgaWYgKHN0YXRlLmZpbmFsaXplZF8gfHwgIWlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAodmFsdWUgPT09IHBlZWsoc3RhdGUuYmFzZV8sIHByb3ApKSB7CiAgICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgICAgY29uc3QgY2hpbGRLZXkgPSBzdGF0ZS50eXBlXyA9PT0gMSA/ICtwcm9wIDogcHJvcDsKICAgICAgY29uc3QgY2hpbGREcmFmdCA9IGNyZWF0ZVByb3h5KHN0YXRlLnNjb3BlXywgdmFsdWUsIHN0YXRlLCBjaGlsZEtleSk7CiAgICAgIHJldHVybiBzdGF0ZS5jb3B5X1tjaGlsZEtleV0gPSBjaGlsZERyYWZ0OwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0sCiAgaGFzKHN0YXRlLCBwcm9wKSB7CiAgICByZXR1cm4gcHJvcCBpbiBsYXRlc3Qoc3RhdGUpOwogIH0sCiAgb3duS2V5cyhzdGF0ZSkgewogICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyhsYXRlc3Qoc3RhdGUpKTsKICB9LAogIHNldChzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICAgIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvKGxhdGVzdChzdGF0ZSksIHByb3ApOwogICAgaWYgKGRlc2M/LnNldCkgewogICAgICBkZXNjLnNldC5jYWxsKHN0YXRlLmRyYWZ0XywgdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICAgIGNvbnN0IGN1cnJlbnQyMiA9IHBlZWsobGF0ZXN0KHN0YXRlKSwgcHJvcCk7CiAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnQyMj8uW0RSQUZUX1NUQVRFXTsKICAgICAgaWYgKGN1cnJlbnRTdGF0ZSAmJiBjdXJyZW50U3RhdGUuYmFzZV8gPT09IHZhbHVlKSB7CiAgICAgICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgICAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIGZhbHNlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXModmFsdWUsIGN1cnJlbnQyMikgJiYgKHZhbHVlICE9PSB2b2lkIDAgfHwgaGFzKHN0YXRlLmJhc2VfLCBwcm9wLCBzdGF0ZS50eXBlXykpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5X1twcm9wXSA9PT0gdmFsdWUgJiYgLy8gc3BlY2lhbCBjYXNlOiBoYW5kbGUgbmV3IHByb3BzIHdpdGggdmFsdWUgJ3VuZGVmaW5lZCcKICAgICh2YWx1ZSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuY29weV8pIHx8IC8vIHNwZWNpYWwgY2FzZTogTmFOCiAgICBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihzdGF0ZS5jb3B5X1twcm9wXSkpCiAgICAgIHJldHVybiB0cnVlOwogICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgIHN0YXRlLmFzc2lnbmVkXy5zZXQocHJvcCwgdHJ1ZSk7CiAgICBoYW5kbGVDcm9zc1JlZmVyZW5jZShzdGF0ZSwgcHJvcCwgdmFsdWUpOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBkZWxldGVQcm9wZXJ0eShzdGF0ZSwgcHJvcCkgewogICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgaWYgKHBlZWsoc3RhdGUuYmFzZV8sIHByb3ApICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5iYXNlXykgewogICAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIGZhbHNlKTsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuYXNzaWduZWRfLmRlbGV0ZShwcm9wKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5XykgewogICAgICBkZWxldGUgc3RhdGUuY29weV9bcHJvcF07CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIC8vIE5vdGU6IFdlIG5ldmVyIGNvZXJjZSBgZGVzYy52YWx1ZWAgaW50byBhbiBJbW1lciBkcmFmdCwgYmVjYXVzZSB3ZSBjYW4ndCBtYWtlCiAgLy8gdGhlIHNhbWUgZ3VhcmFudGVlIGluIEVTNSBtb2RlLgogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihzdGF0ZSwgcHJvcCkgewogICAgY29uc3Qgb3duZXIgPSBsYXRlc3Qoc3RhdGUpOwogICAgY29uc3QgZGVzYyA9IFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG93bmVyLCBwcm9wKTsKICAgIGlmICghZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICByZXR1cm4gewogICAgICBbV1JJVEFCTEVdOiB0cnVlLAogICAgICBbQ09ORklHVVJBQkxFXTogc3RhdGUudHlwZV8gIT09IDEgfHwgcHJvcCAhPT0gImxlbmd0aCIsCiAgICAgIFtFTlVNRVJBQkxFXTogZGVzY1tFTlVNRVJBQkxFXSwKICAgICAgW1ZBTFVFXTogb3duZXJbcHJvcF0KICAgIH07CiAgfSwKICBkZWZpbmVQcm9wZXJ0eSgpIHsKICAgIGRpZSgxMSk7CiAgfSwKICBnZXRQcm90b3R5cGVPZihzdGF0ZSkgewogICAgcmV0dXJuIGdldFByb3RvdHlwZU9mKHN0YXRlLmJhc2VfKTsKICB9LAogIHNldFByb3RvdHlwZU9mKCkgewogICAgZGllKDEyKTsKICB9Cn07CnZhciBhcnJheVRyYXBzID0ge307CmVhY2gob2JqZWN0VHJhcHMsIChrZXksIGZuKSA9PiB7CiAgYXJyYXlUcmFwc1trZXldID0gZnVuY3Rpb24oKSB7CiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzOwogICAgYXJnc1swXSA9IGFyZ3NbMF1bMF07CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJncyk7CiAgfTsKfSk7CmFycmF5VHJhcHMuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCkgewogIGlmIChpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUoMTMpOwogIHJldHVybiBhcnJheVRyYXBzLnNldC5jYWxsKHRoaXMsIHN0YXRlLCBwcm9wLCB2b2lkIDApOwp9OwphcnJheVRyYXBzLnNldCA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogIGlmIChwcm9wICE9PSAibGVuZ3RoIiAmJiBpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUoMTQpOwogIHJldHVybiBvYmplY3RUcmFwcy5zZXQuY2FsbCh0aGlzLCBzdGF0ZVswXSwgcHJvcCwgdmFsdWUsIHN0YXRlWzBdKTsKfTsKZnVuY3Rpb24gcGVlayhkcmFmdCwgcHJvcCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEVdOwogIGNvbnN0IHNvdXJjZSA9IHN0YXRlID8gbGF0ZXN0KHN0YXRlKSA6IGRyYWZ0OwogIHJldHVybiBzb3VyY2VbcHJvcF07Cn0KZnVuY3Rpb24gcmVhZFByb3BGcm9tUHJvdG8oc3RhdGUsIHNvdXJjZSwgcHJvcCkgewogIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvKHNvdXJjZSwgcHJvcCk7CiAgcmV0dXJuIGRlc2MgPyBWQUxVRSBpbiBkZXNjID8gZGVzY1tWQUxVRV0gOiAoCiAgICAvLyBUaGlzIGlzIGEgdmVyeSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBwcm9wIGlzIGEgZ2V0dGVyIGRlZmluZWQgYnkgdGhlCiAgICAvLyBwcm90b3R5cGUsIHdlIHNob3VsZCBpbnZva2UgaXQgd2l0aCB0aGUgZHJhZnQgYXMgY29udGV4dCEKICAgIGRlc2MuZ2V0Py5jYWxsKHN0YXRlLmRyYWZ0XykKICApIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGdldERlc2NyaXB0b3JGcm9tUHJvdG8oc291cmNlLCBwcm9wKSB7CiAgaWYgKCEocHJvcCBpbiBzb3VyY2UpKQogICAgcmV0dXJuIHZvaWQgMDsKICBsZXQgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2Yoc291cmNlKTsKICB3aGlsZSAocHJvdG8yKSB7CiAgICBjb25zdCBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bzIsIHByb3ApOwogICAgaWYgKGRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YocHJvdG8yKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYXJrQ2hhbmdlZChzdGF0ZSkgewogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBzdGF0ZS5tb2RpZmllZF8gPSB0cnVlOwogICAgaWYgKHN0YXRlLnBhcmVudF8pIHsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUucGFyZW50Xyk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHByZXBhcmVDb3B5KHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5jb3B5XykgewogICAgc3RhdGUuYXNzaWduZWRfID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHN0YXRlLmNvcHlfID0gc2hhbGxvd0NvcHkoCiAgICAgIHN0YXRlLmJhc2VfLAogICAgICBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5XwogICAgKTsKICB9Cn0KdmFyIEltbWVyMiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb25maWcpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB0cnVlOwogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSBmYWxzZTsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IGZhbHNlOwogICAgdGhpcy5wcm9kdWNlID0gKGJhc2UsIHJlY2lwZSwgcGF0Y2hMaXN0ZW5lcikgPT4gewogICAgICBpZiAoaXNGdW5jdGlvbihiYXNlKSAmJiAhaXNGdW5jdGlvbihyZWNpcGUpKSB7CiAgICAgICAgY29uc3QgZGVmYXVsdEJhc2UgPSByZWNpcGU7CiAgICAgICAgcmVjaXBlID0gYmFzZTsKICAgICAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGN1cnJpZWRQcm9kdWNlKGJhc2UyID0gZGVmYXVsdEJhc2UsIC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBzZWxmMi5wcm9kdWNlKGJhc2UyLCAoZHJhZnQpID0+IHJlY2lwZS5jYWxsKHRoaXMsIGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIWlzRnVuY3Rpb24ocmVjaXBlKSkKICAgICAgICBkaWUoNik7CiAgICAgIGlmIChwYXRjaExpc3RlbmVyICE9PSB2b2lkIDAgJiYgIWlzRnVuY3Rpb24ocGF0Y2hMaXN0ZW5lcikpCiAgICAgICAgZGllKDcpOwogICAgICBsZXQgcmVzdWx0OwogICAgICBpZiAoaXNEcmFmdGFibGUoYmFzZSkpIHsKICAgICAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUodGhpcyk7CiAgICAgICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eShzY29wZSwgYmFzZSwgdm9pZCAwKTsKICAgICAgICBsZXQgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSByZWNpcGUocHJveHkpOwogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKQogICAgICAgICAgICByZXZva2VTY29wZShzY29wZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGxlYXZlU2NvcGUoc2NvcGUpOwogICAgICAgIH0KICAgICAgICB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICAgICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQocmVzdWx0LCBzY29wZSk7CiAgICAgIH0gZWxzZSBpZiAoIWJhc2UgfHwgIWlzT2JqZWN0aXNoKGJhc2UpKSB7CiAgICAgICAgcmVzdWx0ID0gcmVjaXBlKGJhc2UpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkKICAgICAgICAgIHJlc3VsdCA9IGJhc2U7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gTk9USElORykKICAgICAgICAgIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICBpZiAodGhpcy5hdXRvRnJlZXplXykKICAgICAgICAgIGZyZWV6ZShyZXN1bHQsIHRydWUpOwogICAgICAgIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBjb25zdCBpcCA9IFtdOwogICAgICAgICAgZ2V0UGx1Z2luKFBsdWdpblBhdGNoZXMpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXyhiYXNlLCByZXN1bHQsIHsKICAgICAgICAgICAgcGF0Y2hlc186IHAsCiAgICAgICAgICAgIGludmVyc2VQYXRjaGVzXzogaXAKICAgICAgICAgIH0pOwogICAgICAgICAgcGF0Y2hMaXN0ZW5lcihwLCBpcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZQogICAgICAgIGRpZSgxLCBiYXNlKTsKICAgIH07CiAgICB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyA9IChiYXNlLCByZWNpcGUpID0+IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oYmFzZSkpIHsKICAgICAgICByZXR1cm4gKHN0YXRlLCAuLi5hcmdzKSA9PiB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyhzdGF0ZSwgKGRyYWZ0KSA9PiBiYXNlKGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgIH0KICAgICAgbGV0IHBhdGNoZXMsIGludmVyc2VQYXRjaGVzOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnByb2R1Y2UoYmFzZSwgcmVjaXBlLCAocCwgaXApID0+IHsKICAgICAgICBwYXRjaGVzID0gcDsKICAgICAgICBpbnZlcnNlUGF0Y2hlcyA9IGlwOwogICAgICB9KTsKICAgICAgcmV0dXJuIFtyZXN1bHQsIHBhdGNoZXMsIGludmVyc2VQYXRjaGVzXTsKICAgIH07CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8uYXV0b0ZyZWV6ZSkpCiAgICAgIHRoaXMuc2V0QXV0b0ZyZWV6ZShjb25maWcuYXV0b0ZyZWV6ZSk7CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8udXNlU3RyaWN0U2hhbGxvd0NvcHkpKQogICAgICB0aGlzLnNldFVzZVN0cmljdFNoYWxsb3dDb3B5KGNvbmZpZy51c2VTdHJpY3RTaGFsbG93Q29weSk7CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8udXNlU3RyaWN0SXRlcmF0aW9uKSkKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RJdGVyYXRpb24oY29uZmlnLnVzZVN0cmljdEl0ZXJhdGlvbik7CiAgfQogIGNyZWF0ZURyYWZ0KGJhc2UpIHsKICAgIGlmICghaXNEcmFmdGFibGUoYmFzZSkpCiAgICAgIGRpZSg4KTsKICAgIGlmIChpc0RyYWZ0KGJhc2UpKQogICAgICBiYXNlID0gY3VycmVudChiYXNlKTsKICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZSh0aGlzKTsKICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkoc2NvcGUsIGJhc2UsIHZvaWQgMCk7CiAgICBwcm94eVtEUkFGVF9TVEFURV0uaXNNYW51YWxfID0gdHJ1ZTsKICAgIGxlYXZlU2NvcGUoc2NvcGUpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmaW5pc2hEcmFmdChkcmFmdCwgcGF0Y2hMaXN0ZW5lcikgewogICAgY29uc3Qgc3RhdGUgPSBkcmFmdCAmJiBkcmFmdFtEUkFGVF9TVEFURV07CiAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5pc01hbnVhbF8pCiAgICAgIGRpZSg5KTsKICAgIGNvbnN0IHsgc2NvcGVfOiBzY29wZSB9ID0gc3RhdGU7CiAgICB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdCh2b2lkIDAsIHNjb3BlKTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGF1dG9tYXRpY2FsbHkgZnJlZXplIGFsbCBjb3BpZXMgY3JlYXRlZCBieSBJbW1lci4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGF1dG8tZnJlZXppbmcgaXMgZW5hYmxlZC4KICAgKi8KICBzZXRBdXRvRnJlZXplKHZhbHVlKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBlbmFibGUgc3RyaWN0IHNoYWxsb3cgY29weS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGltbWVyIGRvZXMgbm90IGNvcHkgdGhlIG9iamVjdCBkZXNjcmlwdG9ycyBzdWNoIGFzIGdldHRlciwgc2V0dGVyIGFuZCBub24tZW51bXJhYmxlIHByb3BlcnRpZXMuCiAgICovCiAgc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkodmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgZmFsc2UgdG8gdXNlIGZhc3RlciBpdGVyYXRpb24gdGhhdCBza2lwcyBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzCiAgICogYnV0IHN0aWxsIGhhbmRsZXMgc3ltYm9scyBmb3IgY29tcGF0aWJpbGl0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHN0cmljdCBpdGVyYXRpb24gaXMgZW5hYmxlZCAoaW5jbHVkZXMgYWxsIG93biBwcm9wZXJ0aWVzKS4KICAgKi8KICBzZXRVc2VTdHJpY3RJdGVyYXRpb24odmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHZhbHVlOwogIH0KICBzaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fOwogIH0KICBhcHBseVBhdGNoZXMoYmFzZSwgcGF0Y2hlcykgewogICAgbGV0IGk7CiAgICBmb3IgKGkgPSBwYXRjaGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHBhdGNoID0gcGF0Y2hlc1tpXTsKICAgICAgaWYgKHBhdGNoLnBhdGgubGVuZ3RoID09PSAwICYmIHBhdGNoLm9wID09PSAicmVwbGFjZSIpIHsKICAgICAgICBiYXNlID0gcGF0Y2gudmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChpID4gLTEpIHsKICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuc2xpY2UoaSArIDEpOwogICAgfQogICAgY29uc3QgYXBwbHlQYXRjaGVzSW1wbCA9IGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKS5hcHBseVBhdGNoZXNfOwogICAgaWYgKGlzRHJhZnQoYmFzZSkpIHsKICAgICAgcmV0dXJuIGFwcGx5UGF0Y2hlc0ltcGwoYmFzZSwgcGF0Y2hlcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9kdWNlKAogICAgICBiYXNlLAogICAgICAoZHJhZnQpID0+IGFwcGx5UGF0Y2hlc0ltcGwoZHJhZnQsIHBhdGNoZXMpCiAgICApOwogIH0KfTsKZnVuY3Rpb24gY3JlYXRlUHJveHkocm9vdFNjb3BlLCB2YWx1ZSwgcGFyZW50LCBrZXkpIHsKICBjb25zdCBbZHJhZnQsIHN0YXRlXSA9IGlzTWFwKHZhbHVlKSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpLnByb3h5TWFwXyh2YWx1ZSwgcGFyZW50KSA6IGlzU2V0KHZhbHVlKSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpLnByb3h5U2V0Xyh2YWx1ZSwgcGFyZW50KSA6IGNyZWF0ZVByb3h5UHJveHkodmFsdWUsIHBhcmVudCk7CiAgY29uc3Qgc2NvcGUgPSBwYXJlbnQ/LnNjb3BlXyA/PyBnZXRDdXJyZW50U2NvcGUoKTsKICBzY29wZS5kcmFmdHNfLnB1c2goZHJhZnQpOwogIHN0YXRlLmNhbGxiYWNrc18gPSBwYXJlbnQ/LmNhbGxiYWNrc18gPz8gW107CiAgc3RhdGUua2V5XyA9IGtleTsKICBpZiAocGFyZW50ICYmIGtleSAhPT0gdm9pZCAwKSB7CiAgICByZWdpc3RlckNoaWxkRmluYWxpemF0aW9uQ2FsbGJhY2socGFyZW50LCBzdGF0ZSwga2V5KTsKICB9IGVsc2UgewogICAgc3RhdGUuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIHJvb3REcmFmdENsZWFudXAocm9vdFNjb3BlMikgewogICAgICByb290U2NvcGUyLm1hcFNldFBsdWdpbl8/LmZpeFNldENvbnRlbnRzKHN0YXRlKTsKICAgICAgY29uc3QgeyBwYXRjaFBsdWdpbl8gfSA9IHJvb3RTY29wZTI7CiAgICAgIGlmIChzdGF0ZS5tb2RpZmllZF8gJiYgcGF0Y2hQbHVnaW5fKSB7CiAgICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUGF0Y2hlc18oc3RhdGUsIFtdLCByb290U2NvcGUyKTsKICAgICAgfQogICAgfSk7CiAgfQogIHJldHVybiBkcmFmdDsKfQpmdW5jdGlvbiBjdXJyZW50KHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0KHZhbHVlKSkKICAgIGRpZSgxMCwgdmFsdWUpOwogIHJldHVybiBjdXJyZW50SW1wbCh2YWx1ZSk7Cn0KZnVuY3Rpb24gY3VycmVudEltcGwodmFsdWUpIHsKICBpZiAoIWlzRHJhZnRhYmxlKHZhbHVlKSB8fCBpc0Zyb3plbih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgbGV0IGNvcHkzOwogIGxldCBzdHJpY3QgPSB0cnVlOwogIGlmIChzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pCiAgICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgY29weTMgPSBzaGFsbG93Q29weSh2YWx1ZSwgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8pOwogICAgc3RyaWN0ID0gc3RhdGUuc2NvcGVfLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICB9IGVsc2UgewogICAgY29weTMgPSBzaGFsbG93Q29weSh2YWx1ZSwgdHJ1ZSk7CiAgfQogIGVhY2goCiAgICBjb3B5MywKICAgIChrZXksIGNoaWxkVmFsdWUpID0+IHsKICAgICAgc2V0KGNvcHkzLCBrZXksIGN1cnJlbnRJbXBsKGNoaWxkVmFsdWUpKTsKICAgIH0sCiAgICBzdHJpY3QKICApOwogIGlmIChzdGF0ZSkgewogICAgc3RhdGUuZmluYWxpemVkXyA9IGZhbHNlOwogIH0KICByZXR1cm4gY29weTM7Cn0KdmFyIGltbWVyID0gbmV3IEltbWVyMigpOwp2YXIgcHJvZHVjZSA9IGltbWVyLnByb2R1Y2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVkdXgtdGh1bmtAMy4xLjBfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlZHV4LXRodW5rL2Rpc3QvcmVkdXgtdGh1bmsubWpzCmZ1bmN0aW9uIGNyZWF0ZVRodW5rTWlkZGxld2FyZShleHRyYUFyZ3VtZW50KSB7CiAgY29uc3QgbWlkZGxld2FyZSA9ICh7IGRpc3BhdGNoLCBnZXRTdGF0ZSB9KSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIGFjdGlvbihkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhQXJndW1lbnQpOwogICAgfQogICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICB9OwogIHJldHVybiBtaWRkbGV3YXJlOwp9CnZhciB0aHVuayA9IGNyZWF0ZVRodW5rTWlkZGxld2FyZSgpOwp2YXIgd2l0aEV4dHJhQXJndW1lbnQgPSBjcmVhdGVUaHVua01pZGRsZXdhcmU7CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHJlZHV4anMrdG9vbGtpdEAyLjExLjBfcmVhY3QtcmVkdXhAOS4yLjBfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xX19yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL0ByZWR1eGpzL3Rvb2xraXQvZGlzdC9yZWR1eC10b29sa2l0Lm1vZGVybi5tanMKdmFyIGNvbXBvc2VXaXRoRGV2VG9vbHMgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fQ09NUE9TRV9fID8gd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX0NPTVBPU0VfXyA6IGZ1bmN0aW9uKCkgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdm9pZCAwOwogIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAib2JqZWN0IikgcmV0dXJuIGNvbXBvc2U7CiAgcmV0dXJuIGNvbXBvc2UuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfTsKdmFyIGRldlRvb2xzRW5oYW5jZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fXyA/IHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9fIDogZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKG5vb3AzMikgewogICAgcmV0dXJuIG5vb3AzMjsKICB9Owp9Owp2YXIgaGFzTWF0Y2hGdW5jdGlvbiA9ICh2KSA9PiB7CiAgcmV0dXJuIHYgJiYgdHlwZW9mIHYubWF0Y2ggPT09ICJmdW5jdGlvbiI7Cn07CmZ1bmN0aW9uIGNyZWF0ZUFjdGlvbih0eXBlLCBwcmVwYXJlQWN0aW9uKSB7CiAgZnVuY3Rpb24gYWN0aW9uQ3JlYXRvciguLi5hcmdzKSB7CiAgICBpZiAocHJlcGFyZUFjdGlvbikgewogICAgICBsZXQgcHJlcGFyZWQgPSBwcmVwYXJlQWN0aW9uKC4uLmFyZ3MpOwogICAgICBpZiAoIXByZXBhcmVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgwKSA6ICJwcmVwYXJlQWN0aW9uIGRpZCBub3QgcmV0dXJuIGFuIG9iamVjdCIpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZSwKICAgICAgICBwYXlsb2FkOiBwcmVwYXJlZC5wYXlsb2FkLAogICAgICAgIC4uLiJtZXRhIiBpbiBwcmVwYXJlZCAmJiB7CiAgICAgICAgICBtZXRhOiBwcmVwYXJlZC5tZXRhCiAgICAgICAgfSwKICAgICAgICAuLi4iZXJyb3IiIGluIHByZXBhcmVkICYmIHsKICAgICAgICAgIGVycm9yOiBwcmVwYXJlZC5lcnJvcgogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHR5cGUsCiAgICAgIHBheWxvYWQ6IGFyZ3NbMF0KICAgIH07CiAgfQogIGFjdGlvbkNyZWF0b3IudG9TdHJpbmcgPSAoKSA9PiBgJHt0eXBlfWA7CiAgYWN0aW9uQ3JlYXRvci50eXBlID0gdHlwZTsKICBhY3Rpb25DcmVhdG9yLm1hdGNoID0gKGFjdGlvbikgPT4gaXNBY3Rpb24oYWN0aW9uKSAmJiBhY3Rpb24udHlwZSA9PT0gdHlwZTsKICByZXR1cm4gYWN0aW9uQ3JlYXRvcjsKfQpmdW5jdGlvbiBpc0FjdGlvbkNyZWF0b3IoYWN0aW9uKSB7CiAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgJiYgInR5cGUiIGluIGFjdGlvbiAmJiAvLyBoYXNNYXRjaEZ1bmN0aW9uIG9ubHkgd2FudHMgTWF0Y2hlcnMgYnV0IEkgZG9uJ3Qgc2VlIHRoZSBwb2ludCBpbiByZXdyaXRpbmcgaXQKICBoYXNNYXRjaEZ1bmN0aW9uKGFjdGlvbik7Cn0KZnVuY3Rpb24gZ2V0TWVzc2FnZSh0eXBlKSB7CiAgY29uc3Qgc3BsaXRUeXBlID0gdHlwZSA/IGAke3R5cGV9YC5zcGxpdCgiLyIpIDogW107CiAgY29uc3QgYWN0aW9uTmFtZSA9IHNwbGl0VHlwZVtzcGxpdFR5cGUubGVuZ3RoIC0gMV0gfHwgImFjdGlvbkNyZWF0b3IiOwogIHJldHVybiBgRGV0ZWN0ZWQgYW4gYWN0aW9uIGNyZWF0b3Igd2l0aCB0eXBlICIke3R5cGUgfHwgInVua25vd24ifSIgYmVpbmcgZGlzcGF0Y2hlZC4gCk1ha2Ugc3VyZSB5b3UncmUgY2FsbGluZyB0aGUgYWN0aW9uIGNyZWF0b3IgYmVmb3JlIGRpc3BhdGNoaW5nLCBpLmUuIFxgZGlzcGF0Y2goJHthY3Rpb25OYW1lfSgpKVxgIGluc3RlYWQgb2YgXGBkaXNwYXRjaCgke2FjdGlvbk5hbWV9KVxgLiBUaGlzIGlzIG5lY2Vzc2FyeSBldmVuIGlmIHRoZSBhY3Rpb24gaGFzIG5vIHBheWxvYWQuYDsKfQpmdW5jdGlvbiBjcmVhdGVBY3Rpb25DcmVhdG9ySW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0KICBjb25zdCB7CiAgICBpc0FjdGlvbkNyZWF0b3I6IGlzQWN0aW9uQ3JlYXRvcjIgPSBpc0FjdGlvbkNyZWF0b3IKICB9ID0gb3B0aW9uczsKICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmIChpc0FjdGlvbkNyZWF0b3IyKGFjdGlvbikpIHsKICAgICAgY29uc29sZS53YXJuKGdldE1lc3NhZ2UoYWN0aW9uLnR5cGUpKTsKICAgIH0KICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgfTsKfQpmdW5jdGlvbiBnZXRUaW1lTWVhc3VyZVV0aWxzKG1heERlbGF5LCBmbk5hbWUpIHsKICBsZXQgZWxhcHNlZCA9IDA7CiAgcmV0dXJuIHsKICAgIG1lYXN1cmVUaW1lKGZuKSB7CiAgICAgIGNvbnN0IHN0YXJ0ZWQgPSBEYXRlLm5vdygpOwogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbigpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGNvbnN0IGZpbmlzaGVkID0gRGF0ZS5ub3coKTsKICAgICAgICBlbGFwc2VkICs9IGZpbmlzaGVkIC0gc3RhcnRlZDsKICAgICAgfQogICAgfSwKICAgIHdhcm5JZkV4Y2VlZGVkKCkgewogICAgICBpZiAoZWxhcHNlZCA+IG1heERlbGF5KSB7CiAgICAgICAgY29uc29sZS53YXJuKGAke2ZuTmFtZX0gdG9vayAke2VsYXBzZWR9bXMsIHdoaWNoIGlzIG1vcmUgdGhhbiB0aGUgd2FybmluZyB0aHJlc2hvbGQgb2YgJHttYXhEZWxheX1tcy4gCklmIHlvdXIgc3RhdGUgb3IgYWN0aW9ucyBhcmUgdmVyeSBsYXJnZSwgeW91IG1heSB3YW50IHRvIGRpc2FibGUgdGhlIG1pZGRsZXdhcmUgYXMgaXQgbWlnaHQgY2F1c2UgdG9vIG11Y2ggb2YgYSBzbG93ZG93biBpbiBkZXZlbG9wbWVudCBtb2RlLiBTZWUgaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvZ2V0RGVmYXVsdE1pZGRsZXdhcmUgZm9yIGluc3RydWN0aW9ucy4KSXQgaXMgZGlzYWJsZWQgaW4gcHJvZHVjdGlvbiBidWlsZHMsIHNvIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHRoYXQuYCk7CiAgICAgIH0KICAgIH0KICB9Owp9CnZhciBUdXBsZSA9IGNsYXNzIF9UdXBsZSBleHRlbmRzIEFycmF5IHsKICBjb25zdHJ1Y3RvciguLi5pdGVtcykgewogICAgc3VwZXIoLi4uaXRlbXMpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIF9UdXBsZS5wcm90b3R5cGUpOwogIH0KICBzdGF0aWMgZ2V0IFtTeW1ib2wuc3BlY2llc10oKSB7CiAgICByZXR1cm4gX1R1cGxlOwogIH0KICBjb25jYXQoLi4uYXJyKSB7CiAgICByZXR1cm4gc3VwZXIuY29uY2F0LmFwcGx5KHRoaXMsIGFycik7CiAgfQogIHByZXBlbmQoLi4uYXJyKSB7CiAgICBpZiAoYXJyLmxlbmd0aCA9PT0gMSAmJiBBcnJheS5pc0FycmF5KGFyclswXSkpIHsKICAgICAgcmV0dXJuIG5ldyBfVHVwbGUoLi4uYXJyWzBdLmNvbmNhdCh0aGlzKSk7CiAgICB9CiAgICByZXR1cm4gbmV3IF9UdXBsZSguLi5hcnIuY29uY2F0KHRoaXMpKTsKICB9Cn07CmZ1bmN0aW9uIGZyZWV6ZURyYWZ0YWJsZSh2YWwpIHsKICByZXR1cm4gaXNEcmFmdGFibGUodmFsKSA/IHByb2R1Y2UodmFsLCAoKSA9PiB7CiAgfSkgOiB2YWw7Cn0KZnVuY3Rpb24gZ2V0T3JJbnNlcnRDb21wdXRlZChtYXAzLCBrZXksIGNvbXB1dGUpIHsKICBpZiAobWFwMy5oYXMoa2V5KSkgcmV0dXJuIG1hcDMuZ2V0KGtleSk7CiAgcmV0dXJuIG1hcDMuc2V0KGtleSwgY29tcHV0ZShrZXkpKS5nZXQoa2V5KTsKfQpmdW5jdGlvbiBpc0ltbXV0YWJsZURlZmF1bHQodmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiB8fCB2YWx1ZSA9PSBudWxsIHx8IE9iamVjdC5pc0Zyb3plbih2YWx1ZSk7Cn0KZnVuY3Rpb24gdHJhY2tGb3JNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqKSB7CiAgY29uc3QgdHJhY2tlZFByb3BlcnRpZXMgPSB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqKTsKICByZXR1cm4gewogICAgZGV0ZWN0TXV0YXRpb25zKCkgewogICAgICByZXR1cm4gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIHRyYWNrZWRQcm9wZXJ0aWVzLCBvYmopOwogICAgfQogIH07Cn0KZnVuY3Rpb24gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMgPSBbXSwgb2JqLCBwYXRoMiA9ICIiLCBjaGVja2VkT2JqZWN0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpIHsKICBjb25zdCB0cmFja2VkID0gewogICAgdmFsdWU6IG9iagogIH07CiAgaWYgKCFpc0ltbXV0YWJsZShvYmopICYmICFjaGVja2VkT2JqZWN0cy5oYXMob2JqKSkgewogICAgY2hlY2tlZE9iamVjdHMuYWRkKG9iaik7CiAgICB0cmFja2VkLmNoaWxkcmVuID0ge307CiAgICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICAgIGZvciAoY29uc3Qga2V5IGluIG9iaikgewogICAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICAgIH0pOwogICAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdHJhY2tlZC5jaGlsZHJlbltrZXldID0gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9ialtrZXldLCBuZXN0ZWRQYXRoKTsKICAgIH0KICB9CiAgcmV0dXJuIHRyYWNrZWQ7Cn0KZnVuY3Rpb24gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMgPSBbXSwgdHJhY2tlZFByb3BlcnR5LCBvYmosIHNhbWVQYXJlbnRSZWYgPSBmYWxzZSwgcGF0aDIgPSAiIikgewogIGNvbnN0IHByZXZPYmogPSB0cmFja2VkUHJvcGVydHkgPyB0cmFja2VkUHJvcGVydHkudmFsdWUgOiB2b2lkIDA7CiAgY29uc3Qgc2FtZVJlZiA9IHByZXZPYmogPT09IG9iajsKICBpZiAoc2FtZVBhcmVudFJlZiAmJiAhc2FtZVJlZiAmJiAhTnVtYmVyLmlzTmFOKG9iaikpIHsKICAgIHJldHVybiB7CiAgICAgIHdhc011dGF0ZWQ6IHRydWUsCiAgICAgIHBhdGg6IHBhdGgyCiAgICB9OwogIH0KICBpZiAoaXNJbW11dGFibGUocHJldk9iaikgfHwgaXNJbW11dGFibGUob2JqKSkgewogICAgcmV0dXJuIHsKICAgICAgd2FzTXV0YXRlZDogZmFsc2UKICAgIH07CiAgfQogIGNvbnN0IGtleXNUb0RldGVjdCA9IHt9OwogIGZvciAobGV0IGtleSBpbiB0cmFja2VkUHJvcGVydHkuY2hpbGRyZW4pIHsKICAgIGtleXNUb0RldGVjdFtrZXldID0gdHJ1ZTsKICB9CiAgZm9yIChsZXQga2V5IGluIG9iaikgewogICAga2V5c1RvRGV0ZWN0W2tleV0gPSB0cnVlOwogIH0KICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICBmb3IgKGxldCBrZXkgaW4ga2V5c1RvRGV0ZWN0KSB7CiAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICB9KTsKICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVzdWx0ID0gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIHRyYWNrZWRQcm9wZXJ0eS5jaGlsZHJlbltrZXldLCBvYmpba2V5XSwgc2FtZVJlZiwgbmVzdGVkUGF0aCk7CiAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHdhc011dGF0ZWQ6IGZhbHNlCiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9IGVsc2UgewogICAgbGV0IHN0cmluZ2lmeTIgPSBmdW5jdGlvbihvYmosIHNlcmlhbGl6ZXIsIGluZGVudCwgZGVjeWNsZXIpIHsKICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgZ2V0U2VyaWFsaXplMihzZXJpYWxpemVyLCBkZWN5Y2xlciksIGluZGVudCk7CiAgICB9LCBnZXRTZXJpYWxpemUyID0gZnVuY3Rpb24oc2VyaWFsaXplciwgZGVjeWNsZXIpIHsKICAgICAgbGV0IHN0YWNrID0gW10sIGtleXMgPSBbXTsKICAgICAgaWYgKCFkZWN5Y2xlcikgZGVjeWNsZXIgPSBmdW5jdGlvbihfLCB2YWx1ZSkgewogICAgICAgIGlmIChzdGFja1swXSA9PT0gdmFsdWUpIHJldHVybiAiW0NpcmN1bGFyIH5dIjsKICAgICAgICByZXR1cm4gIltDaXJjdWxhciB+LiIgKyBrZXlzLnNsaWNlKDAsIHN0YWNrLmluZGV4T2YodmFsdWUpKS5qb2luKCIuIikgKyAiXSI7CiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0aGlzUG9zID0gc3RhY2suaW5kZXhPZih0aGlzKTsKICAgICAgICAgIH50aGlzUG9zID8gc3RhY2suc3BsaWNlKHRoaXNQb3MgKyAxKSA6IHN0YWNrLnB1c2godGhpcyk7CiAgICAgICAgICB+dGhpc1BvcyA/IGtleXMuc3BsaWNlKHRoaXNQb3MsIEluZmluaXR5LCBrZXkpIDoga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICBpZiAofnN0YWNrLmluZGV4T2YodmFsdWUpKSB2YWx1ZSA9IGRlY3ljbGVyLmNhbGwodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHN0YWNrLnB1c2godmFsdWUpOwogICAgICAgIHJldHVybiBzZXJpYWxpemVyID09IG51bGwgPyB2YWx1ZSA6IHNlcmlhbGl6ZXIuY2FsbCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgfTsKICAgIH07CiAgICB2YXIgc3RyaW5naWZ5ID0gc3RyaW5naWZ5MiwgZ2V0U2VyaWFsaXplID0gZ2V0U2VyaWFsaXplMjsKICAgIGxldCB7CiAgICAgIGlzSW1tdXRhYmxlID0gaXNJbW11dGFibGVEZWZhdWx0LAogICAgICBpZ25vcmVkUGF0aHMsCiAgICAgIHdhcm5BZnRlciA9IDMyCiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IHRyYWNrID0gdHJhY2tGb3JNdXRhdGlvbnMuYmluZChudWxsLCBpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzKTsKICAgIHJldHVybiAoewogICAgICBnZXRTdGF0ZQogICAgfSkgPT4gewogICAgICBsZXQgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICBsZXQgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgcmV0dXJuIChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICAgICAgY29uc3QgbWVhc3VyZVV0aWxzID0gZ2V0VGltZU1lYXN1cmVVdGlscyh3YXJuQWZ0ZXIsICJJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUiKTsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICAgICAgcmVzdWx0ID0gdHJhY2tlci5kZXRlY3RNdXRhdGlvbnMoKTsKICAgICAgICAgIHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgICAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxOSkgOiBgQSBzdGF0ZSBtdXRhdGlvbiB3YXMgZGV0ZWN0ZWQgYmV0d2VlbiBkaXNwYXRjaGVzLCBpbiB0aGUgcGF0aCAnJHtyZXN1bHQucGF0aCB8fCAiIn0nLiAgVGhpcyBtYXkgY2F1c2UgaW5jb3JyZWN0IGJlaGF2aW9yLiAoaHR0cHM6Ly9yZWR1eC5qcy5vcmcvc3R5bGUtZ3VpZGUvc3R5bGUtZ3VpZGUjZG8tbm90LW11dGF0ZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25zdCBkaXNwYXRjaGVkQWN0aW9uID0gbmV4dChhY3Rpb24pOwogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgICAgICByZXN1bHQgPSB0cmFja2VyLmRldGVjdE11dGF0aW9ucygpOwogICAgICAgICAgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIwKSA6IGBBIHN0YXRlIG11dGF0aW9uIHdhcyBkZXRlY3RlZCBpbnNpZGUgYSBkaXNwYXRjaCwgaW4gdGhlIHBhdGg6ICR7cmVzdWx0LnBhdGggfHwgIiJ9LiBUYWtlIGEgbG9vayBhdCB0aGUgcmVkdWNlcihzKSBoYW5kbGluZyB0aGUgYWN0aW9uICR7c3RyaW5naWZ5MihhY3Rpb24pfS4gKGh0dHBzOi8vcmVkdXguanMub3JnL3N0eWxlLWd1aWRlL3N0eWxlLWd1aWRlI2RvLW5vdC1tdXRhdGUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgbWVhc3VyZVV0aWxzLndhcm5JZkV4Y2VlZGVkKCk7CiAgICAgICAgcmV0dXJuIGRpc3BhdGNoZWRBY3Rpb247CiAgICAgIH07CiAgICB9OwogIH0KfQpmdW5jdGlvbiBpc1BsYWluKHZhbCkgewogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsOwogIHJldHVybiB2YWwgPT0gbnVsbCB8fCB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlID09PSAiYm9vbGVhbiIgfHwgdHlwZSA9PT0gIm51bWJlciIgfHwgQXJyYXkuaXNBcnJheSh2YWwpIHx8IGlzUGxhaW5PYmplY3QodmFsKTsKfQpmdW5jdGlvbiBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUodmFsdWUsIHBhdGgyID0gIiIsIGlzU2VyaWFsaXphYmxlID0gaXNQbGFpbiwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzID0gW10sIGNhY2hlKSB7CiAgbGV0IGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlOwogIGlmICghaXNTZXJpYWxpemFibGUodmFsdWUpKSB7CiAgICByZXR1cm4gewogICAgICBrZXlQYXRoOiBwYXRoMiB8fCAiPHJvb3Q+IiwKICAgICAgdmFsdWUKICAgIH07CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChjYWNoZT8uaGFzKHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IGVudHJpZXMgPSBnZXRFbnRyaWVzICE9IG51bGwgPyBnZXRFbnRyaWVzKHZhbHVlKSA6IE9iamVjdC5lbnRyaWVzKHZhbHVlKTsKICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICBmb3IgKGNvbnN0IFtrZXksIG5lc3RlZFZhbHVlXSBvZiBlbnRyaWVzKSB7CiAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICB9KTsKICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgfQogICAgaWYgKCFpc1NlcmlhbGl6YWJsZShuZXN0ZWRWYWx1ZSkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXlQYXRoOiBuZXN0ZWRQYXRoLAogICAgICAgIHZhbHVlOiBuZXN0ZWRWYWx1ZQogICAgICB9OwogICAgfQogICAgaWYgKHR5cGVvZiBuZXN0ZWRWYWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgZm91bmROZXN0ZWRTZXJpYWxpemFibGUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUobmVzdGVkVmFsdWUsIG5lc3RlZFBhdGgsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMsIGNhY2hlKTsKICAgICAgaWYgKGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlKSB7CiAgICAgICAgcmV0dXJuIGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlOwogICAgICB9CiAgICB9CiAgfQogIGlmIChjYWNoZSAmJiBpc05lc3RlZEZyb3plbih2YWx1ZSkpIGNhY2hlLmFkZCh2YWx1ZSk7CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGlzTmVzdGVkRnJvemVuKHZhbHVlKSB7CiAgaWYgKCFPYmplY3QuaXNGcm96ZW4odmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgZm9yIChjb25zdCBuZXN0ZWRWYWx1ZSBvZiBPYmplY3QudmFsdWVzKHZhbHVlKSkgewogICAgaWYgKHR5cGVvZiBuZXN0ZWRWYWx1ZSAhPT0gIm9iamVjdCIgfHwgbmVzdGVkVmFsdWUgPT09IG51bGwpIGNvbnRpbnVlOwogICAgaWYgKCFpc05lc3RlZEZyb3plbihuZXN0ZWRWYWx1ZSkpIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY3JlYXRlU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHsKICAgICAgaXNTZXJpYWxpemFibGUgPSBpc1BsYWluLAogICAgICBnZXRFbnRyaWVzLAogICAgICBpZ25vcmVkQWN0aW9ucyA9IFtdLAogICAgICBpZ25vcmVkQWN0aW9uUGF0aHMgPSBbIm1ldGEuYXJnIiwgIm1ldGEuYmFzZVF1ZXJ5TWV0YSJdLAogICAgICBpZ25vcmVkUGF0aHMgPSBbXSwKICAgICAgd2FybkFmdGVyID0gMzIsCiAgICAgIGlnbm9yZVN0YXRlID0gZmFsc2UsCiAgICAgIGlnbm9yZUFjdGlvbnMgPSBmYWxzZSwKICAgICAgZGlzYWJsZUNhY2hlID0gZmFsc2UKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgY2FjaGUgPSAhZGlzYWJsZUNhY2hlICYmIFdlYWtTZXQgPyAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSA6IHZvaWQgMDsKICAgIHJldHVybiAoc3RvcmVBUEkpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICAgIGlmICghaXNBY3Rpb24oYWN0aW9uKSkgewogICAgICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gbmV4dChhY3Rpb24pOwogICAgICBjb25zdCBtZWFzdXJlVXRpbHMgPSBnZXRUaW1lTWVhc3VyZVV0aWxzKHdhcm5BZnRlciwgIlNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZSIpOwogICAgICBpZiAoIWlnbm9yZUFjdGlvbnMgJiYgIShpZ25vcmVkQWN0aW9ucy5sZW5ndGggJiYgaWdub3JlZEFjdGlvbnMuaW5kZXhPZihhY3Rpb24udHlwZSkgIT09IC0xKSkgewogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBjb25zdCBmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKGFjdGlvbiwgIiIsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkQWN0aW9uUGF0aHMsIGNhY2hlKTsKICAgICAgICAgIGlmIChmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlKSB7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBrZXlQYXRoLAogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0gPSBmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBIG5vbi1zZXJpYWxpemFibGUgdmFsdWUgd2FzIGRldGVjdGVkIGluIGFuIGFjdGlvbiwgaW4gdGhlIHBhdGg6IFxgJHtrZXlQYXRofVxgLiBWYWx1ZTpgLCB2YWx1ZSwgIlxuVGFrZSBhIGxvb2sgYXQgdGhlIGxvZ2ljIHRoYXQgZGlzcGF0Y2hlZCB0aGlzIGFjdGlvbjogIiwgYWN0aW9uLCAiXG4oU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2ZhcS9hY3Rpb25zI3doeS1zaG91bGQtdHlwZS1iZS1hLXN0cmluZy1vci1hdC1sZWFzdC1zZXJpYWxpemFibGUtd2h5LXNob3VsZC1teS1hY3Rpb24tdHlwZXMtYmUtY29uc3RhbnRzKSIsICJcbihUbyBhbGxvdyBub24tc2VyaWFsaXphYmxlIHZhbHVlcyBzZWU6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvdXNhZ2UvdXNhZ2UtZ3VpZGUjd29ya2luZy13aXRoLW5vbi1zZXJpYWxpemFibGUtZGF0YSkiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWlnbm9yZVN0YXRlKSB7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIGNvbnN0IHN0YXRlID0gc3RvcmVBUEkuZ2V0U3RhdGUoKTsKICAgICAgICAgIGNvbnN0IGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShzdGF0ZSwgIiIsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMsIGNhY2hlKTsKICAgICAgICAgIGlmIChmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWUpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGtleVBhdGgsCiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSA9IGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQSBub24tc2VyaWFsaXphYmxlIHZhbHVlIHdhcyBkZXRlY3RlZCBpbiB0aGUgc3RhdGUsIGluIHRoZSBwYXRoOiBcYCR7a2V5UGF0aH1cYC4gVmFsdWU6YCwgdmFsdWUsIGAKVGFrZSBhIGxvb2sgYXQgdGhlIHJlZHVjZXIocykgaGFuZGxpbmcgdGhpcyBhY3Rpb24gdHlwZTogJHthY3Rpb24udHlwZX0uCihTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvZmFxL29yZ2FuaXppbmctc3RhdGUjY2FuLWktcHV0LWZ1bmN0aW9ucy1wcm9taXNlcy1vci1vdGhlci1ub24tc2VyaWFsaXphYmxlLWl0ZW1zLWluLW15LXN0b3JlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG1lYXN1cmVVdGlscy53YXJuSWZFeGNlZWRlZCgpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KfQpmdW5jdGlvbiBpc0Jvb2xlYW4yKHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gImJvb2xlYW4iOwp9CnZhciBidWlsZEdldERlZmF1bHRNaWRkbGV3YXJlID0gKCkgPT4gZnVuY3Rpb24gZ2V0RGVmYXVsdE1pZGRsZXdhcmUob3B0aW9ucykgewogIGNvbnN0IHsKICAgIHRodW5rOiB0aHVuazIgPSB0cnVlLAogICAgaW1tdXRhYmxlQ2hlY2sgPSB0cnVlLAogICAgc2VyaWFsaXphYmxlQ2hlY2sgPSB0cnVlLAogICAgYWN0aW9uQ3JlYXRvckNoZWNrID0gdHJ1ZQogIH0gPSBvcHRpb25zID8/IHt9OwogIGxldCBtaWRkbGV3YXJlQXJyYXkgPSBuZXcgVHVwbGUoKTsKICBpZiAodGh1bmsyKSB7CiAgICBpZiAoaXNCb29sZWFuMih0aHVuazIpKSB7CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKHRodW5rKTsKICAgIH0gZWxzZSB7CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKHdpdGhFeHRyYUFyZ3VtZW50KHRodW5rMi5leHRyYUFyZ3VtZW50KSk7CiAgICB9CiAgfQogIGlmICh0cnVlKSB7CiAgICBpZiAoaW1tdXRhYmxlQ2hlY2spIHsKICAgICAgbGV0IGltbXV0YWJsZU9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKGltbXV0YWJsZUNoZWNrKSkgewogICAgICAgIGltbXV0YWJsZU9wdGlvbnMgPSBpbW11dGFibGVDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkudW5zaGlmdChjcmVhdGVJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUoaW1tdXRhYmxlT3B0aW9ucykpOwogICAgfQogICAgaWYgKHNlcmlhbGl6YWJsZUNoZWNrKSB7CiAgICAgIGxldCBzZXJpYWxpemFibGVPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihzZXJpYWxpemFibGVDaGVjaykpIHsKICAgICAgICBzZXJpYWxpemFibGVPcHRpb25zID0gc2VyaWFsaXphYmxlQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2goY3JlYXRlU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKHNlcmlhbGl6YWJsZU9wdGlvbnMpKTsKICAgIH0KICAgIGlmIChhY3Rpb25DcmVhdG9yQ2hlY2spIHsKICAgICAgbGV0IGFjdGlvbkNyZWF0b3JPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihhY3Rpb25DcmVhdG9yQ2hlY2spKSB7CiAgICAgICAgYWN0aW9uQ3JlYXRvck9wdGlvbnMgPSBhY3Rpb25DcmVhdG9yQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnVuc2hpZnQoY3JlYXRlQWN0aW9uQ3JlYXRvckludmFyaWFudE1pZGRsZXdhcmUoYWN0aW9uQ3JlYXRvck9wdGlvbnMpKTsKICAgIH0KICB9CiAgcmV0dXJuIG1pZGRsZXdhcmVBcnJheTsKfTsKdmFyIFNIT1VMRF9BVVRPQkFUQ0ggPSAiUlRLX2F1dG9CYXRjaCI7CnZhciBwcmVwYXJlQXV0b0JhdGNoZWQgPSAoKSA9PiAocGF5bG9hZCkgPT4gKHsKICBwYXlsb2FkLAogIG1ldGE6IHsKICAgIFtTSE9VTERfQVVUT0JBVENIXTogdHJ1ZQogIH0KfSk7CnZhciBjcmVhdGVRdWV1ZVdpdGhUaW1lciA9ICh0aW1lb3V0KSA9PiB7CiAgcmV0dXJuIChub3RpZnkpID0+IHsKICAgIHNldFRpbWVvdXQobm90aWZ5LCB0aW1lb3V0KTsKICB9Owp9Owp2YXIgYXV0b0JhdGNoRW5oYW5jZXIgPSAob3B0aW9ucyA9IHsKICB0eXBlOiAicmFmIgp9KSA9PiAobmV4dCkgPT4gKC4uLmFyZ3MpID0+IHsKICBjb25zdCBzdG9yZSA9IG5leHQoLi4uYXJncyk7CiAgbGV0IG5vdGlmeWluZyA9IHRydWU7CiAgbGV0IHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gZmFsc2U7CiAgbGV0IG5vdGlmaWNhdGlvblF1ZXVlZCA9IGZhbHNlOwogIGNvbnN0IGxpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgY29uc3QgcXVldWVDYWxsYmFjayA9IG9wdGlvbnMudHlwZSA9PT0gInRpY2siID8gcXVldWVNaWNyb3Rhc2sgOiBvcHRpb25zLnR5cGUgPT09ICJyYWYiID8gKAogICAgLy8gcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHdvbid0IGV4aXN0IGluIFNTUiBlbnZpcm9ubWVudHMuIEZhbGwgYmFjayB0byBhIHZhZ3VlIGFwcHJveGltYXRpb24ganVzdCB0byBrZWVwIGZyb20gZXJyb3JpbmcuCiAgICB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA6IGNyZWF0ZVF1ZXVlV2l0aFRpbWVyKDEwKQogICkgOiBvcHRpb25zLnR5cGUgPT09ICJjYWxsYmFjayIgPyBvcHRpb25zLnF1ZXVlTm90aWZpY2F0aW9uIDogY3JlYXRlUXVldWVXaXRoVGltZXIob3B0aW9ucy50aW1lb3V0KTsKICBjb25zdCBub3RpZnlMaXN0ZW5lcnMgPSAoKSA9PiB7CiAgICBub3RpZmljYXRpb25RdWV1ZWQgPSBmYWxzZTsKICAgIGlmIChzaG91bGROb3RpZnlBdEVuZE9mVGljaykgewogICAgICBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9IGZhbHNlOwogICAgICBsaXN0ZW5lcnMuZm9yRWFjaCgobCkgPT4gbCgpKTsKICAgIH0KICB9OwogIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdG9yZSwgewogICAgLy8gT3ZlcnJpZGUgdGhlIGJhc2UgYHN0b3JlLnN1YnNjcmliZWAgbWV0aG9kIHRvIGtlZXAgb3JpZ2luYWwgbGlzdGVuZXJzCiAgICAvLyBmcm9tIHJ1bm5pbmcgaWYgd2UncmUgZGVsYXlpbmcgbm90aWZpY2F0aW9ucwogICAgc3Vic2NyaWJlKGxpc3RlbmVyMikgewogICAgICBjb25zdCB3cmFwcGVkTGlzdGVuZXIgPSAoKSA9PiBub3RpZnlpbmcgJiYgbGlzdGVuZXIyKCk7CiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gc3RvcmUuc3Vic2NyaWJlKHdyYXBwZWRMaXN0ZW5lcik7CiAgICAgIGxpc3RlbmVycy5hZGQobGlzdGVuZXIyKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICB1bnN1YnNjcmliZSgpOwogICAgICAgIGxpc3RlbmVycy5kZWxldGUobGlzdGVuZXIyKTsKICAgICAgfTsKICAgIH0sCiAgICAvLyBPdmVycmlkZSB0aGUgYmFzZSBgc3RvcmUuZGlzcGF0Y2hgIG1ldGhvZCBzbyB0aGF0IHdlIGNhbiBjaGVjayBhY3Rpb25zCiAgICAvLyBmb3IgdGhlIGBzaG91bGRBdXRvQmF0Y2hgIGZsYWcgYW5kIGRldGVybWluZSBpZiBiYXRjaGluZyBpcyBhY3RpdmUKICAgIGRpc3BhdGNoKGFjdGlvbikgewogICAgICB0cnkgewogICAgICAgIG5vdGlmeWluZyA9ICFhY3Rpb24/Lm1ldGE/LltTSE9VTERfQVVUT0JBVENIXTsKICAgICAgICBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9ICFub3RpZnlpbmc7CiAgICAgICAgaWYgKHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrKSB7CiAgICAgICAgICBpZiAoIW5vdGlmaWNhdGlvblF1ZXVlZCkgewogICAgICAgICAgICBub3RpZmljYXRpb25RdWV1ZWQgPSB0cnVlOwogICAgICAgICAgICBxdWV1ZUNhbGxiYWNrKG5vdGlmeUxpc3RlbmVycyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdG9yZS5kaXNwYXRjaChhY3Rpb24pOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIG5vdGlmeWluZyA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKdmFyIGJ1aWxkR2V0RGVmYXVsdEVuaGFuY2VycyA9IChtaWRkbGV3YXJlRW5oYW5jZXIpID0+IGZ1bmN0aW9uIGdldERlZmF1bHRFbmhhbmNlcnMob3B0aW9ucykgewogIGNvbnN0IHsKICAgIGF1dG9CYXRjaCA9IHRydWUKICB9ID0gb3B0aW9ucyA/PyB7fTsKICBsZXQgZW5oYW5jZXJBcnJheSA9IG5ldyBUdXBsZShtaWRkbGV3YXJlRW5oYW5jZXIpOwogIGlmIChhdXRvQmF0Y2gpIHsKICAgIGVuaGFuY2VyQXJyYXkucHVzaChhdXRvQmF0Y2hFbmhhbmNlcih0eXBlb2YgYXV0b0JhdGNoID09PSAib2JqZWN0IiA/IGF1dG9CYXRjaCA6IHZvaWQgMCkpOwogIH0KICByZXR1cm4gZW5oYW5jZXJBcnJheTsKfTsKZnVuY3Rpb24gY29uZmlndXJlU3RvcmUob3B0aW9ucykgewogIGNvbnN0IGdldERlZmF1bHRNaWRkbGV3YXJlID0gYnVpbGRHZXREZWZhdWx0TWlkZGxld2FyZSgpOwogIGNvbnN0IHsKICAgIHJlZHVjZXIgPSB2b2lkIDAsCiAgICBtaWRkbGV3YXJlLAogICAgZGV2VG9vbHMgPSB0cnVlLAogICAgZHVwbGljYXRlTWlkZGxld2FyZUNoZWNrID0gdHJ1ZSwKICAgIHByZWxvYWRlZFN0YXRlID0gdm9pZCAwLAogICAgZW5oYW5jZXJzID0gdm9pZCAwCiAgfSA9IG9wdGlvbnMgfHwge307CiAgbGV0IHJvb3RSZWR1Y2VyMjsKICBpZiAodHlwZW9mIHJlZHVjZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJvb3RSZWR1Y2VyMiA9IHJlZHVjZXI7CiAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHJlZHVjZXIpKSB7CiAgICByb290UmVkdWNlcjIgPSBjb21iaW5lUmVkdWNlcnMocmVkdWNlcik7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMSkgOiAiYHJlZHVjZXJgIGlzIGEgcmVxdWlyZWQgYXJndW1lbnQsIGFuZCBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0IG9mIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gY29tYmluZVJlZHVjZXJzIik7CiAgfQogIGlmIChtaWRkbGV3YXJlICYmIHR5cGVvZiBtaWRkbGV3YXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIpIDogImBtaWRkbGV3YXJlYCBmaWVsZCBtdXN0IGJlIGEgY2FsbGJhY2siKTsKICB9CiAgbGV0IGZpbmFsTWlkZGxld2FyZTsKICBpZiAodHlwZW9mIG1pZGRsZXdhcmUgPT09ICJmdW5jdGlvbiIpIHsKICAgIGZpbmFsTWlkZGxld2FyZSA9IG1pZGRsZXdhcmUoZ2V0RGVmYXVsdE1pZGRsZXdhcmUpOwogICAgaWYgKCFBcnJheS5pc0FycmF5KGZpbmFsTWlkZGxld2FyZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzKSA6ICJ3aGVuIHVzaW5nIGEgbWlkZGxld2FyZSBidWlsZGVyIGZ1bmN0aW9uLCBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIG11c3QgYmUgcmV0dXJuZWQiKTsKICAgIH0KICB9IGVsc2UgewogICAgZmluYWxNaWRkbGV3YXJlID0gZ2V0RGVmYXVsdE1pZGRsZXdhcmUoKTsKICB9CiAgaWYgKGZpbmFsTWlkZGxld2FyZS5zb21lKChpdGVtKSA9PiB0eXBlb2YgaXRlbSAhPT0gImZ1bmN0aW9uIikpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNCkgOiAiZWFjaCBtaWRkbGV3YXJlIHByb3ZpZGVkIHRvIGNvbmZpZ3VyZVN0b3JlIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogIH0KICBpZiAoZHVwbGljYXRlTWlkZGxld2FyZUNoZWNrKSB7CiAgICBsZXQgbWlkZGxld2FyZVJlZmVyZW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgZmluYWxNaWRkbGV3YXJlLmZvckVhY2goKG1pZGRsZXdhcmUyKSA9PiB7CiAgICAgIGlmIChtaWRkbGV3YXJlUmVmZXJlbmNlcy5oYXMobWlkZGxld2FyZTIpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0MikgOiAiRHVwbGljYXRlIG1pZGRsZXdhcmUgcmVmZXJlbmNlcyBmb3VuZCB3aGVuIGNyZWF0aW5nIHRoZSBzdG9yZS4gRW5zdXJlIHRoYXQgZWFjaCBtaWRkbGV3YXJlIGlzIG9ubHkgaW5jbHVkZWQgb25jZS4iKTsKICAgICAgfQogICAgICBtaWRkbGV3YXJlUmVmZXJlbmNlcy5hZGQobWlkZGxld2FyZTIpOwogICAgfSk7CiAgfQogIGxldCBmaW5hbENvbXBvc2UgPSBjb21wb3NlOwogIGlmIChkZXZUb29scykgewogICAgZmluYWxDb21wb3NlID0gY29tcG9zZVdpdGhEZXZUb29scyh7CiAgICAgIC8vIEVuYWJsZSBjYXB0dXJlIG9mIHN0YWNrIHRyYWNlcyBmb3IgZGlzcGF0Y2hlZCBSZWR1eCBhY3Rpb25zCiAgICAgIHRyYWNlOiB0cnVlLAogICAgICAuLi50eXBlb2YgZGV2VG9vbHMgPT09ICJvYmplY3QiICYmIGRldlRvb2xzCiAgICB9KTsKICB9CiAgY29uc3QgbWlkZGxld2FyZUVuaGFuY2VyID0gYXBwbHlNaWRkbGV3YXJlKC4uLmZpbmFsTWlkZGxld2FyZSk7CiAgY29uc3QgZ2V0RGVmYXVsdEVuaGFuY2VycyA9IGJ1aWxkR2V0RGVmYXVsdEVuaGFuY2VycyhtaWRkbGV3YXJlRW5oYW5jZXIpOwogIGlmIChlbmhhbmNlcnMgJiYgdHlwZW9mIGVuaGFuY2VycyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg1KSA6ICJgZW5oYW5jZXJzYCBmaWVsZCBtdXN0IGJlIGEgY2FsbGJhY2siKTsKICB9CiAgbGV0IHN0b3JlRW5oYW5jZXJzID0gdHlwZW9mIGVuaGFuY2VycyA9PT0gImZ1bmN0aW9uIiA/IGVuaGFuY2VycyhnZXREZWZhdWx0RW5oYW5jZXJzKSA6IGdldERlZmF1bHRFbmhhbmNlcnMoKTsKICBpZiAoIUFycmF5LmlzQXJyYXkoc3RvcmVFbmhhbmNlcnMpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDYpIDogImBlbmhhbmNlcnNgIGNhbGxiYWNrIG11c3QgcmV0dXJuIGFuIGFycmF5Iik7CiAgfQogIGlmIChzdG9yZUVuaGFuY2Vycy5zb21lKChpdGVtKSA9PiB0eXBlb2YgaXRlbSAhPT0gImZ1bmN0aW9uIikpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNykgOiAiZWFjaCBlbmhhbmNlciBwcm92aWRlZCB0byBjb25maWd1cmVTdG9yZSBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICB9CiAgaWYgKGZpbmFsTWlkZGxld2FyZS5sZW5ndGggJiYgIXN0b3JlRW5oYW5jZXJzLmluY2x1ZGVzKG1pZGRsZXdhcmVFbmhhbmNlcikpIHsKICAgIGNvbnNvbGUuZXJyb3IoIm1pZGRsZXdhcmVzIHdlcmUgcHJvdmlkZWQsIGJ1dCBtaWRkbGV3YXJlIGVuaGFuY2VyIHdhcyBub3QgaW5jbHVkZWQgaW4gZmluYWwgZW5oYW5jZXJzIC0gbWFrZSBzdXJlIHRvIGNhbGwgYGdldERlZmF1bHRFbmhhbmNlcnNgIik7CiAgfQogIGNvbnN0IGNvbXBvc2VkRW5oYW5jZXIgPSBmaW5hbENvbXBvc2UoLi4uc3RvcmVFbmhhbmNlcnMpOwogIHJldHVybiBjcmVhdGVTdG9yZShyb290UmVkdWNlcjIsIHByZWxvYWRlZFN0YXRlLCBjb21wb3NlZEVuaGFuY2VyKTsKfQpmdW5jdGlvbiBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhidWlsZGVyQ2FsbGJhY2spIHsKICBjb25zdCBhY3Rpb25zTWFwID0ge307CiAgY29uc3QgYWN0aW9uTWF0Y2hlcnMgPSBbXTsKICBsZXQgZGVmYXVsdENhc2VSZWR1Y2VyOwogIGNvbnN0IGJ1aWxkZXIgPSB7CiAgICBhZGRDYXNlKHR5cGVPckFjdGlvbkNyZWF0b3IsIHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoYWN0aW9uTWF0Y2hlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyNikgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZE1hdGNoZXJgIik7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjcpIDogImBidWlsZGVyLmFkZENhc2VgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdHlwZSA9IHR5cGVvZiB0eXBlT3JBY3Rpb25DcmVhdG9yID09PSAic3RyaW5nIiA/IHR5cGVPckFjdGlvbkNyZWF0b3IgOiB0eXBlT3JBY3Rpb25DcmVhdG9yLnR5cGU7CiAgICAgIGlmICghdHlwZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjgpIDogImBidWlsZGVyLmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBhbiBlbXB0eSBhY3Rpb24gdHlwZSIpOwogICAgICB9CiAgICAgIGlmICh0eXBlIGluIGFjdGlvbnNNYXApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI5KSA6IGBcYGJ1aWxkZXIuYWRkQ2FzZVxgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCB0d28gcmVkdWNlcnMgZm9yIHRoZSBzYW1lIGFjdGlvbiB0eXBlICcke3R5cGV9J2ApOwogICAgICB9CiAgICAgIGFjdGlvbnNNYXBbdHlwZV0gPSByZWR1Y2VyOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGRBc3luY1RodW5rKGFzeW5jVGh1bmssIHJlZHVjZXJzKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0MykgOiAiYGJ1aWxkZXIuYWRkQXN5bmNUaHVua2Agc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocmVkdWNlcnMucGVuZGluZykgYWN0aW9uc01hcFthc3luY1RodW5rLnBlbmRpbmcudHlwZV0gPSByZWR1Y2Vycy5wZW5kaW5nOwogICAgICBpZiAocmVkdWNlcnMucmVqZWN0ZWQpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5yZWplY3RlZC50eXBlXSA9IHJlZHVjZXJzLnJlamVjdGVkOwogICAgICBpZiAocmVkdWNlcnMuZnVsZmlsbGVkKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsuZnVsZmlsbGVkLnR5cGVdID0gcmVkdWNlcnMuZnVsZmlsbGVkOwogICAgICBpZiAocmVkdWNlcnMuc2V0dGxlZCkgYWN0aW9uTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgbWF0Y2hlcjogYXN5bmNUaHVuay5zZXR0bGVkLAogICAgICAgIHJlZHVjZXI6IHJlZHVjZXJzLnNldHRsZWQKICAgICAgfSk7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZE1hdGNoZXIobWF0Y2hlciwgcmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzApIDogImBidWlsZGVyLmFkZE1hdGNoZXJgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYWN0aW9uTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgbWF0Y2hlciwKICAgICAgICByZWR1Y2VyCiAgICAgIH0pOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGREZWZhdWx0Q2FzZShyZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMSkgOiAiYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlZmF1bHRDYXNlUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfQogIH07CiAgYnVpbGRlckNhbGxiYWNrKGJ1aWxkZXIpOwogIHJldHVybiBbYWN0aW9uc01hcCwgYWN0aW9uTWF0Y2hlcnMsIGRlZmF1bHRDYXNlUmVkdWNlcl07Cn0KZnVuY3Rpb24gaXNTdGF0ZUZ1bmN0aW9uKHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBjcmVhdGVSZWR1Y2VyKGluaXRpYWxTdGF0ZTEzLCBtYXBPckJ1aWxkZXJDYWxsYmFjaykgewogIGlmICh0cnVlKSB7CiAgICBpZiAodHlwZW9mIG1hcE9yQnVpbGRlckNhbGxiYWNrID09PSAib2JqZWN0IikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDgpIDogIlRoZSBvYmplY3Qgbm90YXRpb24gZm9yIGBjcmVhdGVSZWR1Y2VyYCBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgdXNlIHRoZSAnYnVpbGRlciBjYWxsYmFjaycgbm90YXRpb24gaW5zdGVhZDogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvY3JlYXRlUmVkdWNlciIpOwogICAgfQogIH0KICBsZXQgW2FjdGlvbnNNYXAsIGZpbmFsQWN0aW9uTWF0Y2hlcnMsIGZpbmFsRGVmYXVsdENhc2VSZWR1Y2VyXSA9IGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKG1hcE9yQnVpbGRlckNhbGxiYWNrKTsKICBsZXQgZ2V0SW5pdGlhbFN0YXRlOwogIGlmIChpc1N0YXRlRnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpKSB7CiAgICBnZXRJbml0aWFsU3RhdGUgPSAoKSA9PiBmcmVlemVEcmFmdGFibGUoaW5pdGlhbFN0YXRlMTMoKSk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGZyb3plbkluaXRpYWxTdGF0ZSA9IGZyZWV6ZURyYWZ0YWJsZShpbml0aWFsU3RhdGUxMyk7CiAgICBnZXRJbml0aWFsU3RhdGUgPSAoKSA9PiBmcm96ZW5Jbml0aWFsU3RhdGU7CiAgfQogIGZ1bmN0aW9uIHJlZHVjZXIoc3RhdGUgPSBnZXRJbml0aWFsU3RhdGUoKSwgYWN0aW9uKSB7CiAgICBsZXQgY2FzZVJlZHVjZXJzID0gW2FjdGlvbnNNYXBbYWN0aW9uLnR5cGVdLCAuLi5maW5hbEFjdGlvbk1hdGNoZXJzLmZpbHRlcigoewogICAgICBtYXRjaGVyCiAgICB9KSA9PiBtYXRjaGVyKGFjdGlvbikpLm1hcCgoewogICAgICByZWR1Y2VyOiByZWR1Y2VyMgogICAgfSkgPT4gcmVkdWNlcjIpXTsKICAgIGlmIChjYXNlUmVkdWNlcnMuZmlsdGVyKChjcikgPT4gISFjcikubGVuZ3RoID09PSAwKSB7CiAgICAgIGNhc2VSZWR1Y2VycyA9IFtmaW5hbERlZmF1bHRDYXNlUmVkdWNlcl07CiAgICB9CiAgICByZXR1cm4gY2FzZVJlZHVjZXJzLnJlZHVjZSgocHJldmlvdXNTdGF0ZSwgY2FzZVJlZHVjZXIpID0+IHsKICAgICAgaWYgKGNhc2VSZWR1Y2VyKSB7CiAgICAgICAgaWYgKGlzRHJhZnQocHJldmlvdXNTdGF0ZSkpIHsKICAgICAgICAgIGNvbnN0IGRyYWZ0ID0gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhc2VSZWR1Y2VyKGRyYWZ0LCBhY3Rpb24pOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGVsc2UgaWYgKCFpc0RyYWZ0YWJsZShwcmV2aW91c1N0YXRlKSkgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FzZVJlZHVjZXIocHJldmlvdXNTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAocHJldmlvdXNTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IEVycm9yKCJBIGNhc2UgcmVkdWNlciBvbiBhIG5vbi1kcmFmdGFibGUgdmFsdWUgbXVzdCBub3QgcmV0dXJuIHVuZGVmaW5lZCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHByb2R1Y2UocHJldmlvdXNTdGF0ZSwgKGRyYWZ0KSA9PiB7CiAgICAgICAgICAgIHJldHVybiBjYXNlUmVkdWNlcihkcmFmdCwgYWN0aW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgIH0sIHN0YXRlKTsKICB9CiAgcmVkdWNlci5nZXRJbml0aWFsU3RhdGUgPSBnZXRJbml0aWFsU3RhdGU7CiAgcmV0dXJuIHJlZHVjZXI7Cn0KdmFyIG1hdGNoZXMgPSAobWF0Y2hlciwgYWN0aW9uKSA9PiB7CiAgaWYgKGhhc01hdGNoRnVuY3Rpb24obWF0Y2hlcikpIHsKICAgIHJldHVybiBtYXRjaGVyLm1hdGNoKGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIHJldHVybiBtYXRjaGVyKGFjdGlvbik7CiAgfQp9OwpmdW5jdGlvbiBpc0FueU9mKC4uLm1hdGNoZXJzKSB7CiAgcmV0dXJuIChhY3Rpb24pID0+IHsKICAgIHJldHVybiBtYXRjaGVycy5zb21lKChtYXRjaGVyKSA9PiBtYXRjaGVzKG1hdGNoZXIsIGFjdGlvbikpOwogIH07Cn0KdmFyIHVybEFscGhhYmV0ID0gIk1vZHVsZVN5bWJoYXNPd25Qci0wMTIzNDU2Nzg5QUJDREVGR0hOUlZmZ2N0aVV2el9LcVlUSmtMeHBaWElqUVciOwp2YXIgbmFub2lkID0gKHNpemUgPSAyMSkgPT4gewogIGxldCBpZCA9ICIiOwogIGxldCBpID0gc2l6ZTsKICB3aGlsZSAoaS0tKSB7CiAgICBpZCArPSB1cmxBbHBoYWJldFtNYXRoLnJhbmRvbSgpICogNjQgfCAwXTsKICB9CiAgcmV0dXJuIGlkOwp9Owp2YXIgY29tbW9uUHJvcGVydGllcyA9IFsibmFtZSIsICJtZXNzYWdlIiwgInN0YWNrIiwgImNvZGUiXTsKdmFyIFJlamVjdFdpdGhWYWx1ZSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihwYXlsb2FkLCBtZXRhKSB7CiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy5tZXRhID0gbWV0YTsKICB9CiAgLyoKICB0eXBlLW9ubHkgcHJvcGVydHkgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBSZWplY3RXaXRoVmFsdWUgYW5kIEZ1bGZpbGxXaXRoTWV0YQogIGRvZXMgbm90IGV4aXN0IGF0IHJ1bnRpbWUKICAqLwogIF90eXBlOwp9Owp2YXIgRnVsZmlsbFdpdGhNZXRhID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBheWxvYWQsIG1ldGEpIHsKICAgIHRoaXMucGF5bG9hZCA9IHBheWxvYWQ7CiAgICB0aGlzLm1ldGEgPSBtZXRhOwogIH0KICAvKgogIHR5cGUtb25seSBwcm9wZXJ0eSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIFJlamVjdFdpdGhWYWx1ZSBhbmQgRnVsZmlsbFdpdGhNZXRhCiAgZG9lcyBub3QgZXhpc3QgYXQgcnVudGltZQogICovCiAgX3R5cGU7Cn07CnZhciBtaW5pU2VyaWFsaXplRXJyb3IgPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgY29uc3Qgc2ltcGxlRXJyb3IgPSB7fTsKICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgY29tbW9uUHJvcGVydGllcykgewogICAgICBpZiAodHlwZW9mIHZhbHVlW3Byb3BlcnR5XSA9PT0gInN0cmluZyIpIHsKICAgICAgICBzaW1wbGVFcnJvcltwcm9wZXJ0eV0gPSB2YWx1ZVtwcm9wZXJ0eV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzaW1wbGVFcnJvcjsKICB9CiAgcmV0dXJuIHsKICAgIG1lc3NhZ2U6IFN0cmluZyh2YWx1ZSkKICB9Owp9Owp2YXIgZXh0ZXJuYWxBYm9ydE1lc3NhZ2UgPSAiRXh0ZXJuYWwgc2lnbmFsIHdhcyBhYm9ydGVkIjsKdmFyIGNyZWF0ZUFzeW5jVGh1bmsgPSAvKiBAX19QVVJFX18gKi8gKCgpID0+IHsKICBmdW5jdGlvbiBjcmVhdGVBc3luY1RodW5rMih0eXBlUHJlZml4LCBwYXlsb2FkQ3JlYXRvciwgb3B0aW9ucykgewogICAgY29uc3QgZnVsZmlsbGVkID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL2Z1bGZpbGxlZCIsIChwYXlsb2FkLCByZXF1ZXN0SWQsIGFyZywgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZCwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAiZnVsZmlsbGVkIgogICAgICB9CiAgICB9KSk7CiAgICBjb25zdCBwZW5kaW5nID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL3BlbmRpbmciLCAocmVxdWVzdElkLCBhcmcsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQ6IHZvaWQgMCwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAicGVuZGluZyIKICAgICAgfQogICAgfSkpOwogICAgY29uc3QgcmVqZWN0ZWQgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvcmVqZWN0ZWQiLCAoZXJyb3IsIHJlcXVlc3RJZCwgYXJnLCBwYXlsb2FkLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkLAogICAgICBlcnJvcjogKG9wdGlvbnMgJiYgb3B0aW9ucy5zZXJpYWxpemVFcnJvciB8fCBtaW5pU2VyaWFsaXplRXJyb3IpKGVycm9yIHx8ICJSZWplY3RlZCIpLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlamVjdGVkV2l0aFZhbHVlOiAhIXBheWxvYWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogInJlamVjdGVkIiwKICAgICAgICBhYm9ydGVkOiBlcnJvcj8ubmFtZSA9PT0gIkFib3J0RXJyb3IiLAogICAgICAgIGNvbmRpdGlvbjogZXJyb3I/Lm5hbWUgPT09ICJDb25kaXRpb25FcnJvciIKICAgICAgfQogICAgfSkpOwogICAgZnVuY3Rpb24gYWN0aW9uQ3JlYXRvcihhcmcsIHsKICAgICAgc2lnbmFsCiAgICB9ID0ge30pIHsKICAgICAgcmV0dXJuIChkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhKSA9PiB7CiAgICAgICAgY29uc3QgcmVxdWVzdElkID0gb3B0aW9ucz8uaWRHZW5lcmF0b3IgPyBvcHRpb25zLmlkR2VuZXJhdG9yKGFyZykgOiBuYW5vaWQoKTsKICAgICAgICBjb25zdCBhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgICAgbGV0IGFib3J0SGFuZGxlcjsKICAgICAgICBsZXQgYWJvcnRSZWFzb247CiAgICAgICAgZnVuY3Rpb24gYWJvcnQocmVhc29uKSB7CiAgICAgICAgICBhYm9ydFJlYXNvbiA9IHJlYXNvbjsKICAgICAgICAgIGFib3J0Q29udHJvbGxlci5hYm9ydCgpOwogICAgICAgIH0KICAgICAgICBpZiAoc2lnbmFsKSB7CiAgICAgICAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgICAgYWJvcnQoZXh0ZXJuYWxBYm9ydE1lc3NhZ2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgKCkgPT4gYWJvcnQoZXh0ZXJuYWxBYm9ydE1lc3NhZ2UpLCB7CiAgICAgICAgICAgICAgb25jZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcHJvbWlzZSA9IGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgICAgbGV0IGZpbmFsQWN0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGV0IGNvbmRpdGlvblJlc3VsdCA9IG9wdGlvbnM/LmNvbmRpdGlvbj8uKGFyZywgewogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoaXNUaGVuYWJsZShjb25kaXRpb25SZXN1bHQpKSB7CiAgICAgICAgICAgICAgY29uZGl0aW9uUmVzdWx0ID0gYXdhaXQgY29uZGl0aW9uUmVzdWx0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb25kaXRpb25SZXN1bHQgPT09IGZhbHNlIHx8IGFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgICAgIHRocm93IHsKICAgICAgICAgICAgICAgIG5hbWU6ICJDb25kaXRpb25FcnJvciIsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAiQWJvcnRlZCBkdWUgdG8gY29uZGl0aW9uIGNhbGxiYWNrIHJldHVybmluZyBmYWxzZS4iCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBhYm9ydGVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICBhYm9ydEhhbmRsZXIgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICByZWplY3QoewogICAgICAgICAgICAgICAgICBuYW1lOiAiQWJvcnRFcnJvciIsCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGFib3J0UmVhc29uIHx8ICJBYm9ydGVkIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgYWJvcnRIYW5kbGVyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRpc3BhdGNoKHBlbmRpbmcocmVxdWVzdElkLCBhcmcsIG9wdGlvbnM/LmdldFBlbmRpbmdNZXRhPy4oewogICAgICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgICAgICBhcmcKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhCiAgICAgICAgICAgIH0pKSk7CiAgICAgICAgICAgIGZpbmFsQWN0aW9uID0gYXdhaXQgUHJvbWlzZS5yYWNlKFthYm9ydGVkUHJvbWlzZSwgUHJvbWlzZS5yZXNvbHZlKHBheWxvYWRDcmVhdG9yKGFyZywgewogICAgICAgICAgICAgIGRpc3BhdGNoLAogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhLAogICAgICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgICAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWwsCiAgICAgICAgICAgICAgYWJvcnQsCiAgICAgICAgICAgICAgcmVqZWN0V2l0aFZhbHVlOiAodmFsdWUsIG1ldGEpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUmVqZWN0V2l0aFZhbHVlKHZhbHVlLCBtZXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bGZpbGxXaXRoVmFsdWU6ICh2YWx1ZSwgbWV0YSkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGdWxmaWxsV2l0aE1ldGEodmFsdWUsIG1ldGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpLnRoZW4oKHJlc3VsdCkgPT4gewogICAgICAgICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBSZWplY3RXaXRoVmFsdWUpIHsKICAgICAgICAgICAgICAgIHRocm93IHJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEZ1bGZpbGxXaXRoTWV0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZChyZXN1bHQucGF5bG9hZCwgcmVxdWVzdElkLCBhcmcsIHJlc3VsdC5tZXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZChyZXN1bHQsIHJlcXVlc3RJZCwgYXJnKTsKICAgICAgICAgICAgfSldKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBmaW5hbEFjdGlvbiA9IGVyciBpbnN0YW5jZW9mIFJlamVjdFdpdGhWYWx1ZSA/IHJlamVjdGVkKG51bGwsIHJlcXVlc3RJZCwgYXJnLCBlcnIucGF5bG9hZCwgZXJyLm1ldGEpIDogcmVqZWN0ZWQoZXJyLCByZXF1ZXN0SWQsIGFyZyk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpZiAoYWJvcnRIYW5kbGVyKSB7CiAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCJhYm9ydCIsIGFib3J0SGFuZGxlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHNraXBEaXNwYXRjaCA9IG9wdGlvbnMgJiYgIW9wdGlvbnMuZGlzcGF0Y2hDb25kaXRpb25SZWplY3Rpb24gJiYgcmVqZWN0ZWQubWF0Y2goZmluYWxBY3Rpb24pICYmIGZpbmFsQWN0aW9uLm1ldGEuY29uZGl0aW9uOwogICAgICAgICAgaWYgKCFza2lwRGlzcGF0Y2gpIHsKICAgICAgICAgICAgZGlzcGF0Y2goZmluYWxBY3Rpb24pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpbmFsQWN0aW9uOwogICAgICAgIH0oKTsKICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihwcm9taXNlLCB7CiAgICAgICAgICBhYm9ydCwKICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgIGFyZywKICAgICAgICAgIHVud3JhcCgpIHsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbih1bndyYXBSZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYWN0aW9uQ3JlYXRvciwgewogICAgICBwZW5kaW5nLAogICAgICByZWplY3RlZCwKICAgICAgZnVsZmlsbGVkLAogICAgICBzZXR0bGVkOiBpc0FueU9mKHJlamVjdGVkLCBmdWxmaWxsZWQpLAogICAgICB0eXBlUHJlZml4CiAgICB9KTsKICB9CiAgY3JlYXRlQXN5bmNUaHVuazIud2l0aFR5cGVzID0gKCkgPT4gY3JlYXRlQXN5bmNUaHVuazI7CiAgcmV0dXJuIGNyZWF0ZUFzeW5jVGh1bmsyOwp9KSgpOwpmdW5jdGlvbiB1bndyYXBSZXN1bHQoYWN0aW9uKSB7CiAgaWYgKGFjdGlvbi5tZXRhICYmIGFjdGlvbi5tZXRhLnJlamVjdGVkV2l0aFZhbHVlKSB7CiAgICB0aHJvdyBhY3Rpb24ucGF5bG9hZDsKICB9CiAgaWYgKGFjdGlvbi5lcnJvcikgewogICAgdGhyb3cgYWN0aW9uLmVycm9yOwogIH0KICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7Cn0KZnVuY3Rpb24gaXNUaGVuYWJsZSh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iOwp9CnZhciBhc3luY1RodW5rU3ltYm9sID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoInJ0ay1zbGljZS1jcmVhdGVhc3luY3RodW5rIik7CnZhciBhc3luY1RodW5rQ3JlYXRvciA9IHsKICBbYXN5bmNUaHVua1N5bWJvbF06IGNyZWF0ZUFzeW5jVGh1bmsKfTsKZnVuY3Rpb24gZ2V0VHlwZShzbGljZTIsIGFjdGlvbktleSkgewogIHJldHVybiBgJHtzbGljZTJ9LyR7YWN0aW9uS2V5fWA7Cn0KZnVuY3Rpb24gYnVpbGRDcmVhdGVTbGljZSh7CiAgY3JlYXRvcnMKfSA9IHt9KSB7CiAgY29uc3QgY0FUID0gY3JlYXRvcnM/LmFzeW5jVGh1bms/Llthc3luY1RodW5rU3ltYm9sXTsKICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlU2xpY2UyKG9wdGlvbnMpIHsKICAgIGNvbnN0IHsKICAgICAgbmFtZSwKICAgICAgcmVkdWNlclBhdGggPSBuYW1lCiAgICB9ID0gb3B0aW9uczsKICAgIGlmICghbmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDExKSA6ICJgbmFtZWAgaXMgYSByZXF1aXJlZCBvcHRpb24gZm9yIGNyZWF0ZVNsaWNlIik7CiAgICB9CiAgICBpZiAodHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmIHRydWUpIHsKICAgICAgaWYgKG9wdGlvbnMuaW5pdGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJZb3UgbXVzdCBwcm92aWRlIGFuIGBpbml0aWFsU3RhdGVgIHZhbHVlIHRoYXQgaXMgbm90IGB1bmRlZmluZWRgLiBZb3UgbWF5IGhhdmUgbWlzc3BlbGxlZCBgaW5pdGlhbFN0YXRlYCIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCByZWR1Y2VycyA9ICh0eXBlb2Ygb3B0aW9ucy5yZWR1Y2VycyA9PT0gImZ1bmN0aW9uIiA/IG9wdGlvbnMucmVkdWNlcnMoYnVpbGRSZWR1Y2VyQ3JlYXRvcnMoKSkgOiBvcHRpb25zLnJlZHVjZXJzKSB8fCB7fTsKICAgIGNvbnN0IHJlZHVjZXJOYW1lcyA9IE9iamVjdC5rZXlzKHJlZHVjZXJzKTsKICAgIGNvbnN0IGNvbnRleHQgPSB7CiAgICAgIHNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lOiB7fSwKICAgICAgc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGU6IHt9LAogICAgICBhY3Rpb25DcmVhdG9yczoge30sCiAgICAgIHNsaWNlTWF0Y2hlcnM6IFtdCiAgICB9OwogICAgY29uc3QgY29udGV4dE1ldGhvZHMgPSB7CiAgICAgIGFkZENhc2UodHlwZU9yQWN0aW9uQ3JlYXRvciwgcmVkdWNlcjIpIHsKICAgICAgICBjb25zdCB0eXBlID0gdHlwZW9mIHR5cGVPckFjdGlvbkNyZWF0b3IgPT09ICJzdHJpbmciID8gdHlwZU9yQWN0aW9uQ3JlYXRvciA6IHR5cGVPckFjdGlvbkNyZWF0b3IudHlwZTsKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTIpIDogImBjb250ZXh0LmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBhbiBlbXB0eSBhY3Rpb24gdHlwZSIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSBpbiBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEzKSA6ICJgY29udGV4dC5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggdHdvIHJlZHVjZXJzIGZvciB0aGUgc2FtZSBhY3Rpb24gdHlwZTogIiArIHR5cGUpOwogICAgICAgIH0KICAgICAgICBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlW3R5cGVdID0gcmVkdWNlcjI7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBhZGRNYXRjaGVyKG1hdGNoZXIsIHJlZHVjZXIyKSB7CiAgICAgICAgY29udGV4dC5zbGljZU1hdGNoZXJzLnB1c2goewogICAgICAgICAgbWF0Y2hlciwKICAgICAgICAgIHJlZHVjZXI6IHJlZHVjZXIyCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBleHBvc2VBY3Rpb24obmFtZTIsIGFjdGlvbkNyZWF0b3IpIHsKICAgICAgICBjb250ZXh0LmFjdGlvbkNyZWF0b3JzW25hbWUyXSA9IGFjdGlvbkNyZWF0b3I7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBleHBvc2VDYXNlUmVkdWNlcihuYW1lMiwgcmVkdWNlcjIpIHsKICAgICAgICBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lW25hbWUyXSA9IHJlZHVjZXIyOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfQogICAgfTsKICAgIHJlZHVjZXJOYW1lcy5mb3JFYWNoKChyZWR1Y2VyTmFtZSkgPT4gewogICAgICBjb25zdCByZWR1Y2VyRGVmaW5pdGlvbiA9IHJlZHVjZXJzW3JlZHVjZXJOYW1lXTsKICAgICAgY29uc3QgcmVkdWNlckRldGFpbHMgPSB7CiAgICAgICAgcmVkdWNlck5hbWUsCiAgICAgICAgdHlwZTogZ2V0VHlwZShuYW1lLCByZWR1Y2VyTmFtZSksCiAgICAgICAgY3JlYXRlTm90YXRpb246IHR5cGVvZiBvcHRpb25zLnJlZHVjZXJzID09PSAiZnVuY3Rpb24iCiAgICAgIH07CiAgICAgIGlmIChpc0FzeW5jVGh1bmtTbGljZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSkgewogICAgICAgIGhhbmRsZVRodW5rQ2FzZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZXRhaWxzLCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dE1ldGhvZHMsIGNBVCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlTm9ybWFsUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRldGFpbHMsIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0TWV0aG9kcyk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gYnVpbGRSZWR1Y2VyKCkgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5leHRyYVJlZHVjZXJzID09PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNCkgOiAiVGhlIG9iamVjdCBub3RhdGlvbiBmb3IgYGNyZWF0ZVNsaWNlLmV4dHJhUmVkdWNlcnNgIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSB1c2UgdGhlICdidWlsZGVyIGNhbGxiYWNrJyBub3RhdGlvbiBpbnN0ZWFkOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9jcmVhdGVTbGljZSIpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBbZXh0cmFSZWR1Y2VycyA9IHt9LCBhY3Rpb25NYXRjaGVycyA9IFtdLCBkZWZhdWx0Q2FzZVJlZHVjZXIgPSB2b2lkIDBdID0gdHlwZW9mIG9wdGlvbnMuZXh0cmFSZWR1Y2VycyA9PT0gImZ1bmN0aW9uIiA/IGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKG9wdGlvbnMuZXh0cmFSZWR1Y2VycykgOiBbb3B0aW9ucy5leHRyYVJlZHVjZXJzXTsKICAgICAgY29uc3QgZmluYWxDYXNlUmVkdWNlcnMgPSB7CiAgICAgICAgLi4uZXh0cmFSZWR1Y2VycywKICAgICAgICAuLi5jb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlCiAgICAgIH07CiAgICAgIHJldHVybiBjcmVhdGVSZWR1Y2VyKG9wdGlvbnMuaW5pdGlhbFN0YXRlLCAoYnVpbGRlcikgPT4gewogICAgICAgIGZvciAobGV0IGtleSBpbiBmaW5hbENhc2VSZWR1Y2VycykgewogICAgICAgICAgYnVpbGRlci5hZGRDYXNlKGtleSwgZmluYWxDYXNlUmVkdWNlcnNba2V5XSk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IHNNIG9mIGNvbnRleHQuc2xpY2VNYXRjaGVycykgewogICAgICAgICAgYnVpbGRlci5hZGRNYXRjaGVyKHNNLm1hdGNoZXIsIHNNLnJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBtIG9mIGFjdGlvbk1hdGNoZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZE1hdGNoZXIobS5tYXRjaGVyLCBtLnJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICBidWlsZGVyLmFkZERlZmF1bHRDYXNlKGRlZmF1bHRDYXNlUmVkdWNlcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHNlbGVjdFNlbGYgPSAoc3RhdGUpID0+IHN0YXRlOwogICAgY29uc3QgaW5qZWN0ZWRTZWxlY3RvckNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGluamVjdGVkU3RhdGVDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogICAgbGV0IF9yZWR1Y2VyOwogICAgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGlmICghX3JlZHVjZXIpIF9yZWR1Y2VyID0gYnVpbGRSZWR1Y2VyKCk7CiAgICAgIHJldHVybiBfcmVkdWNlcihzdGF0ZSwgYWN0aW9uKTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgaWYgKCFfcmVkdWNlcikgX3JlZHVjZXIgPSBidWlsZFJlZHVjZXIoKTsKICAgICAgcmV0dXJuIF9yZWR1Y2VyLmdldEluaXRpYWxTdGF0ZSgpOwogICAgfQogICAgZnVuY3Rpb24gbWFrZVNlbGVjdG9yUHJvcHMocmVkdWNlclBhdGgyLCBpbmplY3RlZCA9IGZhbHNlKSB7CiAgICAgIGZ1bmN0aW9uIHNlbGVjdFNsaWNlKHN0YXRlKSB7CiAgICAgICAgbGV0IHNsaWNlU3RhdGUgPSBzdGF0ZVtyZWR1Y2VyUGF0aDJdOwogICAgICAgIGlmICh0eXBlb2Ygc2xpY2VTdGF0ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZCkgewogICAgICAgICAgICBzbGljZVN0YXRlID0gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFN0YXRlQ2FjaGUsIHNlbGVjdFNsaWNlLCBnZXRJbml0aWFsU3RhdGUpOwogICAgICAgICAgfSBlbHNlIGlmICh0cnVlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogInNlbGVjdFNsaWNlIHJldHVybmVkIHVuZGVmaW5lZCBmb3IgYW4gdW5pbmplY3RlZCBzbGljZSByZWR1Y2VyIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzbGljZVN0YXRlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdG9ycyhzZWxlY3RTdGF0ZSA9IHNlbGVjdFNlbGYpIHsKICAgICAgICBjb25zdCBzZWxlY3RvckNhY2hlID0gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFNlbGVjdG9yQ2FjaGUsIGluamVjdGVkLCAoKSA9PiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSk7CiAgICAgICAgcmV0dXJuIGdldE9ySW5zZXJ0Q29tcHV0ZWQoc2VsZWN0b3JDYWNoZSwgc2VsZWN0U3RhdGUsICgpID0+IHsKICAgICAgICAgIGNvbnN0IG1hcDMgPSB7fTsKICAgICAgICAgIGZvciAoY29uc3QgW25hbWUyLCBzZWxlY3Rvcl0gb2YgT2JqZWN0LmVudHJpZXMob3B0aW9ucy5zZWxlY3RvcnMgPz8ge30pKSB7CiAgICAgICAgICAgIG1hcDNbbmFtZTJdID0gd3JhcFNlbGVjdG9yKHNlbGVjdG9yLCBzZWxlY3RTdGF0ZSwgKCkgPT4gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFN0YXRlQ2FjaGUsIHNlbGVjdFN0YXRlLCBnZXRJbml0aWFsU3RhdGUpLCBpbmplY3RlZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwMzsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHJlZHVjZXJQYXRoOiByZWR1Y2VyUGF0aDIsCiAgICAgICAgZ2V0U2VsZWN0b3JzLAogICAgICAgIGdldCBzZWxlY3RvcnMoKSB7CiAgICAgICAgICByZXR1cm4gZ2V0U2VsZWN0b3JzKHNlbGVjdFNsaWNlKTsKICAgICAgICB9LAogICAgICAgIHNlbGVjdFNsaWNlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBzbGljZTIgPSB7CiAgICAgIG5hbWUsCiAgICAgIHJlZHVjZXIsCiAgICAgIGFjdGlvbnM6IGNvbnRleHQuYWN0aW9uQ3JlYXRvcnMsCiAgICAgIGNhc2VSZWR1Y2VyczogY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZSwKICAgICAgZ2V0SW5pdGlhbFN0YXRlLAogICAgICAuLi5tYWtlU2VsZWN0b3JQcm9wcyhyZWR1Y2VyUGF0aCksCiAgICAgIGluamVjdEludG8oaW5qZWN0YWJsZSwgewogICAgICAgIHJlZHVjZXJQYXRoOiBwYXRoT3B0LAogICAgICAgIC4uLmNvbmZpZwogICAgICB9ID0ge30pIHsKICAgICAgICBjb25zdCBuZXdSZWR1Y2VyUGF0aCA9IHBhdGhPcHQgPz8gcmVkdWNlclBhdGg7CiAgICAgICAgaW5qZWN0YWJsZS5pbmplY3QoewogICAgICAgICAgcmVkdWNlclBhdGg6IG5ld1JlZHVjZXJQYXRoLAogICAgICAgICAgcmVkdWNlcgogICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLnNsaWNlMiwKICAgICAgICAgIC4uLm1ha2VTZWxlY3RvclByb3BzKG5ld1JlZHVjZXJQYXRoLCB0cnVlKQogICAgICAgIH07CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gc2xpY2UyOwogIH07Cn0KZnVuY3Rpb24gd3JhcFNlbGVjdG9yKHNlbGVjdG9yLCBzZWxlY3RTdGF0ZSwgZ2V0SW5pdGlhbFN0YXRlLCBpbmplY3RlZCkgewogIGZ1bmN0aW9uIHdyYXBwZXIocm9vdFN0YXRlLCAuLi5hcmdzKSB7CiAgICBsZXQgc2xpY2VTdGF0ZSA9IHNlbGVjdFN0YXRlKHJvb3RTdGF0ZSk7CiAgICBpZiAodHlwZW9mIHNsaWNlU3RhdGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGlmIChpbmplY3RlZCkgewogICAgICAgIHNsaWNlU3RhdGUgPSBnZXRJbml0aWFsU3RhdGUoKTsKICAgICAgfSBlbHNlIGlmICh0cnVlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNikgOiAic2VsZWN0U3RhdGUgcmV0dXJuZWQgdW5kZWZpbmVkIGZvciBhbiB1bmluamVjdGVkIHNsaWNlIHJlZHVjZXIiKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNlbGVjdG9yKHNsaWNlU3RhdGUsIC4uLmFyZ3MpOwogIH0KICB3cmFwcGVyLnVud3JhcHBlZCA9IHNlbGVjdG9yOwogIHJldHVybiB3cmFwcGVyOwp9CnZhciBjcmVhdGVTbGljZSA9IC8qIEBfX1BVUkVfXyAqLyBidWlsZENyZWF0ZVNsaWNlKCk7CmZ1bmN0aW9uIGJ1aWxkUmVkdWNlckNyZWF0b3JzKCkgewogIGZ1bmN0aW9uIGFzeW5jVGh1bmsocGF5bG9hZENyZWF0b3IsIGNvbmZpZykgewogICAgcmV0dXJuIHsKICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogImFzeW5jVGh1bmsiLAogICAgICBwYXlsb2FkQ3JlYXRvciwKICAgICAgLi4uY29uZmlnCiAgICB9OwogIH0KICBhc3luY1RodW5rLndpdGhUeXBlcyA9ICgpID0+IGFzeW5jVGh1bms7CiAgcmV0dXJuIHsKICAgIHJlZHVjZXIoY2FzZVJlZHVjZXIpIHsKICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oewogICAgICAgIC8vIGhhY2sgc28gdGhlIHdyYXBwaW5nIGZ1bmN0aW9uIGhhcyB0aGUgc2FtZSBuYW1lIGFzIHRoZSBvcmlnaW5hbAogICAgICAgIC8vIHdlIG5lZWQgdG8gY3JlYXRlIGEgd3JhcHBlciBzbyB0aGUgYHJlZHVjZXJEZWZpbml0aW9uVHlwZWAgaXMgbm90IGFzc2lnbmVkIHRvIHRoZSBvcmlnaW5hbAogICAgICAgIFtjYXNlUmVkdWNlci5uYW1lXSguLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gY2FzZVJlZHVjZXIoLi4uYXJncyk7CiAgICAgICAgfQogICAgICB9W2Nhc2VSZWR1Y2VyLm5hbWVdLCB7CiAgICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogInJlZHVjZXIiCiAgICAgICAgLyogcmVkdWNlciAqLwogICAgICB9KTsKICAgIH0sCiAgICBwcmVwYXJlZFJlZHVjZXIocHJlcGFyZSwgcmVkdWNlcikgewogICAgICByZXR1cm4gewogICAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJyZWR1Y2VyV2l0aFByZXBhcmUiLAogICAgICAgIHByZXBhcmUsCiAgICAgICAgcmVkdWNlcgogICAgICB9OwogICAgfSwKICAgIGFzeW5jVGh1bmsKICB9Owp9CmZ1bmN0aW9uIGhhbmRsZU5vcm1hbFJlZHVjZXJEZWZpbml0aW9uKHsKICB0eXBlLAogIHJlZHVjZXJOYW1lLAogIGNyZWF0ZU5vdGF0aW9uCn0sIG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLCBjb250ZXh0KSB7CiAgbGV0IGNhc2VSZWR1Y2VyOwogIGxldCBwcmVwYXJlQ2FsbGJhY2s7CiAgaWYgKCJyZWR1Y2VyIiBpbiBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSkgewogICAgaWYgKGNyZWF0ZU5vdGF0aW9uICYmICFpc0Nhc2VSZWR1Y2VyV2l0aFByZXBhcmVEZWZpbml0aW9uKG1heWJlUmVkdWNlcldpdGhQcmVwYXJlKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE3KSA6ICJQbGVhc2UgdXNlIHRoZSBgY3JlYXRlLnByZXBhcmVkUmVkdWNlcmAgbm90YXRpb24gZm9yIHByZXBhcmVkIGFjdGlvbiBjcmVhdG9ycyB3aXRoIHRoZSBgY3JlYXRlYCBub3RhdGlvbi4iKTsKICAgIH0KICAgIGNhc2VSZWR1Y2VyID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUucmVkdWNlcjsKICAgIHByZXBhcmVDYWxsYmFjayA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLnByZXBhcmU7CiAgfSBlbHNlIHsKICAgIGNhc2VSZWR1Y2VyID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmU7CiAgfQogIGNvbnRleHQuYWRkQ2FzZSh0eXBlLCBjYXNlUmVkdWNlcikuZXhwb3NlQ2FzZVJlZHVjZXIocmVkdWNlck5hbWUsIGNhc2VSZWR1Y2VyKS5leHBvc2VBY3Rpb24ocmVkdWNlck5hbWUsIHByZXBhcmVDYWxsYmFjayA/IGNyZWF0ZUFjdGlvbih0eXBlLCBwcmVwYXJlQ2FsbGJhY2spIDogY3JlYXRlQWN0aW9uKHR5cGUpKTsKfQpmdW5jdGlvbiBpc0FzeW5jVGh1bmtTbGljZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSB7CiAgcmV0dXJuIHJlZHVjZXJEZWZpbml0aW9uLl9yZWR1Y2VyRGVmaW5pdGlvblR5cGUgPT09ICJhc3luY1RodW5rIjsKfQpmdW5jdGlvbiBpc0Nhc2VSZWR1Y2VyV2l0aFByZXBhcmVEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSB7CiAgcmV0dXJuIHJlZHVjZXJEZWZpbml0aW9uLl9yZWR1Y2VyRGVmaW5pdGlvblR5cGUgPT09ICJyZWR1Y2VyV2l0aFByZXBhcmUiOwp9CmZ1bmN0aW9uIGhhbmRsZVRodW5rQ2FzZVJlZHVjZXJEZWZpbml0aW9uKHsKICB0eXBlLAogIHJlZHVjZXJOYW1lCn0sIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0LCBjQVQpIHsKICBpZiAoIWNBVCkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxOCkgOiAiQ2Fubm90IHVzZSBgY3JlYXRlLmFzeW5jVGh1bmtgIGluIHRoZSBidWlsdC1pbiBgY3JlYXRlU2xpY2VgLiBVc2UgYGJ1aWxkQ3JlYXRlU2xpY2UoeyBjcmVhdG9yczogeyBhc3luY1RodW5rOiBhc3luY1RodW5rQ3JlYXRvciB9IH0pYCB0byBjcmVhdGUgYSBjdXN0b21pc2VkIHZlcnNpb24gb2YgYGNyZWF0ZVNsaWNlYC4iKTsKICB9CiAgY29uc3QgewogICAgcGF5bG9hZENyZWF0b3IsCiAgICBmdWxmaWxsZWQsCiAgICBwZW5kaW5nLAogICAgcmVqZWN0ZWQsCiAgICBzZXR0bGVkLAogICAgb3B0aW9ucwogIH0gPSByZWR1Y2VyRGVmaW5pdGlvbjsKICBjb25zdCB0aHVuazIgPSBjQVQodHlwZSwgcGF5bG9hZENyZWF0b3IsIG9wdGlvbnMpOwogIGNvbnRleHQuZXhwb3NlQWN0aW9uKHJlZHVjZXJOYW1lLCB0aHVuazIpOwogIGlmIChmdWxmaWxsZWQpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIuZnVsZmlsbGVkLCBmdWxmaWxsZWQpOwogIH0KICBpZiAocGVuZGluZykgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5wZW5kaW5nLCBwZW5kaW5nKTsKICB9CiAgaWYgKHJlamVjdGVkKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLnJlamVjdGVkLCByZWplY3RlZCk7CiAgfQogIGlmIChzZXR0bGVkKSB7CiAgICBjb250ZXh0LmFkZE1hdGNoZXIodGh1bmsyLnNldHRsZWQsIHNldHRsZWQpOwogIH0KICBjb250ZXh0LmV4cG9zZUNhc2VSZWR1Y2VyKHJlZHVjZXJOYW1lLCB7CiAgICBmdWxmaWxsZWQ6IGZ1bGZpbGxlZCB8fCBub29wMywKICAgIHBlbmRpbmc6IHBlbmRpbmcgfHwgbm9vcDMsCiAgICByZWplY3RlZDogcmVqZWN0ZWQgfHwgbm9vcDMsCiAgICBzZXR0bGVkOiBzZXR0bGVkIHx8IG5vb3AzCiAgfSk7Cn0KZnVuY3Rpb24gbm9vcDMoKSB7Cn0KdmFyIHRhc2sgPSAidGFzayI7CnZhciBsaXN0ZW5lciA9ICJsaXN0ZW5lciI7CnZhciBjb21wbGV0ZWQgPSAiY29tcGxldGVkIjsKdmFyIGNhbmNlbGxlZCA9ICJjYW5jZWxsZWQiOwp2YXIgdGFza0NhbmNlbGxlZCA9IGB0YXNrLSR7Y2FuY2VsbGVkfWA7CnZhciB0YXNrQ29tcGxldGVkID0gYHRhc2stJHtjb21wbGV0ZWR9YDsKdmFyIGxpc3RlbmVyQ2FuY2VsbGVkID0gYCR7bGlzdGVuZXJ9LSR7Y2FuY2VsbGVkfWA7CnZhciBsaXN0ZW5lckNvbXBsZXRlZCA9IGAke2xpc3RlbmVyfS0ke2NvbXBsZXRlZH1gOwp2YXIgVGFza0Fib3J0RXJyb3IgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29kZSkgewogICAgdGhpcy5jb2RlID0gY29kZTsKICAgIHRoaXMubWVzc2FnZSA9IGAke3Rhc2t9ICR7Y2FuY2VsbGVkfSAocmVhc29uOiAke2NvZGV9KWA7CiAgfQogIG5hbWUgPSAiVGFza0Fib3J0RXJyb3IiOwogIG1lc3NhZ2U7Cn07CnZhciBhc3NlcnRGdW5jdGlvbiA9IChmdW5jLCBleHBlY3RlZCkgPT4gewogIGlmICh0eXBlb2YgZnVuYyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzIpIDogYCR7ZXhwZWN0ZWR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CiAgfQp9Owp2YXIgbm9vcDIyID0gKCkgPT4gewp9Owp2YXIgY2F0Y2hSZWplY3Rpb24gPSAocHJvbWlzZSwgb25FcnJvciA9IG5vb3AyMikgPT4gewogIHByb21pc2UuY2F0Y2gob25FcnJvcik7CiAgcmV0dXJuIHByb21pc2U7Cn07CnZhciBhZGRBYm9ydFNpZ25hbExpc3RlbmVyID0gKGFib3J0U2lnbmFsLCBjYWxsYmFjaykgPT4gewogIGFib3J0U2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgY2FsbGJhY2ssIHsKICAgIG9uY2U6IHRydWUKICB9KTsKICByZXR1cm4gKCkgPT4gYWJvcnRTaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYWxsYmFjayk7Cn07CnZhciBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uID0gKGFib3J0Q29udHJvbGxlciwgcmVhc29uKSA9PiB7CiAgY29uc3Qgc2lnbmFsID0gYWJvcnRDb250cm9sbGVyLnNpZ25hbDsKICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKCEoInJlYXNvbiIgaW4gc2lnbmFsKSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNpZ25hbCwgInJlYXNvbiIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHJlYXNvbiwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICB3cml0YWJsZTogdHJ1ZQogICAgfSk7CiAgfQogIDsKICBhYm9ydENvbnRyb2xsZXIuYWJvcnQocmVhc29uKTsKfTsKdmFyIHZhbGlkYXRlQWN0aXZlID0gKHNpZ25hbCkgPT4gewogIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgY29uc3QgewogICAgICByZWFzb24KICAgIH0gPSBzaWduYWw7CiAgICB0aHJvdyBuZXcgVGFza0Fib3J0RXJyb3IocmVhc29uKTsKICB9Cn07CmZ1bmN0aW9uIHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgcHJvbWlzZSkgewogIGxldCBjbGVhbnVwID0gbm9vcDIyOwogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBjb25zdCBub3RpZnlSZWplY3Rpb24gPSAoKSA9PiByZWplY3QobmV3IFRhc2tBYm9ydEVycm9yKHNpZ25hbC5yZWFzb24pKTsKICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICBub3RpZnlSZWplY3Rpb24oKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xlYW51cCA9IGFkZEFib3J0U2lnbmFsTGlzdGVuZXIoc2lnbmFsLCBub3RpZnlSZWplY3Rpb24pOwogICAgcHJvbWlzZS5maW5hbGx5KCgpID0+IGNsZWFudXAoKSkudGhlbihyZXNvbHZlLCByZWplY3QpOwogIH0pLmZpbmFsbHkoKCkgPT4gewogICAgY2xlYW51cCA9IG5vb3AyMjsKICB9KTsKfQp2YXIgcnVuVGFzayA9IGFzeW5jICh0YXNrMiwgY2xlYW5VcCkgPT4gewogIHRyeSB7CiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKTsKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGFzazIoKTsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czogIm9rIiwKICAgICAgdmFsdWUKICAgIH07CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czogZXJyb3IgaW5zdGFuY2VvZiBUYXNrQWJvcnRFcnJvciA/ICJjYW5jZWxsZWQiIDogInJlamVjdGVkIiwKICAgICAgZXJyb3IKICAgIH07CiAgfSBmaW5hbGx5IHsKICAgIGNsZWFuVXA/LigpOwogIH0KfTsKdmFyIGNyZWF0ZVBhdXNlID0gKHNpZ25hbCkgPT4gewogIHJldHVybiAocHJvbWlzZSkgPT4gewogICAgcmV0dXJuIGNhdGNoUmVqZWN0aW9uKHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgcHJvbWlzZSkudGhlbigob3V0cHV0KSA9PiB7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9KSk7CiAgfTsKfTsKdmFyIGNyZWF0ZURlbGF5ID0gKHNpZ25hbCkgPT4gewogIGNvbnN0IHBhdXNlID0gY3JlYXRlUGF1c2Uoc2lnbmFsKTsKICByZXR1cm4gKHRpbWVvdXRNcykgPT4gewogICAgcmV0dXJuIHBhdXNlKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXRNcykpKTsKICB9Owp9Owp2YXIgewogIGFzc2lnbgp9ID0gT2JqZWN0Owp2YXIgSU5URVJOQUxfTklMX1RPS0VOID0ge307CnZhciBhbG0gPSAibGlzdGVuZXJNaWRkbGV3YXJlIjsKdmFyIGNyZWF0ZUZvcmsgPSAocGFyZW50QWJvcnRTaWduYWwsIHBhcmVudEJsb2NraW5nUHJvbWlzZXMpID0+IHsKICBjb25zdCBsaW5rQ29udHJvbGxlcnMgPSAoY29udHJvbGxlcikgPT4gYWRkQWJvcnRTaWduYWxMaXN0ZW5lcihwYXJlbnRBYm9ydFNpZ25hbCwgKCkgPT4gYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBwYXJlbnRBYm9ydFNpZ25hbC5yZWFzb24pKTsKICByZXR1cm4gKHRhc2tFeGVjdXRvciwgb3B0cykgPT4gewogICAgYXNzZXJ0RnVuY3Rpb24odGFza0V4ZWN1dG9yLCAidGFza0V4ZWN1dG9yIik7CiAgICBjb25zdCBjaGlsZEFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGxpbmtDb250cm9sbGVycyhjaGlsZEFib3J0Q29udHJvbGxlcik7CiAgICBjb25zdCByZXN1bHQgPSBydW5UYXNrKGFzeW5jICgpID0+IHsKICAgICAgdmFsaWRhdGVBY3RpdmUocGFyZW50QWJvcnRTaWduYWwpOwogICAgICB2YWxpZGF0ZUFjdGl2ZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpOwogICAgICBjb25zdCByZXN1bHQyID0gYXdhaXQgdGFza0V4ZWN1dG9yKHsKICAgICAgICBwYXVzZTogY3JlYXRlUGF1c2UoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICBkZWxheTogY3JlYXRlRGVsYXkoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICBzaWduYWw6IGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbAogICAgICB9KTsKICAgICAgdmFsaWRhdGVBY3RpdmUoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgcmV0dXJuIHJlc3VsdDI7CiAgICB9LCAoKSA9PiBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNoaWxkQWJvcnRDb250cm9sbGVyLCB0YXNrQ29tcGxldGVkKSk7CiAgICBpZiAob3B0cz8uYXV0b0pvaW4pIHsKICAgICAgcGFyZW50QmxvY2tpbmdQcm9taXNlcy5wdXNoKHJlc3VsdC5jYXRjaChub29wMjIpKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHJlc3VsdDogY3JlYXRlUGF1c2UocGFyZW50QWJvcnRTaWduYWwpKHJlc3VsdCksCiAgICAgIGNhbmNlbCgpIHsKICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNoaWxkQWJvcnRDb250cm9sbGVyLCB0YXNrQ2FuY2VsbGVkKTsKICAgICAgfQogICAgfTsKICB9Owp9Owp2YXIgY3JlYXRlVGFrZVBhdHRlcm4gPSAoc3RhcnRMaXN0ZW5pbmcsIHNpZ25hbCkgPT4gewogIGNvbnN0IHRha2UgPSBhc3luYyAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiB7CiAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgbGV0IHVuc3Vic2NyaWJlID0gKCkgPT4gewogICAgfTsKICAgIGNvbnN0IHR1cGxlUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgbGV0IHN0b3BMaXN0ZW5pbmcgPSBzdGFydExpc3RlbmluZyh7CiAgICAgICAgcHJlZGljYXRlLAogICAgICAgIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgICAgICAgIGxpc3RlbmVyQXBpLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICByZXNvbHZlKFthY3Rpb24sIGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGxpc3RlbmVyQXBpLmdldE9yaWdpbmFsU3RhdGUoKV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHVuc3Vic2NyaWJlID0gKCkgPT4gewogICAgICAgIHN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICByZWplY3QoKTsKICAgICAgfTsKICAgIH0pOwogICAgY29uc3QgcHJvbWlzZXMgPSBbdHVwbGVQcm9taXNlXTsKICAgIGlmICh0aW1lb3V0ICE9IG51bGwpIHsKICAgICAgcHJvbWlzZXMucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0LCBudWxsKSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgcmFjZVdpdGhTaWduYWwoc2lnbmFsLCBQcm9taXNlLnJhY2UocHJvbWlzZXMpKTsKICAgICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0gZmluYWxseSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfTsKICByZXR1cm4gKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gY2F0Y2hSZWplY3Rpb24odGFrZShwcmVkaWNhdGUsIHRpbWVvdXQpKTsKfTsKdmFyIGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20gPSAob3B0aW9ucykgPT4gewogIGxldCB7CiAgICB0eXBlLAogICAgYWN0aW9uQ3JlYXRvciwKICAgIG1hdGNoZXIsCiAgICBwcmVkaWNhdGUsCiAgICBlZmZlY3QKICB9ID0gb3B0aW9uczsKICBpZiAodHlwZSkgewogICAgcHJlZGljYXRlID0gY3JlYXRlQWN0aW9uKHR5cGUpLm1hdGNoOwogIH0gZWxzZSBpZiAoYWN0aW9uQ3JlYXRvcikgewogICAgdHlwZSA9IGFjdGlvbkNyZWF0b3IudHlwZTsKICAgIHByZWRpY2F0ZSA9IGFjdGlvbkNyZWF0b3IubWF0Y2g7CiAgfSBlbHNlIGlmIChtYXRjaGVyKSB7CiAgICBwcmVkaWNhdGUgPSBtYXRjaGVyOwogIH0gZWxzZSBpZiAocHJlZGljYXRlKSB7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjEpIDogIkNyZWF0aW5nIG9yIHJlbW92aW5nIGEgbGlzdGVuZXIgcmVxdWlyZXMgb25lIG9mIHRoZSBrbm93biBmaWVsZHMgZm9yIG1hdGNoaW5nIGFuIGFjdGlvbiIpOwogIH0KICBhc3NlcnRGdW5jdGlvbihlZmZlY3QsICJvcHRpb25zLmxpc3RlbmVyIik7CiAgcmV0dXJuIHsKICAgIHByZWRpY2F0ZSwKICAgIHR5cGUsCiAgICBlZmZlY3QKICB9Owp9Owp2YXIgY3JlYXRlTGlzdGVuZXJFbnRyeSA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oKG9wdGlvbnMpID0+IHsKICBjb25zdCB7CiAgICB0eXBlLAogICAgcHJlZGljYXRlLAogICAgZWZmZWN0CiAgfSA9IGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20ob3B0aW9ucyk7CiAgY29uc3QgZW50cnkgPSB7CiAgICBpZDogbmFub2lkKCksCiAgICBlZmZlY3QsCiAgICB0eXBlLAogICAgcHJlZGljYXRlLAogICAgcGVuZGluZzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICAgIHVuc3Vic2NyaWJlOiAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjIpIDogIlVuc3Vic2NyaWJlIG5vdCBpbml0aWFsaXplZCIpOwogICAgfQogIH07CiAgcmV0dXJuIGVudHJ5Owp9LCB7CiAgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVMaXN0ZW5lckVudHJ5Cn0pOwp2YXIgZmluZExpc3RlbmVyRW50cnkgPSAobGlzdGVuZXJNYXAsIG9wdGlvbnMpID0+IHsKICBjb25zdCB7CiAgICB0eXBlLAogICAgZWZmZWN0LAogICAgcHJlZGljYXRlCiAgfSA9IGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20ob3B0aW9ucyk7CiAgcmV0dXJuIEFycmF5LmZyb20obGlzdGVuZXJNYXAudmFsdWVzKCkpLmZpbmQoKGVudHJ5KSA9PiB7CiAgICBjb25zdCBtYXRjaFByZWRpY2F0ZU9yVHlwZSA9IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiA/IGVudHJ5LnR5cGUgPT09IHR5cGUgOiBlbnRyeS5wcmVkaWNhdGUgPT09IHByZWRpY2F0ZTsKICAgIHJldHVybiBtYXRjaFByZWRpY2F0ZU9yVHlwZSAmJiBlbnRyeS5lZmZlY3QgPT09IGVmZmVjdDsKICB9KTsKfTsKdmFyIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyA9IChlbnRyeSkgPT4gewogIGVudHJ5LnBlbmRpbmcuZm9yRWFjaCgoY29udHJvbGxlcikgPT4gewogICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgfSk7Cn07CnZhciBjcmVhdGVDbGVhckxpc3RlbmVyTWlkZGxld2FyZSA9IChsaXN0ZW5lck1hcCwgZXhlY3V0aW5nTGlzdGVuZXJzKSA9PiB7CiAgcmV0dXJuICgpID0+IHsKICAgIGZvciAoY29uc3QgbGlzdGVuZXIyIG9mIGV4ZWN1dGluZ0xpc3RlbmVycy5rZXlzKCkpIHsKICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGxpc3RlbmVyMik7CiAgICB9CiAgICBsaXN0ZW5lck1hcC5jbGVhcigpOwogIH07Cn07CnZhciBzYWZlbHlOb3RpZnlFcnJvciA9IChlcnJvckhhbmRsZXIsIGVycm9yVG9Ob3RpZnksIGVycm9ySW5mbykgPT4gewogIHRyeSB7CiAgICBlcnJvckhhbmRsZXIoZXJyb3JUb05vdGlmeSwgZXJyb3JJbmZvKTsKICB9IGNhdGNoIChlcnJvckhhbmRsZXJFcnJvcikgewogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRocm93IGVycm9ySGFuZGxlckVycm9yOwogICAgfSwgMCk7CiAgfQp9Owp2YXIgYWRkTGlzdGVuZXIgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9hZGRgKSwgewogIHdpdGhUeXBlczogKCkgPT4gYWRkTGlzdGVuZXIKfSk7CnZhciBjbGVhckFsbExpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9yZW1vdmVBbGxgKTsKdmFyIHJlbW92ZUxpc3RlbmVyID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vcmVtb3ZlYCksIHsKICB3aXRoVHlwZXM6ICgpID0+IHJlbW92ZUxpc3RlbmVyCn0pOwp2YXIgZGVmYXVsdEVycm9ySGFuZGxlciA9ICguLi5hcmdzKSA9PiB7CiAgY29uc29sZS5lcnJvcihgJHthbG19L2Vycm9yYCwgLi4uYXJncyk7Cn07CnZhciBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUgPSAobWlkZGxld2FyZU9wdGlvbnMgPSB7fSkgPT4gewogIGNvbnN0IGxpc3RlbmVyTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBleGVjdXRpbmdMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IHRyYWNrRXhlY3V0aW5nTGlzdGVuZXIgPSAoZW50cnkpID0+IHsKICAgIGNvbnN0IGNvdW50ID0gZXhlY3V0aW5nTGlzdGVuZXJzLmdldChlbnRyeSkgPz8gMDsKICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5zZXQoZW50cnksIGNvdW50ICsgMSk7CiAgfTsKICBjb25zdCB1bnRyYWNrRXhlY3V0aW5nTGlzdGVuZXIgPSAoZW50cnkpID0+IHsKICAgIGNvbnN0IGNvdW50ID0gZXhlY3V0aW5nTGlzdGVuZXJzLmdldChlbnRyeSkgPz8gMTsKICAgIGlmIChjb3VudCA9PT0gMSkgewogICAgICBleGVjdXRpbmdMaXN0ZW5lcnMuZGVsZXRlKGVudHJ5KTsKICAgIH0gZWxzZSB7CiAgICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5zZXQoZW50cnksIGNvdW50IC0gMSk7CiAgICB9CiAgfTsKICBjb25zdCB7CiAgICBleHRyYSwKICAgIG9uRXJyb3IgPSBkZWZhdWx0RXJyb3JIYW5kbGVyCiAgfSA9IG1pZGRsZXdhcmVPcHRpb25zOwogIGFzc2VydEZ1bmN0aW9uKG9uRXJyb3IsICJvbkVycm9yIik7CiAgY29uc3QgaW5zZXJ0RW50cnkgPSAoZW50cnkpID0+IHsKICAgIGVudHJ5LnVuc3Vic2NyaWJlID0gKCkgPT4gbGlzdGVuZXJNYXAuZGVsZXRlKGVudHJ5LmlkKTsKICAgIGxpc3RlbmVyTWFwLnNldChlbnRyeS5pZCwgZW50cnkpOwogICAgcmV0dXJuIChjYW5jZWxPcHRpb25zKSA9PiB7CiAgICAgIGVudHJ5LnVuc3Vic2NyaWJlKCk7CiAgICAgIGlmIChjYW5jZWxPcHRpb25zPy5jYW5jZWxBY3RpdmUpIHsKICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMoZW50cnkpOwogICAgICB9CiAgICB9OwogIH07CiAgY29uc3Qgc3RhcnRMaXN0ZW5pbmcgPSAob3B0aW9ucykgPT4gewogICAgY29uc3QgZW50cnkgPSBmaW5kTGlzdGVuZXJFbnRyeShsaXN0ZW5lck1hcCwgb3B0aW9ucykgPz8gY3JlYXRlTGlzdGVuZXJFbnRyeShvcHRpb25zKTsKICAgIHJldHVybiBpbnNlcnRFbnRyeShlbnRyeSk7CiAgfTsKICBhc3NpZ24oc3RhcnRMaXN0ZW5pbmcsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gc3RhcnRMaXN0ZW5pbmcKICB9KTsKICBjb25zdCBzdG9wTGlzdGVuaW5nID0gKG9wdGlvbnMpID0+IHsKICAgIGNvbnN0IGVudHJ5ID0gZmluZExpc3RlbmVyRW50cnkobGlzdGVuZXJNYXAsIG9wdGlvbnMpOwogICAgaWYgKGVudHJ5KSB7CiAgICAgIGVudHJ5LnVuc3Vic2NyaWJlKCk7CiAgICAgIGlmIChvcHRpb25zLmNhbmNlbEFjdGl2ZSkgewogICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhlbnRyeSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAhIWVudHJ5OwogIH07CiAgYXNzaWduKHN0b3BMaXN0ZW5pbmcsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gc3RvcExpc3RlbmluZwogIH0pOwogIGNvbnN0IG5vdGlmeUxpc3RlbmVyID0gYXN5bmMgKGVudHJ5LCBhY3Rpb24sIGFwaSwgZ2V0T3JpZ2luYWxTdGF0ZSkgPT4gewogICAgY29uc3QgaW50ZXJuYWxUYXNrQ29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHRha2UgPSBjcmVhdGVUYWtlUGF0dGVybihzdGFydExpc3RlbmluZywgaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpOwogICAgY29uc3QgYXV0b0pvaW5Qcm9taXNlcyA9IFtdOwogICAgdHJ5IHsKICAgICAgZW50cnkucGVuZGluZy5hZGQoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICAgIHRyYWNrRXhlY3V0aW5nTGlzdGVuZXIoZW50cnkpOwogICAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoZW50cnkuZWZmZWN0KAogICAgICAgIGFjdGlvbiwKICAgICAgICAvLyBVc2UgYXNzaWduKCkgcmF0aGVyIHRoYW4gLi4uIHRvIGF2b2lkIGV4dHJhIGhlbHBlciBmdW5jdGlvbnMgYWRkZWQgdG8gYnVuZGxlCiAgICAgICAgYXNzaWduKHt9LCBhcGksIHsKICAgICAgICAgIGdldE9yaWdpbmFsU3RhdGUsCiAgICAgICAgICBjb25kaXRpb246IChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IHRha2UocHJlZGljYXRlLCB0aW1lb3V0KS50aGVuKEJvb2xlYW4pLAogICAgICAgICAgdGFrZSwKICAgICAgICAgIGRlbGF5OiBjcmVhdGVEZWxheShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgICBwYXVzZTogY3JlYXRlUGF1c2UoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpLAogICAgICAgICAgZXh0cmEsCiAgICAgICAgICBzaWduYWw6IGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsLAogICAgICAgICAgZm9yazogY3JlYXRlRm9yayhpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCwgYXV0b0pvaW5Qcm9taXNlcyksCiAgICAgICAgICB1bnN1YnNjcmliZTogZW50cnkudW5zdWJzY3JpYmUsCiAgICAgICAgICBzdWJzY3JpYmU6ICgpID0+IHsKICAgICAgICAgICAgbGlzdGVuZXJNYXAuc2V0KGVudHJ5LmlkLCBlbnRyeSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzOiAoKSA9PiB7CiAgICAgICAgICAgIGVudHJ5LnBlbmRpbmcuZm9yRWFjaCgoY29udHJvbGxlciwgXywgc2V0MykgPT4gewogICAgICAgICAgICAgIGlmIChjb250cm9sbGVyICE9PSBpbnRlcm5hbFRhc2tDb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICAgICAgICAgICAgICAgIHNldDMuZGVsZXRlKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsOiAoKSA9PiB7CiAgICAgICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oaW50ZXJuYWxUYXNrQ29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogICAgICAgICAgICBlbnRyeS5wZW5kaW5nLmRlbGV0ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aHJvd0lmQ2FuY2VsbGVkOiAoKSA9PiB7CiAgICAgICAgICAgIHZhbGlkYXRlQWN0aXZlKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICApKTsKICAgIH0gY2F0Y2ggKGxpc3RlbmVyRXJyb3IpIHsKICAgICAgaWYgKCEobGlzdGVuZXJFcnJvciBpbnN0YW5jZW9mIFRhc2tBYm9ydEVycm9yKSkgewogICAgICAgIHNhZmVseU5vdGlmeUVycm9yKG9uRXJyb3IsIGxpc3RlbmVyRXJyb3IsIHsKICAgICAgICAgIHJhaXNlZEJ5OiAiZWZmZWN0IgogICAgICAgIH0pOwogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbChhdXRvSm9pblByb21pc2VzKTsKICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihpbnRlcm5hbFRhc2tDb250cm9sbGVyLCBsaXN0ZW5lckNvbXBsZXRlZCk7CiAgICAgIHVudHJhY2tFeGVjdXRpbmdMaXN0ZW5lcihlbnRyeSk7CiAgICAgIGVudHJ5LnBlbmRpbmcuZGVsZXRlKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgfQogIH07CiAgY29uc3QgY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUgPSBjcmVhdGVDbGVhckxpc3RlbmVyTWlkZGxld2FyZShsaXN0ZW5lck1hcCwgZXhlY3V0aW5nTGlzdGVuZXJzKTsKICBjb25zdCBtaWRkbGV3YXJlID0gKGFwaSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmICghaXNBY3Rpb24oYWN0aW9uKSkgewogICAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogICAgfQogICAgaWYgKGFkZExpc3RlbmVyLm1hdGNoKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIHN0YXJ0TGlzdGVuaW5nKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0KICAgIGlmIChjbGVhckFsbExpc3RlbmVycy5tYXRjaChhY3Rpb24pKSB7CiAgICAgIGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChyZW1vdmVMaXN0ZW5lci5tYXRjaChhY3Rpb24pKSB7CiAgICAgIHJldHVybiBzdG9wTGlzdGVuaW5nKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0KICAgIGxldCBvcmlnaW5hbFN0YXRlID0gYXBpLmdldFN0YXRlKCk7CiAgICBjb25zdCBnZXRPcmlnaW5hbFN0YXRlID0gKCkgPT4gewogICAgICBpZiAob3JpZ2luYWxTdGF0ZSA9PT0gSU5URVJOQUxfTklMX1RPS0VOKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMykgOiBgJHthbG19OiBnZXRPcmlnaW5hbFN0YXRlIGNhbiBvbmx5IGJlIGNhbGxlZCBzeW5jaHJvbm91c2x5YCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9yaWdpbmFsU3RhdGU7CiAgICB9OwogICAgbGV0IHJlc3VsdDsKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IG5leHQoYWN0aW9uKTsKICAgICAgaWYgKGxpc3RlbmVyTWFwLnNpemUgPiAwKSB7CiAgICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gYXBpLmdldFN0YXRlKCk7CiAgICAgICAgY29uc3QgbGlzdGVuZXJFbnRyaWVzID0gQXJyYXkuZnJvbShsaXN0ZW5lck1hcC52YWx1ZXMoKSk7CiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBsaXN0ZW5lckVudHJpZXMpIHsKICAgICAgICAgIGxldCBydW5MaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcnVuTGlzdGVuZXIgPSBlbnRyeS5wcmVkaWNhdGUoYWN0aW9uLCBjdXJyZW50U3RhdGUsIG9yaWdpbmFsU3RhdGUpOwogICAgICAgICAgfSBjYXRjaCAocHJlZGljYXRlRXJyb3IpIHsKICAgICAgICAgICAgcnVuTGlzdGVuZXIgPSBmYWxzZTsKICAgICAgICAgICAgc2FmZWx5Tm90aWZ5RXJyb3Iob25FcnJvciwgcHJlZGljYXRlRXJyb3IsIHsKICAgICAgICAgICAgICByYWlzZWRCeTogInByZWRpY2F0ZSIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJ1bkxpc3RlbmVyKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbm90aWZ5TGlzdGVuZXIoZW50cnksIGFjdGlvbiwgYXBpLCBnZXRPcmlnaW5hbFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIG9yaWdpbmFsU3RhdGUgPSBJTlRFUk5BTF9OSUxfVE9LRU47CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgcmV0dXJuIHsKICAgIG1pZGRsZXdhcmUsCiAgICBzdGFydExpc3RlbmluZywKICAgIHN0b3BMaXN0ZW5pbmcsCiAgICBjbGVhckxpc3RlbmVyczogY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUKICB9Owp9Owp2YXIgT1JJR0lOQUxfU1RBVEUgPSBTeW1ib2wuZm9yKCJydGstc3RhdGUtcHJveHktb3JpZ2luYWwiKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2xheW91dFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUgPSB7CiAgbGF5b3V0VHlwZTogImhvcml6b250YWwiLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBtYXJnaW46IHsKICAgIHRvcDogNSwKICAgIHJpZ2h0OiA1LAogICAgYm90dG9tOiA1LAogICAgbGVmdDogNQogIH0sCiAgc2NhbGU6IDEKfTsKdmFyIGNoYXJ0TGF5b3V0U2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNoYXJ0TGF5b3V0IiwKICBpbml0aWFsU3RhdGUsCiAgcmVkdWNlcnM6IHsKICAgIHNldExheW91dChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmxheW91dFR5cGUgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRDaGFydFNpemUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS53aWR0aCA9IGFjdGlvbi5wYXlsb2FkLndpZHRoOwogICAgICBzdGF0ZS5oZWlnaHQgPSBhY3Rpb24ucGF5bG9hZC5oZWlnaHQ7CiAgICB9LAogICAgc2V0TWFyZ2luKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZCR0b3AsIF9hY3Rpb24kcGF5bG9hZCRyaWdodCwgX2FjdGlvbiRwYXlsb2FkJGJvdHRvLCBfYWN0aW9uJHBheWxvYWQkbGVmdDsKICAgICAgc3RhdGUubWFyZ2luLnRvcCA9IChfYWN0aW9uJHBheWxvYWQkdG9wID0gYWN0aW9uLnBheWxvYWQudG9wKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkdG9wICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkdG9wIDogMDsKICAgICAgc3RhdGUubWFyZ2luLnJpZ2h0ID0gKF9hY3Rpb24kcGF5bG9hZCRyaWdodCA9IGFjdGlvbi5wYXlsb2FkLnJpZ2h0KSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkcmlnaHQgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRyaWdodCA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5ib3R0b20gPSAoX2FjdGlvbiRwYXlsb2FkJGJvdHRvID0gYWN0aW9uLnBheWxvYWQuYm90dG9tKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkYm90dG8gIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRib3R0byA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5sZWZ0ID0gKF9hY3Rpb24kcGF5bG9hZCRsZWZ0ID0gYWN0aW9uLnBheWxvYWQubGVmdCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGxlZnQgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRsZWZ0IDogMDsKICAgIH0sCiAgICBzZXRTY2FsZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNjYWxlID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRNYXJnaW4sCiAgc2V0TGF5b3V0LAogIHNldENoYXJ0U2l6ZSwKICBzZXRTY2FsZQp9ID0gY2hhcnRMYXlvdXRTbGljZS5hY3Rpb25zOwp2YXIgY2hhcnRMYXlvdXRSZWR1Y2VyID0gY2hhcnRMYXlvdXRTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DaGFydFV0aWxzLmpzCnZhciBpbXBvcnRfc29ydEJ5MiA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgaW1wb3J0X2dldDIgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0U2xpY2VkLmpzCmZ1bmN0aW9uIGdldFNsaWNlZChhcnIsIHN0YXJ0SW5kZXgsIGVuZEluZGV4KSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnI7CiAgfQogIGlmIChhcnIgJiYgc3RhcnRJbmRleCArIGVuZEluZGV4ICE9PSAwKSB7CiAgICByZXR1cm4gYXJyLnNsaWNlKHN0YXJ0SW5kZXgsIGVuZEluZGV4ICsgMSk7CiAgfQogIHJldHVybiBhcnI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2hhcnRVdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRWYWx1ZUJ5RGF0YUtleShvYmosIGRhdGFLZXksIGRlZmF1bHRWYWx1ZSkgewogIGlmIChpc051bGxpc2gob2JqKSB8fCBpc051bGxpc2goZGF0YUtleSkpIHsKICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgfQogIGlmIChpc051bU9yU3RyKGRhdGFLZXkpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9nZXQyLmRlZmF1bHQpKG9iaiwgZGF0YUtleSwgZGVmYXVsdFZhbHVlKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhS2V5ID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZGF0YUtleShvYmopOwogIH0KICByZXR1cm4gZGVmYXVsdFZhbHVlOwp9CnZhciBhcHBlbmRPZmZzZXRPZkxlZ2VuZCA9IChvZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKSA9PiB7CiAgaWYgKGxlZ2VuZFNldHRpbmdzICYmIGxlZ2VuZFNpemUpIHsKICAgIHZhciB7CiAgICAgIHdpZHRoOiBib3hXaWR0aCwKICAgICAgaGVpZ2h0OiBib3hIZWlnaHQKICAgIH0gPSBsZWdlbmRTaXplOwogICAgdmFyIHsKICAgICAgYWxpZ24sCiAgICAgIHZlcnRpY2FsQWxpZ24sCiAgICAgIGxheW91dAogICAgfSA9IGxlZ2VuZFNldHRpbmdzOwogICAgaWYgKChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgfHwgbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgdmVydGljYWxBbGlnbiA9PT0gIm1pZGRsZSIpICYmIGFsaWduICE9PSAiY2VudGVyIiAmJiBpc051bWJlcihvZmZzZXRbYWxpZ25dKSkgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIG9mZnNldCksIHt9LCB7CiAgICAgICAgW2FsaWduXTogb2Zmc2V0W2FsaWduXSArIChib3hXaWR0aCB8fCAwKQogICAgICB9KTsKICAgIH0KICAgIGlmICgobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiICYmIGFsaWduID09PSAiY2VudGVyIikgJiYgdmVydGljYWxBbGlnbiAhPT0gIm1pZGRsZSIgJiYgaXNOdW1iZXIob2Zmc2V0W3ZlcnRpY2FsQWxpZ25dKSkgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIG9mZnNldCksIHt9LCB7CiAgICAgICAgW3ZlcnRpY2FsQWxpZ25dOiBvZmZzZXRbdmVydGljYWxBbGlnbl0gKyAoYm94SGVpZ2h0IHx8IDApCiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gb2Zmc2V0Owp9Owp2YXIgaXNDYXRlZ29yaWNhbEF4aXMgPSAobGF5b3V0LCBheGlzVHlwZSkgPT4gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgYXhpc1R5cGUgPT09ICJ4QXhpcyIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiICYmIGF4aXNUeXBlID09PSAieUF4aXMiIHx8IGxheW91dCA9PT0gImNlbnRyaWMiICYmIGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiB8fCBsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAicmFkaXVzQXhpcyI7CnZhciBnZXRDb29yZGluYXRlc09mR3JpZCA9ICh0aWNrczIsIG1pblZhbHVlLCBtYXhWYWx1ZSwgc3luY1dpdGhUaWNrcykgPT4gewogIGlmIChzeW5jV2l0aFRpY2tzKSB7CiAgICByZXR1cm4gdGlja3MyLm1hcCgoZW50cnkpID0+IGVudHJ5LmNvb3JkaW5hdGUpOwogIH0KICB2YXIgaGFzTWluLCBoYXNNYXg7CiAgdmFyIHZhbHVlcyA9IHRpY2tzMi5tYXAoKGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkuY29vcmRpbmF0ZSA9PT0gbWluVmFsdWUpIHsKICAgICAgaGFzTWluID0gdHJ1ZTsKICAgIH0KICAgIGlmIChlbnRyeS5jb29yZGluYXRlID09PSBtYXhWYWx1ZSkgewogICAgICBoYXNNYXggPSB0cnVlOwogICAgfQogICAgcmV0dXJuIGVudHJ5LmNvb3JkaW5hdGU7CiAgfSk7CiAgaWYgKCFoYXNNaW4pIHsKICAgIHZhbHVlcy5wdXNoKG1pblZhbHVlKTsKICB9CiAgaWYgKCFoYXNNYXgpIHsKICAgIHZhbHVlcy5wdXNoKG1heFZhbHVlKTsKICB9CiAgcmV0dXJuIHZhbHVlczsKfTsKdmFyIGdldFRpY2tzT2ZBeGlzID0gKGF4aXMsIGlzR3JpZCwgaXNBbGwpID0+IHsKICBpZiAoIWF4aXMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZHVwbGljYXRlRG9tYWluLAogICAgdHlwZSwKICAgIHJhbmdlOiByYW5nZTQsCiAgICBzY2FsZSwKICAgIHJlYWxTY2FsZVR5cGUsCiAgICBpc0NhdGVnb3JpY2FsLAogICAgY2F0ZWdvcmljYWxEb21haW4sCiAgICB0aWNrQ291bnQsCiAgICB0aWNrczogdGlja3MyLAogICAgbmljZVRpY2tzLAogICAgYXhpc1R5cGUKICB9ID0gYXhpczsKICBpZiAoIXNjYWxlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSAoaXNHcmlkIHx8IGlzQWxsKSAmJiB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAmJiByYW5nZTQubGVuZ3RoID49IDIgPyBtYXRoU2lnbihyYW5nZTRbMF0gLSByYW5nZTRbMV0pICogMiAqIG9mZnNldCA6IG9mZnNldDsKICBpZiAoaXNHcmlkICYmICh0aWNrczIgfHwgbmljZVRpY2tzKSkgewogICAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgbmljZVRpY2tzIHx8IFtdKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQsCiAgICAgICAgaW5kZXgKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gIWlzTmFuKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIGlmIChzY2FsZS50aWNrcyAmJiAhaXNBbGwgJiYgdGlja0NvdW50ICE9IG51bGwpIHsKICAgIHJldHVybiBzY2FsZS50aWNrcyh0aWNrQ291bnQpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0LAogICAgICBpbmRleAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBFUFMyID0gMWUtNDsKdmFyIGNoZWNrRG9tYWluT2ZTY2FsZSA9IChzY2FsZSkgPT4gewogIHZhciBkb21haW4gPSBzY2FsZS5kb21haW4oKTsKICBpZiAoIWRvbWFpbiB8fCBkb21haW4ubGVuZ3RoIDw9IDIpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGxlbiA9IGRvbWFpbi5sZW5ndGg7CiAgdmFyIHJhbmdlNCA9IHNjYWxlLnJhbmdlKCk7CiAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4ocmFuZ2U0WzBdLCByYW5nZTRbMV0pIC0gRVBTMjsKICB2YXIgbWF4VmFsdWUgPSBNYXRoLm1heChyYW5nZTRbMF0sIHJhbmdlNFsxXSkgKyBFUFMyOwogIHZhciBmaXJzdCA9IHNjYWxlKGRvbWFpblswXSk7CiAgdmFyIGxhc3QyID0gc2NhbGUoZG9tYWluW2xlbiAtIDFdKTsKICBpZiAoZmlyc3QgPCBtaW5WYWx1ZSB8fCBmaXJzdCA+IG1heFZhbHVlIHx8IGxhc3QyIDwgbWluVmFsdWUgfHwgbGFzdDIgPiBtYXhWYWx1ZSkgewogICAgc2NhbGUuZG9tYWluKFtkb21haW5bMF0sIGRvbWFpbltsZW4gLSAxXV0pOwogIH0KfTsKdmFyIG9mZnNldFNpZ24gPSAoc2VyaWVzKSA9PiB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoOwogIGlmIChuIDw9IDApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICh2YXIgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICB2YXIgcG9zaXRpdmUgPSAwOwogICAgdmFyIG5lZ2F0aXZlID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlzTmFuKHNlcmllc1tpXVtqXVsxXSkgPyBzZXJpZXNbaV1bal1bMF0gOiBzZXJpZXNbaV1bal1bMV07CiAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gcG9zaXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gcG9zaXRpdmUgKyB2YWx1ZTsKICAgICAgICBwb3NpdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBuZWdhdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBuZWdhdGl2ZSArIHZhbHVlOwogICAgICAgIG5lZ2F0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgb2Zmc2V0UG9zaXRpdmUgPSAoc2VyaWVzKSA9PiB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoOwogIGlmIChuIDw9IDApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICh2YXIgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICB2YXIgcG9zaXRpdmUgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgdmFyIHZhbHVlID0gaXNOYW4oc2VyaWVzW2ldW2pdWzFdKSA/IHNlcmllc1tpXVtqXVswXSA6IHNlcmllc1tpXVtqXVsxXTsKICAgICAgaWYgKHZhbHVlID49IDApIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBwb3NpdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBwb3NpdGl2ZSArIHZhbHVlOwogICAgICAgIHBvc2l0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9IGVsc2UgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IDA7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gMDsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIFNUQUNLX09GRlNFVF9NQVAgPSB7CiAgc2lnbjogb2Zmc2V0U2lnbiwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgZXhwYW5kOiBleHBhbmRfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgbm9uZTogbm9uZV9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICBzaWxob3VldHRlOiBzaWxob3VldHRlX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIHdpZ2dsZTogd2lnZ2xlX2RlZmF1bHQsCiAgcG9zaXRpdmU6IG9mZnNldFBvc2l0aXZlCn07CnZhciBnZXRTdGFja2VkRGF0YSA9IChkYXRhLCBkYXRhS2V5cywgb2Zmc2V0VHlwZSkgPT4gewogIHZhciBvZmZzZXRBY2Nlc3NvciA9IFNUQUNLX09GRlNFVF9NQVBbb2Zmc2V0VHlwZV07CiAgdmFyIHN0YWNrID0gc3RhY2tfZGVmYXVsdCgpLmtleXMoZGF0YUtleXMpLnZhbHVlKChkLCBrZXkpID0+IE51bWJlcihnZXRWYWx1ZUJ5RGF0YUtleShkLCBrZXksIDApKSkub3JkZXIobm9uZV9kZWZhdWx0Mikub2Zmc2V0KG9mZnNldEFjY2Vzc29yKTsKICByZXR1cm4gc3RhY2soZGF0YSk7Cn07CmZ1bmN0aW9uIGdldE5vcm1hbGl6ZWRTdGFja0lkKHB1YmxpY1N0YWNrSWQpIHsKICByZXR1cm4gcHVibGljU3RhY2tJZCA9PSBudWxsID8gdm9pZCAwIDogU3RyaW5nKHB1YmxpY1N0YWNrSWQpOwp9CmZ1bmN0aW9uIGdldENhdGVDb29yZGluYXRlT2ZMaW5lKF9yZWYyKSB7CiAgdmFyIHsKICAgIGF4aXMsCiAgICB0aWNrczogdGlja3MyLAogICAgYmFuZFNpemUsCiAgICBlbnRyeSwKICAgIGluZGV4LAogICAgZGF0YUtleQogIH0gPSBfcmVmMjsKICBpZiAoYXhpcy50eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICBpZiAoIWF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgYXhpcy5kYXRhS2V5ICYmICFpc051bGxpc2goZW50cnlbYXhpcy5kYXRhS2V5XSkpIHsKICAgICAgdmFyIG1hdGNoZWRUaWNrID0gZmluZEVudHJ5SW5BcnJheSh0aWNrczIsICJ2YWx1ZSIsIGVudHJ5W2F4aXMuZGF0YUtleV0pOwogICAgICBpZiAobWF0Y2hlZFRpY2spIHsKICAgICAgICByZXR1cm4gbWF0Y2hlZFRpY2suY29vcmRpbmF0ZSArIGJhbmRTaXplIC8gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRpY2tzMltpbmRleF0gPyB0aWNrczJbaW5kZXhdLmNvb3JkaW5hdGUgKyBiYW5kU2l6ZSAvIDIgOiBudWxsOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgIWlzTnVsbGlzaChkYXRhS2V5KSA/IGRhdGFLZXkgOiBheGlzLmRhdGFLZXkpOwogIHJldHVybiAhaXNOdWxsaXNoKHZhbHVlKSA/IGF4aXMuc2NhbGUodmFsdWUpIDogbnVsbDsKfQp2YXIgZ2V0RG9tYWluT2ZTaW5nbGUgPSAoZGF0YSkgPT4gewogIHZhciBmbGF0ID0gZGF0YS5mbGF0KDIpLmZpbHRlcihpc051bWJlcik7CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5mbGF0KSwgTWF0aC5tYXgoLi4uZmxhdCldOwp9Owp2YXIgbWFrZURvbWFpbkZpbml0ZSA9IChkb21haW4pID0+IHsKICByZXR1cm4gW2RvbWFpblswXSA9PT0gSW5maW5pdHkgPyAwIDogZG9tYWluWzBdLCBkb21haW5bMV0gPT09IC1JbmZpbml0eSA/IDAgOiBkb21haW5bMV1dOwp9Owp2YXIgZ2V0RG9tYWluT2ZTdGFja0dyb3VwcyA9IChzdGFja0dyb3Vwcywgc3RhcnRJbmRleCwgZW5kSW5kZXgpID0+IHsKICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIG1ha2VEb21haW5GaW5pdGUoT2JqZWN0LmtleXMoc3RhY2tHcm91cHMpLnJlZHVjZSgocmVzdWx0LCBzdGFja0lkKSA9PiB7CiAgICB2YXIgZ3JvdXAgPSBzdGFja0dyb3Vwc1tzdGFja0lkXTsKICAgIHZhciB7CiAgICAgIHN0YWNrZWREYXRhCiAgICB9ID0gZ3JvdXA7CiAgICB2YXIgZG9tYWluID0gc3RhY2tlZERhdGEucmVkdWNlKChyZXMsIGVudHJ5KSA9PiB7CiAgICAgIHZhciBzbGljZWQgPSBnZXRTbGljZWQoZW50cnksIHN0YXJ0SW5kZXgsIGVuZEluZGV4KTsKICAgICAgdmFyIHMgPSBnZXREb21haW5PZlNpbmdsZShzbGljZWQpOwogICAgICByZXR1cm4gW01hdGgubWluKHJlc1swXSwgc1swXSksIE1hdGgubWF4KHJlc1sxXSwgc1sxXSldOwogICAgfSwgW0luZmluaXR5LCAtSW5maW5pdHldKTsKICAgIHJldHVybiBbTWF0aC5taW4oZG9tYWluWzBdLCByZXN1bHRbMF0pLCBNYXRoLm1heChkb21haW5bMV0sIHJlc3VsdFsxXSldOwogIH0sIFtJbmZpbml0eSwgLUluZmluaXR5XSkpOwp9Owp2YXIgTUlOX1ZBTFVFX1JFRyA9IC9eZGF0YU1pbltcc10qLVtcc10qKFswLTldKyhbLl17MX1bMC05XSspezAsMX0pJC87CnZhciBNQVhfVkFMVUVfUkVHID0gL15kYXRhTWF4W1xzXSpcK1tcc10qKFswLTldKyhbLl17MX1bMC05XSspezAsMX0pJC87CnZhciBnZXRCYW5kU2l6ZU9mQXhpcyA9IChheGlzLCB0aWNrczIsIGlzQmFyKSA9PiB7CiAgaWYgKGF4aXMgJiYgYXhpcy5zY2FsZSAmJiBheGlzLnNjYWxlLmJhbmR3aWR0aCkgewogICAgdmFyIGJhbmRXaWR0aCA9IGF4aXMuc2NhbGUuYmFuZHdpZHRoKCk7CiAgICBpZiAoIWlzQmFyIHx8IGJhbmRXaWR0aCA+IDApIHsKICAgICAgcmV0dXJuIGJhbmRXaWR0aDsKICAgIH0KICB9CiAgaWYgKGF4aXMgJiYgdGlja3MyICYmIHRpY2tzMi5sZW5ndGggPj0gMikgewogICAgdmFyIG9yZGVyZWRUaWNrcyA9ICgwLCBpbXBvcnRfc29ydEJ5Mi5kZWZhdWx0KSh0aWNrczIsIChvKSA9PiBvLmNvb3JkaW5hdGUpOwogICAgdmFyIGJhbmRTaXplID0gSW5maW5pdHk7CiAgICBmb3IgKHZhciBpID0gMSwgbGVuID0gb3JkZXJlZFRpY2tzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBjdXIgPSBvcmRlcmVkVGlja3NbaV07CiAgICAgIHZhciBwcmV2ID0gb3JkZXJlZFRpY2tzW2kgLSAxXTsKICAgICAgYmFuZFNpemUgPSBNYXRoLm1pbigoY3VyLmNvb3JkaW5hdGUgfHwgMCkgLSAocHJldi5jb29yZGluYXRlIHx8IDApLCBiYW5kU2l6ZSk7CiAgICB9CiAgICByZXR1cm4gYmFuZFNpemUgPT09IEluZmluaXR5ID8gMCA6IGJhbmRTaXplOwogIH0KICByZXR1cm4gaXNCYXIgPyB2b2lkIDAgOiAwOwp9OwpmdW5jdGlvbiBnZXRUb29sdGlwRW50cnkoX3JlZjQpIHsKICB2YXIgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgICBkYXRhS2V5LAogICAgcGF5bG9hZCwKICAgIHZhbHVlLAogICAgbmFtZQogIH0gPSBfcmVmNDsKICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIHRvb2x0aXBFbnRyeVNldHRpbmdzKSwge30sIHsKICAgIGRhdGFLZXksCiAgICBwYXlsb2FkLAogICAgdmFsdWUsCiAgICBuYW1lCiAgfSk7Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWVGcm9tSXRlbSwgZGF0YUtleSkgewogIGlmIChuYW1lRnJvbUl0ZW0pIHsKICAgIHJldHVybiBTdHJpbmcobmFtZUZyb21JdGVtKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhS2V5ID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRhdGFLZXk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KdmFyIGNhbGN1bGF0ZUNhcnRlc2lhblRvb2x0aXBQb3MgPSAoY29vcmRpbmF0ZSwgbGF5b3V0KSA9PiB7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gY29vcmRpbmF0ZS5jaGFydFg7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBjb29yZGluYXRlLmNoYXJ0WTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIGNhbGN1bGF0ZVBvbGFyVG9vbHRpcFBvcyA9IChyYW5nZU9iaiwgbGF5b3V0KSA9PiB7CiAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICByZXR1cm4gcmFuZ2VPYmouYW5nbGU7CiAgfQogIHJldHVybiByYW5nZU9iai5yYWRpdXM7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29udGFpbmVyU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RDaGFydFdpZHRoID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQud2lkdGg7CnZhciBzZWxlY3RDaGFydEhlaWdodCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmhlaWdodDsKdmFyIHNlbGVjdENvbnRhaW5lclNjYWxlID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQuc2NhbGU7CnZhciBzZWxlY3RNYXJnaW4gPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5tYXJnaW47CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0QWxsQXhlcy5qcwp2YXIgc2VsZWN0QWxsWEF4ZXMgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLmNhcnRlc2lhbkF4aXMueEF4aXMsICh4QXhpc01hcCkgPT4gewogIHJldHVybiBPYmplY3QudmFsdWVzKHhBeGlzTWFwKTsKfSk7CnZhciBzZWxlY3RBbGxZQXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuY2FydGVzaWFuQXhpcy55QXhpcywgKHlBeGlzTWFwKSA9PiB7CiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoeUF4aXNNYXApOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ29uc3RhbnRzLmpzCnZhciBEQVRBX0lURU1fSU5ERVhfQVRUUklCVVRFX05BTUUgPSAiZGF0YS1yZWNoYXJ0cy1pdGVtLWluZGV4IjsKdmFyIERBVEFfSVRFTV9EQVRBS0VZX0FUVFJJQlVURV9OQU1FID0gImRhdGEtcmVjaGFydHMtaXRlbS1kYXRhLWtleSI7CnZhciBERUZBVUxUX1lfQVhJU19XSURUSCA9IDYwOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwuanMKZnVuY3Rpb24gb3duS2V5czMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlbGVjdEJydXNoSGVpZ2h0ID0gKHN0YXRlKSA9PiBzdGF0ZS5icnVzaC5oZWlnaHQ7CmZ1bmN0aW9uIHNlbGVjdExlZnRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgdmFyIHdpZHRoID0gdHlwZW9mIGVudHJ5LndpZHRoID09PSAibnVtYmVyIiA/IGVudHJ5LndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgICAgIHJldHVybiByZXN1bHQgKyB3aWR0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KZnVuY3Rpb24gc2VsZWN0UmlnaHRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHZhciB3aWR0aCA9IHR5cGVvZiBlbnRyeS53aWR0aCA9PT0gIm51bWJlciIgPyBlbnRyeS53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogICAgICByZXR1cm4gcmVzdWx0ICsgd2lkdGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdFRvcEF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdEJvdHRvbUF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CnZhciBzZWxlY3RDaGFydE9mZnNldEludGVybmFsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RNYXJnaW4sIHNlbGVjdEJydXNoSGVpZ2h0LCBzZWxlY3RMZWZ0QXhlc09mZnNldCwgc2VsZWN0UmlnaHRBeGVzT2Zmc2V0LCBzZWxlY3RUb3BBeGVzT2Zmc2V0LCBzZWxlY3RCb3R0b21BeGVzT2Zmc2V0LCBzZWxlY3RMZWdlbmRTZXR0aW5ncywgc2VsZWN0TGVnZW5kU2l6ZV0sIChjaGFydFdpZHRoLCBjaGFydEhlaWdodCwgbWFyZ2luLCBicnVzaEhlaWdodCwgbGVmdEF4ZXNPZmZzZXQsIHJpZ2h0QXhlc09mZnNldCwgdG9wQXhlc09mZnNldCwgYm90dG9tQXhlc09mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpID0+IHsKICB2YXIgb2Zmc2V0SCA9IHsKICAgIGxlZnQ6IChtYXJnaW4ubGVmdCB8fCAwKSArIGxlZnRBeGVzT2Zmc2V0LAogICAgcmlnaHQ6IChtYXJnaW4ucmlnaHQgfHwgMCkgKyByaWdodEF4ZXNPZmZzZXQKICB9OwogIHZhciBvZmZzZXRWID0gewogICAgdG9wOiAobWFyZ2luLnRvcCB8fCAwKSArIHRvcEF4ZXNPZmZzZXQsCiAgICBib3R0b206IChtYXJnaW4uYm90dG9tIHx8IDApICsgYm90dG9tQXhlc09mZnNldAogIH07CiAgdmFyIG9mZnNldCA9IF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHt9LCBvZmZzZXRWKSwgb2Zmc2V0SCk7CiAgdmFyIGJydXNoQm90dG9tID0gb2Zmc2V0LmJvdHRvbTsKICBvZmZzZXQuYm90dG9tICs9IGJydXNoSGVpZ2h0OwogIG9mZnNldCA9IGFwcGVuZE9mZnNldE9mTGVnZW5kKG9mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpOwogIHZhciBvZmZzZXRXaWR0aCA9IGNoYXJ0V2lkdGggLSBvZmZzZXQubGVmdCAtIG9mZnNldC5yaWdodDsKICB2YXIgb2Zmc2V0SGVpZ2h0ID0gY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbTsKICByZXR1cm4gX29iamVjdFNwcmVhZDMoX29iamVjdFNwcmVhZDMoewogICAgYnJ1c2hCb3R0b20KICB9LCBvZmZzZXQpLCB7fSwgewogICAgLy8gbmV2ZXIgcmV0dXJuIG5lZ2F0aXZlIHZhbHVlcyBmb3IgaGVpZ2h0IGFuZCB3aWR0aAogICAgd2lkdGg6IE1hdGgubWF4KG9mZnNldFdpZHRoLCAwKSwKICAgIGhlaWdodDogTWF0aC5tYXgob2Zmc2V0SGVpZ2h0LCAwKQogIH0pOwp9KTsKdmFyIHNlbGVjdENoYXJ0Vmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIChvZmZzZXQpID0+ICh7CiAgeDogb2Zmc2V0LmxlZnQsCiAgeTogb2Zmc2V0LnRvcCwKICB3aWR0aDogb2Zmc2V0LndpZHRoLAogIGhlaWdodDogb2Zmc2V0LmhlaWdodAp9KSk7CnZhciBzZWxlY3RBeGlzVmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCAod2lkdGgsIGhlaWdodCkgPT4gKHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGgsCiAgaGVpZ2h0Cn0pKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUGFub3JhbWFDb250ZXh0LmpzCnZhciBSZWFjdDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFBhbm9yYW1hQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTEuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VJc1Bhbm9yYW1hID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDExLnVzZUNvbnRleHQpKFBhbm9yYW1hQ29udGV4dCkgIT0gbnVsbDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9icnVzaFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QnJ1c2hTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUuYnJ1c2g7CnZhciBzZWxlY3RCcnVzaERpbWVuc2lvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QnJ1c2hTZXR0aW5ncywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0TWFyZ2luXSwgKGJydXNoU2V0dGluZ3MsIG9mZnNldCwgbWFyZ2luKSA9PiAoewogIGhlaWdodDogYnJ1c2hTZXR0aW5ncy5oZWlnaHQsCiAgeDogaXNOdW1iZXIoYnJ1c2hTZXR0aW5ncy54KSA/IGJydXNoU2V0dGluZ3MueCA6IG9mZnNldC5sZWZ0LAogIHk6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3MueSkgPyBicnVzaFNldHRpbmdzLnkgOiBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCArIG9mZnNldC5icnVzaEJvdHRvbSAtICgobWFyZ2luID09PSBudWxsIHx8IG1hcmdpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogbWFyZ2luLmJvdHRvbSkgfHwgMCksCiAgd2lkdGg6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3Mud2lkdGgpID8gYnJ1c2hTZXR0aW5ncy53aWR0aCA6IG9mZnNldC53aWR0aAp9KSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwp2YXIgUmVhY3Q0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfdGhyb3R0bGUgPSBfX3RvRVNNKHJlcXVpcmVfdGhyb3R0bGUyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Mb2dVdGlscy5qcwp2YXIgaXNEZXYgPSB0cnVlOwp2YXIgd2FybiA9IGZ1bmN0aW9uIHdhcm4yKGNvbmRpdGlvbiwgZm9ybWF0MikgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAyID8gX2xlbiAtIDIgOiAwKSwgX2tleSA9IDI7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGFyZ3NbX2tleSAtIDJdID0gYXJndW1lbnRzW19rZXldOwogIH0KICBpZiAoaXNEZXYgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUud2FybikgewogICAgaWYgKGZvcm1hdDIgPT09IHZvaWQgMCkgewogICAgICBjb25zb2xlLndhcm4oIkxvZ1V0aWxzIHJlcXVpcmVzIGFuIGVycm9yIG1lc3NhZ2UgYXJndW1lbnQiKTsKICAgIH0KICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgIGlmIChmb3JtYXQyID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLndhcm4oIk1pbmlmaWVkIGV4Y2VwdGlvbiBvY2N1cnJlZDsgdXNlIHRoZSBub24tbWluaWZpZWQgZGV2IGVudmlyb25tZW50IGZvciB0aGUgZnVsbCBlcnJvciBtZXNzYWdlIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGFyZ0luZGV4ID0gMDsKICAgICAgICBjb25zb2xlLndhcm4oZm9ybWF0Mi5yZXBsYWNlKC8lcy9nLCAoKSA9PiBhcmdzW2FyZ0luZGV4KytdKSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvcmVzcG9uc2l2ZUNvbnRhaW5lclV0aWxzLmpzCnZhciBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnMgPSAoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCwgcHJvcHMpID0+IHsKICB2YXIgewogICAgd2lkdGggPSAiMTAwJSIsCiAgICBoZWlnaHQgPSAiMTAwJSIsCiAgICBhc3BlY3QsCiAgICBtYXhIZWlnaHQKICB9ID0gcHJvcHM7CiAgdmFyIGNhbGN1bGF0ZWRXaWR0aCA9IGlzUGVyY2VudCh3aWR0aCkgPyBjb250YWluZXJXaWR0aCA6IE51bWJlcih3aWR0aCk7CiAgdmFyIGNhbGN1bGF0ZWRIZWlnaHQgPSBpc1BlcmNlbnQoaGVpZ2h0KSA/IGNvbnRhaW5lckhlaWdodCA6IE51bWJlcihoZWlnaHQpOwogIGlmIChhc3BlY3QgJiYgYXNwZWN0ID4gMCkgewogICAgaWYgKGNhbGN1bGF0ZWRXaWR0aCkgewogICAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gY2FsY3VsYXRlZFdpZHRoIC8gYXNwZWN0OwogICAgfSBlbHNlIGlmIChjYWxjdWxhdGVkSGVpZ2h0KSB7CiAgICAgIGNhbGN1bGF0ZWRXaWR0aCA9IGNhbGN1bGF0ZWRIZWlnaHQgKiBhc3BlY3Q7CiAgICB9CiAgICBpZiAobWF4SGVpZ2h0ICYmIGNhbGN1bGF0ZWRIZWlnaHQgIT0gbnVsbCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID4gbWF4SGVpZ2h0KSB7CiAgICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBtYXhIZWlnaHQ7CiAgICB9CiAgfQogIHJldHVybiB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfTsKfTsKdmFyIGJvdGhPdmVyZmxvdyA9IHsKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgb3ZlcmZsb3c6ICJ2aXNpYmxlIgp9Owp2YXIgb3ZlcmZsb3dYID0gewogIHdpZHRoOiAwLAogIG92ZXJmbG93WDogInZpc2libGUiCn07CnZhciBvdmVyZmxvd1kgPSB7CiAgaGVpZ2h0OiAwLAogIG92ZXJmbG93WTogInZpc2libGUiCn07CnZhciBub1N0eWxlID0ge307CnZhciBnZXRJbm5lckRpdlN0eWxlID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBpc1dpZHRoUGVyY2VudCA9IGlzUGVyY2VudCh3aWR0aCk7CiAgdmFyIGlzSGVpZ2h0UGVyY2VudCA9IGlzUGVyY2VudChoZWlnaHQpOwogIGlmIChpc1dpZHRoUGVyY2VudCAmJiBpc0hlaWdodFBlcmNlbnQpIHsKICAgIHJldHVybiBib3RoT3ZlcmZsb3c7CiAgfQogIGlmIChpc1dpZHRoUGVyY2VudCkgewogICAgcmV0dXJuIG92ZXJmbG93WDsKICB9CiAgaWYgKGlzSGVpZ2h0UGVyY2VudCkgewogICAgcmV0dXJuIG92ZXJmbG93WTsKICB9CiAgcmV0dXJuIG5vU3R5bGU7Cn07CmZ1bmN0aW9uIGdldERlZmF1bHRXaWR0aEFuZEhlaWdodChfcmVmMikgewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdAogIH0gPSBfcmVmMjsKICB2YXIgY2FsY3VsYXRlZFdpZHRoID0gd2lkdGg7CiAgdmFyIGNhbGN1bGF0ZWRIZWlnaHQgPSBoZWlnaHQ7CiAgaWYgKGNhbGN1bGF0ZWRXaWR0aCA9PT0gdm9pZCAwICYmIGNhbGN1bGF0ZWRIZWlnaHQgPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZFdpZHRoID0gIjEwMCUiOwogICAgY2FsY3VsYXRlZEhlaWdodCA9ICIxMDAlIjsKICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRXaWR0aCA9PT0gdm9pZCAwKSB7CiAgICBjYWxjdWxhdGVkV2lkdGggPSBhc3BlY3QgJiYgYXNwZWN0ID4gMCA/IHZvaWQgMCA6ICIxMDAlIjsKICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRIZWlnaHQgPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZEhlaWdodCA9IGFzcGVjdCAmJiBhc3BlY3QgPiAwID8gdm9pZCAwIDogIjEwMCUiOwogIH0KICByZXR1cm4gewogICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvaXNXZWxsQmVoYXZlZE51bWJlci5qcwpmdW5jdGlvbiBpc1dlbGxCZWhhdmVkTnVtYmVyKG4pIHsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG4pOwp9CmZ1bmN0aW9uIGlzUG9zaXRpdmVOdW1iZXIobikgewogIHJldHVybiB0eXBlb2YgbiA9PT0gIm51bWJlciIgJiYgbiA+IDAgJiYgTnVtYmVyLmlzRmluaXRlKG4pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwpmdW5jdGlvbiBfZXh0ZW5kczMoKSB7CiAgcmV0dXJuIF9leHRlbmRzMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5NCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuY3JlYXRlQ29udGV4dCkoewogIHdpZHRoOiAtMSwKICBoZWlnaHQ6IC0xCn0pOwpmdW5jdGlvbiBpc0FjY2VwdGFibGVTaXplKHNpemUpIHsKICByZXR1cm4gaXNQb3NpdGl2ZU51bWJlcihzaXplLndpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHNpemUuaGVpZ2h0KTsKfQpmdW5jdGlvbiBSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gX3JlZjI7CiAgdmFyIHNpemUgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlTWVtbykoKCkgPT4gKHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSksIFt3aWR0aCwgaGVpZ2h0XSk7CiAgaWYgKCFpc0FjY2VwdGFibGVTaXplKHNpemUpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHNpemUKICB9LCBjaGlsZHJlbik7Cn0KdmFyIHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDEyLnVzZUNvbnRleHQpKFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KTsKdmFyIFNpemVEZXRlY3RvckNvbnRhaW5lciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuZm9yd2FyZFJlZikoKF9yZWYyLCByZWYpID0+IHsKICB2YXIgewogICAgYXNwZWN0LAogICAgaW5pdGlhbERpbWVuc2lvbiA9IHsKICAgICAgd2lkdGg6IC0xLAogICAgICBoZWlnaHQ6IC0xCiAgICB9LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICAvKgogICAgICogZGVmYXVsdCBtaW4td2lkdGggdG8gMCBpZiBub3Qgc3BlY2lmaWVkIC0gJ2F1dG8nIGNhdXNlcyBpc3N1ZXMgd2l0aCBmbGV4Ym94CiAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvaXNzdWVzLzE3MgogICAgICovCiAgICBtaW5XaWR0aCA9IDAsCiAgICBtaW5IZWlnaHQsCiAgICBtYXhIZWlnaHQsCiAgICBjaGlsZHJlbiwKICAgIGRlYm91bmNlID0gMCwKICAgIGlkLAogICAgY2xhc3NOYW1lLAogICAgb25SZXNpemUsCiAgICBzdHlsZSA9IHt9CiAgfSA9IF9yZWYyOwogIHZhciBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlUmVmKShudWxsKTsKICB2YXIgb25SZXNpemVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlUmVmKSgpOwogIG9uUmVzaXplUmVmLmN1cnJlbnQgPSBvblJlc2l6ZTsKICAoMCwgaW1wb3J0X3JlYWN0MTIudXNlSW1wZXJhdGl2ZUhhbmRsZSkocmVmLCAoKSA9PiBjb250YWluZXJSZWYuY3VycmVudCk7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogaW5pdGlhbERpbWVuc2lvbi53aWR0aCwKICAgIGNvbnRhaW5lckhlaWdodDogaW5pdGlhbERpbWVuc2lvbi5oZWlnaHQKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICAoMCwgaW1wb3J0X3JlYWN0MTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQgPT0gbnVsbCB8fCB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGNhbGxiYWNrID0gKGVudHJpZXMpID0+IHsKICAgICAgdmFyIF9vblJlc2l6ZVJlZiRjdXJyZW50OwogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aDMsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQzCiAgICAgIH0gPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0OwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoMywgY29udGFpbmVySGVpZ2h0Myk7CiAgICAgIChfb25SZXNpemVSZWYkY3VycmVudCA9IG9uUmVzaXplUmVmLmN1cnJlbnQpID09PSBudWxsIHx8IF9vblJlc2l6ZVJlZiRjdXJyZW50ID09PSB2b2lkIDAgfHwgX29uUmVzaXplUmVmJGN1cnJlbnQuY2FsbChvblJlc2l6ZVJlZiwgY29udGFpbmVyV2lkdGgzLCBjb250YWluZXJIZWlnaHQzKTsKICAgIH07CiAgICBpZiAoZGVib3VuY2UgPiAwKSB7CiAgICAgIGNhbGxiYWNrID0gKDAsIGltcG9ydF90aHJvdHRsZS5kZWZhdWx0KShjYWxsYmFjaywgZGVib3VuY2UsIHsKICAgICAgICB0cmFpbGluZzogdHJ1ZSwKICAgICAgICBsZWFkaW5nOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIHZhciBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7CiAgICB2YXIgewogICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgyLAogICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodDIKICAgIH0gPSBjb250YWluZXJSZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgyLCBjb250YWluZXJIZWlnaHQyKTsKICAgIG9ic2VydmVyLm9ic2VydmUoY29udGFpbmVyUmVmLmN1cnJlbnQpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgfTsKICB9LCBbc2V0Q29udGFpbmVyU2l6ZSwgZGVib3VuY2VdKTsKICB2YXIgewogICAgY29udGFpbmVyV2lkdGgsCiAgICBjb250YWluZXJIZWlnaHQKICB9ID0gc2l6ZXM7CiAgd2FybighYXNwZWN0IHx8IGFzcGVjdCA+IDAsICJUaGUgYXNwZWN0KCVzKSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIsIGFzcGVjdCk7CiAgdmFyIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9ID0gY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgYXNwZWN0LAogICAgbWF4SGVpZ2h0CiAgfSk7CiAgd2FybihjYWxjdWxhdGVkV2lkdGggIT0gbnVsbCAmJiBjYWxjdWxhdGVkV2lkdGggPiAwIHx8IGNhbGN1bGF0ZWRIZWlnaHQgIT0gbnVsbCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID4gMCwgIlRoZSB3aWR0aCglcykgYW5kIGhlaWdodCglcykgb2YgY2hhcnQgc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiAwLFxuICAgICAgIHBsZWFzZSBjaGVjayB0aGUgc3R5bGUgb2YgY29udGFpbmVyLCBvciB0aGUgcHJvcHMgd2lkdGgoJXMpIGFuZCBoZWlnaHQoJXMpLFxuICAgICAgIG9yIGFkZCBhIG1pbldpZHRoKCVzKSBvciBtaW5IZWlnaHQoJXMpIG9yIHVzZSBhc3BlY3QoJXMpIHRvIGNvbnRyb2wgdGhlXG4gICAgICAgaGVpZ2h0IGFuZCB3aWR0aC4iLCBjYWxjdWxhdGVkV2lkdGgsIGNhbGN1bGF0ZWRIZWlnaHQsIHdpZHRoLCBoZWlnaHQsIG1pbldpZHRoLCBtaW5IZWlnaHQsIGFzcGVjdCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgaWQ6IGlkID8gIiIuY29uY2F0KGlkKSA6IHZvaWQgMCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmVzcG9uc2l2ZS1jb250YWluZXIiLCBjbGFzc05hbWUpLAogICAgc3R5bGU6IF9vYmplY3RTcHJlYWQ0KF9vYmplY3RTcHJlYWQ0KHt9LCBzdHlsZSksIHt9LCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIG1pbldpZHRoLAogICAgICBtaW5IZWlnaHQsCiAgICAgIG1heEhlaWdodAogICAgfSksCiAgICByZWY6IGNvbnRhaW5lclJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgc3R5bGU6IGdldElubmVyRGl2U3R5bGUoewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9KQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyLCB7CiAgICB3aWR0aDogY2FsY3VsYXRlZFdpZHRoLAogICAgaGVpZ2h0OiBjYWxjdWxhdGVkSGVpZ2h0CiAgfSwgY2hpbGRyZW4pKSk7Cn0pOwp2YXIgUmVzcG9uc2l2ZUNvbnRhaW5lciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgcmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIGlmIChpc1Bvc2l0aXZlTnVtYmVyKHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LndpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LmhlaWdodCkpIHsKICAgIHJldHVybiBwcm9wcy5jaGlsZHJlbjsKICB9CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IGdldERlZmF1bHRXaWR0aEFuZEhlaWdodCh7CiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGFzcGVjdDogcHJvcHMuYXNwZWN0CiAgfSk7CiAgdmFyIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9ID0gY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zKHZvaWQgMCwgdm9pZCAwLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdDogcHJvcHMuYXNwZWN0LAogICAgbWF4SGVpZ2h0OiBwcm9wcy5tYXhIZWlnaHQKICB9KTsKICBpZiAoaXNOdW1iZXIoY2FsY3VsYXRlZFdpZHRoKSAmJiBpc051bWJlcihjYWxjdWxhdGVkSGVpZ2h0KSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyLCB7CiAgICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogICAgfSwgcHJvcHMuY2hpbGRyZW4pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KFNpemVEZXRlY3RvckNvbnRhaW5lciwgX2V4dGVuZHMzKHt9LCBwcm9wcywgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZWYKICB9KSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydExheW91dENvbnRleHQuanMKZnVuY3Rpb24gY2FydGVzaWFuVmlld0JveFRvVHJhcGV6b2lkKGJveCkgewogIGlmICghYm94KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gewogICAgeDogYm94LngsCiAgICB5OiBib3gueSwKICAgIHVwcGVyV2lkdGg6ICJ1cHBlcldpZHRoIiBpbiBib3ggPyBib3gudXBwZXJXaWR0aCA6IGJveC53aWR0aCwKICAgIGxvd2VyV2lkdGg6ICJsb3dlcldpZHRoIiBpbiBib3ggPyBib3gubG93ZXJXaWR0aCA6IGJveC53aWR0aCwKICAgIHdpZHRoOiBib3gud2lkdGgsCiAgICBoZWlnaHQ6IGJveC5oZWlnaHQKICB9Owp9CnZhciB1c2VWaWV3Qm94ID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgdmFyIHBhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciByb290Vmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0Vmlld0JveCk7CiAgdmFyIGJydXNoRGltZW5zaW9ucyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoRGltZW5zaW9ucyk7CiAgdmFyIGJydXNoUGFkZGluZyA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaFNldHRpbmdzKSkgPT09IG51bGwgfHwgX3VzZUFwcFNlbGVjdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdXNlQXBwU2VsZWN0b3IucGFkZGluZzsKICBpZiAoIXBhbm9yYW1hIHx8ICFicnVzaERpbWVuc2lvbnMgfHwgIWJydXNoUGFkZGluZykgewogICAgcmV0dXJuIHJvb3RWaWV3Qm94OwogIH0KICByZXR1cm4gewogICAgd2lkdGg6IGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5sZWZ0IC0gYnJ1c2hQYWRkaW5nLnJpZ2h0LAogICAgaGVpZ2h0OiBicnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLnRvcCAtIGJydXNoUGFkZGluZy5ib3R0b20sCiAgICB4OiBicnVzaFBhZGRpbmcubGVmdCwKICAgIHk6IGJydXNoUGFkZGluZy50b3AKICB9Owp9Owp2YXIgbWFueUNvbXBvbmVudHNUaHJvd0Vycm9yc0lmT2Zmc2V0SXNVbmRlZmluZWQgPSB7CiAgdG9wOiAwLAogIGJvdHRvbTogMCwKICBsZWZ0OiAwLAogIHJpZ2h0OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBicnVzaEJvdHRvbTogMAp9Owp2YXIgdXNlT2Zmc2V0SW50ZXJuYWwgPSAoKSA9PiB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjI7CiAgcmV0dXJuIChfdXNlQXBwU2VsZWN0b3IyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvcjIgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvcjIgOiBtYW55Q29tcG9uZW50c1Rocm93RXJyb3JzSWZPZmZzZXRJc1VuZGVmaW5lZDsKfTsKdmFyIHVzZUNoYXJ0V2lkdGggPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgpOwp9Owp2YXIgdXNlQ2hhcnRIZWlnaHQgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0KTsKfTsKdmFyIHNlbGVjdENoYXJ0TGF5b3V0ID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZTsKdmFyIHVzZUNoYXJ0TGF5b3V0ID0gKCkgPT4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRMYXlvdXQpOwp2YXIgdXNlQ2FydGVzaWFuQ2hhcnRMYXlvdXQgPSAoKSA9PiB7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIGxheW91dDsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHVzZUlzSW5DaGFydENvbnRleHQgPSAoKSA9PiB7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgcmV0dXJuIGxheW91dCAhPT0gdm9pZCAwOwp9Owp2YXIgUmVwb3J0Q2hhcnRTaXplID0gKHByb3BzKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgewogICAgd2lkdGg6IHdpZHRoRnJvbVByb3BzLAogICAgaGVpZ2h0OiBoZWlnaHRGcm9tUHJvcHMKICB9ID0gcHJvcHM7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIHZhciB3aWR0aCA9IHdpZHRoRnJvbVByb3BzOwogIHZhciBoZWlnaHQgPSBoZWlnaHRGcm9tUHJvcHM7CiAgaWYgKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMpIHsKICAgIHdpZHRoID0gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoIDogd2lkdGhGcm9tUHJvcHM7CiAgICBoZWlnaHQgPSByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA6IGhlaWdodEZyb21Qcm9wczsKICB9CiAgKDAsIGltcG9ydF9yZWFjdDEzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc1Bhbm9yYW1hICYmIGlzUG9zaXRpdmVOdW1iZXIod2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSkgewogICAgICBkaXNwYXRjaChzZXRDaGFydFNpemUoewogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9KSk7CiAgICB9CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vaW1tZXJAMTAuMi4wL25vZGVfbW9kdWxlcy9pbW1lci9kaXN0L2ltbWVyLm1qcwp2YXIgTk9USElORzIgPSBTeW1ib2wuZm9yKCJpbW1lci1ub3RoaW5nIik7CnZhciBEUkFGVEFCTEUyID0gU3ltYm9sLmZvcigiaW1tZXItZHJhZnRhYmxlIik7CnZhciBEUkFGVF9TVEFURTIgPSBTeW1ib2wuZm9yKCJpbW1lci1zdGF0ZSIpOwp2YXIgZXJyb3JzMiA9IHRydWUgPyBbCiAgLy8gQWxsIGVycm9yIGNvZGVzLCBzdGFydGluZyBieSAwOgogIGZ1bmN0aW9uKHBsdWdpbikgewogICAgcmV0dXJuIGBUaGUgcGx1Z2luIGZvciAnJHtwbHVnaW59JyBoYXMgbm90IGJlZW4gbG9hZGVkIGludG8gSW1tZXIuIFRvIGVuYWJsZSB0aGUgcGx1Z2luLCBpbXBvcnQgYW5kIGNhbGwgXGBlbmFibGUke3BsdWdpbn0oKVxgIHdoZW4gaW5pdGlhbGl6aW5nIHlvdXIgYXBwbGljYXRpb24uYDsKICB9LAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYHByb2R1Y2UgY2FuIG9ubHkgYmUgY2FsbGVkIG9uIHRoaW5ncyB0aGF0IGFyZSBkcmFmdGFibGU6IHBsYWluIG9iamVjdHMsIGFycmF5cywgTWFwLCBTZXQgb3IgY2xhc3NlcyB0aGF0IGFyZSBtYXJrZWQgd2l0aCAnW2ltbWVyYWJsZV06IHRydWUnLiBHb3QgJyR7dGhpbmd9J2A7CiAgfSwKICAiVGhpcyBvYmplY3QgaGFzIGJlZW4gZnJvemVuIGFuZCBzaG91bGQgbm90IGJlIG11dGF0ZWQiLAogIGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiAiQ2Fubm90IHVzZSBhIHByb3h5IHRoYXQgaGFzIGJlZW4gcmV2b2tlZC4gRGlkIHlvdSBwYXNzIGFuIG9iamVjdCBmcm9tIGluc2lkZSBhbiBpbW1lciBmdW5jdGlvbiB0byBhbiBhc3luYyBwcm9jZXNzPyAiICsgZGF0YTsKICB9LAogICJBbiBpbW1lciBwcm9kdWNlciByZXR1cm5lZCBhIG5ldyB2YWx1ZSAqYW5kKiBtb2RpZmllZCBpdHMgZHJhZnQuIEVpdGhlciByZXR1cm4gYSBuZXcgdmFsdWUgKm9yKiBtb2RpZnkgdGhlIGRyYWZ0LiIsCiAgIkltbWVyIGZvcmJpZHMgY2lyY3VsYXIgcmVmZXJlbmNlcyIsCiAgIlRoZSBmaXJzdCBvciBzZWNvbmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiIsCiAgIlRoZSB0aGlyZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIHVuZGVmaW5lZCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBjcmVhdGVEcmFmdGAgbXVzdCBiZSBhIHBsYWluIG9iamVjdCwgYW4gYXJyYXksIG9yIGFuIGltbWVyYWJsZSBvYmplY3QiLAogICJGaXJzdCBhcmd1bWVudCB0byBgZmluaXNoRHJhZnRgIG11c3QgYmUgYSBkcmFmdCByZXR1cm5lZCBieSBgY3JlYXRlRHJhZnRgIiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnY3VycmVudCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9LAogICJPYmplY3QuZGVmaW5lUHJvcGVydHkoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIk9iamVjdC5zZXRQcm90b3R5cGVPZigpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBkZWxldGluZyBhcnJheSBpbmRpY2VzIiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBzZXR0aW5nIGFycmF5IGluZGljZXMgYW5kIHRoZSAnbGVuZ3RoJyBwcm9wZXJ0eSIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ29yaWdpbmFsJyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0KICAvLyBOb3RlOiBpZiBtb3JlIGVycm9ycyBhcmUgYWRkZWQsIHRoZSBlcnJvck9mZnNldCBpbiBQYXRjaGVzLnRzIHNob3VsZCBiZSBpbmNyZWFzZWQKICAvLyBTZWUgUGF0Y2hlcy50cyBmb3IgYWRkaXRpb25hbCBlcnJvcnMKXSA6IFtdOwpmdW5jdGlvbiBkaWUyKGVycm9yLCAuLi5hcmdzKSB7CiAgaWYgKHRydWUpIHsKICAgIGNvbnN0IGUgPSBlcnJvcnMyW2Vycm9yXTsKICAgIGNvbnN0IG1zZyA9IHR5cGVvZiBlID09PSAiZnVuY3Rpb24iID8gZS5hcHBseShudWxsLCBhcmdzKSA6IGU7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtJbW1lcl0gJHttc2d9YCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBbSW1tZXJdIG1pbmlmaWVkIGVycm9yIG5yOiAke2Vycm9yfS4gRnVsbCBlcnJvciBhdDogaHR0cHM6Ly9iaXQubHkvM2NYRUtXZmAKICApOwp9CnZhciBnZXRQcm90b3R5cGVPZjIgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CmZ1bmN0aW9uIGlzRHJhZnQyKHZhbHVlKSB7CiAgcmV0dXJuICEhdmFsdWUgJiYgISF2YWx1ZVtEUkFGVF9TVEFURTJdOwp9CmZ1bmN0aW9uIGlzRHJhZnRhYmxlMih2YWx1ZSkgewogIGlmICghdmFsdWUpCiAgICByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QzKHZhbHVlKSB8fCBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhIXZhbHVlW0RSQUZUQUJMRTJdIHx8ICEhdmFsdWUuY29uc3RydWN0b3I/LltEUkFGVEFCTEUyXSB8fCBpc01hcDIodmFsdWUpIHx8IGlzU2V0Mih2YWx1ZSk7Cn0KdmFyIG9iamVjdEN0b3JTdHJpbmcyID0gT2JqZWN0LnByb3RvdHlwZS5jb25zdHJ1Y3Rvci50b1N0cmluZygpOwp2YXIgY2FjaGVkQ3RvclN0cmluZ3MyID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3QzKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiKQogICAgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHByb3RvMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgaWYgKHByb3RvMiA9PT0gbnVsbCB8fCBwcm90bzIgPT09IE9iamVjdC5wcm90b3R5cGUpCiAgICByZXR1cm4gdHJ1ZTsKICBjb25zdCBDdG9yID0gT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwocHJvdG8yLCAiY29uc3RydWN0b3IiKSAmJiBwcm90bzIuY29uc3RydWN0b3I7CiAgaWYgKEN0b3IgPT09IE9iamVjdCkKICAgIHJldHVybiB0cnVlOwogIGlmICh0eXBlb2YgQ3RvciAhPT0gImZ1bmN0aW9uIikKICAgIHJldHVybiBmYWxzZTsKICBsZXQgY3RvclN0cmluZyA9IGNhY2hlZEN0b3JTdHJpbmdzMi5nZXQoQ3Rvcik7CiAgaWYgKGN0b3JTdHJpbmcgPT09IHZvaWQgMCkgewogICAgY3RvclN0cmluZyA9IEZ1bmN0aW9uLnRvU3RyaW5nLmNhbGwoQ3Rvcik7CiAgICBjYWNoZWRDdG9yU3RyaW5nczIuc2V0KEN0b3IsIGN0b3JTdHJpbmcpOwogIH0KICByZXR1cm4gY3RvclN0cmluZyA9PT0gb2JqZWN0Q3RvclN0cmluZzI7Cn0KZnVuY3Rpb24gZWFjaDIob2JqLCBpdGVyLCBzdHJpY3QgPSB0cnVlKSB7CiAgaWYgKGdldEFyY2h0eXBlMihvYmopID09PSAwKSB7CiAgICBjb25zdCBrZXlzID0gc3RyaWN0ID8gUmVmbGVjdC5vd25LZXlzKG9iaikgOiBPYmplY3Qua2V5cyhvYmopOwogICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgaXRlcihrZXksIG9ialtrZXldLCBvYmopOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iai5mb3JFYWNoKChlbnRyeSwgaW5kZXgpID0+IGl0ZXIoaW5kZXgsIGVudHJ5LCBvYmopKTsKICB9Cn0KZnVuY3Rpb24gZ2V0QXJjaHR5cGUyKHRoaW5nKSB7CiAgY29uc3Qgc3RhdGUgPSB0aGluZ1tEUkFGVF9TVEFURTJdOwogIHJldHVybiBzdGF0ZSA/IHN0YXRlLnR5cGVfIDogQXJyYXkuaXNBcnJheSh0aGluZykgPyAxIDogaXNNYXAyKHRoaW5nKSA/IDIgOiBpc1NldDIodGhpbmcpID8gMyA6IDA7Cn0KZnVuY3Rpb24gaGFzMih0aGluZywgcHJvcCkgewogIHJldHVybiBnZXRBcmNodHlwZTIodGhpbmcpID09PSAyID8gdGhpbmcuaGFzKHByb3ApIDogT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaW5nLCBwcm9wKTsKfQpmdW5jdGlvbiBzZXQyKHRoaW5nLCBwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpIHsKICBjb25zdCB0ID0gZ2V0QXJjaHR5cGUyKHRoaW5nKTsKICBpZiAodCA9PT0gMikKICAgIHRoaW5nLnNldChwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpOwogIGVsc2UgaWYgKHQgPT09IDMpIHsKICAgIHRoaW5nLmFkZCh2YWx1ZSk7CiAgfSBlbHNlCiAgICB0aGluZ1twcm9wT3JPbGRWYWx1ZV0gPSB2YWx1ZTsKfQpmdW5jdGlvbiBpczIoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KZnVuY3Rpb24gaXNNYXAyKHRhcmdldCkgewogIHJldHVybiB0YXJnZXQgaW5zdGFuY2VvZiBNYXA7Cn0KZnVuY3Rpb24gaXNTZXQyKHRhcmdldCkgewogIHJldHVybiB0YXJnZXQgaW5zdGFuY2VvZiBTZXQ7Cn0KZnVuY3Rpb24gbGF0ZXN0MihzdGF0ZSkgewogIHJldHVybiBzdGF0ZS5jb3B5XyB8fCBzdGF0ZS5iYXNlXzsKfQpmdW5jdGlvbiBzaGFsbG93Q29weTIoYmFzZSwgc3RyaWN0KSB7CiAgaWYgKGlzTWFwMihiYXNlKSkgewogICAgcmV0dXJuIG5ldyBNYXAoYmFzZSk7CiAgfQogIGlmIChpc1NldDIoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgU2V0KGJhc2UpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShiYXNlKSkKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChiYXNlKTsKICBjb25zdCBpc1BsYWluMiA9IGlzUGxhaW5PYmplY3QzKGJhc2UpOwogIGlmIChzdHJpY3QgPT09IHRydWUgfHwgc3RyaWN0ID09PSAiY2xhc3Nfb25seSIgJiYgIWlzUGxhaW4yKSB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKGJhc2UpOwogICAgZGVsZXRlIGRlc2NyaXB0b3JzW0RSQUZUX1NUQVRFMl07CiAgICBsZXQga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhkZXNjcmlwdG9ycyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgY29uc3QgZGVzYyA9IGRlc2NyaXB0b3JzW2tleV07CiAgICAgIGlmIChkZXNjLndyaXRhYmxlID09PSBmYWxzZSkgewogICAgICAgIGRlc2Mud3JpdGFibGUgPSB0cnVlOwogICAgICAgIGRlc2MuY29uZmlndXJhYmxlID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpCiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgLy8gY291bGQgbGl2ZSB3aXRoICEhZGVzYy5zZXQgYXMgd2VsbCBoZXJlLi4uCiAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjLmVudW1lcmFibGUsCiAgICAgICAgICB2YWx1ZTogYmFzZVtrZXldCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuY3JlYXRlKGdldFByb3RvdHlwZU9mMihiYXNlKSwgZGVzY3JpcHRvcnMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIoYmFzZSk7CiAgICBpZiAocHJvdG8yICE9PSBudWxsICYmIGlzUGxhaW4yKSB7CiAgICAgIHJldHVybiB7IC4uLmJhc2UgfTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IE9iamVjdC5jcmVhdGUocHJvdG8yKTsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKG9iaiwgYmFzZSk7CiAgfQp9CmZ1bmN0aW9uIGZyZWV6ZTIob2JqLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoaXNGcm96ZW4yKG9iaikgfHwgaXNEcmFmdDIob2JqKSB8fCAhaXNEcmFmdGFibGUyKG9iaikpCiAgICByZXR1cm4gb2JqOwogIGlmIChnZXRBcmNodHlwZTIob2JqKSA+IDEpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKG9iaiwgewogICAgICBzZXQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGFkZDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgY2xlYXI6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGRlbGV0ZTogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMgogICAgfSk7CiAgfQogIE9iamVjdC5mcmVlemUob2JqKTsKICBpZiAoZGVlcCkKICAgIE9iamVjdC52YWx1ZXMob2JqKS5mb3JFYWNoKCh2YWx1ZSkgPT4gZnJlZXplMih2YWx1ZSwgdHJ1ZSkpOwogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zMigpIHsKICBkaWUyKDIpOwp9CnZhciBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyID0gewogIHZhbHVlOiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMyCn07CmZ1bmN0aW9uIGlzRnJvemVuMihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIE9iamVjdC5pc0Zyb3plbihvYmopOwp9CnZhciBwbHVnaW5zMiA9IHt9OwpmdW5jdGlvbiBnZXRQbHVnaW4yKHBsdWdpbktleSkgewogIGNvbnN0IHBsdWdpbiA9IHBsdWdpbnMyW3BsdWdpbktleV07CiAgaWYgKCFwbHVnaW4pIHsKICAgIGRpZTIoMCwgcGx1Z2luS2V5KTsKICB9CiAgcmV0dXJuIHBsdWdpbjsKfQp2YXIgY3VycmVudFNjb3BlMjsKZnVuY3Rpb24gZ2V0Q3VycmVudFNjb3BlMigpIHsKICByZXR1cm4gY3VycmVudFNjb3BlMjsKfQpmdW5jdGlvbiBjcmVhdGVTY29wZTIocGFyZW50XywgaW1tZXJfKSB7CiAgcmV0dXJuIHsKICAgIGRyYWZ0c186IFtdLAogICAgcGFyZW50XywKICAgIGltbWVyXywKICAgIC8vIFdoZW5ldmVyIHRoZSBtb2RpZmllZCBkcmFmdCBjb250YWlucyBhIGRyYWZ0IGZyb20gYW5vdGhlciBzY29wZSwgd2UKICAgIC8vIG5lZWQgdG8gcHJldmVudCBhdXRvLWZyZWV6aW5nIHNvIHRoZSB1bm93bmVkIGRyYWZ0IGNhbiBiZSBmaW5hbGl6ZWQuCiAgICBjYW5BdXRvRnJlZXplXzogdHJ1ZSwKICAgIHVuZmluYWxpemVkRHJhZnRzXzogMAogIH07Cn0KZnVuY3Rpb24gdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKSB7CiAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKTsKICAgIHNjb3BlLnBhdGNoZXNfID0gW107CiAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfID0gcGF0Y2hMaXN0ZW5lcjsKICB9Cn0KZnVuY3Rpb24gcmV2b2tlU2NvcGUyKHNjb3BlKSB7CiAgbGVhdmVTY29wZTIoc2NvcGUpOwogIHNjb3BlLmRyYWZ0c18uZm9yRWFjaChyZXZva2VEcmFmdDIpOwogIHNjb3BlLmRyYWZ0c18gPSBudWxsOwp9CmZ1bmN0aW9uIGxlYXZlU2NvcGUyKHNjb3BlKSB7CiAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUyKSB7CiAgICBjdXJyZW50U2NvcGUyID0gc2NvcGUucGFyZW50XzsKICB9Cn0KZnVuY3Rpb24gZW50ZXJTY29wZTIoaW1tZXIyMikgewogIHJldHVybiBjdXJyZW50U2NvcGUyID0gY3JlYXRlU2NvcGUyKGN1cnJlbnRTY29wZTIsIGltbWVyMjIpOwp9CmZ1bmN0aW9uIHJldm9rZURyYWZ0MihkcmFmdCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEUyXTsKICBpZiAoc3RhdGUudHlwZV8gPT09IDAgfHwgc3RhdGUudHlwZV8gPT09IDEpCiAgICBzdGF0ZS5yZXZva2VfKCk7CiAgZWxzZQogICAgc3RhdGUucmV2b2tlZF8gPSB0cnVlOwp9CmZ1bmN0aW9uIHByb2Nlc3NSZXN1bHQyKHJlc3VsdCwgc2NvcGUpIHsKICBzY29wZS51bmZpbmFsaXplZERyYWZ0c18gPSBzY29wZS5kcmFmdHNfLmxlbmd0aDsKICBjb25zdCBiYXNlRHJhZnQgPSBzY29wZS5kcmFmdHNfWzBdOwogIGNvbnN0IGlzUmVwbGFjZWQgPSByZXN1bHQgIT09IHZvaWQgMCAmJiByZXN1bHQgIT09IGJhc2VEcmFmdDsKICBpZiAoaXNSZXBsYWNlZCkgewogICAgaWYgKGJhc2VEcmFmdFtEUkFGVF9TVEFURTJdLm1vZGlmaWVkXykgewogICAgICByZXZva2VTY29wZTIoc2NvcGUpOwogICAgICBkaWUyKDQpOwogICAgfQogICAgaWYgKGlzRHJhZnRhYmxlMihyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IGZpbmFsaXplMihzY29wZSwgcmVzdWx0KTsKICAgICAgaWYgKCFzY29wZS5wYXJlbnRfKQogICAgICAgIG1heWJlRnJlZXplMihzY29wZSwgcmVzdWx0KTsKICAgIH0KICAgIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKAogICAgICAgIGJhc2VEcmFmdFtEUkFGVF9TVEFURTJdLmJhc2VfLAogICAgICAgIHJlc3VsdCwKICAgICAgICBzY29wZS5wYXRjaGVzXywKICAgICAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18KICAgICAgKTsKICAgIH0KICB9IGVsc2UgewogICAgcmVzdWx0ID0gZmluYWxpemUyKHNjb3BlLCBiYXNlRHJhZnQsIFtdKTsKICB9CiAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfKHNjb3BlLnBhdGNoZXNfLCBzY29wZS5pbnZlcnNlUGF0Y2hlc18pOwogIH0KICByZXR1cm4gcmVzdWx0ICE9PSBOT1RISU5HMiA/IHJlc3VsdCA6IHZvaWQgMDsKfQpmdW5jdGlvbiBmaW5hbGl6ZTIocm9vdFNjb3BlLCB2YWx1ZSwgcGF0aDIpIHsKICBpZiAoaXNGcm96ZW4yKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCB1c2VTdHJpY3RJdGVyYXRpb24gPSByb290U2NvcGUuaW1tZXJfLnNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEUyXTsKICBpZiAoIXN0YXRlKSB7CiAgICBlYWNoMigKICAgICAgdmFsdWUsCiAgICAgIChrZXksIGNoaWxkVmFsdWUpID0+IGZpbmFsaXplUHJvcGVydHkocm9vdFNjb3BlLCBzdGF0ZSwgdmFsdWUsIGtleSwgY2hpbGRWYWx1ZSwgcGF0aDIpLAogICAgICB1c2VTdHJpY3RJdGVyYXRpb24KICAgICk7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmIChzdGF0ZS5zY29wZV8gIT09IHJvb3RTY29wZSkKICAgIHJldHVybiB2YWx1ZTsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgc3RhdGUuYmFzZV8sIHRydWUpOwogICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogIH0KICBpZiAoIXN0YXRlLmZpbmFsaXplZF8pIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgc3RhdGUuc2NvcGVfLnVuZmluYWxpemVkRHJhZnRzXy0tOwogICAgY29uc3QgcmVzdWx0ID0gc3RhdGUuY29weV87CiAgICBsZXQgcmVzdWx0RWFjaCA9IHJlc3VsdDsKICAgIGxldCBpc1NldDIyID0gZmFsc2U7CiAgICBpZiAoc3RhdGUudHlwZV8gPT09IDMpIHsKICAgICAgcmVzdWx0RWFjaCA9IG5ldyBTZXQocmVzdWx0KTsKICAgICAgcmVzdWx0LmNsZWFyKCk7CiAgICAgIGlzU2V0MjIgPSB0cnVlOwogICAgfQogICAgZWFjaDIoCiAgICAgIHJlc3VsdEVhY2gsCiAgICAgIChrZXksIGNoaWxkVmFsdWUpID0+IGZpbmFsaXplUHJvcGVydHkoCiAgICAgICAgcm9vdFNjb3BlLAogICAgICAgIHN0YXRlLAogICAgICAgIHJlc3VsdCwKICAgICAgICBrZXksCiAgICAgICAgY2hpbGRWYWx1ZSwKICAgICAgICBwYXRoMiwKICAgICAgICBpc1NldDIyCiAgICAgICksCiAgICAgIHVzZVN0cmljdEl0ZXJhdGlvbgogICAgKTsKICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIHJlc3VsdCwgZmFsc2UpOwogICAgaWYgKHBhdGgyICYmIHJvb3RTY29wZS5wYXRjaGVzXykgewogICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVQYXRjaGVzXygKICAgICAgICBzdGF0ZSwKICAgICAgICBwYXRoMiwKICAgICAgICByb290U2NvcGUucGF0Y2hlc18sCiAgICAgICAgcm9vdFNjb3BlLmludmVyc2VQYXRjaGVzXwogICAgICApOwogICAgfQogIH0KICByZXR1cm4gc3RhdGUuY29weV87Cn0KZnVuY3Rpb24gZmluYWxpemVQcm9wZXJ0eShyb290U2NvcGUsIHBhcmVudFN0YXRlLCB0YXJnZXRPYmplY3QsIHByb3AsIGNoaWxkVmFsdWUsIHJvb3RQYXRoLCB0YXJnZXRJc1NldCkgewogIGlmIChjaGlsZFZhbHVlID09IG51bGwpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKHR5cGVvZiBjaGlsZFZhbHVlICE9PSAib2JqZWN0IiAmJiAhdGFyZ2V0SXNTZXQpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgY2hpbGRJc0Zyb3plbiA9IGlzRnJvemVuMihjaGlsZFZhbHVlKTsKICBpZiAoY2hpbGRJc0Zyb3plbiAmJiAhdGFyZ2V0SXNTZXQpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKGNoaWxkVmFsdWUgPT09IHRhcmdldE9iamVjdCkKICAgIGRpZTIoNSk7CiAgaWYgKGlzRHJhZnQyKGNoaWxkVmFsdWUpKSB7CiAgICBjb25zdCBwYXRoMiA9IHJvb3RQYXRoICYmIHBhcmVudFN0YXRlICYmIHBhcmVudFN0YXRlLnR5cGVfICE9PSAzICYmIC8vIFNldCBvYmplY3RzIGFyZSBhdG9taWMgc2luY2UgdGhleSBoYXZlIG5vIGtleXMuCiAgICAhaGFzMihwYXJlbnRTdGF0ZS5hc3NpZ25lZF8sIHByb3ApID8gcm9vdFBhdGguY29uY2F0KHByb3ApIDogdm9pZCAwOwogICAgY29uc3QgcmVzID0gZmluYWxpemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSwgcGF0aDIpOwogICAgc2V0Mih0YXJnZXRPYmplY3QsIHByb3AsIHJlcyk7CiAgICBpZiAoaXNEcmFmdDIocmVzKSkgewogICAgICByb290U2NvcGUuY2FuQXV0b0ZyZWV6ZV8gPSBmYWxzZTsKICAgIH0gZWxzZQogICAgICByZXR1cm47CiAgfSBlbHNlIGlmICh0YXJnZXRJc1NldCkgewogICAgdGFyZ2V0T2JqZWN0LmFkZChjaGlsZFZhbHVlKTsKICB9CiAgaWYgKGlzRHJhZnRhYmxlMihjaGlsZFZhbHVlKSAmJiAhY2hpbGRJc0Zyb3plbikgewogICAgaWYgKCFyb290U2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHJvb3RTY29wZS51bmZpbmFsaXplZERyYWZ0c18gPCAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwYXJlbnRTdGF0ZSAmJiBwYXJlbnRTdGF0ZS5iYXNlXyAmJiBwYXJlbnRTdGF0ZS5iYXNlX1twcm9wXSA9PT0gY2hpbGRWYWx1ZSAmJiBjaGlsZElzRnJvemVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZpbmFsaXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUpOwogICAgaWYgKCghcGFyZW50U3RhdGUgfHwgIXBhcmVudFN0YXRlLnNjb3BlXy5wYXJlbnRfKSAmJiB0eXBlb2YgcHJvcCAhPT0gInN5bWJvbCIgJiYgKGlzTWFwMih0YXJnZXRPYmplY3QpID8gdGFyZ2V0T2JqZWN0Lmhhcyhwcm9wKSA6IE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbCh0YXJnZXRPYmplY3QsIHByb3ApKSkKICAgICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSk7CiAgfQp9CmZ1bmN0aW9uIG1heWJlRnJlZXplMihzY29wZSwgdmFsdWUsIGRlZXAgPSBmYWxzZSkgewogIGlmICghc2NvcGUucGFyZW50XyAmJiBzY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgc2NvcGUuY2FuQXV0b0ZyZWV6ZV8pIHsKICAgIGZyZWV6ZTIodmFsdWUsIGRlZXApOwogIH0KfQpmdW5jdGlvbiBjcmVhdGVQcm94eVByb3h5MihiYXNlLCBwYXJlbnQpIHsKICBjb25zdCBpc0FycmF5MiA9IEFycmF5LmlzQXJyYXkoYmFzZSk7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB0eXBlXzogaXNBcnJheTIgPyAxIDogMCwKICAgIC8vIFRyYWNrIHdoaWNoIHByb2R1Y2UgY2FsbCB0aGlzIGlzIGFzc29jaWF0ZWQgd2l0aC4KICAgIHNjb3BlXzogcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZTIoKSwKICAgIC8vIFRydWUgZm9yIGJvdGggc2hhbGxvdyBhbmQgZGVlcCBjaGFuZ2VzLgogICAgbW9kaWZpZWRfOiBmYWxzZSwKICAgIC8vIFVzZWQgZHVyaW5nIGZpbmFsaXphdGlvbi4KICAgIGZpbmFsaXplZF86IGZhbHNlLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvcGVydGllcyBoYXZlIGJlZW4gYXNzaWduZWQgKHRydWUpIG9yIGRlbGV0ZWQgKGZhbHNlKS4KICAgIGFzc2lnbmVkXzoge30sCiAgICAvLyBUaGUgcGFyZW50IGRyYWZ0IHN0YXRlLgogICAgcGFyZW50XzogcGFyZW50LAogICAgLy8gVGhlIGJhc2Ugc3RhdGUuCiAgICBiYXNlXzogYmFzZSwKICAgIC8vIFRoZSBiYXNlIHByb3h5LgogICAgZHJhZnRfOiBudWxsLAogICAgLy8gc2V0IGJlbG93CiAgICAvLyBUaGUgYmFzZSBjb3B5IHdpdGggYW55IHVwZGF0ZWQgdmFsdWVzLgogICAgY29weV86IG51bGwsCiAgICAvLyBDYWxsZWQgYnkgdGhlIGBwcm9kdWNlYCBmdW5jdGlvbi4KICAgIHJldm9rZV86IG51bGwsCiAgICBpc01hbnVhbF86IGZhbHNlCiAgfTsKICBsZXQgdGFyZ2V0ID0gc3RhdGU7CiAgbGV0IHRyYXBzID0gb2JqZWN0VHJhcHMyOwogIGlmIChpc0FycmF5MikgewogICAgdGFyZ2V0ID0gW3N0YXRlXTsKICAgIHRyYXBzID0gYXJyYXlUcmFwczI7CiAgfQogIGNvbnN0IHsgcmV2b2tlLCBwcm94eSB9ID0gUHJveHkucmV2b2NhYmxlKHRhcmdldCwgdHJhcHMpOwogIHN0YXRlLmRyYWZ0XyA9IHByb3h5OwogIHN0YXRlLnJldm9rZV8gPSByZXZva2U7CiAgcmV0dXJuIHByb3h5Owp9CnZhciBvYmplY3RUcmFwczIgPSB7CiAgZ2V0KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocHJvcCA9PT0gRFJBRlRfU1RBVEUyKQogICAgICByZXR1cm4gc3RhdGU7CiAgICBjb25zdCBzb3VyY2UgPSBsYXRlc3QyKHN0YXRlKTsKICAgIGlmICghaGFzMihzb3VyY2UsIHByb3ApKSB7CiAgICAgIHJldHVybiByZWFkUHJvcEZyb21Qcm90bzIoc3RhdGUsIHNvdXJjZSwgcHJvcCk7CiAgICB9CiAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKICAgIGlmIChzdGF0ZS5maW5hbGl6ZWRfIHx8ICFpc0RyYWZ0YWJsZTIodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh2YWx1ZSA9PT0gcGVlazIoc3RhdGUuYmFzZV8sIHByb3ApKSB7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIHJldHVybiBzdGF0ZS5jb3B5X1twcm9wXSA9IGNyZWF0ZVByb3h5Mih2YWx1ZSwgc3RhdGUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0sCiAgaGFzKHN0YXRlLCBwcm9wKSB7CiAgICByZXR1cm4gcHJvcCBpbiBsYXRlc3QyKHN0YXRlKTsKICB9LAogIG93bktleXMoc3RhdGUpIHsKICAgIHJldHVybiBSZWZsZWN0Lm93bktleXMobGF0ZXN0MihzdGF0ZSkpOwogIH0sCiAgc2V0KHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogICAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKGxhdGVzdDIoc3RhdGUpLCBwcm9wKTsKICAgIGlmIChkZXNjPy5zZXQpIHsKICAgICAgZGVzYy5zZXQuY2FsbChzdGF0ZS5kcmFmdF8sIHZhbHVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgICBjb25zdCBjdXJyZW50MjIgPSBwZWVrMihsYXRlc3QyKHN0YXRlKSwgcHJvcCk7CiAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnQyMj8uW0RSQUZUX1NUQVRFMl07CiAgICAgIGlmIChjdXJyZW50U3RhdGUgJiYgY3VycmVudFN0YXRlLmJhc2VfID09PSB2YWx1ZSkgewogICAgICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICAgICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzMih2YWx1ZSwgY3VycmVudDIyKSAmJiAodmFsdWUgIT09IHZvaWQgMCB8fCBoYXMyKHN0YXRlLmJhc2VfLCBwcm9wKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZSk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV9bcHJvcF0gPT09IHZhbHVlICYmIC8vIHNwZWNpYWwgY2FzZTogaGFuZGxlIG5ldyBwcm9wcyB3aXRoIHZhbHVlICd1bmRlZmluZWQnCiAgICAodmFsdWUgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmNvcHlfKSB8fCAvLyBzcGVjaWFsIGNhc2U6IE5hTgogICAgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4oc3RhdGUuY29weV9bcHJvcF0pKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSB0cnVlOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBkZWxldGVQcm9wZXJ0eShzdGF0ZSwgcHJvcCkgewogICAgaWYgKHBlZWsyKHN0YXRlLmJhc2VfLCBwcm9wKSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuYmFzZV8pIHsKICAgICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gZmFsc2U7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBkZWxldGUgc3RhdGUuYXNzaWduZWRfW3Byb3BdOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5jb3B5X1twcm9wXTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgLy8gTm90ZTogV2UgbmV2ZXIgY29lcmNlIGBkZXNjLnZhbHVlYCBpbnRvIGFuIEltbWVyIGRyYWZ0LCBiZWNhdXNlIHdlIGNhbid0IG1ha2UKICAvLyB0aGUgc2FtZSBndWFyYW50ZWUgaW4gRVM1IG1vZGUuCiAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHN0YXRlLCBwcm9wKSB7CiAgICBjb25zdCBvd25lciA9IGxhdGVzdDIoc3RhdGUpOwogICAgY29uc3QgZGVzYyA9IFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG93bmVyLCBwcm9wKTsKICAgIGlmICghZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICByZXR1cm4gewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiBzdGF0ZS50eXBlXyAhPT0gMSB8fCBwcm9wICE9PSAibGVuZ3RoIiwKICAgICAgZW51bWVyYWJsZTogZGVzYy5lbnVtZXJhYmxlLAogICAgICB2YWx1ZTogb3duZXJbcHJvcF0KICAgIH07CiAgfSwKICBkZWZpbmVQcm9wZXJ0eSgpIHsKICAgIGRpZTIoMTEpOwogIH0sCiAgZ2V0UHJvdG90eXBlT2Yoc3RhdGUpIHsKICAgIHJldHVybiBnZXRQcm90b3R5cGVPZjIoc3RhdGUuYmFzZV8pOwogIH0sCiAgc2V0UHJvdG90eXBlT2YoKSB7CiAgICBkaWUyKDEyKTsKICB9Cn07CnZhciBhcnJheVRyYXBzMiA9IHt9OwplYWNoMihvYmplY3RUcmFwczIsIChrZXksIGZuKSA9PiB7CiAgYXJyYXlUcmFwczJba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgYXJndW1lbnRzWzBdID0gYXJndW1lbnRzWzBdWzBdOwogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSk7CmFycmF5VHJhcHMyLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24oc3RhdGUsIHByb3ApIHsKICBpZiAoaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllMigxMyk7CiAgcmV0dXJuIGFycmF5VHJhcHMyLnNldC5jYWxsKHRoaXMsIHN0YXRlLCBwcm9wLCB2b2lkIDApOwp9OwphcnJheVRyYXBzMi5zZXQgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICBpZiAocHJvcCAhPT0gImxlbmd0aCIgJiYgaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllMigxNCk7CiAgcmV0dXJuIG9iamVjdFRyYXBzMi5zZXQuY2FsbCh0aGlzLCBzdGF0ZVswXSwgcHJvcCwgdmFsdWUsIHN0YXRlWzBdKTsKfTsKZnVuY3Rpb24gcGVlazIoZHJhZnQsIHByb3ApIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgY29uc3Qgc291cmNlID0gc3RhdGUgPyBsYXRlc3QyKHN0YXRlKSA6IGRyYWZ0OwogIHJldHVybiBzb3VyY2VbcHJvcF07Cn0KZnVuY3Rpb24gcmVhZFByb3BGcm9tUHJvdG8yKHN0YXRlLCBzb3VyY2UsIHByb3ApIHsKICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIoc291cmNlLCBwcm9wKTsKICByZXR1cm4gZGVzYyA/IGB2YWx1ZWAgaW4gZGVzYyA/IGRlc2MudmFsdWUgOiAoCiAgICAvLyBUaGlzIGlzIGEgdmVyeSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBwcm9wIGlzIGEgZ2V0dGVyIGRlZmluZWQgYnkgdGhlCiAgICAvLyBwcm90b3R5cGUsIHdlIHNob3VsZCBpbnZva2UgaXQgd2l0aCB0aGUgZHJhZnQgYXMgY29udGV4dCEKICAgIGRlc2MuZ2V0Py5jYWxsKHN0YXRlLmRyYWZ0XykKICApIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKHNvdXJjZSwgcHJvcCkgewogIGlmICghKHByb3AgaW4gc291cmNlKSkKICAgIHJldHVybiB2b2lkIDA7CiAgbGV0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihzb3VyY2UpOwogIHdoaWxlIChwcm90bzIpIHsKICAgIGNvbnN0IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvMiwgcHJvcCk7CiAgICBpZiAoZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIocHJvdG8yKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYXJrQ2hhbmdlZDIoc3RhdGUpIHsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgc3RhdGUubW9kaWZpZWRfID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5wYXJlbnRfKSB7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZS5wYXJlbnRfKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gcHJlcGFyZUNvcHkyKHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5jb3B5XykgewogICAgc3RhdGUuY29weV8gPSBzaGFsbG93Q29weTIoCiAgICAgIHN0YXRlLmJhc2VfLAogICAgICBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5XwogICAgKTsKICB9Cn0KdmFyIEltbWVyMjIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29uZmlnKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdHJ1ZTsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gZmFsc2U7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB0cnVlOwogICAgdGhpcy5wcm9kdWNlID0gKGJhc2UsIHJlY2lwZSwgcGF0Y2hMaXN0ZW5lcikgPT4gewogICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHJlY2lwZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNvbnN0IGRlZmF1bHRCYXNlID0gcmVjaXBlOwogICAgICAgIHJlY2lwZSA9IGJhc2U7CiAgICAgICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBjdXJyaWVkUHJvZHVjZShiYXNlMiA9IGRlZmF1bHRCYXNlLCAuLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gc2VsZjIucHJvZHVjZShiYXNlMiwgKGRyYWZ0KSA9PiByZWNpcGUuY2FsbCh0aGlzLCBkcmFmdCwgLi4uYXJncykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiByZWNpcGUgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgZGllMig2KTsKICAgICAgaWYgKHBhdGNoTGlzdGVuZXIgIT09IHZvaWQgMCAmJiB0eXBlb2YgcGF0Y2hMaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikKICAgICAgICBkaWUyKDcpOwogICAgICBsZXQgcmVzdWx0OwogICAgICBpZiAoaXNEcmFmdGFibGUyKGJhc2UpKSB7CiAgICAgICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlMih0aGlzKTsKICAgICAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5MihiYXNlLCB2b2lkIDApOwogICAgICAgIGxldCBoYXNFcnJvciA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc3VsdCA9IHJlY2lwZShwcm94eSk7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpCiAgICAgICAgICAgIHJldm9rZVNjb3BlMihzY29wZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGxlYXZlU2NvcGUyKHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgICAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdDIocmVzdWx0LCBzY29wZSk7CiAgICAgIH0gZWxzZSBpZiAoIWJhc2UgfHwgdHlwZW9mIGJhc2UgIT09ICJvYmplY3QiKSB7CiAgICAgICAgcmVzdWx0ID0gcmVjaXBlKGJhc2UpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkKICAgICAgICAgIHJlc3VsdCA9IGJhc2U7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gTk9USElORzIpCiAgICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRoaXMuYXV0b0ZyZWV6ZV8pCiAgICAgICAgICBmcmVlemUyKHJlc3VsdCwgdHJ1ZSk7CiAgICAgICAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgICAgICAgIGNvbnN0IHAgPSBbXTsKICAgICAgICAgIGNvbnN0IGlwID0gW107CiAgICAgICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKGJhc2UsIHJlc3VsdCwgcCwgaXApOwogICAgICAgICAgcGF0Y2hMaXN0ZW5lcihwLCBpcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZQogICAgICAgIGRpZTIoMSwgYmFzZSk7CiAgICB9OwogICAgdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMgPSAoYmFzZSwgcmVjaXBlKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiAoc3RhdGUsIC4uLmFyZ3MpID0+IHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzKHN0YXRlLCAoZHJhZnQpID0+IGJhc2UoZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgfQogICAgICBsZXQgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXM7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucHJvZHVjZShiYXNlLCByZWNpcGUsIChwLCBpcCkgPT4gewogICAgICAgIHBhdGNoZXMgPSBwOwogICAgICAgIGludmVyc2VQYXRjaGVzID0gaXA7CiAgICAgIH0pOwogICAgICByZXR1cm4gW3Jlc3VsdCwgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXNdOwogICAgfTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy5hdXRvRnJlZXplID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0QXV0b0ZyZWV6ZShjb25maWcuYXV0b0ZyZWV6ZSk7CiAgICBpZiAodHlwZW9mIGNvbmZpZz8udXNlU3RyaWN0U2hhbGxvd0NvcHkgPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RTaGFsbG93Q29weShjb25maWcudXNlU3RyaWN0U2hhbGxvd0NvcHkpOwogICAgaWYgKHR5cGVvZiBjb25maWc/LnVzZVN0cmljdEl0ZXJhdGlvbiA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldFVzZVN0cmljdEl0ZXJhdGlvbihjb25maWcudXNlU3RyaWN0SXRlcmF0aW9uKTsKICB9CiAgY3JlYXRlRHJhZnQoYmFzZSkgewogICAgaWYgKCFpc0RyYWZ0YWJsZTIoYmFzZSkpCiAgICAgIGRpZTIoOCk7CiAgICBpZiAoaXNEcmFmdDIoYmFzZSkpCiAgICAgIGJhc2UgPSBjdXJyZW50MihiYXNlKTsKICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZTIodGhpcyk7CiAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5MihiYXNlLCB2b2lkIDApOwogICAgcHJveHlbRFJBRlRfU1RBVEUyXS5pc01hbnVhbF8gPSB0cnVlOwogICAgbGVhdmVTY29wZTIoc2NvcGUpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmaW5pc2hEcmFmdChkcmFmdCwgcGF0Y2hMaXN0ZW5lcikgewogICAgY29uc3Qgc3RhdGUgPSBkcmFmdCAmJiBkcmFmdFtEUkFGVF9TVEFURTJdOwogICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuaXNNYW51YWxfKQogICAgICBkaWUyKDkpOwogICAgY29uc3QgeyBzY29wZV86IHNjb3BlIH0gPSBzdGF0ZTsKICAgIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdDIodm9pZCAwLCBzY29wZSk7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IGZyZWV6ZSBhbGwgY29waWVzIGNyZWF0ZWQgYnkgSW1tZXIuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBhdXRvLWZyZWV6aW5nIGlzIGVuYWJsZWQuCiAgICovCiAgc2V0QXV0b0ZyZWV6ZSh2YWx1ZSkgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gZW5hYmxlIHN0cmljdCBzaGFsbG93IGNvcHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBpbW1lciBkb2VzIG5vdCBjb3B5IHRoZSBvYmplY3QgZGVzY3JpcHRvcnMgc3VjaCBhcyBnZXR0ZXIsIHNldHRlciBhbmQgbm9uLWVudW1yYWJsZSBwcm9wZXJ0aWVzLgogICAqLwogIHNldFVzZVN0cmljdFNoYWxsb3dDb3B5KHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIGZhbHNlIHRvIHVzZSBmYXN0ZXIgaXRlcmF0aW9uIHRoYXQgc2tpcHMgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcwogICAqIGJ1dCBzdGlsbCBoYW5kbGVzIHN5bWJvbHMgZm9yIGNvbXBhdGliaWxpdHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBzdHJpY3QgaXRlcmF0aW9uIGlzIGVuYWJsZWQgKGluY2x1ZGVzIGFsbCBvd24gcHJvcGVydGllcykuCiAgICovCiAgc2V0VXNlU3RyaWN0SXRlcmF0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB2YWx1ZTsKICB9CiAgc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXzsKICB9CiAgYXBwbHlQYXRjaGVzKGJhc2UsIHBhdGNoZXMpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gcGF0Y2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwYXRjaCA9IHBhdGNoZXNbaV07CiAgICAgIGlmIChwYXRjaC5wYXRoLmxlbmd0aCA9PT0gMCAmJiBwYXRjaC5vcCA9PT0gInJlcGxhY2UiKSB7CiAgICAgICAgYmFzZSA9IHBhdGNoLnZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIHBhdGNoZXMgPSBwYXRjaGVzLnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIGNvbnN0IGFwcGx5UGF0Y2hlc0ltcGwgPSBnZXRQbHVnaW4yKCJQYXRjaGVzIikuYXBwbHlQYXRjaGVzXzsKICAgIGlmIChpc0RyYWZ0MihiYXNlKSkgewogICAgICByZXR1cm4gYXBwbHlQYXRjaGVzSW1wbChiYXNlLCBwYXRjaGVzKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb2R1Y2UoCiAgICAgIGJhc2UsCiAgICAgIChkcmFmdCkgPT4gYXBwbHlQYXRjaGVzSW1wbChkcmFmdCwgcGF0Y2hlcykKICAgICk7CiAgfQp9OwpmdW5jdGlvbiBjcmVhdGVQcm94eTIodmFsdWUsIHBhcmVudCkgewogIGNvbnN0IGRyYWZ0ID0gaXNNYXAyKHZhbHVlKSA/IGdldFBsdWdpbjIoIk1hcFNldCIpLnByb3h5TWFwXyh2YWx1ZSwgcGFyZW50KSA6IGlzU2V0Mih2YWx1ZSkgPyBnZXRQbHVnaW4yKCJNYXBTZXQiKS5wcm94eVNldF8odmFsdWUsIHBhcmVudCkgOiBjcmVhdGVQcm94eVByb3h5Mih2YWx1ZSwgcGFyZW50KTsKICBjb25zdCBzY29wZSA9IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUyKCk7CiAgc2NvcGUuZHJhZnRzXy5wdXNoKGRyYWZ0KTsKICByZXR1cm4gZHJhZnQ7Cn0KZnVuY3Rpb24gY3VycmVudDIodmFsdWUpIHsKICBpZiAoIWlzRHJhZnQyKHZhbHVlKSkKICAgIGRpZTIoMTAsIHZhbHVlKTsKICByZXR1cm4gY3VycmVudEltcGwyKHZhbHVlKTsKfQpmdW5jdGlvbiBjdXJyZW50SW1wbDIodmFsdWUpIHsKICBpZiAoIWlzRHJhZnRhYmxlMih2YWx1ZSkgfHwgaXNGcm96ZW4yKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFMl07CiAgbGV0IGNvcHkzOwogIGxldCBzdHJpY3QgPSB0cnVlOwogIGlmIChzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pCiAgICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgY29weTMgPSBzaGFsbG93Q29weTIodmFsdWUsIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfKTsKICAgIHN0cmljdCA9IHN0YXRlLnNjb3BlXy5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkyKHZhbHVlLCB0cnVlKTsKICB9CiAgZWFjaDIoCiAgICBjb3B5MywKICAgIChrZXksIGNoaWxkVmFsdWUpID0+IHsKICAgICAgc2V0Mihjb3B5Mywga2V5LCBjdXJyZW50SW1wbDIoY2hpbGRWYWx1ZSkpOwogICAgfSwKICAgIHN0cmljdAogICk7CiAgaWYgKHN0YXRlKSB7CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gZmFsc2U7CiAgfQogIHJldHVybiBjb3B5MzsKfQp2YXIgaW1tZXIyID0gbmV3IEltbWVyMjIoKTsKdmFyIHByb2R1Y2UyID0gaW1tZXIyLnByb2R1Y2U7CmZ1bmN0aW9uIGNhc3REcmFmdCh2YWx1ZSkgewogIHJldHVybiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbGVnZW5kU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTIgPSB7CiAgc2V0dGluZ3M6IHsKICAgIGxheW91dDogImhvcml6b250YWwiLAogICAgYWxpZ246ICJjZW50ZXIiLAogICAgdmVydGljYWxBbGlnbjogIm1pZGRsZSIsCiAgICBpdGVtU29ydGVyOiAidmFsdWUiCiAgfSwKICBzaXplOiB7CiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH0sCiAgcGF5bG9hZDogW10KfTsKdmFyIGxlZ2VuZFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJsZWdlbmQiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMiwKICByZWR1Y2VyczogewogICAgc2V0TGVnZW5kU2l6ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNpemUud2lkdGggPSBhY3Rpb24ucGF5bG9hZC53aWR0aDsKICAgICAgc3RhdGUuc2l6ZS5oZWlnaHQgPSBhY3Rpb24ucGF5bG9hZC5oZWlnaHQ7CiAgICB9LAogICAgc2V0TGVnZW5kU2V0dGluZ3Moc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zZXR0aW5ncy5hbGlnbiA9IGFjdGlvbi5wYXlsb2FkLmFsaWduOwogICAgICBzdGF0ZS5zZXR0aW5ncy5sYXlvdXQgPSBhY3Rpb24ucGF5bG9hZC5sYXlvdXQ7CiAgICAgIHN0YXRlLnNldHRpbmdzLnZlcnRpY2FsQWxpZ24gPSBhY3Rpb24ucGF5bG9hZC52ZXJ0aWNhbEFsaWduOwogICAgICBzdGF0ZS5zZXR0aW5ncy5pdGVtU29ydGVyID0gYWN0aW9uLnBheWxvYWQuaXRlbVNvcnRlcjsKICAgIH0sCiAgICBhZGRMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnBheWxvYWQucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucGF5bG9hZC5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBheWxvYWRbaW5kZXhdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBheWxvYWQuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUucGF5bG9hZC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIHNldExlZ2VuZFNpemUsCiAgc2V0TGVnZW5kU2V0dGluZ3MsCiAgYWRkTGVnZW5kUGF5bG9hZCwKICByZXBsYWNlTGVnZW5kUGF5bG9hZCwKICByZW1vdmVMZWdlbmRQYXlsb2FkCn0gPSBsZWdlbmRTbGljZS5hY3Rpb25zOwp2YXIgbGVnZW5kUmVkdWNlciA9IGxlZ2VuZFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwp2YXIgUmVhY3QxMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0X2RvbTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0RlZmF1bHRUb29sdGlwQ29udGVudC5qcwp2YXIgUmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3NvcnRCeTMgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKZnVuY3Rpb24gX2V4dGVuZHM0KCkgewogIHJldHVybiBfZXh0ZW5kczQgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTUoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBkZWZhdWx0Rm9ybWF0dGVyKHZhbHVlKSB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGlzTnVtT3JTdHIodmFsdWVbMF0pICYmIGlzTnVtT3JTdHIodmFsdWVbMV0pID8gdmFsdWUuam9pbigiIH4gIikgOiB2YWx1ZTsKfQp2YXIgRGVmYXVsdFRvb2x0aXBDb250ZW50ID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHNlcGFyYXRvciA9ICIgOiAiLAogICAgY29udGVudFN0eWxlID0ge30sCiAgICBpdGVtU3R5bGUgPSB7fSwKICAgIGxhYmVsU3R5bGUgPSB7fSwKICAgIHBheWxvYWQsCiAgICBmb3JtYXR0ZXIsCiAgICBpdGVtU29ydGVyLAogICAgd3JhcHBlckNsYXNzTmFtZSwKICAgIGxhYmVsQ2xhc3NOYW1lLAogICAgbGFiZWwsCiAgICBsYWJlbEZvcm1hdHRlciwKICAgIGFjY2Vzc2liaWxpdHlMYXllciA9IGZhbHNlCiAgfSA9IHByb3BzOwogIHZhciByZW5kZXJDb250ZW50MiA9ICgpID0+IHsKICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQubGVuZ3RoKSB7CiAgICAgIHZhciBsaXN0U3R5bGUgPSB7CiAgICAgICAgcGFkZGluZzogMCwKICAgICAgICBtYXJnaW46IDAKICAgICAgfTsKICAgICAgdmFyIGl0ZW1zID0gKGl0ZW1Tb3J0ZXIgPyAoMCwgaW1wb3J0X3NvcnRCeTMuZGVmYXVsdCkocGF5bG9hZCwgaXRlbVNvcnRlcikgOiBwYXlsb2FkKS5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICAgICAgaWYgKGVudHJ5LnR5cGUgPT09ICJub25lIikgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmaW5hbEZvcm1hdHRlciA9IGVudHJ5LmZvcm1hdHRlciB8fCBmb3JtYXR0ZXIgfHwgZGVmYXVsdEZvcm1hdHRlcjsKICAgICAgICB2YXIgewogICAgICAgICAgdmFsdWUsCiAgICAgICAgICBuYW1lCiAgICAgICAgfSA9IGVudHJ5OwogICAgICAgIHZhciBmaW5hbFZhbHVlID0gdmFsdWU7CiAgICAgICAgdmFyIGZpbmFsTmFtZSA9IG5hbWU7CiAgICAgICAgaWYgKGZpbmFsRm9ybWF0dGVyKSB7CiAgICAgICAgICB2YXIgZm9ybWF0dGVkID0gZmluYWxGb3JtYXR0ZXIodmFsdWUsIG5hbWUsIGVudHJ5LCBpLCBwYXlsb2FkKTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGZvcm1hdHRlZCkpIHsKICAgICAgICAgICAgW2ZpbmFsVmFsdWUsIGZpbmFsTmFtZV0gPSBmb3JtYXR0ZWQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdHRlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBmb3JtYXR0ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZpbmFsSXRlbVN0eWxlID0gX29iamVjdFNwcmVhZDUoewogICAgICAgICAgZGlzcGxheTogImJsb2NrIiwKICAgICAgICAgIHBhZGRpbmdUb3A6IDQsCiAgICAgICAgICBwYWRkaW5nQm90dG9tOiA0LAogICAgICAgICAgY29sb3I6IGVudHJ5LmNvbG9yIHx8ICIjMDAwIgogICAgICAgIH0sIGl0ZW1TdHlsZSk7CiAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgibGkiLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0iLAogICAgICAgICAga2V5OiAidG9vbHRpcC1pdGVtLSIuY29uY2F0KGkpLAogICAgICAgICAgc3R5bGU6IGZpbmFsSXRlbVN0eWxlCiAgICAgICAgfSwgaXNOdW1PclN0cihmaW5hbE5hbWUpID8gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLW5hbWUiCiAgICAgICAgfSwgZmluYWxOYW1lKSA6IG51bGwsIGlzTnVtT3JTdHIoZmluYWxOYW1lKSA/IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1zZXBhcmF0b3IiCiAgICAgICAgfSwgc2VwYXJhdG9yKSA6IG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS12YWx1ZSIKICAgICAgICB9LCBmaW5hbFZhbHVlKSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXVuaXQiCiAgICAgICAgfSwgZW50cnkudW5pdCB8fCAiIikpOwogICAgICB9KTsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgidWwiLCB7CiAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLWxpc3QiLAogICAgICAgIHN0eWxlOiBsaXN0U3R5bGUKICAgICAgfSwgaXRlbXMpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfTsKICB2YXIgZmluYWxTdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgIG1hcmdpbjogMCwKICAgIHBhZGRpbmc6IDEwLAogICAgYmFja2dyb3VuZENvbG9yOiAiI2ZmZiIsCiAgICBib3JkZXI6ICIxcHggc29saWQgI2NjYyIsCiAgICB3aGl0ZVNwYWNlOiAibm93cmFwIgogIH0sIGNvbnRlbnRTdHlsZSk7CiAgdmFyIGZpbmFsTGFiZWxTdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgIG1hcmdpbjogMAogIH0sIGxhYmVsU3R5bGUpOwogIHZhciBoYXNMYWJlbCA9ICFpc051bGxpc2gobGFiZWwpOwogIHZhciBmaW5hbExhYmVsID0gaGFzTGFiZWwgPyBsYWJlbCA6ICIiOwogIHZhciB3cmFwcGVyQ04gPSBjbHN4KCJyZWNoYXJ0cy1kZWZhdWx0LXRvb2x0aXAiLCB3cmFwcGVyQ2xhc3NOYW1lKTsKICB2YXIgbGFiZWxDTiA9IGNsc3goInJlY2hhcnRzLXRvb2x0aXAtbGFiZWwiLCBsYWJlbENsYXNzTmFtZSk7CiAgaWYgKGhhc0xhYmVsICYmIGxhYmVsRm9ybWF0dGVyICYmIHBheWxvYWQgIT09IHZvaWQgMCAmJiBwYXlsb2FkICE9PSBudWxsKSB7CiAgICBmaW5hbExhYmVsID0gbGFiZWxGb3JtYXR0ZXIobGFiZWwsIHBheWxvYWQpOwogIH0KICB2YXIgYWNjZXNzaWJpbGl0eUF0dHJpYnV0ZXMgPSBhY2Nlc3NpYmlsaXR5TGF5ZXIgPyB7CiAgICByb2xlOiAic3RhdHVzIiwKICAgICJhcmlhLWxpdmUiOiAiYXNzZXJ0aXZlIgogIH0gOiB7fTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczQoewogICAgY2xhc3NOYW1lOiB3cmFwcGVyQ04sCiAgICBzdHlsZTogZmluYWxTdHlsZQogIH0sIGFjY2Vzc2liaWxpdHlBdHRyaWJ1dGVzKSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJwIiwgewogICAgY2xhc3NOYW1lOiBsYWJlbENOLAogICAgc3R5bGU6IGZpbmFsTGFiZWxTdHlsZQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuaXNWYWxpZEVsZW1lbnQoZmluYWxMYWJlbCkgPyBmaW5hbExhYmVsIDogIiIuY29uY2F0KGZpbmFsTGFiZWwpKSwgcmVuZGVyQ29udGVudDIoKSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcEJvdW5kaW5nQm94LmpzCnZhciBSZWFjdDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdG9vbHRpcC90cmFuc2xhdGUuanMKdmFyIENTU19DTEFTU19QUkVGSVggPSAicmVjaGFydHMtdG9vbHRpcC13cmFwcGVyIjsKdmFyIFRPT0xUSVBfSElEREVOID0gewogIHZpc2liaWxpdHk6ICJoaWRkZW4iCn07CmZ1bmN0aW9uIGdldFRvb2x0aXBDU1NDbGFzc05hbWUoX3JlZjIpIHsKICB2YXIgewogICAgY29vcmRpbmF0ZSwKICAgIHRyYW5zbGF0ZVgsCiAgICB0cmFuc2xhdGVZCiAgfSA9IF9yZWYyOwogIHJldHVybiBjbHN4KENTU19DTEFTU19QUkVGSVgsIHsKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1yaWdodCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWCkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLngpICYmIHRyYW5zbGF0ZVggPj0gY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWxlZnQiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVgpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS54KSAmJiB0cmFuc2xhdGVYIDwgY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWJvdHRvbSIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPj0gY29vcmRpbmF0ZS55LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLXRvcCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPCBjb29yZGluYXRlLnkKICB9KTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlWFkoX3JlZjIpIHsKICB2YXIgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgY29vcmRpbmF0ZSwKICAgIGtleSwKICAgIG9mZnNldFRvcExlZnQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB0b29sdGlwRGltZW5zaW9uLAogICAgdmlld0JveCwKICAgIHZpZXdCb3hEaW1lbnNpb24KICB9ID0gX3JlZjI7CiAgaWYgKHBvc2l0aW9uICYmIGlzTnVtYmVyKHBvc2l0aW9uW2tleV0pKSB7CiAgICByZXR1cm4gcG9zaXRpb25ba2V5XTsKICB9CiAgdmFyIG5lZ2F0aXZlID0gY29vcmRpbmF0ZVtrZXldIC0gdG9vbHRpcERpbWVuc2lvbiAtIChvZmZzZXRUb3BMZWZ0ID4gMCA/IG9mZnNldFRvcExlZnQgOiAwKTsKICB2YXIgcG9zaXRpdmUgPSBjb29yZGluYXRlW2tleV0gKyBvZmZzZXRUb3BMZWZ0OwogIGlmIChhbGxvd0VzY2FwZVZpZXdCb3hba2V5XSkgewogICAgcmV0dXJuIHJldmVyc2VEaXJlY3Rpb25ba2V5XSA/IG5lZ2F0aXZlIDogcG9zaXRpdmU7CiAgfQogIHZhciB2aWV3Qm94S2V5ID0gdmlld0JveFtrZXldOwogIGlmICh2aWV3Qm94S2V5ID09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAocmV2ZXJzZURpcmVjdGlvbltrZXldKSB7CiAgICB2YXIgX3Rvb2x0aXBCb3VuZGFyeSA9IG5lZ2F0aXZlOwogICAgdmFyIF92aWV3Qm94Qm91bmRhcnkgPSB2aWV3Qm94S2V5OwogICAgaWYgKF90b29sdGlwQm91bmRhcnkgPCBfdmlld0JveEJvdW5kYXJ5KSB7CiAgICAgIHJldHVybiBNYXRoLm1heChwb3NpdGl2ZSwgdmlld0JveEtleSk7CiAgICB9CiAgICByZXR1cm4gTWF0aC5tYXgobmVnYXRpdmUsIHZpZXdCb3hLZXkpOwogIH0KICBpZiAodmlld0JveERpbWVuc2lvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgdmFyIHRvb2x0aXBCb3VuZGFyeSA9IHBvc2l0aXZlICsgdG9vbHRpcERpbWVuc2lvbjsKICB2YXIgdmlld0JveEJvdW5kYXJ5ID0gdmlld0JveEtleSArIHZpZXdCb3hEaW1lbnNpb247CiAgaWYgKHRvb2x0aXBCb3VuZGFyeSA+IHZpZXdCb3hCb3VuZGFyeSkgewogICAgcmV0dXJuIE1hdGgubWF4KG5lZ2F0aXZlLCB2aWV3Qm94S2V5KTsKICB9CiAgcmV0dXJuIE1hdGgubWF4KHBvc2l0aXZlLCB2aWV3Qm94S2V5KTsKfQpmdW5jdGlvbiBnZXRUcmFuc2Zvcm1TdHlsZShfcmVmMykgewogIHZhciB7CiAgICB0cmFuc2xhdGVYLAogICAgdHJhbnNsYXRlWSwKICAgIHVzZVRyYW5zbGF0ZTNkCiAgfSA9IF9yZWYzOwogIHJldHVybiB7CiAgICB0cmFuc2Zvcm06IHVzZVRyYW5zbGF0ZTNkID8gInRyYW5zbGF0ZTNkKCIuY29uY2F0KHRyYW5zbGF0ZVgsICJweCwgIikuY29uY2F0KHRyYW5zbGF0ZVksICJweCwgMCkiKSA6ICJ0cmFuc2xhdGUoIi5jb25jYXQodHJhbnNsYXRlWCwgInB4LCAiKS5jb25jYXQodHJhbnNsYXRlWSwgInB4KSIpCiAgfTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlKF9yZWY0KSB7CiAgdmFyIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGNvb3JkaW5hdGUsCiAgICBvZmZzZXRUb3BMZWZ0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdG9vbHRpcEJveCwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgdmlld0JveAogIH0gPSBfcmVmNDsKICB2YXIgY3NzUHJvcGVydGllcywgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWTsKICBpZiAodG9vbHRpcEJveC5oZWlnaHQgPiAwICYmIHRvb2x0aXBCb3gud2lkdGggPiAwICYmIGNvb3JkaW5hdGUpIHsKICAgIHRyYW5zbGF0ZVggPSBnZXRUb29sdGlwVHJhbnNsYXRlWFkoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGtleTogIngiLAogICAgICBvZmZzZXRUb3BMZWZ0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcERpbWVuc2lvbjogdG9vbHRpcEJveC53aWR0aCwKICAgICAgdmlld0JveCwKICAgICAgdmlld0JveERpbWVuc2lvbjogdmlld0JveC53aWR0aAogICAgfSk7CiAgICB0cmFuc2xhdGVZID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBrZXk6ICJ5IiwKICAgICAgb2Zmc2V0VG9wTGVmdCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBEaW1lbnNpb246IHRvb2x0aXBCb3guaGVpZ2h0LAogICAgICB2aWV3Qm94LAogICAgICB2aWV3Qm94RGltZW5zaW9uOiB2aWV3Qm94LmhlaWdodAogICAgfSk7CiAgICBjc3NQcm9wZXJ0aWVzID0gZ2V0VHJhbnNmb3JtU3R5bGUoewogICAgICB0cmFuc2xhdGVYLAogICAgICB0cmFuc2xhdGVZLAogICAgICB1c2VUcmFuc2xhdGUzZAogICAgfSk7CiAgfSBlbHNlIHsKICAgIGNzc1Byb3BlcnRpZXMgPSBUT09MVElQX0hJRERFTjsKICB9CiAgcmV0dXJuIHsKICAgIGNzc1Byb3BlcnRpZXMsCiAgICBjc3NDbGFzc2VzOiBnZXRUb29sdGlwQ1NTQ2xhc3NOYW1lKHsKICAgICAgdHJhbnNsYXRlWCwKICAgICAgdHJhbnNsYXRlWSwKICAgICAgY29vcmRpbmF0ZQogICAgfSkKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcEJvdW5kaW5nQm94LmpzCmZ1bmN0aW9uIG93bktleXM2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTYoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTYocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTYodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBUb29sdGlwQm91bmRpbmdCb3ggPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDE0LlB1cmVDb21wb25lbnQgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIF9kZWZpbmVQcm9wZXJ0eTYodGhpcywgInN0YXRlIiwgewogICAgICBkaXNtaXNzZWQ6IGZhbHNlLAogICAgICBkaXNtaXNzZWRBdENvb3JkaW5hdGU6IHsKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAKICAgICAgfQogICAgfSk7CiAgICBfZGVmaW5lUHJvcGVydHk2KHRoaXMsICJoYW5kbGVLZXlEb3duIiwgKGV2ZW50KSA9PiB7CiAgICAgIGlmIChldmVudC5rZXkgPT09ICJFc2NhcGUiKSB7CiAgICAgICAgdmFyIF90aGlzJHByb3BzJGNvb3JkaW5hdCwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MiwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MywgX3RoaXMkcHJvcHMkY29vcmRpbmF0NDsKICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGRpc21pc3NlZDogdHJ1ZSwKICAgICAgICAgIGRpc21pc3NlZEF0Q29vcmRpbmF0ZTogewogICAgICAgICAgICB4OiAoX3RoaXMkcHJvcHMkY29vcmRpbmF0ID0gKF90aGlzJHByb3BzJGNvb3JkaW5hdDIgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDIueCkgIT09IG51bGwgJiYgX3RoaXMkcHJvcHMkY29vcmRpbmF0ICE9PSB2b2lkIDAgPyBfdGhpcyRwcm9wcyRjb29yZGluYXQgOiAwLAogICAgICAgICAgICB5OiAoX3RoaXMkcHJvcHMkY29vcmRpbmF0MyA9IChfdGhpcyRwcm9wcyRjb29yZGluYXQ0ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ0LnkpICE9PSBudWxsICYmIF90aGlzJHByb3BzJGNvb3JkaW5hdDMgIT09IHZvaWQgMCA/IF90aGlzJHByb3BzJGNvb3JkaW5hdDMgOiAwCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb21wb25lbnREaWRNb3VudCgpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmhhbmRsZUtleURvd24pOwogIH0KICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmhhbmRsZUtleURvd24pOwogIH0KICBjb21wb25lbnREaWRVcGRhdGUoKSB7CiAgICB2YXIgX3RoaXMkcHJvcHMkY29vcmRpbmF0NSwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NjsKICAgIGlmICghdGhpcy5zdGF0ZS5kaXNtaXNzZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCgoX3RoaXMkcHJvcHMkY29vcmRpbmF0NSA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0NS54KSAhPT0gdGhpcy5zdGF0ZS5kaXNtaXNzZWRBdENvb3JkaW5hdGUueCB8fCAoKF90aGlzJHByb3BzJGNvb3JkaW5hdDYgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDYueSkgIT09IHRoaXMuc3RhdGUuZGlzbWlzc2VkQXRDb29yZGluYXRlLnkpIHsKICAgICAgdGhpcy5zdGF0ZS5kaXNtaXNzZWQgPSBmYWxzZTsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgdmFyIHsKICAgICAgYWN0aXZlLAogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgICBhbmltYXRpb25FYXNpbmcsCiAgICAgIGNoaWxkcmVuLAogICAgICBjb29yZGluYXRlLAogICAgICBoYXNQYXlsb2FkLAogICAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgICAgb2Zmc2V0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdXNlVHJhbnNsYXRlM2QsCiAgICAgIHZpZXdCb3gsCiAgICAgIHdyYXBwZXJTdHlsZSwKICAgICAgbGFzdEJvdW5kaW5nQm94LAogICAgICBpbm5lclJlZiwKICAgICAgaGFzUG9ydGFsRnJvbVByb3BzCiAgICB9ID0gdGhpcy5wcm9wczsKICAgIHZhciB7CiAgICAgIGNzc0NsYXNzZXMsCiAgICAgIGNzc1Byb3BlcnRpZXMKICAgIH0gPSBnZXRUb29sdGlwVHJhbnNsYXRlKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBvZmZzZXRUb3BMZWZ0OiBvZmZzZXQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB0b29sdGlwQm94OiB7CiAgICAgICAgaGVpZ2h0OiBsYXN0Qm91bmRpbmdCb3guaGVpZ2h0LAogICAgICAgIHdpZHRoOiBsYXN0Qm91bmRpbmdCb3gud2lkdGgKICAgICAgfSwKICAgICAgdXNlVHJhbnNsYXRlM2QsCiAgICAgIHZpZXdCb3gKICAgIH0pOwogICAgdmFyIHBvc2l0aW9uU3R5bGVzID0gaGFzUG9ydGFsRnJvbVByb3BzID8ge30gOiBfb2JqZWN0U3ByZWFkNihfb2JqZWN0U3ByZWFkNih7CiAgICAgIHRyYW5zaXRpb246IGlzQW5pbWF0aW9uQWN0aXZlICYmIGFjdGl2ZSA/ICJ0cmFuc2Zvcm0gIi5jb25jYXQoYW5pbWF0aW9uRHVyYXRpb24sICJtcyAiKS5jb25jYXQoYW5pbWF0aW9uRWFzaW5nKSA6IHZvaWQgMAogICAgfSwgY3NzUHJvcGVydGllcyksIHt9LCB7CiAgICAgIHBvaW50ZXJFdmVudHM6ICJub25lIiwKICAgICAgdmlzaWJpbGl0eTogIXRoaXMuc3RhdGUuZGlzbWlzc2VkICYmIGFjdGl2ZSAmJiBoYXNQYXlsb2FkID8gInZpc2libGUiIDogImhpZGRlbiIsCiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6IDAsCiAgICAgIGxlZnQ6IDAKICAgIH0pOwogICAgdmFyIG91dGVyU3R5bGUgPSBfb2JqZWN0U3ByZWFkNihfb2JqZWN0U3ByZWFkNih7fSwgcG9zaXRpb25TdHlsZXMpLCB7fSwgewogICAgICB2aXNpYmlsaXR5OiAhdGhpcy5zdGF0ZS5kaXNtaXNzZWQgJiYgYWN0aXZlICYmIGhhc1BheWxvYWQgPyAidmlzaWJsZSIgOiAiaGlkZGVuIgogICAgfSwgd3JhcHBlclN0eWxlKTsKICAgIHJldHVybiAoCiAgICAgIC8vIFRoaXMgZWxlbWVudCBhbGxvdyBsaXN0ZW5pbmcgdG8gdGhlIGBFc2NhcGVgIGtleS4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzI5MjUKICAgICAgLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0eXBlc2NyaXB0IGxpYnJhcnkgZG9lcyBub3QgcmVjb2duaXplIHhtbG5zIGF0dHJpYnV0ZSwgYnV0IGl0J3MgcmVxdWlyZWQgZm9yIGFuIEhUTUwgY2h1bmsgaW5zaWRlIFNWRy4KICAgICAgICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiLAogICAgICAgIHRhYkluZGV4OiAtMSwKICAgICAgICBjbGFzc05hbWU6IGNzc0NsYXNzZXMsCiAgICAgICAgc3R5bGU6IG91dGVyU3R5bGUsCiAgICAgICAgcmVmOiBpbm5lclJlZgogICAgICB9LCBjaGlsZHJlbikKICAgICk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9hY2Nlc3NpYmlsaXR5Q29udGV4dC5qcwp2YXIgdXNlQWNjZXNzaWJpbGl0eUxheWVyID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgcmV0dXJuIChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHRydWU7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ3Vyc29yLmpzCnZhciBSZWFjdDExID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9DdXJ2ZS5qcwp2YXIgUmVhY3Q3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczUoKSB7CiAgcmV0dXJuIF9leHRlbmRzNSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM3KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBDVVJWRV9GQUNUT1JJRVMgPSB7CiAgY3VydmVCYXNpc0Nsb3NlZDogYmFzaXNDbG9zZWRfZGVmYXVsdCwKICBjdXJ2ZUJhc2lzT3BlbjogYmFzaXNPcGVuX2RlZmF1bHQsCiAgY3VydmVCYXNpczogYmFzaXNfZGVmYXVsdCwKICBjdXJ2ZUJ1bXBYOiBidW1wWCwKICBjdXJ2ZUJ1bXBZOiBidW1wWSwKICBjdXJ2ZUxpbmVhckNsb3NlZDogbGluZWFyQ2xvc2VkX2RlZmF1bHQsCiAgY3VydmVMaW5lYXI6IGxpbmVhcl9kZWZhdWx0LAogIGN1cnZlTW9ub3RvbmVYOiBtb25vdG9uZVgsCiAgY3VydmVNb25vdG9uZVk6IG1vbm90b25lWSwKICBjdXJ2ZU5hdHVyYWw6IG5hdHVyYWxfZGVmYXVsdCwKICBjdXJ2ZVN0ZXA6IHN0ZXBfZGVmYXVsdCwKICBjdXJ2ZVN0ZXBBZnRlcjogc3RlcEFmdGVyLAogIGN1cnZlU3RlcEJlZm9yZTogc3RlcEJlZm9yZQp9Owp2YXIgZGVmaW5lZCA9IChwKSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHAueCkgJiYgaXNXZWxsQmVoYXZlZE51bWJlcihwLnkpOwp2YXIgYXJlYURlZmluZWQgPSAoZCkgPT4gZC5iYXNlICE9IG51bGwgJiYgZGVmaW5lZChkLmJhc2UpICYmIGRlZmluZWQoZCk7CnZhciBnZXRYID0gKHApID0+IHAueDsKdmFyIGdldFkgPSAocCkgPT4gcC55Owp2YXIgZ2V0Q3VydmVGYWN0b3J5ID0gKHR5cGUsIGxheW91dCkgPT4gewogIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIHR5cGU7CiAgfQogIHZhciBuYW1lID0gImN1cnZlIi5jb25jYXQodXBwZXJGaXJzdCh0eXBlKSk7CiAgaWYgKChuYW1lID09PSAiY3VydmVNb25vdG9uZSIgfHwgbmFtZSA9PT0gImN1cnZlQnVtcCIpICYmIGxheW91dCkgewogICAgcmV0dXJuIENVUlZFX0ZBQ1RPUklFU1siIi5jb25jYXQobmFtZSkuY29uY2F0KGxheW91dCA9PT0gInZlcnRpY2FsIiA/ICJZIiA6ICJYIildOwogIH0KICByZXR1cm4gQ1VSVkVfRkFDVE9SSUVTW25hbWVdIHx8IGxpbmVhcl9kZWZhdWx0Owp9Owp2YXIgZ2V0UGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB0eXBlID0gImxpbmVhciIsCiAgICBwb2ludHMgPSBbXSwKICAgIGJhc2VMaW5lLAogICAgbGF5b3V0LAogICAgY29ubmVjdE51bGxzID0gZmFsc2UKICB9ID0gX3JlZjI7CiAgdmFyIGN1cnZlRmFjdG9yeSA9IGdldEN1cnZlRmFjdG9yeSh0eXBlLCBsYXlvdXQpOwogIHZhciBmb3JtYXRQb2ludHMgPSBjb25uZWN0TnVsbHMgPyBwb2ludHMuZmlsdGVyKGRlZmluZWQpIDogcG9pbnRzOwogIHZhciBsaW5lRnVuY3Rpb247CiAgaWYgKEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpKSB7CiAgICB2YXIgYXJlYVBvaW50cyA9IHBvaW50cy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gX29iamVjdFNwcmVhZDcoX29iamVjdFNwcmVhZDcoe30sIGVudHJ5KSwge30sIHsKICAgICAgYmFzZTogYmFzZUxpbmVbaW5kZXhdCiAgICB9KSk7CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLnkoZ2V0WSkueDEoZ2V0WCkueDAoKGQpID0+IGQuYmFzZS54KTsKICAgIH0gZWxzZSB7CiAgICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLngoZ2V0WCkueTEoZ2V0WSkueTAoKGQpID0+IGQuYmFzZS55KTsKICAgIH0KICAgIHZhciBfbnVsbGFibGVMaW5lRnVuY3Rpb24gPSBsaW5lRnVuY3Rpb24uZGVmaW5lZChhcmVhRGVmaW5lZCkuY3VydmUoY3VydmVGYWN0b3J5KTsKICAgIHZhciBmaW5hbFBvaW50cyA9IGNvbm5lY3ROdWxscyA/IGFyZWFQb2ludHMuZmlsdGVyKGFyZWFEZWZpbmVkKSA6IGFyZWFQb2ludHM7CiAgICByZXR1cm4gX251bGxhYmxlTGluZUZ1bmN0aW9uKGZpbmFsUG9pbnRzKTsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBpc051bWJlcihiYXNlTGluZSkpIHsKICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLnkoZ2V0WSkueDEoZ2V0WCkueDAoYmFzZUxpbmUpOwogIH0gZWxzZSBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS54KGdldFgpLnkxKGdldFkpLnkwKGJhc2VMaW5lKTsKICB9IGVsc2UgewogICAgbGluZUZ1bmN0aW9uID0gbGluZV9kZWZhdWx0KCkueChnZXRYKS55KGdldFkpOwogIH0KICB2YXIgbnVsbGFibGVMaW5lRnVuY3Rpb24gPSBsaW5lRnVuY3Rpb24uZGVmaW5lZChkZWZpbmVkKS5jdXJ2ZShjdXJ2ZUZhY3RvcnkpOwogIHJldHVybiBudWxsYWJsZUxpbmVGdW5jdGlvbihmb3JtYXRQb2ludHMpOwp9Owp2YXIgQ3VydmUgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY2xhc3NOYW1lLAogICAgcG9pbnRzLAogICAgcGF0aDogcGF0aDIsCiAgICBwYXRoUmVmCiAgfSA9IHByb3BzOwogIGlmICgoIXBvaW50cyB8fCAhcG9pbnRzLmxlbmd0aCkgJiYgIXBhdGgyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJlYWxQYXRoID0gcG9pbnRzICYmIHBvaW50cy5sZW5ndGggPyBnZXRQYXRoKHByb3BzKSA6IHBhdGgyOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q3LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczUoe30sIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyksIGFkYXB0RXZlbnRIYW5kbGVycyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY3VydmUiLCBjbGFzc05hbWUpLAogICAgZDogcmVhbFBhdGggPT09IG51bGwgPyB2b2lkIDAgOiByZWFsUGF0aCwKICAgIHJlZjogcGF0aFJlZgogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0Nyb3NzLmpzCnZhciBSZWFjdDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQzID0gWyJ4IiwgInkiLCAidG9wIiwgImxlZnQiLCAid2lkdGgiLCAiaGVpZ2h0IiwgImNsYXNzTmFtZSJdOwpmdW5jdGlvbiBfZXh0ZW5kczYoKSB7CiAgcmV0dXJuIF9leHRlbmRzNiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czgoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTgoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5OChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTgocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5OCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTgodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBnZXRQYXRoMiA9ICh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCkgPT4gewogIHJldHVybiAiTSIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh0b3AsICJ2IikuY29uY2F0KGhlaWdodCwgIk0iKS5jb25jYXQobGVmdCwgIiwiKS5jb25jYXQoeTIsICJoIikuY29uY2F0KHdpZHRoKTsKfTsKdmFyIENyb3NzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyID0gMCwKICAgIHk6IHkyID0gMCwKICAgIHRvcCA9IDAsCiAgICBsZWZ0ID0gMCwKICAgIHdpZHRoID0gMCwKICAgIGhlaWdodCA9IDAsCiAgICBjbGFzc05hbWUKICB9ID0gX3JlZjIsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMzKF9yZWYyLCBfZXhjbHVkZWQzKTsKICB2YXIgcHJvcHMgPSBfb2JqZWN0U3ByZWFkOCh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdG9wLAogICAgbGVmdCwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSwgcmVzdCk7CiAgaWYgKCFpc051bWJlcih4MikgfHwgIWlzTnVtYmVyKHkyKSB8fCAhaXNOdW1iZXIod2lkdGgpIHx8ICFpc051bWJlcihoZWlnaHQpIHx8ICFpc051bWJlcih0b3ApIHx8ICFpc051bWJlcihsZWZ0KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q4LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczYoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNyb3NzIiwgY2xhc3NOYW1lKSwKICAgIGQ6IGdldFBhdGgyKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgdG9wLCBsZWZ0KQogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldEN1cnNvclJlY3RhbmdsZS5qcwpmdW5jdGlvbiBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpIHsKICB2YXIgaGFsZlNpemUgPSB0b29sdGlwQXhpc0JhbmRTaXplIC8gMjsKICByZXR1cm4gewogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBmaWxsOiAiI2NjYyIsCiAgICB4OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IGFjdGl2ZUNvb3JkaW5hdGUueCAtIGhhbGZTaXplIDogb2Zmc2V0LmxlZnQgKyAwLjUsCiAgICB5OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC50b3AgKyAwLjUgOiBhY3RpdmVDb29yZGluYXRlLnkgLSBoYWxmU2l6ZSwKICAgIHdpZHRoOiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHRvb2x0aXBBeGlzQmFuZFNpemUgOiBvZmZzZXQud2lkdGggLSAxLAogICAgaGVpZ2h0OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC5oZWlnaHQgLSAxIDogdG9vbHRpcEF4aXNCYW5kU2l6ZQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1JlY3RhbmdsZS5qcwp2YXIgUmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vSmF2YXNjcmlwdEFuaW1hdGUuanMKdmFyIGltcG9ydF9yZWFjdDE2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3V0aWwuanMKZnVuY3Rpb24gb3duS2V5czkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5OShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5OShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGdldERhc2hDYXNlID0gKG5hbWUpID0+IG5hbWUucmVwbGFjZSgvKFtBLVpdKS9nLCAodikgPT4gIi0iLmNvbmNhdCh2LnRvTG93ZXJDYXNlKCkpKTsKdmFyIGdldFRyYW5zaXRpb25WYWwgPSAocHJvcHMsIGR1cmF0aW9uLCBlYXNpbmcpID0+IHByb3BzLm1hcCgocHJvcCkgPT4gIiIuY29uY2F0KGdldERhc2hDYXNlKHByb3ApLCAiICIpLmNvbmNhdChkdXJhdGlvbiwgIm1zICIpLmNvbmNhdChlYXNpbmcpKS5qb2luKCIsIik7CnZhciBnZXRJbnRlcnNlY3Rpb25LZXlzID0gKHByZU9iaiwgbmV4dE9iaikgPT4gW09iamVjdC5rZXlzKHByZU9iaiksIE9iamVjdC5rZXlzKG5leHRPYmopXS5yZWR1Y2UoKGEsIGIpID0+IGEuZmlsdGVyKChjKSA9PiBiLmluY2x1ZGVzKGMpKSk7CnZhciBtYXBPYmplY3QgPSAoZm4sIG9iaikgPT4gT2JqZWN0LmtleXMob2JqKS5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkOShfb2JqZWN0U3ByZWFkOSh7fSwgcmVzKSwge30sIHsKICBba2V5XTogZm4oa2V5LCBvYmpba2V5XSkKfSksIHt9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9jb25maWdVcGRhdGUuanMKZnVuY3Rpb24gb3duS2V5czEwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBhbHBoYSA9IChiZWdpbiwgZW5kLCBrKSA9PiBiZWdpbiArIChlbmQgLSBiZWdpbikgKiBrOwp2YXIgbmVlZENvbnRpbnVlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGZyb206IGZyb20yLAogICAgdG86IHRvMgogIH0gPSBfcmVmMjsKICByZXR1cm4gZnJvbTIgIT09IHRvMjsKfTsKdmFyIGNhbFN0ZXBwZXJWYWxzID0gKGVhc2luZywgcHJlVmFscywgc3RlcHMpID0+IHsKICB2YXIgbmV4dFN0ZXBWYWxzID0gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gewogICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgIHZhciBbbmV3WCwgbmV3Vl0gPSBlYXNpbmcodmFsLmZyb20sIHZhbC50bywgdmFsLnZlbG9jaXR5KTsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHZhbCksIHt9LCB7CiAgICAgICAgZnJvbTogbmV3WCwKICAgICAgICB2ZWxvY2l0eTogbmV3VgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfSwgcHJlVmFscyk7CiAgaWYgKHN0ZXBzIDwgMSkgewogICAgcmV0dXJuIG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHsKICAgICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHZhbCksIHt9LCB7CiAgICAgICAgICB2ZWxvY2l0eTogYWxwaGEodmFsLnZlbG9jaXR5LCBuZXh0U3RlcFZhbHNba2V5XS52ZWxvY2l0eSwgc3RlcHMpLAogICAgICAgICAgZnJvbTogYWxwaGEodmFsLmZyb20sIG5leHRTdGVwVmFsc1trZXldLmZyb20sIHN0ZXBzKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9LCBwcmVWYWxzKTsKICB9CiAgcmV0dXJuIGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgbmV4dFN0ZXBWYWxzLCBzdGVwcyAtIDEpOwp9OwpmdW5jdGlvbiBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIHByZVRpbWU7CiAgdmFyIHN0ZXBwZXJTdHlsZSA9IGludGVyS2V5cy5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IHsKICAgICAgZnJvbTogZnJvbTJba2V5XSwKICAgICAgdmVsb2NpdHk6IDAsCiAgICAgIHRvOiB0bzJba2V5XQogICAgfQogIH0pLCB7fSk7CiAgdmFyIGdldEN1cnJTdHlsZSA9ICgpID0+IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHZhbC5mcm9tLCBzdGVwcGVyU3R5bGUpOwogIHZhciBzaG91bGRTdG9wQW5pbWF0aW9uID0gKCkgPT4gIU9iamVjdC52YWx1ZXMoc3RlcHBlclN0eWxlKS5maWx0ZXIobmVlZENvbnRpbnVlKS5sZW5ndGg7CiAgdmFyIHN0b3BBbmltYXRpb24gPSBudWxsOwogIHZhciBzdGVwcGVyVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFwcmVUaW1lKSB7CiAgICAgIHByZVRpbWUgPSBub3c7CiAgICB9CiAgICB2YXIgZGVsdGFUaW1lID0gbm93IC0gcHJlVGltZTsKICAgIHZhciBzdGVwcyA9IGRlbHRhVGltZSAvIGVhc2luZy5kdDsKICAgIHN0ZXBwZXJTdHlsZSA9IGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgc3RlcHBlclN0eWxlLCBzdGVwcyk7CiAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgZ2V0Q3VyclN0eWxlKCkpKTsKICAgIHByZVRpbWUgPSBub3c7CiAgICBpZiAoIXNob3VsZFN0b3BBbmltYXRpb24oKSkgewogICAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIH0KICB9OwogIHJldHVybiAoKSA9PiB7CiAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfc3RvcEFuaW1hdGlvbjsKICAgICAgKF9zdG9wQW5pbWF0aW9uID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24gPT09IHZvaWQgMCB8fCBfc3RvcEFuaW1hdGlvbigpOwogICAgfTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpIHsKICB2YXIgc3RvcEFuaW1hdGlvbiA9IG51bGw7CiAgdmFyIHRpbWluZ1N0eWxlID0gaW50ZXJLZXlzLnJlZHVjZSgocmVzLCBrZXkpID0+IF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHJlcyksIHt9LCB7CiAgICBba2V5XTogW2Zyb20yW2tleV0sIHRvMltrZXldXQogIH0pLCB7fSk7CiAgdmFyIGJlZ2luVGltZTsKICB2YXIgdGltaW5nVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFiZWdpblRpbWUpIHsKICAgICAgYmVnaW5UaW1lID0gbm93OwogICAgfQogICAgdmFyIHQgPSAobm93IC0gYmVnaW5UaW1lKSAvIGR1cmF0aW9uOwogICAgdmFyIGN1cnJTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKHQpKSwgdGltaW5nU3R5bGUpOwogICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGN1cnJTdHlsZSkpOwogICAgaWYgKHQgPCAxKSB7CiAgICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZmluYWxTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKDEpKSwgdGltaW5nU3R5bGUpOwogICAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgZmluYWxTdHlsZSkpOwogICAgfQogIH07CiAgcmV0dXJuICgpID0+IHsKICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgX3N0b3BBbmltYXRpb24yOwogICAgICAoX3N0b3BBbmltYXRpb24yID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24yID09PSB2b2lkIDAgfHwgX3N0b3BBbmltYXRpb24yKCk7CiAgICB9OwogIH07Cn0KdmFyIGNvbmZpZ1VwZGF0ZV9kZWZhdWx0ID0gKGZyb20yLCB0bzIsIGVhc2luZywgZHVyYXRpb24sIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpID0+IHsKICB2YXIgaW50ZXJLZXlzID0gZ2V0SW50ZXJzZWN0aW9uS2V5cyhmcm9tMiwgdG8yKTsKICBpZiAoZWFzaW5nID09IG51bGwpIHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMikpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICB9OwogICAgfTsKICB9CiAgcmV0dXJuIGVhc2luZy5pc1N0ZXBwZXIgPT09IHRydWUgPyBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSA6IGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL2Vhc2luZy5qcwp2YXIgQUNDVVJBQ1kgPSAxZS00Owp2YXIgY3ViaWNCZXppZXJGYWN0b3IgPSAoYzEsIGMyKSA9PiBbMCwgMyAqIGMxLCAzICogYzIgLSA2ICogYzEsIDMgKiBjMSAtIDMgKiBjMiArIDFdOwp2YXIgZXZhbHVhdGVQb2x5bm9taWFsID0gKHBhcmFtcywgdCkgPT4gcGFyYW1zLm1hcCgocGFyYW0sIGkpID0+IHBhcmFtICogdCAqKiBpKS5yZWR1Y2UoKHByZSwgY3VycikgPT4gcHJlICsgY3Vycik7CnZhciBjdWJpY0JlemllciA9IChjMSwgYzIpID0+ICh0KSA9PiB7CiAgdmFyIHBhcmFtcyA9IGN1YmljQmV6aWVyRmFjdG9yKGMxLCBjMik7CiAgcmV0dXJuIGV2YWx1YXRlUG9seW5vbWlhbChwYXJhbXMsIHQpOwp9Owp2YXIgZGVyaXZhdGl2ZUN1YmljQmV6aWVyID0gKGMxLCBjMikgPT4gKHQpID0+IHsKICB2YXIgcGFyYW1zID0gY3ViaWNCZXppZXJGYWN0b3IoYzEsIGMyKTsKICB2YXIgbmV3UGFyYW1zID0gWy4uLnBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiBwYXJhbSAqIGkpLnNsaWNlKDEpLCAwXTsKICByZXR1cm4gZXZhbHVhdGVQb2x5bm9taWFsKG5ld1BhcmFtcywgdCk7Cn07CnZhciBnZXRCZXppZXJDb29yZGluYXRlcyA9IGZ1bmN0aW9uIGdldEJlemllckNvb3JkaW5hdGVzMigpIHsKICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgfQogIGlmIChhcmdzLmxlbmd0aCA9PT0gMSkgewogICAgc3dpdGNoIChhcmdzWzBdKSB7CiAgICAgIGNhc2UgImxpbmVhciI6CiAgICAgICAgcmV0dXJuIFswLCAwLCAxLCAxXTsKICAgICAgY2FzZSAiZWFzZSI6CiAgICAgICAgcmV0dXJuIFswLjI1LCAwLjEsIDAuMjUsIDFdOwogICAgICBjYXNlICJlYXNlLWluIjoKICAgICAgICByZXR1cm4gWzAuNDIsIDAsIDEsIDFdOwogICAgICBjYXNlICJlYXNlLW91dCI6CiAgICAgICAgcmV0dXJuIFswLjQyLCAwLCAwLjU4LCAxXTsKICAgICAgY2FzZSAiZWFzZS1pbi1vdXQiOgogICAgICAgIHJldHVybiBbMCwgMCwgMC41OCwgMV07CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICB2YXIgX2Vhc2luZyQ7CiAgICAgICAgdmFyIGVhc2luZyA9IGFyZ3NbMF0uc3BsaXQoIigiKTsKICAgICAgICBpZiAoZWFzaW5nWzBdID09PSAiY3ViaWMtYmV6aWVyIiAmJiAoKF9lYXNpbmckID0gZWFzaW5nWzFdKSA9PT0gbnVsbCB8fCBfZWFzaW5nJCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vhc2luZyQuc3BsaXQoIikiKVswXS5zcGxpdCgiLCIpLmxlbmd0aCkgPT09IDQpIHsKICAgICAgICAgIHZhciBjb29yZHMgPSBlYXNpbmdbMV0uc3BsaXQoIikiKVswXS5zcGxpdCgiLCIpLm1hcCgoeDIpID0+IHBhcnNlRmxvYXQoeDIpKTsKICAgICAgICAgIHJldHVybiBbY29vcmRzWzBdLCBjb29yZHNbMV0sIGNvb3Jkc1syXSwgY29vcmRzWzNdXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKGFyZ3MubGVuZ3RoID09PSA0KSB7CiAgICByZXR1cm4gYXJnczsKICB9CiAgcmV0dXJuIFswLCAwLCAxLCAxXTsKfTsKdmFyIGNyZWF0ZUJlemllckVhc2luZyA9ICh4MSwgeTEsIHgyLCB5MikgPT4gewogIHZhciBjdXJ2ZVggPSBjdWJpY0Jlemllcih4MSwgeDIpOwogIHZhciBjdXJ2ZVkgPSBjdWJpY0Jlemllcih5MSwgeTIpOwogIHZhciBkZXJDdXJ2ZVggPSBkZXJpdmF0aXZlQ3ViaWNCZXppZXIoeDEsIHgyKTsKICB2YXIgcmFuZ2VWYWx1ZSA9ICh2YWx1ZSkgPT4gewogICAgaWYgKHZhbHVlID4gMSkgewogICAgICByZXR1cm4gMTsKICAgIH0KICAgIGlmICh2YWx1ZSA8IDApIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICB2YXIgYmV6aWVyID0gKF90KSA9PiB7CiAgICB2YXIgdCA9IF90ID4gMSA/IDEgOiBfdDsKICAgIHZhciB4MyA9IHQ7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7ICsraSkgewogICAgICB2YXIgZXZhbFQgPSBjdXJ2ZVgoeDMpIC0gdDsKICAgICAgdmFyIGRlclZhbCA9IGRlckN1cnZlWCh4Myk7CiAgICAgIGlmIChNYXRoLmFicyhldmFsVCAtIHQpIDwgQUNDVVJBQ1kgfHwgZGVyVmFsIDwgQUNDVVJBQ1kpIHsKICAgICAgICByZXR1cm4gY3VydmVZKHgzKTsKICAgICAgfQogICAgICB4MyA9IHJhbmdlVmFsdWUoeDMgLSBldmFsVCAvIGRlclZhbCk7CiAgICB9CiAgICByZXR1cm4gY3VydmVZKHgzKTsKICB9OwogIGJlemllci5pc1N0ZXBwZXIgPSBmYWxzZTsKICByZXR1cm4gYmV6aWVyOwp9Owp2YXIgY29uZmlnQmV6aWVyID0gZnVuY3Rpb24gY29uZmlnQmV6aWVyMigpIHsKICByZXR1cm4gY3JlYXRlQmV6aWVyRWFzaW5nKC4uLmdldEJlemllckNvb3JkaW5hdGVzKC4uLmFyZ3VtZW50cykpOwp9Owp2YXIgY29uZmlnU3ByaW5nID0gZnVuY3Rpb24gY29uZmlnU3ByaW5nMigpIHsKICB2YXIgY29uZmlnID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiB7fTsKICB2YXIgewogICAgc3RpZmYgPSAxMDAsCiAgICBkYW1waW5nID0gOCwKICAgIGR0ID0gMTcKICB9ID0gY29uZmlnOwogIHZhciBzdGVwcGVyID0gKGN1cnJYLCBkZXN0WCwgY3VyclYpID0+IHsKICAgIHZhciBGU3ByaW5nID0gLShjdXJyWCAtIGRlc3RYKSAqIHN0aWZmOwogICAgdmFyIEZEYW1waW5nID0gY3VyclYgKiBkYW1waW5nOwogICAgdmFyIG5ld1YgPSBjdXJyViArIChGU3ByaW5nIC0gRkRhbXBpbmcpICogZHQgLyAxZTM7CiAgICB2YXIgbmV3WCA9IGN1cnJWICogZHQgLyAxZTMgKyBjdXJyWDsKICAgIGlmIChNYXRoLmFicyhuZXdYIC0gZGVzdFgpIDwgQUNDVVJBQ1kgJiYgTWF0aC5hYnMobmV3VikgPCBBQ0NVUkFDWSkgewogICAgICByZXR1cm4gW2Rlc3RYLCAwXTsKICAgIH0KICAgIHJldHVybiBbbmV3WCwgbmV3Vl07CiAgfTsKICBzdGVwcGVyLmlzU3RlcHBlciA9IHRydWU7CiAgc3RlcHBlci5kdCA9IGR0OwogIHJldHVybiBzdGVwcGVyOwp9Owp2YXIgY29uZmlnRWFzaW5nID0gKGVhc2luZykgPT4gewogIGlmICh0eXBlb2YgZWFzaW5nID09PSAic3RyaW5nIikgewogICAgc3dpdGNoIChlYXNpbmcpIHsKICAgICAgY2FzZSAiZWFzZSI6CiAgICAgIGNhc2UgImVhc2UtaW4tb3V0IjoKICAgICAgY2FzZSAiZWFzZS1vdXQiOgogICAgICBjYXNlICJlYXNlLWluIjoKICAgICAgY2FzZSAibGluZWFyIjoKICAgICAgICByZXR1cm4gY29uZmlnQmV6aWVyKGVhc2luZyk7CiAgICAgIGNhc2UgInNwcmluZyI6CiAgICAgICAgcmV0dXJuIGNvbmZpZ1NwcmluZygpOwogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChlYXNpbmcuc3BsaXQoIigiKVswXSA9PT0gImN1YmljLWJlemllciIpIHsKICAgICAgICAgIHJldHVybiBjb25maWdCZXppZXIoZWFzaW5nKTsKICAgICAgICB9CiAgICB9CiAgfQogIGlmICh0eXBlb2YgZWFzaW5nID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZWFzaW5nOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91c2VBbmltYXRpb25NYW5hZ2VyLmpzCnZhciBpbXBvcnRfcmVhY3QxNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9BbmltYXRpb25NYW5hZ2VyLmpzCmZ1bmN0aW9uIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIGN1cnJTdHlsZTsKICB2YXIgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICB2YXIgc2hvdWxkU3RvcCA9IGZhbHNlOwogIHZhciBjYW5jZWxUaW1lb3V0ID0gbnVsbDsKICB2YXIgc2V0U3R5bGUgPSAoX3N0eWxlKSA9PiB7CiAgICBpZiAoc2hvdWxkU3RvcCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShfc3R5bGUpKSB7CiAgICAgIGlmICghX3N0eWxlLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgc3R5bGVzID0gX3N0eWxlOwogICAgICB2YXIgW2N1cnIsIC4uLnJlc3RTdHlsZXNdID0gc3R5bGVzOwogICAgICBpZiAodHlwZW9mIGN1cnIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgY2FuY2VsVGltZW91dCA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc2V0U3R5bGUuYmluZChudWxsLCByZXN0U3R5bGVzKSwgY3Vycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNldFN0eWxlKGN1cnIpOwogICAgICBjYW5jZWxUaW1lb3V0ID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzZXRTdHlsZS5iaW5kKG51bGwsIHJlc3RTdHlsZXMpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJzdHJpbmciKSB7CiAgICAgIGN1cnJTdHlsZSA9IF9zdHlsZTsKICAgICAgaGFuZGxlQ2hhbmdlKGN1cnJTdHlsZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gIm9iamVjdCIpIHsKICAgICAgY3VyclN0eWxlID0gX3N0eWxlOwogICAgICBoYW5kbGVDaGFuZ2UoY3VyclN0eWxlKTsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIF9zdHlsZSgpOwogICAgfQogIH07CiAgcmV0dXJuIHsKICAgIHN0b3A6ICgpID0+IHsKICAgICAgc2hvdWxkU3RvcCA9IHRydWU7CiAgICB9LAogICAgc3RhcnQ6IChzdHlsZSkgPT4gewogICAgICBzaG91bGRTdG9wID0gZmFsc2U7CiAgICAgIGlmIChjYW5jZWxUaW1lb3V0KSB7CiAgICAgICAgY2FuY2VsVGltZW91dCgpOwogICAgICAgIGNhbmNlbFRpbWVvdXQgPSBudWxsOwogICAgICB9CiAgICAgIHNldFN0eWxlKHN0eWxlKTsKICAgIH0sCiAgICBzdWJzY3JpYmU6IChfaGFuZGxlQ2hhbmdlKSA9PiB7CiAgICAgIGhhbmRsZUNoYW5nZSA9IF9oYW5kbGVDaGFuZ2U7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICAgICAgfTsKICAgIH0sCiAgICBnZXRUaW1lb3V0Q29udHJvbGxlcjogKCkgPT4gdGltZW91dENvbnRyb2xsZXIKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdGltZW91dENvbnRyb2xsZXIuanMKdmFyIFJlcXVlc3RBbmltYXRpb25GcmFtZVRpbWVvdXRDb250cm9sbGVyID0gY2xhc3MgewogIHNldFRpbWVvdXQoY2FsbGJhY2spIHsKICAgIHZhciBkZWxheSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogMDsKICAgIHZhciBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgIHZhciByZXF1ZXN0SWQgPSBudWxsOwogICAgdmFyIGV4ZWN1dGVDYWxsYmFjayA9IChub3cpID0+IHsKICAgICAgaWYgKG5vdyAtIHN0YXJ0VGltZSA+PSBkZWxheSkgewogICAgICAgIGNhbGxiYWNrKG5vdyk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShleGVjdXRlQ2FsbGJhY2spOwogICAgICB9CiAgICB9OwogICAgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGV4ZWN1dGVDYWxsYmFjayk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocmVxdWVzdElkICE9IG51bGwpIHsKICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyZXF1ZXN0SWQpOwogICAgICB9CiAgICB9OwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9jcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlci5qcwpmdW5jdGlvbiBjcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlcigpIHsKICByZXR1cm4gY3JlYXRlQW5pbWF0ZU1hbmFnZXIobmV3IFJlcXVlc3RBbmltYXRpb25GcmFtZVRpbWVvdXRDb250cm9sbGVyKCkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgQW5pbWF0aW9uTWFuYWdlckNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDE1LmNyZWF0ZUNvbnRleHQpKGNyZWF0ZURlZmF1bHRBbmltYXRpb25NYW5hZ2VyKTsKZnVuY3Rpb24gdXNlQW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcykgewogIHZhciBjb250ZXh0QW5pbWF0aW9uTWFuYWdlciA9ICgwLCBpbXBvcnRfcmVhY3QxNS51c2VDb250ZXh0KShBbmltYXRpb25NYW5hZ2VyQ29udGV4dCk7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QxNS51c2VNZW1vKSgoKSA9PiBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzICE9PSBudWxsICYmIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgOiBjb250ZXh0QW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCksIFthbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcywgY29udGV4dEFuaW1hdGlvbk1hbmFnZXJdKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9HbG9iYWwuanMKdmFyIHBhcnNlSXNTc3JCeURlZmF1bHQgPSAoKSA9PiAhKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kb2N1bWVudCAmJiBCb29sZWFuKHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KSAmJiB3aW5kb3cuc2V0VGltZW91dCk7CnZhciBHbG9iYWwgPSB7CiAgZGV2VG9vbHNFbmFibGVkOiBmYWxzZSwKICBpc1NzcjogcGFyc2VJc1NzckJ5RGVmYXVsdCgpCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vSmF2YXNjcmlwdEFuaW1hdGUuanMKdmFyIGRlZmF1bHRKYXZhc2NyaXB0QW5pbWF0ZVByb3BzID0gewogIGJlZ2luOiAwLAogIGR1cmF0aW9uOiAxZTMsCiAgZWFzaW5nOiAiZWFzZSIsCiAgaXNBY3RpdmU6IHRydWUsCiAgY2FuQmVnaW46IHRydWUsCiAgb25BbmltYXRpb25FbmQ6ICgpID0+IHsKICB9LAogIG9uQW5pbWF0aW9uU3RhcnQ6ICgpID0+IHsKICB9Cn07CnZhciBmcm9tID0gewogIHQ6IDAKfTsKdmFyIHRvID0gewogIHQ6IDEKfTsKZnVuY3Rpb24gSmF2YXNjcmlwdEFuaW1hdGUob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRKYXZhc2NyaXB0QW5pbWF0ZVByb3BzKTsKICB2YXIgewogICAgaXNBY3RpdmU6IGlzQWN0aXZlUHJvcCwKICAgIGNhbkJlZ2luLAogICAgZHVyYXRpb24sCiAgICBlYXNpbmcsCiAgICBiZWdpbiwKICAgIG9uQW5pbWF0aW9uRW5kLAogICAgb25BbmltYXRpb25TdGFydCwKICAgIGNoaWxkcmVuCiAgfSA9IHByb3BzOwogIHZhciBpc0FjdGl2ZSA9IGlzQWN0aXZlUHJvcCA9PT0gImF1dG8iID8gIUdsb2JhbC5pc1NzciA6IGlzQWN0aXZlUHJvcDsKICB2YXIgYW5pbWF0aW9uTWFuYWdlciA9IHVzZUFuaW1hdGlvbk1hbmFnZXIocHJvcHMuYW5pbWF0aW9uSWQsIHByb3BzLmFuaW1hdGlvbk1hbmFnZXIpOwogIHZhciBbc3R5bGUsIHNldFN0eWxlXSA9ICgwLCBpbXBvcnRfcmVhY3QxNi51c2VTdGF0ZSkoaXNBY3RpdmUgPyBmcm9tIDogdG8pOwogIHZhciBzdG9wSlNBbmltYXRpb24gPSAoMCwgaW1wb3J0X3JlYWN0MTYudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MTYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzQWN0aXZlKSB7CiAgICAgIHNldFN0eWxlKHRvKTsKICAgIH0KICB9LCBbaXNBY3RpdmVdKTsKICAoMCwgaW1wb3J0X3JlYWN0MTYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzQWN0aXZlIHx8ICFjYW5CZWdpbikgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBzdGFydEFuaW1hdGlvbiA9IGNvbmZpZ1VwZGF0ZV9kZWZhdWx0KGZyb20sIHRvLCBjb25maWdFYXNpbmcoZWFzaW5nKSwgZHVyYXRpb24sIHNldFN0eWxlLCBhbmltYXRpb25NYW5hZ2VyLmdldFRpbWVvdXRDb250cm9sbGVyKCkpOwogICAgdmFyIG9uQW5pbWF0aW9uQWN0aXZlID0gKCkgPT4gewogICAgICBzdG9wSlNBbmltYXRpb24uY3VycmVudCA9IHN0YXJ0QW5pbWF0aW9uKCk7CiAgICB9OwogICAgYW5pbWF0aW9uTWFuYWdlci5zdGFydChbb25BbmltYXRpb25TdGFydCwgYmVnaW4sIG9uQW5pbWF0aW9uQWN0aXZlLCBkdXJhdGlvbiwgb25BbmltYXRpb25FbmRdKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGFuaW1hdGlvbk1hbmFnZXIuc3RvcCgpOwogICAgICBpZiAoc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQpIHsKICAgICAgICBzdG9wSlNBbmltYXRpb24uY3VycmVudCgpOwogICAgICB9CiAgICAgIG9uQW5pbWF0aW9uRW5kKCk7CiAgICB9OwogIH0sIFtpc0FjdGl2ZSwgY2FuQmVnaW4sIGR1cmF0aW9uLCBlYXNpbmcsIGJlZ2luLCBvbkFuaW1hdGlvblN0YXJ0LCBvbkFuaW1hdGlvbkVuZCwgYW5pbWF0aW9uTWFuYWdlcl0pOwogIHJldHVybiBjaGlsZHJlbihzdHlsZS50KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VBbmltYXRpb25JZC5qcwp2YXIgaW1wb3J0X3JlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZUFuaW1hdGlvbklkKGlucHV0KSB7CiAgdmFyIHByZWZpeCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogImFuaW1hdGlvbi0iOwogIHZhciBhbmltYXRpb25JZCA9ICgwLCBpbXBvcnRfcmVhY3QxNy51c2VSZWYpKHVuaXF1ZUlkKHByZWZpeCkpOwogIHZhciBwcmV2UHJvcHMgPSAoMCwgaW1wb3J0X3JlYWN0MTcudXNlUmVmKShpbnB1dCk7CiAgaWYgKHByZXZQcm9wcy5jdXJyZW50ICE9PSBpbnB1dCkgewogICAgYW5pbWF0aW9uSWQuY3VycmVudCA9IHVuaXF1ZUlkKHByZWZpeCk7CiAgICBwcmV2UHJvcHMuY3VycmVudCA9IGlucHV0OwogIH0KICByZXR1cm4gYW5pbWF0aW9uSWQuY3VycmVudDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvUmVjdGFuZ2xlLmpzCnZhciBfZXhjbHVkZWQ0ID0gWyJyYWRpdXMiXTsKdmFyIF9leGNsdWRlZDIyID0gWyJyYWRpdXMiXTsKZnVuY3Rpb24gb3duS2V5czExKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTExKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzNygpIHsKICByZXR1cm4gX2V4dGVuZHM3ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM3LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGdldFJlY3RhbmdsZVBhdGggPSAoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXMpID0+IHsKICB2YXIgbWF4UmFkaXVzID0gTWF0aC5taW4oTWF0aC5hYnMod2lkdGgpIC8gMiwgTWF0aC5hYnMoaGVpZ2h0KSAvIDIpOwogIHZhciB5U2lnbiA9IGhlaWdodCA+PSAwID8gMSA6IC0xOwogIHZhciB4U2lnbiA9IHdpZHRoID49IDAgPyAxIDogLTE7CiAgdmFyIGNsb2NrV2lzZSA9IGhlaWdodCA+PSAwICYmIHdpZHRoID49IDAgfHwgaGVpZ2h0IDwgMCAmJiB3aWR0aCA8IDAgPyAxIDogMDsKICB2YXIgcGF0aDI7CiAgaWYgKG1heFJhZGl1cyA+IDAgJiYgcmFkaXVzIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgIHZhciBuZXdSYWRpdXMgPSBbMCwgMCwgMCwgMF07CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gNDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIG5ld1JhZGl1c1tpXSA9IHJhZGl1c1tpXSA+IG1heFJhZGl1cyA/IG1heFJhZGl1cyA6IHJhZGl1c1tpXTsKICAgIH0KICAgIHBhdGgyID0gIk0iLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIG5ld1JhZGl1c1swXSk7CiAgICBpZiAobmV3UmFkaXVzWzBdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMF0sICIsIikuY29uY2F0KG5ld1JhZGl1c1swXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB4U2lnbiAqIG5ld1JhZGl1c1swXSwgIiwiKS5jb25jYXQoeTIpOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogbmV3UmFkaXVzWzFdLCAiLCIpLmNvbmNhdCh5Mik7CiAgICBpZiAobmV3UmFkaXVzWzFdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMV0sICIsIikuY29uY2F0KG5ld1JhZGl1c1sxXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBuZXdSYWRpdXNbMV0pOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIG5ld1JhZGl1c1syXSk7CiAgICBpZiAobmV3UmFkaXVzWzJdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMl0sICIsIikuY29uY2F0KG5ld1JhZGl1c1syXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIG5ld1JhZGl1c1syXSwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQpOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB4U2lnbiAqIG5ld1JhZGl1c1szXSwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQpOwogICAgaWYgKG5ld1JhZGl1c1szXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzNdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbM10sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIG5ld1JhZGl1c1szXSk7CiAgICB9CiAgICBwYXRoMiArPSAiWiI7CiAgfSBlbHNlIGlmIChtYXhSYWRpdXMgPiAwICYmIHJhZGl1cyA9PT0gK3JhZGl1cyAmJiByYWRpdXMgPiAwKSB7CiAgICB2YXIgX25ld1JhZGl1cyA9IE1hdGgubWluKG1heFJhZGl1cywgcmFkaXVzKTsKICAgIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0LCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogX25ld1JhZGl1cywgIiBaIik7CiAgfSBlbHNlIHsKICAgIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyLCAiIGggIikuY29uY2F0KHdpZHRoLCAiIHYgIikuY29uY2F0KGhlaWdodCwgIiBoICIpLmNvbmNhdCgtd2lkdGgsICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICAvLyBUaGUgcmFkaXVzIG9mIGJvcmRlcgogIC8vIFRoZSByYWRpdXMgb2YgZm91ciBjb3JuZXJzIHdoZW4gcmFkaXVzIGlzIGEgbnVtYmVyCiAgLy8gVGhlIHJhZGl1cyBvZiBsZWZ0LXRvcCwgcmlnaHQtdG9wLCByaWdodC1ib3R0b20sIGxlZnQtYm90dG9tIHdoZW4gcmFkaXVzIGlzIGFuIGFycmF5CiAgcmFkaXVzOiAwLAogIGlzQW5pbWF0aW9uQWN0aXZlOiBmYWxzZSwKICBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZTogZmFsc2UsCiAgYW5pbWF0aW9uQmVnaW46IDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIKfTsKdmFyIFJlY3RhbmdsZSA9IChyZWN0YW5nbGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMocmVjdGFuZ2xlUHJvcHMsIGRlZmF1bHRSZWN0YW5nbGVQcm9wcyk7CiAgdmFyIHBhdGhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKShudWxsKTsKICB2YXIgW3RvdGFsTGVuZ3RoLCBzZXRUb3RhbExlbmd0aF0gPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlU3RhdGUpKC0xKTsKICAoMCwgaW1wb3J0X3JlYWN0MTgudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50ICYmIHBhdGhSZWYuY3VycmVudC5nZXRUb3RhbExlbmd0aCkgewogICAgICB0cnkgewogICAgICAgIHZhciBwYXRoVG90YWxMZW5ndGggPSBwYXRoUmVmLmN1cnJlbnQuZ2V0VG90YWxMZW5ndGgoKTsKICAgICAgICBpZiAocGF0aFRvdGFsTGVuZ3RoKSB7CiAgICAgICAgICBzZXRUb3RhbExlbmd0aChwYXRoVG90YWxMZW5ndGgpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgICB9CiAgICB9CiAgfSwgW10pOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByYWRpdXMsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgdmFyIHsKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlCiAgfSA9IHByb3BzOwogIHZhciBwcmV2V2lkdGhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh3aWR0aCk7CiAgdmFyIHByZXZIZWlnaHRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKShoZWlnaHQpOwogIHZhciBwcmV2WFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHgyKTsKICB2YXIgcHJldllSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh5Mik7CiAgdmFyIGFuaW1hdGlvbklkSW5wdXQgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlTWVtbykoKCkgPT4gKHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJhZGl1cwogIH0pLCBbeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXNdKTsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChhbmltYXRpb25JZElucHV0LCAicmVjdGFuZ2xlLSIpOwogIGlmICh4MiAhPT0gK3gyIHx8IHkyICE9PSAreTIgfHwgd2lkdGggIT09ICt3aWR0aCB8fCBoZWlnaHQgIT09ICtoZWlnaHQgfHwgd2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1yZWN0YW5nbGUiLCBjbGFzc05hbWUpOwogIGlmICghaXNVcGRhdGVBbmltYXRpb25BY3RpdmUpIHsKICAgIHZhciBfc3ZnUHJvcGVydGllc0FuZEV2ZW4gPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgICByYWRpdXM6IF8KICAgIH0gPSBfc3ZnUHJvcGVydGllc0FuZEV2ZW4sIG90aGVyUGF0aFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChfc3ZnUHJvcGVydGllc0FuZEV2ZW4sIF9leGNsdWRlZDQpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDkuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNyh7fSwgb3RoZXJQYXRoUHJvcHMsIHsKICAgICAgcmFkaXVzOiB0eXBlb2YgcmFkaXVzID09PSAibnVtYmVyIiA/IHJhZGl1cyA6IHZvaWQgMCwKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRSZWN0YW5nbGVQYXRoKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzKQogICAgfSkpOwogIH0KICB2YXIgcHJldldpZHRoID0gcHJldldpZHRoUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZIZWlnaHQgPSBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZYID0gcHJldlhSZWYuY3VycmVudDsKICB2YXIgcHJldlkgPSBwcmV2WVJlZi5jdXJyZW50OwogIHZhciBmcm9tMiA9ICIwcHggIi5jb25jYXQodG90YWxMZW5ndGggPT09IC0xID8gMSA6IHRvdGFsTGVuZ3RoLCAicHgiKTsKICB2YXIgdG8yID0gIiIuY29uY2F0KHRvdGFsTGVuZ3RoLCAicHggMHB4Iik7CiAgdmFyIHRyYW5zaXRpb24gPSBnZXRUcmFuc2l0aW9uVmFsKFsic3Ryb2tlRGFzaGFycmF5Il0sIGFuaW1hdGlvbkR1cmF0aW9uLCB0eXBlb2YgYW5pbWF0aW9uRWFzaW5nID09PSAic3RyaW5nIiA/IGFuaW1hdGlvbkVhc2luZyA6IGRlZmF1bHRSZWN0YW5nbGVQcm9wcy5hbmltYXRpb25FYXNpbmcpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAga2V5OiBhbmltYXRpb25JZCwKICAgIGNhbkJlZ2luOiB0b3RhbExlbmd0aCA+IDAsCiAgICBkdXJhdGlvbjogYW5pbWF0aW9uRHVyYXRpb24sCiAgICBlYXNpbmc6IGFuaW1hdGlvbkVhc2luZywKICAgIGlzQWN0aXZlOiBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZSwKICAgIGJlZ2luOiBhbmltYXRpb25CZWdpbgogIH0sICh0KSA9PiB7CiAgICB2YXIgY3VycldpZHRoID0gaW50ZXJwb2xhdGUocHJldldpZHRoLCB3aWR0aCwgdCk7CiAgICB2YXIgY3VyckhlaWdodCA9IGludGVycG9sYXRlKHByZXZIZWlnaHQsIGhlaWdodCwgdCk7CiAgICB2YXIgY3VyclggPSBpbnRlcnBvbGF0ZShwcmV2WCwgeDIsIHQpOwogICAgdmFyIGN1cnJZID0gaW50ZXJwb2xhdGUocHJldlksIHkyLCB0KTsKICAgIGlmIChwYXRoUmVmLmN1cnJlbnQpIHsKICAgICAgcHJldldpZHRoUmVmLmN1cnJlbnQgPSBjdXJyV2lkdGg7CiAgICAgIHByZXZIZWlnaHRSZWYuY3VycmVudCA9IGN1cnJIZWlnaHQ7CiAgICAgIHByZXZYUmVmLmN1cnJlbnQgPSBjdXJyWDsKICAgICAgcHJldllSZWYuY3VycmVudCA9IGN1cnJZOwogICAgfQogICAgdmFyIGFuaW1hdGlvblN0eWxlOwogICAgaWYgKCFpc0FuaW1hdGlvbkFjdGl2ZSkgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgICB9OwogICAgfSBlbHNlIGlmICh0ID4gMCkgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICB0cmFuc2l0aW9uLAogICAgICAgIHN0cm9rZURhc2hhcnJheTogdG8yCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IGZyb20yCiAgICAgIH07CiAgICB9CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICAgIHJhZGl1czogXzIKICAgIH0gPSBfc3ZnUHJvcGVydGllc0FuZEV2ZW4yLCBvdGhlclBhdGhQcm9wczIgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM0KF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIsIF9leGNsdWRlZDIyKTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczcoe30sIG90aGVyUGF0aFByb3BzMiwgewogICAgICByYWRpdXM6IHR5cGVvZiByYWRpdXMgPT09ICJudW1iZXIiID8gcmFkaXVzIDogdm9pZCAwLAogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGQ6IGdldFJlY3RhbmdsZVBhdGgoY3VyclgsIGN1cnJZLCBjdXJyV2lkdGgsIGN1cnJIZWlnaHQsIHJhZGl1cyksCiAgICAgIHJlZjogcGF0aFJlZiwKICAgICAgc3R5bGU6IF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIGFuaW1hdGlvblN0eWxlKSwgcHJvcHMuc3R5bGUpCiAgICB9KSk7CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1BvbGFyVXRpbHMuanMKdmFyIGltcG9ydF9yZWFjdDE5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBvd25LZXlzMTIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czEyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFJBRElBTiA9IE1hdGguUEkgLyAxODA7CnZhciByYWRpYW5Ub0RlZ3JlZSA9IChhbmdsZUluUmFkaWFuKSA9PiBhbmdsZUluUmFkaWFuICogMTgwIC8gTWF0aC5QSTsKdmFyIHBvbGFyVG9DYXJ0ZXNpYW4gPSAoY3gsIGN5LCByYWRpdXMsIGFuZ2xlKSA9PiAoewogIHg6IGN4ICsgTWF0aC5jb3MoLVJBRElBTiAqIGFuZ2xlKSAqIHJhZGl1cywKICB5OiBjeSArIE1hdGguc2luKC1SQURJQU4gKiBhbmdsZSkgKiByYWRpdXMKfSk7CnZhciBnZXRNYXhSYWRpdXMgPSBmdW5jdGlvbiBnZXRNYXhSYWRpdXMyKHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgb2Zmc2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB7CiAgICB0b3A6IDAsCiAgICByaWdodDogMCwKICAgIGJvdHRvbTogMCwKICAgIGxlZnQ6IDAsCiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMCwKICAgIGJydXNoQm90dG9tOiAwCiAgfTsKICByZXR1cm4gTWF0aC5taW4oTWF0aC5hYnMod2lkdGggLSAob2Zmc2V0LmxlZnQgfHwgMCkgLSAob2Zmc2V0LnJpZ2h0IHx8IDApKSwgTWF0aC5hYnMoaGVpZ2h0IC0gKG9mZnNldC50b3AgfHwgMCkgLSAob2Zmc2V0LmJvdHRvbSB8fCAwKSkpIC8gMjsKfTsKdmFyIGRpc3RhbmNlQmV0d2VlblBvaW50cyA9IChwb2ludDQsIGFub3RoZXJQb2ludCkgPT4gewogIHZhciB7CiAgICB4OiB4MSwKICAgIHk6IHkxCiAgfSA9IHBvaW50NDsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBhbm90aGVyUG9pbnQ7CiAgcmV0dXJuIE1hdGguc3FydCgoeDEgLSB4MikgKiogMiArICh5MSAtIHkyKSAqKiAyKTsKfTsKdmFyIGdldEFuZ2xlT2ZQb2ludCA9IChfcmVmMiwgX3JlZjIyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIGN4LAogICAgY3kKICB9ID0gX3JlZjIyOwogIHZhciByYWRpdXMgPSBkaXN0YW5jZUJldHdlZW5Qb2ludHMoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHsKICAgIHg6IGN4LAogICAgeTogY3kKICB9KTsKICBpZiAocmFkaXVzIDw9IDApIHsKICAgIHJldHVybiB7CiAgICAgIHJhZGl1cywKICAgICAgYW5nbGU6IDAKICAgIH07CiAgfQogIHZhciBjb3MgPSAoeDIgLSBjeCkgLyByYWRpdXM7CiAgdmFyIGFuZ2xlSW5SYWRpYW4gPSBNYXRoLmFjb3MoY29zKTsKICBpZiAoeTIgPiBjeSkgewogICAgYW5nbGVJblJhZGlhbiA9IDIgKiBNYXRoLlBJIC0gYW5nbGVJblJhZGlhbjsKICB9CiAgcmV0dXJuIHsKICAgIHJhZGl1cywKICAgIGFuZ2xlOiByYWRpYW5Ub0RlZ3JlZShhbmdsZUluUmFkaWFuKSwKICAgIGFuZ2xlSW5SYWRpYW4KICB9Owp9Owp2YXIgZm9ybWF0QW5nbGVPZlNlY3RvciA9IChfcmVmMykgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjM7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gewogICAgc3RhcnRBbmdsZTogc3RhcnRBbmdsZSAtIG1pbjIgKiAzNjAsCiAgICBlbmRBbmdsZTogZW5kQW5nbGUgLSBtaW4yICogMzYwCiAgfTsKfTsKdmFyIHJldmVyc2VGb3JtYXRBbmdsZU9mU2VjdG9yID0gKGFuZ2xlLCBfcmVmNCkgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjQ7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gYW5nbGUgKyBtaW4yICogMzYwOwp9Owp2YXIgaW5SYW5nZU9mU2VjdG9yID0gKF9yZWY1LCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IF9yZWY1OwogIHZhciB7CiAgICByYWRpdXMsCiAgICBhbmdsZQogIH0gPSBnZXRBbmdsZU9mUG9pbnQoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHZpZXdCb3gpOwogIHZhciB7CiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzCiAgfSA9IHZpZXdCb3g7CiAgaWYgKHJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHJhZGl1cyA+IG91dGVyUmFkaXVzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHJhZGl1cyA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gZm9ybWF0QW5nbGVPZlNlY3Rvcih2aWV3Qm94KTsKICB2YXIgZm9ybWF0QW5nbGUgPSBhbmdsZTsKICB2YXIgaW5SYW5nZTsKICBpZiAoc3RhcnRBbmdsZSA8PSBlbmRBbmdsZSkgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gZW5kQW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgLT0gMzYwOwogICAgfQogICAgd2hpbGUgKGZvcm1hdEFuZ2xlIDwgc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gc3RhcnRBbmdsZSAmJiBmb3JtYXRBbmdsZSA8PSBlbmRBbmdsZTsKICB9IGVsc2UgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSAtPSAzNjA7CiAgICB9CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPCBlbmRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gZW5kQW5nbGUgJiYgZm9ybWF0QW5nbGUgPD0gc3RhcnRBbmdsZTsKICB9CiAgaWYgKGluUmFuZ2UpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTIoX29iamVjdFNwcmVhZDEyKHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgcmFkaXVzLAogICAgICBhbmdsZTogcmV2ZXJzZUZvcm1hdEFuZ2xlT2ZTZWN0b3IoZm9ybWF0QW5nbGUsIHZpZXdCb3gpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRSYWRpYWxDdXJzb3JQb2ludHMuanMKZnVuY3Rpb24gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpIHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBhY3RpdmVDb29yZGluYXRlOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgc3RhcnRBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgZW5kQW5nbGUpOwogIHJldHVybiB7CiAgICBwb2ludHM6IFtzdGFydFBvaW50LCBlbmRQb2ludF0sCiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvU2VjdG9yLmpzCnZhciBSZWFjdDEwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczgoKSB7CiAgcmV0dXJuIF9leHRlbmRzOCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzOC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBnZXREZWx0YUFuZ2xlID0gKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKSA9PiB7CiAgdmFyIHNpZ24yID0gbWF0aFNpZ24oZW5kQW5nbGUgLSBzdGFydEFuZ2xlKTsKICB2YXIgZGVsdGFBbmdsZSA9IE1hdGgubWluKE1hdGguYWJzKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSksIDM1OS45OTkpOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciBnZXRUYW5nZW50Q2lyY2xlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBhbmdsZSwKICAgIHNpZ246IHNpZ24yLAogICAgaXNFeHRlcm5hbCwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9ID0gX3JlZjI7CiAgdmFyIGNlbnRlclJhZGl1cyA9IGNvcm5lclJhZGl1cyAqIChpc0V4dGVybmFsID8gMSA6IC0xKSArIHJhZGl1czsKICB2YXIgdGhldGEgPSBNYXRoLmFzaW4oY29ybmVyUmFkaXVzIC8gY2VudGVyUmFkaXVzKSAvIFJBRElBTjsKICB2YXIgY2VudGVyQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gYW5nbGUgOiBhbmdsZSArIHNpZ24yICogdGhldGE7CiAgdmFyIGNlbnRlciA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBjZW50ZXJSYWRpdXMsIGNlbnRlckFuZ2xlKTsKICB2YXIgY2lyY2xlVGFuZ2VuY3kgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBjZW50ZXJBbmdsZSk7CiAgdmFyIGxpbmVUYW5nZW5jeUFuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IGFuZ2xlIC0gc2lnbjIgKiB0aGV0YSA6IGFuZ2xlOwogIHZhciBsaW5lVGFuZ2VuY3kgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgY2VudGVyUmFkaXVzICogTWF0aC5jb3ModGhldGEgKiBSQURJQU4pLCBsaW5lVGFuZ2VuY3lBbmdsZSk7CiAgcmV0dXJuIHsKICAgIGNlbnRlciwKICAgIGNpcmNsZVRhbmdlbmN5LAogICAgbGluZVRhbmdlbmN5LAogICAgdGhldGEKICB9Owp9Owp2YXIgZ2V0U2VjdG9yUGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMjsKICB2YXIgYW5nbGUgPSBnZXREZWx0YUFuZ2xlKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKTsKICB2YXIgdGVtcEVuZEFuZ2xlID0gc3RhcnRBbmdsZSArIGFuZ2xlOwogIHZhciBvdXRlclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogIHZhciBvdXRlckVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCB0ZW1wRW5kQW5nbGUpOwogIHZhciBwYXRoMiA9ICJNICIuY29uY2F0KG91dGVyU3RhcnRQb2ludC54LCAiLCIpLmNvbmNhdChvdXRlclN0YXJ0UG9pbnQueSwgIlxuICAgIEEgIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLCIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwwLFxuICAgICIpLmNvbmNhdCgrKE1hdGguYWJzKGFuZ2xlKSA+IDE4MCksICIsIikuY29uY2F0KCsoc3RhcnRBbmdsZSA+IHRlbXBFbmRBbmdsZSksICIsXG4gICAgIikuY29uY2F0KG91dGVyRW5kUG9pbnQueCwgIiwiKS5jb25jYXQob3V0ZXJFbmRQb2ludC55LCAiXG4gICIpOwogIGlmIChpbm5lclJhZGl1cyA+IDApIHsKICAgIHZhciBpbm5lclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogICAgdmFyIGlubmVyRW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHRlbXBFbmRBbmdsZSk7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChpbm5lckVuZFBvaW50LngsICIsIikuY29uY2F0KGlubmVyRW5kUG9pbnQueSwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLDAsXG4gICAgICAgICAgICAiKS5jb25jYXQoKyhNYXRoLmFicyhhbmdsZSkgPiAxODApLCAiLCIpLmNvbmNhdCgrKHN0YXJ0QW5nbGUgPD0gdGVtcEVuZEFuZ2xlKSwgIixcbiAgICAgICAgICAgICIpLmNvbmNhdChpbm5lclN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoaW5uZXJTdGFydFBvaW50LnksICIgWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBnZXRTZWN0b3JXaXRoQ29ybmVyID0gKF9yZWYzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYzOwogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIHsKICAgIGNpcmNsZVRhbmdlbmN5OiBzb2N0LAogICAgbGluZVRhbmdlbmN5OiBzb2x0LAogICAgdGhldGE6IHNvdAogIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXM6IG91dGVyUmFkaXVzLAogICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9KTsKICB2YXIgewogICAgY2lyY2xlVGFuZ2VuY3k6IGVvY3QsCiAgICBsaW5lVGFuZ2VuY3k6IGVvbHQsCiAgICB0aGV0YTogZW90CiAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1czogb3V0ZXJSYWRpdXMsCiAgICBhbmdsZTogZW5kQW5nbGUsCiAgICBzaWduOiAtc2lnbjIsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSk7CiAgdmFyIG91dGVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzb3QgLSBlb3Q7CiAgaWYgKG91dGVyQXJjQW5nbGUgPCAwKSB7CiAgICBpZiAoZm9yY2VDb3JuZXJSYWRpdXMpIHsKICAgICAgcmV0dXJuICJNICIuY29uY2F0KHNvbHQueCwgIiwiKS5jb25jYXQoc29sdC55LCAiXG4gICAgICAgIGEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLDEsIikuY29uY2F0KGNvcm5lclJhZGl1cyAqIDIsICIsMFxuICAgICAgICBhIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwxLCIpLmNvbmNhdCgtY29ybmVyUmFkaXVzICogMiwgIiwwXG4gICAgICAiKTsKICAgIH0KICAgIHJldHVybiBnZXRTZWN0b3JQYXRoKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9CiAgdmFyIHBhdGgyID0gIk0gIi5jb25jYXQoc29sdC54LCAiLCIpLmNvbmNhdChzb2x0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzb2N0LngsICIsIikuY29uY2F0KHNvY3QueSwgIlxuICAgIEEiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLDAsIikuY29uY2F0KCsob3V0ZXJBcmNBbmdsZSA+IDE4MCksICIsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZW9jdC54LCAiLCIpLmNvbmNhdChlb2N0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlb2x0LngsICIsIikuY29uY2F0KGVvbHQueSwgIlxuICAiKTsKICBpZiAoaW5uZXJSYWRpdXMgPiAwKSB7CiAgICB2YXIgewogICAgICBjaXJjbGVUYW5nZW5jeTogc2ljdCwKICAgICAgbGluZVRhbmdlbmN5OiBzaWx0LAogICAgICB0aGV0YTogc2l0CiAgICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzOiBpbm5lclJhZGl1cywKICAgICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICAgIHNpZ246IHNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIHsKICAgICAgY2lyY2xlVGFuZ2VuY3k6IGVpY3QsCiAgICAgIGxpbmVUYW5nZW5jeTogZWlsdCwKICAgICAgdGhldGE6IGVpdAogICAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgIGFuZ2xlOiBlbmRBbmdsZSwKICAgICAgc2lnbjogLXNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIGlubmVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzaXQgLSBlaXQ7CiAgICBpZiAoaW5uZXJBcmNBbmdsZSA8IDAgJiYgY29ybmVyUmFkaXVzID09PSAwKSB7CiAgICAgIHJldHVybiAiIi5jb25jYXQocGF0aDIsICJMIikuY29uY2F0KGN4LCAiLCIpLmNvbmNhdChjeSwgIloiKTsKICAgIH0KICAgIHBhdGgyICs9ICJMIi5jb25jYXQoZWlsdC54LCAiLCIpLmNvbmNhdChlaWx0LnksICJcbiAgICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVpY3QueCwgIiwiKS5jb25jYXQoZWljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLCIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwwLCIpLmNvbmNhdCgrKGlubmVyQXJjQW5nbGUgPiAxODApLCAiLCIpLmNvbmNhdCgrKHNpZ24yID4gMCksICIsIikuY29uY2F0KHNpY3QueCwgIiwiKS5jb25jYXQoc2ljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzaWx0LngsICIsIikuY29uY2F0KHNpbHQueSwgIloiKTsKICB9IGVsc2UgewogICAgcGF0aDIgKz0gIkwiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICJaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGRlZmF1bHRTZWN0b3JQcm9wcyA9IHsKICBjeDogMCwKICBjeTogMCwKICBpbm5lclJhZGl1czogMCwKICBvdXRlclJhZGl1czogMCwKICBzdGFydEFuZ2xlOiAwLAogIGVuZEFuZ2xlOiAwLAogIGNvcm5lclJhZGl1czogMCwKICBmb3JjZUNvcm5lclJhZGl1czogZmFsc2UsCiAgY29ybmVySXNFeHRlcm5hbDogZmFsc2UKfTsKdmFyIFNlY3RvciA9IChzZWN0b3JQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMoc2VjdG9yUHJvcHMsIGRlZmF1bHRTZWN0b3JQcm9wcyk7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIGlmIChvdXRlclJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHN0YXJ0QW5nbGUgPT09IGVuZEFuZ2xlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1zZWN0b3IiLCBjbGFzc05hbWUpOwogIHZhciBkZWx0YVJhZGl1cyA9IG91dGVyUmFkaXVzIC0gaW5uZXJSYWRpdXM7CiAgdmFyIGNyID0gZ2V0UGVyY2VudFZhbHVlKGNvcm5lclJhZGl1cywgZGVsdGFSYWRpdXMsIDAsIHRydWUpOwogIHZhciBwYXRoMjsKICBpZiAoY3IgPiAwICYmIE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgPCAzNjApIHsKICAgIHBhdGgyID0gZ2V0U2VjdG9yV2l0aENvcm5lcih7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBjb3JuZXJSYWRpdXM6IE1hdGgubWluKGNyLCBkZWx0YVJhZGl1cyAvIDIpLAogICAgICBmb3JjZUNvcm5lclJhZGl1cywKICAgICAgY29ybmVySXNFeHRlcm5hbCwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0gZWxzZSB7CiAgICBwYXRoMiA9IGdldFNlY3RvclBhdGgoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTAuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzOCh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgIGQ6IHBhdGgyCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9jdXJzb3IvZ2V0Q3Vyc29yUG9pbnRzLmpzCmZ1bmN0aW9uIGdldEN1cnNvclBvaW50cyhsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCkgewogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFt7CiAgICAgIHg6IGFjdGl2ZUNvb3JkaW5hdGUueCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfSwgewogICAgICB4OiBhY3RpdmVDb29yZGluYXRlLngsCiAgICAgIHk6IG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0CiAgICB9XTsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIFt7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiBhY3RpdmVDb29yZGluYXRlLnkKICAgIH0sIHsKICAgICAgeDogb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsCiAgICAgIHk6IGFjdGl2ZUNvb3JkaW5hdGUueQogICAgfV07CiAgfQogIGlmIChpc1BvbGFyQ29vcmRpbmF0ZShhY3RpdmVDb29yZGluYXRlKSkgewogICAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICAgIHZhciB7CiAgICAgICAgY3gsCiAgICAgICAgY3ksCiAgICAgICAgaW5uZXJSYWRpdXMsCiAgICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgICAgYW5nbGUKICAgICAgfSA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgICAgIHZhciBpbm5lclBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCBhbmdsZSk7CiAgICAgIHZhciBvdXRlclBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCBhbmdsZSk7CiAgICAgIHJldHVybiBbewogICAgICAgIHg6IGlubmVyUG9pbnQueCwKICAgICAgICB5OiBpbm5lclBvaW50LnkKICAgICAgfSwgewogICAgICAgIHg6IG91dGVyUG9pbnQueCwKICAgICAgICB5OiBvdXRlclBvaW50LnkKICAgICAgfV07CiAgICB9CiAgICByZXR1cm4gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXhpc1NlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3JhbmdlMiA9IF9fdG9FU00ocmVxdWlyZV9yYW5nZTIoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdmljdG9yeS12ZW5kb3JAMzcuMy42L25vZGVfbW9kdWxlcy92aWN0b3J5LXZlbmRvci9lcy9kMy1zY2FsZS5qcwp2YXIgZDNfc2NhbGVfZXhwb3J0cyA9IHt9OwpfX2V4cG9ydChkM19zY2FsZV9leHBvcnRzLCB7CiAgc2NhbGVCYW5kOiAoKSA9PiBiYW5kLAogIHNjYWxlRGl2ZXJnaW5nOiAoKSA9PiBkaXZlcmdpbmcsCiAgc2NhbGVEaXZlcmdpbmdMb2c6ICgpID0+IGRpdmVyZ2luZ0xvZywKICBzY2FsZURpdmVyZ2luZ1BvdzogKCkgPT4gZGl2ZXJnaW5nUG93LAogIHNjYWxlRGl2ZXJnaW5nU3FydDogKCkgPT4gZGl2ZXJnaW5nU3FydCwKICBzY2FsZURpdmVyZ2luZ1N5bWxvZzogKCkgPT4gZGl2ZXJnaW5nU3ltbG9nLAogIHNjYWxlSWRlbnRpdHk6ICgpID0+IGlkZW50aXR5MiwKICBzY2FsZUltcGxpY2l0OiAoKSA9PiBpbXBsaWNpdCwKICBzY2FsZUxpbmVhcjogKCkgPT4gbGluZWFyMiwKICBzY2FsZUxvZzogKCkgPT4gbG9nLAogIHNjYWxlT3JkaW5hbDogKCkgPT4gb3JkaW5hbCwKICBzY2FsZVBvaW50OiAoKSA9PiBwb2ludDMsCiAgc2NhbGVQb3c6ICgpID0+IHBvdywKICBzY2FsZVF1YW50aWxlOiAoKSA9PiBxdWFudGlsZTIsCiAgc2NhbGVRdWFudGl6ZTogKCkgPT4gcXVhbnRpemUsCiAgc2NhbGVSYWRpYWw6ICgpID0+IHJhZGlhbCwKICBzY2FsZVNlcXVlbnRpYWw6ICgpID0+IHNlcXVlbnRpYWwsCiAgc2NhbGVTZXF1ZW50aWFsTG9nOiAoKSA9PiBzZXF1ZW50aWFsTG9nLAogIHNjYWxlU2VxdWVudGlhbFBvdzogKCkgPT4gc2VxdWVudGlhbFBvdywKICBzY2FsZVNlcXVlbnRpYWxRdWFudGlsZTogKCkgPT4gc2VxdWVudGlhbFF1YW50aWxlLAogIHNjYWxlU2VxdWVudGlhbFNxcnQ6ICgpID0+IHNlcXVlbnRpYWxTcXJ0LAogIHNjYWxlU2VxdWVudGlhbFN5bWxvZzogKCkgPT4gc2VxdWVudGlhbFN5bWxvZywKICBzY2FsZVNxcnQ6ICgpID0+IHNxcnQsCiAgc2NhbGVTeW1sb2c6ICgpID0+IHN5bWxvZywKICBzY2FsZVRocmVzaG9sZDogKCkgPT4gdGhyZXNob2xkLAogIHNjYWxlVGltZTogKCkgPT4gdGltZSwKICBzY2FsZVV0YzogKCkgPT4gdXRjVGltZSwKICB0aWNrRm9ybWF0OiAoKSA9PiB0aWNrRm9ybWF0Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYXNjZW5kaW5nLmpzCmZ1bmN0aW9uIGFzY2VuZGluZyhhLCBiKSB7CiAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogYSA+PSBiID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvZGVzY2VuZGluZy5qcwpmdW5jdGlvbiBkZXNjZW5kaW5nKGEsIGIpIHsKICByZXR1cm4gYSA9PSBudWxsIHx8IGIgPT0gbnVsbCA/IE5hTiA6IGIgPCBhID8gLTEgOiBiID4gYSA/IDEgOiBiID49IGEgPyAwIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3Rvci5qcwpmdW5jdGlvbiBiaXNlY3RvcihmKSB7CiAgbGV0IGNvbXBhcmUxLCBjb21wYXJlMiwgZGVsdGE7CiAgaWYgKGYubGVuZ3RoICE9PSAyKSB7CiAgICBjb21wYXJlMSA9IGFzY2VuZGluZzsKICAgIGNvbXBhcmUyID0gKGQsIHgyKSA9PiBhc2NlbmRpbmcoZihkKSwgeDIpOwogICAgZGVsdGEgPSAoZCwgeDIpID0+IGYoZCkgLSB4MjsKICB9IGVsc2UgewogICAgY29tcGFyZTEgPSBmID09PSBhc2NlbmRpbmcgfHwgZiA9PT0gZGVzY2VuZGluZyA/IGYgOiB6ZXJvOwogICAgY29tcGFyZTIgPSBmOwogICAgZGVsdGEgPSBmOwogIH0KICBmdW5jdGlvbiBsZWZ0KGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGlmIChsbyA8IGhpKSB7CiAgICAgIGlmIChjb21wYXJlMSh4MiwgeDIpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgyKSA8IDApIGxvID0gbWlkICsgMTsKICAgICAgICBlbHNlIGhpID0gbWlkOwogICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgIH0KICAgIHJldHVybiBsbzsKICB9CiAgZnVuY3Rpb24gcmlnaHQoYSwgeDIsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgaWYgKGxvIDwgaGkpIHsKICAgICAgaWYgKGNvbXBhcmUxKHgyLCB4MikgIT09IDApIHJldHVybiBoaTsKICAgICAgZG8gewogICAgICAgIGNvbnN0IG1pZCA9IGxvICsgaGkgPj4+IDE7CiAgICAgICAgaWYgKGNvbXBhcmUyKGFbbWlkXSwgeDIpIDw9IDApIGxvID0gbWlkICsgMTsKICAgICAgICBlbHNlIGhpID0gbWlkOwogICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgIH0KICAgIHJldHVybiBsbzsKICB9CiAgZnVuY3Rpb24gY2VudGVyKGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGNvbnN0IGkgPSBsZWZ0KGEsIHgyLCBsbywgaGkgLSAxKTsKICAgIHJldHVybiBpID4gbG8gJiYgZGVsdGEoYVtpIC0gMV0sIHgyKSA+IC1kZWx0YShhW2ldLCB4MikgPyBpIC0gMSA6IGk7CiAgfQogIHJldHVybiB7IGxlZnQsIGNlbnRlciwgcmlnaHQgfTsKfQpmdW5jdGlvbiB6ZXJvKCkgewogIHJldHVybiAwOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyKHgyKSB7CiAgcmV0dXJuIHgyID09PSBudWxsID8gTmFOIDogK3gyOwp9CmZ1bmN0aW9uKiBudW1iZXJzKHZhbHVlcywgdmFsdWVvZikgewogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAodmFsdWUgPSArdmFsdWUpID49IHZhbHVlKSB7CiAgICAgICAgeWllbGQgdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKHZhbHVlID0gK3ZhbHVlKSA+PSB2YWx1ZSkgewogICAgICAgIHlpZWxkIHZhbHVlOwogICAgICB9CiAgICB9CiAgfQp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3QuanMKdmFyIGFzY2VuZGluZ0Jpc2VjdCA9IGJpc2VjdG9yKGFzY2VuZGluZyk7CnZhciBiaXNlY3RSaWdodCA9IGFzY2VuZGluZ0Jpc2VjdC5yaWdodDsKdmFyIGJpc2VjdExlZnQgPSBhc2NlbmRpbmdCaXNlY3QubGVmdDsKdmFyIGJpc2VjdENlbnRlciA9IGJpc2VjdG9yKG51bWJlcikuY2VudGVyOwp2YXIgYmlzZWN0X2RlZmF1bHQgPSBiaXNlY3RSaWdodDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9pbnRlcm5tYXBAMi4wLjMvbm9kZV9tb2R1bGVzL2ludGVybm1hcC9zcmMvaW5kZXguanMKdmFyIEludGVybk1hcCA9IGNsYXNzIGV4dGVuZHMgTWFwIHsKICBjb25zdHJ1Y3RvcihlbnRyaWVzLCBrZXkgPSBrZXlvZikgewogICAgc3VwZXIoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsgX2ludGVybjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSB9LCBfa2V5OiB7IHZhbHVlOiBrZXkgfSB9KTsKICAgIGlmIChlbnRyaWVzICE9IG51bGwpIGZvciAoY29uc3QgW2tleTIsIHZhbHVlXSBvZiBlbnRyaWVzKSB0aGlzLnNldChrZXkyLCB2YWx1ZSk7CiAgfQogIGdldChrZXkpIHsKICAgIHJldHVybiBzdXBlci5nZXQoaW50ZXJuX2dldCh0aGlzLCBrZXkpKTsKICB9CiAgaGFzKGtleSkgewogICAgcmV0dXJuIHN1cGVyLmhhcyhpbnRlcm5fZ2V0KHRoaXMsIGtleSkpOwogIH0KICBzZXQoa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIHN1cGVyLnNldChpbnRlcm5fc2V0KHRoaXMsIGtleSksIHZhbHVlKTsKICB9CiAgZGVsZXRlKGtleSkgewogICAgcmV0dXJuIHN1cGVyLmRlbGV0ZShpbnRlcm5fZGVsZXRlKHRoaXMsIGtleSkpOwogIH0KfTsKZnVuY3Rpb24gaW50ZXJuX2dldCh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICByZXR1cm4gX2ludGVybi5oYXMoa2V5KSA/IF9pbnRlcm4uZ2V0KGtleSkgOiB2YWx1ZTsKfQpmdW5jdGlvbiBpbnRlcm5fc2V0KHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIGlmIChfaW50ZXJuLmhhcyhrZXkpKSByZXR1cm4gX2ludGVybi5nZXQoa2V5KTsKICBfaW50ZXJuLnNldChrZXksIHZhbHVlKTsKICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gaW50ZXJuX2RlbGV0ZSh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICBpZiAoX2ludGVybi5oYXMoa2V5KSkgewogICAgdmFsdWUgPSBfaW50ZXJuLmdldChrZXkpOwogICAgX2ludGVybi5kZWxldGUoa2V5KTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGtleW9mKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgPyB2YWx1ZS52YWx1ZU9mKCkgOiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvc29ydC5qcwpmdW5jdGlvbiBjb21wYXJlRGVmaW5lZChjb21wYXJlID0gYXNjZW5kaW5nKSB7CiAgaWYgKGNvbXBhcmUgPT09IGFzY2VuZGluZykgcmV0dXJuIGFzY2VuZGluZ0RlZmluZWQ7CiAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJjb21wYXJlIGlzIG5vdCBhIGZ1bmN0aW9uIik7CiAgcmV0dXJuIChhLCBiKSA9PiB7CiAgICBjb25zdCB4MiA9IGNvbXBhcmUoYSwgYik7CiAgICBpZiAoeDIgfHwgeDIgPT09IDApIHJldHVybiB4MjsKICAgIHJldHVybiAoY29tcGFyZShiLCBiKSA9PT0gMCkgLSAoY29tcGFyZShhLCBhKSA9PT0gMCk7CiAgfTsKfQpmdW5jdGlvbiBhc2NlbmRpbmdEZWZpbmVkKGEsIGIpIHsKICByZXR1cm4gKGEgPT0gbnVsbCB8fCAhKGEgPj0gYSkpIC0gKGIgPT0gbnVsbCB8fCAhKGIgPj0gYikpIHx8IChhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogMCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3RpY2tzLmpzCnZhciBlMTAgPSBNYXRoLnNxcnQoNTApOwp2YXIgZTUgPSBNYXRoLnNxcnQoMTApOwp2YXIgZTIgPSBNYXRoLnNxcnQoMik7CmZ1bmN0aW9uIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIGNvbnN0IHN0ZXAgPSAoc3RvcCAtIHN0YXJ0KSAvIE1hdGgubWF4KDAsIGNvdW50KSwgcG93ZXIgPSBNYXRoLmZsb29yKE1hdGgubG9nMTAoc3RlcCkpLCBlcnJvciA9IHN0ZXAgLyBNYXRoLnBvdygxMCwgcG93ZXIpLCBmYWN0b3IgPSBlcnJvciA+PSBlMTAgPyAxMCA6IGVycm9yID49IGU1ID8gNSA6IGVycm9yID49IGUyID8gMiA6IDE7CiAgbGV0IGkxLCBpMiwgaW5jOwogIGlmIChwb3dlciA8IDApIHsKICAgIGluYyA9IE1hdGgucG93KDEwLCAtcG93ZXIpIC8gZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0ICogaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wICogaW5jKTsKICAgIGlmIChpMSAvIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyIC8gaW5jID4gc3RvcCkgLS1pMjsKICAgIGluYyA9IC1pbmM7CiAgfSBlbHNlIHsKICAgIGluYyA9IE1hdGgucG93KDEwLCBwb3dlcikgKiBmYWN0b3I7CiAgICBpMSA9IE1hdGgucm91bmQoc3RhcnQgLyBpbmMpOwogICAgaTIgPSBNYXRoLnJvdW5kKHN0b3AgLyBpbmMpOwogICAgaWYgKGkxICogaW5jIDwgc3RhcnQpICsraTE7CiAgICBpZiAoaTIgKiBpbmMgPiBzdG9wKSAtLWkyOwogIH0KICBpZiAoaTIgPCBpMSAmJiAwLjUgPD0gY291bnQgJiYgY291bnQgPCAyKSByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50ICogMik7CiAgcmV0dXJuIFtpMSwgaTIsIGluY107Cn0KZnVuY3Rpb24gdGlja3Moc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgc3RvcCA9ICtzdG9wLCBzdGFydCA9ICtzdGFydCwgY291bnQgPSArY291bnQ7CiAgaWYgKCEoY291bnQgPiAwKSkgcmV0dXJuIFtdOwogIGlmIChzdGFydCA9PT0gc3RvcCkgcmV0dXJuIFtzdGFydF07CiAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQsIFtpMSwgaTIsIGluY10gPSByZXZlcnNlMiA/IHRpY2tTcGVjKHN0b3AsIHN0YXJ0LCBjb3VudCkgOiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpOwogIGlmICghKGkyID49IGkxKSkgcmV0dXJuIFtdOwogIGNvbnN0IG4gPSBpMiAtIGkxICsgMSwgdGlja3MyID0gbmV3IEFycmF5KG4pOwogIGlmIChyZXZlcnNlMikgewogICAgaWYgKGluYyA8IDApIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTIgLSBpKSAvIC1pbmM7CiAgICBlbHNlIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTIgLSBpKSAqIGluYzsKICB9IGVsc2UgewogICAgaWYgKGluYyA8IDApIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTEgKyBpKSAvIC1pbmM7CiAgICBlbHNlIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTEgKyBpKSAqIGluYzsKICB9CiAgcmV0dXJuIHRpY2tzMjsKfQpmdW5jdGlvbiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIHJldHVybiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpWzJdOwp9CmZ1bmN0aW9uIHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0LCBpbmMgPSByZXZlcnNlMiA/IHRpY2tJbmNyZW1lbnQoc3RvcCwgc3RhcnQsIGNvdW50KSA6IHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50KTsKICByZXR1cm4gKHJldmVyc2UyID8gLTEgOiAxKSAqIChpbmMgPCAwID8gMSAvIC1pbmMgOiBpbmMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9tYXguanMKZnVuY3Rpb24gbWF4KHZhbHVlcywgdmFsdWVvZikgewogIGxldCBtYXgyOwogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChtYXgyIDwgdmFsdWUgfHwgbWF4MiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1heDIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAobWF4MiA8IHZhbHVlIHx8IG1heDIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtYXgyID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1heDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL21pbi5qcwpmdW5jdGlvbiBtaW4odmFsdWVzLCB2YWx1ZW9mKSB7CiAgbGV0IG1pbjI7CiAgaWYgKHZhbHVlb2YgPT09IHZvaWQgMCkgewogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKG1pbjIgPiB2YWx1ZSB8fCBtaW4yID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWluMiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGxldCBpbmRleCA9IC0xOwogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICgodmFsdWUgPSB2YWx1ZW9mKHZhbHVlLCArK2luZGV4LCB2YWx1ZXMpKSAhPSBudWxsICYmIChtaW4yID4gdmFsdWUgfHwgbWluMiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1pbjIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbWluMjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVpY2tzZWxlY3QuanMKZnVuY3Rpb24gcXVpY2tzZWxlY3QoYXJyYXksIGssIGxlZnQgPSAwLCByaWdodCA9IEluZmluaXR5LCBjb21wYXJlKSB7CiAgayA9IE1hdGguZmxvb3Ioayk7CiAgbGVmdCA9IE1hdGguZmxvb3IoTWF0aC5tYXgoMCwgbGVmdCkpOwogIHJpZ2h0ID0gTWF0aC5mbG9vcihNYXRoLm1pbihhcnJheS5sZW5ndGggLSAxLCByaWdodCkpOwogIGlmICghKGxlZnQgPD0gayAmJiBrIDw9IHJpZ2h0KSkgcmV0dXJuIGFycmF5OwogIGNvbXBhcmUgPSBjb21wYXJlID09PSB2b2lkIDAgPyBhc2NlbmRpbmdEZWZpbmVkIDogY29tcGFyZURlZmluZWQoY29tcGFyZSk7CiAgd2hpbGUgKHJpZ2h0ID4gbGVmdCkgewogICAgaWYgKHJpZ2h0IC0gbGVmdCA+IDYwMCkgewogICAgICBjb25zdCBuID0gcmlnaHQgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgbSA9IGsgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgeiA9IE1hdGgubG9nKG4pOwogICAgICBjb25zdCBzID0gMC41ICogTWF0aC5leHAoMiAqIHogLyAzKTsKICAgICAgY29uc3Qgc2QgPSAwLjUgKiBNYXRoLnNxcnQoeiAqIHMgKiAobiAtIHMpIC8gbikgKiAobSAtIG4gLyAyIDwgMCA/IC0xIDogMSk7CiAgICAgIGNvbnN0IG5ld0xlZnQgPSBNYXRoLm1heChsZWZ0LCBNYXRoLmZsb29yKGsgLSBtICogcyAvIG4gKyBzZCkpOwogICAgICBjb25zdCBuZXdSaWdodCA9IE1hdGgubWluKHJpZ2h0LCBNYXRoLmZsb29yKGsgKyAobiAtIG0pICogcyAvIG4gKyBzZCkpOwogICAgICBxdWlja3NlbGVjdChhcnJheSwgaywgbmV3TGVmdCwgbmV3UmlnaHQsIGNvbXBhcmUpOwogICAgfQogICAgY29uc3QgdCA9IGFycmF5W2tdOwogICAgbGV0IGkgPSBsZWZ0OwogICAgbGV0IGogPSByaWdodDsKICAgIHN3YXAoYXJyYXksIGxlZnQsIGspOwogICAgaWYgKGNvbXBhcmUoYXJyYXlbcmlnaHRdLCB0KSA+IDApIHN3YXAoYXJyYXksIGxlZnQsIHJpZ2h0KTsKICAgIHdoaWxlIChpIDwgaikgewogICAgICBzd2FwKGFycmF5LCBpLCBqKSwgKytpLCAtLWo7CiAgICAgIHdoaWxlIChjb21wYXJlKGFycmF5W2ldLCB0KSA8IDApICsraTsKICAgICAgd2hpbGUgKGNvbXBhcmUoYXJyYXlbal0sIHQpID4gMCkgLS1qOwogICAgfQogICAgaWYgKGNvbXBhcmUoYXJyYXlbbGVmdF0sIHQpID09PSAwKSBzd2FwKGFycmF5LCBsZWZ0LCBqKTsKICAgIGVsc2UgKytqLCBzd2FwKGFycmF5LCBqLCByaWdodCk7CiAgICBpZiAoaiA8PSBrKSBsZWZ0ID0gaiArIDE7CiAgICBpZiAoayA8PSBqKSByaWdodCA9IGogLSAxOwogIH0KICByZXR1cm4gYXJyYXk7Cn0KZnVuY3Rpb24gc3dhcChhcnJheSwgaSwgaikgewogIGNvbnN0IHQgPSBhcnJheVtpXTsKICBhcnJheVtpXSA9IGFycmF5W2pdOwogIGFycmF5W2pdID0gdDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVhbnRpbGUuanMKZnVuY3Rpb24gcXVhbnRpbGUodmFsdWVzLCBwLCB2YWx1ZW9mKSB7CiAgdmFsdWVzID0gRmxvYXQ2NEFycmF5LmZyb20obnVtYmVycyh2YWx1ZXMsIHZhbHVlb2YpKTsKICBpZiAoIShuID0gdmFsdWVzLmxlbmd0aCkgfHwgaXNOYU4ocCA9ICtwKSkgcmV0dXJuOwogIGlmIChwIDw9IDAgfHwgbiA8IDIpIHJldHVybiBtaW4odmFsdWVzKTsKICBpZiAocCA+PSAxKSByZXR1cm4gbWF4KHZhbHVlcyk7CiAgdmFyIG4sIGkgPSAobiAtIDEpICogcCwgaTAgPSBNYXRoLmZsb29yKGkpLCB2YWx1ZTAgPSBtYXgocXVpY2tzZWxlY3QodmFsdWVzLCBpMCkuc3ViYXJyYXkoMCwgaTAgKyAxKSksIHZhbHVlMSA9IG1pbih2YWx1ZXMuc3ViYXJyYXkoaTAgKyAxKSk7CiAgcmV0dXJuIHZhbHVlMCArICh2YWx1ZTEgLSB2YWx1ZTApICogKGkgLSBpMCk7Cn0KZnVuY3Rpb24gcXVhbnRpbGVTb3J0ZWQodmFsdWVzLCBwLCB2YWx1ZW9mID0gbnVtYmVyKSB7CiAgaWYgKCEobiA9IHZhbHVlcy5sZW5ndGgpIHx8IGlzTmFOKHAgPSArcCkpIHJldHVybjsKICBpZiAocCA8PSAwIHx8IG4gPCAyKSByZXR1cm4gK3ZhbHVlb2YodmFsdWVzWzBdLCAwLCB2YWx1ZXMpOwogIGlmIChwID49IDEpIHJldHVybiArdmFsdWVvZih2YWx1ZXNbbiAtIDFdLCBuIC0gMSwgdmFsdWVzKTsKICB2YXIgbiwgaSA9IChuIC0gMSkgKiBwLCBpMCA9IE1hdGguZmxvb3IoaSksIHZhbHVlMCA9ICt2YWx1ZW9mKHZhbHVlc1tpMF0sIGkwLCB2YWx1ZXMpLCB2YWx1ZTEgPSArdmFsdWVvZih2YWx1ZXNbaTAgKyAxXSwgaTAgKyAxLCB2YWx1ZXMpOwogIHJldHVybiB2YWx1ZTAgKyAodmFsdWUxIC0gdmFsdWUwKSAqIChpIC0gaTApOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9yYW5nZS5qcwpmdW5jdGlvbiByYW5nZShzdGFydCwgc3RvcCwgc3RlcCkgewogIHN0YXJ0ID0gK3N0YXJ0LCBzdG9wID0gK3N0b3AsIHN0ZXAgPSAobiA9IGFyZ3VtZW50cy5sZW5ndGgpIDwgMiA/IChzdG9wID0gc3RhcnQsIHN0YXJ0ID0gMCwgMSkgOiBuIDwgMyA/IDEgOiArc3RlcDsKICB2YXIgaSA9IC0xLCBuID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCkpIHwgMCwgcmFuZ2U0ID0gbmV3IEFycmF5KG4pOwogIHdoaWxlICgrK2kgPCBuKSB7CiAgICByYW5nZTRbaV0gPSBzdGFydCArIGkgKiBzdGVwOwogIH0KICByZXR1cm4gcmFuZ2U0Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9pbml0LmpzCmZ1bmN0aW9uIGluaXRSYW5nZShkb21haW4sIHJhbmdlNCkgewogIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgY2FzZSAwOgogICAgICBicmVhazsKICAgIGNhc2UgMToKICAgICAgdGhpcy5yYW5nZShkb21haW4pOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRoaXMucmFuZ2UocmFuZ2U0KS5kb21haW4oZG9tYWluKTsKICAgICAgYnJlYWs7CiAgfQogIHJldHVybiB0aGlzOwp9CmZ1bmN0aW9uIGluaXRJbnRlcnBvbGF0b3IoZG9tYWluLCBpbnRlcnBvbGF0b3IpIHsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6IHsKICAgICAgaWYgKHR5cGVvZiBkb21haW4gPT09ICJmdW5jdGlvbiIpIHRoaXMuaW50ZXJwb2xhdG9yKGRvbWFpbik7CiAgICAgIGVsc2UgdGhpcy5yYW5nZShkb21haW4pOwogICAgICBicmVhazsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgdGhpcy5kb21haW4oZG9tYWluKTsKICAgICAgaWYgKHR5cGVvZiBpbnRlcnBvbGF0b3IgPT09ICJmdW5jdGlvbiIpIHRoaXMuaW50ZXJwb2xhdG9yKGludGVycG9sYXRvcik7CiAgICAgIGVsc2UgdGhpcy5yYW5nZShpbnRlcnBvbGF0b3IpOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIHRoaXM7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL29yZGluYWwuanMKdmFyIGltcGxpY2l0ID0gU3ltYm9sKCJpbXBsaWNpdCIpOwpmdW5jdGlvbiBvcmRpbmFsKCkgewogIHZhciBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKSwgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB1bmtub3duID0gaW1wbGljaXQ7CiAgZnVuY3Rpb24gc2NhbGUoZCkgewogICAgbGV0IGkgPSBpbmRleC5nZXQoZCk7CiAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgIGlmICh1bmtub3duICE9PSBpbXBsaWNpdCkgcmV0dXJuIHVua25vd247CiAgICAgIGluZGV4LnNldChkLCBpID0gZG9tYWluLnB1c2goZCkgLSAxKTsKICAgIH0KICAgIHJldHVybiByYW5nZTRbaSAlIHJhbmdlNC5sZW5ndGhdOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdLCBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgXykgewogICAgICBpZiAoaW5kZXguaGFzKHZhbHVlKSkgY29udGludWU7CiAgICAgIGluZGV4LnNldCh2YWx1ZSwgZG9tYWluLnB1c2godmFsdWUpIC0gMSk7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHNjYWxlKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG9yZGluYWwoZG9tYWluLCByYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9iYW5kLmpzCmZ1bmN0aW9uIGJhbmQoKSB7CiAgdmFyIHNjYWxlID0gb3JkaW5hbCgpLnVua25vd24odm9pZCAwKSwgZG9tYWluID0gc2NhbGUuZG9tYWluLCBvcmRpbmFsUmFuZ2UgPSBzY2FsZS5yYW5nZSwgcjAgPSAwLCByMSA9IDEsIHN0ZXAsIGJhbmR3aWR0aCwgcm91bmQgPSBmYWxzZSwgcGFkZGluZ0lubmVyID0gMCwgcGFkZGluZ091dGVyID0gMCwgYWxpZ24gPSAwLjU7CiAgZGVsZXRlIHNjYWxlLnVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBuID0gZG9tYWluKCkubGVuZ3RoLCByZXZlcnNlMiA9IHIxIDwgcjAsIHN0YXJ0ID0gcmV2ZXJzZTIgPyByMSA6IHIwLCBzdG9wID0gcmV2ZXJzZTIgPyByMCA6IHIxOwogICAgc3RlcCA9IChzdG9wIC0gc3RhcnQpIC8gTWF0aC5tYXgoMSwgbiAtIHBhZGRpbmdJbm5lciArIHBhZGRpbmdPdXRlciAqIDIpOwogICAgaWYgKHJvdW5kKSBzdGVwID0gTWF0aC5mbG9vcihzdGVwKTsKICAgIHN0YXJ0ICs9IChzdG9wIC0gc3RhcnQgLSBzdGVwICogKG4gLSBwYWRkaW5nSW5uZXIpKSAqIGFsaWduOwogICAgYmFuZHdpZHRoID0gc3RlcCAqICgxIC0gcGFkZGluZ0lubmVyKTsKICAgIGlmIChyb3VuZCkgc3RhcnQgPSBNYXRoLnJvdW5kKHN0YXJ0KSwgYmFuZHdpZHRoID0gTWF0aC5yb3VuZChiYW5kd2lkdGgpOwogICAgdmFyIHZhbHVlcyA9IHJhbmdlKG4pLm1hcChmdW5jdGlvbihpKSB7CiAgICAgIHJldHVybiBzdGFydCArIHN0ZXAgKiBpOwogICAgfSk7CiAgICByZXR1cm4gb3JkaW5hbFJhbmdlKHJldmVyc2UyID8gdmFsdWVzLnJldmVyc2UoKSA6IHZhbHVlcyk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbihfKSwgcmVzY2FsZSgpKSA6IGRvbWFpbigpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxXSA9IF8sIHIwID0gK3IwLCByMSA9ICtyMSwgcmVzY2FsZSgpKSA6IFtyMCwgcjFdOwogIH07CiAgc2NhbGUucmFuZ2VSb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBbcjAsIHIxXSA9IF8sIHIwID0gK3IwLCByMSA9ICtyMSwgcm91bmQgPSB0cnVlLCByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5iYW5kd2lkdGggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiYW5kd2lkdGg7CiAgfTsKICBzY2FsZS5zdGVwID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc3RlcDsKICB9OwogIHNjYWxlLnJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocm91bmQgPSAhIV8sIHJlc2NhbGUoKSkgOiByb3VuZDsKICB9OwogIHNjYWxlLnBhZGRpbmcgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nSW5uZXIgPSBNYXRoLm1pbigxLCBwYWRkaW5nT3V0ZXIgPSArXyksIHJlc2NhbGUoKSkgOiBwYWRkaW5nSW5uZXI7CiAgfTsKICBzY2FsZS5wYWRkaW5nSW5uZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nSW5uZXIgPSBNYXRoLm1pbigxLCBfKSwgcmVzY2FsZSgpKSA6IHBhZGRpbmdJbm5lcjsKICB9OwogIHNjYWxlLnBhZGRpbmdPdXRlciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdPdXRlciA9ICtfLCByZXNjYWxlKCkpIDogcGFkZGluZ091dGVyOwogIH07CiAgc2NhbGUuYWxpZ24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChhbGlnbiA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIF8pKSwgcmVzY2FsZSgpKSA6IGFsaWduOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGJhbmQoZG9tYWluKCksIFtyMCwgcjFdKS5yb3VuZChyb3VuZCkucGFkZGluZ0lubmVyKHBhZGRpbmdJbm5lcikucGFkZGluZ091dGVyKHBhZGRpbmdPdXRlcikuYWxpZ24oYWxpZ24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShyZXNjYWxlKCksIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gcG9pbnRpc2goc2NhbGUpIHsKICB2YXIgY29weTMgPSBzY2FsZS5jb3B5OwogIHNjYWxlLnBhZGRpbmcgPSBzY2FsZS5wYWRkaW5nT3V0ZXI7CiAgZGVsZXRlIHNjYWxlLnBhZGRpbmdJbm5lcjsKICBkZWxldGUgc2NhbGUucGFkZGluZ091dGVyOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBwb2ludGlzaChjb3B5MygpKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBwb2ludDMoKSB7CiAgcmV0dXJuIHBvaW50aXNoKGJhbmQuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5wYWRkaW5nSW5uZXIoMSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtY29sb3JAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9kZWZpbmUuanMKZnVuY3Rpb24gZGVmaW5lX2RlZmF1bHQoY29uc3RydWN0b3IsIGZhY3RvcnksIHByb3RvdHlwZSkgewogIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IGZhY3RvcnkucHJvdG90eXBlID0gcHJvdG90eXBlOwogIHByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwp9CmZ1bmN0aW9uIGV4dGVuZChwYXJlbnQsIGRlZmluaXRpb24pIHsKICB2YXIgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKICBmb3IgKHZhciBrZXkgaW4gZGVmaW5pdGlvbikgcHJvdG90eXBlW2tleV0gPSBkZWZpbml0aW9uW2tleV07CiAgcmV0dXJuIHByb3RvdHlwZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWNvbG9yQDMuMS4wL25vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvY29sb3IuanMKZnVuY3Rpb24gQ29sb3IoKSB7Cn0KdmFyIGRhcmtlciA9IDAuNzsKdmFyIGJyaWdodGVyID0gMSAvIGRhcmtlcjsKdmFyIHJlSSA9ICJcXHMqKFsrLV0/XFxkKylcXHMqIjsKdmFyIHJlTiA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPylcXHMqIjsKdmFyIHJlUCA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPyklXFxzKiI7CnZhciByZUhleCA9IC9eIyhbMC05YS1mXXszLDh9KSQvOwp2YXIgcmVSZ2JJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVJfSwke3JlSX0sJHtyZUl9XFwpJGApOwp2YXIgcmVSZ2JQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVQfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVSZ2JhSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZUl9LCR7cmVJfSwke3JlSX0sJHtyZU59XFwpJGApOwp2YXIgcmVSZ2JhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZVB9LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgcmVIc2xQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbFxcKCR7cmVOfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVIc2xhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xhXFwoJHtyZU59LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgbmFtZWQgPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9OwpkZWZpbmVfZGVmYXVsdChDb2xvciwgY29sb3IsIHsKICBjb3B5KGNoYW5uZWxzKSB7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLCB0aGlzLCBjaGFubmVscyk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLnJnYigpLmRpc3BsYXlhYmxlKCk7CiAgfSwKICBoZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogY29sb3JfZm9ybWF0SGV4LAogIGZvcm1hdEhleDg6IGNvbG9yX2Zvcm1hdEhleDgsCiAgZm9ybWF0SHNsOiBjb2xvcl9mb3JtYXRIc2wsCiAgZm9ybWF0UmdiOiBjb2xvcl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IGNvbG9yX2Zvcm1hdFJnYgp9KTsKZnVuY3Rpb24gY29sb3JfZm9ybWF0SGV4KCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4OCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhzbCgpIHsKICByZXR1cm4gaHNsQ29udmVydCh0aGlzKS5mb3JtYXRIc2woKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRSZ2IoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0UmdiKCk7Cn0KZnVuY3Rpb24gY29sb3IoZm9ybWF0MikgewogIHZhciBtLCBsOwogIGZvcm1hdDIgPSAoZm9ybWF0MiArICIiKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICByZXR1cm4gKG0gPSByZUhleC5leGVjKGZvcm1hdDIpKSA/IChsID0gbVsxXS5sZW5ndGgsIG0gPSBwYXJzZUludChtWzFdLCAxNiksIGwgPT09IDYgPyByZ2JuKG0pIDogbCA9PT0gMyA/IG5ldyBSZ2IobSA+PiA4ICYgMTUgfCBtID4+IDQgJiAyNDAsIG0gPj4gNCAmIDE1IHwgbSAmIDI0MCwgKG0gJiAxNSkgPDwgNCB8IG0gJiAxNSwgMSkgOiBsID09PSA4ID8gcmdiYShtID4+IDI0ICYgMjU1LCBtID4+IDE2ICYgMjU1LCBtID4+IDggJiAyNTUsIChtICYgMjU1KSAvIDI1NSkgOiBsID09PSA0ID8gcmdiYShtID4+IDEyICYgMTUgfCBtID4+IDggJiAyNDAsIG0gPj4gOCAmIDE1IHwgbSA+PiA0ICYgMjQwLCBtID4+IDQgJiAxNSB8IG0gJiAyNDAsICgobSAmIDE1KSA8PCA0IHwgbSAmIDE1KSAvIDI1NSkgOiBudWxsKSA6IChtID0gcmVSZ2JJbnRlZ2VyLmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdLCBtWzJdLCBtWzNdLCAxKSA6IChtID0gcmVSZ2JQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdICogMjU1IC8gMTAwLCBtWzJdICogMjU1IC8gMTAwLCBtWzNdICogMjU1IC8gMTAwLCAxKSA6IChtID0gcmVSZ2JhSW50ZWdlci5leGVjKGZvcm1hdDIpKSA/IHJnYmEobVsxXSwgbVsyXSwgbVszXSwgbVs0XSkgOiAobSA9IHJlUmdiYVBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyByZ2JhKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIG1bNF0pIDogKG0gPSByZUhzbFBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIDEpIDogKG0gPSByZUhzbGFQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gaHNsYShtWzFdLCBtWzJdIC8gMTAwLCBtWzNdIC8gMTAwLCBtWzRdKSA6IG5hbWVkLmhhc093blByb3BlcnR5KGZvcm1hdDIpID8gcmdibihuYW1lZFtmb3JtYXQyXSkgOiBmb3JtYXQyID09PSAidHJhbnNwYXJlbnQiID8gbmV3IFJnYihOYU4sIE5hTiwgTmFOLCAwKSA6IG51bGw7Cn0KZnVuY3Rpb24gcmdibihuKSB7CiAgcmV0dXJuIG5ldyBSZ2IobiA+PiAxNiAmIDI1NSwgbiA+PiA4ICYgMjU1LCBuICYgMjU1LCAxKTsKfQpmdW5jdGlvbiByZ2JhKHIyLCBnLCBiLCBhKSB7CiAgaWYgKGEgPD0gMCkgcjIgPSBnID0gYiA9IE5hTjsKICByZXR1cm4gbmV3IFJnYihyMiwgZywgYiwgYSk7Cn0KZnVuY3Rpb24gcmdiQ29udmVydChvKSB7CiAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogIGlmICghbykgcmV0dXJuIG5ldyBSZ2IoKTsKICBvID0gby5yZ2IoKTsKICByZXR1cm4gbmV3IFJnYihvLnIsIG8uZywgby5iLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIHJnYihyMiwgZywgYiwgb3BhY2l0eSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gcmdiQ29udmVydChyMikgOiBuZXcgUmdiKHIyLCBnLCBiLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gUmdiKHIyLCBnLCBiLCBvcGFjaXR5KSB7CiAgdGhpcy5yID0gK3IyOwogIHRoaXMuZyA9ICtnOwogIHRoaXMuYiA9ICtiOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KFJnYiwgcmdiLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgayk7CiAgICByZXR1cm4gbmV3IFJnYih0aGlzLnIgKiBrLCB0aGlzLmcgKiBrLCB0aGlzLmIgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGspOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHJldHVybiB0aGlzOwogIH0sCiAgY2xhbXAoKSB7CiAgICByZXR1cm4gbmV3IFJnYihjbGFtcGkodGhpcy5yKSwgY2xhbXBpKHRoaXMuZyksIGNsYW1waSh0aGlzLmIpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiAtMC41IDw9IHRoaXMuciAmJiB0aGlzLnIgPCAyNTUuNSAmJiAoLTAuNSA8PSB0aGlzLmcgJiYgdGhpcy5nIDwgMjU1LjUpICYmICgtMC41IDw9IHRoaXMuYiAmJiB0aGlzLmIgPCAyNTUuNSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGhleDogcmdiX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogcmdiX2Zvcm1hdEhleCwKICBmb3JtYXRIZXg4OiByZ2JfZm9ybWF0SGV4OCwKICBmb3JtYXRSZ2I6IHJnYl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IHJnYl9mb3JtYXRSZ2IKfSkpOwpmdW5jdGlvbiByZ2JfZm9ybWF0SGV4KCkgewogIHJldHVybiBgIyR7aGV4KHRoaXMucil9JHtoZXgodGhpcy5nKX0ke2hleCh0aGlzLmIpfWA7Cn0KZnVuY3Rpb24gcmdiX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9JHtoZXgoKGlzTmFOKHRoaXMub3BhY2l0eSkgPyAxIDogdGhpcy5vcGFjaXR5KSAqIDI1NSl9YDsKfQpmdW5jdGlvbiByZ2JfZm9ybWF0UmdiKCkgewogIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICByZXR1cm4gYCR7YSA9PT0gMSA/ICJyZ2IoIiA6ICJyZ2JhKCJ9JHtjbGFtcGkodGhpcy5yKX0sICR7Y2xhbXBpKHRoaXMuZyl9LCAke2NsYW1waSh0aGlzLmIpfSR7YSA9PT0gMSA/ICIpIiA6IGAsICR7YX0pYH1gOwp9CmZ1bmN0aW9uIGNsYW1wYShvcGFjaXR5KSB7CiAgcmV0dXJuIGlzTmFOKG9wYWNpdHkpID8gMSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wYWNpdHkpKTsKfQpmdW5jdGlvbiBjbGFtcGkodmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMjU1LCBNYXRoLnJvdW5kKHZhbHVlKSB8fCAwKSk7Cn0KZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgdmFsdWUgPSBjbGFtcGkodmFsdWUpOwogIHJldHVybiAodmFsdWUgPCAxNiA/ICIwIiA6ICIiKSArIHZhbHVlLnRvU3RyaW5nKDE2KTsKfQpmdW5jdGlvbiBoc2xhKGgsIHMsIGwsIGEpIHsKICBpZiAoYSA8PSAwKSBoID0gcyA9IGwgPSBOYU47CiAgZWxzZSBpZiAobCA8PSAwIHx8IGwgPj0gMSkgaCA9IHMgPSBOYU47CiAgZWxzZSBpZiAocyA8PSAwKSBoID0gTmFOOwogIHJldHVybiBuZXcgSHNsKGgsIHMsIGwsIGEpOwp9CmZ1bmN0aW9uIGhzbENvbnZlcnQobykgewogIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbmV3IEhzbChvLmgsIG8ucywgby5sLCBvLm9wYWNpdHkpOwogIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpIG8gPSBjb2xvcihvKTsKICBpZiAoIW8pIHJldHVybiBuZXcgSHNsKCk7CiAgaWYgKG8gaW5zdGFuY2VvZiBIc2wpIHJldHVybiBvOwogIG8gPSBvLnJnYigpOwogIHZhciByMiA9IG8uciAvIDI1NSwgZyA9IG8uZyAvIDI1NSwgYiA9IG8uYiAvIDI1NSwgbWluMiA9IE1hdGgubWluKHIyLCBnLCBiKSwgbWF4MiA9IE1hdGgubWF4KHIyLCBnLCBiKSwgaCA9IE5hTiwgcyA9IG1heDIgLSBtaW4yLCBsID0gKG1heDIgKyBtaW4yKSAvIDI7CiAgaWYgKHMpIHsKICAgIGlmIChyMiA9PT0gbWF4MikgaCA9IChnIC0gYikgLyBzICsgKGcgPCBiKSAqIDY7CiAgICBlbHNlIGlmIChnID09PSBtYXgyKSBoID0gKGIgLSByMikgLyBzICsgMjsKICAgIGVsc2UgaCA9IChyMiAtIGcpIC8gcyArIDQ7CiAgICBzIC89IGwgPCAwLjUgPyBtYXgyICsgbWluMiA6IDIgLSBtYXgyIC0gbWluMjsKICAgIGggKj0gNjA7CiAgfSBlbHNlIHsKICAgIHMgPSBsID4gMCAmJiBsIDwgMSA/IDAgOiBoOwogIH0KICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIGhzbChoLCBzLCBsLCBvcGFjaXR5KSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBoc2xDb252ZXJ0KGgpIDogbmV3IEhzbChoLCBzLCBsLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gSHNsKGgsIHMsIGwsIG9wYWNpdHkpIHsKICB0aGlzLmggPSAraDsKICB0aGlzLnMgPSArczsKICB0aGlzLmwgPSArbDsKICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKfQpkZWZpbmVfZGVmYXVsdChIc2wsIGhzbCwgZXh0ZW5kKENvbG9yLCB7CiAgYnJpZ2h0ZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICBkYXJrZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGRhcmtlciA6IE1hdGgucG93KGRhcmtlciwgayk7CiAgICByZXR1cm4gbmV3IEhzbCh0aGlzLmgsIHRoaXMucywgdGhpcy5sICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHZhciBoID0gdGhpcy5oICUgMzYwICsgKHRoaXMuaCA8IDApICogMzYwLCBzID0gaXNOYU4oaCkgfHwgaXNOYU4odGhpcy5zKSA/IDAgOiB0aGlzLnMsIGwgPSB0aGlzLmwsIG0yID0gbCArIChsIDwgMC41ID8gbCA6IDEgLSBsKSAqIHMsIG0xID0gMiAqIGwgLSBtMjsKICAgIHJldHVybiBuZXcgUmdiKAogICAgICBoc2wycmdiKGggPj0gMjQwID8gaCAtIDI0MCA6IGggKyAxMjAsIG0xLCBtMiksCiAgICAgIGhzbDJyZ2IoaCwgbTEsIG0yKSwKICAgICAgaHNsMnJnYihoIDwgMTIwID8gaCArIDI0MCA6IGggLSAxMjAsIG0xLCBtMiksCiAgICAgIHRoaXMub3BhY2l0eQogICAgKTsKICB9LAogIGNsYW1wKCkgewogICAgcmV0dXJuIG5ldyBIc2woY2xhbXBoKHRoaXMuaCksIGNsYW1wdCh0aGlzLnMpLCBjbGFtcHQodGhpcy5sKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gKDAgPD0gdGhpcy5zICYmIHRoaXMucyA8PSAxIHx8IGlzTmFOKHRoaXMucykpICYmICgwIDw9IHRoaXMubCAmJiB0aGlzLmwgPD0gMSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGZvcm1hdEhzbCgpIHsKICAgIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthID09PSAxID8gImhzbCgiIDogImhzbGEoIn0ke2NsYW1waCh0aGlzLmgpfSwgJHtjbGFtcHQodGhpcy5zKSAqIDEwMH0lLCAke2NsYW1wdCh0aGlzLmwpICogMTAwfSUke2EgPT09IDEgPyAiKSIgOiBgLCAke2F9KWB9YDsKICB9Cn0pKTsKZnVuY3Rpb24gY2xhbXBoKHZhbHVlKSB7CiAgdmFsdWUgPSAodmFsdWUgfHwgMCkgJSAzNjA7CiAgcmV0dXJuIHZhbHVlIDwgMCA/IHZhbHVlICsgMzYwIDogdmFsdWU7Cn0KZnVuY3Rpb24gY2xhbXB0KHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZhbHVlIHx8IDApKTsKfQpmdW5jdGlvbiBoc2wycmdiKGgsIG0xLCBtMikgewogIHJldHVybiAoaCA8IDYwID8gbTEgKyAobTIgLSBtMSkgKiBoIC8gNjAgOiBoIDwgMTgwID8gbTIgOiBoIDwgMjQwID8gbTEgKyAobTIgLSBtMSkgKiAoMjQwIC0gaCkgLyA2MCA6IG0xKSAqIDI1NTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvYmFzaXMuanMKZnVuY3Rpb24gYmFzaXModDEyLCB2MCwgdjEsIHYyLCB2MykgewogIHZhciB0MiA9IHQxMiAqIHQxMiwgdDMgPSB0MiAqIHQxMjsKICByZXR1cm4gKCgxIC0gMyAqIHQxMiArIDMgKiB0MiAtIHQzKSAqIHYwICsgKDQgLSA2ICogdDIgKyAzICogdDMpICogdjEgKyAoMSArIDMgKiB0MTIgKyAzICogdDIgLSAzICogdDMpICogdjIgKyB0MyAqIHYzKSAvIDY7Cn0KZnVuY3Rpb24gYmFzaXNfZGVmYXVsdDIodmFsdWVzKSB7CiAgdmFyIG4gPSB2YWx1ZXMubGVuZ3RoIC0gMTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkgPSB0IDw9IDAgPyB0ID0gMCA6IHQgPj0gMSA/ICh0ID0gMSwgbiAtIDEpIDogTWF0aC5mbG9vcih0ICogbiksIHYxID0gdmFsdWVzW2ldLCB2MiA9IHZhbHVlc1tpICsgMV0sIHYwID0gaSA+IDAgPyB2YWx1ZXNbaSAtIDFdIDogMiAqIHYxIC0gdjIsIHYzID0gaSA8IG4gLSAxID8gdmFsdWVzW2kgKyAyXSA6IDIgKiB2MiAtIHYxOwogICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzQ2xvc2VkLmpzCmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQyKHZhbHVlcykgewogIHZhciBuID0gdmFsdWVzLmxlbmd0aDsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkgPSBNYXRoLmZsb29yKCgodCAlPSAxKSA8IDAgPyArK3QgOiB0KSAqIG4pLCB2MCA9IHZhbHVlc1soaSArIG4gLSAxKSAlIG5dLCB2MSA9IHZhbHVlc1tpICUgbl0sIHYyID0gdmFsdWVzWyhpICsgMSkgJSBuXSwgdjMgPSB2YWx1ZXNbKGkgKyAyKSAlIG5dOwogICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbnN0YW50LmpzCnZhciBjb25zdGFudF9kZWZhdWx0MiA9ICh4MikgPT4gKCkgPT4geDI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb2xvci5qcwpmdW5jdGlvbiBsaW5lYXIoYSwgZCkgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYSArIHQgKiBkOwogIH07Cn0KZnVuY3Rpb24gZXhwb25lbnRpYWwoYSwgYiwgeTIpIHsKICByZXR1cm4gYSA9IE1hdGgucG93KGEsIHkyKSwgYiA9IE1hdGgucG93KGIsIHkyKSAtIGEsIHkyID0gMSAvIHkyLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gTWF0aC5wb3coYSArIHQgKiBiLCB5Mik7CiAgfTsKfQpmdW5jdGlvbiBnYW1tYSh5MikgewogIHJldHVybiAoeTIgPSAreTIpID09PSAxID8gbm9nYW1tYSA6IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBiIC0gYSA/IGV4cG9uZW50aWFsKGEsIGIsIHkyKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEpID8gYiA6IGEpOwogIH07Cn0KZnVuY3Rpb24gbm9nYW1tYShhLCBiKSB7CiAgdmFyIGQgPSBiIC0gYTsKICByZXR1cm4gZCA/IGxpbmVhcihhLCBkKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEpID8gYiA6IGEpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yZ2IuanMKdmFyIHJnYl9kZWZhdWx0ID0gZnVuY3Rpb24gcmdiR2FtbWEoeTIpIHsKICB2YXIgY29sb3IyID0gZ2FtbWEoeTIpOwogIGZ1bmN0aW9uIHJnYjIoc3RhcnQsIGVuZCkgewogICAgdmFyIHIyID0gY29sb3IyKChzdGFydCA9IHJnYihzdGFydCkpLnIsIChlbmQgPSByZ2IoZW5kKSkuciksIGcgPSBjb2xvcjIoc3RhcnQuZywgZW5kLmcpLCBiID0gY29sb3IyKHN0YXJ0LmIsIGVuZC5iKSwgb3BhY2l0eSA9IG5vZ2FtbWEoc3RhcnQub3BhY2l0eSwgZW5kLm9wYWNpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgc3RhcnQuciA9IHIyKHQpOwogICAgICBzdGFydC5nID0gZyh0KTsKICAgICAgc3RhcnQuYiA9IGIodCk7CiAgICAgIHN0YXJ0Lm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgIH07CiAgfQogIHJnYjIuZ2FtbWEgPSByZ2JHYW1tYTsKICByZXR1cm4gcmdiMjsKfSgxKTsKZnVuY3Rpb24gcmdiU3BsaW5lKHNwbGluZSkgewogIHJldHVybiBmdW5jdGlvbihjb2xvcnMpIHsKICAgIHZhciBuID0gY29sb3JzLmxlbmd0aCwgcjIgPSBuZXcgQXJyYXkobiksIGcgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIGksIGNvbG9yMjsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgY29sb3IyID0gcmdiKGNvbG9yc1tpXSk7CiAgICAgIHIyW2ldID0gY29sb3IyLnIgfHwgMDsKICAgICAgZ1tpXSA9IGNvbG9yMi5nIHx8IDA7CiAgICAgIGJbaV0gPSBjb2xvcjIuYiB8fCAwOwogICAgfQogICAgcjIgPSBzcGxpbmUocjIpOwogICAgZyA9IHNwbGluZShnKTsKICAgIGIgPSBzcGxpbmUoYik7CiAgICBjb2xvcjIub3BhY2l0eSA9IDE7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICBjb2xvcjIuciA9IHIyKHQpOwogICAgICBjb2xvcjIuZyA9IGcodCk7CiAgICAgIGNvbG9yMi5iID0gYih0KTsKICAgICAgcmV0dXJuIGNvbG9yMiArICIiOwogICAgfTsKICB9Owp9CnZhciByZ2JCYXNpcyA9IHJnYlNwbGluZShiYXNpc19kZWZhdWx0Mik7CnZhciByZ2JCYXNpc0Nsb3NlZCA9IHJnYlNwbGluZShiYXNpc0Nsb3NlZF9kZWZhdWx0Mik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXJBcnJheS5qcwpmdW5jdGlvbiBudW1iZXJBcnJheV9kZWZhdWx0KGEsIGIpIHsKICBpZiAoIWIpIGIgPSBbXTsKICB2YXIgbiA9IGEgPyBNYXRoLm1pbihiLmxlbmd0aCwgYS5sZW5ndGgpIDogMCwgYyA9IGIuc2xpY2UoKSwgaTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgY1tpXSA9IGFbaV0gKiAoMSAtIHQpICsgYltpXSAqIHQ7CiAgICByZXR1cm4gYzsKICB9Owp9CmZ1bmN0aW9uIGlzTnVtYmVyQXJyYXkoeDIpIHsKICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9hcnJheS5qcwpmdW5jdGlvbiBnZW5lcmljQXJyYXkoYSwgYikgewogIHZhciBuYiA9IGIgPyBiLmxlbmd0aCA6IDAsIG5hID0gYSA/IE1hdGgubWluKG5iLCBhLmxlbmd0aCkgOiAwLCB4MiA9IG5ldyBBcnJheShuYSksIGMgPSBuZXcgQXJyYXkobmIpLCBpOwogIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSB4MltpXSA9IHZhbHVlX2RlZmF1bHQoYVtpXSwgYltpXSk7CiAgZm9yICg7IGkgPCBuYjsgKytpKSBjW2ldID0gYltpXTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIGNbaV0gPSB4MltpXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2RhdGUuanMKZnVuY3Rpb24gZGF0ZV9kZWZhdWx0KGEsIGIpIHsKICB2YXIgZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGQuc2V0VGltZShhICogKDEgLSB0KSArIGIgKiB0KSwgZDsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyX2RlZmF1bHQoYSwgYikgewogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEgKiAoMSAtIHQpICsgYiAqIHQ7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvb2JqZWN0LmpzCmZ1bmN0aW9uIG9iamVjdF9kZWZhdWx0KGEsIGIpIHsKICB2YXIgaSA9IHt9LCBjID0ge30sIGs7CiAgaWYgKGEgPT09IG51bGwgfHwgdHlwZW9mIGEgIT09ICJvYmplY3QiKSBhID0ge307CiAgaWYgKGIgPT09IG51bGwgfHwgdHlwZW9mIGIgIT09ICJvYmplY3QiKSBiID0ge307CiAgZm9yIChrIGluIGIpIHsKICAgIGlmIChrIGluIGEpIHsKICAgICAgaVtrXSA9IHZhbHVlX2RlZmF1bHQoYVtrXSwgYltrXSk7CiAgICB9IGVsc2UgewogICAgICBjW2tdID0gYltrXTsKICAgIH0KICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoayBpbiBpKSBjW2tdID0gaVtrXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3N0cmluZy5qcwp2YXIgcmVBID0gL1stK10/KD86XGQrXC4/XGQqfFwuP1xkKykoPzpbZUVdWy0rXT9cZCspPy9nOwp2YXIgcmVCID0gbmV3IFJlZ0V4cChyZUEuc291cmNlLCAiZyIpOwpmdW5jdGlvbiB6ZXJvMihiKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGI7CiAgfTsKfQpmdW5jdGlvbiBvbmUoYikgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYih0KSArICIiOwogIH07Cn0KZnVuY3Rpb24gc3RyaW5nX2RlZmF1bHQoYSwgYikgewogIHZhciBiaSA9IHJlQS5sYXN0SW5kZXggPSByZUIubGFzdEluZGV4ID0gMCwgYW0sIGJtLCBicywgaSA9IC0xLCBzID0gW10sIHEgPSBbXTsKICBhID0gYSArICIiLCBiID0gYiArICIiOwogIHdoaWxlICgoYW0gPSByZUEuZXhlYyhhKSkgJiYgKGJtID0gcmVCLmV4ZWMoYikpKSB7CiAgICBpZiAoKGJzID0gYm0uaW5kZXgpID4gYmkpIHsKICAgICAgYnMgPSBiLnNsaWNlKGJpLCBicyk7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJzOwogICAgICBlbHNlIHNbKytpXSA9IGJzOwogICAgfQogICAgaWYgKChhbSA9IGFtWzBdKSA9PT0gKGJtID0gYm1bMF0pKSB7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJtOwogICAgICBlbHNlIHNbKytpXSA9IGJtOwogICAgfSBlbHNlIHsKICAgICAgc1srK2ldID0gbnVsbDsKICAgICAgcS5wdXNoKHsgaSwgeDogbnVtYmVyX2RlZmF1bHQoYW0sIGJtKSB9KTsKICAgIH0KICAgIGJpID0gcmVCLmxhc3RJbmRleDsKICB9CiAgaWYgKGJpIDwgYi5sZW5ndGgpIHsKICAgIGJzID0gYi5zbGljZShiaSk7CiAgICBpZiAoc1tpXSkgc1tpXSArPSBiczsKICAgIGVsc2Ugc1srK2ldID0gYnM7CiAgfQogIHJldHVybiBzLmxlbmd0aCA8IDIgPyBxWzBdID8gb25lKHFbMF0ueCkgOiB6ZXJvMihiKSA6IChiID0gcS5sZW5ndGgsIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAodmFyIGkyID0gMCwgbzsgaTIgPCBiOyArK2kyKSBzWyhvID0gcVtpMl0pLmldID0gby54KHQpOwogICAgcmV0dXJuIHMuam9pbigiIik7CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3ZhbHVlLmpzCmZ1bmN0aW9uIHZhbHVlX2RlZmF1bHQoYSwgYikgewogIHZhciB0ID0gdHlwZW9mIGIsIGM7CiAgcmV0dXJuIGIgPT0gbnVsbCB8fCB0ID09PSAiYm9vbGVhbiIgPyBjb25zdGFudF9kZWZhdWx0MihiKSA6ICh0ID09PSAibnVtYmVyIiA/IG51bWJlcl9kZWZhdWx0IDogdCA9PT0gInN0cmluZyIgPyAoYyA9IGNvbG9yKGIpKSA/IChiID0gYywgcmdiX2RlZmF1bHQpIDogc3RyaW5nX2RlZmF1bHQgOiBiIGluc3RhbmNlb2YgY29sb3IgPyByZ2JfZGVmYXVsdCA6IGIgaW5zdGFuY2VvZiBEYXRlID8gZGF0ZV9kZWZhdWx0IDogaXNOdW1iZXJBcnJheShiKSA/IG51bWJlckFycmF5X2RlZmF1bHQgOiBBcnJheS5pc0FycmF5KGIpID8gZ2VuZXJpY0FycmF5IDogdHlwZW9mIGIudmFsdWVPZiAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYi50b1N0cmluZyAhPT0gImZ1bmN0aW9uIiB8fCBpc05hTihiKSA/IG9iamVjdF9kZWZhdWx0IDogbnVtYmVyX2RlZmF1bHQpKGEsIGIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yb3VuZC5qcwpmdW5jdGlvbiByb3VuZF9kZWZhdWx0KGEsIGIpIHsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiAoMSAtIHQpICsgYiAqIHQpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3BpZWNld2lzZS5qcwpmdW5jdGlvbiBwaWVjZXdpc2UoaW50ZXJwb2xhdGUyLCB2YWx1ZXMpIHsKICBpZiAodmFsdWVzID09PSB2b2lkIDApIHZhbHVlcyA9IGludGVycG9sYXRlMiwgaW50ZXJwb2xhdGUyID0gdmFsdWVfZGVmYXVsdDsKICB2YXIgaSA9IDAsIG4gPSB2YWx1ZXMubGVuZ3RoIC0gMSwgdiA9IHZhbHVlc1swXSwgSSA9IG5ldyBBcnJheShuIDwgMCA/IDAgOiBuKTsKICB3aGlsZSAoaSA8IG4pIElbaV0gPSBpbnRlcnBvbGF0ZTIodiwgdiA9IHZhbHVlc1srK2ldKTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkyID0gTWF0aC5tYXgoMCwgTWF0aC5taW4obiAtIDEsIE1hdGguZmxvb3IodCAqPSBuKSkpOwogICAgcmV0dXJuIElbaTJdKHQgLSBpMik7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvY29uc3RhbnQuanMKZnVuY3Rpb24gY29uc3RhbnRzKHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIyKHgyKSB7CiAgcmV0dXJuICt4MjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvY29udGludW91cy5qcwp2YXIgdW5pdCA9IFswLCAxXTsKZnVuY3Rpb24gaWRlbnRpdHkoeDIpIHsKICByZXR1cm4geDI7Cn0KZnVuY3Rpb24gbm9ybWFsaXplKGEsIGIpIHsKICByZXR1cm4gKGIgLT0gYSA9ICthKSA/IGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gKHgyIC0gYSkgLyBiOwogIH0gOiBjb25zdGFudHMoaXNOYU4oYikgPyBOYU4gOiAwLjUpOwp9CmZ1bmN0aW9uIGNsYW1wZXIoYSwgYikgewogIHZhciB0OwogIGlmIChhID4gYikgdCA9IGEsIGEgPSBiLCBiID0gdDsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLm1heChhLCBNYXRoLm1pbihiLCB4MikpOwogIH07Cn0KZnVuY3Rpb24gYmltYXAoZG9tYWluLCByYW5nZTQsIGludGVycG9sYXRlMikgewogIHZhciBkMCA9IGRvbWFpblswXSwgZDEgPSBkb21haW5bMV0sIHIwID0gcmFuZ2U0WzBdLCByMSA9IHJhbmdlNFsxXTsKICBpZiAoZDEgPCBkMCkgZDAgPSBub3JtYWxpemUoZDEsIGQwKSwgcjAgPSBpbnRlcnBvbGF0ZTIocjEsIHIwKTsKICBlbHNlIGQwID0gbm9ybWFsaXplKGQwLCBkMSksIHIwID0gaW50ZXJwb2xhdGUyKHIwLCByMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gcjAoZDAoeDIpKTsKICB9Owp9CmZ1bmN0aW9uIHBvbHltYXAoZG9tYWluLCByYW5nZTQsIGludGVycG9sYXRlMikgewogIHZhciBqID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCkgLSAxLCBkID0gbmV3IEFycmF5KGopLCByMiA9IG5ldyBBcnJheShqKSwgaSA9IC0xOwogIGlmIChkb21haW5bal0gPCBkb21haW5bMF0pIHsKICAgIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpLnJldmVyc2UoKTsKICAgIHJhbmdlNCA9IHJhbmdlNC5zbGljZSgpLnJldmVyc2UoKTsKICB9CiAgd2hpbGUgKCsraSA8IGopIHsKICAgIGRbaV0gPSBub3JtYWxpemUoZG9tYWluW2ldLCBkb21haW5baSArIDFdKTsKICAgIHIyW2ldID0gaW50ZXJwb2xhdGUyKHJhbmdlNFtpXSwgcmFuZ2U0W2kgKyAxXSk7CiAgfQogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgdmFyIGkyID0gYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMSwgaikgLSAxOwogICAgcmV0dXJuIHIyW2kyXShkW2kyXSh4MikpOwogIH07Cn0KZnVuY3Rpb24gY29weShzb3VyY2UsIHRhcmdldCkgewogIHJldHVybiB0YXJnZXQuZG9tYWluKHNvdXJjZS5kb21haW4oKSkucmFuZ2Uoc291cmNlLnJhbmdlKCkpLmludGVycG9sYXRlKHNvdXJjZS5pbnRlcnBvbGF0ZSgpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1lcigpIHsKICB2YXIgZG9tYWluID0gdW5pdCwgcmFuZ2U0ID0gdW5pdCwgaW50ZXJwb2xhdGUyID0gdmFsdWVfZGVmYXVsdCwgdHJhbnNmb3JtLCB1bnRyYW5zZm9ybSwgdW5rbm93biwgY2xhbXAgPSBpZGVudGl0eSwgcGllY2V3aXNlMiwgb3V0cHV0LCBpbnB1dDsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoKTsKICAgIGlmIChjbGFtcCAhPT0gaWRlbnRpdHkpIGNsYW1wID0gY2xhbXBlcihkb21haW5bMF0sIGRvbWFpbltuIC0gMV0pOwogICAgcGllY2V3aXNlMiA9IG4gPiAyID8gcG9seW1hcCA6IGJpbWFwOwogICAgb3V0cHV0ID0gaW5wdXQgPSBudWxsOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IChvdXRwdXQgfHwgKG91dHB1dCA9IHBpZWNld2lzZTIoZG9tYWluLm1hcCh0cmFuc2Zvcm0pLCByYW5nZTQsIGludGVycG9sYXRlMikpKSh0cmFuc2Zvcm0oY2xhbXAoeDIpKSk7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gY2xhbXAodW50cmFuc2Zvcm0oKGlucHV0IHx8IChpbnB1dCA9IHBpZWNld2lzZTIocmFuZ2U0LCBkb21haW4ubWFwKHRyYW5zZm9ybSksIG51bWJlcl9kZWZhdWx0KSkpKHkyKSkpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSwgcmVzY2FsZSgpKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHJhbmdlNCA9IEFycmF5LmZyb20oXyksIGludGVycG9sYXRlMiA9IHJvdW5kX2RlZmF1bHQsIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xhbXAgPSBfID8gdHJ1ZSA6IGlkZW50aXR5LCByZXNjYWxlKCkpIDogY2xhbXAgIT09IGlkZW50aXR5OwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdGUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0ZTIgPSBfLCByZXNjYWxlKCkpIDogaW50ZXJwb2xhdGUyOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQsIHUpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHVudHJhbnNmb3JtID0gdTsKICAgIHJldHVybiByZXNjYWxlKCk7CiAgfTsKfQpmdW5jdGlvbiBjb250aW51b3VzKCkgewogIHJldHVybiB0cmFuc2Zvcm1lcigpKGlkZW50aXR5LCBpZGVudGl0eSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0RGVjaW1hbC5qcwpmdW5jdGlvbiBmb3JtYXREZWNpbWFsX2RlZmF1bHQoeDIpIHsKICByZXR1cm4gTWF0aC5hYnMoeDIgPSBNYXRoLnJvdW5kKHgyKSkgPj0gMWUyMSA/IHgyLnRvTG9jYWxlU3RyaW5nKCJlbiIpLnJlcGxhY2UoLywvZywgIiIpIDogeDIudG9TdHJpbmcoMTApOwp9CmZ1bmN0aW9uIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCkgewogIGlmICgoaSA9ICh4MiA9IHAgPyB4Mi50b0V4cG9uZW50aWFsKHAgLSAxKSA6IHgyLnRvRXhwb25lbnRpYWwoKSkuaW5kZXhPZigiZSIpKSA8IDApIHJldHVybiBudWxsOwogIHZhciBpLCBjb2VmZmljaWVudCA9IHgyLnNsaWNlKDAsIGkpOwogIHJldHVybiBbCiAgICBjb2VmZmljaWVudC5sZW5ndGggPiAxID8gY29lZmZpY2llbnRbMF0gKyBjb2VmZmljaWVudC5zbGljZSgyKSA6IGNvZWZmaWNpZW50LAogICAgK3gyLnNsaWNlKGkgKyAxKQogIF07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZXhwb25lbnQuanMKZnVuY3Rpb24gZXhwb25lbnRfZGVmYXVsdCh4MikgewogIHJldHVybiB4MiA9IGZvcm1hdERlY2ltYWxQYXJ0cyhNYXRoLmFicyh4MikpLCB4MiA/IHgyWzFdIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdEdyb3VwLmpzCmZ1bmN0aW9uIGZvcm1hdEdyb3VwX2RlZmF1bHQoZ3JvdXBpbmcsIHRob3VzYW5kcykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgd2lkdGgpIHsKICAgIHZhciBpID0gdmFsdWUubGVuZ3RoLCB0ID0gW10sIGogPSAwLCBnID0gZ3JvdXBpbmdbMF0sIGxlbmd0aCA9IDA7CiAgICB3aGlsZSAoaSA+IDAgJiYgZyA+IDApIHsKICAgICAgaWYgKGxlbmd0aCArIGcgKyAxID4gd2lkdGgpIGcgPSBNYXRoLm1heCgxLCB3aWR0aCAtIGxlbmd0aCk7CiAgICAgIHQucHVzaCh2YWx1ZS5zdWJzdHJpbmcoaSAtPSBnLCBpICsgZykpOwogICAgICBpZiAoKGxlbmd0aCArPSBnICsgMSkgPiB3aWR0aCkgYnJlYWs7CiAgICAgIGcgPSBncm91cGluZ1tqID0gKGogKyAxKSAlIGdyb3VwaW5nLmxlbmd0aF07CiAgICB9CiAgICByZXR1cm4gdC5yZXZlcnNlKCkuam9pbih0aG91c2FuZHMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0TnVtZXJhbHMuanMKZnVuY3Rpb24gZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChudW1lcmFscykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1swLTldL2csIGZ1bmN0aW9uKGkpIHsKICAgICAgcmV0dXJuIG51bWVyYWxzWytpXTsKICAgIH0pOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0U3BlY2lmaWVyLmpzCnZhciByZSA9IC9eKD86KC4pPyhbPD49Xl0pKT8oWytcLSggXSk/KFskI10pPygwKT8oXGQrKT8oLCk/KFwuXGQrKT8ofik/KFthLXolXSk/JC9pOwpmdW5jdGlvbiBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgaWYgKCEobWF0Y2ggPSByZS5leGVjKHNwZWNpZmllcikpKSB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgZm9ybWF0OiAiICsgc3BlY2lmaWVyKTsKICB2YXIgbWF0Y2g7CiAgcmV0dXJuIG5ldyBGb3JtYXRTcGVjaWZpZXIoewogICAgZmlsbDogbWF0Y2hbMV0sCiAgICBhbGlnbjogbWF0Y2hbMl0sCiAgICBzaWduOiBtYXRjaFszXSwKICAgIHN5bWJvbDogbWF0Y2hbNF0sCiAgICB6ZXJvOiBtYXRjaFs1XSwKICAgIHdpZHRoOiBtYXRjaFs2XSwKICAgIGNvbW1hOiBtYXRjaFs3XSwKICAgIHByZWNpc2lvbjogbWF0Y2hbOF0gJiYgbWF0Y2hbOF0uc2xpY2UoMSksCiAgICB0cmltOiBtYXRjaFs5XSwKICAgIHR5cGU6IG1hdGNoWzEwXQogIH0pOwp9CmZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUgPSBGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlOwpmdW5jdGlvbiBGb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgdGhpcy5maWxsID0gc3BlY2lmaWVyLmZpbGwgPT09IHZvaWQgMCA/ICIgIiA6IHNwZWNpZmllci5maWxsICsgIiI7CiAgdGhpcy5hbGlnbiA9IHNwZWNpZmllci5hbGlnbiA9PT0gdm9pZCAwID8gIj4iIDogc3BlY2lmaWVyLmFsaWduICsgIiI7CiAgdGhpcy5zaWduID0gc3BlY2lmaWVyLnNpZ24gPT09IHZvaWQgMCA/ICItIiA6IHNwZWNpZmllci5zaWduICsgIiI7CiAgdGhpcy5zeW1ib2wgPSBzcGVjaWZpZXIuc3ltYm9sID09PSB2b2lkIDAgPyAiIiA6IHNwZWNpZmllci5zeW1ib2wgKyAiIjsKICB0aGlzLnplcm8gPSAhIXNwZWNpZmllci56ZXJvOwogIHRoaXMud2lkdGggPSBzcGVjaWZpZXIud2lkdGggPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIud2lkdGg7CiAgdGhpcy5jb21tYSA9ICEhc3BlY2lmaWVyLmNvbW1hOwogIHRoaXMucHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogK3NwZWNpZmllci5wcmVjaXNpb247CiAgdGhpcy50cmltID0gISFzcGVjaWZpZXIudHJpbTsKICB0aGlzLnR5cGUgPSBzcGVjaWZpZXIudHlwZSA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIudHlwZSArICIiOwp9CkZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5maWxsICsgdGhpcy5hbGlnbiArIHRoaXMuc2lnbiArIHRoaXMuc3ltYm9sICsgKHRoaXMuemVybyA/ICIwIiA6ICIiKSArICh0aGlzLndpZHRoID09PSB2b2lkIDAgPyAiIiA6IE1hdGgubWF4KDEsIHRoaXMud2lkdGggfCAwKSkgKyAodGhpcy5jb21tYSA/ICIsIiA6ICIiKSArICh0aGlzLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gIiIgOiAiLiIgKyBNYXRoLm1heCgwLCB0aGlzLnByZWNpc2lvbiB8IDApKSArICh0aGlzLnRyaW0gPyAifiIgOiAiIikgKyB0aGlzLnR5cGU7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFRyaW0uanMKZnVuY3Rpb24gZm9ybWF0VHJpbV9kZWZhdWx0KHMpIHsKICBvdXQ6IGZvciAodmFyIG4gPSBzLmxlbmd0aCwgaSA9IDEsIGkwID0gLTEsIGkxOyBpIDwgbjsgKytpKSB7CiAgICBzd2l0Y2ggKHNbaV0pIHsKICAgICAgY2FzZSAiLiI6CiAgICAgICAgaTAgPSBpMSA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIjAiOgogICAgICAgIGlmIChpMCA9PT0gMCkgaTAgPSBpOwogICAgICAgIGkxID0gaTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAoIStzW2ldKSBicmVhayBvdXQ7CiAgICAgICAgaWYgKGkwID4gMCkgaTAgPSAwOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gaTAgPiAwID8gcy5zbGljZSgwLCBpMCkgKyBzLnNsaWNlKGkxICsgMSkgOiBzOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFByZWZpeEF1dG8uanMKdmFyIHByZWZpeEV4cG9uZW50OwpmdW5jdGlvbiBmb3JtYXRQcmVmaXhBdXRvX2RlZmF1bHQoeDIsIHApIHsKICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCk7CiAgaWYgKCFkKSByZXR1cm4geDIgKyAiIjsKICB2YXIgY29lZmZpY2llbnQgPSBkWzBdLCBleHBvbmVudCA9IGRbMV0sIGkgPSBleHBvbmVudCAtIChwcmVmaXhFeHBvbmVudCA9IE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50IC8gMykpKSAqIDMpICsgMSwgbiA9IGNvZWZmaWNpZW50Lmxlbmd0aDsKICByZXR1cm4gaSA9PT0gbiA/IGNvZWZmaWNpZW50IDogaSA+IG4gPyBjb2VmZmljaWVudCArIG5ldyBBcnJheShpIC0gbiArIDEpLmpvaW4oIjAiKSA6IGkgPiAwID8gY29lZmZpY2llbnQuc2xpY2UoMCwgaSkgKyAiLiIgKyBjb2VmZmljaWVudC5zbGljZShpKSA6ICIwLiIgKyBuZXcgQXJyYXkoMSAtIGkpLmpvaW4oIjAiKSArIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgTWF0aC5tYXgoMCwgcCArIGkgLSAxKSlbMF07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0Um91bmRlZC5qcwpmdW5jdGlvbiBmb3JtYXRSb3VuZGVkX2RlZmF1bHQoeDIsIHApIHsKICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCk7CiAgaWYgKCFkKSByZXR1cm4geDIgKyAiIjsKICB2YXIgY29lZmZpY2llbnQgPSBkWzBdLCBleHBvbmVudCA9IGRbMV07CiAgcmV0dXJuIGV4cG9uZW50IDwgMCA/ICIwLiIgKyBuZXcgQXJyYXkoLWV4cG9uZW50KS5qb2luKCIwIikgKyBjb2VmZmljaWVudCA6IGNvZWZmaWNpZW50Lmxlbmd0aCA+IGV4cG9uZW50ICsgMSA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGV4cG9uZW50ICsgMSkgKyAiLiIgKyBjb2VmZmljaWVudC5zbGljZShleHBvbmVudCArIDEpIDogY29lZmZpY2llbnQgKyBuZXcgQXJyYXkoZXhwb25lbnQgLSBjb2VmZmljaWVudC5sZW5ndGggKyAyKS5qb2luKCIwIik7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHlwZXMuanMKdmFyIGZvcm1hdFR5cGVzX2RlZmF1bHQgPSB7CiAgIiUiOiAoeDIsIHApID0+ICh4MiAqIDEwMCkudG9GaXhlZChwKSwKICAiYiI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMiksCiAgImMiOiAoeDIpID0+IHgyICsgIiIsCiAgImQiOiBmb3JtYXREZWNpbWFsX2RlZmF1bHQsCiAgImUiOiAoeDIsIHApID0+IHgyLnRvRXhwb25lbnRpYWwocCksCiAgImYiOiAoeDIsIHApID0+IHgyLnRvRml4ZWQocCksCiAgImciOiAoeDIsIHApID0+IHgyLnRvUHJlY2lzaW9uKHApLAogICJvIjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZyg4KSwKICAicCI6ICh4MiwgcCkgPT4gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHgyICogMTAwLCBwKSwKICAiciI6IGZvcm1hdFJvdW5kZWRfZGVmYXVsdCwKICAicyI6IGZvcm1hdFByZWZpeEF1dG9fZGVmYXVsdCwKICAiWCI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCksCiAgIngiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDE2KQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9pZGVudGl0eS5qcwpmdW5jdGlvbiBpZGVudGl0eV9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHgyOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2xvY2FsZS5qcwp2YXIgbWFwID0gQXJyYXkucHJvdG90eXBlLm1hcDsKdmFyIHByZWZpeGVzID0gWyJ5IiwgInoiLCAiYSIsICJmIiwgInAiLCAibiIsICJceEI1IiwgIm0iLCAiIiwgImsiLCAiTSIsICJHIiwgIlQiLCAiUCIsICJFIiwgIloiLCAiWSJdOwpmdW5jdGlvbiBsb2NhbGVfZGVmYXVsdChsb2NhbGUzKSB7CiAgdmFyIGdyb3VwID0gbG9jYWxlMy5ncm91cGluZyA9PT0gdm9pZCAwIHx8IGxvY2FsZTMudGhvdXNhbmRzID09PSB2b2lkIDAgPyBpZGVudGl0eV9kZWZhdWx0IDogZm9ybWF0R3JvdXBfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLmdyb3VwaW5nLCBOdW1iZXIpLCBsb2NhbGUzLnRob3VzYW5kcyArICIiKSwgY3VycmVuY3lQcmVmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMF0gKyAiIiwgY3VycmVuY3lTdWZmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMV0gKyAiIiwgZGVjaW1hbCA9IGxvY2FsZTMuZGVjaW1hbCA9PT0gdm9pZCAwID8gIi4iIDogbG9jYWxlMy5kZWNpbWFsICsgIiIsIG51bWVyYWxzID0gbG9jYWxlMy5udW1lcmFscyA9PT0gdm9pZCAwID8gaWRlbnRpdHlfZGVmYXVsdCA6IGZvcm1hdE51bWVyYWxzX2RlZmF1bHQobWFwLmNhbGwobG9jYWxlMy5udW1lcmFscywgU3RyaW5nKSksIHBlcmNlbnQgPSBsb2NhbGUzLnBlcmNlbnQgPT09IHZvaWQgMCA/ICIlIiA6IGxvY2FsZTMucGVyY2VudCArICIiLCBtaW51cyA9IGxvY2FsZTMubWludXMgPT09IHZvaWQgMCA/ICJcdTIyMTIiIDogbG9jYWxlMy5taW51cyArICIiLCBuYW4gPSBsb2NhbGUzLm5hbiA9PT0gdm9pZCAwID8gIk5hTiIgOiBsb2NhbGUzLm5hbiArICIiOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIpIHsKICAgIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpOwogICAgdmFyIGZpbGwgPSBzcGVjaWZpZXIuZmlsbCwgYWxpZ24gPSBzcGVjaWZpZXIuYWxpZ24sIHNpZ24yID0gc3BlY2lmaWVyLnNpZ24sIHN5bWJvbCA9IHNwZWNpZmllci5zeW1ib2wsIHplcm8zID0gc3BlY2lmaWVyLnplcm8sIHdpZHRoID0gc3BlY2lmaWVyLndpZHRoLCBjb21tYSA9IHNwZWNpZmllci5jb21tYSwgcHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiwgdHJpbSA9IHNwZWNpZmllci50cmltLCB0eXBlID0gc3BlY2lmaWVyLnR5cGU7CiAgICBpZiAodHlwZSA9PT0gIm4iKSBjb21tYSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBlbHNlIGlmICghZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSkgcHJlY2lzaW9uID09PSB2b2lkIDAgJiYgKHByZWNpc2lvbiA9IDEyKSwgdHJpbSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBpZiAoemVybzMgfHwgZmlsbCA9PT0gIjAiICYmIGFsaWduID09PSAiPSIpIHplcm8zID0gdHJ1ZSwgZmlsbCA9ICIwIiwgYWxpZ24gPSAiPSI7CiAgICB2YXIgcHJlZml4ID0gc3ltYm9sID09PSAiJCIgPyBjdXJyZW5jeVByZWZpeCA6IHN5bWJvbCA9PT0gIiMiICYmIC9bYm94WF0vLnRlc3QodHlwZSkgPyAiMCIgKyB0eXBlLnRvTG93ZXJDYXNlKCkgOiAiIiwgc3VmZml4MiA9IHN5bWJvbCA9PT0gIiQiID8gY3VycmVuY3lTdWZmaXggOiAvWyVwXS8udGVzdCh0eXBlKSA/IHBlcmNlbnQgOiAiIjsKICAgIHZhciBmb3JtYXRUeXBlID0gZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSwgbWF5YmVTdWZmaXggPSAvW2RlZmdwcnMlXS8udGVzdCh0eXBlKTsKICAgIHByZWNpc2lvbiA9IHByZWNpc2lvbiA9PT0gdm9pZCAwID8gNiA6IC9bZ3Byc10vLnRlc3QodHlwZSkgPyBNYXRoLm1heCgxLCBNYXRoLm1pbigyMSwgcHJlY2lzaW9uKSkgOiBNYXRoLm1heCgwLCBNYXRoLm1pbigyMCwgcHJlY2lzaW9uKSk7CiAgICBmdW5jdGlvbiBmb3JtYXQyKHZhbHVlKSB7CiAgICAgIHZhciB2YWx1ZVByZWZpeCA9IHByZWZpeCwgdmFsdWVTdWZmaXggPSBzdWZmaXgyLCBpLCBuLCBjOwogICAgICBpZiAodHlwZSA9PT0gImMiKSB7CiAgICAgICAgdmFsdWVTdWZmaXggPSBmb3JtYXRUeXBlKHZhbHVlKSArIHZhbHVlU3VmZml4OwogICAgICAgIHZhbHVlID0gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSArdmFsdWU7CiAgICAgICAgdmFyIHZhbHVlTmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgMSAvIHZhbHVlIDwgMDsKICAgICAgICB2YWx1ZSA9IGlzTmFOKHZhbHVlKSA/IG5hbiA6IGZvcm1hdFR5cGUoTWF0aC5hYnModmFsdWUpLCBwcmVjaXNpb24pOwogICAgICAgIGlmICh0cmltKSB2YWx1ZSA9IGZvcm1hdFRyaW1fZGVmYXVsdCh2YWx1ZSk7CiAgICAgICAgaWYgKHZhbHVlTmVnYXRpdmUgJiYgK3ZhbHVlID09PSAwICYmIHNpZ24yICE9PSAiKyIpIHZhbHVlTmVnYXRpdmUgPSBmYWxzZTsKICAgICAgICB2YWx1ZVByZWZpeCA9ICh2YWx1ZU5lZ2F0aXZlID8gc2lnbjIgPT09ICIoIiA/IHNpZ24yIDogbWludXMgOiBzaWduMiA9PT0gIi0iIHx8IHNpZ24yID09PSAiKCIgPyAiIiA6IHNpZ24yKSArIHZhbHVlUHJlZml4OwogICAgICAgIHZhbHVlU3VmZml4ID0gKHR5cGUgPT09ICJzIiA/IHByZWZpeGVzWzggKyBwcmVmaXhFeHBvbmVudCAvIDNdIDogIiIpICsgdmFsdWVTdWZmaXggKyAodmFsdWVOZWdhdGl2ZSAmJiBzaWduMiA9PT0gIigiID8gIikiIDogIiIpOwogICAgICAgIGlmIChtYXliZVN1ZmZpeCkgewogICAgICAgICAgaSA9IC0xLCBuID0gdmFsdWUubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICAgICAgaWYgKGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpLCA0OCA+IGMgfHwgYyA+IDU3KSB7CiAgICAgICAgICAgICAgdmFsdWVTdWZmaXggPSAoYyA9PT0gNDYgPyBkZWNpbWFsICsgdmFsdWUuc2xpY2UoaSArIDEpIDogdmFsdWUuc2xpY2UoaSkpICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgwLCBpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29tbWEgJiYgIXplcm8zKSB2YWx1ZSA9IGdyb3VwKHZhbHVlLCBJbmZpbml0eSk7CiAgICAgIHZhciBsZW5ndGggPSB2YWx1ZVByZWZpeC5sZW5ndGggKyB2YWx1ZS5sZW5ndGggKyB2YWx1ZVN1ZmZpeC5sZW5ndGgsIHBhZGRpbmcgPSBsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgOiAiIjsKICAgICAgaWYgKGNvbW1hICYmIHplcm8zKSB2YWx1ZSA9IGdyb3VwKHBhZGRpbmcgKyB2YWx1ZSwgcGFkZGluZy5sZW5ndGggPyB3aWR0aCAtIHZhbHVlU3VmZml4Lmxlbmd0aCA6IEluZmluaXR5KSwgcGFkZGluZyA9ICIiOwogICAgICBzd2l0Y2ggKGFsaWduKSB7CiAgICAgICAgY2FzZSAiPCI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmc7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICI9IjoKICAgICAgICAgIHZhbHVlID0gdmFsdWVQcmVmaXggKyBwYWRkaW5nICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIl4iOgogICAgICAgICAgdmFsdWUgPSBwYWRkaW5nLnNsaWNlKDAsIGxlbmd0aCA9IHBhZGRpbmcubGVuZ3RoID4+IDEpICsgdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4ICsgcGFkZGluZy5zbGljZShsZW5ndGgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHZhbHVlID0gcGFkZGluZyArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiBudW1lcmFscyh2YWx1ZSk7CiAgICB9CiAgICBmb3JtYXQyLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzcGVjaWZpZXIgKyAiIjsKICAgIH07CiAgICByZXR1cm4gZm9ybWF0MjsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UHJlZml4MihzcGVjaWZpZXIsIHZhbHVlKSB7CiAgICB2YXIgZiA9IG5ld0Zvcm1hdCgoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciksIHNwZWNpZmllci50eXBlID0gImYiLCBzcGVjaWZpZXIpKSwgZSA9IE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50X2RlZmF1bHQodmFsdWUpIC8gMykpKSAqIDMsIGsgPSBNYXRoLnBvdygxMCwgLWUpLCBwcmVmaXggPSBwcmVmaXhlc1s4ICsgZSAvIDNdOwogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlMikgewogICAgICByZXR1cm4gZihrICogdmFsdWUyKSArIHByZWZpeDsKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBmb3JtYXQ6IG5ld0Zvcm1hdCwKICAgIGZvcm1hdFByZWZpeDogZm9ybWF0UHJlZml4MgogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZGVmYXVsdExvY2FsZS5qcwp2YXIgbG9jYWxlOwp2YXIgZm9ybWF0Owp2YXIgZm9ybWF0UHJlZml4OwpkZWZhdWx0TG9jYWxlKHsKICB0aG91c2FuZHM6ICIsIiwKICBncm91cGluZzogWzNdLAogIGN1cnJlbmN5OiBbIiQiLCAiIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUoZGVmaW5pdGlvbikgewogIGxvY2FsZSA9IGxvY2FsZV9kZWZhdWx0KGRlZmluaXRpb24pOwogIGZvcm1hdCA9IGxvY2FsZS5mb3JtYXQ7CiAgZm9ybWF0UHJlZml4ID0gbG9jYWxlLmZvcm1hdFByZWZpeDsKICByZXR1cm4gbG9jYWxlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvbkZpeGVkLmpzCmZ1bmN0aW9uIHByZWNpc2lvbkZpeGVkX2RlZmF1bHQoc3RlcCkgewogIHJldHVybiBNYXRoLm1heCgwLCAtZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblByZWZpeC5qcwpmdW5jdGlvbiBwcmVjaXNpb25QcmVmaXhfZGVmYXVsdChzdGVwLCB2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzIC0gZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblJvdW5kLmpzCmZ1bmN0aW9uIHByZWNpc2lvblJvdW5kX2RlZmF1bHQoc3RlcCwgbWF4MikgewogIHN0ZXAgPSBNYXRoLmFicyhzdGVwKSwgbWF4MiA9IE1hdGguYWJzKG1heDIpIC0gc3RlcDsKICByZXR1cm4gTWF0aC5tYXgoMCwgZXhwb25lbnRfZGVmYXVsdChtYXgyKSAtIGV4cG9uZW50X2RlZmF1bHQoc3RlcCkpICsgMTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGlja0Zvcm1hdC5qcwpmdW5jdGlvbiB0aWNrRm9ybWF0KHN0YXJ0LCBzdG9wLCBjb3VudCwgc3BlY2lmaWVyKSB7CiAgdmFyIHN0ZXAgPSB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCBwcmVjaXNpb247CiAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciA9PSBudWxsID8gIixmIiA6IHNwZWNpZmllcik7CiAgc3dpdGNoIChzcGVjaWZpZXIudHlwZSkgewogICAgY2FzZSAicyI6IHsKICAgICAgdmFyIHZhbHVlID0gTWF0aC5tYXgoTWF0aC5hYnMoc3RhcnQpLCBNYXRoLmFicyhzdG9wKSk7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblByZWZpeF9kZWZhdWx0KHN0ZXAsIHZhbHVlKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb247CiAgICAgIHJldHVybiBmb3JtYXRQcmVmaXgoc3BlY2lmaWVyLCB2YWx1ZSk7CiAgICB9CiAgICBjYXNlICIiOgogICAgY2FzZSAiZSI6CiAgICBjYXNlICJnIjoKICAgIGNhc2UgInAiOgogICAgY2FzZSAiciI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uUm91bmRfZGVmYXVsdChzdGVwLCBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiZSIpOwogICAgICBicmVhazsKICAgIH0KICAgIGNhc2UgImYiOgogICAgY2FzZSAiJSI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uRml4ZWRfZGVmYXVsdChzdGVwKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb24gLSAoc3BlY2lmaWVyLnR5cGUgPT09ICIlIikgKiAyOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGZvcm1hdChzcGVjaWZpZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9saW5lYXIuanMKZnVuY3Rpb24gbGluZWFyaXNoKHNjYWxlKSB7CiAgdmFyIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBzY2FsZS50aWNrcyA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tzKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgY291bnQgPT0gbnVsbCA/IDEwIDogY291bnQpOwogIH07CiAgc2NhbGUudGlja0Zvcm1hdCA9IGZ1bmN0aW9uKGNvdW50LCBzcGVjaWZpZXIpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja0Zvcm1hdChkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGNvdW50ID09IG51bGwgPyAxMCA6IGNvdW50LCBzcGVjaWZpZXIpOwogIH07CiAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICBpZiAoY291bnQgPT0gbnVsbCkgY291bnQgPSAxMDsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICB2YXIgaTAgPSAwOwogICAgdmFyIGkxID0gZC5sZW5ndGggLSAxOwogICAgdmFyIHN0YXJ0ID0gZFtpMF07CiAgICB2YXIgc3RvcCA9IGRbaTFdOwogICAgdmFyIHByZXN0ZXA7CiAgICB2YXIgc3RlcDsKICAgIHZhciBtYXhJdGVyID0gMTA7CiAgICBpZiAoc3RvcCA8IHN0YXJ0KSB7CiAgICAgIHN0ZXAgPSBzdGFydCwgc3RhcnQgPSBzdG9wLCBzdG9wID0gc3RlcDsKICAgICAgc3RlcCA9IGkwLCBpMCA9IGkxLCBpMSA9IHN0ZXA7CiAgICB9CiAgICB3aGlsZSAobWF4SXRlci0tID4gMCkgewogICAgICBzdGVwID0gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpOwogICAgICBpZiAoc3RlcCA9PT0gcHJlc3RlcCkgewogICAgICAgIGRbaTBdID0gc3RhcnQ7CiAgICAgICAgZFtpMV0gPSBzdG9wOwogICAgICAgIHJldHVybiBkb21haW4oZCk7CiAgICAgIH0gZWxzZSBpZiAoc3RlcCA+IDApIHsKICAgICAgICBzdGFydCA9IE1hdGguZmxvb3Ioc3RhcnQgLyBzdGVwKSAqIHN0ZXA7CiAgICAgICAgc3RvcCA9IE1hdGguY2VpbChzdG9wIC8gc3RlcCkgKiBzdGVwOwogICAgICB9IGVsc2UgaWYgKHN0ZXAgPCAwKSB7CiAgICAgICAgc3RhcnQgPSBNYXRoLmNlaWwoc3RhcnQgKiBzdGVwKSAvIHN0ZXA7CiAgICAgICAgc3RvcCA9IE1hdGguZmxvb3Ioc3RvcCAqIHN0ZXApIC8gc3RlcDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBwcmVzdGVwID0gc3RlcDsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBsaW5lYXIyKCkgewogIHZhciBzY2FsZSA9IGNvbnRpbnVvdXMoKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgbGluZWFyMigpKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvaWRlbnRpdHkuanMKZnVuY3Rpb24gaWRlbnRpdHkyKGRvbWFpbikgewogIHZhciB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogeDI7CiAgfQogIHNjYWxlLmludmVydCA9IHNjYWxlOwogIHNjYWxlLmRvbWFpbiA9IHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSwgc2NhbGUpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gaWRlbnRpdHkyKGRvbWFpbikudW5rbm93bih1bmtub3duKTsKICB9OwogIGRvbWFpbiA9IGFyZ3VtZW50cy5sZW5ndGggPyBBcnJheS5mcm9tKGRvbWFpbiwgbnVtYmVyMikgOiBbMCwgMV07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL25pY2UuanMKZnVuY3Rpb24gbmljZShkb21haW4sIGludGVydmFsKSB7CiAgZG9tYWluID0gZG9tYWluLnNsaWNlKCk7CiAgdmFyIGkwID0gMCwgaTEgPSBkb21haW4ubGVuZ3RoIC0gMSwgeDAgPSBkb21haW5baTBdLCB4MSA9IGRvbWFpbltpMV0sIHQ7CiAgaWYgKHgxIDwgeDApIHsKICAgIHQgPSBpMCwgaTAgPSBpMSwgaTEgPSB0OwogICAgdCA9IHgwLCB4MCA9IHgxLCB4MSA9IHQ7CiAgfQogIGRvbWFpbltpMF0gPSBpbnRlcnZhbC5mbG9vcih4MCk7CiAgZG9tYWluW2kxXSA9IGludGVydmFsLmNlaWwoeDEpOwogIHJldHVybiBkb21haW47Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2xvZy5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1Mb2coeDIpIHsKICByZXR1cm4gTWF0aC5sb2coeDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cCh4MikgewogIHJldHVybiBNYXRoLmV4cCh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtTG9nbih4MikgewogIHJldHVybiAtTWF0aC5sb2coLXgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1FeHBuKHgyKSB7CiAgcmV0dXJuIC1NYXRoLmV4cCgteDIpOwp9CmZ1bmN0aW9uIHBvdzEwKHgyKSB7CiAgcmV0dXJuIGlzRmluaXRlKHgyKSA/ICsoIjFlIiArIHgyKSA6IHgyIDwgMCA/IDAgOiB4MjsKfQpmdW5jdGlvbiBwb3dwKGJhc2UpIHsKICByZXR1cm4gYmFzZSA9PT0gMTAgPyBwb3cxMCA6IGJhc2UgPT09IE1hdGguRSA/IE1hdGguZXhwIDogKHgyKSA9PiBNYXRoLnBvdyhiYXNlLCB4Mik7Cn0KZnVuY3Rpb24gbG9ncChiYXNlKSB7CiAgcmV0dXJuIGJhc2UgPT09IE1hdGguRSA/IE1hdGgubG9nIDogYmFzZSA9PT0gMTAgJiYgTWF0aC5sb2cxMCB8fCBiYXNlID09PSAyICYmIE1hdGgubG9nMiB8fCAoYmFzZSA9IE1hdGgubG9nKGJhc2UpLCAoeDIpID0+IE1hdGgubG9nKHgyKSAvIGJhc2UpOwp9CmZ1bmN0aW9uIHJlZmxlY3QoZikgewogIHJldHVybiAoeDIsIGspID0+IC1mKC14Miwgayk7Cn0KZnVuY3Rpb24gbG9nZ2lzaCh0cmFuc2Zvcm0pIHsKICBjb25zdCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1Mb2csIHRyYW5zZm9ybUV4cCk7CiAgY29uc3QgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIGxldCBiYXNlID0gMTA7CiAgbGV0IGxvZ3M7CiAgbGV0IHBvd3M7CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIGxvZ3MgPSBsb2dwKGJhc2UpLCBwb3dzID0gcG93cChiYXNlKTsKICAgIGlmIChkb21haW4oKVswXSA8IDApIHsKICAgICAgbG9ncyA9IHJlZmxlY3QobG9ncyksIHBvd3MgPSByZWZsZWN0KHBvd3MpOwogICAgICB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nbiwgdHJhbnNmb3JtRXhwbik7CiAgICB9IGVsc2UgewogICAgICB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH0KICBzY2FsZS5iYXNlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYmFzZSA9ICtfLCByZXNjYWxlKCkpIDogYmFzZTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbihfKSwgcmVzY2FsZSgpKSA6IGRvbWFpbigpOwogIH07CiAgc2NhbGUudGlja3MgPSAoY291bnQpID0+IHsKICAgIGNvbnN0IGQgPSBkb21haW4oKTsKICAgIGxldCB1ID0gZFswXTsKICAgIGxldCB2ID0gZFtkLmxlbmd0aCAtIDFdOwogICAgY29uc3QgcjIgPSB2IDwgdTsKICAgIGlmIChyMikgW3UsIHZdID0gW3YsIHVdOwogICAgbGV0IGkgPSBsb2dzKHUpOwogICAgbGV0IGogPSBsb2dzKHYpOwogICAgbGV0IGs7CiAgICBsZXQgdDsKICAgIGNvbnN0IG4gPSBjb3VudCA9PSBudWxsID8gMTAgOiArY291bnQ7CiAgICBsZXQgeiA9IFtdOwogICAgaWYgKCEoYmFzZSAlIDEpICYmIGogLSBpIDwgbikgewogICAgICBpID0gTWF0aC5mbG9vcihpKSwgaiA9IE1hdGguY2VpbChqKTsKICAgICAgaWYgKHUgPiAwKSBmb3IgKDsgaSA8PSBqOyArK2kpIHsKICAgICAgICBmb3IgKGsgPSAxOyBrIDwgYmFzZTsgKytrKSB7CiAgICAgICAgICB0ID0gaSA8IDAgPyBrIC8gcG93cygtaSkgOiBrICogcG93cyhpKTsKICAgICAgICAgIGlmICh0IDwgdSkgY29udGludWU7CiAgICAgICAgICBpZiAodCA+IHYpIGJyZWFrOwogICAgICAgICAgei5wdXNoKHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGZvciAoOyBpIDw9IGo7ICsraSkgewogICAgICAgIGZvciAoayA9IGJhc2UgLSAxOyBrID49IDE7IC0taykgewogICAgICAgICAgdCA9IGkgPiAwID8gayAvIHBvd3MoLWkpIDogayAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHoubGVuZ3RoICogMiA8IG4pIHogPSB0aWNrcyh1LCB2LCBuKTsKICAgIH0gZWxzZSB7CiAgICAgIHogPSB0aWNrcyhpLCBqLCBNYXRoLm1pbihqIC0gaSwgbikpLm1hcChwb3dzKTsKICAgIH0KICAgIHJldHVybiByMiA/IHoucmV2ZXJzZSgpIDogejsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSAoY291bnQsIHNwZWNpZmllcikgPT4gewogICAgaWYgKGNvdW50ID09IG51bGwpIGNvdW50ID0gMTA7CiAgICBpZiAoc3BlY2lmaWVyID09IG51bGwpIHNwZWNpZmllciA9IGJhc2UgPT09IDEwID8gInMiIDogIiwiOwogICAgaWYgKHR5cGVvZiBzcGVjaWZpZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCEoYmFzZSAlIDEpICYmIChzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSkucHJlY2lzaW9uID09IG51bGwpIHNwZWNpZmllci50cmltID0gdHJ1ZTsKICAgICAgc3BlY2lmaWVyID0gZm9ybWF0KHNwZWNpZmllcik7CiAgICB9CiAgICBpZiAoY291bnQgPT09IEluZmluaXR5KSByZXR1cm4gc3BlY2lmaWVyOwogICAgY29uc3QgayA9IE1hdGgubWF4KDEsIGJhc2UgKiBjb3VudCAvIHNjYWxlLnRpY2tzKCkubGVuZ3RoKTsKICAgIHJldHVybiAoZCkgPT4gewogICAgICBsZXQgaSA9IGQgLyBwb3dzKE1hdGgucm91bmQobG9ncyhkKSkpOwogICAgICBpZiAoaSAqIGJhc2UgPCBiYXNlIC0gMC41KSBpICo9IGJhc2U7CiAgICAgIHJldHVybiBpIDw9IGsgPyBzcGVjaWZpZXIoZCkgOiAiIjsKICAgIH07CiAgfTsKICBzY2FsZS5uaWNlID0gKCkgPT4gewogICAgcmV0dXJuIGRvbWFpbihuaWNlKGRvbWFpbigpLCB7CiAgICAgIGZsb29yOiAoeDIpID0+IHBvd3MoTWF0aC5mbG9vcihsb2dzKHgyKSkpLAogICAgICBjZWlsOiAoeDIpID0+IHBvd3MoTWF0aC5jZWlsKGxvZ3MoeDIpKSkKICAgIH0pKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBsb2coKSB7CiAgY29uc3Qgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyKCkpLmRvbWFpbihbMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gKCkgPT4gY29weShzY2FsZSwgbG9nKCkpLmJhc2Uoc2NhbGUuYmFzZSgpKTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zeW1sb2cuanMKZnVuY3Rpb24gdHJhbnNmb3JtU3ltbG9nKGMpIHsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5sb2cxcChNYXRoLmFicyh4MiAvIGMpKTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWV4cChjKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIE1hdGguZXhwbTEoTWF0aC5hYnMoeDIpKSAqIGM7CiAgfTsKfQpmdW5jdGlvbiBzeW1sb2dpc2godHJhbnNmb3JtKSB7CiAgdmFyIGMgPSAxLCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYyksIHRyYW5zZm9ybVN5bWV4cChjKSk7CiAgc2NhbGUuY29uc3RhbnQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYyA9ICtfKSwgdHJhbnNmb3JtU3ltZXhwKGMpKSA6IGM7CiAgfTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQpmdW5jdGlvbiBzeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBzeW1sb2coKSkuY29uc3RhbnQoc2NhbGUuY29uc3RhbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9wb3cuanMKZnVuY3Rpb24gdHJhbnNmb3JtUG93KGV4cG9uZW50KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4geDIgPCAwID8gLU1hdGgucG93KC14MiwgZXhwb25lbnQpIDogTWF0aC5wb3coeDIsIGV4cG9uZW50KTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVNxcnQoeDIpIHsKICByZXR1cm4geDIgPCAwID8gLU1hdGguc3FydCgteDIpIDogTWF0aC5zcXJ0KHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TcXVhcmUoeDIpIHsKICByZXR1cm4geDIgPCAwID8gLXgyICogeDIgOiB4MiAqIHgyOwp9CmZ1bmN0aW9uIHBvd2lzaCh0cmFuc2Zvcm0pIHsKICB2YXIgc2NhbGUgPSB0cmFuc2Zvcm0oaWRlbnRpdHksIGlkZW50aXR5KSwgZXhwb25lbnQgPSAxOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICByZXR1cm4gZXhwb25lbnQgPT09IDEgPyB0cmFuc2Zvcm0oaWRlbnRpdHksIGlkZW50aXR5KSA6IGV4cG9uZW50ID09PSAwLjUgPyB0cmFuc2Zvcm0odHJhbnNmb3JtU3FydCwgdHJhbnNmb3JtU3F1YXJlKSA6IHRyYW5zZm9ybSh0cmFuc2Zvcm1Qb3coZXhwb25lbnQpLCB0cmFuc2Zvcm1Qb3coMSAvIGV4cG9uZW50KSk7CiAgfQogIHNjYWxlLmV4cG9uZW50ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZXhwb25lbnQgPSArXywgcmVzY2FsZSgpKSA6IGV4cG9uZW50OwogIH07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KZnVuY3Rpb24gcG93KCkgewogIHZhciBzY2FsZSA9IHBvd2lzaCh0cmFuc2Zvcm1lcigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgcG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBzcXJ0KCkgewogIHJldHVybiBwb3cuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5leHBvbmVudCgwLjUpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9yYWRpYWwuanMKZnVuY3Rpb24gc3F1YXJlKHgyKSB7CiAgcmV0dXJuIE1hdGguc2lnbih4MikgKiB4MiAqIHgyOwp9CmZ1bmN0aW9uIHVuc3F1YXJlKHgyKSB7CiAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLnNxcnQoTWF0aC5hYnMoeDIpKTsKfQpmdW5jdGlvbiByYWRpYWwoKSB7CiAgdmFyIHNxdWFyZWQgPSBjb250aW51b3VzKCksIHJhbmdlNCA9IFswLCAxXSwgcm91bmQgPSBmYWxzZSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgdmFyIHkyID0gdW5zcXVhcmUoc3F1YXJlZCh4MikpOwogICAgcmV0dXJuIGlzTmFOKHkyKSA/IHVua25vd24gOiByb3VuZCA/IE1hdGgucm91bmQoeTIpIDogeTI7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gc3F1YXJlZC5pbnZlcnQoc3F1YXJlKHkyKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzcXVhcmVkLmRvbWFpbihfKSwgc2NhbGUpIDogc3F1YXJlZC5kb21haW4oKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5yYW5nZSgocmFuZ2U0ID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSkubWFwKHNxdWFyZSkpLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gc2NhbGUucmFuZ2UoXykucm91bmQodHJ1ZSk7CiAgfTsKICBzY2FsZS5yb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJvdW5kID0gISFfLCBzY2FsZSkgOiByb3VuZDsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5jbGFtcChfKSwgc2NhbGUpIDogc3F1YXJlZC5jbGFtcCgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHJhZGlhbChzcXVhcmVkLmRvbWFpbigpLCByYW5nZTQpLnJvdW5kKHJvdW5kKS5jbGFtcChzcXVhcmVkLmNsYW1wKCkpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3F1YW50aWxlLmpzCmZ1bmN0aW9uIHF1YW50aWxlMigpIHsKICB2YXIgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB0aHJlc2hvbGRzID0gW10sIHVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gMCwgbiA9IE1hdGgubWF4KDEsIHJhbmdlNC5sZW5ndGgpOwogICAgdGhyZXNob2xkcyA9IG5ldyBBcnJheShuIC0gMSk7CiAgICB3aGlsZSAoKytpIDwgbikgdGhyZXNob2xkc1tpIC0gMV0gPSBxdWFudGlsZVNvcnRlZChkb21haW4sIGkgLyBuKTsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiByYW5nZTRbYmlzZWN0X2RlZmF1bHQodGhyZXNob2xkcywgeDIpXTsKICB9CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIGkgPCAwID8gW05hTiwgTmFOXSA6IFsKICAgICAgaSA+IDAgPyB0aHJlc2hvbGRzW2kgLSAxXSA6IGRvbWFpblswXSwKICAgICAgaSA8IHRocmVzaG9sZHMubGVuZ3RoID8gdGhyZXNob2xkc1tpXSA6IGRvbWFpbltkb21haW4ubGVuZ3RoIC0gMV0KICAgIF07CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdOwogICAgZm9yIChsZXQgZCBvZiBfKSBpZiAoZCAhPSBudWxsICYmICFpc05hTihkID0gK2QpKSBkb21haW4ucHVzaChkKTsKICAgIGRvbWFpbi5zb3J0KGFzY2VuZGluZyk7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGRzLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpbGUyKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcXVhbnRpemUuanMKZnVuY3Rpb24gcXVhbnRpemUoKSB7CiAgdmFyIHgwID0gMCwgeDEgPSAxLCBuID0gMSwgZG9tYWluID0gWzAuNV0sIHJhbmdlNCA9IFswLCAxXSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyICE9IG51bGwgJiYgeDIgPD0geDIgPyByYW5nZTRbYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMCwgbildIDogdW5rbm93bjsKICB9CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gLTE7CiAgICBkb21haW4gPSBuZXcgQXJyYXkobik7CiAgICB3aGlsZSAoKytpIDwgbikgZG9tYWluW2ldID0gKChpICsgMSkgKiB4MSAtIChpIC0gbikgKiB4MCkgLyAobiArIDEpOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHgwID0gK3gwLCB4MSA9ICt4MSwgcmVzY2FsZSgpKSA6IFt4MCwgeDFdOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChuID0gKHJhbmdlNCA9IEFycmF5LmZyb20oXykpLmxlbmd0aCAtIDEsIHJlc2NhbGUoKSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBpIDwgMCA/IFtOYU4sIE5hTl0gOiBpIDwgMSA/IFt4MCwgZG9tYWluWzBdXSA6IGkgPj0gbiA/IFtkb21haW5bbiAtIDFdLCB4MV0gOiBbZG9tYWluW2kgLSAxXSwgZG9tYWluW2ldXTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogc2NhbGU7CiAgfTsKICBzY2FsZS50aHJlc2hvbGRzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpemUoKS5kb21haW4oW3gwLCB4MV0pLnJhbmdlKHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkobGluZWFyaXNoKHNjYWxlKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGhyZXNob2xkLmpzCmZ1bmN0aW9uIHRocmVzaG9sZCgpIHsKICB2YXIgZG9tYWluID0gWzAuNV0sIHJhbmdlNCA9IFswLCAxXSwgdW5rbm93biwgbiA9IDE7CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiAhPSBudWxsICYmIHgyIDw9IHgyID8gcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDAsIG4pXSA6IHVua25vd247CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXyksIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoIC0gMSksIHNjYWxlKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCAtIDEpLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBbZG9tYWluW2kgLSAxXSwgZG9tYWluW2ldXTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGQoKS5kb21haW4oZG9tYWluKS5yYW5nZShyYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvaW50ZXJ2YWwuanMKdmFyIHQwID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CnZhciB0MSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwpmdW5jdGlvbiB0aW1lSW50ZXJ2YWwoZmxvb3JpLCBvZmZzZXRpLCBjb3VudCwgZmllbGQpIHsKICBmdW5jdGlvbiBpbnRlcnZhbChkYXRlMikgewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPyAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSA6IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpKSwgZGF0ZTI7CiAgfQogIGludGVydmFsLmZsb29yID0gKGRhdGUyKSA9PiB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMikpLCBkYXRlMjsKICB9OwogIGludGVydmFsLmNlaWwgPSAoZGF0ZTIpID0+IHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSBuZXcgRGF0ZShkYXRlMiAtIDEpKSwgb2Zmc2V0aShkYXRlMiwgMSksIGZsb29yaShkYXRlMiksIGRhdGUyOwogIH07CiAgaW50ZXJ2YWwucm91bmQgPSAoZGF0ZTIpID0+IHsKICAgIGNvbnN0IGQwID0gaW50ZXJ2YWwoZGF0ZTIpLCBkMSA9IGludGVydmFsLmNlaWwoZGF0ZTIpOwogICAgcmV0dXJuIGRhdGUyIC0gZDAgPCBkMSAtIGRhdGUyID8gZDAgOiBkMTsKICB9OwogIGludGVydmFsLm9mZnNldCA9IChkYXRlMiwgc3RlcCkgPT4gewogICAgcmV0dXJuIG9mZnNldGkoZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSwgc3RlcCA9PSBudWxsID8gMSA6IE1hdGguZmxvb3Ioc3RlcCkpLCBkYXRlMjsKICB9OwogIGludGVydmFsLnJhbmdlID0gKHN0YXJ0LCBzdG9wLCBzdGVwKSA9PiB7CiAgICBjb25zdCByYW5nZTQgPSBbXTsKICAgIHN0YXJ0ID0gaW50ZXJ2YWwuY2VpbChzdGFydCk7CiAgICBzdGVwID0gc3RlcCA9PSBudWxsID8gMSA6IE1hdGguZmxvb3Ioc3RlcCk7CiAgICBpZiAoIShzdGFydCA8IHN0b3ApIHx8ICEoc3RlcCA+IDApKSByZXR1cm4gcmFuZ2U0OwogICAgbGV0IHByZXZpb3VzOwogICAgZG8KICAgICAgcmFuZ2U0LnB1c2gocHJldmlvdXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK3N0YXJ0KSksIG9mZnNldGkoc3RhcnQsIHN0ZXApLCBmbG9vcmkoc3RhcnQpOwogICAgd2hpbGUgKHByZXZpb3VzIDwgc3RhcnQgJiYgc3RhcnQgPCBzdG9wKTsKICAgIHJldHVybiByYW5nZTQ7CiAgfTsKICBpbnRlcnZhbC5maWx0ZXIgPSAodGVzdCkgPT4gewogICAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgICAgaWYgKGRhdGUyID49IGRhdGUyKSB3aGlsZSAoZmxvb3JpKGRhdGUyKSwgIXRlc3QoZGF0ZTIpKSBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gMSk7CiAgICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgICAgaWYgKGRhdGUyID49IGRhdGUyKSB7CiAgICAgICAgaWYgKHN0ZXAgPCAwKSB3aGlsZSAoKytzdGVwIDw9IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUyLCAtMSksICF0ZXN0KGRhdGUyKSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHdoaWxlICgtLXN0ZXAgPj0gMCkgewogICAgICAgICAgd2hpbGUgKG9mZnNldGkoZGF0ZTIsIDEpLCAhdGVzdChkYXRlMikpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CiAgaWYgKGNvdW50KSB7CiAgICBpbnRlcnZhbC5jb3VudCA9IChzdGFydCwgZW5kKSA9PiB7CiAgICAgIHQwLnNldFRpbWUoK3N0YXJ0KSwgdDEuc2V0VGltZSgrZW5kKTsKICAgICAgZmxvb3JpKHQwKSwgZmxvb3JpKHQxKTsKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoY291bnQodDAsIHQxKSk7CiAgICB9OwogICAgaW50ZXJ2YWwuZXZlcnkgPSAoc3RlcCkgPT4gewogICAgICBzdGVwID0gTWF0aC5mbG9vcihzdGVwKTsKICAgICAgcmV0dXJuICFpc0Zpbml0ZShzdGVwKSB8fCAhKHN0ZXAgPiAwKSA/IG51bGwgOiAhKHN0ZXAgPiAxKSA/IGludGVydmFsIDogaW50ZXJ2YWwuZmlsdGVyKGZpZWxkID8gKGQpID0+IGZpZWxkKGQpICUgc3RlcCA9PT0gMCA6IChkKSA9PiBpbnRlcnZhbC5jb3VudCgwLCBkKSAlIHN0ZXAgPT09IDApOwogICAgfTsKICB9CiAgcmV0dXJuIGludGVydmFsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbWlsbGlzZWNvbmQuanMKdmFyIG1pbGxpc2Vjb25kID0gdGltZUludGVydmFsKCgpID0+IHsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kIC0gc3RhcnQ7Cn0pOwptaWxsaXNlY29uZC5ldmVyeSA9IChrKSA9PiB7CiAgayA9IE1hdGguZmxvb3Ioayk7CiAgaWYgKCFpc0Zpbml0ZShrKSB8fCAhKGsgPiAwKSkgcmV0dXJuIG51bGw7CiAgaWYgKCEoayA+IDEpKSByZXR1cm4gbWlsbGlzZWNvbmQ7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFRpbWUoTWF0aC5mbG9vcihkYXRlMiAvIGspICogayk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBrKTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBrOwogIH0pOwp9Owp2YXIgbWlsbGlzZWNvbmRzID0gbWlsbGlzZWNvbmQucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvZHVyYXRpb24uanMKdmFyIGR1cmF0aW9uU2Vjb25kID0gMWUzOwp2YXIgZHVyYXRpb25NaW51dGUgPSBkdXJhdGlvblNlY29uZCAqIDYwOwp2YXIgZHVyYXRpb25Ib3VyID0gZHVyYXRpb25NaW51dGUgKiA2MDsKdmFyIGR1cmF0aW9uRGF5ID0gZHVyYXRpb25Ib3VyICogMjQ7CnZhciBkdXJhdGlvbldlZWsgPSBkdXJhdGlvbkRheSAqIDc7CnZhciBkdXJhdGlvbk1vbnRoID0gZHVyYXRpb25EYXkgKiAzMDsKdmFyIGR1cmF0aW9uWWVhciA9IGR1cmF0aW9uRGF5ICogMzY1OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3NlY29uZC5qcwp2YXIgc2Vjb25kID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uU2Vjb25kKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uU2Vjb25kOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDU2Vjb25kcygpOwp9KTsKdmFyIHNlY29uZHMgPSBzZWNvbmQucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbWludXRlLmpzCnZhciB0aW1lTWludXRlID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSAtIGRhdGUyLmdldFNlY29uZHMoKSAqIGR1cmF0aW9uU2Vjb25kKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25NaW51dGUpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25NaW51dGU7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRNaW51dGVzKCk7Cn0pOwp2YXIgdGltZU1pbnV0ZXMgPSB0aW1lTWludXRlLnJhbmdlOwp2YXIgdXRjTWludXRlID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ1NlY29uZHMoMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uTWludXRlKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uTWludXRlOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDTWludXRlcygpOwp9KTsKdmFyIHV0Y01pbnV0ZXMgPSB1dGNNaW51dGUucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvaG91ci5qcwp2YXIgdGltZUhvdXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpIC0gZGF0ZTIuZ2V0U2Vjb25kcygpICogZHVyYXRpb25TZWNvbmQgLSBkYXRlMi5nZXRNaW51dGVzKCkgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uSG91cik7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkhvdXI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRIb3VycygpOwp9KTsKdmFyIHRpbWVIb3VycyA9IHRpbWVIb3VyLnJhbmdlOwp2YXIgdXRjSG91ciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENNaW51dGVzKDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbkhvdXIpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25Ib3VyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDSG91cnMoKTsKfSk7CnZhciB1dGNIb3VycyA9IHV0Y0hvdXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvZGF5LmpzCnZhciB0aW1lRGF5ID0gdGltZUludGVydmFsKAogIChkYXRlMikgPT4gZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCksCiAgKGRhdGUyLCBzdGVwKSA9PiBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSArIHN0ZXApLAogIChzdGFydCwgZW5kKSA9PiAoZW5kIC0gc3RhcnQgLSAoZW5kLmdldFRpbWV6b25lT2Zmc2V0KCkgLSBzdGFydC5nZXRUaW1lem9uZU9mZnNldCgpKSAqIGR1cmF0aW9uTWludXRlKSAvIGR1cmF0aW9uRGF5LAogIChkYXRlMikgPT4gZGF0ZTIuZ2V0RGF0ZSgpIC0gMQopOwp2YXIgdGltZURheXMgPSB0aW1lRGF5LnJhbmdlOwp2YXIgdXRjRGF5ID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25EYXk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENEYXRlKCkgLSAxOwp9KTsKdmFyIHV0Y0RheXMgPSB1dGNEYXkucmFuZ2U7CnZhciB1bml4RGF5ID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25EYXk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBNYXRoLmZsb29yKGRhdGUyIC8gZHVyYXRpb25EYXkpOwp9KTsKdmFyIHVuaXhEYXlzID0gdW5peERheS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy93ZWVrLmpzCmZ1bmN0aW9uIHRpbWVXZWVrZGF5KGkpIHsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgLSAoZGF0ZTIuZ2V0RGF5KCkgKyA3IC0gaSkgJSA3KTsKICAgIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgKyBzdGVwICogNyk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQgLSAoZW5kLmdldFRpbWV6b25lT2Zmc2V0KCkgLSBzdGFydC5nZXRUaW1lem9uZU9mZnNldCgpKSAqIGR1cmF0aW9uTWludXRlKSAvIGR1cmF0aW9uV2VlazsKICB9KTsKfQp2YXIgdGltZVN1bmRheSA9IHRpbWVXZWVrZGF5KDApOwp2YXIgdGltZU1vbmRheSA9IHRpbWVXZWVrZGF5KDEpOwp2YXIgdGltZVR1ZXNkYXkgPSB0aW1lV2Vla2RheSgyKTsKdmFyIHRpbWVXZWRuZXNkYXkgPSB0aW1lV2Vla2RheSgzKTsKdmFyIHRpbWVUaHVyc2RheSA9IHRpbWVXZWVrZGF5KDQpOwp2YXIgdGltZUZyaWRheSA9IHRpbWVXZWVrZGF5KDUpOwp2YXIgdGltZVNhdHVyZGF5ID0gdGltZVdlZWtkYXkoNik7CnZhciB0aW1lU3VuZGF5cyA9IHRpbWVTdW5kYXkucmFuZ2U7CnZhciB0aW1lTW9uZGF5cyA9IHRpbWVNb25kYXkucmFuZ2U7CnZhciB0aW1lVHVlc2RheXMgPSB0aW1lVHVlc2RheS5yYW5nZTsKdmFyIHRpbWVXZWRuZXNkYXlzID0gdGltZVdlZG5lc2RheS5yYW5nZTsKdmFyIHRpbWVUaHVyc2RheXMgPSB0aW1lVGh1cnNkYXkucmFuZ2U7CnZhciB0aW1lRnJpZGF5cyA9IHRpbWVGcmlkYXkucmFuZ2U7CnZhciB0aW1lU2F0dXJkYXlzID0gdGltZVNhdHVyZGF5LnJhbmdlOwpmdW5jdGlvbiB1dGNXZWVrZGF5KGkpIHsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgLSAoZGF0ZTIuZ2V0VVRDRGF5KCkgKyA3IC0gaSkgJSA3KTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwICogNyk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25XZWVrOwogIH0pOwp9CnZhciB1dGNTdW5kYXkgPSB1dGNXZWVrZGF5KDApOwp2YXIgdXRjTW9uZGF5ID0gdXRjV2Vla2RheSgxKTsKdmFyIHV0Y1R1ZXNkYXkgPSB1dGNXZWVrZGF5KDIpOwp2YXIgdXRjV2VkbmVzZGF5ID0gdXRjV2Vla2RheSgzKTsKdmFyIHV0Y1RodXJzZGF5ID0gdXRjV2Vla2RheSg0KTsKdmFyIHV0Y0ZyaWRheSA9IHV0Y1dlZWtkYXkoNSk7CnZhciB1dGNTYXR1cmRheSA9IHV0Y1dlZWtkYXkoNik7CnZhciB1dGNTdW5kYXlzID0gdXRjU3VuZGF5LnJhbmdlOwp2YXIgdXRjTW9uZGF5cyA9IHV0Y01vbmRheS5yYW5nZTsKdmFyIHV0Y1R1ZXNkYXlzID0gdXRjVHVlc2RheS5yYW5nZTsKdmFyIHV0Y1dlZG5lc2RheXMgPSB1dGNXZWRuZXNkYXkucmFuZ2U7CnZhciB1dGNUaHVyc2RheXMgPSB1dGNUaHVyc2RheS5yYW5nZTsKdmFyIHV0Y0ZyaWRheXMgPSB1dGNGcmlkYXkucmFuZ2U7CnZhciB1dGNTYXR1cmRheXMgPSB1dGNTYXR1cmRheS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9tb250aC5qcwp2YXIgdGltZU1vbnRoID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldERhdGUoMSk7CiAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldE1vbnRoKGRhdGUyLmdldE1vbnRoKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldE1vbnRoKCkgLSBzdGFydC5nZXRNb250aCgpICsgKGVuZC5nZXRGdWxsWWVhcigpIC0gc3RhcnQuZ2V0RnVsbFllYXIoKSkgKiAxMjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldE1vbnRoKCk7Cn0pOwp2YXIgdGltZU1vbnRocyA9IHRpbWVNb250aC5yYW5nZTsKdmFyIHV0Y01vbnRoID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ01vbnRoKGRhdGUyLmdldFVUQ01vbnRoKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ01vbnRoKCkgLSBzdGFydC5nZXRVVENNb250aCgpICsgKGVuZC5nZXRVVENGdWxsWWVhcigpIC0gc3RhcnQuZ2V0VVRDRnVsbFllYXIoKSkgKiAxMjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ01vbnRoKCk7Cn0pOwp2YXIgdXRjTW9udGhzID0gdXRjTW9udGgucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMveWVhci5qcwp2YXIgdGltZVllYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0TW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldEZ1bGxZZWFyKGRhdGUyLmdldEZ1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldEZ1bGxZZWFyKCkgLSBzdGFydC5nZXRGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0RnVsbFllYXIoKTsKfSk7CnRpbWVZZWFyLmV2ZXJ5ID0gKGspID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsgPSBNYXRoLmZsb29yKGspKSB8fCAhKGsgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldEZ1bGxZZWFyKCkgLyBrKSAqIGspOwogICAgZGF0ZTIuc2V0TW9udGgoMCwgMSk7CiAgICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldEZ1bGxZZWFyKGRhdGUyLmdldEZ1bGxZZWFyKCkgKyBzdGVwICogayk7CiAgfSk7Cn07CnZhciB0aW1lWWVhcnMgPSB0aW1lWWVhci5yYW5nZTsKdmFyIHV0Y1llYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ0Z1bGxZZWFyKCkgLSBzdGFydC5nZXRVVENGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKTsKfSk7CnV0Y1llYXIuZXZlcnkgPSAoaykgPT4gewogIHJldHVybiAhaXNGaW5pdGUoayA9IE1hdGguZmxvb3IoaykpIHx8ICEoayA+IDApID8gbnVsbCA6IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKE1hdGguZmxvb3IoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSAvIGspICogayk7CiAgICBkYXRlMi5zZXRVVENNb250aCgwLCAxKTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSArIHN0ZXAgKiBrKTsKICB9KTsKfTsKdmFyIHV0Y1llYXJzID0gdXRjWWVhci5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy90aWNrcy5qcwpmdW5jdGlvbiB0aWNrZXIoeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlKSB7CiAgY29uc3QgdGlja0ludGVydmFscyA9IFsKICAgIFtzZWNvbmQsIDEsIGR1cmF0aW9uU2Vjb25kXSwKICAgIFtzZWNvbmQsIDUsIDUgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCAxNSwgMTUgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCAzMCwgMzAgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbbWludXRlLCAxLCBkdXJhdGlvbk1pbnV0ZV0sCiAgICBbbWludXRlLCA1LCA1ICogZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgMTUsIDE1ICogZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgMzAsIDMwICogZHVyYXRpb25NaW51dGVdLAogICAgW2hvdXIsIDEsIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgMywgMyAqIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgNiwgNiAqIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgMTIsIDEyICogZHVyYXRpb25Ib3VyXSwKICAgIFtkYXksIDEsIGR1cmF0aW9uRGF5XSwKICAgIFtkYXksIDIsIDIgKiBkdXJhdGlvbkRheV0sCiAgICBbd2VlaywgMSwgZHVyYXRpb25XZWVrXSwKICAgIFttb250aCwgMSwgZHVyYXRpb25Nb250aF0sCiAgICBbbW9udGgsIDMsIDMgKiBkdXJhdGlvbk1vbnRoXSwKICAgIFt5ZWFyLCAxLCBkdXJhdGlvblllYXJdCiAgXTsKICBmdW5jdGlvbiB0aWNrczIoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydDsKICAgIGlmIChyZXZlcnNlMikgW3N0YXJ0LCBzdG9wXSA9IFtzdG9wLCBzdGFydF07CiAgICBjb25zdCBpbnRlcnZhbCA9IGNvdW50ICYmIHR5cGVvZiBjb3VudC5yYW5nZSA9PT0gImZ1bmN0aW9uIiA/IGNvdW50IDogdGlja0ludGVydmFsKHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgICBjb25zdCB0aWNrczMgPSBpbnRlcnZhbCA/IGludGVydmFsLnJhbmdlKHN0YXJ0LCArc3RvcCArIDEpIDogW107CiAgICByZXR1cm4gcmV2ZXJzZTIgPyB0aWNrczMucmV2ZXJzZSgpIDogdGlja3MzOwogIH0KICBmdW5jdGlvbiB0aWNrSW50ZXJ2YWwoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICBjb25zdCB0YXJnZXQgPSBNYXRoLmFicyhzdG9wIC0gc3RhcnQpIC8gY291bnQ7CiAgICBjb25zdCBpID0gYmlzZWN0b3IoKFssICwgc3RlcDJdKSA9PiBzdGVwMikucmlnaHQodGlja0ludGVydmFscywgdGFyZ2V0KTsKICAgIGlmIChpID09PSB0aWNrSW50ZXJ2YWxzLmxlbmd0aCkgcmV0dXJuIHllYXIuZXZlcnkodGlja1N0ZXAoc3RhcnQgLyBkdXJhdGlvblllYXIsIHN0b3AgLyBkdXJhdGlvblllYXIsIGNvdW50KSk7CiAgICBpZiAoaSA9PT0gMCkgcmV0dXJuIG1pbGxpc2Vjb25kLmV2ZXJ5KE1hdGgubWF4KHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCksIDEpKTsKICAgIGNvbnN0IFt0LCBzdGVwXSA9IHRpY2tJbnRlcnZhbHNbdGFyZ2V0IC8gdGlja0ludGVydmFsc1tpIC0gMV1bMl0gPCB0aWNrSW50ZXJ2YWxzW2ldWzJdIC8gdGFyZ2V0ID8gaSAtIDEgOiBpXTsKICAgIHJldHVybiB0LmV2ZXJ5KHN0ZXApOwogIH0KICByZXR1cm4gW3RpY2tzMiwgdGlja0ludGVydmFsXTsKfQp2YXIgW3V0Y1RpY2tzLCB1dGNUaWNrSW50ZXJ2YWxdID0gdGlja2VyKHV0Y1llYXIsIHV0Y01vbnRoLCB1dGNTdW5kYXksIHVuaXhEYXksIHV0Y0hvdXIsIHV0Y01pbnV0ZSk7CnZhciBbdGltZVRpY2tzLCB0aW1lVGlja0ludGVydmFsXSA9IHRpY2tlcih0aW1lWWVhciwgdGltZU1vbnRoLCB0aW1lU3VuZGF5LCB0aW1lRGF5LCB0aW1lSG91ciwgdGltZU1pbnV0ZSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZS1mb3JtYXRANC4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9sb2NhbGUuanMKZnVuY3Rpb24gbG9jYWxEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZSgtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihkLnkpOwogICAgcmV0dXJuIGRhdGUyOwogIH0KICByZXR1cm4gbmV3IERhdGUoZC55LCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKTsKfQpmdW5jdGlvbiB1dGNEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZShEYXRlLlVUQygtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMjsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwp9CmZ1bmN0aW9uIG5ld0RhdGUoeTIsIG0sIGQpIHsKICByZXR1cm4geyB5OiB5MiwgbSwgZCwgSDogMCwgTTogMCwgUzogMCwgTDogMCB9Owp9CmZ1bmN0aW9uIGZvcm1hdExvY2FsZShsb2NhbGUzKSB7CiAgdmFyIGxvY2FsZV9kYXRlVGltZSA9IGxvY2FsZTMuZGF0ZVRpbWUsIGxvY2FsZV9kYXRlID0gbG9jYWxlMy5kYXRlLCBsb2NhbGVfdGltZSA9IGxvY2FsZTMudGltZSwgbG9jYWxlX3BlcmlvZHMgPSBsb2NhbGUzLnBlcmlvZHMsIGxvY2FsZV93ZWVrZGF5cyA9IGxvY2FsZTMuZGF5cywgbG9jYWxlX3Nob3J0V2Vla2RheXMgPSBsb2NhbGUzLnNob3J0RGF5cywgbG9jYWxlX21vbnRocyA9IGxvY2FsZTMubW9udGhzLCBsb2NhbGVfc2hvcnRNb250aHMgPSBsb2NhbGUzLnNob3J0TW9udGhzOwogIHZhciBwZXJpb2RSZSA9IGZvcm1hdFJlKGxvY2FsZV9wZXJpb2RzKSwgcGVyaW9kTG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9wZXJpb2RzKSwgd2Vla2RheVJlID0gZm9ybWF0UmUobG9jYWxlX3dlZWtkYXlzKSwgd2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfd2Vla2RheXMpLCBzaG9ydFdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgc2hvcnRXZWVrZGF5TG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgbW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9tb250aHMpLCBtb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfbW9udGhzKSwgc2hvcnRNb250aFJlID0gZm9ybWF0UmUobG9jYWxlX3Nob3J0TW9udGhzKSwgc2hvcnRNb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRNb250aHMpOwogIHZhciBmb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFdlZWtkYXksCiAgICAiYiI6IGZvcm1hdFNob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdE1vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFllYXJJU08sCiAgICAiRyI6IGZvcm1hdEZ1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRIb3VyMjQsCiAgICAiSSI6IGZvcm1hdEhvdXIxMiwKICAgICJqIjogZm9ybWF0RGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdE1vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRNaW51dGVzLAogICAgInAiOiBmb3JtYXRQZXJpb2QsCiAgICAicSI6IGZvcm1hdFF1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRTZWNvbmRzLAogICAgInUiOiBmb3JtYXRXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRZZWFyLAogICAgIlkiOiBmb3JtYXRGdWxsWWVhciwKICAgICJaIjogZm9ybWF0Wm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciB1dGNGb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRVVENTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFVUQ1dlZWtkYXksCiAgICAiYiI6IGZvcm1hdFVUQ1Nob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdFVUQ01vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRVVENNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFVUQ1llYXJJU08sCiAgICAiRyI6IGZvcm1hdFVUQ0Z1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRVVENIb3VyMjQsCiAgICAiSSI6IGZvcm1hdFVUQ0hvdXIxMiwKICAgICJqIjogZm9ybWF0VVRDRGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRVVENNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdFVUQ01vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRVVENNaW51dGVzLAogICAgInAiOiBmb3JtYXRVVENQZXJpb2QsCiAgICAicSI6IGZvcm1hdFVUQ1F1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRVVENTZWNvbmRzLAogICAgInUiOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRVVENXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRVVENZZWFyLAogICAgIlkiOiBmb3JtYXRVVENGdWxsWWVhciwKICAgICJaIjogZm9ybWF0VVRDWm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciBwYXJzZXMgPSB7CiAgICAiYSI6IHBhcnNlU2hvcnRXZWVrZGF5LAogICAgIkEiOiBwYXJzZVdlZWtkYXksCiAgICAiYiI6IHBhcnNlU2hvcnRNb250aCwKICAgICJCIjogcGFyc2VNb250aCwKICAgICJjIjogcGFyc2VMb2NhbGVEYXRlVGltZSwKICAgICJkIjogcGFyc2VEYXlPZk1vbnRoLAogICAgImUiOiBwYXJzZURheU9mTW9udGgsCiAgICAiZiI6IHBhcnNlTWljcm9zZWNvbmRzLAogICAgImciOiBwYXJzZVllYXIsCiAgICAiRyI6IHBhcnNlRnVsbFllYXIsCiAgICAiSCI6IHBhcnNlSG91cjI0LAogICAgIkkiOiBwYXJzZUhvdXIyNCwKICAgICJqIjogcGFyc2VEYXlPZlllYXIsCiAgICAiTCI6IHBhcnNlTWlsbGlzZWNvbmRzLAogICAgIm0iOiBwYXJzZU1vbnRoTnVtYmVyLAogICAgIk0iOiBwYXJzZU1pbnV0ZXMsCiAgICAicCI6IHBhcnNlUGVyaW9kLAogICAgInEiOiBwYXJzZVF1YXJ0ZXIsCiAgICAiUSI6IHBhcnNlVW5peFRpbWVzdGFtcCwKICAgICJzIjogcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogcGFyc2VTZWNvbmRzLAogICAgInUiOiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IHBhcnNlV2Vla051bWJlclN1bmRheSwKICAgICJWIjogcGFyc2VXZWVrTnVtYmVySVNPLAogICAgInciOiBwYXJzZVdlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IHBhcnNlV2Vla051bWJlck1vbmRheSwKICAgICJ4IjogcGFyc2VMb2NhbGVEYXRlLAogICAgIlgiOiBwYXJzZUxvY2FsZVRpbWUsCiAgICAieSI6IHBhcnNlWWVhciwKICAgICJZIjogcGFyc2VGdWxsWWVhciwKICAgICJaIjogcGFyc2Vab25lLAogICAgIiUiOiBwYXJzZUxpdGVyYWxQZXJjZW50CiAgfTsKICBmb3JtYXRzLnggPSBuZXdGb3JtYXQobG9jYWxlX2RhdGUsIGZvcm1hdHMpOwogIGZvcm1hdHMuWCA9IG5ld0Zvcm1hdChsb2NhbGVfdGltZSwgZm9ybWF0cyk7CiAgZm9ybWF0cy5jID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlVGltZSwgZm9ybWF0cyk7CiAgdXRjRm9ybWF0cy54ID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlLCB1dGNGb3JtYXRzKTsKICB1dGNGb3JtYXRzLlggPSBuZXdGb3JtYXQobG9jYWxlX3RpbWUsIHV0Y0Zvcm1hdHMpOwogIHV0Y0Zvcm1hdHMuYyA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZVRpbWUsIHV0Y0Zvcm1hdHMpOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIsIGZvcm1hdHMyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZTIpIHsKICAgICAgdmFyIHN0cmluZyA9IFtdLCBpID0gLTEsIGogPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgYywgcGFkMiwgZm9ybWF0MjsKICAgICAgaWYgKCEoZGF0ZTIgaW5zdGFuY2VvZiBEYXRlKSkgZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKTsKICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICBpZiAoc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSkgPT09IDM3KSB7CiAgICAgICAgICBzdHJpbmcucHVzaChzcGVjaWZpZXIuc2xpY2UoaiwgaSkpOwogICAgICAgICAgaWYgKChwYWQyID0gcGFkc1tjID0gc3BlY2lmaWVyLmNoYXJBdCgrK2kpXSkgIT0gbnVsbCkgYyA9IHNwZWNpZmllci5jaGFyQXQoKytpKTsKICAgICAgICAgIGVsc2UgcGFkMiA9IGMgPT09ICJlIiA/ICIgIiA6ICIwIjsKICAgICAgICAgIGlmIChmb3JtYXQyID0gZm9ybWF0czJbY10pIGMgPSBmb3JtYXQyKGRhdGUyLCBwYWQyKTsKICAgICAgICAgIHN0cmluZy5wdXNoKGMpOwogICAgICAgICAgaiA9IGkgKyAxOwogICAgICAgIH0KICAgICAgfQogICAgICBzdHJpbmcucHVzaChzcGVjaWZpZXIuc2xpY2UoaiwgaSkpOwogICAgICByZXR1cm4gc3RyaW5nLmpvaW4oIiIpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gbmV3UGFyc2Uoc3BlY2lmaWVyLCBaKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIHZhciBkID0gbmV3RGF0ZSgxOTAwLCB2b2lkIDAsIDEpLCBpID0gcGFyc2VTcGVjaWZpZXIoZCwgc3BlY2lmaWVyLCBzdHJpbmcgKz0gIiIsIDApLCB3ZWVrLCBkYXk7CiAgICAgIGlmIChpICE9IHN0cmluZy5sZW5ndGgpIHJldHVybiBudWxsOwogICAgICBpZiAoIlEiIGluIGQpIHJldHVybiBuZXcgRGF0ZShkLlEpOwogICAgICBpZiAoInMiIGluIGQpIHJldHVybiBuZXcgRGF0ZShkLnMgKiAxZTMgKyAoIkwiIGluIGQgPyBkLkwgOiAwKSk7CiAgICAgIGlmIChaICYmICEoIloiIGluIGQpKSBkLlogPSAwOwogICAgICBpZiAoInAiIGluIGQpIGQuSCA9IGQuSCAlIDEyICsgZC5wICogMTI7CiAgICAgIGlmIChkLm0gPT09IHZvaWQgMCkgZC5tID0gInEiIGluIGQgPyBkLnEgOiAwOwogICAgICBpZiAoIlYiIGluIGQpIHsKICAgICAgICBpZiAoZC5WIDwgMSB8fCBkLlYgPiA1MykgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCEoInciIGluIGQpKSBkLncgPSAxOwogICAgICAgIGlmICgiWiIgaW4gZCkgewogICAgICAgICAgd2VlayA9IHV0Y0RhdGUobmV3RGF0ZShkLnksIDAsIDEpKSwgZGF5ID0gd2Vlay5nZXRVVENEYXkoKTsKICAgICAgICAgIHdlZWsgPSBkYXkgPiA0IHx8IGRheSA9PT0gMCA/IHV0Y01vbmRheS5jZWlsKHdlZWspIDogdXRjTW9uZGF5KHdlZWspOwogICAgICAgICAgd2VlayA9IHV0Y0RheS5vZmZzZXQod2VlaywgKGQuViAtIDEpICogNyk7CiAgICAgICAgICBkLnkgPSB3ZWVrLmdldFVUQ0Z1bGxZZWFyKCk7CiAgICAgICAgICBkLm0gPSB3ZWVrLmdldFVUQ01vbnRoKCk7CiAgICAgICAgICBkLmQgPSB3ZWVrLmdldFVUQ0RhdGUoKSArIChkLncgKyA2KSAlIDc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdlZWsgPSBsb2NhbERhdGUobmV3RGF0ZShkLnksIDAsIDEpKSwgZGF5ID0gd2Vlay5nZXREYXkoKTsKICAgICAgICAgIHdlZWsgPSBkYXkgPiA0IHx8IGRheSA9PT0gMCA/IHRpbWVNb25kYXkuY2VpbCh3ZWVrKSA6IHRpbWVNb25kYXkod2Vlayk7CiAgICAgICAgICB3ZWVrID0gdGltZURheS5vZmZzZXQod2VlaywgKGQuViAtIDEpICogNyk7CiAgICAgICAgICBkLnkgPSB3ZWVrLmdldEZ1bGxZZWFyKCk7CiAgICAgICAgICBkLm0gPSB3ZWVrLmdldE1vbnRoKCk7CiAgICAgICAgICBkLmQgPSB3ZWVrLmdldERhdGUoKSArIChkLncgKyA2KSAlIDc7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCJXIiBpbiBkIHx8ICJVIiBpbiBkKSB7CiAgICAgICAgaWYgKCEoInciIGluIGQpKSBkLncgPSAidSIgaW4gZCA/IGQudSAlIDcgOiAiVyIgaW4gZCA/IDEgOiAwOwogICAgICAgIGRheSA9ICJaIiBpbiBkID8gdXRjRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLmdldFVUQ0RheSgpIDogbG9jYWxEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSkuZ2V0RGF5KCk7CiAgICAgICAgZC5tID0gMDsKICAgICAgICBkLmQgPSAiVyIgaW4gZCA/IChkLncgKyA2KSAlIDcgKyBkLlcgKiA3IC0gKGRheSArIDUpICUgNyA6IGQudyArIGQuVSAqIDcgLSAoZGF5ICsgNikgJSA3OwogICAgICB9CiAgICAgIGlmICgiWiIgaW4gZCkgewogICAgICAgIGQuSCArPSBkLlogLyAxMDAgfCAwOwogICAgICAgIGQuTSArPSBkLlogJSAxMDA7CiAgICAgICAgcmV0dXJuIHV0Y0RhdGUoZCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxvY2FsRGF0ZShkKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlU3BlY2lmaWVyKGQsIHNwZWNpZmllciwgc3RyaW5nLCBqKSB7CiAgICB2YXIgaSA9IDAsIG4gPSBzcGVjaWZpZXIubGVuZ3RoLCBtID0gc3RyaW5nLmxlbmd0aCwgYywgcGFyc2U7CiAgICB3aGlsZSAoaSA8IG4pIHsKICAgICAgaWYgKGogPj0gbSkgcmV0dXJuIC0xOwogICAgICBjID0gc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSsrKTsKICAgICAgaWYgKGMgPT09IDM3KSB7CiAgICAgICAgYyA9IHNwZWNpZmllci5jaGFyQXQoaSsrKTsKICAgICAgICBwYXJzZSA9IHBhcnNlc1tjIGluIHBhZHMgPyBzcGVjaWZpZXIuY2hhckF0KGkrKykgOiBjXTsKICAgICAgICBpZiAoIXBhcnNlIHx8IChqID0gcGFyc2UoZCwgc3RyaW5nLCBqKSkgPCAwKSByZXR1cm4gLTE7CiAgICAgIH0gZWxzZSBpZiAoYyAhPSBzdHJpbmcuY2hhckNvZGVBdChqKyspKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gajsKICB9CiAgZnVuY3Rpb24gcGFyc2VQZXJpb2QoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHBlcmlvZFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQucCA9IHBlcmlvZExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVNob3J0V2Vla2RheShkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gc2hvcnRXZWVrZGF5UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC53ID0gc2hvcnRXZWVrZGF5TG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlV2Vla2RheShkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gd2Vla2RheVJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQudyA9IHdlZWtkYXlMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTaG9ydE1vbnRoKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBzaG9ydE1vbnRoUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5tID0gc2hvcnRNb250aExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZU1vbnRoKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBtb250aFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQubSA9IG1vbnRoTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlRGF0ZVRpbWUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX2RhdGVUaW1lLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZURhdGUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX2RhdGUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlVGltZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfdGltZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0U2hvcnRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRXZWVrZGF5c1tkLmdldERheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3dlZWtkYXlzW2QuZ2V0RGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRTaG9ydE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRNb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9tb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UGVyaW9kKGQpIHsKICAgIHJldHVybiBsb2NhbGVfcGVyaW9kc1srKGQuZ2V0SG91cnMoKSA+PSAxMildOwogIH0KICBmdW5jdGlvbiBmb3JtYXRRdWFydGVyKGQpIHsKICAgIHJldHVybiAxICsgfn4oZC5nZXRNb250aCgpIC8gMyk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1Nob3J0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0V2Vla2RheXNbZC5nZXRVVENEYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV93ZWVrZGF5c1tkLmdldFVUQ0RheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDU2hvcnRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0TW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfbW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1BlcmlvZChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3BlcmlvZHNbKyhkLmdldFVUQ0hvdXJzKCkgPj0gMTIpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDUXVhcnRlcihkKSB7CiAgICByZXR1cm4gMSArIH5+KGQuZ2V0VVRDTW9udGgoKSAvIDMpOwogIH0KICByZXR1cm4gewogICAgZm9ybWF0OiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIGYgPSBuZXdGb3JtYXQoc3BlY2lmaWVyICs9ICIiLCBmb3JtYXRzKTsKICAgICAgZi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIHAgPSBuZXdQYXJzZShzcGVjaWZpZXIgKz0gIiIsIGZhbHNlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfSwKICAgIHV0Y0Zvcm1hdDogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBmID0gbmV3Rm9ybWF0KHNwZWNpZmllciArPSAiIiwgdXRjRm9ybWF0cyk7CiAgICAgIGYudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gZjsKICAgIH0sCiAgICB1dGNQYXJzZTogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBwID0gbmV3UGFyc2Uoc3BlY2lmaWVyICs9ICIiLCB0cnVlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfQogIH07Cn0KdmFyIHBhZHMgPSB7ICItIjogIiIsICJfIjogIiAiLCAiMCI6ICIwIiB9Owp2YXIgbnVtYmVyUmUgPSAvXlxzKlxkKy87CnZhciBwZXJjZW50UmUgPSAvXiUvOwp2YXIgcmVxdW90ZVJlID0gL1tcXF4kKis/fFtcXSgpLnt9XS9nOwpmdW5jdGlvbiBwYWQodmFsdWUsIGZpbGwsIHdpZHRoKSB7CiAgdmFyIHNpZ24yID0gdmFsdWUgPCAwID8gIi0iIDogIiIsIHN0cmluZyA9IChzaWduMiA/IC12YWx1ZSA6IHZhbHVlKSArICIiLCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoOwogIHJldHVybiBzaWduMiArIChsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgKyBzdHJpbmcgOiBzdHJpbmcpOwp9CmZ1bmN0aW9uIHJlcXVvdGUocykgewogIHJldHVybiBzLnJlcGxhY2UocmVxdW90ZVJlLCAiXFwkJiIpOwp9CmZ1bmN0aW9uIGZvcm1hdFJlKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBSZWdFeHAoIl4oPzoiICsgbmFtZXMubWFwKHJlcXVvdGUpLmpvaW4oInwiKSArICIpIiwgImkiKTsKfQpmdW5jdGlvbiBmb3JtYXRMb29rdXAobmFtZXMpIHsKICByZXR1cm4gbmV3IE1hcChuYW1lcy5tYXAoKG5hbWUsIGkpID0+IFtuYW1lLnRvTG93ZXJDYXNlKCksIGldKSk7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrZGF5TnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLncgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC51ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJTdW5kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVySVNPKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlYgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5XID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUZ1bGxZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDQpKTsKICByZXR1cm4gbiA/IChkLnkgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0gKyAoK25bMF0gPiA2OCA/IDE5MDAgOiAyZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2Vab25lKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gL14oWil8KFsrLV1cZFxkKSg/Ojo/KFxkXGQpKT8vLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA2KSk7CiAgcmV0dXJuIG4gPyAoZC5aID0gblsxXSA/IDAgOiAtKG5bMl0gKyAoblszXSB8fCAiMDAiKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVF1YXJ0ZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQucSA9IG5bMF0gKiAzIC0gMywgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTW9udGhOdW1iZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQubSA9IG5bMF0gLSAxLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VEYXlPZk1vbnRoKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLm0gPSAwLCBkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlSG91cjI0KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLkggPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWludXRlcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5NID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuUyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWxsaXNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMykpOwogIHJldHVybiBuID8gKGQuTCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWNyb3NlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuTCA9IE1hdGguZmxvb3IoblswXSAvIDFlMyksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUxpdGVyYWxQZXJjZW50KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gcGVyY2VudFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyBpICsgblswXS5sZW5ndGggOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXAoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgcmV0dXJuIG4gPyAoZC5RID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXBTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQucyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldERhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXREYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHRpbWVEYXkuY291bnQodGltZVllYXIoZCksIGQpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRNaWxsaXNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaWxsaXNlY29uZHMoKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWljcm9zZWNvbmRzKGQsIHApIHsKICByZXR1cm4gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApICsgIjAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TW9udGhOdW1iZXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNb250aCgpICsgMSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0TWludXRlcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldE1pbnV0ZXMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0U2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFNlY29uZHMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlck1vbmRheShkKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgcmV0dXJuIGRheSA9PT0gMCA/IDcgOiBkYXk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlclN1bmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lU3VuZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGRJU08oZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB0aW1lVGh1cnNkYXkoZCkgOiB0aW1lVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKHRpbWVUaHVyc2RheS5jb3VudCh0aW1lWWVhcihkKSwgZCkgKyAodGltZVllYXIoZCkuZ2V0RGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXREYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHRpbWVNb25kYXkuY291bnQodGltZVllYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0WWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXJJU08oZCwgcCkgewogIGQgPSBkSVNPKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdEZ1bGxZZWFySVNPKGQsIHApIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICBkID0gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFpvbmUoZCkgewogIHZhciB6ID0gZC5nZXRUaW1lem9uZU9mZnNldCgpOwogIHJldHVybiAoeiA+IDAgPyAiLSIgOiAoeiAqPSAtMSwgIisiKSkgKyBwYWQoeiAvIDYwIHwgMCwgIjAiLCAyKSArIHBhZCh6ICUgNjAsICIwIiwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0RhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENEYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHV0Y0RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1NlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkb3cgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkb3cgPT09IDAgPyA3IDogZG93Owp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodXRjU3VuZGF5LmNvdW50KHV0Y1llYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gVVRDZElTTyhkKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgcmV0dXJuIGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKHV0Y1RodXJzZGF5LmNvdW50KHV0Y1llYXIoZCksIGQpICsgKHV0Y1llYXIoZCkuZ2V0VVRDRGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXRVVENEYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y01vbmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1llYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRVVENGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWm9uZSgpIHsKICByZXR1cm4gIiswMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRMaXRlcmFsUGVyY2VudCgpIHsKICByZXR1cm4gIiUiOwp9CmZ1bmN0aW9uIGZvcm1hdFVuaXhUaW1lc3RhbXAoZCkgewogIHJldHVybiArZDsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcyhkKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoK2QgLyAxZTMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZS1mb3JtYXRANC4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9kZWZhdWx0TG9jYWxlLmpzCnZhciBsb2NhbGUyOwp2YXIgdGltZUZvcm1hdDsKdmFyIHRpbWVQYXJzZTsKdmFyIHV0Y0Zvcm1hdDsKdmFyIHV0Y1BhcnNlOwpkZWZhdWx0TG9jYWxlMih7CiAgZGF0ZVRpbWU6ICIleCwgJVgiLAogIGRhdGU6ICIlLW0vJS1kLyVZIiwKICB0aW1lOiAiJS1JOiVNOiVTICVwIiwKICBwZXJpb2RzOiBbIkFNIiwgIlBNIl0sCiAgZGF5czogWyJTdW5kYXkiLCAiTW9uZGF5IiwgIlR1ZXNkYXkiLCAiV2VkbmVzZGF5IiwgIlRodXJzZGF5IiwgIkZyaWRheSIsICJTYXR1cmRheSJdLAogIHNob3J0RGF5czogWyJTdW4iLCAiTW9uIiwgIlR1ZSIsICJXZWQiLCAiVGh1IiwgIkZyaSIsICJTYXQiXSwKICBtb250aHM6IFsiSmFudWFyeSIsICJGZWJydWFyeSIsICJNYXJjaCIsICJBcHJpbCIsICJNYXkiLCAiSnVuZSIsICJKdWx5IiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2N0b2JlciIsICJOb3ZlbWJlciIsICJEZWNlbWJlciJdLAogIHNob3J0TW9udGhzOiBbIkphbiIsICJGZWIiLCAiTWFyIiwgIkFwciIsICJNYXkiLCAiSnVuIiwgIkp1bCIsICJBdWciLCAiU2VwIiwgIk9jdCIsICJOb3YiLCAiRGVjIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUyKGRlZmluaXRpb24pIHsKICBsb2NhbGUyID0gZm9ybWF0TG9jYWxlKGRlZmluaXRpb24pOwogIHRpbWVGb3JtYXQgPSBsb2NhbGUyLmZvcm1hdDsKICB0aW1lUGFyc2UgPSBsb2NhbGUyLnBhcnNlOwogIHV0Y0Zvcm1hdCA9IGxvY2FsZTIudXRjRm9ybWF0OwogIHV0Y1BhcnNlID0gbG9jYWxlMi51dGNQYXJzZTsKICByZXR1cm4gbG9jYWxlMjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGltZS5qcwpmdW5jdGlvbiBkYXRlKHQpIHsKICByZXR1cm4gbmV3IERhdGUodCk7Cn0KZnVuY3Rpb24gbnVtYmVyMyh0KSB7CiAgcmV0dXJuIHQgaW5zdGFuY2VvZiBEYXRlID8gK3QgOiArLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCt0KTsKfQpmdW5jdGlvbiBjYWxlbmRhcih0aWNrczIsIHRpY2tJbnRlcnZhbCwgeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQyLCBmb3JtYXQyKSB7CiAgdmFyIHNjYWxlID0gY29udGludW91cygpLCBpbnZlcnQgPSBzY2FsZS5pbnZlcnQsIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICB2YXIgZm9ybWF0TWlsbGlzZWNvbmQgPSBmb3JtYXQyKCIuJUwiKSwgZm9ybWF0U2Vjb25kID0gZm9ybWF0MigiOiVTIiksIGZvcm1hdE1pbnV0ZSA9IGZvcm1hdDIoIiVJOiVNIiksIGZvcm1hdEhvdXIgPSBmb3JtYXQyKCIlSSAlcCIpLCBmb3JtYXREYXkgPSBmb3JtYXQyKCIlYSAlZCIpLCBmb3JtYXRXZWVrID0gZm9ybWF0MigiJWIgJWQiKSwgZm9ybWF0TW9udGggPSBmb3JtYXQyKCIlQiIpLCBmb3JtYXRZZWFyMiA9IGZvcm1hdDIoIiVZIik7CiAgZnVuY3Rpb24gdGlja0Zvcm1hdDIoZGF0ZTIpIHsKICAgIHJldHVybiAoc2Vjb25kMihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1pbGxpc2Vjb25kIDogbWludXRlKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0U2Vjb25kIDogaG91cihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1pbnV0ZSA6IGRheShkYXRlMikgPCBkYXRlMiA/IGZvcm1hdEhvdXIgOiBtb250aChkYXRlMikgPCBkYXRlMiA/IHdlZWsoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXREYXkgOiBmb3JtYXRXZWVrIDogeWVhcihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1vbnRoIDogZm9ybWF0WWVhcjIpKGRhdGUyKTsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gZnVuY3Rpb24oeTIpIHsKICAgIHJldHVybiBuZXcgRGF0ZShpbnZlcnQoeTIpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gZG9tYWluKEFycmF5LmZyb20oXywgbnVtYmVyMykpIDogZG9tYWluKCkubWFwKGRhdGUpOwogIH07CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihpbnRlcnZhbCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrczIoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBpbnRlcnZhbCA9PSBudWxsID8gMTAgOiBpbnRlcnZhbCk7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gZnVuY3Rpb24oY291bnQsIHNwZWNpZmllcikgewogICAgcmV0dXJuIHNwZWNpZmllciA9PSBudWxsID8gdGlja0Zvcm1hdDIgOiBmb3JtYXQyKHNwZWNpZmllcik7CiAgfTsKICBzY2FsZS5uaWNlID0gZnVuY3Rpb24oaW50ZXJ2YWwpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICBpZiAoIWludGVydmFsIHx8IHR5cGVvZiBpbnRlcnZhbC5yYW5nZSAhPT0gImZ1bmN0aW9uIikgaW50ZXJ2YWwgPSB0aWNrSW50ZXJ2YWwoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBpbnRlcnZhbCA9PSBudWxsID8gMTAgOiBpbnRlcnZhbCk7CiAgICByZXR1cm4gaW50ZXJ2YWwgPyBkb21haW4obmljZShkLCBpbnRlcnZhbCkpIDogc2NhbGU7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHRpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih0aW1lVGlja3MsIHRpbWVUaWNrSW50ZXJ2YWwsIHRpbWVZZWFyLCB0aW1lTW9udGgsIHRpbWVTdW5kYXksIHRpbWVEYXksIHRpbWVIb3VyLCB0aW1lTWludXRlLCBzZWNvbmQsIHRpbWVGb3JtYXQpLmRvbWFpbihbbmV3IERhdGUoMmUzLCAwLCAxKSwgbmV3IERhdGUoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy91dGNUaW1lLmpzCmZ1bmN0aW9uIHV0Y1RpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih1dGNUaWNrcywgdXRjVGlja0ludGVydmFsLCB1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1dGNEYXksIHV0Y0hvdXIsIHV0Y01pbnV0ZSwgc2Vjb25kLCB1dGNGb3JtYXQpLmRvbWFpbihbRGF0ZS5VVEMoMmUzLCAwLCAxKSwgRGF0ZS5VVEMoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zZXF1ZW50aWFsLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMigpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDEsIHQwMiwgdDEyLCBrMTAsIHRyYW5zZm9ybSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHksIGNsYW1wID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiBpbnRlcnBvbGF0b3IoazEwID09PSAwID8gMC41IDogKHgyID0gKHRyYW5zZm9ybSh4MikgLSB0MDIpICogazEwLCBjbGFtcCA/IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHgyKSkgOiB4MikpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKSwgc2NhbGUpIDogW3gwLCB4MV07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjE7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjFdID0gXywgaW50ZXJwb2xhdG9yID0gaW50ZXJwb2xhdGUyKHIwLCByMSksIHNjYWxlKSA6IFtpbnRlcnBvbGF0b3IoMCksIGludGVycG9sYXRvcigxKV07CiAgICB9OwogIH0KICBzY2FsZS5yYW5nZSA9IHJhbmdlNCh2YWx1ZV9kZWZhdWx0KTsKICBzY2FsZS5yYW5nZVJvdW5kID0gcmFuZ2U0KHJvdW5kX2RlZmF1bHQpOwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB0MDIgPSB0KHgwKSwgdDEyID0gdCh4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGNvcHkyKHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5pbnRlcnBvbGF0b3Ioc291cmNlLmludGVycG9sYXRvcigpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsKCkgewogIHZhciBzY2FsZSA9IGxpbmVhcmlzaCh0cmFuc2Zvcm1lcjIoKShpZGVudGl0eSkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxMb2coKSB7CiAgdmFyIHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcjIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbExvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsU3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcjIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsU3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbFBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxTcXJ0KCkgewogIHJldHVybiBzZXF1ZW50aWFsUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc2VxdWVudGlhbFF1YW50aWxlLmpzCmZ1bmN0aW9uIHNlcXVlbnRpYWxRdWFudGlsZSgpIHsKICB2YXIgZG9tYWluID0gW10sIGludGVycG9sYXRvciA9IGlkZW50aXR5OwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICBpZiAoeDIgIT0gbnVsbCAmJiAhaXNOYU4oeDIgPSAreDIpKSByZXR1cm4gaW50ZXJwb2xhdG9yKChiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAxKSAtIDEpIC8gKGRvbWFpbi5sZW5ndGggLSAxKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogICAgZG9tYWluID0gW107CiAgICBmb3IgKGxldCBkIG9mIF8pIGlmIChkICE9IG51bGwgJiYgIWlzTmFOKGQgPSArZCkpIGRvbWFpbi5wdXNoKGQpOwogICAgZG9tYWluLnNvcnQoYXNjZW5kaW5nKTsKICAgIHJldHVybiBzY2FsZTsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZG9tYWluLm1hcCgoZCwgaSkgPT4gaW50ZXJwb2xhdG9yKGkgLyAoZG9tYWluLmxlbmd0aCAtIDEpKSk7CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbihuKSB7CiAgICByZXR1cm4gQXJyYXkuZnJvbSh7IGxlbmd0aDogbiArIDEgfSwgKF8sIGkpID0+IHF1YW50aWxlKGRvbWFpbiwgaSAvIG4pKTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZXF1ZW50aWFsUXVhbnRpbGUoaW50ZXJwb2xhdG9yKS5kb21haW4oZG9tYWluKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9kaXZlcmdpbmcuanMKZnVuY3Rpb24gdHJhbnNmb3JtZXIzKCkgewogIHZhciB4MCA9IDAsIHgxID0gMC41LCB4MiA9IDEsIHMgPSAxLCB0MDIsIHQxMiwgdDIsIGsxMCwgazIxLCBpbnRlcnBvbGF0b3IgPSBpZGVudGl0eSwgdHJhbnNmb3JtLCBjbGFtcCA9IGZhbHNlLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgzKSB7CiAgICByZXR1cm4gaXNOYU4oeDMgPSAreDMpID8gdW5rbm93biA6ICh4MyA9IDAuNSArICgoeDMgPSArdHJhbnNmb3JtKHgzKSkgLSB0MTIpICogKHMgKiB4MyA8IHMgKiB0MTIgPyBrMTAgOiBrMjEpLCBpbnRlcnBvbGF0b3IoY2xhbXAgPyBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4MykpIDogeDMpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MSwgeDJdID0gXywgdDAyID0gdHJhbnNmb3JtKHgwID0gK3gwKSwgdDEyID0gdHJhbnNmb3JtKHgxID0gK3gxKSwgdDIgPSB0cmFuc2Zvcm0oeDIgPSAreDIpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAwLjUgLyAodDEyIC0gdDAyKSwgazIxID0gdDEyID09PSB0MiA/IDAgOiAwLjUgLyAodDIgLSB0MTIpLCBzID0gdDEyIDwgdDAyID8gLTEgOiAxLCBzY2FsZSkgOiBbeDAsIHgxLCB4Ml07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjEsIHIyOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxLCByMl0gPSBfLCBpbnRlcnBvbGF0b3IgPSBwaWVjZXdpc2UoaW50ZXJwb2xhdGUyLCBbcjAsIHIxLCByMl0pLCBzY2FsZSkgOiBbaW50ZXJwb2xhdG9yKDApLCBpbnRlcnBvbGF0b3IoMC41KSwgaW50ZXJwb2xhdG9yKDEpXTsKICAgIH07CiAgfQogIHNjYWxlLnJhbmdlID0gcmFuZ2U0KHZhbHVlX2RlZmF1bHQpOwogIHNjYWxlLnJhbmdlUm91bmQgPSByYW5nZTQocm91bmRfZGVmYXVsdCk7CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHQwMiA9IHQoeDApLCB0MTIgPSB0KHgxKSwgdDIgPSB0KHgyKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMC41IC8gKHQxMiAtIHQwMiksIGsyMSA9IHQxMiA9PT0gdDIgPyAwIDogMC41IC8gKHQyIC0gdDEyKSwgcyA9IHQxMiA8IHQwMiA/IC0xIDogMTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGRpdmVyZ2luZygpIHsKICB2YXIgc2NhbGUgPSBsaW5lYXJpc2godHJhbnNmb3JtZXIzKCkoaWRlbnRpdHkpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZygpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ0xvZygpIHsKICB2YXIgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyMygpKS5kb21haW4oWzAuMSwgMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ0xvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdTeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyMygpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ1N5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1BvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIzKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nUG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nU3FydCgpIHsKICByZXR1cm4gZGl2ZXJnaW5nUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2RhdGFTZWxlY3RvcnMuanMKdmFyIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzID0gKHN0YXRlKSA9PiBzdGF0ZS5jaGFydERhdGE7CnZhciBzZWxlY3RDaGFydERhdGFBbmRBbHdheXNJZ25vcmVJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzXSwgKGRhdGFTdGF0ZSkgPT4gewogIHZhciBkYXRhRW5kSW5kZXggPSBkYXRhU3RhdGUuY2hhcnREYXRhICE9IG51bGwgPyBkYXRhU3RhdGUuY2hhcnREYXRhLmxlbmd0aCAtIDEgOiAwOwogIHJldHVybiB7CiAgICBjaGFydERhdGE6IGRhdGFTdGF0ZS5jaGFydERhdGEsCiAgICBjb21wdXRlZERhdGE6IGRhdGFTdGF0ZS5jb21wdXRlZERhdGEsCiAgICBkYXRhRW5kSW5kZXgsCiAgICBkYXRhU3RhcnRJbmRleDogMAogIH07Cn0pOwp2YXIgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEgPSAoc3RhdGUsIF91bnVzZWQxLCBfdW51c2VkMiwgaXNQYW5vcmFtYSkgPT4gewogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gc2VsZWN0Q2hhcnREYXRhQW5kQWx3YXlzSWdub3JlSW5kZXhlcyhzdGF0ZSk7CiAgfQogIHJldHVybiBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcyhzdGF0ZSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2lzRG9tYWluU3BlY2lmaWVkQnlVc2VyLmpzCmZ1bmN0aW9uIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbih2KSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodikgJiYgdi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbbWluMiwgbWF4Ml0gPSB2OwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobWluMikgJiYgaXNXZWxsQmVoYXZlZE51bWJlcihtYXgyKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV4dGVuZERvbWFpbihwcm92aWRlZERvbWFpbiwgYm91bmRhcnlEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKGFsbG93RGF0YU92ZXJmbG93KSB7CiAgICByZXR1cm4gcHJvdmlkZWREb21haW47CiAgfQogIHJldHVybiBbTWF0aC5taW4ocHJvdmlkZWREb21haW5bMF0sIGJvdW5kYXJ5RG9tYWluWzBdKSwgTWF0aC5tYXgocHJvdmlkZWREb21haW5bMV0sIGJvdW5kYXJ5RG9tYWluWzFdKV07Cn0KZnVuY3Rpb24gbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEodXNlckRvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoIWFsbG93RGF0YU92ZXJmbG93KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIHVzZXJEb21haW4gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHVzZXJEb21haW4pICYmIHVzZXJEb21haW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW3Byb3ZpZGVkTWluLCBwcm92aWRlZE1heF0gPSB1c2VyRG9tYWluOwogICAgdmFyIGZpbmFsTWluLCBmaW5hbE1heDsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKHByb3ZpZGVkTWluKSkgewogICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKHByb3ZpZGVkTWF4KSkgewogICAgICBmaW5hbE1heCA9IHByb3ZpZGVkTWF4OwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHZhciBjYW5kaWRhdGUgPSBbZmluYWxNaW4sIGZpbmFsTWF4XTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oY2FuZGlkYXRlKSkgewogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIHBhcnNlTnVtZXJpY2FsVXNlckRvbWFpbih1c2VyRG9tYWluLCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmICghYWxsb3dEYXRhT3ZlcmZsb3cgJiYgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIHVzZXJEb21haW4gPT09ICJmdW5jdGlvbiIgJiYgZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICB0cnkgewogICAgICB2YXIgcmVzdWx0ID0gdXNlckRvbWFpbihkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4ocmVzdWx0KSkgewogICAgICAgIHJldHVybiBleHRlbmREb21haW4ocmVzdWx0LCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIH0KICB9CiAgaWYgKEFycmF5LmlzQXJyYXkodXNlckRvbWFpbikgJiYgdXNlckRvbWFpbi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbcHJvdmlkZWRNaW4sIHByb3ZpZGVkTWF4XSA9IHVzZXJEb21haW47CiAgICB2YXIgZmluYWxNaW4sIGZpbmFsTWF4OwogICAgaWYgKHByb3ZpZGVkTWluID09PSAiYXV0byIpIHsKICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgIGZpbmFsTWluID0gTWF0aC5taW4oLi4uZGF0YURvbWFpbik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocHJvdmlkZWRNaW4pKSB7CiAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW47CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cnkgewogICAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW4oZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzBdKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQyKSB7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAic3RyaW5nIiAmJiBNSU5fVkFMVUVfUkVHLnRlc3QocHJvdmlkZWRNaW4pKSB7CiAgICAgIHZhciBtYXRjaCA9IE1JTl9WQUxVRV9SRUcuZXhlYyhwcm92aWRlZE1pbik7CiAgICAgIGlmIChtYXRjaCA9PSBudWxsIHx8IGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgICAgIGZpbmFsTWluID0gdm9pZCAwOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB2YWx1ZSA9ICttYXRjaFsxXTsKICAgICAgICBmaW5hbE1pbiA9IGRhdGFEb21haW5bMF0gLSB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmluYWxNaW4gPSBkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMF07CiAgICB9CiAgICBpZiAocHJvdmlkZWRNYXggPT09ICJhdXRvIikgewogICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgZmluYWxNYXggPSBNYXRoLm1heCguLi5kYXRhRG9tYWluKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc051bWJlcihwcm92aWRlZE1heCkpIHsKICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heChkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMV0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZDMpIHsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJzdHJpbmciICYmIE1BWF9WQUxVRV9SRUcudGVzdChwcm92aWRlZE1heCkpIHsKICAgICAgdmFyIF9tYXRjaCA9IE1BWF9WQUxVRV9SRUcuZXhlYyhwcm92aWRlZE1heCk7CiAgICAgIGlmIChfbWF0Y2ggPT0gbnVsbCB8fCBkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICBmaW5hbE1heCA9IHZvaWQgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX3ZhbHVlID0gK19tYXRjaFsxXTsKICAgICAgICBmaW5hbE1heCA9IGRhdGFEb21haW5bMV0gKyBfdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsTWF4ID0gZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzFdOwogICAgfQogICAgdmFyIGNhbmRpZGF0ZSA9IFtmaW5hbE1pbiwgZmluYWxNYXhdOwogICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihjYW5kaWRhdGUpKSB7CiAgICAgIGlmIChkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgICB9CiAgICAgIHJldHVybiBleHRlbmREb21haW4oY2FuZGlkYXRlLCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvZ2V0TmljZVRpY2tWYWx1ZXMuanMKdmFyIGltcG9ydF9kZWNpbWFsMiA9IF9fdG9FU00ocmVxdWlyZV9kZWNpbWFsKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS91dGlsL3V0aWxzLmpzCnZhciBpZGVudGl0eTMgPSAoaSkgPT4gaTsKdmFyIFBMQUNFX0hPTERFUiA9IHsKICAiQEBmdW5jdGlvbmFsL3BsYWNlaG9sZGVyIjogdHJ1ZQp9Owp2YXIgaXNQbGFjZUhvbGRlciA9ICh2YWwpID0+IHZhbCA9PT0gUExBQ0VfSE9MREVSOwp2YXIgY3VycnkwID0gKGZuKSA9PiBmdW5jdGlvbiBfY3VycmllZCgpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIGlzUGxhY2VIb2xkZXIoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdm9pZCAwIDogYXJndW1lbnRzWzBdKSkgewogICAgcmV0dXJuIF9jdXJyaWVkOwogIH0KICByZXR1cm4gZm4oLi4uYXJndW1lbnRzKTsKfTsKdmFyIGN1cnJ5TiA9IChuLCBmbikgPT4gewogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gZm47CiAgfQogIHJldHVybiBjdXJyeTAoZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgIH0KICAgIHZhciBhcmdzTGVuZ3RoID0gYXJncy5maWx0ZXIoKGFyZykgPT4gYXJnICE9PSBQTEFDRV9IT0xERVIpLmxlbmd0aDsKICAgIGlmIChhcmdzTGVuZ3RoID49IG4pIHsKICAgICAgcmV0dXJuIGZuKC4uLmFyZ3MpOwogICAgfQogICAgcmV0dXJuIGN1cnJ5TihuIC0gYXJnc0xlbmd0aCwgY3VycnkwKGZ1bmN0aW9uKCkgewogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIHJlc3RBcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgcmVzdEFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQogICAgICB2YXIgbmV3QXJncyA9IGFyZ3MubWFwKChhcmcpID0+IGlzUGxhY2VIb2xkZXIoYXJnKSA/IHJlc3RBcmdzLnNoaWZ0KCkgOiBhcmcpOwogICAgICByZXR1cm4gZm4oLi4ubmV3QXJncywgLi4ucmVzdEFyZ3MpOwogICAgfSkpOwogIH0pOwp9Owp2YXIgY3VycnkgPSAoZm4pID0+IGN1cnJ5Tihmbi5sZW5ndGgsIGZuKTsKdmFyIHJhbmdlMiA9IChiZWdpbiwgZW5kKSA9PiB7CiAgdmFyIGFyciA9IFtdOwogIGZvciAodmFyIGkgPSBiZWdpbjsgaSA8IGVuZDsgKytpKSB7CiAgICBhcnJbaSAtIGJlZ2luXSA9IGk7CiAgfQogIHJldHVybiBhcnI7Cn07CnZhciBtYXAyID0gY3VycnkoKGZuLCBhcnIpID0+IHsKICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyLm1hcChmbik7CiAgfQogIHJldHVybiBPYmplY3Qua2V5cyhhcnIpLm1hcCgoa2V5KSA9PiBhcnJba2V5XSkubWFwKGZuKTsKfSk7CnZhciBjb21wb3NlMiA9IGZ1bmN0aW9uIGNvbXBvc2UzKCkgewogIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgYXJnc1tfa2V5M10gPSBhcmd1bWVudHNbX2tleTNdOwogIH0KICBpZiAoIWFyZ3MubGVuZ3RoKSB7CiAgICByZXR1cm4gaWRlbnRpdHkzOwogIH0KICB2YXIgZm5zID0gYXJncy5yZXZlcnNlKCk7CiAgdmFyIGZpcnN0Rm4gPSBmbnNbMF07CiAgdmFyIHRhaWxzRm4gPSBmbnMuc2xpY2UoMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRhaWxzRm4ucmVkdWNlKChyZXMsIGZuKSA9PiBmbihyZXMpLCBmaXJzdEZuKC4uLmFyZ3VtZW50cykpOwogIH07Cn07CnZhciByZXZlcnNlID0gKGFycikgPT4gewogIGlmIChBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnIucmV2ZXJzZSgpOwogIH0KICByZXR1cm4gYXJyLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIik7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL3V0aWwvYXJpdGhtZXRpYy5qcwp2YXIgaW1wb3J0X2RlY2ltYWwgPSBfX3RvRVNNKHJlcXVpcmVfZGVjaW1hbCgpKTsKZnVuY3Rpb24gZ2V0RGlnaXRDb3VudCh2YWx1ZSkgewogIHZhciByZXN1bHQ7CiAgaWYgKHZhbHVlID09PSAwKSB7CiAgICByZXN1bHQgPSAxOwogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBNYXRoLmZsb29yKG5ldyBpbXBvcnRfZGVjaW1hbC5kZWZhdWx0KHZhbHVlKS5hYnMoKS5sb2coMTApLnRvTnVtYmVyKCkpICsgMTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiByYW5nZVN0ZXAoc3RhcnQsIGVuZCwgc3RlcCkgewogIHZhciBudW0gPSBuZXcgaW1wb3J0X2RlY2ltYWwuZGVmYXVsdChzdGFydCk7CiAgdmFyIGkgPSAwOwogIHZhciByZXN1bHQgPSBbXTsKICB3aGlsZSAobnVtLmx0KGVuZCkgJiYgaSA8IDFlNSkgewogICAgcmVzdWx0LnB1c2gobnVtLnRvTnVtYmVyKCkpOwogICAgbnVtID0gbnVtLmFkZChzdGVwKTsKICAgIGkrKzsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS9nZXROaWNlVGlja1ZhbHVlcy5qcwp2YXIgZ2V0VmFsaWRJbnRlcnZhbCA9IChfcmVmMikgPT4gewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgW3ZhbGlkTWluLCB2YWxpZE1heF0gPSBbbWluMiwgbWF4Ml07CiAgaWYgKG1pbjIgPiBtYXgyKSB7CiAgICBbdmFsaWRNaW4sIHZhbGlkTWF4XSA9IFttYXgyLCBtaW4yXTsKICB9CiAgcmV0dXJuIFt2YWxpZE1pbiwgdmFsaWRNYXhdOwp9Owp2YXIgZ2V0Rm9ybWF0U3RlcCA9IChyb3VnaFN0ZXAsIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IpID0+IHsKICBpZiAocm91Z2hTdGVwLmx0ZSgwKSkgewogICAgcmV0dXJuIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKTsKICB9CiAgdmFyIGRpZ2l0Q291bnQgPSBnZXREaWdpdENvdW50KHJvdWdoU3RlcC50b051bWJlcigpKTsKICB2YXIgZGlnaXRDb3VudFZhbHVlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEwKS5wb3coZGlnaXRDb3VudCk7CiAgdmFyIHN0ZXBSYXRpbyA9IHJvdWdoU3RlcC5kaXYoZGlnaXRDb3VudFZhbHVlKTsKICB2YXIgc3RlcFJhdGlvU2NhbGUgPSBkaWdpdENvdW50ICE9PSAxID8gMC4wNSA6IDAuMTsKICB2YXIgYW1lbmRTdGVwUmF0aW8gPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKHN0ZXBSYXRpby5kaXYoc3RlcFJhdGlvU2NhbGUpLnRvTnVtYmVyKCkpKS5hZGQoY29ycmVjdGlvbkZhY3RvcikubXVsKHN0ZXBSYXRpb1NjYWxlKTsKICB2YXIgZm9ybWF0U3RlcCA9IGFtZW5kU3RlcFJhdGlvLm11bChkaWdpdENvdW50VmFsdWUpOwogIHJldHVybiBhbGxvd0RlY2ltYWxzID8gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkgOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkpOwp9Owp2YXIgZ2V0VGlja09mU2luZ2xlVmFsdWUgPSAodmFsdWUsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscykgPT4gewogIHZhciBzdGVwID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEpOwogIHZhciBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodmFsdWUpOwogIGlmICghbWlkZGxlLmlzaW50KCkgJiYgYWxsb3dEZWNpbWFscykgewogICAgdmFyIGFic1ZhbCA9IE1hdGguYWJzKHZhbHVlKTsKICAgIGlmIChhYnNWYWwgPCAxKSB7CiAgICAgIHN0ZXAgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMTApLnBvdyhnZXREaWdpdENvdW50KHZhbHVlKSAtIDEpOwogICAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcihtaWRkbGUuZGl2KHN0ZXApLnRvTnVtYmVyKCkpKS5tdWwoc3RlcCk7CiAgICB9IGVsc2UgaWYgKGFic1ZhbCA+IDEpIHsKICAgICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICAgIH0KICB9IGVsc2UgaWYgKHZhbHVlID09PSAwKSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKSk7CiAgfSBlbHNlIGlmICghYWxsb3dEZWNpbWFscykgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICB9CiAgdmFyIG1pZGRsZUluZGV4ID0gTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKTsKICB2YXIgZm4gPSBjb21wb3NlMihtYXAyKChuKSA9PiBtaWRkbGUuYWRkKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChuIC0gbWlkZGxlSW5kZXgpLm11bChzdGVwKSkudG9OdW1iZXIoKSksIHJhbmdlMik7CiAgcmV0dXJuIGZuKDAsIHRpY2tDb3VudCk7Cn07CnZhciBfY2FsY3VsYXRlU3RlcCA9IGZ1bmN0aW9uIGNhbGN1bGF0ZVN0ZXAobWluMiwgbWF4MiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKSB7CiAgdmFyIGNvcnJlY3Rpb25GYWN0b3IgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiBhcmd1bWVudHNbNF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1s0XSA6IDA7CiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUoKG1heDIgLSBtaW4yKSAvICh0aWNrQ291bnQgLSAxKSkpIHsKICAgIHJldHVybiB7CiAgICAgIHN0ZXA6IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKSwKICAgICAgdGlja01pbjogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApLAogICAgICB0aWNrTWF4OiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCkKICAgIH07CiAgfQogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWF4Mikuc3ViKG1pbjIpLmRpdih0aWNrQ291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3Rvcik7CiAgdmFyIG1pZGRsZTsKICBpZiAobWluMiA8PSAwICYmIG1heDIgPj0gMCkgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApOwogIH0gZWxzZSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWluMikuYWRkKG1heDIpLmRpdigyKTsKICAgIG1pZGRsZSA9IG1pZGRsZS5zdWIobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1pZGRsZSkubW9kKHN0ZXApKTsKICB9CiAgdmFyIGJlbG93Q291bnQgPSBNYXRoLmNlaWwobWlkZGxlLnN1YihtaW4yKS5kaXYoc3RlcCkudG9OdW1iZXIoKSk7CiAgdmFyIHVwQ291bnQgPSBNYXRoLmNlaWwobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1heDIpLnN1YihtaWRkbGUpLmRpdihzdGVwKS50b051bWJlcigpKTsKICB2YXIgc2NhbGVDb3VudCA9IGJlbG93Q291bnQgKyB1cENvdW50ICsgMTsKICBpZiAoc2NhbGVDb3VudCA+IHRpY2tDb3VudCkgewogICAgcmV0dXJuIF9jYWxjdWxhdGVTdGVwKG1pbjIsIG1heDIsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3RvciArIDEpOwogIH0KICBpZiAoc2NhbGVDb3VudCA8IHRpY2tDb3VudCkgewogICAgdXBDb3VudCA9IG1heDIgPiAwID8gdXBDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KSA6IHVwQ291bnQ7CiAgICBiZWxvd0NvdW50ID0gbWF4MiA+IDAgPyBiZWxvd0NvdW50IDogYmVsb3dDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KTsKICB9CiAgcmV0dXJuIHsKICAgIHN0ZXAsCiAgICB0aWNrTWluOiBtaWRkbGUuc3ViKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChiZWxvd0NvdW50KS5tdWwoc3RlcCkpLAogICAgdGlja01heDogbWlkZGxlLmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodXBDb3VudCkubXVsKHN0ZXApKQogIH07Cn07CnZhciBnZXROaWNlVGlja1ZhbHVlcyA9IGZ1bmN0aW9uIGdldE5pY2VUaWNrVmFsdWVzMihfcmVmMikgewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgdGlja0NvdW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiA2OwogIHZhciBhbGxvd0RlY2ltYWxzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogIHZhciBjb3VudCA9IE1hdGgubWF4KHRpY2tDb3VudCwgMik7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHZhciBfdmFsdWVzID0gY29ybWF4ID09PSBJbmZpbml0eSA/IFtjb3JtaW4sIC4uLnJhbmdlMigwLCB0aWNrQ291bnQgLSAxKS5tYXAoKCkgPT4gSW5maW5pdHkpXSA6IFsuLi5yYW5nZTIoMCwgdGlja0NvdW50IC0gMSkubWFwKCgpID0+IC1JbmZpbml0eSksIGNvcm1heF07CiAgICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKF92YWx1ZXMpIDogX3ZhbHVlczsKICB9CiAgaWYgKGNvcm1pbiA9PT0gY29ybWF4KSB7CiAgICByZXR1cm4gZ2V0VGlja09mU2luZ2xlVmFsdWUoY29ybWluLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpOwogIH0KICB2YXIgewogICAgc3RlcCwKICAgIHRpY2tNaW4sCiAgICB0aWNrTWF4CiAgfSA9IF9jYWxjdWxhdGVTdGVwKGNvcm1pbiwgY29ybWF4LCBjb3VudCwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IHJhbmdlU3RlcCh0aWNrTWluLCB0aWNrTWF4LmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMC4xKS5tdWwoc3RlcCkpLCBzdGVwKTsKICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKHZhbHVlcykgOiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4gPSBmdW5jdGlvbiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4yKF9yZWYzLCB0aWNrQ291bnQpIHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjM7CiAgdmFyIGFsbG93RGVjaW1hbHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHJldHVybiBbbWluMiwgbWF4Ml07CiAgfQogIGlmIChjb3JtaW4gPT09IGNvcm1heCkgewogICAgcmV0dXJuIFtjb3JtaW5dOwogIH0KICB2YXIgY291bnQgPSBNYXRoLm1heCh0aWNrQ291bnQsIDIpOwogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWF4KS5zdWIoY29ybWluKS5kaXYoY291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IFsuLi5yYW5nZVN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1pbiksIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtYXgpLCBzdGVwKSwgY29ybWF4XTsKICBpZiAoYWxsb3dEZWNpbWFscyA9PT0gZmFsc2UpIHsKICAgIHZhbHVlcyA9IHZhbHVlcy5tYXAoKHZhbHVlKSA9PiBNYXRoLnJvdW5kKHZhbHVlKSk7CiAgfQogIHJldHVybiBtaW4yID4gbWF4MiA/IHJldmVyc2UodmFsdWVzKSA6IHZhbHVlczsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9yb290UHJvcHNTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEJhckNhdGVnb3J5R2FwID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYmFyQ2F0ZWdvcnlHYXA7CnZhciBzZWxlY3RTdGFja09mZnNldFR5cGUgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zdGFja09mZnNldDsKdmFyIHNlbGVjdFJldmVyc2VTdGFja09yZGVyID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMucmV2ZXJzZVN0YWNrT3JkZXI7CnZhciBzZWxlY3RDaGFydE5hbWUgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuY2hhcnROYW1lOwp2YXIgc2VsZWN0U3luY0lkID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3luY0lkOwp2YXIgc2VsZWN0U3luY01ldGhvZCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN5bmNNZXRob2Q7CnZhciBzZWxlY3RFdmVudEVtaXR0ZXIgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuZXZlbnRFbWl0dGVyOwp2YXIgc2VsZWN0Q2hhcnRCYXNlVmFsdWUgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5iYXNlVmFsdWU7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvRGVmYXVsdFpJbmRleGVzLmpzCnZhciBEZWZhdWx0WkluZGV4ZXMgPSB7CiAgLyoqCiAgICogQ2FydGVzaWFuR3JpZCBhbmQgUG9sYXJHcmlkCiAgICovCiAgZ3JpZDogLTEwMCwKICAvKioKICAgKiBCYWNrZ3JvdW5kIG9mIEJhciBhbmQgUmFkaWFsQmFyLgogICAqIFRoaXMgaXMgbm90IHZpc2libGUgYnkgZGVmYXVsdCBidXQgY2FuIGJlIGVuYWJsZWQgYnkgc2V0dGluZyBiYWNrZ3JvdW5kPXt0cnVlfSBvbiBCYXIgb3IgUmFkaWFsQmFyLgogICAqLwogIGJhckJhY2tncm91bmQ6IC01MCwKICAvKgogICAqIG90aGVyIGNoYXJ0IGVsZW1lbnRzIG9yIGN1c3RvbSBlbGVtZW50cyB3aXRob3V0IHNwZWNpZmljIHpJbmRleAogICAqIHJlbmRlciBpbiBoZXJlLCBhdCB6SW5kZXggMAogICAqLwogIC8qKgogICAqIEFyZWEsIFBpZSwgUmFkYXIsIGFuZCBSZWZlcmVuY2VBcmVhCiAgICovCiAgYXJlYTogMTAwLAogIC8qKgogICAqIEN1cnNvciBpcyBlbWJlZGRlZCBpbnNpZGUgVG9vbHRpcCBhbmQgY29udHJvbGxlZCBieSBpdC4KICAgKiBUaGUgVG9vbHRpcCBpdHNlbGYgaGFzIGEgc2VwYXJhdGUgcG9ydGFsIGFuZCBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHpJbmRleCBzeXN0ZW07CiAgICogQ3Vyc29yIGlzIHRoZSBkZWNvcmF0aW9uIGluc2lkZSB0aGUgY2hhcnQgYXJlYS4gQ3Vyc29yUmVjdGFuZ2xlIGlzIGEgcmVjdGFuZ2xlIGJveC4KICAgKiBJdCByZW5kZXJzIGJlbG93IGJhciBzbyB0aGF0IGluIGEgc3RhY2tlZCBiYXIgY2hhcnQgdGhlIGN1cnNvciByZWN0YW5nbGUgZG9lcyBub3QgaGlkZSB0aGUgb3RoZXIgYmFycy4KICAgKi8KICBjdXJzb3JSZWN0YW5nbGU6IDIwMCwKICAvKioKICAgKiBCYXIgYW5kIFJhZGlhbEJhcgogICAqLwogIGJhcjogMzAwLAogIC8qKgogICAqIExpbmUgYW5kIFJlZmVyZW5jZUxpbmUsIGFuZCBFcnJvckJvcgogICAqLwogIGxpbmU6IDQwMCwKICAvKioKICAgKiBYQXhpcyBhbmQgWUF4aXMgYW5kIFBvbGFyQW5nbGVBeGlzIGFuZCBQb2xhclJhZGl1c0F4aXMgdGlja3MgYW5kIGxpbmVzIGFuZCBjaGlsZHJlbgogICAqLwogIGF4aXM6IDUwMCwKICAvKioKICAgKiBTY2F0dGVyIGFuZCBSZWZlcmVuY2VEb3QsCiAgICogYW5kIERvdHMgb2YgTGluZSBhbmQgQXJlYSBhbmQgUmFkYXIgaWYgdGhleSBoYXZlIGRvdD10cnVlCiAgICovCiAgc2NhdHRlcjogNjAwLAogIC8qKgogICAqIEhvdmVyaW5nIG92ZXIgYSBCYXIgb3IgUmFkaWFsQmFyIHJlbmRlcnMgYSBoaWdobGlnaHQgcmVjdGFuZ2xlCiAgICovCiAgYWN0aXZlQmFyOiAxZTMsCiAgLyoqCiAgICogQ3Vyc29yIGlzIGVtYmVkZGVkIGluc2lkZSBUb29sdGlwIGFuZCBjb250cm9sbGVkIGJ5IGl0LgogICAqIFRoZSBUb29sdGlwIGl0c2VsZiBoYXMgYSBzZXBhcmF0ZSBwb3J0YWwgYW5kIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgekluZGV4IHN5c3RlbTsKICAgKiBDdXJzb3IgaXMgdGhlIGRlY29yYXRpb24gaW5zaWRlIHRoZSBjaGFydCBhcmVhLCB1c3VhbGx5IGEgY3Jvc3Mgb3IgYSBib3guCiAgICogQ3Vyc29yTGluZSBpcyBhIGxpbmUgY3Vyc29yIHJlbmRlcmVkIGluIExpbmUsIEFyZWEsIFNjYXR0ZXIsIFJhZGFyIGNoYXJ0cy4KICAgKiBJdCByZW5kZXJzIGFib3ZlIHRoZSBMaW5lIGFuZCBTY2F0dGVyIHNvIHRoYXQgaXQgaXMgYWx3YXlzIHZpc2libGUuCiAgICogSXQgcmVuZGVycyBiZWxvdyBhY3RpdmUgZG90IHNvIHRoYXQgdGhlIGRvdCBpcyBhbHdheXMgdmlzaWJsZSBhbmQgc2hvd3MgdGhlIGN1cnJlbnQgcG9pbnQuCiAgICogV2UncmUgYWxzbyBhc3N1bWluZyB0aGF0IHRoZSBhY3RpdmUgZG90IGlzIHNtYWxsIGVub3VnaCB0aGF0IGl0IGRvZXMgbm90IGZ1bGx5IGNvdmVyIHRoZSBjdXJzb3IgbGluZS4KICAgKgogICAqIFRoaXMgYWxzbyBhcHBsaWVzIHRvIHRoZSByYWRpYWwgY3Vyc29yIGluIFJhZGlhbEJhckNoYXJ0LgogICAqLwogIGN1cnNvckxpbmU6IDExMDAsCiAgLyoqCiAgICogSG92ZXJpbmcgb3ZlciBhIFBvaW50IGluIExpbmUsIEFyZWEsIFNjYXR0ZXIsIFJhZGFyIHJlbmRlcnMgYSBoaWdobGlnaHQgZG90CiAgICovCiAgYWN0aXZlRG90OiAxMjAwLAogIC8qKgogICAqIExhYmVsTGlzdCBhbmQgTGFiZWwsIGluY2x1ZGluZyBBeGlzIGxhYmVscwogICAqLwogIGxhYmVsOiAyZTMKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmpzCnZhciBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcyA9IHsKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICAvLyBpZiBJIHNldCB0aGlzIHRvIGZhbHNlIHRoZW4gVG9vbHRpcCBzeW5jaHJvbmlzYXRpb24gc3RvcHMgd29ya2luZyBpbiBSYWRhciwgd3RmCiAgYW5nbGVBeGlzSWQ6IDAsCiAgYXhpc0xpbmU6IHRydWUsCiAgYXhpc0xpbmVUeXBlOiAicG9seWdvbiIsCiAgY3g6IDAsCiAgY3k6IDAsCiAgb3JpZW50YXRpb246ICJvdXRlciIsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrTGluZTogdHJ1ZSwKICB0aWNrU2l6ZTogOCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5qcwp2YXIgZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBheGlzTGluZTogdHJ1ZSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBsYWJlbDogZmFsc2UsCiAgb3JpZW50YXRpb246ICJyaWdodCIsCiAgcmFkaXVzQXhpc0lkOiAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHN0cm9rZTogIiNjY2MiLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHR5cGU6ICJudW1iZXIiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlLmpzCnZhciBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UgPSAoYXhpc1NldHRpbmdzLCBheGlzUmFuZ2UpID0+IHsKICBpZiAoIWF4aXNTZXR0aW5ncyB8fCAhYXhpc1JhbmdlKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9PSBudWxsICYmIGF4aXNTZXR0aW5ncyAhPT0gdm9pZCAwICYmIGF4aXNTZXR0aW5ncy5yZXZlcnNlZCkgewogICAgcmV0dXJuIFtheGlzUmFuZ2VbMV0sIGF4aXNSYW5nZVswXV07CiAgfQogIHJldHVybiBheGlzUmFuZ2U7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcG9sYXJBeGlzU2VsZWN0b3JzLmpzCnZhciBpbXBsaWNpdEFuZ2xlQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGZhbHNlLAogIC8vIGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5IGhhcyBpdCBzZXQgdG8gdHJ1ZSBidXQgdGhlIGFjdHVhbCBheGlzIHJlbmRlcmluZyBpZ25vcmVzIHRoZSBwcm9wIGJlY2F1c2UgcmVhc29ucywKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMucmV2ZXJzZWQsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpdXNBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5yYWRpdXNBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2tDb3VudCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpYWxCYXJBbmdsZUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAibnVtYmVyIiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaWFsQmFyUmFkaXVzQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMucmFkaXVzQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrQ291bnQsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgc2VsZWN0QW5nbGVBeGlzID0gKHN0YXRlLCBhbmdsZUF4aXNJZCkgPT4gewogIGlmIChzdGF0ZS5wb2xhckF4aXMuYW5nbGVBeGlzW2FuZ2xlQXhpc0lkXSAhPSBudWxsKSB7CiAgICByZXR1cm4gc3RhdGUucG9sYXJBeGlzLmFuZ2xlQXhpc1thbmdsZUF4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhckFuZ2xlQXhpczsKICB9CiAgcmV0dXJuIGltcGxpY2l0QW5nbGVBeGlzOwp9Owp2YXIgc2VsZWN0UmFkaXVzQXhpcyA9IChzdGF0ZSwgcmFkaXVzQXhpc0lkKSA9PiB7CiAgaWYgKHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF0gIT0gbnVsbCkgewogICAgcmV0dXJuIHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhclJhZGl1c0F4aXM7CiAgfQogIHJldHVybiBpbXBsaWNpdFJhZGl1c0F4aXM7Cn07CnZhciBzZWxlY3RQb2xhck9wdGlvbnMgPSAoc3RhdGUpID0+IHN0YXRlLnBvbGFyT3B0aW9uczsKdmFyIHNlbGVjdE1heFJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGdldE1heFJhZGl1cyk7CnZhciBzZWxlY3RJbm5lclJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdE1heFJhZGl1c10sIChwb2xhckNoYXJ0T3B0aW9ucywgbWF4UmFkaXVzKSA9PiB7CiAgaWYgKHBvbGFyQ2hhcnRPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBnZXRQZXJjZW50VmFsdWUocG9sYXJDaGFydE9wdGlvbnMuaW5uZXJSYWRpdXMsIG1heFJhZGl1cywgMCk7Cn0pOwp2YXIgc2VsZWN0T3V0ZXJSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RNYXhSYWRpdXNdLCAocG9sYXJDaGFydE9wdGlvbnMsIG1heFJhZGl1cykgPT4gewogIGlmIChwb2xhckNoYXJ0T3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKHBvbGFyQ2hhcnRPcHRpb25zLm91dGVyUmFkaXVzLCBtYXhSYWRpdXMsIG1heFJhZGl1cyAqIDAuOCk7Cn0pOwp2YXIgY29tYmluZUFuZ2xlQXhpc1JhbmdlID0gKHBvbGFyT3B0aW9ucykgPT4gewogIGlmIChwb2xhck9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIFswLCAwXTsKICB9CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIFtzdGFydEFuZ2xlLCBlbmRBbmdsZV07Cn07CnZhciBzZWxlY3RBbmdsZUF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnNdLCBjb21iaW5lQW5nbGVBeGlzUmFuZ2UpOwp2YXIgc2VsZWN0QW5nbGVBeGlzUmFuZ2VXaXRoUmV2ZXJzZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QW5nbGVBeGlzLCBzZWxlY3RBbmdsZUF4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RSYWRpdXNBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0TWF4UmFkaXVzLCBzZWxlY3RJbm5lclJhZGl1cywgc2VsZWN0T3V0ZXJSYWRpdXNdLCAobWF4UmFkaXVzLCBpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXMpID0+IHsKICBpZiAobWF4UmFkaXVzID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW2lubmVyUmFkaXVzLCBvdXRlclJhZGl1c107Cn0pOwp2YXIgc2VsZWN0UmFkaXVzQXhpc1JhbmdlV2l0aFJldmVyc2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJhZGl1c0F4aXMsIHNlbGVjdFJhZGl1c0F4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RQb2xhclZpZXdCb3ggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0SW5uZXJSYWRpdXMsIHNlbGVjdE91dGVyUmFkaXVzLCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChsYXlvdXQsIHBvbGFyT3B0aW9ucywgaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzLCB3aWR0aCwgaGVpZ2h0KSA9PiB7CiAgaWYgKGxheW91dCAhPT0gImNlbnRyaWMiICYmIGxheW91dCAhPT0gInJhZGlhbCIgfHwgcG9sYXJPcHRpb25zID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIHsKICAgIGN4OiBnZXRQZXJjZW50VmFsdWUoY3gsIHdpZHRoLCB3aWR0aCAvIDIpLAogICAgY3k6IGdldFBlcmNlbnRWYWx1ZShjeSwgaGVpZ2h0LCBoZWlnaHQgLyAyKSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbG9ja1dpc2U6IGZhbHNlCiAgICAvLyB0aGlzIHByb3BlcnR5IGxvb2sgdXNlZnVsLCB3aHkgbm90IHVzZSBpdD8KICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9waWNrQXhpc1R5cGUuanMKdmFyIHBpY2tBeGlzVHlwZSA9IChfc3RhdGUsIGF4aXNUeXBlKSA9PiBheGlzVHlwZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9waWNrQXhpc0lkLmpzCnZhciBwaWNrQXhpc0lkID0gKF9zdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IGF4aXNJZDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3RhY2tzL2dldFN0YWNrU2VyaWVzSWRlbnRpZmllci5qcwpmdW5jdGlvbiBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoZ3JhcGhpY2FsSXRlbSkgewogIHJldHVybiBncmFwaGljYWxJdGVtID09PSBudWxsIHx8IGdyYXBoaWNhbEl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdyYXBoaWNhbEl0ZW0uaWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhLmpzCmZ1bmN0aW9uIGNvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YShzdGFja2VkR3JhcGhpY2FsSXRlbXMsIF9yZWYyLCB0b29sdGlwQXhpc1NldHRpbmdzKSB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSA9IFtdCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGRhdGFLZXk6IHRvb2x0aXBEYXRhS2V5CiAgfSA9IHRvb2x0aXBBeGlzU2V0dGluZ3M7CiAgdmFyIGtub3duSXRlbXNCeURhdGFLZXkgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHN0YWNrZWRHcmFwaGljYWxJdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICB2YXIgX2l0ZW0kZGF0YTsKICAgIHZhciByZXNvbHZlZERhdGEgPSAoX2l0ZW0kZGF0YSA9IGl0ZW0uZGF0YSkgIT09IG51bGwgJiYgX2l0ZW0kZGF0YSAhPT0gdm9pZCAwID8gX2l0ZW0kZGF0YSA6IGNoYXJ0RGF0YTsKICAgIGlmIChyZXNvbHZlZERhdGEgPT0gbnVsbCB8fCByZXNvbHZlZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzdGFja0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoaXRlbSk7CiAgICByZXNvbHZlZERhdGEuZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgIHZhciB0b29sdGlwVmFsdWUgPSB0b29sdGlwRGF0YUtleSA9PSBudWxsIHx8IGFsbG93RHVwbGljYXRlZENhdGVnb3J5ID8gaW5kZXggOiBTdHJpbmcoZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIHRvb2x0aXBEYXRhS2V5LCBudWxsKSk7CiAgICAgIHZhciBudW1lcmljVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgaXRlbS5kYXRhS2V5LCAwKTsKICAgICAgdmFyIGN1cnI7CiAgICAgIGlmIChrbm93bkl0ZW1zQnlEYXRhS2V5Lmhhcyh0b29sdGlwVmFsdWUpKSB7CiAgICAgICAgY3VyciA9IGtub3duSXRlbXNCeURhdGFLZXkuZ2V0KHRvb2x0aXBWYWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VyciA9IHt9OwogICAgICB9CiAgICAgIE9iamVjdC5hc3NpZ24oY3VyciwgewogICAgICAgIFtzdGFja0lkZW50aWZpZXJdOiBudW1lcmljVmFsdWUKICAgICAgfSk7CiAgICAgIGtub3duSXRlbXNCeURhdGFLZXkuc2V0KHRvb2x0aXBWYWx1ZSwgY3Vycik7CiAgICB9KTsKICB9KTsKICByZXR1cm4gQXJyYXkuZnJvbShrbm93bkl0ZW1zQnlEYXRhS2V5LnZhbHVlcygpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdHlwZXMvU3RhY2tlZEdyYXBoaWNhbEl0ZW0uanMKZnVuY3Rpb24gaXNTdGFja2VkKGdyYXBoaWNhbEl0ZW0pIHsKICByZXR1cm4gZ3JhcGhpY2FsSXRlbS5zdGFja0lkICE9IG51bGwgJiYgZ3JhcGhpY2FsSXRlbS5kYXRhS2V5ICE9IG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9udW1iZXJEb21haW5FcXVhbGl0eUNoZWNrLmpzCnZhciBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrID0gKGEsIGIpID0+IHsKICBpZiAoYSA9PT0gYikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiBhWzBdID09PSBiWzBdICYmIGFbMV0gPT09IGJbMV07Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJyYXlFcXVhbGl0eUNoZWNrLmpzCmZ1bmN0aW9uIGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjayhhLCBiKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYSkgJiYgQXJyYXkuaXNBcnJheShiKSAmJiBhLmxlbmd0aCA9PT0gMCAmJiBiLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBhID09PSBiOwp9CmZ1bmN0aW9uIGFycmF5Q29udGVudHNBcmVFcXVhbENoZWNrKGEsIGIpIHsKICBpZiAoYS5sZW5ndGggPT09IGIubGVuZ3RoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwQXhpc1R5cGUuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSA9IChzdGF0ZSkgPT4gewogIHZhciBsYXlvdXQgPSBzZWxlY3RDaGFydExheW91dChzdGF0ZSk7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gInhBeGlzIjsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuICJ5QXhpcyI7CiAgfQogIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgcmV0dXJuICJhbmdsZUF4aXMiOwogIH0KICByZXR1cm4gInJhZGl1c0F4aXMiOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBBeGlzSWQuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzSWQgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MuYXhpc0lkOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKZnVuY3Rpb24gb3duS2V5czEzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0TnVtZXJpY0RvbWFpbiA9IFswLCAiYXV0byJdOwp2YXIgaW1wbGljaXRYQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogdHJ1ZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaGVpZ2h0OiAzMCwKICBoaWRlOiB0cnVlLAogIGlkOiAwLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIG1pblRpY2tHYXA6IDUsCiAgbWlycm9yOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgb3JpZW50YXRpb246ICJib3R0b20iLAogIHBhZGRpbmc6IHsKICAgIGxlZnQ6IDAsCiAgICByaWdodDogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogImNhdGVnb3J5IiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICByZXR1cm4gc3RhdGUuY2FydGVzaWFuQXhpcy54QXhpc1theGlzSWRdOwp9Owp2YXIgc2VsZWN0WEF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRYQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBpbXBsaWNpdFlBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiB0cnVlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IGRlZmF1bHROdW1lcmljRG9tYWluLAogIGhpZGU6IHRydWUsCiAgaWQ6IDAsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgbWluVGlja0dhcDogNSwKICBtaXJyb3I6IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICBvcmllbnRhdGlvbjogImxlZnQiLAogIHBhZGRpbmc6IHsKICAgIHRvcDogMCwKICAgIGJvdHRvbTogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogdm9pZCAwLAogIHdpZHRoOiBERUZBVUxUX1lfQVhJU19XSURUSAp9Owp2YXIgc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnlBeGlzW2F4aXNJZF07Cn07CnZhciBzZWxlY3RZQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFlBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIGltcGxpY2l0WkF4aXMgPSB7CiAgZG9tYWluOiBbMCwgImF1dG8iXSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICByZXZlcnNlZDogZmFsc2UsCiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBmYWxzZSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgaWQ6IDAsCiAgbmFtZTogIiIsCiAgcmFuZ2U6IFs2NCwgNjRdLAogIHNjYWxlOiAiYXV0byIsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogIiIKfTsKdmFyIHNlbGVjdFpBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc3RhdGUuY2FydGVzaWFuQXhpcy56QXhpc1theGlzSWRdOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFpBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIHNlbGVjdEJhc2VBeGlzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiekF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdENhcnRlc2lhbkF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBheGlzIHR5cGU6ICIuY29uY2F0KGF4aXNUeXBlKSk7CiAgfQp9Owp2YXIgc2VsZWN0QXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdEhhc0JhciA9IChzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMuY2FydGVzaWFuSXRlbXMuc29tZSgoaXRlbSkgPT4gaXRlbS50eXBlID09PSAiYmFyIikgfHwgc3RhdGUuZ3JhcGhpY2FsSXRlbXMucG9sYXJJdGVtcy5zb21lKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJyYWRpYWxCYXIiKTsKZnVuY3Rpb24gaXRlbUF4aXNQcmVkaWNhdGUoYXhpc1R5cGUsIGF4aXNJZCkgewogIHJldHVybiAoaXRlbSkgPT4gewogICAgc3dpdGNoIChheGlzVHlwZSkgewogICAgICBjYXNlICJ4QXhpcyI6CiAgICAgICAgcmV0dXJuICJ4QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueEF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ5QXhpcyI6CiAgICAgICAgcmV0dXJuICJ5QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ6QXhpcyI6CiAgICAgICAgcmV0dXJuICJ6QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0uekF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICAgIHJldHVybiAiYW5nbGVBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS5hbmdsZUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJyYWRpdXNBeGlzIjoKICAgICAgICByZXR1cm4gInJhZGl1c0F4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnJhZGl1c0F4aXNJZCA9PT0gYXhpc0lkOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9Owp9CnZhciBzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zOwp2YXIgc2VsZWN0QXhpc1ByZWRpY2F0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBpdGVtQXhpc1ByZWRpY2F0ZSk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IChncmFwaGljYWxJdGVtcywgYXhpc1NldHRpbmdzLCBheGlzUHJlZGljYXRlKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoYXhpc1ByZWRpY2F0ZSkuZmlsdGVyKChpdGVtKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuaW5jbHVkZUhpZGRlbikgPT09IHRydWUpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gIWl0ZW0uaGlkZTsKfSk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFVuZmlsdGVyZWRDYXJ0ZXNpYW5JdGVtcywgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNQcmVkaWNhdGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIChjYXJ0ZXNpYW5JdGVtcykgPT4gewogIHJldHVybiBjYXJ0ZXNpYW5JdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImFyZWEiIHx8IGl0ZW0udHlwZSA9PT0gImJhciIpLmZpbHRlcihpc1N0YWNrZWQpOwp9KTsKdmFyIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyA9IChjYXJ0ZXNpYW5JdGVtcykgPT4gY2FydGVzaWFuSXRlbXMuZmlsdGVyKChpdGVtKSA9PiAhKCJzdGFja0lkIiBpbiBpdGVtKSB8fCBpdGVtLnN0YWNrSWQgPT09IHZvaWQgMCk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgZmlsdGVyR3JhcGhpY2FsTm90U3RhY2tlZEl0ZW1zKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEgPSAoY2FydGVzaWFuSXRlbXMpID0+IGNhcnRlc2lhbkl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5kYXRhKS5maWx0ZXIoQm9vbGVhbikuZmxhdCgxKTsKdmFyIHNlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgY29tYmluZURpc3BsYXllZERhdGEgPSAoZ3JhcGhpY2FsSXRlbXNEYXRhLCBfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEgPSBbXSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYyOwogIGlmIChncmFwaGljYWxJdGVtc0RhdGEubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGdyYXBoaWNhbEl0ZW1zRGF0YTsKICB9CiAgcmV0dXJuIGNoYXJ0RGF0YS5zbGljZShkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4ICsgMSk7Cn07CnZhciBzZWxlY3REaXNwbGF5ZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWFdLCBjb21iaW5lRGlzcGxheWVkRGF0YSk7CnZhciBjb21iaW5lQXBwbGllZFZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT0gbnVsbCkgewogICAgcmV0dXJuIGRhdGEubWFwKChpdGVtKSA9PiAoewogICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbSwgYXhpc1NldHRpbmdzLmRhdGFLZXkpCiAgICB9KSk7CiAgfQogIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gaXRlbXMubWFwKChpdGVtKSA9PiBpdGVtLmRhdGFLZXkpLmZsYXRNYXAoKGRhdGFLZXkpID0+IGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KQogICAgfSkpKTsKICB9CiAgcmV0dXJuIGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgIHZhbHVlOiBlbnRyeQogIH0pKTsKfTsKdmFyIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lQXBwbGllZFZhbHVlcyk7CmZ1bmN0aW9uIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikgewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGVycm9yQmFyLmRpcmVjdGlvbiA9PT0gIngiOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gZXJyb3JCYXIuZGlyZWN0aW9uID09PSAieSI7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2U7CiAgfQp9CmZ1bmN0aW9uIG1ha2VOdW1iZXIodmFsKSB7CiAgaWYgKGlzTnVtT3JTdHIodmFsKSB8fCB2YWwgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbiA9IE51bWJlcih2YWwpOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobikpIHsKICAgICAgcmV0dXJuIG47CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFrZURvbWFpbih2YWwpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICB2YXIgYXR0ZW1wdCA9IFttYWtlTnVtYmVyKHZhbFswXSksIG1ha2VOdW1iZXIodmFsWzFdKV07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGF0dGVtcHQpKSB7CiAgICAgIHJldHVybiBhdHRlbXB0OwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG4gPSBtYWtlTnVtYmVyKHZhbCk7CiAgaWYgKG4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtuLCBuXTsKfQpmdW5jdGlvbiBvbmx5QWxsb3dOdW1iZXJzKGRhdGEpIHsKICByZXR1cm4gZGF0YS5tYXAobWFrZU51bWJlcikuZmlsdGVyKGlzTm90TmlsKTsKfQpmdW5jdGlvbiBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgYXBwbGllZFZhbHVlLCByZWxldmFudEVycm9yQmFycykgewogIGlmICghcmVsZXZhbnRFcnJvckJhcnMgfHwgdHlwZW9mIGFwcGxpZWRWYWx1ZSAhPT0gIm51bWJlciIgfHwgaXNOYW4oYXBwbGllZFZhbHVlKSkgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoIXJlbGV2YW50RXJyb3JCYXJzLmxlbmd0aCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhyZWxldmFudEVycm9yQmFycy5mbGF0TWFwKChlYikgPT4gewogICAgdmFyIGVycm9yVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZWIuZGF0YUtleSk7CiAgICB2YXIgbG93Qm91bmQsIGhpZ2hCb3VuZDsKICAgIGlmIChBcnJheS5pc0FycmF5KGVycm9yVmFsdWUpKSB7CiAgICAgIFtsb3dCb3VuZCwgaGlnaEJvdW5kXSA9IGVycm9yVmFsdWU7CiAgICB9IGVsc2UgewogICAgICBsb3dCb3VuZCA9IGhpZ2hCb3VuZCA9IGVycm9yVmFsdWU7CiAgICB9CiAgICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIobG93Qm91bmQpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGhpZ2hCb3VuZCkpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBbYXBwbGllZFZhbHVlIC0gbG93Qm91bmQsIGFwcGxpZWRWYWx1ZSArIGhpZ2hCb3VuZF07CiAgfSkpOwp9CnZhciBzZWxlY3RUb29sdGlwQXhpcyA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHJldHVybiBzZWxlY3RBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzXSwgKGF4aXMpID0+IGF4aXMgPT09IG51bGwgfHwgYXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpcy5kYXRhS2V5KTsKdmFyIHNlbGVjdERpc3BsYXllZFN0YWNrZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSwgc2VsZWN0VG9vbHRpcEF4aXNdLCBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEpOwp2YXIgY29tYmluZVN0YWNrR3JvdXBzID0gKGRpc3BsYXllZERhdGEsIGl0ZW1zLCBzdGFja09mZnNldFR5cGUsIHJldmVyc2VTdGFja09yZGVyKSA9PiB7CiAgdmFyIGluaXRpYWxJdGVtc0dyb3VwcyA9IHt9OwogIHZhciBpdGVtc0dyb3VwID0gaXRlbXMucmVkdWNlKChhY2MsIGl0ZW0pID0+IHsKICAgIGlmIChpdGVtLnN0YWNrSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gYWNjOwogICAgfQogICAgaWYgKGFjY1tpdGVtLnN0YWNrSWRdID09IG51bGwpIHsKICAgICAgYWNjW2l0ZW0uc3RhY2tJZF0gPSBbXTsKICAgIH0KICAgIGFjY1tpdGVtLnN0YWNrSWRdLnB1c2goaXRlbSk7CiAgICByZXR1cm4gYWNjOwogIH0sIGluaXRpYWxJdGVtc0dyb3Vwcyk7CiAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhpdGVtc0dyb3VwKS5tYXAoKF9yZWYyKSA9PiB7CiAgICB2YXIgW3N0YWNrSWQsIGdyYXBoaWNhbEl0ZW1zXSA9IF9yZWYyOwogICAgdmFyIG9yZGVyZWRHcmFwaGljYWxJdGVtcyA9IHJldmVyc2VTdGFja09yZGVyID8gWy4uLmdyYXBoaWNhbEl0ZW1zXS5yZXZlcnNlKCkgOiBncmFwaGljYWxJdGVtczsKICAgIHZhciBkYXRhS2V5cyA9IG9yZGVyZWRHcmFwaGljYWxJdGVtcy5tYXAoZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKTsKICAgIHJldHVybiBbc3RhY2tJZCwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFN0YWNrZWREYXRhIHJlcXVpcmVzIHRoYXQgdGhlIGlucHV0IGlzIGFycmF5IG9mIG9iamVjdHMsIFJlY2hhcnRzIGRvZXMgbm90IHRlc3QgZm9yIHRoYXQKICAgICAgc3RhY2tlZERhdGE6IGdldFN0YWNrZWREYXRhKGRpc3BsYXllZERhdGEsIGRhdGFLZXlzLCBzdGFja09mZnNldFR5cGUpLAogICAgICBncmFwaGljYWxJdGVtczogb3JkZXJlZEdyYXBoaWNhbEl0ZW1zCiAgICB9XTsKICB9KSk7Cn07CnZhciBzZWxlY3RTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWRTdGFja2VkRGF0YSwgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXJdLCBjb21iaW5lU3RhY2tHcm91cHMpOwp2YXIgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIF9yZWYzLCBheGlzVHlwZSwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYzOwogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiekF4aXMiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZG9tYWluT2ZTdGFja0dyb3VwcyA9IGdldERvbWFpbk9mU3RhY2tHcm91cHMoc3RhY2tHcm91cHMsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpOwogIGlmIChkb21haW5PZlN0YWNrR3JvdXBzICE9IG51bGwgJiYgZG9tYWluT2ZTdGFja0dyb3Vwc1swXSA9PT0gMCAmJiBkb21haW5PZlN0YWNrR3JvdXBzWzFdID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZG9tYWluT2ZTdGFja0dyb3VwczsKfTsKdmFyIHNlbGVjdEFsbG93c0RhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBnZXREb21haW5EZWZpbml0aW9uID0gKGF4aXNTZXR0aW5ncykgPT4gewogIHZhciBfYXhpc1NldHRpbmdzJGRvbWFpbjsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwgfHwgISgiZG9tYWluIiBpbiBheGlzU2V0dGluZ3MpKSB7CiAgICByZXR1cm4gZGVmYXVsdE51bWVyaWNEb21haW47CiAgfQogIGlmIChheGlzU2V0dGluZ3MuZG9tYWluICE9IG51bGwpIHsKICAgIHJldHVybiBheGlzU2V0dGluZ3MuZG9tYWluOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLnRpY2tzICE9IG51bGwpIHsKICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgdmFyIGFsbFZhbHVlcyA9IG9ubHlBbGxvd051bWJlcnMoYXhpc1NldHRpbmdzLnRpY2tzKTsKICAgICAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxWYWx1ZXMpLCBNYXRoLm1heCguLi5hbGxWYWx1ZXMpXTsKICAgIH0KICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgICByZXR1cm4gYXhpc1NldHRpbmdzLnRpY2tzLm1hcChTdHJpbmcpOwogICAgfQogIH0KICByZXR1cm4gKF9heGlzU2V0dGluZ3MkZG9tYWluID0gYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRvbWFpbikgIT09IG51bGwgJiYgX2F4aXNTZXR0aW5ncyRkb21haW4gIT09IHZvaWQgMCA/IF9heGlzU2V0dGluZ3MkZG9tYWluIDogZGVmYXVsdE51bWVyaWNEb21haW47Cn07CnZhciBzZWxlY3REb21haW5EZWZpbml0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzXSwgZ2V0RG9tYWluRGVmaW5pdGlvbik7CnZhciBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0QWxsb3dzRGF0YU92ZXJmbG93XSwgbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEpOwp2YXIgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHBpY2tBeGlzVHlwZSwgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlXSwgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS5lcnJvckJhcnM7CnZhciBjb21iaW5lUmVsZXZhbnRFcnJvckJhclNldHRpbmdzID0gKGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIGFsbEVycm9yQmFyU2V0dGluZ3MsIGF4aXNUeXBlKSA9PiB7CiAgcmV0dXJuIGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MuZmxhdE1hcCgoaXRlbSkgPT4gewogICAgcmV0dXJuIGFsbEVycm9yQmFyU2V0dGluZ3NbaXRlbS5pZF07CiAgfSkuZmlsdGVyKEJvb2xlYW4pLmZpbHRlcigoZSkgPT4gewogICAgcmV0dXJuIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlKTsKICB9KTsKfTsKdmFyIG1lcmdlRG9tYWlucyA9IGZ1bmN0aW9uIG1lcmdlRG9tYWluczIoKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGRvbWFpbnMgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBkb21haW5zW19rZXldID0gYXJndW1lbnRzW19rZXldOwogIH0KICB2YXIgYWxsRG9tYWlucyA9IGRvbWFpbnMuZmlsdGVyKEJvb2xlYW4pOwogIGlmIChhbGxEb21haW5zLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGFsbFZhbHVlcyA9IGFsbERvbWFpbnMuZmxhdCgpOwogIHZhciBtaW4yID0gTWF0aC5taW4oLi4uYWxsVmFsdWVzKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KC4uLmFsbFZhbHVlcyk7CiAgcmV0dXJuIFttaW4yLCBtYXgyXTsKfTsKdmFyIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zLCBlcnJvckJhcnMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGxvd2VyRW5kLCB1cHBlckVuZDsKICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgZGF0YS5mb3JFYWNoKChlbnRyeSkgPT4gewogICAgICBpdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIF9lcnJvckJhcnMkaXRlbSRpZCwgX2F4aXNTZXR0aW5ncyRkYXRhS2V5OwogICAgICAgIHZhciByZWxldmFudEVycm9yQmFycyA9IChfZXJyb3JCYXJzJGl0ZW0kaWQgPSBlcnJvckJhcnNbaXRlbS5pZF0pID09PSBudWxsIHx8IF9lcnJvckJhcnMkaXRlbSRpZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yQmFycyRpdGVtJGlkLmZpbHRlcigoZXJyb3JCYXIpID0+IGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikpOwogICAgICAgIHZhciB2YWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCAoX2F4aXNTZXR0aW5ncyRkYXRhS2V5ID0gYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9heGlzU2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX2F4aXNTZXR0aW5ncyRkYXRhS2V5IDogaXRlbS5kYXRhS2V5KTsKICAgICAgICB2YXIgZXJyb3JEb21haW4gPSBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgdmFsdWVCeURhdGFLZXksIHJlbGV2YW50RXJyb3JCYXJzKTsKICAgICAgICBpZiAoZXJyb3JEb21haW4ubGVuZ3RoID49IDIpIHsKICAgICAgICAgIHZhciBsb2NhbExvd2VyID0gTWF0aC5taW4oLi4uZXJyb3JEb21haW4pOwogICAgICAgICAgdmFyIGxvY2FsVXBwZXIgPSBNYXRoLm1heCguLi5lcnJvckRvbWFpbik7CiAgICAgICAgICBpZiAobG93ZXJFbmQgPT0gbnVsbCB8fCBsb2NhbExvd2VyIDwgbG93ZXJFbmQpIHsKICAgICAgICAgICAgbG93ZXJFbmQgPSBsb2NhbExvd2VyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwcGVyRW5kID09IG51bGwgfHwgbG9jYWxVcHBlciA+IHVwcGVyRW5kKSB7CiAgICAgICAgICAgIHVwcGVyRW5kID0gbG9jYWxVcHBlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRhdGFWYWx1ZURvbWFpbiA9IG1ha2VEb21haW4odmFsdWVCeURhdGFLZXkpOwogICAgICAgIGlmIChkYXRhVmFsdWVEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgbG93ZXJFbmQgPSBsb3dlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzBdIDogTWF0aC5taW4obG93ZXJFbmQsIGRhdGFWYWx1ZURvbWFpblswXSk7CiAgICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIGRhdGEuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICB2YXIgZGF0YVZhbHVlRG9tYWluID0gbWFrZURvbWFpbihnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLCBheGlzU2V0dGluZ3MuZGF0YUtleSkpOwogICAgICBpZiAoZGF0YVZhbHVlRG9tYWluICE9IG51bGwpIHsKICAgICAgICBsb3dlckVuZCA9IGxvd2VyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMF0gOiBNYXRoLm1pbihsb3dlckVuZCwgZGF0YVZhbHVlRG9tYWluWzBdKTsKICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgfQogICAgfSk7CiAgfQogIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKGxvd2VyRW5kKSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKHVwcGVyRW5kKSkgewogICAgcmV0dXJuIFtsb3dlckVuZCwgdXBwZXJFbmRdOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CmZ1bmN0aW9uIG9ubHlBbGxvd051bWJlcnNBbmRTdHJpbmdzQW5kRGF0ZXMoaXRlbSkgewogIHZhciB7CiAgICB2YWx1ZQogIH0gPSBpdGVtOwogIGlmIChpc051bU9yU3RyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQp2YXIgY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5ID0gKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzLCBpc0NhdGVnb3JpY2FsKSA9PiB7CiAgdmFyIGNhdGVnb3JpY2FsRG9tYWluID0gYWxsRGF0YVNxdWlzaGVkLm1hcChvbmx5QWxsb3dOdW1iZXJzQW5kU3RyaW5nc0FuZERhdGVzKS5maWx0ZXIoKHYpID0+IHYgIT0gbnVsbCk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgKGF4aXNTZXR0aW5ncy5kYXRhS2V5ID09IG51bGwgfHwgYXhpc1NldHRpbmdzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGhhc0R1cGxpY2F0ZShjYXRlZ29yaWNhbERvbWFpbikpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgYWxsRGF0YVNxdWlzaGVkLmxlbmd0aCk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkpIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbjsKICB9CiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChjYXRlZ29yaWNhbERvbWFpbikpOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90cyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMuZG90czsKdmFyIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzID0gKGVsZW1lbnRzLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIGVsZW1lbnRzLmZpbHRlcigoZWwpID0+IGVsLmlmT3ZlcmZsb3cgPT09ICJleHRlbmREb21haW4iKS5maWx0ZXIoKGVsKSA9PiB7CiAgICBpZiAoYXhpc1R5cGUgPT09ICJ4QXhpcyIpIHsKICAgICAgcmV0dXJuIGVsLnhBeGlzSWQgPT09IGF4aXNJZDsKICAgIH0KICAgIHJldHVybiBlbC55QXhpc0lkID09PSBheGlzSWQ7CiAgfSk7Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzID0gKHN0YXRlKSA9PiBzdGF0ZS5yZWZlcmVuY2VFbGVtZW50cy5hcmVhczsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lcyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMubGluZXM7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lcywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgY29tYmluZURvdHNEb21haW4gPSAoZG90cywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhkb3RzLm1hcCgoZG90KSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGRvdC54IDogZG90LnkpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzLCBwaWNrQXhpc1R5cGUsIGNvbWJpbmVEb3RzRG9tYWluKTsKdmFyIGNvbWJpbmVBcmVhc0RvbWFpbiA9IChhcmVhcywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhhcmVhcy5mbGF0TWFwKChhcmVhKSA9PiBbYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngxIDogYXJlYS55MSwgYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngyIDogYXJlYS55Ml0pKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXJlYXNEb21haW4pOwpmdW5jdGlvbiBleHRyYWN0WENvb3JkaW5hdGVzKGxpbmUpIHsKICB2YXIgX2xpbmUkc2VnbWVudDsKICBpZiAobGluZS54ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnhdKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50ID0gbGluZS5zZWdtZW50KSA9PT0gbnVsbCB8fCBfbGluZSRzZWdtZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbGluZSRzZWdtZW50Lm1hcCgocykgPT4gcy54KTsKICBpZiAoc2VnbWVudENvb3JkaW5hdGVzID09IG51bGwgfHwgc2VnbWVudENvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhzZWdtZW50Q29vcmRpbmF0ZXMpOwp9CmZ1bmN0aW9uIGV4dHJhY3RZQ29vcmRpbmF0ZXMobGluZSkgewogIHZhciBfbGluZSRzZWdtZW50MjsKICBpZiAobGluZS55ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnldKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50MiA9IGxpbmUuc2VnbWVudCkgPT09IG51bGwgfHwgX2xpbmUkc2VnbWVudDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9saW5lJHNlZ21lbnQyLm1hcCgocykgPT4gcy55KTsKICBpZiAoc2VnbWVudENvb3JkaW5hdGVzID09IG51bGwgfHwgc2VnbWVudENvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhzZWdtZW50Q29vcmRpbmF0ZXMpOwp9CnZhciBjb21iaW5lTGluZXNEb21haW4gPSAobGluZXMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IGxpbmVzLmZsYXRNYXAoKGxpbmUpID0+IGF4aXNUeXBlID09PSAieEF4aXMiID8gZXh0cmFjdFhDb29yZGluYXRlcyhsaW5lKSA6IGV4dHJhY3RZQ29vcmRpbmF0ZXMobGluZSkpOwogIGlmIChhbGxDb29yZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW01hdGgubWluKC4uLmFsbENvb3JkcyksIE1hdGgubWF4KC4uLmFsbENvb3JkcyldOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXNCeUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFJlZmVyZW5jZUxpbmVzRG9tYWluLCBzZWxlY3RSZWZlcmVuY2VBcmVhc0RvbWFpbiwgKGRvdHNEb21haW4sIGxpbmVzRG9tYWluLCBhcmVhc0RvbWFpbikgPT4gewogIHJldHVybiBtZXJnZURvbWFpbnMoZG90c0RvbWFpbiwgYXJlYXNEb21haW4sIGxpbmVzRG9tYWluKTsKfSk7CnZhciBjb21iaW5lTnVtZXJpY2FsRG9tYWluID0gKGF4aXNTZXR0aW5ncywgZG9tYWluRGVmaW5pdGlvbiwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlLCBkb21haW5PZlN0YWNrR3JvdXBzLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluLCByZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgbGF5b3V0LCBheGlzVHlwZSkgPT4gewogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZTsKICB9CiAgdmFyIHNob3VsZEluY2x1ZGVEb21haW5PZlN0YWNrR3JvdXBzID0gbGF5b3V0ID09PSAidmVydGljYWwiICYmIGF4aXNUeXBlID09PSAieEF4aXMiIHx8IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIGF4aXNUeXBlID09PSAieUF4aXMiOwogIHZhciBtZXJnZWREb21haW5zID0gc2hvdWxkSW5jbHVkZURvbWFpbk9mU3RhY2tHcm91cHMgPyBtZXJnZURvbWFpbnMoZG9tYWluT2ZTdGFja0dyb3VwcywgcmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGRhdGFBbmRFcnJvckJhcnNEb21haW4pIDogbWVyZ2VEb21haW5zKHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluKTsKICByZXR1cm4gcGFyc2VOdW1lcmljYWxVc2VyRG9tYWluKGRvbWFpbkRlZmluaXRpb24sIG1lcmdlZERvbWFpbnMsIGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7Cn07CnZhciBzZWxlY3ROdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdERvbWFpbkRlZmluaXRpb24sIHNlbGVjdERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSwgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3Vwcywgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHNlbGVjdFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBzZWxlY3RDaGFydExheW91dCwgcGlja0F4aXNUeXBlXSwgY29tYmluZU51bWVyaWNhbERvbWFpbiwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIGV4cGFuZERvbWFpbiA9IFswLCAxXTsKdmFyIGNvbWJpbmVBeGlzRG9tYWluID0gKGF4aXNTZXR0aW5ncywgbGF5b3V0LCBkaXNwbGF5ZWREYXRhLCBhbGxBcHBsaWVkVmFsdWVzLCBzdGFja09mZnNldFR5cGUsIGF4aXNUeXBlLCBudW1lcmljYWxEb21haW4pID0+IHsKICBpZiAoKGF4aXNTZXR0aW5ncyA9PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhLmxlbmd0aCA9PT0gMCkgJiYgbnVtZXJpY2FsRG9tYWluID09PSB2b2lkIDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhS2V5LAogICAgdHlwZQogIH0gPSBheGlzU2V0dGluZ3M7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBkYXRhS2V5ID09IG51bGwpIHsKICAgIHZhciBfZGlzcGxheWVkRGF0YSRsZW5ndGg7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgKF9kaXNwbGF5ZWREYXRhJGxlbmd0aCA9IGRpc3BsYXllZERhdGEgPT09IG51bGwgfHwgZGlzcGxheWVkRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGlzcGxheWVkRGF0YS5sZW5ndGgpICE9PSBudWxsICYmIF9kaXNwbGF5ZWREYXRhJGxlbmd0aCAhPT0gdm9pZCAwID8gX2Rpc3BsYXllZERhdGEkbGVuZ3RoIDogMCk7CiAgfQogIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICByZXR1cm4gY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5KGFsbEFwcGxpZWRWYWx1ZXMsIGF4aXNTZXR0aW5ncywgaXNDYXRlZ29yaWNhbCk7CiAgfQogIGlmIChzdGFja09mZnNldFR5cGUgPT09ICJleHBhbmQiKSB7CiAgICByZXR1cm4gZXhwYW5kRG9tYWluOwogIH0KICByZXR1cm4gbnVtZXJpY2FsRG9tYWluOwp9Owp2YXIgc2VsZWN0QXhpc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgcGlja0F4aXNUeXBlLCBzZWxlY3ROdW1lcmljYWxEb21haW5dLCBjb21iaW5lQXhpc0RvbWFpbik7CnZhciBjb21iaW5lUmVhbFNjYWxlVHlwZSA9IChheGlzQ29uZmlnLCBsYXlvdXQsIGhhc0JhciwgY2hhcnRUeXBlLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzQ29uZmlnID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBzY2FsZSwKICAgIHR5cGUKICB9ID0gYXhpc0NvbmZpZzsKICBpZiAoc2NhbGUgPT09ICJhdXRvIikgewogICAgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJyYWRpdXNBeGlzIikgewogICAgICByZXR1cm4gImJhbmQiOwogICAgfQogICAgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiKSB7CiAgICAgIHJldHVybiAibGluZWFyIjsKICAgIH0KICAgIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiICYmIGNoYXJ0VHlwZSAmJiAoY2hhcnRUeXBlLmluZGV4T2YoIkxpbmVDaGFydCIpID49IDAgfHwgY2hhcnRUeXBlLmluZGV4T2YoIkFyZWFDaGFydCIpID49IDAgfHwgY2hhcnRUeXBlLmluZGV4T2YoIkNvbXBvc2VkQ2hhcnQiKSA+PSAwICYmICFoYXNCYXIpKSB7CiAgICAgIHJldHVybiAicG9pbnQiOwogICAgfQogICAgaWYgKHR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgICAgcmV0dXJuICJiYW5kIjsKICAgIH0KICAgIHJldHVybiAibGluZWFyIjsKICB9CiAgaWYgKHR5cGVvZiBzY2FsZSA9PT0gInN0cmluZyIpIHsKICAgIHZhciBuYW1lID0gInNjYWxlIi5jb25jYXQodXBwZXJGaXJzdChzY2FsZSkpOwogICAgcmV0dXJuIG5hbWUgaW4gZDNfc2NhbGVfZXhwb3J0cyA/IG5hbWUgOiAicG9pbnQiOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0UmVhbFNjYWxlVHlwZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEhhc0Jhciwgc2VsZWN0Q2hhcnROYW1lLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lUmVhbFNjYWxlVHlwZSk7CmZ1bmN0aW9uIGdldEQzU2NhbGVGcm9tVHlwZShyZWFsU2NhbGVUeXBlKSB7CiAgaWYgKHJlYWxTY2FsZVR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHJlYWxTY2FsZVR5cGUgaW4gZDNfc2NhbGVfZXhwb3J0cykgewogICAgcmV0dXJuIGQzX3NjYWxlX2V4cG9ydHNbcmVhbFNjYWxlVHlwZV0oKTsKICB9CiAgdmFyIG5hbWUgPSAic2NhbGUiLmNvbmNhdCh1cHBlckZpcnN0KHJlYWxTY2FsZVR5cGUpKTsKICBpZiAobmFtZSBpbiBkM19zY2FsZV9leHBvcnRzKSB7CiAgICByZXR1cm4gZDNfc2NhbGVfZXhwb3J0c1tuYW1lXSgpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKGF4aXMsIHJlYWxTY2FsZVR5cGUsIGF4aXNEb21haW4sIGF4aXNSYW5nZSkgewogIGlmIChheGlzRG9tYWluID09IG51bGwgfHwgYXhpc1JhbmdlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICh0eXBlb2YgYXhpcy5zY2FsZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGF4aXMuc2NhbGUuY29weSgpLmRvbWFpbihheGlzRG9tYWluKS5yYW5nZShheGlzUmFuZ2UpOwogIH0KICB2YXIgZDNTY2FsZUZ1bmN0aW9uID0gZ2V0RDNTY2FsZUZyb21UeXBlKHJlYWxTY2FsZVR5cGUpOwogIGlmIChkM1NjYWxlRnVuY3Rpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHNjYWxlID0gZDNTY2FsZUZ1bmN0aW9uLmRvbWFpbihheGlzRG9tYWluKS5yYW5nZShheGlzUmFuZ2UpOwogIGNoZWNrRG9tYWluT2ZTY2FsZShzY2FsZSk7CiAgcmV0dXJuIHNjYWxlOwp9CnZhciBjb21iaW5lTmljZVRpY2tzID0gKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncywgcmVhbFNjYWxlVHlwZSkgPT4gewogIHZhciBkb21haW5EZWZpbml0aW9uID0gZ2V0RG9tYWluRGVmaW5pdGlvbihheGlzU2V0dGluZ3MpOwogIGlmIChyZWFsU2NhbGVUeXBlICE9PSAiYXV0byIgJiYgcmVhbFNjYWxlVHlwZSAhPT0gImxpbmVhciIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT0gbnVsbCAmJiBheGlzU2V0dGluZ3MudGlja0NvdW50ICYmIEFycmF5LmlzQXJyYXkoZG9tYWluRGVmaW5pdGlvbikgJiYgKGRvbWFpbkRlZmluaXRpb25bMF0gPT09ICJhdXRvIiB8fCBkb21haW5EZWZpbml0aW9uWzFdID09PSAiYXV0byIpICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihheGlzRG9tYWluKSkgewogICAgcmV0dXJuIGdldE5pY2VUaWNrVmFsdWVzKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncy50aWNrQ291bnQsIGF4aXNTZXR0aW5ncy5hbGxvd0RlY2ltYWxzKTsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPSBudWxsICYmIGF4aXNTZXR0aW5ncy50aWNrQ291bnQgJiYgYXhpc1NldHRpbmdzLnR5cGUgPT09ICJudW1iZXIiICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihheGlzRG9tYWluKSkgewogICAgcmV0dXJuIGdldFRpY2tWYWx1ZXNGaXhlZERvbWFpbihheGlzRG9tYWluLCBheGlzU2V0dGluZ3MudGlja0NvdW50LCBheGlzU2V0dGluZ3MuYWxsb3dEZWNpbWFscyk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3ROaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlXSwgY29tYmluZU5pY2VUaWNrcyk7CnZhciBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MgPSAoYXhpc1NldHRpbmdzLCBkb21haW4sIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoCiAgICAvKgogICAgICogQW5nbGUgYXhpcyBmb3Igc29tZSByZWFzb24gdXNlcyBuaWNlIHRpY2tzIHdoZW4gcmVuZGVyaW5nIGF4aXMgdGljayBsYWJlbHMsCiAgICAgKiBidXQgZG9lc24ndCB1c2UgbmljZSB0aWNrcyBmb3IgZXh0ZW5kaW5nIGRvbWFpbiBsaWtlIGFsbCB0aGUgb3RoZXIgYXhlcyBkby4KICAgICAqIE5vdCByZWFsbHkgc3VyZSB3aHk/IElzIHRoZXJlIGEgZ29vZCByZWFzb24sCiAgICAgKiBvciBpcyBpdCBqdXN0IGJlY2F1c2Ugc29tZW9uZSBhZGRlZCBzdXBwb3J0IGZvciBuaWNlIHRpY2tzIHRvIHRoZSBvdGhlciBheGVzIGFuZCBmb3Jnb3QgdGhpcyBvbmU/CiAgICAgKi8KICAgIGF4aXNUeXBlICE9PSAiYW5nbGVBeGlzIiAmJiAoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLnR5cGUpID09PSAibnVtYmVyIiAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSAmJiBBcnJheS5pc0FycmF5KG5pY2VUaWNrcykgJiYgbmljZVRpY2tzLmxlbmd0aCA+IDAKICApIHsKICAgIHZhciBtaW5Gcm9tRG9tYWluID0gZG9tYWluWzBdOwogICAgdmFyIG1pbkZyb21UaWNrcyA9IG5pY2VUaWNrc1swXTsKICAgIHZhciBtYXhGcm9tRG9tYWluID0gZG9tYWluWzFdOwogICAgdmFyIG1heEZyb21UaWNrcyA9IG5pY2VUaWNrc1tuaWNlVGlja3MubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gW01hdGgubWluKG1pbkZyb21Eb21haW4sIG1pbkZyb21UaWNrcyksIE1hdGgubWF4KG1heEZyb21Eb21haW4sIG1heEZyb21UaWNrcyldOwogIH0KICByZXR1cm4gZG9tYWluOwp9Owp2YXIgc2VsZWN0QXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0TmljZVRpY2tzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RCYXNlQXhpcywgKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgaWYgKCFheGlzU2V0dGluZ3MgfHwgYXhpc1NldHRpbmdzLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBJbmZpbml0eTsKICB2YXIgc29ydGVkVmFsdWVzID0gQXJyYXkuZnJvbShvbmx5QWxsb3dOdW1iZXJzKGFsbERhdGFTcXVpc2hlZC5tYXAoKGQpID0+IGQudmFsdWUpKSkuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIGlmIChzb3J0ZWRWYWx1ZXMubGVuZ3RoIDwgMikgewogICAgcmV0dXJuIEluZmluaXR5OwogIH0KICB2YXIgZGlmZiA9IHNvcnRlZFZhbHVlc1tzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMV0gLSBzb3J0ZWRWYWx1ZXNbMF07CiAgaWYgKGRpZmYgPT09IDApIHsKICAgIHJldHVybiBJbmZpbml0eTsKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICB2YXIgZGlzdGFuY2UgPSBzb3J0ZWRWYWx1ZXNbaSArIDFdIC0gc29ydGVkVmFsdWVzW2ldOwogICAgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBNYXRoLm1pbihzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcywgZGlzdGFuY2UpOwogIH0KICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgLyBkaWZmOwp9KTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RCYXJDYXRlZ29yeUdhcCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgKF8xLCBfMiwgXzMsIHBhZGRpbmcpID0+IHBhZGRpbmcsIChzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50LCBsYXlvdXQsIGJhckNhdGVnb3J5R2FwLCBvZmZzZXQsIHBhZGRpbmcpID0+IHsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCkpIHsKICAgIHJldHVybiAwOwogIH0KICB2YXIgcmFuZ2VXaWR0aCA9IGxheW91dCA9PT0gInZlcnRpY2FsIiA/IG9mZnNldC5oZWlnaHQgOiBvZmZzZXQud2lkdGg7CiAgaWYgKHBhZGRpbmcgPT09ICJnYXAiKSB7CiAgICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCAqIHJhbmdlV2lkdGggLyAyOwogIH0KICBpZiAocGFkZGluZyA9PT0gIm5vLWdhcCIpIHsKICAgIHZhciBnYXAgPSBnZXRQZXJjZW50VmFsdWUoYmFyQ2F0ZWdvcnlHYXAsIHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoKTsKICAgIHZhciBoYWxmQmFuZCA9IHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoIC8gMjsKICAgIHJldHVybiBoYWxmQmFuZCAtIGdhcCAtIChoYWxmQmFuZCAtIGdhcCkgLyByYW5nZVdpZHRoICogZ2FwOwogIH0KICByZXR1cm4gMDsKfSk7CnZhciBzZWxlY3RDYWxjdWxhdGVkWEF4aXNQYWRkaW5nID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgeEF4aXNTZXR0aW5ncyA9IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKHhBeGlzU2V0dGluZ3MgPT0gbnVsbCB8fCB0eXBlb2YgeEF4aXNTZXR0aW5ncy5wYWRkaW5nICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIDA7CiAgfQogIHJldHVybiBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyhzdGF0ZSwgInhBeGlzIiwgYXhpc0lkLCB4QXhpc1NldHRpbmdzLnBhZGRpbmcpOwp9Owp2YXIgc2VsZWN0Q2FsY3VsYXRlZFlBeGlzUGFkZGluZyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIHlBeGlzU2V0dGluZ3MgPSBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwgfHwgdHlwZW9mIHlBeGlzU2V0dGluZ3MucGFkZGluZyAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcoc3RhdGUsICJ5QXhpcyIsIGF4aXNJZCwgeUF4aXNTZXR0aW5ncy5wYWRkaW5nKTsKfTsKdmFyIHNlbGVjdFhBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRYQXhpc1BhZGRpbmcsICh4QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJGxlZnQsIF9wYWRkaW5nJHJpZ2h0OwogIGlmICh4QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB4QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IGNhbGN1bGF0ZWQsCiAgICAgIHJpZ2h0OiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgbGVmdDogKChfcGFkZGluZyRsZWZ0ID0gcGFkZGluZy5sZWZ0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRsZWZ0ICE9PSB2b2lkIDAgPyBfcGFkZGluZyRsZWZ0IDogMCkgKyBjYWxjdWxhdGVkLAogICAgcmlnaHQ6ICgoX3BhZGRpbmckcmlnaHQgPSBwYWRkaW5nLnJpZ2h0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRyaWdodCAhPT0gdm9pZCAwID8gX3BhZGRpbmckcmlnaHQgOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFlBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRZQXhpc1BhZGRpbmcsICh5QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJHRvcCwgX3BhZGRpbmckYm90dG9tOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogMCwKICAgICAgYm90dG9tOiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB5QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogY2FsY3VsYXRlZCwKICAgICAgYm90dG9tOiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgdG9wOiAoKF9wYWRkaW5nJHRvcCA9IHBhZGRpbmcudG9wKSAhPT0gbnVsbCAmJiBfcGFkZGluZyR0b3AgIT09IHZvaWQgMCA/IF9wYWRkaW5nJHRvcCA6IDApICsgY2FsY3VsYXRlZCwKICAgIGJvdHRvbTogKChfcGFkZGluZyRib3R0b20gPSBwYWRkaW5nLmJvdHRvbSkgIT09IG51bGwgJiYgX3BhZGRpbmckYm90dG9tICE9PSB2b2lkIDAgPyBfcGFkZGluZyRib3R0b20gOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIGNvbWJpbmVYQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgcGFkZGluZywgYnJ1c2hEaW1lbnNpb25zLCBfcmVmNCwgaXNQYW5vcmFtYSkgPT4gewogIHZhciB7CiAgICBwYWRkaW5nOiBicnVzaFBhZGRpbmcKICB9ID0gX3JlZjQ7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBbYnJ1c2hQYWRkaW5nLmxlZnQsIGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5yaWdodF07CiAgfQogIHJldHVybiBbb2Zmc2V0LmxlZnQgKyBwYWRkaW5nLmxlZnQsIG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gcGFkZGluZy5yaWdodF07Cn0pOwp2YXIgY29tYmluZVlBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFlBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgbGF5b3V0LCBwYWRkaW5nLCBicnVzaERpbWVuc2lvbnMsIF9yZWY1LCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIHsKICAgIHBhZGRpbmc6IGJydXNoUGFkZGluZwogIH0gPSBfcmVmNTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIFticnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLmJvdHRvbSwgYnJ1c2hQYWRkaW5nLnRvcF07CiAgfQogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFtvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIHBhZGRpbmcuYm90dG9tLCBvZmZzZXQudG9wICsgcGFkZGluZy50b3BdOwogIH0KICByZXR1cm4gW29mZnNldC50b3AgKyBwYWRkaW5nLnRvcCwgb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBwYWRkaW5nLmJvdHRvbV07Cn0pOwp2YXIgc2VsZWN0QXhpc1JhbmdlID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIF9zZWxlY3RaQXhpc1NldHRpbmdzOwogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGNvbWJpbmVYQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQsIGlzUGFub3JhbWEpOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gY29tYmluZVlBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgICBjYXNlICJ6QXhpcyI6CiAgICAgIHJldHVybiAoX3NlbGVjdFpBeGlzU2V0dGluZ3MgPSBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpKSA9PT0gbnVsbCB8fCBfc2VsZWN0WkF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3NlbGVjdFpBeGlzU2V0dGluZ3MucmFuZ2U7CiAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzUmFuZ2Uoc3RhdGUpOwogICAgY2FzZSAicmFkaXVzQXhpcyI6CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCk7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gdm9pZCAwOwogIH0KfTsKdmFyIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0QXhpc1NjYWxlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzLCBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdEVycm9yQmFyc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVSZWxldmFudEVycm9yQmFyU2V0dGluZ3MpOwpmdW5jdGlvbiBjb21wYXJlSWRzKGEsIGIpIHsKICBpZiAoYS5pZCA8IGIuaWQpIHsKICAgIHJldHVybiAtMTsKICB9CiAgaWYgKGEuaWQgPiBiLmlkKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIDA7Cn0KdmFyIHBpY2tBeGlzT3JpZW50YXRpb24gPSAoX3N0YXRlLCBvcmllbnRhdGlvbikgPT4gb3JpZW50YXRpb247CnZhciBwaWNrTWlycm9yID0gKF9zdGF0ZSwgX29yaWVudGF0aW9uLCBtaXJyb3IpID0+IG1pcnJvcjsKdmFyIHNlbGVjdEFsbFhBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxYQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxZQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIGdldFhBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHJldHVybiB7CiAgICB3aWR0aDogb2Zmc2V0LndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2V0dGluZ3MuaGVpZ2h0CiAgfTsKfTsKdmFyIGdldFlBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHZhciB3aWR0aCA9IHR5cGVvZiBheGlzU2V0dGluZ3Mud2lkdGggPT09ICJudW1iZXIiID8gYXhpc1NldHRpbmdzLndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgcmV0dXJuIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0CiAgfTsKfTsKdmFyIHNlbGVjdFhBeGlzU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIGdldFhBeGlzU2l6ZSk7CnZhciBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpID0+IHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gb2Zmc2V0LnRvcDsKICAgIGNhc2UgImJvdHRvbSI6CiAgICAgIHJldHVybiBjaGFydEhlaWdodCAtIG9mZnNldC5ib3R0b207CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMDsKICB9Cn07CnZhciBjb21iaW5lWUF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRXaWR0aCkgPT4gewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gb2Zmc2V0LmxlZnQ7CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHJldHVybiBjaGFydFdpZHRoIC0gb2Zmc2V0LnJpZ2h0OwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9Owp2YXIgc2VsZWN0QWxsWEF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RBbGxYQXhlc1dpdGhPZmZzZXRUeXBlLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoY2hhcnRIZWlnaHQsIG9mZnNldCwgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZSwgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gewogIHZhciBzdGVwcyA9IHt9OwogIHZhciBwb3NpdGlvbjsKICBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLmZvckVhY2goKGF4aXMpID0+IHsKICAgIHZhciBheGlzU2l6ZSA9IGdldFhBeGlzU2l6ZShvZmZzZXQsIGF4aXMpOwogICAgaWYgKHBvc2l0aW9uID09IG51bGwpIHsKICAgICAgcG9zaXRpb24gPSBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS5oZWlnaHQ7CiAgICBwb3NpdGlvbiArPSAobmVlZFNwYWNlID8gLTEgOiAxKSAqIGF4aXNTaXplLmhlaWdodDsKICB9KTsKICByZXR1cm4gc3RlcHM7Cn0pOwp2YXIgc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChjaGFydFdpZHRoLCBvZmZzZXQsIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IHsKICB2YXIgc3RlcHMgPSB7fTsKICB2YXIgcG9zaXRpb247CiAgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZS5mb3JFYWNoKChheGlzKSA9PiB7CiAgICB2YXIgYXhpc1NpemUgPSBnZXRZQXhpc1NpemUob2Zmc2V0LCBheGlzKTsKICAgIGlmIChwb3NpdGlvbiA9PSBudWxsKSB7CiAgICAgIHBvc2l0aW9uID0gY29tYmluZVlBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50KG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0V2lkdGgpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS53aWR0aDsKICAgIHBvc2l0aW9uICs9IChuZWVkU3BhY2UgPyAtMSA6IDEpICogYXhpc1NpemUud2lkdGg7CiAgfSk7CiAgcmV0dXJuIHN0ZXBzOwp9KTsKdmFyIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzU2V0dGluZ3MgPSBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHNlbGVjdEFsbFhBeGVzT2Zmc2V0U3RlcHMoc3RhdGUsIGF4aXNTZXR0aW5ncy5vcmllbnRhdGlvbiwgYXhpc1NldHRpbmdzLm1pcnJvcik7Cn07CnZhciBzZWxlY3RYQXhpc1Bvc2l0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMsIChfLCBheGlzSWQpID0+IGF4aXNJZF0sIChvZmZzZXQsIGF4aXNTZXR0aW5ncywgYWxsU3RlcHMsIGF4aXNJZCkgPT4gewogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHN0ZXBPZlRoaXNBeGlzID0gYWxsU3RlcHMgPT09IG51bGwgfHwgYWxsU3RlcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFN0ZXBzW2F4aXNJZF07CiAgaWYgKHN0ZXBPZlRoaXNBeGlzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiAwCiAgICB9OwogIH0KICByZXR1cm4gewogICAgeDogb2Zmc2V0LmxlZnQsCiAgICB5OiBzdGVwT2ZUaGlzQXhpcwogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXNTZXR0aW5ncyA9IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyhzdGF0ZSwgYXhpc1NldHRpbmdzLm9yaWVudGF0aW9uLCBheGlzU2V0dGluZ3MubWlycm9yKTsKfTsKdmFyIHNlbGVjdFlBeGlzUG9zaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcywgKF8sIGF4aXNJZCkgPT4gYXhpc0lkXSwgKG9mZnNldCwgYXhpc1NldHRpbmdzLCBhbGxTdGVwcywgYXhpc0lkKSA9PiB7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc3RlcE9mVGhpc0F4aXMgPSBhbGxTdGVwcyA9PT0gbnVsbCB8fCBhbGxTdGVwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsU3RlcHNbYXhpc0lkXTsKICBpZiAoc3RlcE9mVGhpc0F4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgeDogMCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHg6IHN0ZXBPZlRoaXNBeGlzLAogICAgeTogb2Zmc2V0LnRvcAogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNTaXplID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgKG9mZnNldCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgdmFyIHdpZHRoID0gdHlwZW9mIGF4aXNTZXR0aW5ncy53aWR0aCA9PT0gIm51bWJlciIgPyBheGlzU2V0dGluZ3Mud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICByZXR1cm4gewogICAgd2lkdGgsCiAgICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKICB9Owp9KTsKdmFyIGNvbWJpbmVEdXBsaWNhdGVEb21haW4gPSAoY2hhcnRMYXlvdXQsIGFwcGxpZWRWYWx1ZXMsIGF4aXMsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgdHlwZSwKICAgIGRhdGFLZXkKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGNoYXJ0TGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIGFsbERhdGEgPSBhcHBsaWVkVmFsdWVzLm1hcCgoYXYpID0+IGF2LnZhbHVlKTsKICBpZiAoZGF0YUtleSAmJiBpc0NhdGVnb3JpY2FsICYmIHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgaGFzRHVwbGljYXRlKGFsbERhdGEpKSB7CiAgICByZXR1cm4gYWxsRGF0YTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVEdXBsaWNhdGVEb21haW4pOwp2YXIgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluID0gKGxheW91dCwgYXBwbGllZFZhbHVlcywgYXhpcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IGF4aXMuZGF0YUtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZSwKICAgIHNjYWxlCiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiAodHlwZSA9PT0gIm51bWJlciIgfHwgc2NhbGUgIT09ICJhdXRvIikpIHsKICAgIHJldHVybiBhcHBsaWVkVmFsdWVzLm1hcCgoZCkgPT4gZC52YWx1ZSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QXhpc1NldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDYXJ0ZXNpYW5BeGlzU2V0dGluZ3MsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3ROaWNlVGlja3MsIHBpY2tBeGlzVHlwZV0sIChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzUmFuZ2UsIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHJldHVybiB7CiAgICBhbmdsZTogYXhpcy5hbmdsZSwKICAgIGludGVydmFsOiBheGlzLmludGVydmFsLAogICAgbWluVGlja0dhcDogYXhpcy5taW5UaWNrR2FwLAogICAgb3JpZW50YXRpb246IGF4aXMub3JpZW50YXRpb24sCiAgICB0aWNrOiBheGlzLnRpY2ssCiAgICB0aWNrQ291bnQ6IGF4aXMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogYXhpcy50aWNrRm9ybWF0dGVyLAogICAgdGlja3M6IGF4aXMudGlja3MsCiAgICB0eXBlOiBheGlzLnR5cGUsCiAgICB1bml0OiBheGlzLnVuaXQsCiAgICBheGlzVHlwZSwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgZHVwbGljYXRlRG9tYWluLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIG5pY2VUaWNrcywKICAgIHJhbmdlOiBheGlzUmFuZ2UsCiAgICByZWFsU2NhbGVUeXBlLAogICAgc2NhbGUKICB9Owp9KTsKdmFyIGNvbWJpbmVBeGlzVGlja3MgPSAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgbmljZVRpY2tzLCBheGlzUmFuZ2UsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHZhciB7CiAgICB0eXBlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHRpY2tDb3VudAogIH0gPSBheGlzOwogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgdHlwZW9mIHNjYWxlLmJhbmR3aWR0aCA9PT0gImZ1bmN0aW9uIiA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gMiA6IDI7CiAgdmFyIG9mZnNldCA9IHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyBvZmZzZXRGb3JCYW5kIDogMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgYXhpc1JhbmdlICE9IG51bGwgJiYgYXhpc1JhbmdlLmxlbmd0aCA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgdmFyIHRpY2tzT3JOaWNlVGlja3MgPSB0aWNrczIgfHwgbmljZVRpY2tzOwogIGlmICh0aWNrc09yTmljZVRpY2tzKSB7CiAgICB2YXIgcmVzdWx0ID0gdGlja3NPck5pY2VUaWNrcy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5kZXgsCiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpLmZpbHRlcigocm93KSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChzY2FsZS50aWNrcykgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUaWNrc09mQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdE5pY2VUaWNrcywgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc1RpY2tzKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtVGlja3MgPSAobGF5b3V0LCBheGlzLCBzY2FsZSwgYXhpc1JhbmdlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCB8fCBheGlzUmFuZ2UgPT0gbnVsbCB8fCBheGlzUmFuZ2VbMF0gPT09IGF4aXNSYW5nZVsxXSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgewogICAgdGlja0NvdW50CiAgfSA9IGF4aXM7CiAgdmFyIG9mZnNldCA9IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIChheGlzUmFuZ2UgPT09IG51bGwgfHwgYXhpc1JhbmdlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzUmFuZ2UubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgaWYgKHNjYWxlLnRpY2tzKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBeGlzU2V0dGluZ3MsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbVRpY2tzKTsKdmFyIHNlbGVjdEF4aXNXaXRoU2NhbGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1NjYWxlLCAoYXhpcywgc2NhbGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTMoX29iamVjdFNwcmVhZDEzKHt9LCBheGlzKSwge30sIHsKICAgIHNjYWxlCiAgfSk7Cn0pOwp2YXIgc2VsZWN0WkF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RaQXhpc1dpdGhTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IHNlbGVjdFpBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCksIHNlbGVjdFpBeGlzU2NhbGUsIChheGlzLCBzY2FsZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMyhfb2JqZWN0U3ByZWFkMTMoe30sIGF4aXMpLCB7fSwgewogICAgc2NhbGUKICB9KTsKfSk7CnZhciBzZWxlY3RDaGFydERpcmVjdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsWEF4ZXMsIHNlbGVjdEFsbFlBeGVzXSwgKGxheW91dCwgYWxsWEF4ZXMsIGFsbFlBeGVzKSA9PiB7CiAgc3dpdGNoIChsYXlvdXQpIHsKICAgIGNhc2UgImhvcml6b250YWwiOiB7CiAgICAgIHJldHVybiBhbGxYQXhlcy5zb21lKChheGlzKSA9PiBheGlzLnJldmVyc2VkKSA/ICJyaWdodC10by1sZWZ0IiA6ICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGNhc2UgInZlcnRpY2FsIjogewogICAgICByZXR1cm4gYWxsWUF4ZXMuc29tZSgoYXhpcykgPT4gYXhpcy5yZXZlcnNlZCkgPyAiYm90dG9tLXRvLXRvcCIgOiAidG9wLXRvLWJvdHRvbSI7CiAgICB9CiAgICBjYXNlICJjZW50cmljIjoKICAgIGNhc2UgInJhZGlhbCI6IHsKICAgICAgcmV0dXJuICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBFdmVudFR5cGUuanMKdmFyIHNlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwp2YXIgc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy52YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzOwpmdW5jdGlvbiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKSB7CiAgaWYgKHNoYXJlZCA9PSBudWxsKSB7CiAgICByZXR1cm4gZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CiAgfQogIHZhciBldmVudFR5cGUgPSBzaGFyZWQgPyAiYXhpcyIgOiAiaXRlbSI7CiAgaWYgKHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwogIH0KICByZXR1cm4gdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcy5pbmNsdWRlcyhldmVudFR5cGUpID8gZXZlbnRUeXBlIDogZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7Cn0KZnVuY3Rpb24gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc2hhcmVkKSB7CiAgdmFyIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlID0gc2VsZWN0RGVmYXVsdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUpOwogIHZhciB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID0gc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyhzdGF0ZSk7CiAgcmV0dXJuIGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMpOwp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkKSB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc2hhcmVkKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZUxhYmVsLmpzCnZhciBjb21iaW5lQWN0aXZlTGFiZWwgPSAodG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCkgPT4gewogIHZhciBfdG9vbHRpcFRpY2tzJG47CiAgdmFyIG4gPSBOdW1iZXIoYWN0aXZlSW5kZXgpOwogIGlmIChpc05hbihuKSB8fCBhY3RpdmVJbmRleCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gbiA+PSAwID8gdG9vbHRpcFRpY2tzID09PSBudWxsIHx8IHRvb2x0aXBUaWNrcyA9PT0gdm9pZCAwIHx8IChfdG9vbHRpcFRpY2tzJG4gPSB0b29sdGlwVGlja3Nbbl0pID09PSBudWxsIHx8IF90b29sdGlwVGlja3MkbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Rvb2x0aXBUaWNrcyRuLnZhbHVlIDogdm9pZCAwOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTZXR0aW5ncy5qcwp2YXIgc2VsZWN0VG9vbHRpcFNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdG9vbHRpcFNsaWNlLmpzCnZhciBub0ludGVyYWN0aW9uID0gewogIGFjdGl2ZTogZmFsc2UsCiAgaW5kZXg6IG51bGwsCiAgZGF0YUtleTogdm9pZCAwLAogIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwLAogIGNvb3JkaW5hdGU6IHZvaWQgMAp9Owp2YXIgaW5pdGlhbFN0YXRlMyA9IHsKICBpdGVtSW50ZXJhY3Rpb246IHsKICAgIGNsaWNrOiBub0ludGVyYWN0aW9uLAogICAgaG92ZXI6IG5vSW50ZXJhY3Rpb24KICB9LAogIGF4aXNJbnRlcmFjdGlvbjogewogICAgY2xpY2s6IG5vSW50ZXJhY3Rpb24sCiAgICBob3Zlcjogbm9JbnRlcmFjdGlvbgogIH0sCiAga2V5Ym9hcmRJbnRlcmFjdGlvbjogbm9JbnRlcmFjdGlvbiwKICBzeW5jSW50ZXJhY3Rpb246IHsKICAgIGFjdGl2ZTogZmFsc2UsCiAgICBpbmRleDogbnVsbCwKICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgIGxhYmVsOiB2b2lkIDAsCiAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICBzb3VyY2VWaWV3Qm94OiB2b2lkIDAsCiAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogIH0sCiAgdG9vbHRpcEl0ZW1QYXlsb2FkczogW10sCiAgc2V0dGluZ3M6IHsKICAgIHNoYXJlZDogdm9pZCAwLAogICAgdHJpZ2dlcjogImhvdmVyIiwKICAgIGF4aXNJZDogMCwKICAgIGFjdGl2ZTogZmFsc2UsCiAgICBkZWZhdWx0SW5kZXg6IHZvaWQgMAogIH0KfTsKdmFyIHRvb2x0aXBTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAidG9vbHRpcCIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUzLAogIHJlZHVjZXJzOiB7CiAgICBhZGRUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS50b29sdGlwSXRlbVBheWxvYWRzLmluZGV4T2YoY2FzdERyYWZ0KHByZXYpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkc1tpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnRvb2x0aXBJdGVtUGF5bG9hZHMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNldHRpbmdzID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmdyYXBoaWNhbEl0ZW1JZCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUdyYXBoaWNhbEl0ZW1JZDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIG1vdXNlTGVhdmVDaGFydChzdGF0ZSkgewogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgIH0sCiAgICBtb3VzZUxlYXZlSXRlbShzdGF0ZSkgewogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICB9LAogICAgc2V0QWN0aXZlQ2xpY2tJdGVtSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZ3JhcGhpY2FsSXRlbUlkID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlR3JhcGhpY2FsSXRlbUlkOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0TW91c2VPdmVyQXhpc0luZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0U3luY0ludGVyYWN0aW9uKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRUb29sdGlwRW50cnlTZXR0aW5ncywKICByZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgcmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgc2V0VG9vbHRpcFNldHRpbmdzU3RhdGUsCiAgc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4LAogIG1vdXNlTGVhdmVJdGVtLAogIG1vdXNlTGVhdmVDaGFydCwKICBzZXRBY3RpdmVDbGlja0l0ZW1JbmRleCwKICBzZXRNb3VzZU92ZXJBeGlzSW5kZXgsCiAgc2V0TW91c2VDbGlja0F4aXNJbmRleCwKICBzZXRTeW5jSW50ZXJhY3Rpb24sCiAgc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbgp9ID0gdG9vbHRpcFNsaWNlLmFjdGlvbnM7CnZhciB0b29sdGlwUmVkdWNlciA9IHRvb2x0aXBTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUuanMKZnVuY3Rpb24gb3duS2V5czE0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGNob29zZUFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbih0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpIHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICBpZiAodHJpZ2dlciA9PT0gImNsaWNrIikgewogICAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljazsKICAgIH0KICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyOwogIH0KICBpZiAodHJpZ2dlciA9PT0gImNsaWNrIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2s7CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyOwp9CmZ1bmN0aW9uIGhhc0JlZW5BY3RpdmVQcmV2aW91c2x5KHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKSB7CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmluZGV4ICE9IG51bGw7Cn0KdmFyIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9ICh0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleCkgPT4gewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiBub0ludGVyYWN0aW9uOwogIH0KICB2YXIgYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uID0gY2hvb3NlQXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcik7CiAgaWYgKGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gbm9JbnRlcmFjdGlvbjsKICB9CiAgaWYgKGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgIHJldHVybiBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb247CiAgfQogIGlmICh0b29sdGlwU3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbjsKICB9CiAgaWYgKHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlICYmIHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb24uaW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb247CiAgfQogIHZhciBhY3RpdmVGcm9tUHJvcHMgPSB0b29sdGlwU3RhdGUuc2V0dGluZ3MuYWN0aXZlID09PSB0cnVlOwogIGlmIChoYXNCZWVuQWN0aXZlUHJldmlvdXNseShhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24pKSB7CiAgICBpZiAoYWN0aXZlRnJvbVByb3BzKSB7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTQoX29iamVjdFNwcmVhZDE0KHt9LCBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24pLCB7fSwgewogICAgICAgIGFjdGl2ZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGRlZmF1bHRJbmRleCAhPSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICBhY3RpdmU6IHRydWUsCiAgICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgICAgZGF0YUtleTogdm9pZCAwLAogICAgICBpbmRleDogZGVmYXVsdEluZGV4LAogICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgfTsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNChfb2JqZWN0U3ByZWFkMTQoe30sIG5vSW50ZXJhY3Rpb24pLCB7fSwgewogICAgY29vcmRpbmF0ZTogYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uLmNvb3JkaW5hdGUKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleC5qcwpmdW5jdGlvbiB0b0Zpbml0ZU51bWJlcih2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHZhbHVlKSA/IHZhbHVlIDogdm9pZCAwOwogIH0KICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbnVtZXJpY1ZhbHVlID0gdmFsdWUudmFsdWVPZigpOwogICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShudW1lcmljVmFsdWUpID8gbnVtZXJpY1ZhbHVlIDogdm9pZCAwOwogIH0KICB2YXIgcGFyc2VkID0gTnVtYmVyKHZhbHVlKTsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHBhcnNlZCkgPyBwYXJzZWQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gaXNWYWx1ZVdpdGhpbk51bWJlckRvbWFpbih2YWx1ZSwgZG9tYWluKSB7CiAgdmFyIG51bWVyaWNWYWx1ZSA9IHRvRmluaXRlTnVtYmVyKHZhbHVlKTsKICB2YXIgbG93ZXJCb3VuZCA9IGRvbWFpblswXTsKICB2YXIgdXBwZXJCb3VuZCA9IGRvbWFpblsxXTsKICBpZiAobnVtZXJpY1ZhbHVlID09PSB2b2lkIDApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihsb3dlckJvdW5kLCB1cHBlckJvdW5kKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KGxvd2VyQm91bmQsIHVwcGVyQm91bmQpOwogIHJldHVybiBudW1lcmljVmFsdWUgPj0gbWluMiAmJiBudW1lcmljVmFsdWUgPD0gbWF4MjsKfQpmdW5jdGlvbiBpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSB7CiAgaWYgKGRvbWFpbiA9PSBudWxsIHx8IGF4aXNEYXRhS2V5ID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgYXhpc0RhdGFLZXkpOwogIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKCFpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBpc1ZhbHVlV2l0aGluTnVtYmVyRG9tYWluKHZhbHVlLCBkb21haW4pOwp9CnZhciBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4ID0gKHRvb2x0aXBJbnRlcmFjdGlvbiwgY2hhcnREYXRhLCBheGlzRGF0YUtleSwgZG9tYWluKSA9PiB7CiAgdmFyIGRlc2lyZWRJbmRleCA9IHRvb2x0aXBJbnRlcmFjdGlvbiA9PT0gbnVsbCB8fCB0b29sdGlwSW50ZXJhY3Rpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBJbnRlcmFjdGlvbi5pbmRleDsKICBpZiAoZGVzaXJlZEluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaW5kZXhBc051bWJlciA9IE51bWJlcihkZXNpcmVkSW5kZXgpOwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihpbmRleEFzTnVtYmVyKSkgewogICAgcmV0dXJuIGRlc2lyZWRJbmRleDsKICB9CiAgdmFyIGxvd2VyTGltaXQgPSAwOwogIHZhciB1cHBlckxpbWl0ID0gSW5maW5pdHk7CiAgaWYgKGNoYXJ0RGF0YS5sZW5ndGggPiAwKSB7CiAgICB1cHBlckxpbWl0ID0gY2hhcnREYXRhLmxlbmd0aCAtIDE7CiAgfQogIHZhciBjbGFtcGVkSW5kZXggPSBNYXRoLm1heChsb3dlckxpbWl0LCBNYXRoLm1pbihpbmRleEFzTnVtYmVyLCB1cHBlckxpbWl0KSk7CiAgdmFyIGVudHJ5ID0gY2hhcnREYXRhW2NsYW1wZWRJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKICB9CiAgaWYgKCFpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXguanMKdmFyIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gKHdpZHRoLCBoZWlnaHQsIGxheW91dCwgb2Zmc2V0LCB0b29sdGlwVGlja3MsIGRlZmF1bHRJbmRleCwgdG9vbHRpcENvbmZpZ3VyYXRpb25zLCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKSA9PiB7CiAgaWYgKGRlZmF1bHRJbmRleCA9PSBudWxsIHx8IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGZpcnN0Q29uZmlndXJhdGlvbiA9IHRvb2x0aXBDb25maWd1cmF0aW9uc1swXTsKICB2YXIgbWF5YmVQb3NpdGlvbiA9IGZpcnN0Q29uZmlndXJhdGlvbiA9PSBudWxsID8gdm9pZCAwIDogdG9vbHRpcFBheWxvYWRTZWFyY2hlcihmaXJzdENvbmZpZ3VyYXRpb24ucG9zaXRpb25zLCBkZWZhdWx0SW5kZXgpOwogIGlmIChtYXliZVBvc2l0aW9uICE9IG51bGwpIHsKICAgIHJldHVybiBtYXliZVBvc2l0aW9uOwogIH0KICB2YXIgdGljayA9IHRvb2x0aXBUaWNrcyA9PT0gbnVsbCB8fCB0b29sdGlwVGlja3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBUaWNrc1tOdW1iZXIoZGVmYXVsdEluZGV4KV07CiAgaWYgKCF0aWNrKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBzd2l0Y2ggKGxheW91dCkgewogICAgY2FzZSAiaG9yaXpvbnRhbCI6IHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB0aWNrLmNvb3JkaW5hdGUsCiAgICAgICAgeTogKG9mZnNldC50b3AgKyBoZWlnaHQpIC8gMgogICAgICB9OwogICAgfQogICAgZGVmYXVsdDogewogICAgICByZXR1cm4gewogICAgICAgIHg6IChvZmZzZXQubGVmdCArIHdpZHRoKSAvIDIsCiAgICAgICAgeTogdGljay5jb29yZGluYXRlCiAgICAgIH07CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucy5qcwp2YXIgY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSAodG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHM7CiAgfQogIGlmICh0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgdmFyIGZpbHRlckJ5RGF0YUtleTsKICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgZmlsdGVyQnlEYXRhS2V5ID0gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogIH0gZWxzZSB7CiAgICBmaWx0ZXJCeURhdGFLZXkgPSB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7CiAgfQogIGlmIChmaWx0ZXJCeURhdGFLZXkgPT0gbnVsbCAmJiBkZWZhdWx0SW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIFt0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkc1swXV07CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5maWx0ZXIoKHRwYykgPT4gewogICAgdmFyIF90cGMkc2V0dGluZ3M7CiAgICByZXR1cm4gKChfdHBjJHNldHRpbmdzID0gdHBjLnNldHRpbmdzKSA9PT0gbnVsbCB8fCBfdHBjJHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdHBjJHNldHRpbmdzLmRhdGFLZXkpID09PSBmaWx0ZXJCeURhdGFLZXk7CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlci5qcwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy50b29sdGlwUGF5bG9hZFNlYXJjaGVyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTdGF0ZS5qcwp2YXIgc2VsZWN0VG9vbHRpcFN0YXRlID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcFBheWxvYWQuanMKZnVuY3Rpb24gb3duS2V5czE1KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTUoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTUocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHNlbGVjdEZpbmFsRGF0YShkYXRhRGVmaW5lZE9uSXRlbSwgZGF0YURlZmluZWRPbkNoYXJ0KSB7CiAgaWYgKGRhdGFEZWZpbmVkT25JdGVtICE9IG51bGwpIHsKICAgIHJldHVybiBkYXRhRGVmaW5lZE9uSXRlbTsKICB9CiAgcmV0dXJuIGRhdGFEZWZpbmVkT25DaGFydDsKfQp2YXIgY29tYmluZVRvb2x0aXBQYXlsb2FkID0gKHRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIGFjdGl2ZUluZGV4LCBjaGFydERhdGFTdGF0ZSwgdG9vbHRpcEF4aXNEYXRhS2V5LCBhY3RpdmVMYWJlbCwgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwgdG9vbHRpcEV2ZW50VHlwZSkgPT4gewogIGlmIChhY3RpdmVJbmRleCA9PSBudWxsIHx8IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSwKICAgIGNvbXB1dGVkRGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IGNoYXJ0RGF0YVN0YXRlOwogIHZhciBpbml0ID0gW107CiAgcmV0dXJuIHRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMucmVkdWNlKChhZ2csIF9yZWYyKSA9PiB7CiAgICB2YXIgX3NldHRpbmdzJGRhdGFLZXk7CiAgICB2YXIgewogICAgICBkYXRhRGVmaW5lZE9uSXRlbSwKICAgICAgc2V0dGluZ3MKICAgIH0gPSBfcmVmMjsKICAgIHZhciBmaW5hbERhdGEgPSBzZWxlY3RGaW5hbERhdGEoZGF0YURlZmluZWRPbkl0ZW0sIGNoYXJ0RGF0YSk7CiAgICB2YXIgc2xpY2VkID0gQXJyYXkuaXNBcnJheShmaW5hbERhdGEpID8gZ2V0U2xpY2VkKGZpbmFsRGF0YSwgZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCkgOiBmaW5hbERhdGE7CiAgICB2YXIgZmluYWxEYXRhS2V5ID0gKF9zZXR0aW5ncyRkYXRhS2V5ID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9zZXR0aW5ncyRkYXRhS2V5ICE9PSB2b2lkIDAgPyBfc2V0dGluZ3MkZGF0YUtleSA6IHRvb2x0aXBBeGlzRGF0YUtleTsKICAgIHZhciBmaW5hbE5hbWVLZXkgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MubmFtZUtleTsKICAgIHZhciB0b29sdGlwUGF5bG9hZDsKICAgIGlmICh0b29sdGlwQXhpc0RhdGFLZXkgJiYgQXJyYXkuaXNBcnJheShzbGljZWQpICYmIC8qCiAgICAgKiBmaW5kRW50cnlJbkFycmF5IHdvbid0IHdvcmsgZm9yIFNjYXR0ZXIgYmVjYXVzZSBTY2F0dGVyIHByb3ZpZGVzIGFuIGFycmF5IG9mIGFycmF5cwogICAgICogYXMgdG9vbHRpcCBwYXlsb2FkcyBhbmQgZmluZEVudHJ5SW5BcnJheSBpcyBub3QgcHJlcGFyZWQgdG8gaGFuZGxlIHRoYXQuCiAgICAgKiBTYWQgYnV0IGFsc28gU2NhdHRlckNoYXJ0IG9ubHkgYWxsb3dzICdpdGVtJyB0b29sdGlwRXZlbnRUeXBlCiAgICAgKiBhbmQgYWxzbyB0aGlzIGlzIG9ubHkgYSBwcm9ibGVtIGlmIHRoZXJlIGFyZSBtdWx0aXBsZSBTY2F0dGVycyBhbmQgZWFjaCBoYXMgaXRzIG93biBkYXRhIGFycmF5CiAgICAgKiBzbyBsZXQncyBmaXggdGhhdCBzb21lIG90aGVyIHRpbWUuCiAgICAgKi8KICAgICFBcnJheS5pc0FycmF5KHNsaWNlZFswXSkgJiYgLyoKICAgICAqIElmIHRoZSB0b29sdGlwRXZlbnRUeXBlIGlzICdheGlzJywgd2Ugc2hvdWxkIHNlYXJjaCBmb3IgdGhlIGRhdGFLZXkgaW4gdGhlIHNsaWNlZCBkYXRhCiAgICAgKiBiZWNhdXNlIHRoYW5rcyB0byBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeT1mYWxzZSwgdGhlIG9yZGVyIG9mIGVsZW1lbnRzIGluIHRoZSBhcnJheQogICAgICogbm8gbG9uZ2VyIG1hdGNoZXMgdGhlIG9yZGVyIG9mIGVsZW1lbnRzIGluIHRoZSBvcmlnaW5hbCBkYXRhCiAgICAgKiBhbmQgc28gd2UgbmVlZCB0byBzZWFyY2ggYnkgdGhlIGFjdGl2ZSBkYXRhS2V5ICsgbGFiZWwgcmF0aGVyIHRoYW4gYnkgaW5kZXguCiAgICAgKgogICAgICogVGhlIHNhbWUgaGFwcGVucyBpZiBtdWx0aXBsZSBncmFwaGljYWwgaXRlbXMgYXJlIHByZXNlbnQgaW4gdGhlIGNoYXJ0CiAgICAgKiBhbmQgZWFjaCBvZiB0aGVtIGhhcyBpdHMgb3duIGRhdGEgYXJyYXkuIFRob3NlIGFycmF5cyBnZXQgY29uY2F0ZW5hdGVkCiAgICAgKiBhbmQgYWdhaW4gdGhlIHRvb2x0aXAgaW5kZXggbm8gbG9uZ2VyIG1hdGNoZXMgdGhlIG9yaWdpbmFsIGRhdGEuCiAgICAgKgogICAgICogT24gdGhlIG90aGVyIGhhbmQgdGhlIHRvb2x0aXBFdmVudFR5cGUgJ2l0ZW0nIHNob3VsZCBhbHdheXMgc2VhcmNoIGJ5IGluZGV4CiAgICAgKiBiZWNhdXNlIHdlIGdldCB0aGUgaW5kZXggZnJvbSBpbnRlcmFjdGluZyBvdmVyIHRoZSBpbmRpdmlkdWFsIGVsZW1lbnRzCiAgICAgKiB3aGljaCBpcyBhbHdheXMgYWNjdXJhdGUsIGlycmVzcGVjdGl2ZSBvZiB0aGUgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgc2V0dGluZy4KICAgICAqLwogICAgdG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkID0gZmluZEVudHJ5SW5BcnJheShzbGljZWQsIHRvb2x0aXBBeGlzRGF0YUtleSwgYWN0aXZlTGFiZWwpOwogICAgfSBlbHNlIHsKICAgICAgdG9vbHRpcFBheWxvYWQgPSB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKHNsaWNlZCwgYWN0aXZlSW5kZXgsIGNvbXB1dGVkRGF0YSwgZmluYWxOYW1lS2V5KTsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KHRvb2x0aXBQYXlsb2FkKSkgewogICAgICB0b29sdGlwUGF5bG9hZC5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIG5ld1NldHRpbmdzID0gX29iamVjdFNwcmVhZDE1KF9vYmplY3RTcHJlYWQxNSh7fSwgc2V0dGluZ3MpLCB7fSwgewogICAgICAgICAgbmFtZTogaXRlbS5uYW1lLAogICAgICAgICAgdW5pdDogaXRlbS51bml0LAogICAgICAgICAgLy8gY29sb3IgYW5kIGZpbGwgYXJlIGVyYXNlZCB0byBrZWVwIDEwMCUgdGhlIGlkZW50aWNhbCBiZWhhdmlvdXIgdG8gcmVjaGFydHMgMi54IC0gYnV0IHRoZXJlJ3Mgbm90aGluZyBzdG9wcGluZyB1cyBmcm9tIHJldHVybmluZyB0aGVtIGhlcmUuIEl0J3MgdGVjaG5pY2FsbHkgYSBicmVha2luZyBjaGFuZ2UuCiAgICAgICAgICBjb2xvcjogdm9pZCAwLAogICAgICAgICAgLy8gY29sb3IgYW5kIGZpbGwgYXJlIGVyYXNlZCB0byBrZWVwIDEwMCUgdGhlIGlkZW50aWNhbCBiZWhhdmlvdXIgdG8gcmVjaGFydHMgMi54IC0gYnV0IHRoZXJlJ3Mgbm90aGluZyBzdG9wcGluZyB1cyBmcm9tIHJldHVybmluZyB0aGVtIGhlcmUuIEl0J3MgdGVjaG5pY2FsbHkgYSBicmVha2luZyBjaGFuZ2UuCiAgICAgICAgICBmaWxsOiB2b2lkIDAKICAgICAgICB9KTsKICAgICAgICBhZ2cucHVzaChnZXRUb29sdGlwRW50cnkoewogICAgICAgICAgdG9vbHRpcEVudHJ5U2V0dGluZ3M6IG5ld1NldHRpbmdzLAogICAgICAgICAgZGF0YUtleTogaXRlbS5kYXRhS2V5LAogICAgICAgICAgcGF5bG9hZDogaXRlbS5wYXlsb2FkLAogICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRWYWx1ZUJ5RGF0YUtleSBkb2VzIG5vdCB2YWxpZGF0ZSB0aGUgb3V0cHV0IHR5cGUKICAgICAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLnBheWxvYWQsIGl0ZW0uZGF0YUtleSksCiAgICAgICAgICBuYW1lOiBpdGVtLm5hbWUKICAgICAgICB9KSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIF9nZXRWYWx1ZUJ5RGF0YUtleTsKICAgICAgYWdnLnB1c2goZ2V0VG9vbHRpcEVudHJ5KHsKICAgICAgICB0b29sdGlwRW50cnlTZXR0aW5nczogc2V0dGluZ3MsCiAgICAgICAgZGF0YUtleTogZmluYWxEYXRhS2V5LAogICAgICAgIHBheWxvYWQ6IHRvb2x0aXBQYXlsb2FkLAogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KHRvb2x0aXBQYXlsb2FkLCBmaW5hbERhdGFLZXkpLAogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgbmFtZTogKF9nZXRWYWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KHRvb2x0aXBQYXlsb2FkLCBmaW5hbE5hbWVLZXkpKSAhPT0gbnVsbCAmJiBfZ2V0VmFsdWVCeURhdGFLZXkgIT09IHZvaWQgMCA/IF9nZXRWYWx1ZUJ5RGF0YUtleSA6IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5uYW1lCiAgICAgIH0pKTsKICAgIH0KICAgIHJldHVybiBhZ2c7CiAgfSwgaW5pdCk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvdG9vbHRpcFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0SGFzQmFyLCBzZWxlY3RDaGFydE5hbWUsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVSZWFsU2NhbGVUeXBlKTsKdmFyIHNlbGVjdEFsbFVuZmlsdGVyZWRHcmFwaGljYWxJdGVtcyA9IGNyZWF0ZVNlbGVjdG9yKFsoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zLCAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXNdLCAoY2FydGVzaWFuSXRlbXMsIHBvbGFySXRlbXMpID0+IFsuLi5jYXJ0ZXNpYW5JdGVtcywgLi4ucG9sYXJJdGVtc10pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNQcmVkaWNhdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgaXRlbUF4aXNQcmVkaWNhdGUpOwp2YXIgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxVbmZpbHRlcmVkR3JhcGhpY2FsSXRlbXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1ByZWRpY2F0ZV0sIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgKGdyYXBoaWNhbEl0ZW1zKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoaXNTdGFja2VkKSk7CnZhciBzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc10sIGNvbWJpbmVEaXNwbGF5ZWREYXRhKTsKdmFyIHNlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzXSwgY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKTsKdmFyIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVBcHBsaWVkVmFsdWVzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIGdldERvbWFpbkRlZmluaXRpb24pOwp2YXIgc2VsZWN0VG9vbHRpcERhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBzZWxlY3RUb29sdGlwRG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24sIHNlbGVjdFRvb2x0aXBEYXRhT3ZlcmZsb3ddLCBudW1lcmljYWxEb21haW5TcGVjaWZpZWRXaXRob3V0UmVxdWlyaW5nRGF0YSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIChncmFwaGljYWxJdGVtcykgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGlzU3RhY2tlZCkpOwp2YXIgc2VsZWN0VG9vbHRpcFN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSwgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFJldmVyc2VTdGFja09yZGVyXSwgY29tYmluZVN0YWNrR3JvdXBzKTsKdmFyIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXNdLCBjb21iaW5lRG9tYWluT2ZTdGFja0dyb3Vwcyk7CnZhciBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyk7CnZhciBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VEb3RzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRG90c0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VBcmVhc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVBcmVhc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUFyZWFzRG9tYWluXSwgbWVyZ2VEb21haW5zKTsKdmFyIHNlbGVjdFRvb2x0aXBOdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXMsIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzLCBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIsIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwTnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcE5pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluLCBzZWxlY3RUb29sdGlwTmljZVRpY2tzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHZhciBpc1Bhbm9yYW1hID0gZmFsc2U7CiAgcmV0dXJuIHNlbGVjdEF4aXNSYW5nZShzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7Cn07CnZhciBzZWxlY3RUb29sdGlwQXhpc1JhbmdlV2l0aFJldmVyc2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcywgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRHVwbGljYXRlRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgY29tYmluZVRpY2tzT2ZUb29sdGlwQXhpcyA9IChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCByYW5nZTQsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAhPSBudWxsICYmIChyYW5nZTQgPT09IG51bGwgfHwgcmFuZ2U0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByYW5nZTQubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSwgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0VG9vbHRpcENhdGVnb3JpY2FsRG9tYWluLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lVGlja3NPZlRvb2x0aXBBeGlzKTsKdmFyIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLCBzZWxlY3RUb29sdGlwU2V0dGluZ3NdLCAoZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSwgc2V0dGluZ3MpID0+IGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNldHRpbmdzLnNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSkpOwp2YXIgc2VsZWN0VG9vbHRpcFRyaWdnZXIgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MudHJpZ2dlcjsKdmFyIHNlbGVjdERlZmF1bHRJbmRleCA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5kZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyLCBzZWxlY3RUb29sdGlwVHJpZ2dlciwgc2VsZWN0RGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZUxhYmVsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleF0sIGNvbWJpbmVBY3RpdmVMYWJlbCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb24pID0+IHsKICBpZiAoIXRvb2x0aXBJbnRlcmFjdGlvbikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvbi5kYXRhS2V5Owp9KTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBHcmFwaGljYWxJdGVtSWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uKSA9PiB7CiAgaWYgKCF0b29sdGlwSW50ZXJhY3Rpb24pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb24uZ3JhcGhpY2FsSXRlbUlkOwp9KTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiwgc2VsZWN0VG9vbHRpcFRyaWdnZXIsIHNlbGVjdERlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0RGVmYXVsdEluZGV4LCBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyXSwgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcENvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBkZWZhdWx0SW5kZXhDb29yZGluYXRlKSA9PiB7CiAgaWYgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSBudWxsICYmIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSB2b2lkIDAgJiYgdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZSkgewogICAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGU7CiAgfQogIHJldHVybiBkZWZhdWx0SW5kZXhDb29yZGluYXRlOwp9KTsKdmFyIHNlbGVjdElzVG9vbHRpcEFjdGl2ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgPT4gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuYWN0aXZlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyXSwgY29tYmluZVRvb2x0aXBQYXlsb2FkKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkXSwgKHBheWxvYWQpID0+IHsKICBpZiAocGF5bG9hZCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZGF0YVBvaW50cyA9IHBheWxvYWQubWFwKChwKSA9PiBwLnBheWxvYWQpLmZpbHRlcigocCkgPT4gcCAhPSBudWxsKTsKICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGRhdGFQb2ludHMpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L3VzZVRvb2x0aXBBeGlzLmpzCmZ1bmN0aW9uIG93bktleXMxNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgdXNlVG9vbHRpcEF4aXMgPSAoKSA9PiB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpcyk7CnZhciB1c2VUb29sdGlwQXhpc0JhbmRTaXplID0gKCkgPT4gewogIHZhciB0b29sdGlwQXhpcyA9IHVzZVRvb2x0aXBBeGlzKCk7CiAgdmFyIHRvb2x0aXBUaWNrcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MpOwogIHZhciB0b29sdGlwQXhpc1NjYWxlID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSk7CiAgaWYgKCF0b29sdGlwQXhpcyB8fCAhdG9vbHRpcEF4aXNTY2FsZSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHZvaWQgMCwgdG9vbHRpcFRpY2tzKTsKICB9CiAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKF9vYmplY3RTcHJlYWQxNihfb2JqZWN0U3ByZWFkMTYoe30sIHRvb2x0aXBBeGlzKSwge30sIHsKICAgIHNjYWxlOiB0b29sdGlwQXhpc1NjYWxlCiAgfSksIHRvb2x0aXBUaWNrcyk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfc29ydEJ5NCA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRBY3RpdmVDb29yZGluYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZ2V0QWN0aXZlQ2FydGVzaWFuQ29vcmRpbmF0ZSA9IChsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHBvaW50ZXIpID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBlbnRyeS5jb29yZGluYXRlLAogICAgICAgIHk6IHBvaW50ZXIuY2hhcnRZCiAgICAgIH07CiAgICB9CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogcG9pbnRlci5jaGFydFgsCiAgICAgICAgeTogZW50cnkuY29vcmRpbmF0ZQogICAgICB9OwogICAgfQogIH0KICByZXR1cm4gewogICAgeDogMCwKICAgIHk6IDAKICB9Owp9Owp2YXIgZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlID0gKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgICAgdmFyIF9hbmdsZSA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICAgIHZhciB7CiAgICAgICAgcmFkaXVzOiBfcmFkaXVzCiAgICAgIH0gPSByYW5nZU9iajsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KHt9LCByYW5nZU9iaiksIHBvbGFyVG9DYXJ0ZXNpYW4ocmFuZ2VPYmouY3gsIHJhbmdlT2JqLmN5LCBfcmFkaXVzLCBfYW5nbGUpKSwge30sIHsKICAgICAgICBhbmdsZTogX2FuZ2xlLAogICAgICAgIHJhZGl1czogX3JhZGl1cwogICAgICB9KTsKICAgIH0KICAgIHZhciByYWRpdXMgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIHsKICAgICAgYW5nbGUKICAgIH0gPSByYW5nZU9iajsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyh7fSwgcmFuZ2VPYmopLCBwb2xhclRvQ2FydGVzaWFuKHJhbmdlT2JqLmN4LCByYW5nZU9iai5jeSwgcmFkaXVzLCBhbmdsZSkpLCB7fSwgewogICAgICBhbmdsZSwKICAgICAgcmFkaXVzCiAgICB9KTsKICB9CiAgcmV0dXJuIHsKICAgIGFuZ2xlOiAwLAogICAgY2xvY2tXaXNlOiBmYWxzZSwKICAgIGN4OiAwLAogICAgY3k6IDAsCiAgICBlbmRBbmdsZTogMCwKICAgIGlubmVyUmFkaXVzOiAwLAogICAgb3V0ZXJSYWRpdXM6IDAsCiAgICByYWRpdXM6IDAsCiAgICBzdGFydEFuZ2xlOiAwLAogICAgeDogMCwKICAgIHk6IDAKICB9Owp9OwpmdW5jdGlvbiBpc0luQ2FydGVzaWFuUmFuZ2UocG9pbnRlciwgb2Zmc2V0KSB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IHBvaW50ZXI7CiAgcmV0dXJuIHgyID49IG9mZnNldC5sZWZ0ICYmIHgyIDw9IG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoICYmIHkyID49IG9mZnNldC50b3AgJiYgeTIgPD0gb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQ7Cn0KdmFyIGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleCA9IChjb29yZGluYXRlLCB0aWNrczIsIHVuc29ydGVkVGlja3MsIGF4aXNUeXBlLCByYW5nZTQpID0+IHsKICB2YXIgX3RpY2tzJGxlbmd0aDsKICB2YXIgaW5kZXggPSAtMTsKICB2YXIgbGVuID0gKF90aWNrcyRsZW5ndGggPSB0aWNrczIgPT09IG51bGwgfHwgdGlja3MyID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0aWNrczIubGVuZ3RoKSAhPT0gbnVsbCAmJiBfdGlja3MkbGVuZ3RoICE9PSB2b2lkIDAgPyBfdGlja3MkbGVuZ3RoIDogMDsKICBpZiAobGVuIDw9IDEgfHwgY29vcmRpbmF0ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgIT0gbnVsbCAmJiBNYXRoLmFicyhNYXRoLmFicyhyYW5nZTRbMV0gLSByYW5nZTRbMF0pIC0gMzYwKSA8PSAxZS02KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBiZWZvcmUgPSBpID4gMCA/IHVuc29ydGVkVGlja3NbaSAtIDFdLmNvb3JkaW5hdGUgOiB1bnNvcnRlZFRpY2tzW2xlbiAtIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBjdXIgPSB1bnNvcnRlZFRpY2tzW2ldLmNvb3JkaW5hdGU7CiAgICAgIHZhciBhZnRlciA9IGkgPj0gbGVuIC0gMSA/IHVuc29ydGVkVGlja3NbMF0uY29vcmRpbmF0ZSA6IHVuc29ydGVkVGlja3NbaSArIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBzYW1lRGlyZWN0aW9uQ29vcmQgPSB2b2lkIDA7CiAgICAgIGlmIChtYXRoU2lnbihjdXIgLSBiZWZvcmUpICE9PSBtYXRoU2lnbihhZnRlciAtIGN1cikpIHsKICAgICAgICB2YXIgZGlmZkludGVydmFsID0gW107CiAgICAgICAgaWYgKG1hdGhTaWduKGFmdGVyIC0gY3VyKSA9PT0gbWF0aFNpZ24ocmFuZ2U0WzFdIC0gcmFuZ2U0WzBdKSkgewogICAgICAgICAgc2FtZURpcmVjdGlvbkNvb3JkID0gYWZ0ZXI7CiAgICAgICAgICB2YXIgY3VySW5SYW5nZSA9IGN1ciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ckluUmFuZ2UsIChjdXJJblJhbmdlICsgYmVmb3JlKSAvIDIpOwogICAgICAgICAgZGlmZkludGVydmFsWzFdID0gTWF0aC5tYXgoY3VySW5SYW5nZSwgKGN1ckluUmFuZ2UgKyBiZWZvcmUpIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNhbWVEaXJlY3Rpb25Db29yZCA9IGJlZm9yZTsKICAgICAgICAgIHZhciBhZnRlckluUmFuZ2UgPSBhZnRlciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFsxXSA9IE1hdGgubWF4KGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNhbWVJbnRlcnZhbCA9IFtNYXRoLm1pbihjdXIsIChzYW1lRGlyZWN0aW9uQ29vcmQgKyBjdXIpIC8gMiksIE1hdGgubWF4KGN1ciwgKHNhbWVEaXJlY3Rpb25Db29yZCArIGN1cikgLyAyKV07CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiBzYW1lSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBzYW1lSW50ZXJ2YWxbMV0gfHwgY29vcmRpbmF0ZSA+PSBkaWZmSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBkaWZmSW50ZXJ2YWxbMV0pIHsKICAgICAgICAgICh7CiAgICAgICAgICAgIGluZGV4CiAgICAgICAgICB9ID0gdW5zb3J0ZWRUaWNrc1tpXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4oYmVmb3JlLCBhZnRlcik7CiAgICAgICAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgoYmVmb3JlLCBhZnRlcik7CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiAobWluVmFsdWUgKyBjdXIpIC8gMiAmJiBjb29yZGluYXRlIDw9IChtYXhWYWx1ZSArIGN1cikgLyAyKSB7CiAgICAgICAgICAoewogICAgICAgICAgICBpbmRleAogICAgICAgICAgfSA9IHVuc29ydGVkVGlja3NbaV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICh0aWNrczIpIHsKICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBsZW47IF9pKyspIHsKICAgICAgaWYgKF9pID09PSAwICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA+IDAgJiYgX2kgPCBsZW4gLSAxICYmIGNvb3JkaW5hdGUgPiAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pIC0gMV0uY29vcmRpbmF0ZSkgLyAyICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA9PT0gbGVuIC0gMSAmJiBjb29yZGluYXRlID4gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSAtIDFdLmNvb3JkaW5hdGUpIC8gMikgewogICAgICAgICh7CiAgICAgICAgICBpbmRleAogICAgICAgIH0gPSB0aWNrczJbX2ldKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gaW5kZXg7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0b3JzLmpzCnZhciB1c2VDaGFydE5hbWUgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0TmFtZSk7Cn07CnZhciBwaWNrVG9vbHRpcEV2ZW50VHlwZSA9IChfc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUpID0+IHRvb2x0aXBFdmVudFR5cGU7CnZhciBwaWNrVHJpZ2dlciA9IChfc3RhdGUsIF90b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSA9PiB0cmlnZ2VyOwp2YXIgcGlja0RlZmF1bHRJbmRleCA9IChfc3RhdGUsIF90b29sdGlwRXZlbnRUeXBlLCBfdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiBkZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RPcmRlcmVkVG9vbHRpcFRpY2tzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgKHRpY2tzMikgPT4gKDAsIGltcG9ydF9zb3J0Qnk0LmRlZmF1bHQpKHRpY2tzMiwgKG8pID0+IG8uY29vcmRpbmF0ZSkpOwp2YXIgc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgcGlja1Rvb2x0aXBFdmVudFR5cGUsIHBpY2tUcmlnZ2VyLCBwaWNrRGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZUluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdFRvb2x0aXBEYXRhS2V5ID0gKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHRvb2x0aXBTdGF0ZSA9IHNlbGVjdFRvb2x0aXBTdGF0ZShzdGF0ZSk7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICAgIH0KICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7CiAgfQogIGlmICh0cmlnZ2VyID09PSAiaG92ZXIiKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5Owp9Owp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBwaWNrVG9vbHRpcEV2ZW50VHlwZSwgcGlja1RyaWdnZXIsIHBpY2tEZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyk7CnZhciBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgcGlja0RlZmF1bHRJbmRleCwgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXJdLCBjb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCk7CnZhciBzZWxlY3RBY3RpdmVDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgZGVmYXVsdEluZGV4Q29vcmRpbmF0ZSkgPT4gewogIHZhciBfdG9vbHRpcEludGVyYWN0aW9uU3Q7CiAgcmV0dXJuIChfdG9vbHRpcEludGVyYWN0aW9uU3QgPSB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5jb29yZGluYXRlKSAhPT0gbnVsbCAmJiBfdG9vbHRpcEludGVyYWN0aW9uU3QgIT09IHZvaWQgMCA/IF90b29sdGlwSW50ZXJhY3Rpb25TdCA6IGRlZmF1bHRJbmRleENvb3JkaW5hdGU7Cn0pOwp2YXIgc2VsZWN0QWN0aXZlTGFiZWwyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZUluZGV4XSwgY29tYmluZUFjdGl2ZUxhYmVsKTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyLCBzZWxlY3RBY3RpdmVJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwyLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCBwaWNrVG9vbHRpcEV2ZW50VHlwZV0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZCk7CnZhciBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0QWN0aXZlSW5kZXhdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIGFjdGl2ZUluZGV4KSA9PiB7CiAgcmV0dXJuIHsKICAgIGlzQWN0aXZlOiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5hY3RpdmUgJiYgYWN0aXZlSW5kZXggIT0gbnVsbCwKICAgIGFjdGl2ZUluZGV4CiAgfTsKfSk7CnZhciBjb21iaW5lQWN0aXZlQ2FydGVzaWFuUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKCFpc0luQ2FydGVzaWFuUmFuZ2UoY2hhcnRFdmVudCwgb2Zmc2V0KSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHBvcyA9IGNhbGN1bGF0ZUNhcnRlc2lhblRvb2x0aXBQb3MoY2hhcnRFdmVudCwgbGF5b3V0KTsKICB2YXIgYWN0aXZlSW5kZXggPSBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXgocG9zLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCB0b29sdGlwVGlja3MsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSk7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBnZXRBY3RpdmVDYXJ0ZXNpYW5Db29yZGluYXRlKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgY2hhcnRFdmVudCk7CiAgcmV0dXJuIHsKICAgIGFjdGl2ZUluZGV4OiBTdHJpbmcoYWN0aXZlSW5kZXgpLAogICAgYWN0aXZlQ29vcmRpbmF0ZQogIH07Cn07CnZhciBjb21iaW5lQWN0aXZlUG9sYXJQcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzIHx8ICFwb2xhclZpZXdCb3gpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciByYW5nZU9iaiA9IGluUmFuZ2VPZlNlY3RvcihjaGFydEV2ZW50LCBwb2xhclZpZXdCb3gpOwogIGlmICghcmFuZ2VPYmopIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBwb3MgPSBjYWxjdWxhdGVQb2xhclRvb2x0aXBQb3MocmFuZ2VPYmosIGxheW91dCk7CiAgdmFyIGFjdGl2ZUluZGV4ID0gY2FsY3VsYXRlQWN0aXZlVGlja0luZGV4KHBvcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgdG9vbHRpcFRpY2tzLCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UpOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopOwogIHJldHVybiB7CiAgICBhY3RpdmVJbmRleDogU3RyaW5nKGFjdGl2ZUluZGV4KSwKICAgIGFjdGl2ZUNvb3JkaW5hdGUKICB9Owp9Owp2YXIgY29tYmluZUFjdGl2ZVByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICFsYXlvdXQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gY29tYmluZUFjdGl2ZUNhcnRlc2lhblByb3BzKGNoYXJ0RXZlbnQsIGxheW91dCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCk7CiAgfQogIHJldHVybiBjb21iaW5lQWN0aXZlUG9sYXJQcm9wcyhjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCnZhciBpbXBvcnRfcmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdF9kb20gPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L3pJbmRleFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WkluZGV4UG9ydGFsSWQgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnpJbmRleC56SW5kZXhNYXAsIChfLCB6SW5kZXgpID0+IHpJbmRleCwgKF8sIF96SW5kZXgsIGlzUGFub3JhbWEpID0+IGlzUGFub3JhbWEsICh6SW5kZXhNYXAsIHpJbmRleCwgaXNQYW5vcmFtYSkgPT4gewogIGlmICh6SW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGVudHJ5ID0gekluZGV4TWFwW3pJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gZW50cnkucGFub3JhbWFFbGVtZW50SWQ7CiAgfQogIHJldHVybiBlbnRyeS5lbGVtZW50SWQ7Cn0pOwp2YXIgc2VsZWN0QWxsUmVnaXN0ZXJlZFpJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS56SW5kZXguekluZGV4TWFwLCAoekluZGV4TWFwKSA9PiB7CiAgdmFyIGFsbE51bWJlcnMgPSBPYmplY3Qua2V5cyh6SW5kZXhNYXApLm1hcCgoekluZGV4U3RyKSA9PiBwYXJzZUludCh6SW5kZXhTdHIsIDEwKSkuY29uY2F0KE9iamVjdC52YWx1ZXMoRGVmYXVsdFpJbmRleGVzKSk7CiAgdmFyIHVuaXF1ZU51bWJlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQoYWxsTnVtYmVycykpOwogIHJldHVybiB1bmlxdWVOdW1iZXJzLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBhcnJheUNvbnRlbnRzQXJlRXF1YWxDaGVjawogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS96SW5kZXhTbGljZS5qcwpmdW5jdGlvbiBvd25LZXlzMTgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxOChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlZWQgPSB7fTsKdmFyIGluaXRpYWxTdGF0ZTQgPSB7CiAgekluZGV4TWFwOiBPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykucmVkdWNlKChhY2MsIGN1cnJlbnQzKSA9PiBfb2JqZWN0U3ByZWFkMTgoX29iamVjdFNwcmVhZDE4KHt9LCBhY2MpLCB7fSwgewogICAgW2N1cnJlbnQzXTogewogICAgICBlbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgY29uc3VtZXJzOiAwCiAgICB9CiAgfSksIHNlZWQpCn07CnZhciBkZWZhdWx0WkluZGV4U2V0ID0gbmV3IFNldChPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykpOwpmdW5jdGlvbiBpc0RlZmF1bHRaSW5kZXgoekluZGV4KSB7CiAgcmV0dXJuIGRlZmF1bHRaSW5kZXhTZXQuaGFzKHpJbmRleCk7Cn0KdmFyIHpJbmRleFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJ6SW5kZXgiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNCwKICByZWR1Y2VyczogewogICAgcmVnaXN0ZXJaSW5kZXhQb3J0YWw6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uY29uc3VtZXJzICs9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdID0gewogICAgICAgICAgICBjb25zdW1lcnM6IDEsCiAgICAgICAgICAgIGVsZW1lbnRJZDogdm9pZCAwLAogICAgICAgICAgICBwYW5vcmFtYUVsZW1lbnRJZDogdm9pZCAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyAtPSAxOwogICAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyA8PSAwICYmICFpc0RlZmF1bHRaSW5kZXgoekluZGV4KSkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuekluZGV4TWFwW3pJbmRleF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlZ2lzdGVyWkluZGV4UG9ydGFsSWQ6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4LAogICAgICAgICAgZWxlbWVudElkLAogICAgICAgICAgaXNQYW5vcmFtYQogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLnBhbm9yYW1hRWxlbWVudElkID0gZWxlbWVudElkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uZWxlbWVudElkID0gZWxlbWVudElkOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XSA9IHsKICAgICAgICAgICAgY29uc3VtZXJzOiAwLAogICAgICAgICAgICBlbGVtZW50SWQ6IGlzUGFub3JhbWEgPyB2b2lkIDAgOiBlbGVtZW50SWQsCiAgICAgICAgICAgIHBhbm9yYW1hRWxlbWVudElkOiBpc1Bhbm9yYW1hID8gZWxlbWVudElkIDogdm9pZCAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQ6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkLmlzUGFub3JhbWEpIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0ucGFub3JhbWFFbGVtZW50SWQgPSB2b2lkIDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5lbGVtZW50SWQgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgcmVnaXN0ZXJaSW5kZXhQb3J0YWwsCiAgdW5yZWdpc3RlclpJbmRleFBvcnRhbCwKICByZWdpc3RlclpJbmRleFBvcnRhbElkLAogIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWxJZAp9ID0gekluZGV4U2xpY2UuYWN0aW9uczsKdmFyIHpJbmRleFJlZHVjZXIgPSB6SW5kZXhTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCmZ1bmN0aW9uIFpJbmRleExheWVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBpc0luQ2hhcnRDb250ZXh0ID0gdXNlSXNJbkNoYXJ0Q29udGV4dCgpOwogIHZhciBzaG91bGRSZW5kZXJJblBvcnRhbCA9IGlzSW5DaGFydENvbnRleHQgJiYgekluZGV4ICE9PSB2b2lkIDAgJiYgekluZGV4ICE9PSAwOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFzaG91bGRSZW5kZXJJblBvcnRhbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIGRpc3BhdGNoKHJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgekluZGV4CiAgICB9KSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaCh1bnJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgICB6SW5kZXgKICAgICAgfSkpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIHpJbmRleCwgc2hvdWxkUmVuZGVySW5Qb3J0YWxdKTsKICB2YXIgcG9ydGFsSWQgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFpJbmRleFBvcnRhbElkKHN0YXRlLCB6SW5kZXgsIGlzUGFub3JhbWEpKTsKICBpZiAoIXNob3VsZFJlbmRlckluUG9ydGFsKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIGlmICghcG9ydGFsSWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgekluZGV4UG9ydGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocG9ydGFsSWQpOwogIGlmICh6SW5kZXhQb3J0YWwpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20uY3JlYXRlUG9ydGFsKShjaGlsZHJlbiwgekluZGV4UG9ydGFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9DdXJzb3IuanMKZnVuY3Rpb24gX2V4dGVuZHM5KCkgewogIHJldHVybiBfZXh0ZW5kczkgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzMTkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxOShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE5KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxOShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxOShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxOShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxOSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gUmVuZGVyQ3Vyc29yKF9yZWYyKSB7CiAgdmFyIHsKICAgIGN1cnNvciwKICAgIGN1cnNvckNvbXAsCiAgICBjdXJzb3JQcm9wcwogIH0gPSBfcmVmMjsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5pc1ZhbGlkRWxlbWVudCkoY3Vyc29yKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuY2xvbmVFbGVtZW50KShjdXJzb3IsIGN1cnNvclByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuY3JlYXRlRWxlbWVudCkoY3Vyc29yQ29tcCwgY3Vyc29yUHJvcHMpOwp9CmZ1bmN0aW9uIEN1cnNvckludGVybmFsKHByb3BzKSB7CiAgdmFyIF9wcm9wcyR6SW5kZXg7CiAgdmFyIHsKICAgIGNvb3JkaW5hdGUsCiAgICBwYXlsb2FkLAogICAgaW5kZXgsCiAgICBvZmZzZXQsCiAgICB0b29sdGlwQXhpc0JhbmRTaXplLAogICAgbGF5b3V0LAogICAgY3Vyc29yLAogICAgdG9vbHRpcEV2ZW50VHlwZSwKICAgIGNoYXJ0TmFtZQogIH0gPSBwcm9wczsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGNvb3JkaW5hdGU7CiAgdmFyIGFjdGl2ZVBheWxvYWQgPSBwYXlsb2FkOwogIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSBpbmRleDsKICBpZiAoIWN1cnNvciB8fCAhYWN0aXZlQ29vcmRpbmF0ZSB8fCBjaGFydE5hbWUgIT09ICJTY2F0dGVyQ2hhcnQiICYmIHRvb2x0aXBFdmVudFR5cGUgIT09ICJheGlzIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByZXN0UHJvcHMsIGN1cnNvckNvbXAsIHByZWZlcnJlZFpJbmRleDsKICBpZiAoY2hhcnROYW1lID09PSAiU2NhdHRlckNoYXJ0IikgewogICAgcmVzdFByb3BzID0gYWN0aXZlQ29vcmRpbmF0ZTsKICAgIGN1cnNvckNvbXAgPSBDcm9zczsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0gZWxzZSBpZiAoY2hhcnROYW1lID09PSAiQmFyQ2hhcnQiKSB7CiAgICByZXN0UHJvcHMgPSBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpOwogICAgY3Vyc29yQ29tcCA9IFJlY3RhbmdsZTsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JSZWN0YW5nbGU7CiAgfSBlbHNlIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGlzUG9sYXJDb29yZGluYXRlKGFjdGl2ZUNvb3JkaW5hdGUpKSB7CiAgICB2YXIgewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0gPSBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSk7CiAgICByZXN0UHJvcHMgPSB7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUsCiAgICAgIGlubmVyUmFkaXVzOiByYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzOiByYWRpdXMKICAgIH07CiAgICBjdXJzb3JDb21wID0gU2VjdG9yOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfSBlbHNlIHsKICAgIHJlc3RQcm9wcyA9IHsKICAgICAgcG9pbnRzOiBnZXRDdXJzb3JQb2ludHMobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQpCiAgICB9OwogICAgY3Vyc29yQ29tcCA9IEN1cnZlOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfQogIHZhciBleHRyYUNsYXNzTmFtZSA9IHR5cGVvZiBjdXJzb3IgPT09ICJvYmplY3QiICYmICJjbGFzc05hbWUiIGluIGN1cnNvciA/IGN1cnNvci5jbGFzc05hbWUgOiB2b2lkIDA7CiAgdmFyIGN1cnNvclByb3BzID0gX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOShfb2JqZWN0U3ByZWFkMTkoX29iamVjdFNwcmVhZDE5KHsKICAgIHN0cm9rZTogIiNjY2MiLAogICAgcG9pbnRlckV2ZW50czogIm5vbmUiCiAgfSwgb2Zmc2V0KSwgcmVzdFByb3BzKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oY3Vyc29yKSksIHt9LCB7CiAgICBwYXlsb2FkOiBhY3RpdmVQYXlsb2FkLAogICAgcGF5bG9hZEluZGV4OiBhY3RpdmVUb29sdGlwSW5kZXgsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXRvb2x0aXAtY3Vyc29yIiwgZXh0cmFDbGFzc05hbWUpCiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogKF9wcm9wcyR6SW5kZXggPSBwcm9wcy56SW5kZXgpICE9PSBudWxsICYmIF9wcm9wcyR6SW5kZXggIT09IHZvaWQgMCA/IF9wcm9wcyR6SW5kZXggOiBwcmVmZXJyZWRaSW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KFJlbmRlckN1cnNvciwgewogICAgY3Vyc29yLAogICAgY3Vyc29yQ29tcCwKICAgIGN1cnNvclByb3BzCiAgfSkpOwp9CmZ1bmN0aW9uIEN1cnNvcihwcm9wcykgewogIHZhciB0b29sdGlwQXhpc0JhbmRTaXplID0gdXNlVG9vbHRpcEF4aXNCYW5kU2l6ZSgpOwogIHZhciBvZmZzZXQgPSB1c2VPZmZzZXRJbnRlcm5hbCgpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciBjaGFydE5hbWUgPSB1c2VDaGFydE5hbWUoKTsKICBpZiAodG9vbHRpcEF4aXNCYW5kU2l6ZSA9PSBudWxsIHx8IG9mZnNldCA9PSBudWxsIHx8IGxheW91dCA9PSBudWxsIHx8IGNoYXJ0TmFtZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoQ3Vyc29ySW50ZXJuYWwsIF9leHRlbmRzOSh7fSwgcHJvcHMsIHsKICAgIG9mZnNldCwKICAgIGxheW91dCwKICAgIHRvb2x0aXBBeGlzQmFuZFNpemUsCiAgICBjaGFydE5hbWUKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvdG9vbHRpcFBvcnRhbENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDIyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgVG9vbHRpcFBvcnRhbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIyLmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgdXNlVG9vbHRpcFBvcnRhbCA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QyMi51c2VDb250ZXh0KShUb29sdGlwUG9ydGFsQ29udGV4dCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vdXNlQ2hhcnRTeW5jaHJvbmlzYXRpb24uanMKdmFyIGltcG9ydF9yZWFjdDIzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2V2ZW50ZW1pdHRlcjNANS4wLjEvbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXgubWpzCnZhciBpbXBvcnRfaW5kZXggPSBfX3RvRVNNKHJlcXVpcmVfZXZlbnRlbWl0dGVyMygpLCAxKTsKdmFyIGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCA9IGltcG9ydF9pbmRleC5kZWZhdWx0OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9FdmVudHMuanMKdmFyIGV2ZW50Q2VudGVyID0gbmV3IGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCgpOwp2YXIgVE9PTFRJUF9TWU5DX0VWRU5UID0gInJlY2hhcnRzLnN5bmNFdmVudC50b29sdGlwIjsKdmFyIEJSVVNIX1NZTkNfRVZFTlQgPSAicmVjaGFydHMuc3luY0V2ZW50LmJydXNoIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL29wdGlvbnNTbGljZS5qcwpmdW5jdGlvbiBhcnJheVRvb2x0aXBTZWFyY2hlcihkYXRhLCBzdHJJbmRleCkgewogIGlmICghc3RySW5kZXgpIHJldHVybiB2b2lkIDA7CiAgdmFyIG51bUluZGV4ID0gTnVtYmVyLnBhcnNlSW50KHN0ckluZGV4LCAxMCk7CiAgaWYgKGlzTmFuKG51bUluZGV4KSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YVtudW1JbmRleF07Cn0KdmFyIGluaXRpYWxTdGF0ZTUgPSB7CiAgY2hhcnROYW1lOiAiIiwKICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyOiB2b2lkIDAsCiAgZXZlbnRFbWl0dGVyOiB2b2lkIDAsCiAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU6ICJheGlzIgp9Owp2YXIgb3B0aW9uc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJvcHRpb25zIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTUsCiAgcmVkdWNlcnM6IHsKICAgIGNyZWF0ZUV2ZW50RW1pdHRlcjogKHN0YXRlKSA9PiB7CiAgICAgIGlmIChzdGF0ZS5ldmVudEVtaXR0ZXIgPT0gbnVsbCkgewogICAgICAgIHN0YXRlLmV2ZW50RW1pdHRlciA9IFN5bWJvbCgicmVjaGFydHNFdmVudEVtaXR0ZXIiKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciBvcHRpb25zUmVkdWNlciA9IG9wdGlvbnNTbGljZS5yZWR1Y2VyOwp2YXIgewogIGNyZWF0ZUV2ZW50RW1pdHRlcgp9ID0gb3B0aW9uc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vc3luY1NlbGVjdG9ycy5qcwpmdW5jdGlvbiBzZWxlY3RTeW5jaHJvbmlzZWRUb29sdGlwU3RhdGUoc3RhdGUpIHsKICByZXR1cm4gc3RhdGUudG9vbHRpcC5zeW5jSW50ZXJhY3Rpb247Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2NoYXJ0RGF0YVNsaWNlLmpzCnZhciBpbml0aWFsQ2hhcnREYXRhU3RhdGUgPSB7CiAgY2hhcnREYXRhOiB2b2lkIDAsCiAgY29tcHV0ZWREYXRhOiB2b2lkIDAsCiAgZGF0YVN0YXJ0SW5kZXg6IDAsCiAgZGF0YUVuZEluZGV4OiAwCn07CnZhciBjaGFydERhdGFTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2hhcnREYXRhIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxDaGFydERhdGFTdGF0ZSwKICByZWR1Y2VyczogewogICAgc2V0Q2hhcnREYXRhKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuY2hhcnREYXRhID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgc3RhdGUuZGF0YVN0YXJ0SW5kZXggPSAwOwogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5sZW5ndGggPiAwICYmIHN0YXRlLmRhdGFFbmRJbmRleCAhPT0gYWN0aW9uLnBheWxvYWQubGVuZ3RoIC0gMSkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGFjdGlvbi5wYXlsb2FkLmxlbmd0aCAtIDE7CiAgICAgIH0KICAgIH0sCiAgICBzZXRDb21wdXRlZERhdGEoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5jb21wdXRlZERhdGEgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXREYXRhU3RhcnRFbmRJbmRleGVzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIHsKICAgICAgICBzdGFydEluZGV4LAogICAgICAgIGVuZEluZGV4CiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXJ0SW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFTdGFydEluZGV4ID0gc3RhcnRJbmRleDsKICAgICAgfQogICAgICBpZiAoZW5kSW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGVuZEluZGV4OwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRDaGFydERhdGEsCiAgc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcywKICBzZXRDb21wdXRlZERhdGEKfSA9IGNoYXJ0RGF0YVNsaWNlLmFjdGlvbnM7CnZhciBjaGFydERhdGFSZWR1Y2VyID0gY2hhcnREYXRhU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N5bmNocm9uaXNhdGlvbi91c2VDaGFydFN5bmNocm9uaXNhdGlvbi5qcwp2YXIgX2V4Y2x1ZGVkNSA9IFsieCIsICJ5Il07CmZ1bmN0aW9uIG93bktleXMyMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiB1c2VUb29sdGlwU3luY0V2ZW50c0xpc3RlbmVyKCkgewogIHZhciBteVN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIG15RXZlbnRFbWl0dGVyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBzeW5jTWV0aG9kID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY01ldGhvZCk7CiAgdmFyIHRvb2x0aXBUaWNrcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogIHZhciBjbGFzc05hbWUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5jbGFzc05hbWUpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChteVN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGxpc3RlbmVyMiA9IChpbmNvbWluZ1N5bmNJZCwgYWN0aW9uLCBlbWl0dGVyKSA9PiB7CiAgICAgIGlmIChteUV2ZW50RW1pdHRlciA9PT0gZW1pdHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobXlTeW5jSWQgIT09IGluY29taW5nU3luY0lkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChzeW5jTWV0aG9kID09PSAiaW5kZXgiKSB7CiAgICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZDsKICAgICAgICBpZiAodmlld0JveCAmJiBhY3Rpb24gIT09IG51bGwgJiYgYWN0aW9uICE9PSB2b2lkIDAgJiYgKF9hY3Rpb24kcGF5bG9hZCA9IGFjdGlvbi5wYXlsb2FkKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQgIT09IHZvaWQgMCAmJiBfYWN0aW9uJHBheWxvYWQuY29vcmRpbmF0ZSAmJiBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94KSB7CiAgICAgICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkJGNvb3JkID0gYWN0aW9uLnBheWxvYWQuY29vcmRpbmF0ZSwgewogICAgICAgICAgICB4OiBfeCwKICAgICAgICAgICAgeTogX3kKICAgICAgICAgIH0gPSBfYWN0aW9uJHBheWxvYWQkY29vcmQsIG90aGVyQ29vcmRpbmF0ZVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNShfYWN0aW9uJHBheWxvYWQkY29vcmQsIF9leGNsdWRlZDUpOwogICAgICAgICAgdmFyIHsKICAgICAgICAgICAgeDogc291cmNlWCwKICAgICAgICAgICAgeTogc291cmNlWSwKICAgICAgICAgICAgd2lkdGg6IHNvdXJjZVdpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IHNvdXJjZUhlaWdodAogICAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3g7CiAgICAgICAgICB2YXIgc2NhbGVkQ29vcmRpbmF0ZSA9IF9vYmplY3RTcHJlYWQyMChfb2JqZWN0U3ByZWFkMjAoe30sIG90aGVyQ29vcmRpbmF0ZVByb3BzKSwge30sIHsKICAgICAgICAgICAgeDogdmlld0JveC54ICsgKHNvdXJjZVdpZHRoID8gKF94IC0gc291cmNlWCkgLyBzb3VyY2VXaWR0aCA6IDApICogdmlld0JveC53aWR0aCwKICAgICAgICAgICAgeTogdmlld0JveC55ICsgKHNvdXJjZUhlaWdodCA/IChfeSAtIHNvdXJjZVkpIC8gc291cmNlSGVpZ2h0IDogMCkgKiB2aWV3Qm94LmhlaWdodAogICAgICAgICAgfSk7CiAgICAgICAgICBkaXNwYXRjaChfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBhY3Rpb24pLCB7fSwgewogICAgICAgICAgICBwYXlsb2FkOiBfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBhY3Rpb24ucGF5bG9hZCksIHt9LCB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZTogc2NhbGVkQ29vcmRpbmF0ZQogICAgICAgICAgICB9KQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkaXNwYXRjaChhY3Rpb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRvb2x0aXBUaWNrcyA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBhY3RpdmVUaWNrOwogICAgICBpZiAodHlwZW9mIHN5bmNNZXRob2QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB2YXIgc3luY01ldGhvZFBhcmFtID0gewogICAgICAgICAgYWN0aXZlVG9vbHRpcEluZGV4OiBhY3Rpb24ucGF5bG9hZC5pbmRleCA9PSBudWxsID8gdm9pZCAwIDogTnVtYmVyKGFjdGlvbi5wYXlsb2FkLmluZGV4KSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogYWN0aW9uLnBheWxvYWQuYWN0aXZlLAogICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGlvbi5wYXlsb2FkLmluZGV4ID09IG51bGwgPyB2b2lkIDAgOiBOdW1iZXIoYWN0aW9uLnBheWxvYWQuaW5kZXgpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IGFjdGlvbi5wYXlsb2FkLmxhYmVsLAogICAgICAgICAgYWN0aXZlRGF0YUtleTogYWN0aW9uLnBheWxvYWQuZGF0YUtleSwKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGlvbi5wYXlsb2FkLmNvb3JkaW5hdGUKICAgICAgICB9OwogICAgICAgIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSBzeW5jTWV0aG9kKHRvb2x0aXBUaWNrcywgc3luY01ldGhvZFBhcmFtKTsKICAgICAgICBhY3RpdmVUaWNrID0gdG9vbHRpcFRpY2tzW2FjdGl2ZVRvb2x0aXBJbmRleF07CiAgICAgIH0gZWxzZSBpZiAoc3luY01ldGhvZCA9PT0gInZhbHVlIikgewogICAgICAgIGFjdGl2ZVRpY2sgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gU3RyaW5nKHRpY2sudmFsdWUpID09PSBhY3Rpb24ucGF5bG9hZC5sYWJlbCk7CiAgICAgIH0KICAgICAgdmFyIHsKICAgICAgICBjb29yZGluYXRlCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKGFjdGl2ZVRpY2sgPT0gbnVsbCB8fCBhY3Rpb24ucGF5bG9hZC5hY3RpdmUgPT09IGZhbHNlIHx8IGNvb3JkaW5hdGUgPT0gbnVsbCB8fCB2aWV3Qm94ID09IG51bGwpIHsKICAgICAgICBkaXNwYXRjaChzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgICAgICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgIGluZGV4OiBudWxsLAogICAgICAgICAgbGFiZWw6IHZvaWQgMCwKICAgICAgICAgIHNvdXJjZVZpZXdCb3g6IHZvaWQgMCwKICAgICAgICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgICAgICAgfSkpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgewogICAgICAgIHg6IHgyLAogICAgICAgIHk6IHkyCiAgICAgIH0gPSBjb29yZGluYXRlOwogICAgICB2YXIgdmFsaWRhdGVDaGFydFggPSBNYXRoLm1pbih4Miwgdmlld0JveC54ICsgdmlld0JveC53aWR0aCk7CiAgICAgIHZhciB2YWxpZGF0ZUNoYXJ0WSA9IE1hdGgubWluKHkyLCB2aWV3Qm94LnkgKyB2aWV3Qm94LmhlaWdodCk7CiAgICAgIHZhciBhY3RpdmVDb29yZGluYXRlID0gewogICAgICAgIHg6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gYWN0aXZlVGljay5jb29yZGluYXRlIDogdmFsaWRhdGVDaGFydFgsCiAgICAgICAgeTogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB2YWxpZGF0ZUNoYXJ0WSA6IGFjdGl2ZVRpY2suY29vcmRpbmF0ZQogICAgICB9OwogICAgICB2YXIgc3luY0FjdGlvbiA9IHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlOiBhY3Rpb24ucGF5bG9hZC5hY3RpdmUsCiAgICAgICAgY29vcmRpbmF0ZTogYWN0aXZlQ29vcmRpbmF0ZSwKICAgICAgICBkYXRhS2V5OiBhY3Rpb24ucGF5bG9hZC5kYXRhS2V5LAogICAgICAgIGluZGV4OiBTdHJpbmcoYWN0aXZlVGljay5pbmRleCksCiAgICAgICAgbGFiZWw6IGFjdGlvbi5wYXlsb2FkLmxhYmVsLAogICAgICAgIHNvdXJjZVZpZXdCb3g6IGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3gsCiAgICAgICAgZ3JhcGhpY2FsSXRlbUlkOiBhY3Rpb24ucGF5bG9hZC5ncmFwaGljYWxJdGVtSWQKICAgICAgfSk7CiAgICAgIGRpc3BhdGNoKHN5bmNBY3Rpb24pOwogICAgfTsKICAgIGV2ZW50Q2VudGVyLm9uKFRPT0xUSVBfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGV2ZW50Q2VudGVyLm9mZihUT09MVElQX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICB9OwogIH0sIFtjbGFzc05hbWUsIGRpc3BhdGNoLCBteUV2ZW50RW1pdHRlciwgbXlTeW5jSWQsIHN5bmNNZXRob2QsIHRvb2x0aXBUaWNrcywgbGF5b3V0LCB2aWV3Qm94XSk7Cn0KZnVuY3Rpb24gdXNlQnJ1c2hTeW5jRXZlbnRzTGlzdGVuZXIoKSB7CiAgdmFyIG15U3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgbXlFdmVudEVtaXR0ZXIgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKG15U3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgbGlzdGVuZXIyID0gKGluY29taW5nU3luY0lkLCBhY3Rpb24sIGVtaXR0ZXIpID0+IHsKICAgICAgaWYgKG15RXZlbnRFbWl0dGVyID09PSBlbWl0dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChteVN5bmNJZCA9PT0gaW5jb21pbmdTeW5jSWQpIHsKICAgICAgICBkaXNwYXRjaChzZXREYXRhU3RhcnRFbmRJbmRleGVzKGFjdGlvbikpOwogICAgICB9CiAgICB9OwogICAgZXZlbnRDZW50ZXIub24oQlJVU0hfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGV2ZW50Q2VudGVyLm9mZihCUlVTSF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIG15RXZlbnRFbWl0dGVyLCBteVN5bmNJZF0pOwp9CmZ1bmN0aW9uIHVzZVN5bmNocm9uaXNlZEV2ZW50c0Zyb21PdGhlckNoYXJ0cygpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKGNyZWF0ZUV2ZW50RW1pdHRlcigpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB1c2VUb29sdGlwU3luY0V2ZW50c0xpc3RlbmVyKCk7CiAgdXNlQnJ1c2hTeW5jRXZlbnRzTGlzdGVuZXIoKTsKfQpmdW5jdGlvbiB1c2VUb29sdGlwQ2hhcnRTeW5jaHJvbmlzYXRpb24odG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgYWN0aXZlQ29vcmRpbmF0ZSwgYWN0aXZlTGFiZWwsIGFjdGl2ZUluZGV4LCBpc1Rvb2x0aXBBY3RpdmUpIHsKICB2YXIgYWN0aXZlRGF0YUtleSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcERhdGFLZXkoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpKTsKICB2YXIgZXZlbnRFbWl0dGVyU3ltYm9sID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgc3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgc3luY01ldGhvZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNNZXRob2QpOwogIHZhciB0b29sdGlwU3RhdGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jaHJvbmlzZWRUb29sdGlwU3RhdGUpOwogIHZhciBpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbiA9IHRvb2x0aXBTdGF0ZSA9PT0gbnVsbCB8fCB0b29sdGlwU3RhdGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBTdGF0ZS5hY3RpdmU7CiAgdmFyIHZpZXdCb3ggPSB1c2VWaWV3Qm94KCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnRFbWl0dGVyU3ltYm9sID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN5bmNBY3Rpb24gPSBzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICBhY3RpdmU6IGlzVG9vbHRpcEFjdGl2ZSwKICAgICAgY29vcmRpbmF0ZTogYWN0aXZlQ29vcmRpbmF0ZSwKICAgICAgZGF0YUtleTogYWN0aXZlRGF0YUtleSwKICAgICAgaW5kZXg6IGFjdGl2ZUluZGV4LAogICAgICBsYWJlbDogdHlwZW9mIGFjdGl2ZUxhYmVsID09PSAibnVtYmVyIiA/IFN0cmluZyhhY3RpdmVMYWJlbCkgOiBhY3RpdmVMYWJlbCwKICAgICAgc291cmNlVmlld0JveDogdmlld0JveCwKICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgIH0pOwogICAgZXZlbnRDZW50ZXIuZW1pdChUT09MVElQX1NZTkNfRVZFTlQsIHN5bmNJZCwgc3luY0FjdGlvbiwgZXZlbnRFbWl0dGVyU3ltYm9sKTsKICB9LCBbaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24sIGFjdGl2ZUNvb3JkaW5hdGUsIGFjdGl2ZURhdGFLZXksIGFjdGl2ZUluZGV4LCBhY3RpdmVMYWJlbCwgZXZlbnRFbWl0dGVyU3ltYm9sLCBzeW5jSWQsIHN5bmNNZXRob2QsIGlzVG9vbHRpcEFjdGl2ZSwgdmlld0JveF0pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwpmdW5jdGlvbiBvd25LZXlzMjEoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIxKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjEoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZGVmYXVsdFVuaXFCeShlbnRyeSkgewogIHJldHVybiBlbnRyeS5kYXRhS2V5Owp9CmZ1bmN0aW9uIHJlbmRlckNvbnRlbnQoY29udGVudCwgcHJvcHMpIHsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MTIuaXNWYWxpZEVsZW1lbnQoY29udGVudCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jbG9uZUVsZW1lbnQoY29udGVudCwgcHJvcHMpOwogIH0KICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KGNvbnRlbnQsIHByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoRGVmYXVsdFRvb2x0aXBDb250ZW50LCBwcm9wcyk7Cn0KdmFyIGVtcHR5UGF5bG9hZCA9IFtdOwp2YXIgZGVmYXVsdFRvb2x0aXBQcm9wcyA9IHsKICBhbGxvd0VzY2FwZVZpZXdCb3g6IHsKICAgIHg6IGZhbHNlLAogICAgeTogZmFsc2UKICB9LAogIGFuaW1hdGlvbkR1cmF0aW9uOiA0MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgYXhpc0lkOiAwLAogIGNvbnRlbnRTdHlsZToge30sCiAgY3Vyc29yOiB0cnVlLAogIGZpbHRlck51bGw6IHRydWUsCiAgaXNBbmltYXRpb25BY3RpdmU6ICJhdXRvIiwKICBpdGVtU29ydGVyOiAibmFtZSIsCiAgaXRlbVN0eWxlOiB7fSwKICBsYWJlbFN0eWxlOiB7fSwKICBvZmZzZXQ6IDEwLAogIHJldmVyc2VEaXJlY3Rpb246IHsKICAgIHg6IGZhbHNlLAogICAgeTogZmFsc2UKICB9LAogIHNlcGFyYXRvcjogIiA6ICIsCiAgdHJpZ2dlcjogImhvdmVyIiwKICB1c2VUcmFuc2xhdGUzZDogZmFsc2UsCiAgd3JhcHBlclN0eWxlOiB7fQp9OwpmdW5jdGlvbiBUb29sdGlwKG91dHNpZGVQcm9wcykgewogIHZhciBfdXNlQXBwU2VsZWN0b3IsIF9yZWYyOwogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0VG9vbHRpcFByb3BzKTsKICB2YXIgewogICAgYWN0aXZlOiBhY3RpdmVGcm9tUHJvcHMsCiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGNvbnRlbnQsCiAgICBmaWx0ZXJOdWxsLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBvZmZzZXQsCiAgICBwYXlsb2FkVW5pcUJ5LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB3cmFwcGVyU3R5bGUsCiAgICBjdXJzb3IsCiAgICBzaGFyZWQsCiAgICB0cmlnZ2VyLAogICAgZGVmYXVsdEluZGV4LAogICAgcG9ydGFsOiBwb3J0YWxGcm9tUHJvcHMsCiAgICBheGlzSWQKICB9ID0gcHJvcHM7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgZGVmYXVsdEluZGV4QXNTdHJpbmcgPSB0eXBlb2YgZGVmYXVsdEluZGV4ID09PSAibnVtYmVyIiA/IFN0cmluZyhkZWZhdWx0SW5kZXgpIDogZGVmYXVsdEluZGV4OwogICgwLCBpbXBvcnRfcmVhY3QyNC51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlKHsKICAgICAgc2hhcmVkLAogICAgICB0cmlnZ2VyLAogICAgICBheGlzSWQsCiAgICAgIGFjdGl2ZTogYWN0aXZlRnJvbVByb3BzLAogICAgICBkZWZhdWx0SW5kZXg6IGRlZmF1bHRJbmRleEFzU3RyaW5nCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBzaGFyZWQsIHRyaWdnZXIsIGF4aXNJZCwgYWN0aXZlRnJvbVByb3BzLCBkZWZhdWx0SW5kZXhBc1N0cmluZ10pOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXIgPSB1c2VBY2Nlc3NpYmlsaXR5TGF5ZXIoKTsKICB2YXIgdG9vbHRpcEV2ZW50VHlwZSA9IHVzZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkKTsKICB2YXIgewogICAgYWN0aXZlSW5kZXgsCiAgICBpc0FjdGl2ZQogIH0gPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUyKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXhBc1N0cmluZykpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHt9OwogIHZhciBwYXlsb2FkRnJvbVJlZHV4ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwUGF5bG9hZChzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgbGFiZWxGcm9tUmVkdXggPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFjdGl2ZUxhYmVsMihzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgY29vcmRpbmF0ZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QWN0aXZlQ29vcmRpbmF0ZShzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgcGF5bG9hZCA9IHBheWxvYWRGcm9tUmVkdXg7CiAgdmFyIHRvb2x0aXBQb3J0YWxGcm9tQ29udGV4dCA9IHVzZVRvb2x0aXBQb3J0YWwoKTsKICB2YXIgZmluYWxJc0FjdGl2ZSA9IChfcmVmMiA9IGFjdGl2ZUZyb21Qcm9wcyAhPT0gbnVsbCAmJiBhY3RpdmVGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFjdGl2ZUZyb21Qcm9wcyA6IGlzQWN0aXZlKSAhPT0gbnVsbCAmJiBfcmVmMiAhPT0gdm9pZCAwID8gX3JlZjIgOiBmYWxzZTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgdXBkYXRlQm91bmRpbmdCb3hdID0gdXNlRWxlbWVudE9mZnNldChbcGF5bG9hZCwgZmluYWxJc0FjdGl2ZV0pOwogIHZhciBmaW5hbExhYmVsID0gdG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiID8gbGFiZWxGcm9tUmVkdXggOiB2b2lkIDA7CiAgdXNlVG9vbHRpcENoYXJ0U3luY2hyb25pc2F0aW9uKHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGNvb3JkaW5hdGUsIGZpbmFsTGFiZWwsIGFjdGl2ZUluZGV4LCBmaW5hbElzQWN0aXZlKTsKICB2YXIgdG9vbHRpcFBvcnRhbCA9IHBvcnRhbEZyb21Qcm9wcyAhPT0gbnVsbCAmJiBwb3J0YWxGcm9tUHJvcHMgIT09IHZvaWQgMCA/IHBvcnRhbEZyb21Qcm9wcyA6IHRvb2x0aXBQb3J0YWxGcm9tQ29udGV4dDsKICBpZiAodG9vbHRpcFBvcnRhbCA9PSBudWxsIHx8IHZpZXdCb3ggPT0gbnVsbCB8fCB0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgZmluYWxQYXlsb2FkID0gcGF5bG9hZCAhPT0gbnVsbCAmJiBwYXlsb2FkICE9PSB2b2lkIDAgPyBwYXlsb2FkIDogZW1wdHlQYXlsb2FkOwogIGlmICghZmluYWxJc0FjdGl2ZSkgewogICAgZmluYWxQYXlsb2FkID0gZW1wdHlQYXlsb2FkOwogIH0KICBpZiAoZmlsdGVyTnVsbCAmJiBmaW5hbFBheWxvYWQubGVuZ3RoKSB7CiAgICBmaW5hbFBheWxvYWQgPSBnZXRVbmlxUGF5bG9hZChmaW5hbFBheWxvYWQuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkudmFsdWUgIT0gbnVsbCAmJiAoZW50cnkuaGlkZSAhPT0gdHJ1ZSB8fCBwcm9wcy5pbmNsdWRlSGlkZGVuKSksIHBheWxvYWRVbmlxQnksIGRlZmF1bHRVbmlxQnkpOwogIH0KICB2YXIgaGFzUGF5bG9hZCA9IGZpbmFsUGF5bG9hZC5sZW5ndGggPiAwOwogIHZhciB0b29sdGlwRWxlbWVudCA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoVG9vbHRpcEJvdW5kaW5nQm94LCB7CiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgYWN0aXZlOiBmaW5hbElzQWN0aXZlLAogICAgY29vcmRpbmF0ZSwKICAgIGhhc1BheWxvYWQsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB1c2VUcmFuc2xhdGUzZCwKICAgIHZpZXdCb3gsCiAgICB3cmFwcGVyU3R5bGUsCiAgICBsYXN0Qm91bmRpbmdCb3gsCiAgICBpbm5lclJlZjogdXBkYXRlQm91bmRpbmdCb3gsCiAgICBoYXNQb3J0YWxGcm9tUHJvcHM6IEJvb2xlYW4ocG9ydGFsRnJvbVByb3BzKQogIH0sIHJlbmRlckNvbnRlbnQoY29udGVudCwgX29iamVjdFNwcmVhZDIxKF9vYmplY3RTcHJlYWQyMSh7fSwgcHJvcHMpLCB7fSwgewogICAgcGF5bG9hZDogZmluYWxQYXlsb2FkLAogICAgbGFiZWw6IGZpbmFsTGFiZWwsCiAgICBhY3RpdmU6IGZpbmFsSXNBY3RpdmUsCiAgICBhY3RpdmVJbmRleCwKICAgIGNvb3JkaW5hdGUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXIKICB9KSkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KFJlYWN0MTIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0X2RvbTIuY3JlYXRlUG9ydGFsKSh0b29sdGlwRWxlbWVudCwgdG9vbHRpcFBvcnRhbCksIGZpbmFsSXNBY3RpdmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChDdXJzb3IsIHsKICAgIGN1cnNvciwKICAgIHRvb2x0aXBFdmVudFR5cGUsCiAgICBjb29yZGluYXRlLAogICAgcGF5bG9hZDogZmluYWxQYXlsb2FkLAogICAgaW5kZXg6IGFjdGl2ZUluZGV4CiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVGV4dC5qcwp2YXIgUmVhY3QxMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9MUlVDYWNoZS5qcwpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgTFJVQ2FjaGUgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IobWF4U2l6ZSkgewogICAgX2RlZmluZVByb3BlcnR5MjIodGhpcywgImNhY2hlIiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSk7CiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplOwogIH0KICBnZXQoa2V5KSB7CiAgICB2YXIgdmFsdWUgPSB0aGlzLmNhY2hlLmdldChrZXkpOwogICAgaWYgKHZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTsKICAgICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHNldChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5jYWNoZS5oYXMoa2V5KSkgewogICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpOwogICAgfSBlbHNlIGlmICh0aGlzLmNhY2hlLnNpemUgPj0gdGhpcy5tYXhTaXplKSB7CiAgICAgIHZhciBmaXJzdEtleSA9IHRoaXMuY2FjaGUua2V5cygpLm5leHQoKS52YWx1ZTsKICAgICAgaWYgKGZpcnN0S2V5ICE9IG51bGwpIHsKICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShmaXJzdEtleSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUpOwogIH0KICBjbGVhcigpIHsKICAgIHRoaXMuY2FjaGUuY2xlYXIoKTsKICB9CiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLmNhY2hlLnNpemU7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ET01VdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMjIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDb25maWcgPSB7CiAgY2FjaGVTaXplOiAyZTMsCiAgZW5hYmxlQ2FjaGU6IHRydWUKfTsKdmFyIGN1cnJlbnRDb25maWcgPSBfb2JqZWN0U3ByZWFkMjIoe30sIGRlZmF1bHRDb25maWcpOwp2YXIgc3RyaW5nQ2FjaGUgPSBuZXcgTFJVQ2FjaGUoY3VycmVudENvbmZpZy5jYWNoZVNpemUpOwp2YXIgU1BBTl9TVFlMRSA9IHsKICBwb3NpdGlvbjogImFic29sdXRlIiwKICB0b3A6ICItMjAwMDBweCIsCiAgbGVmdDogMCwKICBwYWRkaW5nOiAwLAogIG1hcmdpbjogMCwKICBib3JkZXI6ICJub25lIiwKICB3aGl0ZVNwYWNlOiAicHJlIgp9Owp2YXIgTUVBU1VSRU1FTlRfU1BBTl9JRCA9ICJyZWNoYXJ0c19tZWFzdXJlbWVudF9zcGFuIjsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVLZXkodGV4dCwgc3R5bGUpIHsKICB2YXIgZm9udFNpemUgPSBzdHlsZS5mb250U2l6ZSB8fCAiIjsKICB2YXIgZm9udEZhbWlseSA9IHN0eWxlLmZvbnRGYW1pbHkgfHwgIiI7CiAgdmFyIGZvbnRXZWlnaHQgPSBzdHlsZS5mb250V2VpZ2h0IHx8ICIiOwogIHZhciBmb250U3R5bGUgPSBzdHlsZS5mb250U3R5bGUgfHwgIiI7CiAgdmFyIGxldHRlclNwYWNpbmcgPSBzdHlsZS5sZXR0ZXJTcGFjaW5nIHx8ICIiOwogIHZhciB0ZXh0VHJhbnNmb3JtID0gc3R5bGUudGV4dFRyYW5zZm9ybSB8fCAiIjsKICByZXR1cm4gIiIuY29uY2F0KHRleHQsICJ8IikuY29uY2F0KGZvbnRTaXplLCAifCIpLmNvbmNhdChmb250RmFtaWx5LCAifCIpLmNvbmNhdChmb250V2VpZ2h0LCAifCIpLmNvbmNhdChmb250U3R5bGUsICJ8IikuY29uY2F0KGxldHRlclNwYWNpbmcsICJ8IikuY29uY2F0KHRleHRUcmFuc2Zvcm0pOwp9CnZhciBtZWFzdXJlVGV4dFdpdGhET00gPSAodGV4dCwgc3R5bGUpID0+IHsKICB0cnkgewogICAgdmFyIG1lYXN1cmVtZW50U3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgaWYgKCFtZWFzdXJlbWVudFNwYW4pIHsKICAgICAgbWVhc3VyZW1lbnRTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJpZCIsIE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobWVhc3VyZW1lbnRTcGFuKTsKICAgIH0KICAgIE9iamVjdC5hc3NpZ24obWVhc3VyZW1lbnRTcGFuLnN0eWxlLCBTUEFOX1NUWUxFLCBzdHlsZSk7CiAgICBtZWFzdXJlbWVudFNwYW4udGV4dENvbnRlbnQgPSAiIi5jb25jYXQodGV4dCk7CiAgICB2YXIgcmVjdCA9IG1lYXN1cmVtZW50U3Bhbi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiByZWN0LndpZHRoLAogICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0CiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQp9Owp2YXIgZ2V0U3RyaW5nU2l6ZSA9IGZ1bmN0aW9uIGdldFN0cmluZ1NpemUyKHRleHQpIHsKICB2YXIgc3R5bGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogIGlmICh0ZXh0ID09PSB2b2lkIDAgfHwgdGV4dCA9PT0gbnVsbCB8fCBHbG9iYWwuaXNTc3IpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQogIGlmICghY3VycmVudENvbmZpZy5lbmFibGVDYWNoZSkgewogICAgcmV0dXJuIG1lYXN1cmVUZXh0V2l0aERPTSh0ZXh0LCBzdHlsZSk7CiAgfQogIHZhciBjYWNoZUtleSA9IGNyZWF0ZUNhY2hlS2V5KHRleHQsIHN0eWxlKTsKICB2YXIgY2FjaGVkUmVzdWx0ID0gc3RyaW5nQ2FjaGUuZ2V0KGNhY2hlS2V5KTsKICBpZiAoY2FjaGVkUmVzdWx0KSB7CiAgICByZXR1cm4gY2FjaGVkUmVzdWx0OwogIH0KICB2YXIgcmVzdWx0ID0gbWVhc3VyZVRleHRXaXRoRE9NKHRleHQsIHN0eWxlKTsKICBzdHJpbmdDYWNoZS5zZXQoY2FjaGVLZXksIHJlc3VsdCk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUmVkdWNlQ1NTQ2FsYy5qcwp2YXIgTVVMVElQTFlfT1JfRElWSURFX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKShbKi9dKSgtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKS87CnZhciBBRERfT1JfU1VCVFJBQ1RfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopKFsrLV0pKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopLzsKdmFyIENTU19MRU5HVEhfVU5JVF9SRUdFWCA9IC9ecHh8Y218dmh8dnd8ZW18cmVtfCV8bW18aW58cHR8cGN8ZXh8Y2h8dm1pbnx2bWF4fFEkLzsKdmFyIE5VTV9TUExJVF9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/KShbYS16QS1aJV0rKT8vOwp2YXIgQ09OVkVSU0lPTl9SQVRFUyA9IHsKICBjbTogOTYgLyAyLjU0LAogIG1tOiA5NiAvIDI1LjQsCiAgcHQ6IDk2IC8gNzIsCiAgcGM6IDk2IC8gNiwKICBpbjogOTYsCiAgUTogOTYgLyAoMi41NCAqIDQwKSwKICBweDogMQp9Owp2YXIgRklYRURfQ1NTX0xFTkdUSF9VTklUUyA9IE9iamVjdC5rZXlzKENPTlZFUlNJT05fUkFURVMpOwp2YXIgU1RSX05BTiA9ICJOYU4iOwpmdW5jdGlvbiBjb252ZXJ0VG9QeCh2YWx1ZSwgdW5pdDIpIHsKICByZXR1cm4gdmFsdWUgKiBDT05WRVJTSU9OX1JBVEVTW3VuaXQyXTsKfQp2YXIgRGVjaW1hbENTUyA9IGNsYXNzIF9EZWNpbWFsQ1NTIHsKICBzdGF0aWMgcGFyc2Uoc3RyKSB7CiAgICB2YXIgX05VTV9TUExJVF9SRUdFWCRleGVjOwogICAgdmFyIFssIG51bVN0ciwgdW5pdDJdID0gKF9OVU1fU1BMSVRfUkVHRVgkZXhlYyA9IE5VTV9TUExJVF9SRUdFWC5leGVjKHN0cikpICE9PSBudWxsICYmIF9OVU1fU1BMSVRfUkVHRVgkZXhlYyAhPT0gdm9pZCAwID8gX05VTV9TUExJVF9SRUdFWCRleGVjIDogW107CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHBhcnNlRmxvYXQobnVtU3RyKSwgdW5pdDIgIT09IG51bGwgJiYgdW5pdDIgIT09IHZvaWQgMCA/IHVuaXQyIDogIiIpOwogIH0KICBjb25zdHJ1Y3RvcihudW0sIHVuaXQyKSB7CiAgICB0aGlzLm51bSA9IG51bTsKICAgIHRoaXMudW5pdCA9IHVuaXQyOwogICAgdGhpcy5udW0gPSBudW07CiAgICB0aGlzLnVuaXQgPSB1bml0MjsKICAgIGlmIChpc05hbihudW0pKSB7CiAgICAgIHRoaXMudW5pdCA9ICIiOwogICAgfQogICAgaWYgKHVuaXQyICE9PSAiIiAmJiAhQ1NTX0xFTkdUSF9VTklUX1JFR0VYLnRlc3QodW5pdDIpKSB7CiAgICAgIHRoaXMubnVtID0gTmFOOwogICAgICB0aGlzLnVuaXQgPSAiIjsKICAgIH0KICAgIGlmIChGSVhFRF9DU1NfTEVOR1RIX1VOSVRTLmluY2x1ZGVzKHVuaXQyKSkgewogICAgICB0aGlzLm51bSA9IGNvbnZlcnRUb1B4KG51bSwgdW5pdDIpOwogICAgICB0aGlzLnVuaXQgPSAicHgiOwogICAgfQogIH0KICBhZGQob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gKyBvdGhlci5udW0sIHRoaXMudW5pdCk7CiAgfQogIHN1YnRyYWN0KG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtIC0gb3RoZXIubnVtLCB0aGlzLnVuaXQpOwogIH0KICBtdWx0aXBseShvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gIiIgJiYgb3RoZXIudW5pdCAhPT0gIiIgJiYgdGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtICogb3RoZXIubnVtLCB0aGlzLnVuaXQgfHwgb3RoZXIudW5pdCk7CiAgfQogIGRpdmlkZShvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gIiIgJiYgb3RoZXIudW5pdCAhPT0gIiIgJiYgdGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtIC8gb3RoZXIubnVtLCB0aGlzLnVuaXQgfHwgb3RoZXIudW5pdCk7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLm51bSkuY29uY2F0KHRoaXMudW5pdCk7CiAgfQogIGlzTmFOKCkgewogICAgcmV0dXJuIGlzTmFuKHRoaXMubnVtKTsKICB9Cn07CmZ1bmN0aW9uIGNhbGN1bGF0ZUFyaXRobWV0aWMoZXhwcikgewogIGlmIChleHByLmluY2x1ZGVzKFNUUl9OQU4pKSB7CiAgICByZXR1cm4gU1RSX05BTjsKICB9CiAgdmFyIG5ld0V4cHIgPSBleHByOwogIHdoaWxlIChuZXdFeHByLmluY2x1ZGVzKCIqIikgfHwgbmV3RXhwci5pbmNsdWRlcygiLyIpKSB7CiAgICB2YXIgX01VTFRJUExZX09SX0RJVklERV9SOwogICAgdmFyIFssIGxlZnRPcGVyYW5kLCBvcGVyYXRvciwgcmlnaHRPcGVyYW5kXSA9IChfTVVMVElQTFlfT1JfRElWSURFX1IgPSBNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVguZXhlYyhuZXdFeHByKSkgIT09IG51bGwgJiYgX01VTFRJUExZX09SX0RJVklERV9SICE9PSB2b2lkIDAgPyBfTVVMVElQTFlfT1JfRElWSURFX1IgOiBbXTsKICAgIHZhciBsVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKGxlZnRPcGVyYW5kICE9PSBudWxsICYmIGxlZnRPcGVyYW5kICE9PSB2b2lkIDAgPyBsZWZ0T3BlcmFuZCA6ICIiKTsKICAgIHZhciByVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKHJpZ2h0T3BlcmFuZCAhPT0gbnVsbCAmJiByaWdodE9wZXJhbmQgIT09IHZvaWQgMCA/IHJpZ2h0T3BlcmFuZCA6ICIiKTsKICAgIHZhciByZXN1bHQgPSBvcGVyYXRvciA9PT0gIioiID8gbFRzLm11bHRpcGx5KHJUcykgOiBsVHMuZGl2aWRlKHJUcyk7CiAgICBpZiAocmVzdWx0LmlzTmFOKCkpIHsKICAgICAgcmV0dXJuIFNUUl9OQU47CiAgICB9CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKE1VTFRJUExZX09SX0RJVklERV9SRUdFWCwgcmVzdWx0LnRvU3RyaW5nKCkpOwogIH0KICB3aGlsZSAobmV3RXhwci5pbmNsdWRlcygiKyIpIHx8IC8uLVxkKyg/OlwuXGQrKT8vLnRlc3QobmV3RXhwcikpIHsKICAgIHZhciBfQUREX09SX1NVQlRSQUNUX1JFR0U7CiAgICB2YXIgWywgX2xlZnRPcGVyYW5kLCBfb3BlcmF0b3IsIF9yaWdodE9wZXJhbmRdID0gKF9BRERfT1JfU1VCVFJBQ1RfUkVHRSA9IEFERF9PUl9TVUJUUkFDVF9SRUdFWC5leGVjKG5ld0V4cHIpKSAhPT0gbnVsbCAmJiBfQUREX09SX1NVQlRSQUNUX1JFR0UgIT09IHZvaWQgMCA/IF9BRERfT1JfU1VCVFJBQ1RfUkVHRSA6IFtdOwogICAgdmFyIF9sVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKF9sZWZ0T3BlcmFuZCAhPT0gbnVsbCAmJiBfbGVmdE9wZXJhbmQgIT09IHZvaWQgMCA/IF9sZWZ0T3BlcmFuZCA6ICIiKTsKICAgIHZhciBfclRzID0gRGVjaW1hbENTUy5wYXJzZShfcmlnaHRPcGVyYW5kICE9PSBudWxsICYmIF9yaWdodE9wZXJhbmQgIT09IHZvaWQgMCA/IF9yaWdodE9wZXJhbmQgOiAiIik7CiAgICB2YXIgX3Jlc3VsdCA9IF9vcGVyYXRvciA9PT0gIisiID8gX2xUcy5hZGQoX3JUcykgOiBfbFRzLnN1YnRyYWN0KF9yVHMpOwogICAgaWYgKF9yZXN1bHQuaXNOYU4oKSkgewogICAgICByZXR1cm4gU1RSX05BTjsKICAgIH0KICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoQUREX09SX1NVQlRSQUNUX1JFR0VYLCBfcmVzdWx0LnRvU3RyaW5nKCkpOwogIH0KICByZXR1cm4gbmV3RXhwcjsKfQp2YXIgUEFSRU5USEVTRVNfUkVHRVggPSAvXCgoW14oKV0qKVwpLzsKZnVuY3Rpb24gY2FsY3VsYXRlUGFyZW50aGVzZXMoZXhwcikgewogIHZhciBuZXdFeHByID0gZXhwcjsKICB2YXIgbWF0Y2g7CiAgd2hpbGUgKChtYXRjaCA9IFBBUkVOVEhFU0VTX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9IG51bGwpIHsKICAgIHZhciBbLCBwYXJlbnRoZXRpY2FsRXhwcmVzc2lvbl0gPSBtYXRjaDsKICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoUEFSRU5USEVTRVNfUkVHRVgsIGNhbGN1bGF0ZUFyaXRobWV0aWMocGFyZW50aGV0aWNhbEV4cHJlc3Npb24pKTsKICB9CiAgcmV0dXJuIG5ld0V4cHI7Cn0KZnVuY3Rpb24gZXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pIHsKICB2YXIgbmV3RXhwciA9IGV4cHJlc3Npb24ucmVwbGFjZSgvXHMrL2csICIiKTsKICBuZXdFeHByID0gY2FsY3VsYXRlUGFyZW50aGVzZXMobmV3RXhwcik7CiAgbmV3RXhwciA9IGNhbGN1bGF0ZUFyaXRobWV0aWMobmV3RXhwcik7CiAgcmV0dXJuIG5ld0V4cHI7Cn0KZnVuY3Rpb24gc2FmZUV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKSB7CiAgdHJ5IHsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbik7CiAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgcmV0dXJuIFNUUl9OQU47CiAgfQp9CmZ1bmN0aW9uIHJlZHVjZUNTU0NhbGMoZXhwcmVzc2lvbikgewogIHZhciByZXN1bHQgPSBzYWZlRXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24uc2xpY2UoNSwgLTEpKTsKICBpZiAocmVzdWx0ID09PSBTVFJfTkFOKSB7CiAgICByZXR1cm4gIiI7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9UZXh0LmpzCnZhciBfZXhjbHVkZWQ2ID0gWyJ4IiwgInkiLCAibGluZUhlaWdodCIsICJjYXBIZWlnaHQiLCAiZmlsbCIsICJzY2FsZVRvRml0IiwgInRleHRBbmNob3IiLCAidmVydGljYWxBbmNob3IiXTsKdmFyIF9leGNsdWRlZDIzID0gWyJkeCIsICJkeSIsICJhbmdsZSIsICJjbGFzc05hbWUiLCAiYnJlYWtBbGwiXTsKZnVuY3Rpb24gX2V4dGVuZHMxMCgpIHsKICByZXR1cm4gX2V4dGVuZHMxMCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U2KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U2KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQlJFQUtJTkdfU1BBQ0VTID0gL1sgXGZcblxyXHRcdlx1MjAyOFx1MjAyOV0rLzsKdmFyIGNhbGN1bGF0ZVdvcmRXaWR0aHMgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBicmVha0FsbCwKICAgIHN0eWxlCiAgfSA9IF9yZWYyOwogIHRyeSB7CiAgICB2YXIgd29yZHMgPSBbXTsKICAgIGlmICghaXNOdWxsaXNoKGNoaWxkcmVuKSkgewogICAgICBpZiAoYnJlYWtBbGwpIHsKICAgICAgICB3b3JkcyA9IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoIiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdvcmRzID0gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdChCUkVBS0lOR19TUEFDRVMpOwogICAgICB9CiAgICB9CiAgICB2YXIgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCA9IHdvcmRzLm1hcCgod29yZCkgPT4gKHsKICAgICAgd29yZCwKICAgICAgd2lkdGg6IGdldFN0cmluZ1NpemUod29yZCwgc3R5bGUpLndpZHRoCiAgICB9KSk7CiAgICB2YXIgc3BhY2VXaWR0aCA9IGJyZWFrQWxsID8gMCA6IGdldFN0cmluZ1NpemUoIlx4QTAiLCBzdHlsZSkud2lkdGg7CiAgICByZXR1cm4gewogICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLAogICAgICBzcGFjZVdpZHRoCiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKZnVuY3Rpb24gaXNWYWxpZFRleHRBbmNob3IodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgPT09ICJzdGFydCIgfHwgdmFsdWUgPT09ICJtaWRkbGUiIHx8IHZhbHVlID09PSAiZW5kIiB8fCB2YWx1ZSA9PT0gImluaGVyaXQiOwp9CnZhciBjYWxjdWxhdGUgPSAod29yZHMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gd29yZHMucmVkdWNlKChyZXN1bHQsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHdvcmQsCiAgICB3aWR0aAogIH0gPSBfcmVmMjsKICB2YXIgY3VycmVudExpbmUgPSByZXN1bHRbcmVzdWx0Lmxlbmd0aCAtIDFdOwogIGlmIChjdXJyZW50TGluZSAmJiB3aWR0aCAhPSBudWxsICYmIChsaW5lV2lkdGggPT0gbnVsbCB8fCBzY2FsZVRvRml0IHx8IGN1cnJlbnRMaW5lLndpZHRoICsgd2lkdGggKyBzcGFjZVdpZHRoIDwgTnVtYmVyKGxpbmVXaWR0aCkpKSB7CiAgICBjdXJyZW50TGluZS53b3Jkcy5wdXNoKHdvcmQpOwogICAgY3VycmVudExpbmUud2lkdGggKz0gd2lkdGggKyBzcGFjZVdpZHRoOwogIH0gZWxzZSB7CiAgICB2YXIgbmV3TGluZSA9IHsKICAgICAgd29yZHM6IFt3b3JkXSwKICAgICAgd2lkdGgKICAgIH07CiAgICByZXN1bHQucHVzaChuZXdMaW5lKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfSwgW10pOwp2YXIgZmluZExvbmdlc3RMaW5lID0gKHdvcmRzKSA9PiB3b3Jkcy5yZWR1Y2UoKGEsIGIpID0+IGEud2lkdGggPiBiLndpZHRoID8gYSA6IGIpOwp2YXIgc3VmZml4ID0gIlx1MjAyNiI7CnZhciBjaGVja092ZXJmbG93ID0gKHRleHQsIGluZGV4LCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpID0+IHsKICB2YXIgdGVtcFRleHQgPSB0ZXh0LnNsaWNlKDAsIGluZGV4KTsKICB2YXIgd29yZHMgPSBjYWxjdWxhdGVXb3JkV2lkdGhzKHsKICAgIGJyZWFrQWxsLAogICAgc3R5bGUsCiAgICBjaGlsZHJlbjogdGVtcFRleHQgKyBzdWZmaXgKICB9KTsKICBpZiAoIXdvcmRzKSB7CiAgICByZXR1cm4gW2ZhbHNlLCBbXV07CiAgfQogIHZhciByZXN1bHQgPSBjYWxjdWxhdGUod29yZHMud29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICB2YXIgZG9lc092ZXJmbG93ID0gcmVzdWx0Lmxlbmd0aCA+IG1heExpbmVzIHx8IGZpbmRMb25nZXN0TGluZShyZXN1bHQpLndpZHRoID4gTnVtYmVyKGxpbmVXaWR0aCk7CiAgcmV0dXJuIFtkb2VzT3ZlcmZsb3csIHJlc3VsdF07Cn07CnZhciBjYWxjdWxhdGVXb3Jkc0J5TGluZXMgPSAoX3JlZjMsIGluaXRpYWxXb3Jkc1dpdGhDb21wdXRlZFdpdGgsIHNwYWNlV2lkdGgsIGxpbmVXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gewogIHZhciB7CiAgICBtYXhMaW5lcywKICAgIGNoaWxkcmVuLAogICAgc3R5bGUsCiAgICBicmVha0FsbAogIH0gPSBfcmVmMzsKICB2YXIgc2hvdWxkTGltaXRMaW5lcyA9IGlzTnVtYmVyKG1heExpbmVzKTsKICB2YXIgdGV4dCA9IFN0cmluZyhjaGlsZHJlbik7CiAgdmFyIG9yaWdpbmFsUmVzdWx0ID0gY2FsY3VsYXRlKGluaXRpYWxXb3Jkc1dpdGhDb21wdXRlZFdpdGgsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgaWYgKCFzaG91bGRMaW1pdExpbmVzIHx8IHNjYWxlVG9GaXQpIHsKICAgIHJldHVybiBvcmlnaW5hbFJlc3VsdDsKICB9CiAgdmFyIG92ZXJmbG93cyA9IG9yaWdpbmFsUmVzdWx0Lmxlbmd0aCA+IG1heExpbmVzIHx8IGZpbmRMb25nZXN0TGluZShvcmlnaW5hbFJlc3VsdCkud2lkdGggPiBOdW1iZXIobGluZVdpZHRoKTsKICBpZiAoIW92ZXJmbG93cykgewogICAgcmV0dXJuIG9yaWdpbmFsUmVzdWx0OwogIH0KICB2YXIgc3RhcnQgPSAwOwogIHZhciBlbmQgPSB0ZXh0Lmxlbmd0aCAtIDE7CiAgdmFyIGl0ZXJhdGlvbnMgPSAwOwogIHZhciB0cmltbWVkUmVzdWx0OwogIHdoaWxlIChzdGFydCA8PSBlbmQgJiYgaXRlcmF0aW9ucyA8PSB0ZXh0Lmxlbmd0aCAtIDEpIHsKICAgIHZhciBtaWRkbGUgPSBNYXRoLmZsb29yKChzdGFydCArIGVuZCkgLyAyKTsKICAgIHZhciBwcmV2ID0gbWlkZGxlIC0gMTsKICAgIHZhciBbZG9lc1ByZXZPdmVyZmxvdywgcmVzdWx0XSA9IGNoZWNrT3ZlcmZsb3codGV4dCwgcHJldiwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICAgIHZhciBbZG9lc01pZGRsZU92ZXJmbG93XSA9IGNoZWNrT3ZlcmZsb3codGV4dCwgbWlkZGxlLCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogICAgaWYgKCFkb2VzUHJldk92ZXJmbG93ICYmICFkb2VzTWlkZGxlT3ZlcmZsb3cpIHsKICAgICAgc3RhcnQgPSBtaWRkbGUgKyAxOwogICAgfQogICAgaWYgKGRvZXNQcmV2T3ZlcmZsb3cgJiYgZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIGVuZCA9IG1pZGRsZSAtIDE7CiAgICB9CiAgICBpZiAoIWRvZXNQcmV2T3ZlcmZsb3cgJiYgZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIHRyaW1tZWRSZXN1bHQgPSByZXN1bHQ7CiAgICAgIGJyZWFrOwogICAgfQogICAgaXRlcmF0aW9ucysrOwogIH0KICByZXR1cm4gdHJpbW1lZFJlc3VsdCB8fCBvcmlnaW5hbFJlc3VsdDsKfTsKdmFyIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZSA9IChjaGlsZHJlbikgPT4gewogIHZhciB3b3JkcyA9ICFpc051bGxpc2goY2hpbGRyZW4pID8gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdChCUkVBS0lOR19TUEFDRVMpIDogW107CiAgcmV0dXJuIFt7CiAgICB3b3JkcywKICAgIHdpZHRoOiB2b2lkIDAKICB9XTsKfTsKdmFyIGdldFdvcmRzQnlMaW5lcyA9IChfcmVmNCkgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIHNjYWxlVG9GaXQsCiAgICBjaGlsZHJlbiwKICAgIHN0eWxlLAogICAgYnJlYWtBbGwsCiAgICBtYXhMaW5lcwogIH0gPSBfcmVmNDsKICBpZiAoKHdpZHRoIHx8IHNjYWxlVG9GaXQpICYmICFHbG9iYWwuaXNTc3IpIHsKICAgIHZhciB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBzcGFjZVdpZHRoOwogICAgdmFyIHdvcmRXaWR0aHMgPSBjYWxjdWxhdGVXb3JkV2lkdGhzKHsKICAgICAgYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuLAogICAgICBzdHlsZQogICAgfSk7CiAgICBpZiAod29yZFdpZHRocykgewogICAgICB2YXIgewogICAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGg6IHdjdywKICAgICAgICBzcGFjZVdpZHRoOiBzdwogICAgICB9ID0gd29yZFdpZHRoczsKICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCA9IHdjdzsKICAgICAgc3BhY2VXaWR0aCA9IHN3OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZShjaGlsZHJlbik7CiAgICB9CiAgICByZXR1cm4gY2FsY3VsYXRlV29yZHNCeUxpbmVzKHsKICAgICAgYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuLAogICAgICBtYXhMaW5lcywKICAgICAgc3R5bGUKICAgIH0sIHdvcmRzV2l0aENvbXB1dGVkV2lkdGgsIHNwYWNlV2lkdGgsIHdpZHRoLCBCb29sZWFuKHNjYWxlVG9GaXQpKTsKICB9CiAgcmV0dXJuIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZShjaGlsZHJlbik7Cn07CnZhciBERUZBVUxUX0ZJTEwgPSAiIzgwODA4MCI7CnZhciB0ZXh0RGVmYXVsdFByb3BzID0gewogIGFuZ2xlOiAwLAogIGJyZWFrQWxsOiBmYWxzZSwKICAvLyBNYWdpYyBudW1iZXIgZnJvbSBkMwogIGNhcEhlaWdodDogIjAuNzFlbSIsCiAgZmlsbDogREVGQVVMVF9GSUxMLAogIGxpbmVIZWlnaHQ6ICIxZW0iLAogIHNjYWxlVG9GaXQ6IGZhbHNlLAogIHRleHRBbmNob3I6ICJzdGFydCIsCiAgLy8gTWFpbnRhaW4gY29tcGF0IHdpdGggZXhpc3RpbmcgY2hhcnRzIC8gZGVmYXVsdCBTVkcgYmVoYXZpb3IKICB2ZXJ0aWNhbEFuY2hvcjogImVuZCIsCiAgeDogMCwKICB5OiAwCn07CnZhciBUZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNS5mb3J3YXJkUmVmKSgob3V0c2lkZVByb3BzLCByZWYpID0+IHsKICB2YXIgX3Jlc29sdmVEZWZhdWx0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgdGV4dERlZmF1bHRQcm9wcyksIHsKICAgIHg6IHByb3BzWCwKICAgIHk6IHByb3BzWSwKICAgIGxpbmVIZWlnaHQsCiAgICBjYXBIZWlnaHQsCiAgICBmaWxsLAogICAgc2NhbGVUb0ZpdCwKICAgIHRleHRBbmNob3IsCiAgICB2ZXJ0aWNhbEFuY2hvcgogIH0gPSBfcmVzb2x2ZURlZmF1bHRQcm9wcywgcHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KF9yZXNvbHZlRGVmYXVsdFByb3BzLCBfZXhjbHVkZWQ2KTsKICB2YXIgd29yZHNCeUxpbmVzID0gKDAsIGltcG9ydF9yZWFjdDI1LnVzZU1lbW8pKCgpID0+IHsKICAgIHJldHVybiBnZXRXb3Jkc0J5TGluZXMoewogICAgICBicmVha0FsbDogcHJvcHMuYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuOiBwcm9wcy5jaGlsZHJlbiwKICAgICAgbWF4TGluZXM6IHByb3BzLm1heExpbmVzLAogICAgICBzY2FsZVRvRml0LAogICAgICBzdHlsZTogcHJvcHMuc3R5bGUsCiAgICAgIHdpZHRoOiBwcm9wcy53aWR0aAogICAgfSk7CiAgfSwgW3Byb3BzLmJyZWFrQWxsLCBwcm9wcy5jaGlsZHJlbiwgcHJvcHMubWF4TGluZXMsIHNjYWxlVG9GaXQsIHByb3BzLnN0eWxlLCBwcm9wcy53aWR0aF0pOwogIHZhciB7CiAgICBkeCwKICAgIGR5LAogICAgYW5nbGUsCiAgICBjbGFzc05hbWUsCiAgICBicmVha0FsbAogIH0gPSBwcm9wcywgdGV4dFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihwcm9wcywgX2V4Y2x1ZGVkMjMpOwogIGlmICghaXNOdW1PclN0cihwcm9wc1gpIHx8ICFpc051bU9yU3RyKHByb3BzWSkgfHwgd29yZHNCeUxpbmVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB4MiA9IE51bWJlcihwcm9wc1gpICsgKGlzTnVtYmVyKGR4KSA/IGR4IDogMCk7CiAgdmFyIHkyID0gTnVtYmVyKHByb3BzWSkgKyAoaXNOdW1iZXIoZHkpID8gZHkgOiAwKTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoeDIpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKHkyKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBzdGFydER5OwogIHN3aXRjaCAodmVydGljYWxBbmNob3IpIHsKICAgIGNhc2UgInN0YXJ0IjoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQoY2FwSGVpZ2h0LCAiKSIpKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJtaWRkbGUiOgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdCgod29yZHNCeUxpbmVzLmxlbmd0aCAtIDEpIC8gMiwgIiAqIC0iKS5jb25jYXQobGluZUhlaWdodCwgIiArICgiKS5jb25jYXQoY2FwSGVpZ2h0LCAiIC8gMikpIikpOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KHdvcmRzQnlMaW5lcy5sZW5ndGggLSAxLCAiICogLSIpLmNvbmNhdChsaW5lSGVpZ2h0LCAiKSIpKTsKICAgICAgYnJlYWs7CiAgfQogIHZhciB0cmFuc2Zvcm1zID0gW107CiAgaWYgKHNjYWxlVG9GaXQpIHsKICAgIHZhciBsaW5lV2lkdGggPSB3b3Jkc0J5TGluZXNbMF0ud2lkdGg7CiAgICB2YXIgewogICAgICB3aWR0aAogICAgfSA9IHByb3BzOwogICAgdHJhbnNmb3Jtcy5wdXNoKCJzY2FsZSgiLmNvbmNhdChpc051bWJlcih3aWR0aCkgJiYgaXNOdW1iZXIobGluZVdpZHRoKSA/IHdpZHRoIC8gbGluZVdpZHRoIDogMSwgIikiKSk7CiAgfQogIGlmIChhbmdsZSkgewogICAgdHJhbnNmb3Jtcy5wdXNoKCJyb3RhdGUoIi5jb25jYXQoYW5nbGUsICIsICIpLmNvbmNhdCh4MiwgIiwgIikuY29uY2F0KHkyLCAiKSIpKTsKICB9CiAgaWYgKHRyYW5zZm9ybXMubGVuZ3RoKSB7CiAgICB0ZXh0UHJvcHMudHJhbnNmb3JtID0gdHJhbnNmb3Jtcy5qb2luKCIgIik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMy5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMCh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyh0ZXh0UHJvcHMpLCB7CiAgICByZWYsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy10ZXh0IiwgY2xhc3NOYW1lKSwKICAgIHRleHRBbmNob3IsCiAgICBmaWxsOiBmaWxsLmluY2x1ZGVzKCJ1cmwiKSA/IERFRkFVTFRfRklMTCA6IGZpbGwKICB9KSwgd29yZHNCeUxpbmVzLm1hcCgobGluZSwgaW5kZXgpID0+IHsKICAgIHZhciB3b3JkcyA9IGxpbmUud29yZHMuam9pbihicmVha0FsbCA/ICIiIDogIiAiKTsKICAgIHJldHVybiAoCiAgICAgIC8vIGR1cGxpY2F0ZSB3b3JkcyB3aWxsIGNhdXNlIGR1cGxpY2F0ZSBrZXlzIHdoaWNoIGlzIHdoeSB3ZSBhZGQgdGhlIGFycmF5IGluZGV4IGhlcmUKICAgICAgLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudCgidHNwYW4iLCB7CiAgICAgICAgeDogeDIsCiAgICAgICAgZHk6IGluZGV4ID09PSAwID8gc3RhcnREeSA6IGxpbmVIZWlnaHQsCiAgICAgICAga2V5OiAiIi5jb25jYXQod29yZHMsICItIikuY29uY2F0KGluZGV4KQogICAgICB9LCB3b3JkcykKICAgICk7CiAgfSkpOwp9KTsKVGV4dC5kaXNwbGF5TmFtZSA9ICJUZXh0IjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9MYWJlbC5qcwp2YXIgUmVhY3QxNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkNyA9IFsibGFiZWxSZWYiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gb3duS2V5czIzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTEoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTEgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczExLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIENhcnRlc2lhbkxhYmVsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciBDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciB2aWV3Qm94ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZU1lbW8pKCgpID0+ICh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCBbeDIsIHkyLCB1cHBlcldpZHRoLCBsb3dlcldpZHRoLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogdmlld0JveAogIH0sIGNoaWxkcmVuKTsKfTsKdmFyIHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCA9ICgpID0+IHsKICB2YXIgbGFiZWxDaGlsZENvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxDb250ZXh0KTsKICB2YXIgY2hhcnRDb250ZXh0ID0gdXNlVmlld0JveCgpOwogIHJldHVybiBsYWJlbENoaWxkQ29udGV4dCB8fCBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQoY2hhcnRDb250ZXh0KTsKfTsKdmFyIFBvbGFyTGFiZWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZVBvbGFyTGFiZWxDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYWJlbENoaWxkQ29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VDb250ZXh0KShQb2xhckxhYmVsQ29udGV4dCk7CiAgdmFyIGNoYXJ0Q29udGV4dCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFBvbGFyVmlld0JveCk7CiAgcmV0dXJuIGxhYmVsQ2hpbGRDb250ZXh0IHx8IGNoYXJ0Q29udGV4dDsKfTsKdmFyIGdldExhYmVsID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHZhbHVlLAogICAgZm9ybWF0dGVyCiAgfSA9IHByb3BzOwogIHZhciBsYWJlbCA9IGlzTnVsbGlzaChwcm9wcy5jaGlsZHJlbikgPyB2YWx1ZSA6IHByb3BzLmNoaWxkcmVuOwogIGlmICh0eXBlb2YgZm9ybWF0dGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZm9ybWF0dGVyKGxhYmVsKTsKICB9CiAgcmV0dXJuIGxhYmVsOwp9Owp2YXIgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24gPSAoY29udGVudCkgPT4gewogIHJldHVybiBjb250ZW50ICE9IG51bGwgJiYgdHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiI7Cn07CnZhciBnZXREZWx0YUFuZ2xlMiA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNjApOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciByZW5kZXJSYWRpYWxMYWJlbCA9IChsYWJlbFByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIG9mZnNldCwKICAgIGNsYXNzTmFtZQogIH0gPSBsYWJlbFByb3BzOwogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsb2NrV2lzZQogIH0gPSB2aWV3Qm94OwogIHZhciByYWRpdXMgPSAoaW5uZXJSYWRpdXMgKyBvdXRlclJhZGl1cykgLyAyOwogIHZhciBkZWx0YUFuZ2xlID0gZ2V0RGVsdGFBbmdsZTIoc3RhcnRBbmdsZSwgZW5kQW5nbGUpOwogIHZhciBzaWduMiA9IGRlbHRhQW5nbGUgPj0gMCA/IDEgOiAtMTsKICB2YXIgbGFiZWxBbmdsZSwgZGlyZWN0aW9uOwogIHN3aXRjaCAocG9zaXRpb24pIHsKICAgIGNhc2UgImluc2lkZVN0YXJ0IjoKICAgICAgbGFiZWxBbmdsZSA9IHN0YXJ0QW5nbGUgKyBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImluc2lkZUVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSAtIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSAhY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSArIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSBjbG9ja1dpc2U7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBwb3NpdGlvbiAiLmNvbmNhdChwb3NpdGlvbikpOwogIH0KICBkaXJlY3Rpb24gPSBkZWx0YUFuZ2xlIDw9IDAgPyBkaXJlY3Rpb24gOiAhZGlyZWN0aW9uOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSArIChkaXJlY3Rpb24gPyAxIDogLTEpICogMzU5KTsKICB2YXIgcGF0aDIgPSAiTSIuY29uY2F0KHN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoc3RhcnRQb2ludC55LCAiXG4gICAgQSIpLmNvbmNhdChyYWRpdXMsICIsIikuY29uY2F0KHJhZGl1cywgIiwwLDEsIikuY29uY2F0KGRpcmVjdGlvbiA/IDAgOiAxLCAiLFxuICAgICIpLmNvbmNhdChlbmRQb2ludC54LCAiLCIpLmNvbmNhdChlbmRQb2ludC55KTsKICB2YXIgaWQgPSBpc051bGxpc2gobGFiZWxQcm9wcy5pZCkgPyB1bmlxdWVJZCgicmVjaGFydHMtcmFkaWFsLWxpbmUtIikgOiBsYWJlbFByb3BzLmlkOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMSh7fSwgYXR0cnMsIHsKICAgIGRvbWluYW50QmFzZWxpbmU6ICJjZW50cmFsIiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmFkaWFsLWJhci1sYWJlbCIsIGNsYXNzTmFtZSkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCB7CiAgICBpZCwKICAgIGQ6IHBhdGgyCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJ0ZXh0UGF0aCIsIHsKICAgIHhsaW5rSHJlZjogIiMiLmNvbmNhdChpZCkKICB9LCBsYWJlbCkpOwp9Owp2YXIgZ2V0QXR0cnNPZlBvbGFyTGFiZWwgPSAodmlld0JveCwgb2Zmc2V0LCBwb3NpdGlvbikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSB2aWV3Qm94OwogIHZhciBtaWRBbmdsZSA9IChzdGFydEFuZ2xlICsgZW5kQW5nbGUpIC8gMjsKICBpZiAocG9zaXRpb24gPT09ICJvdXRzaWRlIikgewogICAgdmFyIHsKICAgICAgeDogX3gsCiAgICAgIHk6IF95CiAgICB9ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzICsgb2Zmc2V0LCBtaWRBbmdsZSk7CiAgICByZXR1cm4gewogICAgICB4OiBfeCwKICAgICAgeTogX3ksCiAgICAgIHRleHRBbmNob3I6IF94ID49IGN4ID8gInN0YXJ0IiA6ICJlbmQiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlciIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiY2VudGVyVG9wIikgewogICAgcmV0dXJuIHsKICAgICAgeDogY3gsCiAgICAgIHk6IGN5LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJzdGFydCIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlckJvdHRvbSIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAiZW5kIgogICAgfTsKICB9CiAgdmFyIHIyID0gKGlubmVyUmFkaXVzICsgb3V0ZXJSYWRpdXMpIC8gMjsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcjIsIG1pZEFuZ2xlKTsKICByZXR1cm4gewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgfTsKfTsKdmFyIGlzUG9sYXIgPSAodmlld0JveCkgPT4gImN4IiBpbiB2aWV3Qm94ICYmIGlzTnVtYmVyKHZpZXdCb3guY3gpOwp2YXIgZ2V0QXR0cnNPZkNhcnRlc2lhbkxhYmVsID0gKHByb3BzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIHBhcmVudFZpZXdCb3g6IHBhcmVudFZpZXdCb3hGcm9tUHJvcHMsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbgogIH0gPSBwcm9wczsKICB2YXIgcGFyZW50Vmlld0JveDsKICBpZiAocGFyZW50Vmlld0JveEZyb21Qcm9wcyAhPSBudWxsICYmICFpc1BvbGFyKHBhcmVudFZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICBwYXJlbnRWaWV3Qm94ID0gcGFyZW50Vmlld0JveEZyb21Qcm9wczsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIGhlaWdodAogIH0gPSB2aWV3Qm94OwogIHZhciB1cHBlclggPSB4MjsKICB2YXIgbG93ZXJYID0geDIgKyAodXBwZXJXaWR0aCAtIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgbWlkZGxlWCA9ICh1cHBlclggKyBsb3dlclgpIC8gMjsKICB2YXIgbWlkSGVpZ2h0V2lkdGggPSAodXBwZXJXaWR0aCArIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgY2VudGVyWCA9IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyOwogIHZhciB2ZXJ0aWNhbFNpZ24gPSBoZWlnaHQgPj0gMCA/IDEgOiAtMTsKICB2YXIgdmVydGljYWxPZmZzZXQgPSB2ZXJ0aWNhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIHZlcnRpY2FsRW5kID0gdmVydGljYWxTaWduID4gMCA/ICJlbmQiIDogInN0YXJ0IjsKICB2YXIgdmVydGljYWxTdGFydCA9IHZlcnRpY2FsU2lnbiA+IDAgPyAic3RhcnQiIDogImVuZCI7CiAgdmFyIGhvcml6b250YWxTaWduID0gdXBwZXJXaWR0aCA+PSAwID8gMSA6IC0xOwogIHZhciBob3Jpem9udGFsT2Zmc2V0ID0gaG9yaXpvbnRhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIGhvcml6b250YWxFbmQgPSBob3Jpem9udGFsU2lnbiA+IDAgPyAiZW5kIiA6ICJzdGFydCI7CiAgdmFyIGhvcml6b250YWxTdGFydCA9IGhvcml6b250YWxTaWduID4gMCA/ICJzdGFydCIgOiAiZW5kIjsKICBpZiAocG9zaXRpb24gPT09ICJ0b3AiKSB7CiAgICB2YXIgYXR0cnMgPSB7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyLAogICAgICB5OiB5MiAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIGF0dHJzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgaGVpZ2h0OiBNYXRoLm1heCh5MiAtIHBhcmVudFZpZXdCb3gueSwgMCksCiAgICAgIHdpZHRoOiB1cHBlcldpZHRoCiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgX2F0dHJzID0gewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyBoZWlnaHQgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRycyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIGhlaWdodDogTWF0aC5tYXgocGFyZW50Vmlld0JveC55ICsgcGFyZW50Vmlld0JveC5oZWlnaHQgLSAoeTIgKyBoZWlnaHQpLCAwKSwKICAgICAgd2lkdGg6IGxvd2VyV2lkdGgKICAgIH0gOiB7fSk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImxlZnQiKSB7CiAgICB2YXIgX2F0dHJzMiA9IHsKICAgICAgeDogbWlkZGxlWCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRyczIpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgoX2F0dHJzMi54IC0gcGFyZW50Vmlld0JveC54LCAwKSwKICAgICAgaGVpZ2h0CiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJyaWdodCIpIHsKICAgIHZhciBfYXR0cnMzID0gewogICAgICB4OiBtaWRkbGVYICsgbWlkSGVpZ2h0V2lkdGggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRyczMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgocGFyZW50Vmlld0JveC54ICsgcGFyZW50Vmlld0JveC53aWR0aCAtIF9hdHRyczMueCwgMCksCiAgICAgIGhlaWdodAogICAgfSA6IHt9KTsKICB9CiAgdmFyIHNpemVBdHRycyA9IHBhcmVudFZpZXdCb3ggPyB7CiAgICB3aWR0aDogbWlkSGVpZ2h0V2lkdGgsCiAgICBoZWlnaHQKICB9IDoge307CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBtaWRkbGVYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbWlkZGxlWCArIG1pZEhlaWdodFdpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b20iKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcExlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlVG9wUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21MZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IGxvd2VyWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21SaWdodCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAoISFwb3NpdGlvbiAmJiB0eXBlb2YgcG9zaXRpb24gPT09ICJvYmplY3QiICYmIChpc051bWJlcihwb3NpdGlvbi54KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueCkpICYmIChpc051bWJlcihwb3NpdGlvbi55KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueSkpKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogeDIgKyBnZXRQZXJjZW50VmFsdWUocG9zaXRpb24ueCwgbWlkSGVpZ2h0V2lkdGgpLAogICAgICB5OiB5MiArIGdldFBlcmNlbnRWYWx1ZShwb3NpdGlvbi55LCBoZWlnaHQpLAogICAgICB0ZXh0QW5jaG9yOiAiZW5kIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJlbmQiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgIHg6IGNlbnRlclgsCiAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogIH0sIHNpemVBdHRycyk7Cn07CnZhciBkZWZhdWx0TGFiZWxQcm9wcyA9IHsKICBhbmdsZTogMCwKICBvZmZzZXQ6IDUsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMubGFiZWwsCiAgcG9zaXRpb246ICJtaWRkbGUiLAogIHRleHRCcmVha0FsbDogZmFsc2UKfTsKZnVuY3Rpb24gTGFiZWwob3V0ZXJQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0ZXJQcm9wcywgZGVmYXVsdExhYmVsUHJvcHMpOwogIHZhciB7CiAgICB2aWV3Qm94OiB2aWV3Qm94RnJvbVByb3BzLAogICAgcG9zaXRpb24sCiAgICB2YWx1ZSwKICAgIGNoaWxkcmVuLAogICAgY29udGVudCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgdGV4dEJyZWFrQWxsLAogICAgbGFiZWxSZWYKICB9ID0gcHJvcHM7CiAgdmFyIHBvbGFyVmlld0JveCA9IHVzZVBvbGFyTGFiZWxDb250ZXh0KCk7CiAgdmFyIGNhcnRlc2lhblZpZXdCb3ggPSB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQoKTsKICB2YXIgcmVzb2x2ZWRWaWV3Qm94ID0gcG9zaXRpb24gPT09ICJjZW50ZXIiID8gY2FydGVzaWFuVmlld0JveCA6IHBvbGFyVmlld0JveCAhPT0gbnVsbCAmJiBwb2xhclZpZXdCb3ggIT09IHZvaWQgMCA/IHBvbGFyVmlld0JveCA6IGNhcnRlc2lhblZpZXdCb3g7CiAgdmFyIHZpZXdCb3gsIGxhYmVsLCBwb3NpdGlvbkF0dHJzOwogIGlmICh2aWV3Qm94RnJvbVByb3BzID09IG51bGwpIHsKICAgIHZpZXdCb3ggPSByZXNvbHZlZFZpZXdCb3g7CiAgfSBlbHNlIGlmIChpc1BvbGFyKHZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICB2aWV3Qm94ID0gdmlld0JveEZyb21Qcm9wczsKICB9IGVsc2UgewogICAgdmlld0JveCA9IGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZCh2aWV3Qm94RnJvbVByb3BzKTsKICB9CiAgaWYgKCF2aWV3Qm94IHx8IGlzTnVsbGlzaCh2YWx1ZSkgJiYgaXNOdWxsaXNoKGNoaWxkcmVuKSAmJiAhLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkgJiYgdHlwZW9mIGNvbnRlbnQgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJvcHNXaXRoVmlld0JveCA9IF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIHByb3BzKSwge30sIHsKICAgIHZpZXdCb3gKICB9KTsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkpIHsKICAgIHZhciB7CiAgICAgIGxhYmVsUmVmOiBfCiAgICB9ID0gcHJvcHNXaXRoVmlld0JveCwgcHJvcHNXaXRob3V0TGFiZWxSZWYgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM3KHByb3BzV2l0aFZpZXdCb3gsIF9leGNsdWRlZDcpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShjb250ZW50LCBwcm9wc1dpdGhvdXRMYWJlbFJlZik7CiAgfQogIGlmICh0eXBlb2YgY29udGVudCA9PT0gImZ1bmN0aW9uIikgewogICAgbGFiZWwgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUVsZW1lbnQpKGNvbnRlbnQsIHByb3BzV2l0aFZpZXdCb3gpOwogICAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSkgewogICAgICByZXR1cm4gbGFiZWw7CiAgICB9CiAgfSBlbHNlIHsKICAgIGxhYmVsID0gZ2V0TGFiZWwocHJvcHMpOwogIH0KICB2YXIgYXR0cnMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKTsKICBpZiAoaXNQb2xhcih2aWV3Qm94KSkgewogICAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlU3RhcnQiIHx8IHBvc2l0aW9uID09PSAiaW5zaWRlRW5kIiB8fCBwb3NpdGlvbiA9PT0gImVuZCIpIHsKICAgICAgcmV0dXJuIHJlbmRlclJhZGlhbExhYmVsKHByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KTsKICAgIH0KICAgIHBvc2l0aW9uQXR0cnMgPSBnZXRBdHRyc09mUG9sYXJMYWJlbCh2aWV3Qm94LCBwcm9wcy5vZmZzZXQsIHByb3BzLnBvc2l0aW9uKTsKICB9IGVsc2UgewogICAgcG9zaXRpb25BdHRycyA9IGdldEF0dHJzT2ZDYXJ0ZXNpYW5MYWJlbChwcm9wcywgdmlld0JveCk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxMSh7CiAgICByZWY6IGxhYmVsUmVmLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1sYWJlbCIsIGNsYXNzTmFtZSkKICB9LCBhdHRycywgcG9zaXRpb25BdHRycywgewogICAgLyoKICAgICAqIHRleHRBbmNob3IgaXMgZGVjaWRlZCBieSBkZWZhdWx0IGJhc2VkIG9uIHRoZSBgcG9zaXRpb25gCiAgICAgKiBidXQgd2UgYWxsb3cgb3ZlcnJpZGluZyB2aWEgcHJvcHMgZm9yIHByZWNpc2UgY29udHJvbC4KICAgICAqLwogICAgdGV4dEFuY2hvcjogaXNWYWxpZFRleHRBbmNob3IoYXR0cnMudGV4dEFuY2hvcikgPyBhdHRycy50ZXh0QW5jaG9yIDogcG9zaXRpb25BdHRycy50ZXh0QW5jaG9yLAogICAgYnJlYWtBbGw6IHRleHRCcmVha0FsbAogIH0pLCBsYWJlbCkpOwp9CkxhYmVsLmRpc3BsYXlOYW1lID0gIkxhYmVsIjsKdmFyIHBhcnNlTGFiZWwgPSAobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSA9PiB7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBjb21tb25Qcm9wcyA9IHsKICAgIHZpZXdCb3gsCiAgICBsYWJlbFJlZgogIH07CiAgaWYgKGxhYmVsID09PSB0cnVlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTnVtT3JTdHIobGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgdmFsdWU6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkobGFiZWwpKSB7CiAgICBpZiAobGFiZWwudHlwZSA9PT0gTGFiZWwpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShsYWJlbCwgX29iamVjdFNwcmVhZDIzKHsKICAgICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgICAgfSwgY29tbW9uUHJvcHMpKTsKICAgIH0KICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAobGFiZWwgJiYgdHlwZW9mIGxhYmVsID09PSAib2JqZWN0IikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoe30sIGxhYmVsLCB7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcChfcmVmMykgewogIHZhciB7CiAgICBsYWJlbCwKICAgIGxhYmVsUmVmCiAgfSA9IF9yZWYzOwogIHZhciB2aWV3Qm94ID0gdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0KCk7CiAgcmV0dXJuIHBhcnNlTGFiZWwobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSB8fCBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvTGFiZWxMaXN0LmpzCnZhciBSZWFjdDE1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfbGFzdCA9IF9fdG9FU00ocmVxdWlyZV9sYXN0MygpKTsKdmFyIF9leGNsdWRlZDggPSBbInZhbHVlQWNjZXNzb3IiXTsKdmFyIF9leGNsdWRlZDI0ID0gWyJkYXRhS2V5IiwgImNsb2NrV2lzZSIsICJpZCIsICJ0ZXh0QnJlYWtBbGwiLCAiekluZGV4Il07CmZ1bmN0aW9uIF9leHRlbmRzMTIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGRlZmF1bHRBY2Nlc3NvciA9IChlbnRyeSkgPT4gQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkgPyAoMCwgaW1wb3J0X2xhc3QuZGVmYXVsdCkoZW50cnkudmFsdWUpIDogZW50cnkudmFsdWU7CnZhciBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNy5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyID0gQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dC5Qcm92aWRlcjsKdmFyIFBvbGFyTGFiZWxMaXN0Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjcuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIFBvbGFyTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyID0gUG9sYXJMYWJlbExpc3RDb250ZXh0LlByb3ZpZGVyOwpmdW5jdGlvbiB1c2VDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KCkgewogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MjcudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCk7Cn0KZnVuY3Rpb24gdXNlUG9sYXJMYWJlbExpc3RDb250ZXh0KCkgewogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MjcudXNlQ29udGV4dCkoUG9sYXJMYWJlbExpc3RDb250ZXh0KTsKfQpmdW5jdGlvbiBMYWJlbExpc3QoX3JlZjIpIHsKICB2YXIgewogICAgdmFsdWVBY2Nlc3NvciA9IGRlZmF1bHRBY2Nlc3NvcgogIH0gPSBfcmVmMiwgcmVzdFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChfcmVmMiwgX2V4Y2x1ZGVkOCk7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBjbG9ja1dpc2UsCiAgICBpZCwKICAgIHRleHRCcmVha0FsbCwKICAgIHpJbmRleAogIH0gPSByZXN0UHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczgocmVzdFByb3BzLCBfZXhjbHVkZWQyNCk7CiAgdmFyIGNhcnRlc2lhbkRhdGEgPSB1c2VDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KCk7CiAgdmFyIHBvbGFyRGF0YSA9IHVzZVBvbGFyTGFiZWxMaXN0Q29udGV4dCgpOwogIHZhciBkYXRhID0gY2FydGVzaWFuRGF0YSB8fCBwb2xhckRhdGE7CiAgaWYgKCFkYXRhIHx8ICFkYXRhLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHpJbmRleCAhPT0gbnVsbCAmJiB6SW5kZXggIT09IHZvaWQgMCA/IHpJbmRleCA6IERlZmF1bHRaSW5kZXhlcy5sYWJlbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWxhYmVsLWxpc3QiCiAgfSwgZGF0YS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgdmFyIF9yZXN0UHJvcHMkZmlsbDsKICAgIHZhciB2YWx1ZSA9IGlzTnVsbGlzaChkYXRhS2V5KSA/IHZhbHVlQWNjZXNzb3IoZW50cnksIGluZGV4KSA6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5ICYmIGVudHJ5LnBheWxvYWQsIGRhdGFLZXkpOwogICAgdmFyIGlkUHJvcHMgPSBpc051bGxpc2goaWQpID8ge30gOiB7CiAgICAgIGlkOiAiIi5jb25jYXQoaWQsICItIikuY29uY2F0KGluZGV4KQogICAgfTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczEyKHsKICAgICAga2V5OiAibGFiZWwtIi5jb25jYXQoaW5kZXgpCiAgICB9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGVudHJ5KSwgb3RoZXJzLCBpZFByb3BzLCB7CiAgICAgIC8qCiAgICAgICAqIFByZWZlciB0byB1c2UgdGhlIGV4cGxpY2l0IGZpbGwgZnJvbSBMYWJlbExpc3QgcHJvcHMuCiAgICAgICAqIE9ubHkgaW4gYW4gYWJzZW5jZSBvZiB0aGF0LCBmYWxsIGJhY2sgdG8gdGhlIGZpbGwgb2YgdGhlIGVudHJ5LgogICAgICAgKiBUaGUgZW50cnkgZmlsbCBjYW4gYmUgcXVpdGUgZGlmZmljdWx0IHRvIHNlZSBlc3BlY2lhbGx5IGluIEJhciwgUGllLCBSYWRpYWxCYXIgaW4gaW5zaWRlIHBvc2l0aW9ucy4KICAgICAgICogT24gdGhlIG90aGVyIGhhbmQgaXQncyBxdWl0ZSBjb252ZW5pZW50IGluIFNjYXR0ZXIsIExpbmUsIG9yIHdoZW4gdGhlIHBvc2l0aW9uIGlzIG91dHNpZGUgdGhlIEJhciwgUGllIGZpbGxlZCBzaGFwZXMuCiAgICAgICAqLwogICAgICBmaWxsOiAoX3Jlc3RQcm9wcyRmaWxsID0gcmVzdFByb3BzLmZpbGwpICE9PSBudWxsICYmIF9yZXN0UHJvcHMkZmlsbCAhPT0gdm9pZCAwID8gX3Jlc3RQcm9wcyRmaWxsIDogZW50cnkuZmlsbCwKICAgICAgcGFyZW50Vmlld0JveDogZW50cnkucGFyZW50Vmlld0JveCwKICAgICAgdmFsdWUsCiAgICAgIHRleHRCcmVha0FsbCwKICAgICAgdmlld0JveDogZW50cnkudmlld0JveCwKICAgICAgaW5kZXgsCiAgICAgIHpJbmRleDogMAogICAgfSkpOwogIH0pKSk7Cn0KTGFiZWxMaXN0LmRpc3BsYXlOYW1lID0gIkxhYmVsTGlzdCI7CmZ1bmN0aW9uIExhYmVsTGlzdEZyb21MYWJlbFByb3AoX3JlZjIpIHsKICB2YXIgewogICAgbGFiZWwKICB9ID0gX3JlZjI7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChsYWJlbCA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCB7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIKICAgIH0pOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MTUuaXNWYWxpZEVsZW1lbnQobGFiZWwpIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCB7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9KTsKICB9CiAgaWYgKHR5cGVvZiBsYWJlbCA9PT0gIm9iamVjdCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIKICAgIH0sIGxhYmVsLCB7CiAgICAgIHR5cGU6IFN0cmluZyhsYWJlbC50eXBlKQogICAgfSkpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvRG90LmpzCnZhciBSZWFjdDE2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczEzKCkgewogIHJldHVybiBfZXh0ZW5kczEzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBEb3QgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHI6IHIyLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtZG90IiwgY2xhc3NOYW1lKTsKICBpZiAoaXNOdW1iZXIoY3gpICYmIGlzTnVtYmVyKGN5KSAmJiBpc051bWJlcihyMikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNi5jcmVhdGVFbGVtZW50KCJjaXJjbGUiLCBfZXh0ZW5kczEzKHt9LCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpLCBhZGFwdEV2ZW50SGFuZGxlcnMocHJvcHMpLCB7CiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByOiByMgogICAgfSkpOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3BvbGFyQXhpc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU2ID0gewogIHJhZGl1c0F4aXM6IHt9LAogIGFuZ2xlQXhpczoge30KfTsKdmFyIHBvbGFyQXhpc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJwb2xhckF4aXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNiwKICByZWR1Y2VyczogewogICAgYWRkUmFkaXVzQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnJhZGl1c0F4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVSYWRpdXNBeGlzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgZGVsZXRlIHN0YXRlLnJhZGl1c0F4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgfSwKICAgIGFkZEFuZ2xlQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmFuZ2xlQXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZUFuZ2xlQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5hbmdsZUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkUmFkaXVzQXhpcywKICByZW1vdmVSYWRpdXNBeGlzLAogIGFkZEFuZ2xlQXhpcywKICByZW1vdmVBbmdsZUF4aXMKfSA9IHBvbGFyQXhpc1NsaWNlLmFjdGlvbnM7CnZhciBwb2xhckF4aXNSZWR1Y2VyID0gcG9sYXJBeGlzU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUmVhY3RVdGlscy5qcwp2YXIgaW1wb3J0X3JlYWN0MjggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpc0NsaXBEb3QgPSAoZG90KSA9PiB7CiAgaWYgKGRvdCAmJiB0eXBlb2YgZG90ID09PSAib2JqZWN0IiAmJiAiY2xpcERvdCIgaW4gZG90KSB7CiAgICByZXR1cm4gQm9vbGVhbihkb3QuY2xpcERvdCk7CiAgfQogIHJldHVybiB0cnVlOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MuanMKdmFyIGltcG9ydF9yZWFjdDI5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRUb29sdGlwRW50cnlTZXR0aW5ncyhfcmVmMikgewogIHZhciB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncwogIH0gPSBfcmVmMjsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MjkudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MjkudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3ModG9vbHRpcEVudHJ5U2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHRvb2x0aXBFbnRyeVNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5ncyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogdG9vbHRpcEVudHJ5U2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSB0b29sdGlwRW50cnlTZXR0aW5nczsKICB9LCBbdG9vbHRpcEVudHJ5U2V0dGluZ3MsIGRpc3BhdGNoLCBpc1Bhbm9yYW1hXSk7CiAgKDAsIGltcG9ydF9yZWFjdDI5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3MocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldExlZ2VuZFBheWxvYWQuanMKdmFyIGltcG9ydF9yZWFjdDMwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRMZWdlbmRQYXlsb2FkKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxlZ2VuZFBheWxvYWQKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlBheWxvYWRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRMZWdlbmRQYXlsb2FkKGxlZ2VuZFBheWxvYWQpKTsKICAgIH0gZWxzZSBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCAhPT0gbGVnZW5kUGF5bG9hZCkgewogICAgICBkaXNwYXRjaChyZXBsYWNlTGVnZW5kUGF5bG9hZCh7CiAgICAgICAgcHJldjogcHJldlBheWxvYWRSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBsZWdlbmRQYXlsb2FkCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBsZWdlbmRQYXlsb2FkOwogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGVnZW5kUGF5bG9hZF0pOwogICgwLCBpbXBvcnRfcmVhY3QzMC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlTGVnZW5kUGF5bG9hZChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlBheWxvYWRSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIFJlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlSWQuanMKdmFyIFJlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfcmVmOwp2YXIgdXNlSWRGYWxsYmFjayA9ICgpID0+IHsKICB2YXIgW2lkXSA9IFJlYWN0MTcudXNlU3RhdGUoKCkgPT4gdW5pcXVlSWQoInVpZC0iKSk7CiAgcmV0dXJuIGlkOwp9Owp2YXIgdXNlSWQgPSAoX3JlZiA9IFJlYWN0MTdbInVzZUlkIi50b1N0cmluZygpXSkgIT09IG51bGwgJiYgX3JlZiAhPT0gdm9pZCAwID8gX3JlZiA6IHVzZUlkRmFsbGJhY2s7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZVVuaXF1ZUlkLmpzCmZ1bmN0aW9uIHVzZVVuaXF1ZUlkKHByZWZpeCwgY3VzdG9tSWQpIHsKICB2YXIgZ2VuZXJhdGVkSWQgPSB1c2VJZCgpOwogIGlmIChjdXN0b21JZCkgewogICAgcmV0dXJuIGN1c3RvbUlkOwogIH0KICByZXR1cm4gcHJlZml4ID8gIiIuY29uY2F0KHByZWZpeCwgIi0iKS5jb25jYXQoZ2VuZXJhdGVkSWQpIDogZ2VuZXJhdGVkSWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIEdyYXBoaWNhbEl0ZW1JZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMxLmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBpZCwKICAgIHR5cGUsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgcmVzb2x2ZWRJZCA9IHVzZVVuaXF1ZUlkKCJyZWNoYXJ0cy0iLmNvbmNhdCh0eXBlKSwgaWQpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOC5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1JZENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiByZXNvbHZlZElkCiAgfSwgY2hpbGRyZW4ocmVzb2x2ZWRJZCkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgaW1wb3J0X3JlYWN0MzIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ncmFwaGljYWxJdGVtc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU3ID0gewogIGNhcnRlc2lhbkl0ZW1zOiBbXSwKICBwb2xhckl0ZW1zOiBbXQp9Owp2YXIgZ3JhcGhpY2FsSXRlbXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiZ3JhcGhpY2FsSXRlbXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNywKICByZWR1Y2VyczogewogICAgYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5jYXJ0ZXNpYW5JdGVtcy5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLmNhcnRlc2lhbkl0ZW1zW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5jYXJ0ZXNpYW5JdGVtcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRQb2xhckdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUucG9sYXJJdGVtcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVBvbGFyR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wb2xhckl0ZW1zLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBvbGFySXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sCiAgYWRkUG9sYXJHcmFwaGljYWxJdGVtLAogIHJlbW92ZVBvbGFyR3JhcGhpY2FsSXRlbQp9ID0gZ3JhcGhpY2FsSXRlbXNTbGljZS5hY3Rpb25zOwp2YXIgZ3JhcGhpY2FsSXRlbXNSZWR1Y2VyID0gZ3JhcGhpY2FsSXRlbXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbUltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2UHJvcHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzIudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbShwcm9wcykpOwogICAgfSBlbHNlIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCAhPT0gcHJvcHMpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0oewogICAgICAgIHByZXY6IHByZXZQcm9wc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHByb3BzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQcm9wc1JlZi5jdXJyZW50ID0gcHJvcHM7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogICgwLCBpbXBvcnRfcmVhY3QzMi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0ocHJldlByb3BzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2UHJvcHNSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn07CnZhciBTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMi5tZW1vKShTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtSW1wbCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvRG90cy5qcwp2YXIgUmVhY3QxOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDMzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkOSA9IFsicG9pbnRzIl07CmZ1bmN0aW9uIG93bktleXMyNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE0KCkgewogIHJldHVybiBfZXh0ZW5kczE0ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczkoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTkoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTkocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIERvdEl0ZW0oX3JlZjIpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgZG90UHJvcHMsCiAgICBjbGFzc05hbWUKICB9ID0gX3JlZjI7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzMuaXNWYWxpZEVsZW1lbnQpKG9wdGlvbikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMzLmNsb25lRWxlbWVudCkob3B0aW9uLCBkb3RQcm9wcyk7CiAgfQogIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gb3B0aW9uKGRvdFByb3BzKTsKICB9CiAgdmFyIGZpbmFsQ2xhc3NOYW1lID0gY2xzeChjbGFzc05hbWUsIHR5cGVvZiBvcHRpb24gIT09ICJib29sZWFuIiA/IG9wdGlvbi5jbGFzc05hbWUgOiAiIik7CiAgdmFyIF9yZWYyMiA9IGRvdFByb3BzICE9PSBudWxsICYmIGRvdFByb3BzICE9PSB2b2lkIDAgPyBkb3RQcm9wcyA6IHt9LCB7CiAgICBwb2ludHMKICB9ID0gX3JlZjIyLCBwcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczkoX3JlZjIyLCBfZXhjbHVkZWQ5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChEb3QsIF9leHRlbmRzMTQoe30sIHByb3BzLCB7CiAgICBjbGFzc05hbWU6IGZpbmFsQ2xhc3NOYW1lCiAgfSkpOwp9CmZ1bmN0aW9uIHNob3VsZFJlbmRlckRvdHMocG9pbnRzLCBkb3QpIHsKICBpZiAocG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKGRvdCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBwb2ludHMubGVuZ3RoID09PSAxOwp9CmZ1bmN0aW9uIERvdHMoX3JlZjMpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgZG90LAogICAgY2xhc3NOYW1lLAogICAgZG90Q2xhc3NOYW1lLAogICAgZGF0YUtleSwKICAgIGJhc2VQcm9wcywKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5zY2F0dGVyCiAgfSA9IF9yZWYzOwogIGlmICghc2hvdWxkUmVuZGVyRG90cyhwb2ludHMsIGRvdCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgY2xpcERvdCA9IGlzQ2xpcERvdChkb3QpOwogIHZhciBjdXN0b21Eb3RQcm9wcyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHNGcm9tVW5rbm93bihkb3QpOwogIHZhciBkb3RzID0gcG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBfZW50cnkkeCwgX2VudHJ5JHk7CiAgICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjQoX29iamVjdFNwcmVhZDI0KF9vYmplY3RTcHJlYWQyNCh7CiAgICAgIHI6IDMKICAgIH0sIGJhc2VQcm9wcyksIGN1c3RvbURvdFByb3BzKSwge30sIHsKICAgICAgaW5kZXg6IGksCiAgICAgIGN4OiAoX2VudHJ5JHggPSBlbnRyeS54KSAhPT0gbnVsbCAmJiBfZW50cnkkeCAhPT0gdm9pZCAwID8gX2VudHJ5JHggOiB2b2lkIDAsCiAgICAgIGN5OiAoX2VudHJ5JHkgPSBlbnRyeS55KSAhPT0gbnVsbCAmJiBfZW50cnkkeSAhPT0gdm9pZCAwID8gX2VudHJ5JHkgOiB2b2lkIDAsCiAgICAgIGRhdGFLZXksCiAgICAgIHZhbHVlOiBlbnRyeS52YWx1ZSwKICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZCwKICAgICAgcG9pbnRzCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KERvdEl0ZW0sIHsKICAgICAga2V5OiAiZG90LSIuY29uY2F0KGkpLAogICAgICBvcHRpb246IGRvdCwKICAgICAgZG90UHJvcHMsCiAgICAgIGNsYXNzTmFtZTogZG90Q2xhc3NOYW1lCiAgICB9KTsKICB9KTsKICB2YXIgbGF5ZXJQcm9wcyA9IHt9OwogIGlmIChuZWVkQ2xpcCAmJiBjbGlwUGF0aElkICE9IG51bGwpIHsKICAgIGxheWVyUHJvcHMuY2xpcFBhdGggPSAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwRG90ID8gIiIgOiAiZG90cy0iKS5jb25jYXQoY2xpcFBhdGhJZCwgIikiKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIF9leHRlbmRzMTQoewogICAgY2xhc3NOYW1lCiAgfSwgbGF5ZXJQcm9wcyksIGRvdHMpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0FjdGl2ZVBvaW50cy5qcwp2YXIgUmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvY2FydGVzaWFuQXhpc1NsaWNlLmpzCmZ1bmN0aW9uIG93bktleXMyNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgaW5pdGlhbFN0YXRlOCA9IHsKICB4QXhpczoge30sCiAgeUF4aXM6IHt9LAogIHpBeGlzOiB7fQp9Owp2YXIgY2FydGVzaWFuQXhpc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjYXJ0ZXNpYW5BeGlzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTgsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnhBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUueEF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnhBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUueEF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS54QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUueUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS55QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUueUF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS55QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnlBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS56QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS56QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnpBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUuekF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHVwZGF0ZVlBeGlzV2lkdGgoc3RhdGUsIGFjdGlvbikgewogICAgICB2YXIgewogICAgICAgIGlkLAogICAgICAgIHdpZHRoCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgdmFyIGF4aXMgPSBzdGF0ZS55QXhpc1tpZF07CiAgICAgIGlmIChheGlzKSB7CiAgICAgICAgdmFyIGhpc3RvcnkgPSBheGlzLndpZHRoSGlzdG9yeSB8fCBbXTsKICAgICAgICBpZiAoaGlzdG9yeS5sZW5ndGggPT09IDMgJiYgaGlzdG9yeVswXSA9PT0gaGlzdG9yeVsyXSAmJiB3aWR0aCA9PT0gaGlzdG9yeVsxXSAmJiB3aWR0aCAhPT0gYXhpcy53aWR0aCAmJiBNYXRoLmFicyh3aWR0aCAtIGhpc3RvcnlbMF0pIDw9IDEpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld0hpc3RvcnkgPSBbLi4uaGlzdG9yeSwgd2lkdGhdLnNsaWNlKC0zKTsKICAgICAgICBzdGF0ZS55QXhpc1tpZF0gPSBfb2JqZWN0U3ByZWFkMjUoX29iamVjdFNwcmVhZDI1KHt9LCBzdGF0ZS55QXhpc1tpZF0pLCB7fSwgewogICAgICAgICAgd2lkdGgsCiAgICAgICAgICB3aWR0aEhpc3Rvcnk6IG5ld0hpc3RvcnkKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkWEF4aXMsCiAgcmVwbGFjZVhBeGlzLAogIHJlbW92ZVhBeGlzLAogIGFkZFlBeGlzLAogIHJlcGxhY2VZQXhpcywKICByZW1vdmVZQXhpcywKICBhZGRaQXhpcywKICByZXBsYWNlWkF4aXMsCiAgcmVtb3ZlWkF4aXMsCiAgdXBkYXRlWUF4aXNXaWR0aAp9ID0gY2FydGVzaWFuQXhpc1NsaWNlLmFjdGlvbnM7CnZhciBjYXJ0ZXNpYW5BeGlzUmVkdWNlciA9IGNhcnRlc2lhbkF4aXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0LmpzCnZhciBzZWxlY3RDaGFydE9mZnNldCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgKG9mZnNldEludGVybmFsKSA9PiB7CiAgcmV0dXJuIHsKICAgIHRvcDogb2Zmc2V0SW50ZXJuYWwudG9wLAogICAgYm90dG9tOiBvZmZzZXRJbnRlcm5hbC5ib3R0b20sCiAgICBsZWZ0OiBvZmZzZXRJbnRlcm5hbC5sZWZ0LAogICAgcmlnaHQ6IG9mZnNldEludGVybmFsLnJpZ2h0CiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0UGxvdEFyZWEuanMKdmFyIHNlbGVjdFBsb3RBcmVhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0LCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChvZmZzZXQsIGNoYXJ0V2lkdGgsIGNoYXJ0SGVpZ2h0KSA9PiB7CiAgaWYgKCFvZmZzZXQgfHwgY2hhcnRXaWR0aCA9PSBudWxsIHx8IGNoYXJ0SGVpZ2h0ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB7CiAgICB4OiBvZmZzZXQubGVmdCwKICAgIHk6IG9mZnNldC50b3AsCiAgICB3aWR0aDogTWF0aC5tYXgoMCwgY2hhcnRXaWR0aCAtIG9mZnNldC5sZWZ0IC0gb2Zmc2V0LnJpZ2h0KSwKICAgIGhlaWdodDogTWF0aC5tYXgoMCwgY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbSkKICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2hvb2tzLmpzCnZhciB1c2VQbG90QXJlYSA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0UGxvdEFyZWEpOwp9Owp2YXIgdXNlQWN0aXZlVG9vbHRpcERhdGFQb2ludHMgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9BY3RpdmVQb2ludHMuanMKZnVuY3Rpb24gb3duS2V5czI2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjYoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjYoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBBY3RpdmVQb2ludCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBwb2ludDogcG9pbnQ0LAogICAgY2hpbGRJbmRleCwKICAgIG1haW5Db2xvciwKICAgIGFjdGl2ZURvdCwKICAgIGRhdGFLZXksCiAgICBjbGlwUGF0aAogIH0gPSBfcmVmMjsKICBpZiAoYWN0aXZlRG90ID09PSBmYWxzZSB8fCBwb2ludDQueCA9PSBudWxsIHx8IHBvaW50NC55ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgZG90UHJvcHNUeXBlZCA9IHsKICAgIGluZGV4OiBjaGlsZEluZGV4LAogICAgZGF0YUtleSwKICAgIGN4OiBwb2ludDQueCwKICAgIGN5OiBwb2ludDQueSwKICAgIHI6IDQsCiAgICBmaWxsOiBtYWluQ29sb3IgIT09IG51bGwgJiYgbWFpbkNvbG9yICE9PSB2b2lkIDAgPyBtYWluQ29sb3IgOiAibm9uZSIsCiAgICBzdHJva2VXaWR0aDogMiwKICAgIHN0cm9rZTogIiNmZmYiLAogICAgcGF5bG9hZDogcG9pbnQ0LnBheWxvYWQsCiAgICB2YWx1ZTogcG9pbnQ0LnZhbHVlCiAgfTsKICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjYoX29iamVjdFNwcmVhZDI2KF9vYmplY3RTcHJlYWQyNih7fSwgZG90UHJvcHNUeXBlZCksIHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGFjdGl2ZURvdCkpLCBhZGFwdEV2ZW50SGFuZGxlcnMoYWN0aXZlRG90KSk7CiAgdmFyIGRvdDsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5pc1ZhbGlkRWxlbWVudCkoYWN0aXZlRG90KSkgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5jbG9uZUVsZW1lbnQpKGFjdGl2ZURvdCwgZG90UHJvcHMpOwogIH0gZWxzZSBpZiAodHlwZW9mIGFjdGl2ZURvdCA9PT0gImZ1bmN0aW9uIikgewogICAgZG90ID0gYWN0aXZlRG90KGRvdFByb3BzKTsKICB9IGVsc2UgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChEb3QsIGRvdFByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFjdGl2ZS1kb3QiLAogICAgY2xpcFBhdGgKICB9LCBkb3QpOwp9OwpmdW5jdGlvbiBBY3RpdmVQb2ludHMoX3JlZjIpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgbWFpbkNvbG9yLAogICAgYWN0aXZlRG90LAogICAgaXRlbURhdGFLZXksCiAgICBjbGlwUGF0aCwKICAgIHpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5hY3RpdmVEb3QKICB9ID0gX3JlZjI7CiAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCk7CiAgdmFyIGFjdGl2ZURhdGFQb2ludHMgPSB1c2VBY3RpdmVUb29sdGlwRGF0YVBvaW50cygpOwogIGlmIChwb2ludHMgPT0gbnVsbCB8fCBhY3RpdmVEYXRhUG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgYWN0aXZlUG9pbnQgPSBwb2ludHMuZmluZCgocCkgPT4gYWN0aXZlRGF0YVBvaW50cy5pbmNsdWRlcyhwLnBheWxvYWQpKTsKICBpZiAoaXNOdWxsaXNoKGFjdGl2ZVBvaW50KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50LCB7CiAgICBwb2ludDogYWN0aXZlUG9pbnQsCiAgICBjaGlsZEluZGV4OiBOdW1iZXIoYWN0aXZlVG9vbHRpcEluZGV4KSwKICAgIG1haW5Db2xvciwKICAgIGRhdGFLZXk6IGl0ZW1EYXRhS2V5LAogICAgYWN0aXZlRG90LAogICAgY2xpcFBhdGgKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2Vycm9yQmFyU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTkgPSB7fTsKdmFyIGVycm9yQmFyU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImVycm9yQmFycyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU5LAogIHJlZHVjZXJzOiB7CiAgICBhZGRFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoIXN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gW107CiAgICAgIH0KICAgICAgc3RhdGVbaXRlbUlkXS5wdXNoKGVycm9yQmFyKTsKICAgIH0sCiAgICByZXBsYWNlRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIHByZXYsCiAgICAgICAgbmV4dAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IHN0YXRlW2l0ZW1JZF0ubWFwKChlKSA9PiBlLmRhdGFLZXkgPT09IHByZXYuZGF0YUtleSAmJiBlLmRpcmVjdGlvbiA9PT0gcHJldi5kaXJlY3Rpb24gPyBuZXh0IDogZSk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBzdGF0ZVtpdGVtSWRdLmZpbHRlcigoZSkgPT4gZS5kYXRhS2V5ICE9PSBlcnJvckJhci5kYXRhS2V5IHx8IGUuZGlyZWN0aW9uICE9PSBlcnJvckJhci5kaXJlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRFcnJvckJhciwKICByZXBsYWNlRXJyb3JCYXIsCiAgcmVtb3ZlRXJyb3JCYXIKfSA9IGVycm9yQmFyU2xpY2UuYWN0aW9uczsKdmFyIGVycm9yQmFyUmVkdWNlciA9IGVycm9yQmFyU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9HcmFwaGljYWxJdGVtQ2xpcFBhdGguanMKdmFyIFJlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKSB7CiAgdmFyIF94QXhpcyRhbGxvd0RhdGFPdmVyZiwgX3lBeGlzJGFsbG93RGF0YU92ZXJmOwogIHZhciB4QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciB5QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBuZWVkQ2xpcFggPSAoX3hBeGlzJGFsbG93RGF0YU92ZXJmID0geEF4aXMgPT09IG51bGwgfHwgeEF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHhBeGlzLmFsbG93RGF0YU92ZXJmbG93KSAhPT0gbnVsbCAmJiBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgIT09IHZvaWQgMCA/IF94QXhpcyRhbGxvd0RhdGFPdmVyZiA6IGltcGxpY2l0WEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3c7CiAgdmFyIG5lZWRDbGlwWSA9IChfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgPSB5QXhpcyA9PT0gbnVsbCB8fCB5QXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogeUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3cpICE9PSBudWxsICYmIF95QXhpcyRhbGxvd0RhdGFPdmVyZiAhPT0gdm9pZCAwID8gX3lBeGlzJGFsbG93RGF0YU92ZXJmIDogaW1wbGljaXRZQXhpcy5hbGxvd0RhdGFPdmVyZmxvdzsKICB2YXIgbmVlZENsaXAgPSBuZWVkQ2xpcFggfHwgbmVlZENsaXBZOwogIHJldHVybiB7CiAgICBuZWVkQ2xpcCwKICAgIG5lZWRDbGlwWCwKICAgIG5lZWRDbGlwWQogIH07Cn0KZnVuY3Rpb24gR3JhcGhpY2FsSXRlbUNsaXBQYXRoKF9yZWYyKSB7CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkLAogICAgY2xpcFBhdGhJZAogIH0gPSBfcmVmMjsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIHZhciB7CiAgICBuZWVkQ2xpcFgsCiAgICBuZWVkQ2xpcFksCiAgICBuZWVkQ2xpcAogIH0gPSB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCk7CiAgaWYgKCFuZWVkQ2xpcCB8fCAhcGxvdEFyZWEpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiAiY2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCkKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogbmVlZENsaXBYID8geDIgOiB4MiAtIHdpZHRoIC8gMiwKICAgIHk6IG5lZWRDbGlwWSA/IHkyIDogeTIgLSBoZWlnaHQgLyAyLAogICAgd2lkdGg6IG5lZWRDbGlwWCA/IHdpZHRoIDogd2lkdGggKiAyLAogICAgaGVpZ2h0OiBuZWVkQ2xpcFkgPyBoZWlnaHQgOiBoZWlnaHQgKiAyCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtcmVkdXhAOS4yLjBfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWFjdC1yZWR1eC9kaXN0L3JlYWN0LXJlZHV4Lm1qcwp2YXIgUmVhY3QyMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yMiA9IF9fdG9FU00ocmVxdWlyZV93aXRoX3NlbGVjdG9yMigpLCAxKTsKdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKdmFyIFJFQUNUX01FTU9fVFlQRSA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CnZhciBGb3J3YXJkUmVmID0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTsKdmFyIE1lbW8gPSBSRUFDVF9NRU1PX1RZUEU7CmZ1bmN0aW9uIGRlZmF1bHROb29wQmF0Y2goY2FsbGJhY2spIHsKICBjYWxsYmFjaygpOwp9CmZ1bmN0aW9uIGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpIHsKICBsZXQgZmlyc3QgPSBudWxsOwogIGxldCBsYXN0MiA9IG51bGw7CiAgcmV0dXJuIHsKICAgIGNsZWFyKCkgewogICAgICBmaXJzdCA9IG51bGw7CiAgICAgIGxhc3QyID0gbnVsbDsKICAgIH0sCiAgICBub3RpZnkoKSB7CiAgICAgIGRlZmF1bHROb29wQmF0Y2goKCkgPT4gewogICAgICAgIGxldCBsaXN0ZW5lcjIgPSBmaXJzdDsKICAgICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgICBsaXN0ZW5lcjIuY2FsbGJhY2soKTsKICAgICAgICAgIGxpc3RlbmVyMiA9IGxpc3RlbmVyMi5uZXh0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZ2V0KCkgewogICAgICBjb25zdCBsaXN0ZW5lcnMgPSBbXTsKICAgICAgbGV0IGxpc3RlbmVyMiA9IGZpcnN0OwogICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgbGlzdGVuZXJzLnB1c2gobGlzdGVuZXIyKTsKICAgICAgICBsaXN0ZW5lcjIgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKICAgIHN1YnNjcmliZShjYWxsYmFjaykgewogICAgICBsZXQgaXNTdWJzY3JpYmVkID0gdHJ1ZTsKICAgICAgY29uc3QgbGlzdGVuZXIyID0gbGFzdDIgPSB7CiAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgbmV4dDogbnVsbCwKICAgICAgICBwcmV2OiBsYXN0MgogICAgICB9OwogICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICBsaXN0ZW5lcjIucHJldi5uZXh0ID0gbGlzdGVuZXIyOwogICAgICB9IGVsc2UgewogICAgICAgIGZpcnN0ID0gbGlzdGVuZXIyOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHsKICAgICAgICBpZiAoIWlzU3Vic2NyaWJlZCB8fCBmaXJzdCA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICAgIGlmIChsaXN0ZW5lcjIubmV4dCkgewogICAgICAgICAgbGlzdGVuZXIyLm5leHQucHJldiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsYXN0MiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0KICAgICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICAgIGxpc3RlbmVyMi5wcmV2Lm5leHQgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKfQp2YXIgbnVsbExpc3RlbmVycyA9IHsKICBub3RpZnkoKSB7CiAgfSwKICBnZXQ6ICgpID0+IFtdCn07CmZ1bmN0aW9uIGNyZWF0ZVN1YnNjcmlwdGlvbihzdG9yZSwgcGFyZW50U3ViKSB7CiAgbGV0IHVuc3Vic2NyaWJlOwogIGxldCBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzOwogIGxldCBzdWJzY3JpcHRpb25zQW1vdW50ID0gMDsKICBsZXQgc2VsZlN1YnNjcmliZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBhZGROZXN0ZWRTdWIobGlzdGVuZXIyKSB7CiAgICB0cnlTdWJzY3JpYmUoKTsKICAgIGNvbnN0IGNsZWFudXBMaXN0ZW5lciA9IGxpc3RlbmVycy5zdWJzY3JpYmUobGlzdGVuZXIyKTsKICAgIGxldCByZW1vdmVkID0gZmFsc2U7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAoIXJlbW92ZWQpIHsKICAgICAgICByZW1vdmVkID0gdHJ1ZTsKICAgICAgICBjbGVhbnVwTGlzdGVuZXIoKTsKICAgICAgICB0cnlVbnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBub3RpZnlOZXN0ZWRTdWJzKCkgewogICAgbGlzdGVuZXJzLm5vdGlmeSgpOwogIH0KICBmdW5jdGlvbiBoYW5kbGVDaGFuZ2VXcmFwcGVyKCkgewogICAgaWYgKHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKSB7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzU3Vic2NyaWJlZCgpIHsKICAgIHJldHVybiBzZWxmU3Vic2NyaWJlZDsKICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlKCkgewogICAgc3Vic2NyaXB0aW9uc0Ftb3VudCsrOwogICAgaWYgKCF1bnN1YnNjcmliZSkgewogICAgICB1bnN1YnNjcmliZSA9IHBhcmVudFN1YiA/IHBhcmVudFN1Yi5hZGROZXN0ZWRTdWIoaGFuZGxlQ2hhbmdlV3JhcHBlcikgOiBzdG9yZS5zdWJzY3JpYmUoaGFuZGxlQ2hhbmdlV3JhcHBlcik7CiAgICAgIGxpc3RlbmVycyA9IGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZSgpIHsKICAgIHN1YnNjcmlwdGlvbnNBbW91bnQtLTsKICAgIGlmICh1bnN1YnNjcmliZSAmJiBzdWJzY3JpcHRpb25zQW1vdW50ID09PSAwKSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICAgIHVuc3Vic2NyaWJlID0gdm9pZCAwOwogICAgICBsaXN0ZW5lcnMuY2xlYXIoKTsKICAgICAgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVyczsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlU2VsZigpIHsKICAgIGlmICghc2VsZlN1YnNjcmliZWQpIHsKICAgICAgc2VsZlN1YnNjcmliZWQgPSB0cnVlOwogICAgICB0cnlTdWJzY3JpYmUoKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmVTZWxmKCkgewogICAgaWYgKHNlbGZTdWJzY3JpYmVkKSB7CiAgICAgIHNlbGZTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIHRyeVVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfQogIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHsKICAgIGFkZE5lc3RlZFN1YiwKICAgIG5vdGlmeU5lc3RlZFN1YnMsCiAgICBoYW5kbGVDaGFuZ2VXcmFwcGVyLAogICAgaXNTdWJzY3JpYmVkLAogICAgdHJ5U3Vic2NyaWJlOiB0cnlTdWJzY3JpYmVTZWxmLAogICAgdHJ5VW5zdWJzY3JpYmU6IHRyeVVuc3Vic2NyaWJlU2VsZiwKICAgIGdldExpc3RlbmVyczogKCkgPT4gbGlzdGVuZXJzCiAgfTsKICByZXR1cm4gc3Vic2NyaXB0aW9uOwp9CnZhciBjYW5Vc2VET00gPSAoKSA9PiAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKdmFyIGlzRE9NID0gLyogQF9fUFVSRV9fICovIGNhblVzZURPTSgpOwp2YXIgaXNSdW5uaW5nSW5SZWFjdE5hdGl2ZSA9ICgpID0+IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5wcm9kdWN0ID09PSAiUmVhY3ROYXRpdmUiOwp2YXIgaXNSZWFjdE5hdGl2ZSA9IC8qIEBfX1BVUkVfXyAqLyBpc1J1bm5pbmdJblJlYWN0TmF0aXZlKCk7CnZhciBnZXRVc2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gKCkgPT4gaXNET00gfHwgaXNSZWFjdE5hdGl2ZSA/IFJlYWN0MjIudXNlTGF5b3V0RWZmZWN0IDogUmVhY3QyMi51c2VFZmZlY3Q7CnZhciB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gLyogQF9fUFVSRV9fICovIGdldFVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKTsKZnVuY3Rpb24gaXMzKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCB5MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CmZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgaWYgKGlzMyhvYmpBLCBvYmpCKSkgcmV0dXJuIHRydWU7CiAgaWYgKHR5cGVvZiBvYmpBICE9PSAib2JqZWN0IiB8fCBvYmpBID09PSBudWxsIHx8IHR5cGVvZiBvYmpCICE9PSAib2JqZWN0IiB8fCBvYmpCID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgY29uc3Qga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICBpZiAoa2V5c0EubGVuZ3RoICE9PSBrZXlzQi5sZW5ndGgpIHJldHVybiBmYWxzZTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBrZXlzQVtpXSkgfHwgIWlzMyhvYmpBW2tleXNBW2ldXSwgb2JqQltrZXlzQVtpXV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KdmFyIEZPUldBUkRfUkVGX1NUQVRJQ1MgPSB7CiAgJCR0eXBlb2Y6IHRydWUsCiAgcmVuZGVyOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUKfTsKdmFyIE1FTU9fU1RBVElDUyA9IHsKICAkJHR5cGVvZjogdHJ1ZSwKICBjb21wYXJlOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUsCiAgdHlwZTogdHJ1ZQp9Owp2YXIgVFlQRV9TVEFUSUNTID0gewogIFtGb3J3YXJkUmVmXTogRk9SV0FSRF9SRUZfU1RBVElDUywKICBbTWVtb106IE1FTU9fU1RBVElDUwp9Owp2YXIgb2JqZWN0UHJvdG90eXBlID0gT2JqZWN0LnByb3RvdHlwZTsKdmFyIENvbnRleHRLZXkgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcihgcmVhY3QtcmVkdXgtY29udGV4dGApOwp2YXIgZ1QgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogKAogIC8qIGZhbGwgYmFjayB0byBhIHBlci1tb2R1bGUgc2NvcGUgKHByZS04LjEgYmVoYXZpb3VyKSBpZiBgZ2xvYmFsVGhpc2AgaXMgbm90IGF2YWlsYWJsZSAqLwogIHt9Cik7CmZ1bmN0aW9uIGdldENvbnRleHQoKSB7CiAgaWYgKCFSZWFjdDIyLmNyZWF0ZUNvbnRleHQpIHJldHVybiB7fTsKICBjb25zdCBjb250ZXh0TWFwID0gZ1RbQ29udGV4dEtleV0gPz89IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IHJlYWxDb250ZXh0ID0gY29udGV4dE1hcC5nZXQoUmVhY3QyMi5jcmVhdGVDb250ZXh0KTsKICBpZiAoIXJlYWxDb250ZXh0KSB7CiAgICByZWFsQ29udGV4dCA9IFJlYWN0MjIuY3JlYXRlQ29udGV4dCgKICAgICAgbnVsbAogICAgKTsKICAgIGlmICh0cnVlKSB7CiAgICAgIHJlYWxDb250ZXh0LmRpc3BsYXlOYW1lID0gIlJlYWN0UmVkdXgiOwogICAgfQogICAgY29udGV4dE1hcC5zZXQoUmVhY3QyMi5jcmVhdGVDb250ZXh0LCByZWFsQ29udGV4dCk7CiAgfQogIHJldHVybiByZWFsQ29udGV4dDsKfQp2YXIgUmVhY3RSZWR1eENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gZ2V0Q29udGV4dCgpOwpmdW5jdGlvbiBQcm92aWRlcihwcm92aWRlclByb3BzKSB7CiAgY29uc3QgeyBjaGlsZHJlbiwgY29udGV4dCwgc2VydmVyU3RhdGUsIHN0b3JlIH0gPSBwcm92aWRlclByb3BzOwogIGNvbnN0IGNvbnRleHRWYWx1ZSA9IFJlYWN0MjIudXNlTWVtbygoKSA9PiB7CiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUpOwogICAgY29uc3QgYmFzZUNvbnRleHRWYWx1ZSA9IHsKICAgICAgc3RvcmUsCiAgICAgIHN1YnNjcmlwdGlvbiwKICAgICAgZ2V0U2VydmVyU3RhdGU6IHNlcnZlclN0YXRlID8gKCkgPT4gc2VydmVyU3RhdGUgOiB2b2lkIDAKICAgIH07CiAgICBpZiAoZmFsc2UpIHsKICAgICAgcmV0dXJuIGJhc2VDb250ZXh0VmFsdWU7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9ICJvbmNlIiwgc3RhYmlsaXR5Q2hlY2sgPSAib25jZSIgfSA9IHByb3ZpZGVyUHJvcHM7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmFzc2lnbihiYXNlQ29udGV4dFZhbHVlLCB7CiAgICAgICAgc3RhYmlsaXR5Q2hlY2ssCiAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrCiAgICAgIH0pOwogICAgfQogIH0sIFtzdG9yZSwgc2VydmVyU3RhdGVdKTsKICBjb25zdCBwcmV2aW91c1N0YXRlID0gUmVhY3QyMi51c2VNZW1vKCgpID0+IHN0b3JlLmdldFN0YXRlKCksIFtzdG9yZV0pOwogIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKCkgPT4gewogICAgY29uc3QgeyBzdWJzY3JpcHRpb24gfSA9IGNvbnRleHRWYWx1ZTsKICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gc3Vic2NyaXB0aW9uLm5vdGlmeU5lc3RlZFN1YnM7CiAgICBzdWJzY3JpcHRpb24udHJ5U3Vic2NyaWJlKCk7CiAgICBpZiAocHJldmlvdXNTdGF0ZSAhPT0gc3RvcmUuZ2V0U3RhdGUoKSkgewogICAgICBzdWJzY3JpcHRpb24ubm90aWZ5TmVzdGVkU3VicygpOwogICAgfQogICAgcmV0dXJuICgpID0+IHsKICAgICAgc3Vic2NyaXB0aW9uLnRyeVVuc3Vic2NyaWJlKCk7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gdm9pZCAwOwogICAgfTsKICB9LCBbY29udGV4dFZhbHVlLCBwcmV2aW91c1N0YXRlXSk7CiAgY29uc3QgQ29udGV4dCA9IGNvbnRleHQgfHwgUmVhY3RSZWR1eENvbnRleHQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoQ29udGV4dC5Qcm92aWRlciwgeyB2YWx1ZTogY29udGV4dFZhbHVlIH0sIGNoaWxkcmVuKTsKfQp2YXIgUHJvdmlkZXJfZGVmYXVsdCA9IFByb3ZpZGVyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9wcm9wc0FyZUVxdWFsLmpzCnZhciBwcm9wc1RvU2hhbGxvd0NvbXBhcmUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImF4aXNMaW5lIiwgInRpY2tMaW5lIiwgImFjdGl2ZUJhciIsICJhY3RpdmVEb3QiLCAiYWN0aXZlTGFiZWwiLCAiYWN0aXZlU2hhcGUiLCAiYWxsb3dFc2NhcGVWaWV3Qm94IiwgImJhY2tncm91bmQiLCAiY3Vyc29yIiwgImRvdCIsICJsYWJlbCIsICJsaW5lIiwgIm1hcmdpbiIsICJwYWRkaW5nIiwgInBvc2l0aW9uIiwgInNoYXBlIiwgInN0eWxlIiwgInRpY2siLCAid3JhcHBlclN0eWxlIl0pOwpmdW5jdGlvbiBzYW1lVmFsdWVaZXJvKHgyLCB5MikgewogIGlmICh4MiA9PSBudWxsICYmIHkyID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAodHlwZW9mIHgyID09PSAibnVtYmVyIiAmJiB0eXBlb2YgeTIgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4geDIgPT09IHkyIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQogIHJldHVybiB4MiA9PT0geTI7Cn0KZnVuY3Rpb24gcHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIHZhciBhbGxLZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWy4uLk9iamVjdC5rZXlzKHByZXZQcm9wcyksIC4uLk9iamVjdC5rZXlzKG5leHRQcm9wcyldKTsKICBmb3IgKHZhciBrZXkgb2YgYWxsS2V5cykgewogICAgaWYgKHByb3BzVG9TaGFsbG93Q29tcGFyZS5oYXMoa2V5KSkgewogICAgICBpZiAocHJldlByb3BzW2tleV0gPT0gbnVsbCAmJiBuZXh0UHJvcHNba2V5XSA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKCFzaGFsbG93RXF1YWwocHJldlByb3BzW2tleV0sIG5leHRQcm9wc1trZXldKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBlbHNlIGlmICghc2FtZVZhbHVlWmVybyhwcmV2UHJvcHNba2V5XSwgbmV4dFByb3BzW2tleV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnREYXRhQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBDaGFydERhdGFDb250ZXh0UHJvdmlkZXIgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY2hhcnREYXRhCiAgfSA9IHByb3BzOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgKDAsIGltcG9ydF9yZWFjdDM1LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgfTsKICAgIH0KICAgIGRpc3BhdGNoKHNldENoYXJ0RGF0YShjaGFydERhdGEpKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHNldENoYXJ0RGF0YSh2b2lkIDApKTsKICAgIH07CiAgfSwgW2NoYXJ0RGF0YSwgZGlzcGF0Y2gsIGlzUGFub3JhbWFdKTsKICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2JydXNoU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTEwID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgcGFkZGluZzogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwCiAgfQp9Owp2YXIgYnJ1c2hTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiYnJ1c2giLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTAsCiAgcmVkdWNlcnM6IHsKICAgIHNldEJydXNoU2V0dGluZ3MoX3N0YXRlLCBhY3Rpb24pIHsKICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkID09IG51bGwpIHsKICAgICAgICByZXR1cm4gaW5pdGlhbFN0YXRlMTA7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0QnJ1c2hTZXR0aW5ncwp9ID0gYnJ1c2hTbGljZS5hY3Rpb25zOwp2YXIgYnJ1c2hSZWR1Y2VyID0gYnJ1c2hTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DYXJ0ZXNpYW5VdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMjcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyOChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFNjYWxlSGVscGVyID0gY2xhc3MgX1NjYWxlSGVscGVyIHsKICBzdGF0aWMgY3JlYXRlKG9iaikgewogICAgcmV0dXJuIG5ldyBfU2NhbGVIZWxwZXIob2JqKTsKICB9CiAgY29uc3RydWN0b3Ioc2NhbGUpIHsKICAgIHRoaXMuc2NhbGUgPSBzY2FsZTsKICB9CiAgZ2V0IGRvbWFpbigpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLmRvbWFpbjsKICB9CiAgZ2V0IHJhbmdlKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUucmFuZ2U7CiAgfQogIGdldCByYW5nZU1pbigpIHsKICAgIHJldHVybiB0aGlzLnJhbmdlKClbMF07CiAgfQogIGdldCByYW5nZU1heCgpIHsKICAgIHJldHVybiB0aGlzLnJhbmdlKClbMV07CiAgfQogIGdldCBiYW5kd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5iYW5kd2lkdGg7CiAgfQogIGFwcGx5KHZhbHVlKSB7CiAgICB2YXIgewogICAgICBiYW5kQXdhcmUsCiAgICAgIHBvc2l0aW9uCiAgICB9ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAocG9zaXRpb24pIHsKICAgICAgc3dpdGNoIChwb3NpdGlvbikgewogICAgICAgIGNhc2UgInN0YXJ0IjogewogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJtaWRkbGUiOiB7CiAgICAgICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIC8gMiA6IDA7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSkgKyBvZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGNhc2UgImVuZCI6IHsKICAgICAgICAgIHZhciBfb2Zmc2V0ID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIDogMDsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIF9vZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChiYW5kQXdhcmUpIHsKICAgICAgdmFyIF9vZmZzZXQyID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIC8gMiA6IDA7CiAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIF9vZmZzZXQyOwogICAgfQogICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogIH0KICBpc0luUmFuZ2UodmFsdWUpIHsKICAgIHZhciByYW5nZTQgPSB0aGlzLnJhbmdlKCk7CiAgICB2YXIgZmlyc3QgPSByYW5nZTRbMF07CiAgICB2YXIgbGFzdDIgPSByYW5nZTRbcmFuZ2U0Lmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIGZpcnN0IDw9IGxhc3QyID8gdmFsdWUgPj0gZmlyc3QgJiYgdmFsdWUgPD0gbGFzdDIgOiB2YWx1ZSA+PSBsYXN0MiAmJiB2YWx1ZSA8PSBmaXJzdDsKICB9Cn07Cl9kZWZpbmVQcm9wZXJ0eTI4KFNjYWxlSGVscGVyLCAiRVBTIiwgMWUtNCk7CnZhciBjcmVhdGVMYWJlbGVkU2NhbGVzID0gKG9wdGlvbnMpID0+IHsKICB2YXIgc2NhbGVzID0gT2JqZWN0LmtleXMob3B0aW9ucykucmVkdWNlKChyZXMsIGtleSkgPT4gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgcmVzKSwge30sIHsKICAgIFtrZXldOiBTY2FsZUhlbHBlci5jcmVhdGUob3B0aW9uc1trZXldKQogIH0pLCB7fSk7CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIHNjYWxlcyksIHt9LCB7CiAgICBhcHBseShjb29yZCkgewogICAgICB2YXIgewogICAgICAgIGJhbmRBd2FyZSwKICAgICAgICBwb3NpdGlvbgogICAgICB9ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhjb29yZCkubWFwKChfcmVmNCkgPT4gewogICAgICAgIHZhciBbbGFiZWwsIHZhbHVlXSA9IF9yZWY0OwogICAgICAgIHJldHVybiBbbGFiZWwsIHNjYWxlc1tsYWJlbF0uYXBwbHkodmFsdWUsIHsKICAgICAgICAgIGJhbmRBd2FyZSwKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgfSldOwogICAgICB9KSk7CiAgICB9LAogICAgaXNJblJhbmdlKGNvb3JkKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhjb29yZCkuZXZlcnkoKGxhYmVsKSA9PiBzY2FsZXNbbGFiZWxdLmlzSW5SYW5nZShjb29yZFtsYWJlbF0pKTsKICAgIH0KICB9KTsKfTsKZnVuY3Rpb24gbm9ybWFsaXplQW5nbGUoYW5nbGUpIHsKICByZXR1cm4gKGFuZ2xlICUgMTgwICsgMTgwKSAlIDE4MDsKfQp2YXIgZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGggPSBmdW5jdGlvbiBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aDIoX3JlZjUpIHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gX3JlZjU7CiAgdmFyIGFuZ2xlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAwOwogIHZhciBub3JtYWxpemVkQW5nbGUgPSBub3JtYWxpemVBbmdsZShhbmdsZSk7CiAgdmFyIGFuZ2xlUmFkaWFucyA9IG5vcm1hbGl6ZWRBbmdsZSAqIE1hdGguUEkgLyAxODA7CiAgdmFyIGFuZ2xlVGhyZXNob2xkID0gTWF0aC5hdGFuKGhlaWdodCAvIHdpZHRoKTsKICB2YXIgYW5nbGVkV2lkdGggPSBhbmdsZVJhZGlhbnMgPiBhbmdsZVRocmVzaG9sZCAmJiBhbmdsZVJhZGlhbnMgPCBNYXRoLlBJIC0gYW5nbGVUaHJlc2hvbGQgPyBoZWlnaHQgLyBNYXRoLnNpbihhbmdsZVJhZGlhbnMpIDogd2lkdGggLyBNYXRoLmNvcyhhbmdsZVJhZGlhbnMpOwogIHJldHVybiBNYXRoLmFicyhhbmdsZWRXaWR0aCk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yZWZlcmVuY2VFbGVtZW50c1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMSA9IHsKICBkb3RzOiBbXSwKICBhcmVhczogW10sCiAgbGluZXM6IFtdCn07CnZhciByZWZlcmVuY2VFbGVtZW50c1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyZWZlcmVuY2VFbGVtZW50cyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUxMSwKICByZWR1Y2VyczogewogICAgYWRkRG90OiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5kb3RzLnB1c2goYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZURvdDogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuZG90cy5maW5kSW5kZXgoKGRvdCkgPT4gZG90ID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5kb3RzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBhZGRBcmVhOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5hcmVhcy5wdXNoKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVBcmVhOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5hcmVhcy5maW5kSW5kZXgoKGFyZWEpID0+IGFyZWEgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmFyZWFzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBhZGRMaW5lOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5saW5lcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgfSwKICAgIHJlbW92ZUxpbmU6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmxpbmVzLmZpbmRJbmRleCgobGluZSkgPT4gbGluZSA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUubGluZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkRG90LAogIHJlbW92ZURvdCwKICBhZGRBcmVhLAogIHJlbW92ZUFyZWEsCiAgYWRkTGluZSwKICByZW1vdmVMaW5lCn0gPSByZWZlcmVuY2VFbGVtZW50c1NsaWNlLmFjdGlvbnM7CnZhciByZWZlcmVuY2VFbGVtZW50c1JlZHVjZXIgPSByZWZlcmVuY2VFbGVtZW50c1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvQ2xpcFBhdGhQcm92aWRlci5qcwp2YXIgUmVhY3QyMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2xpcFBhdGhJZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM2LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBDbGlwUGF0aFByb3ZpZGVyID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBbY2xpcFBhdGhJZF0gPSAoMCwgaW1wb3J0X3JlYWN0MzYudXNlU3RhdGUpKCIiLmNvbmNhdCh1bmlxdWVJZCgicmVjaGFydHMiKSwgIi1jbGlwIikpOwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgaWYgKHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KENsaXBQYXRoSWRDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogY2xpcFBhdGhJZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiBjbGlwUGF0aElkCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICBoZWlnaHQsCiAgICB3aWR0aAogIH0pKSksIGNoaWxkcmVuKTsKfTsKdmFyIHVzZUNsaXBQYXRoSWQgPSAoKSA9PiB7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QzNi51c2VDb250ZXh0KShDbGlwUGF0aElkQ29udGV4dCk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vUmVmZXJlbmNlRG90LmpzCnZhciBSZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIG93bktleXMyOChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI4KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjgoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI4KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI5KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI5KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE1KCkgewogIHJldHVybiBfZXh0ZW5kczE1ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciB1c2VDb29yZGluYXRlID0gKHgyLCB5MiwgeEF4aXNJZCwgeUF4aXNJZCwgaWZPdmVyZmxvdykgPT4gewogIHZhciBpc1ggPSBpc051bU9yU3RyKHgyKTsKICB2YXIgaXNZID0gaXNOdW1PclN0cih5Mik7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHhBeGlzU2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciB5QXhpc1NjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICBpZiAoIWlzWCB8fCAhaXNZIHx8IHhBeGlzU2NhbGUgPT0gbnVsbCB8fCB5QXhpc1NjYWxlID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgc2NhbGVzID0gY3JlYXRlTGFiZWxlZFNjYWxlcyh7CiAgICB4OiB4QXhpc1NjYWxlLAogICAgeTogeUF4aXNTY2FsZQogIH0pOwogIHZhciByZXN1bHQgPSBzY2FsZXMuYXBwbHkoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHsKICAgIGJhbmRBd2FyZTogdHJ1ZQogIH0pOwogIGlmIChpZk92ZXJmbG93ID09PSAiZGlzY2FyZCIgJiYgIXNjYWxlcy5pc0luUmFuZ2UocmVzdWx0KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiByZXN1bHQ7Cn07CmZ1bmN0aW9uIFJlcG9ydFJlZmVyZW5jZURvdChwcm9wcykgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDM3LnVzZUVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2goYWRkRG90KHByb3BzKSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaChyZW1vdmVEb3QocHJvcHMpKTsKICAgIH07CiAgfSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIHJlbmRlckRvdCA9IChvcHRpb24sIHByb3BzKSA9PiB7CiAgdmFyIGRvdDsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjQuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY2xvbmVFbGVtZW50KG9wdGlvbiwgcHJvcHMpOwogIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgZG90ID0gb3B0aW9uKHByb3BzKTsKICB9IGVsc2UgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChEb3QsIF9leHRlbmRzMTUoe30sIHByb3BzLCB7CiAgICAgIGN4OiBwcm9wcy5jeCwKICAgICAgY3k6IHByb3BzLmN5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1yZWZlcmVuY2UtZG90LWRvdCIKICAgIH0pKTsKICB9CiAgcmV0dXJuIGRvdDsKfTsKZnVuY3Rpb24gUmVmZXJlbmNlRG90SW1wbChwcm9wcykgewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgcjogcjIKICB9ID0gcHJvcHM7CiAgdmFyIGNsaXBQYXRoSWQgPSB1c2VDbGlwUGF0aElkKCk7CiAgdmFyIGNvb3JkaW5hdGUgPSB1c2VDb29yZGluYXRlKHgyLCB5MiwgcHJvcHMueEF4aXNJZCwgcHJvcHMueUF4aXNJZCwgcHJvcHMuaWZPdmVyZmxvdyk7CiAgaWYgKCFjb29yZGluYXRlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHg6IGN4LAogICAgeTogY3kKICB9ID0gY29vcmRpbmF0ZTsKICB2YXIgewogICAgc2hhcGUsCiAgICBjbGFzc05hbWUsCiAgICBpZk92ZXJmbG93CiAgfSA9IHByb3BzOwogIHZhciBjbGlwUGF0aCA9IGlmT3ZlcmZsb3cgPT09ICJoaWRkZW4iID8gInVybCgjIi5jb25jYXQoY2xpcFBhdGhJZCwgIikiKSA6IHZvaWQgMDsKICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHsKICAgIGNsaXBQYXRoCiAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcykpLCB7fSwgewogICAgY3gsCiAgICBjeQogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmVmZXJlbmNlLWRvdCIsIGNsYXNzTmFtZSkKICB9LCByZW5kZXJEb3Qoc2hhcGUsIGRvdFByb3BzKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciwgewogICAgeDogY3ggLSByMiwKICAgIHk6IGN5IC0gcjIsCiAgICB3aWR0aDogMiAqIHIyLAogICAgaGVpZ2h0OiAyICogcjIsCiAgICB1cHBlcldpZHRoOiAyICogcjIsCiAgICBsb3dlcldpZHRoOiAyICogcjIKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcCwgewogICAgbGFiZWw6IHByb3BzLmxhYmVsCiAgfSksIHByb3BzLmNoaWxkcmVuKSkpOwp9CnZhciByZWZlcmVuY2VEb3REZWZhdWx0UHJvcHMgPSB7CiAgaWZPdmVyZmxvdzogImRpc2NhcmQiLAogIHhBeGlzSWQ6IDAsCiAgeUF4aXNJZDogMCwKICByOiAxMCwKICBmaWxsOiAiI2ZmZiIsCiAgc3Ryb2tlOiAiI2NjYyIsCiAgZmlsbE9wYWNpdHk6IDEsCiAgc3Ryb2tlV2lkdGg6IDEsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuc2NhdHRlcgp9OwpmdW5jdGlvbiBSZWZlcmVuY2VEb3Qob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHJlZmVyZW5jZURvdERlZmF1bHRQcm9wcyk7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICByOiByMiwKICAgIGlmT3ZlcmZsb3csCiAgICB5QXhpc0lkLAogICAgeEF4aXNJZAogIH0gPSBwcm9wczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChSZWFjdDI0LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFJlcG9ydFJlZmVyZW5jZURvdCwgewogICAgeTogeTIsCiAgICB4OiB4MiwKICAgIHI6IHIyLAogICAgeUF4aXNJZCwKICAgIHhBeGlzSWQsCiAgICBpZk92ZXJmbG93CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoUmVmZXJlbmNlRG90SW1wbCwgcHJvcHMpKTsKfQpSZWZlcmVuY2VEb3QuZGlzcGxheU5hbWUgPSAiUmVmZXJlbmNlRG90IjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5BeGlzLmpzCnZhciBSZWFjdDI1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfZ2V0MyA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRFdmVyeU50aFdpdGhDb25kaXRpb24uanMKZnVuY3Rpb24gZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKGFycmF5LCBuKSB7CiAgaWYgKG4gPCAxKSB7CiAgICByZXR1cm4gW107CiAgfQogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIHZhciByZXN1bHQgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBuKSB7CiAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvVGlja1V0aWxzLmpzCmZ1bmN0aW9uIGdldEFuZ2xlZFRpY2tXaWR0aChjb250ZW50U2l6ZSwgdW5pdFNpemUsIGFuZ2xlKSB7CiAgdmFyIHNpemUgPSB7CiAgICB3aWR0aDogY29udGVudFNpemUud2lkdGggKyB1bml0U2l6ZS53aWR0aCwKICAgIGhlaWdodDogY29udGVudFNpemUuaGVpZ2h0ICsgdW5pdFNpemUuaGVpZ2h0CiAgfTsKICByZXR1cm4gZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGgoc2l6ZSwgYW5nbGUpOwp9CmZ1bmN0aW9uIGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KSB7CiAgdmFyIGlzV2lkdGggPSBzaXplS2V5ID09PSAid2lkdGgiOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gdmlld0JveDsKICBpZiAoc2lnbjIgPT09IDEpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBpc1dpZHRoID8geDIgOiB5MiwKICAgICAgZW5kOiBpc1dpZHRoID8geDIgKyB3aWR0aCA6IHkyICsgaGVpZ2h0CiAgICB9OwogIH0KICByZXR1cm4gewogICAgc3RhcnQ6IGlzV2lkdGggPyB4MiArIHdpZHRoIDogeTIgKyBoZWlnaHQsCiAgICBlbmQ6IGlzV2lkdGggPyB4MiA6IHkyCiAgfTsKfQpmdW5jdGlvbiBpc1Zpc2libGUoc2lnbjIsIHRpY2tQb3NpdGlvbiwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCkgewogIGlmIChzaWduMiAqIHRpY2tQb3NpdGlvbiA8IHNpZ24yICogc3RhcnQgfHwgc2lnbjIgKiB0aWNrUG9zaXRpb24gPiBzaWduMiAqIGVuZCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgc2l6ZSA9IGdldFNpemUoKTsKICByZXR1cm4gc2lnbjIgKiAodGlja1Bvc2l0aW9uIC0gc2lnbjIgKiBzaXplIC8gMiAtIHN0YXJ0KSA+PSAwICYmIHNpZ24yICogKHRpY2tQb3NpdGlvbiArIHNpZ24yICogc2l6ZSAvIDIgLSBlbmQpIDw9IDA7Cn0KZnVuY3Rpb24gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGludGVydmFsKSB7CiAgcmV0dXJuIGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbih0aWNrczIsIGludGVydmFsICsgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9nZXRFcXVpZGlzdGFudFRpY2tzLmpzCmZ1bmN0aW9uIGdldEVxdWlkaXN0YW50VGlja3Moc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApIHsKICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBbXSkuc2xpY2UoKTsKICB2YXIgewogICAgc3RhcnQ6IGluaXRpYWxTdGFydCwKICAgIGVuZAogIH0gPSBib3VuZGFyaWVzOwogIHZhciBpbmRleCA9IDA7CiAgdmFyIHN0ZXBzaXplID0gMTsKICB2YXIgc3RhcnQgPSBpbml0aWFsU3RhcnQ7CiAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AyKCkgewogICAgdmFyIGVudHJ5ID0gdGlja3MyID09PSBudWxsIHx8IHRpY2tzMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGlja3MyW2luZGV4XTsKICAgIGlmIChlbnRyeSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdjogZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKHRpY2tzMiwgc3RlcHNpemUpCiAgICAgIH07CiAgICB9CiAgICB2YXIgaSA9IGluZGV4OwogICAgdmFyIHNpemU7CiAgICB2YXIgZ2V0U2l6ZSA9ICgpID0+IHsKICAgICAgaWYgKHNpemUgPT09IHZvaWQgMCkgewogICAgICAgIHNpemUgPSBnZXRUaWNrU2l6ZShlbnRyeSwgaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgdmFyIHRpY2tDb29yZCA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICB2YXIgaXNTaG93ID0gaW5kZXggPT09IDAgfHwgaXNWaXNpYmxlKHNpZ24yLCB0aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgaWYgKCFpc1Nob3cpIHsKICAgICAgaW5kZXggPSAwOwogICAgICBzdGFydCA9IGluaXRpYWxTdGFydDsKICAgICAgc3RlcHNpemUgKz0gMTsKICAgIH0KICAgIGlmIChpc1Nob3cpIHsKICAgICAgc3RhcnQgPSB0aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgIGluZGV4ICs9IHN0ZXBzaXplOwogICAgfQogIH0sIF9yZXQ7CiAgd2hpbGUgKHN0ZXBzaXplIDw9IHJlc3VsdC5sZW5ndGgpIHsKICAgIF9yZXQgPSBfbG9vcCgpOwogICAgaWYgKF9yZXQpIHJldHVybiBfcmV0LnY7CiAgfQogIHJldHVybiBbXTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL2dldFRpY2tzLmpzCmZ1bmN0aW9uIG93bktleXMyOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRUaWNrc0VuZChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciBsZW4gPSByZXN1bHQubGVuZ3RoOwogIHZhciB7CiAgICBzdGFydAogIH0gPSBib3VuZGFyaWVzOwogIHZhciB7CiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcDIoaTIpIHsKICAgIHZhciBlbnRyeSA9IHJlc3VsdFtpMl07CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgaWYgKGkyID09PSBsZW4gLSAxKSB7CiAgICAgIHZhciBnYXAgPSBzaWduMiAqIChlbnRyeS5jb29yZGluYXRlICsgc2lnbjIgKiBnZXRTaXplKCkgLyAyIC0gZW5kKTsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZ2FwID4gMCA/IGVudHJ5LmNvb3JkaW5hdGUgLSBnYXAgKiBzaWduMiA6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfQogICAgaWYgKGVudHJ5LnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1Nob3cgPSBpc1Zpc2libGUoc2lnbjIsIGVudHJ5LnRpY2tDb29yZCwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1Nob3cpIHsKICAgICAgICBlbmQgPSBlbnRyeS50aWNrQ29vcmQgLSBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIF9sb29wKGkpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGdldFRpY2tzU3RhcnQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXAsIHByZXNlcnZlRW5kKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIGxlbiA9IHJlc3VsdC5sZW5ndGg7CiAgdmFyIHsKICAgIHN0YXJ0LAogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgaWYgKHByZXNlcnZlRW5kKSB7CiAgICB2YXIgdGFpbCA9IHRpY2tzMltsZW4gLSAxXTsKICAgIHZhciB0YWlsU2l6ZSA9IGdldFRpY2tTaXplKHRhaWwsIGxlbiAtIDEpOwogICAgdmFyIHRhaWxHYXAgPSBzaWduMiAqICh0YWlsLmNvb3JkaW5hdGUgKyBzaWduMiAqIHRhaWxTaXplIC8gMiAtIGVuZCk7CiAgICByZXN1bHRbbGVuIC0gMV0gPSB0YWlsID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgdGFpbCksIHt9LCB7CiAgICAgIHRpY2tDb29yZDogdGFpbEdhcCA+IDAgPyB0YWlsLmNvb3JkaW5hdGUgLSB0YWlsR2FwICogc2lnbjIgOiB0YWlsLmNvb3JkaW5hdGUKICAgIH0pOwogICAgaWYgKHRhaWwudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzVGFpbFNob3cgPSBpc1Zpc2libGUoc2lnbjIsIHRhaWwudGlja0Nvb3JkLCAoKSA9PiB0YWlsU2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1RhaWxTaG93KSB7CiAgICAgICAgZW5kID0gdGFpbC50aWNrQ29vcmQgLSBzaWduMiAqICh0YWlsU2l6ZSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgICByZXN1bHRbbGVuIC0gMV0gPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCB0YWlsKSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQogIHZhciBjb3VudCA9IHByZXNlcnZlRW5kID8gbGVuIC0gMSA6IGxlbjsKICB2YXIgX2xvb3AyID0gZnVuY3Rpb24gX2xvb3AyMihpMikgewogICAgdmFyIGVudHJ5ID0gcmVzdWx0W2kyXTsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkyKTsKICAgICAgfQogICAgICByZXR1cm4gc2l6ZTsKICAgIH07CiAgICBpZiAoaTIgPT09IDApIHsKICAgICAgdmFyIGdhcCA9IHNpZ24yICogKGVudHJ5LmNvb3JkaW5hdGUgLSBzaWduMiAqIGdldFNpemUoKSAvIDIgLSBzdGFydCk7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGdhcCA8IDAgPyBlbnRyeS5jb29yZGluYXRlIC0gZ2FwICogc2lnbjIgOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0KICAgIGlmIChlbnRyeS50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCBlbnRyeS50aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNTaG93KSB7CiAgICAgICAgc3RhcnQgPSBlbnRyeS50aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgIF9sb29wMihpKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBnZXRUaWNrcyhwcm9wcywgZm9udFNpemUsIGxldHRlclNwYWNpbmcpIHsKICB2YXIgewogICAgdGljaywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB2aWV3Qm94LAogICAgbWluVGlja0dhcCwKICAgIG9yaWVudGF0aW9uLAogICAgaW50ZXJ2YWwsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBhbmdsZQogIH0gPSBwcm9wczsKICBpZiAoIXRpY2tzMiB8fCAhdGlja3MyLmxlbmd0aCB8fCAhdGljaykgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoaXNOdW1iZXIoaW50ZXJ2YWwpIHx8IEdsb2JhbC5pc1NzcikgewogICAgdmFyIF9nZXROdW1iZXJJbnRlcnZhbFRpYzsKICAgIHJldHVybiAoX2dldE51bWJlckludGVydmFsVGljID0gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGlzTnVtYmVyKGludGVydmFsKSA/IGludGVydmFsIDogMCkpICE9PSBudWxsICYmIF9nZXROdW1iZXJJbnRlcnZhbFRpYyAhPT0gdm9pZCAwID8gX2dldE51bWJlckludGVydmFsVGljIDogW107CiAgfQogIHZhciBjYW5kaWRhdGVzID0gW107CiAgdmFyIHNpemVLZXkgPSBvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iID8gIndpZHRoIiA6ICJoZWlnaHQiOwogIHZhciB1bml0U2l6ZSA9IHVuaXQyICYmIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRTdHJpbmdTaXplKHVuaXQyLCB7CiAgICBmb250U2l6ZSwKICAgIGxldHRlclNwYWNpbmcKICB9KSA6IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfTsKICB2YXIgZ2V0VGlja1NpemUgPSAoY29udGVudCwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZSA9IHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihjb250ZW50LnZhbHVlLCBpbmRleCkgOiBjb250ZW50LnZhbHVlOwogICAgcmV0dXJuIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRBbmdsZWRUaWNrV2lkdGgoZ2V0U3RyaW5nU2l6ZSh2YWx1ZSwgewogICAgICBmb250U2l6ZSwKICAgICAgbGV0dGVyU3BhY2luZwogICAgfSksIHVuaXRTaXplLCBhbmdsZSkgOiBnZXRTdHJpbmdTaXplKHZhbHVlLCB7CiAgICAgIGZvbnRTaXplLAogICAgICBsZXR0ZXJTcGFjaW5nCiAgICB9KVtzaXplS2V5XTsKICB9OwogIHZhciBzaWduMiA9IHRpY2tzMi5sZW5ndGggPj0gMiA/IG1hdGhTaWduKHRpY2tzMlsxXS5jb29yZGluYXRlIC0gdGlja3MyWzBdLmNvb3JkaW5hdGUpIDogMTsKICB2YXIgYm91bmRhcmllcyA9IGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KTsKICBpZiAoaW50ZXJ2YWwgPT09ICJlcXVpZGlzdGFudFByZXNlcnZlU3RhcnQiKSB7CiAgICByZXR1cm4gZ2V0RXF1aWRpc3RhbnRUaWNrcyhzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCk7CiAgfQogIGlmIChpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnQiIHx8IGludGVydmFsID09PSAicHJlc2VydmVTdGFydEVuZCIpIHsKICAgIGNhbmRpZGF0ZXMgPSBnZXRUaWNrc1N0YXJ0KHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwLCBpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnRFbmQiKTsKICB9IGVsc2UgewogICAgY2FuZGlkYXRlcyA9IGdldFRpY2tzRW5kKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKTsKICB9CiAgcmV0dXJuIGNhbmRpZGF0ZXMuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkuaXNTaG93KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ZQXhpc1V0aWxzLmpzCnZhciBnZXRDYWxjdWxhdGVkWUF4aXNXaWR0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB0aWNrczogdGlja3MyLAogICAgbGFiZWwsCiAgICBsYWJlbEdhcFdpdGhUaWNrID0gNSwKICAgIC8vIERlZmF1bHQgZ2FwIGJldHdlZW4gbGFiZWwgYW5kIHRpY2sKICAgIHRpY2tTaXplID0gMCwKICAgIHRpY2tNYXJnaW4gPSAwCiAgfSA9IF9yZWYyOwogIHZhciBtYXhUaWNrV2lkdGggPSAwOwogIGlmICh0aWNrczIpIHsKICAgIEFycmF5LmZyb20odGlja3MyKS5mb3JFYWNoKCh0aWNrTm9kZSkgPT4gewogICAgICBpZiAodGlja05vZGUpIHsKICAgICAgICB2YXIgYmJveCA9IHRpY2tOb2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGlmIChiYm94LndpZHRoID4gbWF4VGlja1dpZHRoKSB7CiAgICAgICAgICBtYXhUaWNrV2lkdGggPSBiYm94LndpZHRoOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgbGFiZWxXaWR0aCA9IGxhYmVsID8gbGFiZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggOiAwOwogICAgdmFyIHRpY2tXaWR0aCA9IHRpY2tTaXplICsgdGlja01hcmdpbjsKICAgIHZhciB1cGRhdGVkWUF4aXNXaWR0aCA9IG1heFRpY2tXaWR0aCArIHRpY2tXaWR0aCArIGxhYmVsV2lkdGggKyAobGFiZWwgPyBsYWJlbEdhcFdpdGhUaWNrIDogMCk7CiAgICByZXR1cm4gTWF0aC5yb3VuZCh1cGRhdGVkWUF4aXNXaWR0aCk7CiAgfQogIHJldHVybiAwOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkF4aXMuanMKdmFyIF9leGNsdWRlZDEwID0gWyJheGlzTGluZSIsICJ3aWR0aCIsICJoZWlnaHQiLCAiY2xhc3NOYW1lIiwgImhpZGUiLCAidGlja3MiLCAiYXhpc1R5cGUiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEwKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxNigpIHsKICByZXR1cm4gX2V4dGVuZHMxNiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTYuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzMzAoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMwKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzEoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICB2aWV3Qm94OiB7CiAgICB4OiAwLAogICAgeTogMCwKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfSwKICAvLyBUaGUgb3JpZW50YXRpb24gb2YgYXhpcwogIG9yaWVudGF0aW9uOiAiYm90dG9tIiwKICAvLyBUaGUgdGlja3MKICB0aWNrczogW10sCiAgc3Ryb2tlOiAiIzY2NiIsCiAgdGlja0xpbmU6IHRydWUsCiAgYXhpc0xpbmU6IHRydWUsCiAgdGljazogdHJ1ZSwKICBtaXJyb3I6IGZhbHNlLAogIG1pblRpY2tHYXA6IDUsCiAgLy8gVGhlIHdpZHRoIG9yIGhlaWdodCBvZiB0aWNrCiAgdGlja1NpemU6IDYsCiAgdGlja01hcmdpbjogMiwKICBpbnRlcnZhbDogInByZXNlcnZlRW5kIiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CmZ1bmN0aW9uIEF4aXNMaW5lKGF4aXNMaW5lUHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb3JpZW50YXRpb24sCiAgICBtaXJyb3IsCiAgICBheGlzTGluZSwKICAgIG90aGVyU3ZnUHJvcHMKICB9ID0gYXhpc0xpbmVQcm9wczsKICBpZiAoIWF4aXNMaW5lKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIG90aGVyU3ZnUHJvcHMpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoYXhpc0xpbmUpKSwge30sIHsKICAgIGZpbGw6ICJub25lIgogIH0pOwogIGlmIChvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgbmVlZEhlaWdodCA9ICsob3JpZW50YXRpb24gPT09ICJ0b3AiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iICYmIG1pcnJvcik7CiAgICBwcm9wcyA9IF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIHByb3BzKSwge30sIHsKICAgICAgeDE6IHgyLAogICAgICB5MTogeTIgKyBuZWVkSGVpZ2h0ICogaGVpZ2h0LAogICAgICB4MjogeDIgKyB3aWR0aCwKICAgICAgeTI6IHkyICsgbmVlZEhlaWdodCAqIGhlaWdodAogICAgfSk7CiAgfSBlbHNlIHsKICAgIHZhciBuZWVkV2lkdGggPSArKG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3IpOwogICAgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBwcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiArIG5lZWRXaWR0aCAqIHdpZHRoLAogICAgICB5MTogeTIsCiAgICAgIHgyOiB4MiArIG5lZWRXaWR0aCAqIHdpZHRoLAogICAgICB5MjogeTIgKyBoZWlnaHQKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgibGluZSIsIF9leHRlbmRzMTYoe30sIHByb3BzLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLWxpbmUiLCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkoYXhpc0xpbmUsICJjbGFzc05hbWUiKSkKICB9KSk7Cn0KZnVuY3Rpb24gZ2V0VGlja0xpbmVDb29yZChkYXRhLCB4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIG9yaWVudGF0aW9uLCB0aWNrU2l6ZSwgbWlycm9yLCB0aWNrTWFyZ2luKSB7CiAgdmFyIHgxLCB4MjIsIHkxLCB5MjIsIHR4LCB0eTsKICB2YXIgc2lnbjIgPSBtaXJyb3IgPyAtMSA6IDE7CiAgdmFyIGZpbmFsVGlja1NpemUgPSBkYXRhLnRpY2tTaXplIHx8IHRpY2tTaXplOwogIHZhciB0aWNrQ29vcmQgPSBpc051bWJlcihkYXRhLnRpY2tDb29yZCkgPyBkYXRhLnRpY2tDb29yZCA6IGRhdGEuY29vcmRpbmF0ZTsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICB4MSA9IHgyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeTIyID0geTIgKyArIW1pcnJvciAqIGhlaWdodDsKICAgICAgeTEgPSB5MjIgLSBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR5ID0geTEgLSBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR4ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGNhc2UgImxlZnQiOgogICAgICB5MSA9IHkyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeDIyID0geDIgKyArIW1pcnJvciAqIHdpZHRoOwogICAgICB4MSA9IHgyMiAtIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHggPSB4MSAtIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHkgPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgY2FzZSAicmlnaHQiOgogICAgICB5MSA9IHkyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeDIyID0geDIgKyArbWlycm9yICogd2lkdGg7CiAgICAgIHgxID0geDIyICsgc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eCA9IHgxICsgc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eSA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB4MSA9IHgyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeTIyID0geTIgKyArbWlycm9yICogaGVpZ2h0OwogICAgICB5MSA9IHkyMiArIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHkgPSB5MSArIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHggPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gewogICAgbGluZTogewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyOiB4MjIsCiAgICAgIHkyOiB5MjIKICAgIH0sCiAgICB0aWNrOiB7CiAgICAgIHg6IHR4LAogICAgICB5OiB0eQogICAgfQogIH07Cn0KZnVuY3Rpb24gZ2V0VGlja1RleHRBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcikgewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gbWlycm9yID8gInN0YXJ0IiA6ICJlbmQiOwogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gbWlycm9yID8gImVuZCIgOiAic3RhcnQiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuICJtaWRkbGUiOwogIH0KfQpmdW5jdGlvbiBnZXRUaWNrVmVydGljYWxBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcikgewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gIm1pZGRsZSI7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gbWlycm9yID8gInN0YXJ0IiA6ICJlbmQiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJlbmQiIDogInN0YXJ0IjsKICB9Cn0KZnVuY3Rpb24gVGlja0l0ZW0ocHJvcHMpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgdGlja1Byb3BzLAogICAgdmFsdWUKICB9ID0gcHJvcHM7CiAgdmFyIHRpY2tJdGVtOwogIHZhciBjb21iaW5lZENsYXNzTmFtZSA9IGNsc3godGlja1Byb3BzLmNsYXNzTmFtZSwgInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiKTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjUuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgdGlja0l0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jbG9uZUVsZW1lbnQob3B0aW9uLCBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCB0aWNrUHJvcHMpLCB7fSwgewogICAgICBjbGFzc05hbWU6IGNvbWJpbmVkQ2xhc3NOYW1lCiAgICB9KSk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICB0aWNrSXRlbSA9IG9wdGlvbihfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCB0aWNrUHJvcHMpLCB7fSwgewogICAgICBjbGFzc05hbWU6IGNvbWJpbmVkQ2xhc3NOYW1lCiAgICB9KSk7CiAgfSBlbHNlIHsKICAgIHZhciBjbGFzc05hbWUgPSAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSI7CiAgICBpZiAodHlwZW9mIG9wdGlvbiAhPT0gImJvb2xlYW4iKSB7CiAgICAgIGNsYXNzTmFtZSA9IGNsc3goY2xhc3NOYW1lLCBvcHRpb24gPT09IG51bGwgfHwgb3B0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb24uY2xhc3NOYW1lKTsKICAgIH0KICAgIHRpY2tJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChUZXh0LCBfZXh0ZW5kczE2KHt9LCB0aWNrUHJvcHMsIHsKICAgICAgY2xhc3NOYW1lCiAgICB9KSwgdmFsdWUpOwogIH0KICByZXR1cm4gdGlja0l0ZW07Cn0KdmFyIFRpY2tzID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzOC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB0aWNrczogdGlja3MyID0gW10sCiAgICB0aWNrLAogICAgdGlja0xpbmUsCiAgICBzdHJva2UsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBwYWRkaW5nLAogICAgdGlja1RleHRQcm9wcywKICAgIG9yaWVudGF0aW9uLAogICAgbWlycm9yLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdGlja1NpemUsCiAgICB0aWNrTWFyZ2luLAogICAgZm9udFNpemUsCiAgICBsZXR0ZXJTcGFjaW5nLAogICAgZ2V0VGlja3NDb25maWcsCiAgICBldmVudHMsCiAgICBheGlzVHlwZQogIH0gPSBwcm9wczsKICB2YXIgZmluYWxUaWNrcyA9IGdldFRpY2tzKF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIGdldFRpY2tzQ29uZmlnKSwge30sIHsKICAgIHRpY2tzOiB0aWNrczIKICB9KSwgZm9udFNpemUsIGxldHRlclNwYWNpbmcpOwogIHZhciB0ZXh0QW5jaG9yID0gZ2V0VGlja1RleHRBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcik7CiAgdmFyIHZlcnRpY2FsQW5jaG9yID0gZ2V0VGlja1ZlcnRpY2FsQW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpOwogIHZhciBheGlzUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoZ2V0VGlja3NDb25maWcpOwogIHZhciBjdXN0b21UaWNrUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bih0aWNrKTsKICB2YXIgdGlja0xpbmVQcm9wc09iamVjdCA9IHt9OwogIGlmICh0eXBlb2YgdGlja0xpbmUgPT09ICJvYmplY3QiKSB7CiAgICB0aWNrTGluZVByb3BzT2JqZWN0ID0gdGlja0xpbmU7CiAgfQogIHZhciB0aWNrTGluZVByb3BzID0gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgYXhpc1Byb3BzKSwge30sIHsKICAgIGZpbGw6ICJub25lIgogIH0sIHRpY2tMaW5lUHJvcHNPYmplY3QpOwogIHZhciB0aWNrTGluZUNvb3JkcyA9IGZpbmFsVGlja3MubWFwKChlbnRyeSkgPT4gX29iamVjdFNwcmVhZDMwKHsKICAgIGVudHJ5CiAgfSwgZ2V0VGlja0xpbmVDb29yZChlbnRyeSwgeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCBvcmllbnRhdGlvbiwgdGlja1NpemUsIG1pcnJvciwgdGlja01hcmdpbikpKTsKICB2YXIgdGlja0xpbmVzID0gdGlja0xpbmVDb29yZHMubWFwKChfcmVmMikgPT4gewogICAgdmFyIHsKICAgICAgZW50cnksCiAgICAgIGxpbmU6IGxpbmVDb29yZAogICAgfSA9IF9yZWYyOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljayIsCiAgICAgIGtleTogInRpY2stIi5jb25jYXQoZW50cnkudmFsdWUsICItIikuY29uY2F0KGVudHJ5LmNvb3JkaW5hdGUsICItIikuY29uY2F0KGVudHJ5LnRpY2tDb29yZCkKICAgIH0sIHRpY2tMaW5lICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE2KHt9LCB0aWNrTGluZVByb3BzLCBsaW5lQ29vcmQsIHsKICAgICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxpbmUiLCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkodGlja0xpbmUsICJjbGFzc05hbWUiKSkKICAgIH0pKSk7CiAgfSk7CiAgdmFyIHRpY2tMYWJlbHMgPSB0aWNrTGluZUNvb3Jkcy5tYXAoKF9yZWYyLCBpKSA9PiB7CiAgICB2YXIgewogICAgICBlbnRyeSwKICAgICAgdGljazogdGlja0Nvb3JkCiAgICB9ID0gX3JlZjI7CiAgICB2YXIgdGlja1Byb3BzID0gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0ZXh0QW5jaG9yIGZyb20gYXhpc1Byb3BzIGlzIHR5cGVkIGFzIGBzdHJpbmdgIGJ1dCBUZXh0IHdhbnRzIHR5cGUgYFRleHRBbmNob3JgCiAgICAgIHRleHRBbmNob3IsCiAgICAgIHZlcnRpY2FsQW5jaG9yCiAgICB9LCBheGlzUHJvcHMpLCB7fSwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGN1c3RvbVRpY2tQcm9wcyBpcyBjb250cmlidXRpbmcgdW5rbm93biBwcm9wcwogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBjdXN0b21UaWNrUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgZmlsbDogc3Ryb2tlCiAgICB9LCBjdXN0b21UaWNrUHJvcHMpLCB0aWNrQ29vcmQpLCB7fSwgewogICAgICBpbmRleDogaSwKICAgICAgcGF5bG9hZDogZW50cnksCiAgICAgIHZpc2libGVUaWNrc0NvdW50OiBmaW5hbFRpY2tzLmxlbmd0aCwKICAgICAgdGlja0Zvcm1hdHRlciwKICAgICAgcGFkZGluZwogICAgfSwgdGlja1RleHRQcm9wcyk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChMYXllciwgX2V4dGVuZHMxNih7CiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGFiZWwiLAogICAgICBrZXk6ICJ0aWNrLWxhYmVsLSIuY29uY2F0KGVudHJ5LnZhbHVlLCAiLSIpLmNvbmNhdChlbnRyeS5jb29yZGluYXRlLCAiLSIpLmNvbmNhdChlbnRyeS50aWNrQ29vcmQpCiAgICB9LCBhZGFwdEV2ZW50c09mQ2hpbGQoZXZlbnRzLCBlbnRyeSwgaSkpLCB0aWNrICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoVGlja0l0ZW0sIHsKICAgICAgb3B0aW9uOiB0aWNrLAogICAgICB0aWNrUHJvcHMsCiAgICAgIHZhbHVlOiAiIi5jb25jYXQodHlwZW9mIHRpY2tGb3JtYXR0ZXIgPT09ICJmdW5jdGlvbiIgPyB0aWNrRm9ybWF0dGVyKGVudHJ5LnZhbHVlLCBpKSA6IGVudHJ5LnZhbHVlKS5jb25jYXQodW5pdDIgfHwgIiIpCiAgICB9KSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrcyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrcyIpCiAgfSwgdGlja0xhYmVscy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmxhYmVsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGFiZWxzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2stbGFiZWxzIiksCiAgICByZWYKICB9LCB0aWNrTGFiZWxzKSksIHRpY2tMaW5lcy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxpbmVzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2stbGluZXMiKQogIH0sIHRpY2tMaW5lcykpOwp9KTsKdmFyIENhcnRlc2lhbkF4aXNDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGF4aXNMaW5lLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBjbGFzc05hbWUsCiAgICBoaWRlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIGF4aXNUeXBlCiAgfSA9IHByb3BzLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAocHJvcHMsIF9leGNsdWRlZDEwKTsKICB2YXIgW2ZvbnRTaXplLCBzZXRGb250U2l6ZV0gPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlU3RhdGUpKCIiKTsKICB2YXIgW2xldHRlclNwYWNpbmcsIHNldExldHRlclNwYWNpbmddID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVN0YXRlKSgiIik7CiAgdmFyIHRpY2tSZWZzID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDM4LnVzZUltcGVyYXRpdmVIYW5kbGUpKHJlZiwgKCkgPT4gKHsKICAgIGdldENhbGN1bGF0ZWRXaWR0aDogKCkgPT4gewogICAgICB2YXIgX3Byb3BzJGxhYmVsUmVmOwogICAgICByZXR1cm4gZ2V0Q2FsY3VsYXRlZFlBeGlzV2lkdGgoewogICAgICAgIHRpY2tzOiB0aWNrUmVmcy5jdXJyZW50LAogICAgICAgIGxhYmVsOiAoX3Byb3BzJGxhYmVsUmVmID0gcHJvcHMubGFiZWxSZWYpID09PSBudWxsIHx8IF9wcm9wcyRsYWJlbFJlZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJGxhYmVsUmVmLmN1cnJlbnQsCiAgICAgICAgbGFiZWxHYXBXaXRoVGljazogNSwKICAgICAgICB0aWNrU2l6ZTogcHJvcHMudGlja1NpemUsCiAgICAgICAgdGlja01hcmdpbjogcHJvcHMudGlja01hcmdpbgogICAgICB9KTsKICAgIH0KICB9KSk7CiAgdmFyIGxheWVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZUNhbGxiYWNrKSgoZWwpID0+IHsKICAgIGlmIChlbCkgewogICAgICB2YXIgdGlja05vZGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSIpOwogICAgICB0aWNrUmVmcy5jdXJyZW50ID0gdGlja05vZGVzOwogICAgICB2YXIgdGljayA9IHRpY2tOb2Rlc1swXTsKICAgICAgaWYgKHRpY2spIHsKICAgICAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRpY2spOwogICAgICAgIHZhciBjYWxjdWxhdGVkRm9udFNpemUgPSBjb21wdXRlZFN0eWxlLmZvbnRTaXplOwogICAgICAgIHZhciBjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyA9IGNvbXB1dGVkU3R5bGUubGV0dGVyU3BhY2luZzsKICAgICAgICBpZiAoY2FsY3VsYXRlZEZvbnRTaXplICE9PSBmb250U2l6ZSB8fCBjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyAhPT0gbGV0dGVyU3BhY2luZykgewogICAgICAgICAgc2V0Rm9udFNpemUoY2FsY3VsYXRlZEZvbnRTaXplKTsKICAgICAgICAgIHNldExldHRlclNwYWNpbmcoY2FsY3VsYXRlZExldHRlclNwYWNpbmcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sIFtmb250U2l6ZSwgbGV0dGVyU3BhY2luZ10pOwogIGlmIChoaWRlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHdpZHRoICE9IG51bGwgJiYgd2lkdGggPD0gMCB8fCBoZWlnaHQgIT0gbnVsbCAmJiBoZWlnaHQgPD0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMiLCBjbGFzc05hbWUpCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChBeGlzTGluZSwgewogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnksCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgYXhpc0xpbmUsCiAgICBvdGhlclN2Z1Byb3BzOiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoVGlja3MsIHsKICAgIHJlZjogbGF5ZXJSZWYsCiAgICBheGlzVHlwZSwKICAgIGV2ZW50czogcmVzdCwKICAgIGZvbnRTaXplLAogICAgZ2V0VGlja3NDb25maWc6IHByb3BzLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBsZXR0ZXJTcGFjaW5nLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgc3Ryb2tlOiBwcm9wcy5zdHJva2UsCiAgICB0aWNrOiBwcm9wcy50aWNrLAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tMaW5lOiBwcm9wcy50aWNrTGluZSwKICAgIHRpY2tNYXJnaW46IHByb3BzLnRpY2tNYXJnaW4sCiAgICB0aWNrU2l6ZTogcHJvcHMudGlja1NpemUsCiAgICB0aWNrVGV4dFByb3BzOiBwcm9wcy50aWNrVGV4dFByb3BzLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsQ29udGV4dFByb3ZpZGVyLCB7CiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueSwKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgbG93ZXJXaWR0aDogcHJvcHMud2lkdGgsCiAgICB1cHBlcldpZHRoOiBwcm9wcy53aWR0aAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwsCiAgICBsYWJlbFJlZjogcHJvcHMubGFiZWxSZWYKICB9KSwgcHJvcHMuY2hpbGRyZW4pKSk7Cn0pOwp2YXIgQ2FydGVzaWFuQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmZvcndhcmRSZWYoKG91dHNpZGVQcm9wcywgcmVmKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXNDb21wb25lbnQsIF9leHRlbmRzMTYoe30sIHByb3BzLCB7CiAgICByZWYKICB9KSk7Cn0pOwpDYXJ0ZXNpYW5BeGlzLmRpc3BsYXlOYW1lID0gIkNhcnRlc2lhbkF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkdyaWQuanMKdmFyIFJlYWN0MjYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxMSA9IFsieDEiLCAieTEiLCAieDIiLCAieTIiLCAia2V5Il07CnZhciBfZXhjbHVkZWQyNSA9IFsib2Zmc2V0Il07CnZhciBfZXhjbHVkZWQzMiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CnZhciBfZXhjbHVkZWQ0MiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CmZ1bmN0aW9uIG93bktleXMzMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMxKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMxKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE3KCkgewogIHJldHVybiBfZXh0ZW5kczE3ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTEocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBCYWNrZ3JvdW5kID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGZpbGwKICB9ID0gcHJvcHM7CiAgaWYgKCFmaWxsIHx8IGZpbGwgPT09ICJub25lIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJ5CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHJ5LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHJva2U6ICJub25lIiwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogIH0pOwp9OwpmdW5jdGlvbiBMaW5lSXRlbShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBsaW5lSXRlbVByb3BzCiAgfSA9IF9yZWYyOwogIHZhciBsaW5lSXRlbTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjYuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jbG9uZUVsZW1lbnQob3B0aW9uLCBsaW5lSXRlbVByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIGxpbmVJdGVtID0gb3B0aW9uKGxpbmVJdGVtUHJvcHMpOwogIH0gZWxzZSB7CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNOb0V2ZW50OwogICAgdmFyIHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MiwKICAgICAgeTIsCiAgICAgIGtleQogICAgfSA9IGxpbmVJdGVtUHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGxpbmVJdGVtUHJvcHMsIF9leGNsdWRlZDExKTsKICAgIHZhciBfcmVmMjIgPSAoX3N2Z1Byb3BlcnRpZXNOb0V2ZW50ID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycykpICE9PSBudWxsICYmIF9zdmdQcm9wZXJ0aWVzTm9FdmVudCAhPT0gdm9pZCAwID8gX3N2Z1Byb3BlcnRpZXNOb0V2ZW50IDoge30sIHsKICAgICAgb2Zmc2V0OiBfXwogICAgfSA9IF9yZWYyMiwgcmVzdE9mRmlsdGVyZWRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKF9yZWYyMiwgX2V4Y2x1ZGVkMjUpOwogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNyh7fSwgcmVzdE9mRmlsdGVyZWRQcm9wcywgewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyLAogICAgICB5MiwKICAgICAgZmlsbDogIm5vbmUiLAogICAgICBrZXkKICAgIH0pKTsKICB9CiAgcmV0dXJuIGxpbmVJdGVtOwp9CmZ1bmN0aW9uIEhvcml6b250YWxHcmlkTGluZXMocHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB3aWR0aCwKICAgIGhvcml6b250YWwgPSB0cnVlLAogICAgaG9yaXpvbnRhbFBvaW50cwogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxQb2ludHMgfHwgIWhvcml6b250YWxQb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IHByb3BzLCBvdGhlckxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShwcm9wcywgX2V4Y2x1ZGVkMzIpOwogIHZhciBpdGVtcyA9IGhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0U3ByZWFkMzEoX29iamVjdFNwcmVhZDMxKHt9LCBvdGhlckxpbmVJdGVtUHJvcHMpLCB7fSwgewogICAgICB4MTogeDIsCiAgICAgIHkxOiBlbnRyeSwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiBlbnRyeSwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBob3Jpem9udGFsLAogICAgICBsaW5lSXRlbVByb3BzCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsR3JpZExpbmVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHk6IHkyLAogICAgaGVpZ2h0LAogICAgdmVydGljYWwgPSB0cnVlLAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCF2ZXJ0aWNhbCB8fCAhdmVydGljYWxQb2ludHMgfHwgIXZlcnRpY2FsUG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBwcm9wcywgb3RoZXJMaW5lSXRlbVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEocHJvcHMsIF9leGNsdWRlZDQyKTsKICB2YXIgaXRlbXMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIG90aGVyTGluZUl0ZW1Qcm9wcyksIHt9LCB7CiAgICAgIHgxOiBlbnRyeSwKICAgICAgeTE6IHkyLAogICAgICB4MjogZW50cnksCiAgICAgIHkyOiB5MiArIGhlaWdodCwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAgb3B0aW9uOiB2ZXJ0aWNhbCwKICAgICAgbGluZUl0ZW1Qcm9wcywKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKQogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC12ZXJ0aWNhbCIKICB9LCBpdGVtcyk7Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbFN0cmlwZXMocHJvcHMpIHsKICB2YXIgewogICAgaG9yaXpvbnRhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGhvcml6b250YWxQb2ludHMsCiAgICBob3Jpem9udGFsID0gdHJ1ZQogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxGaWxsIHx8ICFob3Jpem9udGFsRmlsbC5sZW5ndGggfHwgaG9yaXpvbnRhbFBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzID0gaG9yaXpvbnRhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHkyIC0geTIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHkyICE9PSByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMudW5zaGlmdCgwKTsKICB9CiAgdmFyIGl0ZW1zID0gcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVIZWlnaHQgPSBsYXN0U3RyaXBlID8geTIgKyBoZWlnaHQgLSBlbnRyeSA6IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVIZWlnaHQgPD0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjb2xvckluZGV4ID0gaSAlIGhvcml6b250YWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeTogZW50cnksCiAgICAgIHg6IHgyLAogICAgICBoZWlnaHQ6IGxpbmVIZWlnaHQsCiAgICAgIHdpZHRoLAogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgZmlsbDogaG9yaXpvbnRhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsU3RyaXBlcyhwcm9wcykgewogIHZhciB7CiAgICB2ZXJ0aWNhbCA9IHRydWUsCiAgICB2ZXJ0aWNhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsRmlsbCB8fCAhdmVydGljYWxGaWxsLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHgyIC0geDIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHgyICE9PSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbMF0pIHsKICAgIHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cy51bnNoaWZ0KDApOwogIH0KICB2YXIgaXRlbXMgPSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXTsKICAgIHZhciBsaW5lV2lkdGggPSBsYXN0U3RyaXBlID8geDIgKyB3aWR0aCAtIGVudHJ5IDogcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVXaWR0aCA8PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGNvbG9ySW5kZXggPSBpICUgdmVydGljYWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeDogZW50cnksCiAgICAgIHk6IHkyLAogICAgICB3aWR0aDogbGluZVdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIHN0cm9rZTogIm5vbmUiLAogICAgICBmaWxsOiB2ZXJ0aWNhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLXZlcnRpY2FsIgogIH0sIGl0ZW1zKTsKfQp2YXIgZGVmYXVsdFZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSAoX3JlZjMsIHN5bmNXaXRoVGlja3MpID0+IHsKICB2YXIgewogICAgeEF4aXMsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9mZnNldAogIH0gPSBfcmVmMzsKICByZXR1cm4gZ2V0Q29vcmRpbmF0ZXNPZkdyaWQoZ2V0VGlja3MoX29iamVjdFNwcmVhZDMxKF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpLCB4QXhpcyksIHt9LCB7CiAgICB0aWNrczogZ2V0VGlja3NPZkF4aXMoeEF4aXMsIHRydWUpLAogICAgdmlld0JveDogewogICAgICB4OiAwLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9CiAgfSkpLCBvZmZzZXQubGVmdCwgb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsIHN5bmNXaXRoVGlja3MpOwp9Owp2YXIgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9IChfcmVmNCwgc3luY1dpdGhUaWNrcykgPT4gewogIHZhciB7CiAgICB5QXhpcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb2Zmc2V0CiAgfSA9IF9yZWY0OwogIHJldHVybiBnZXRDb29yZGluYXRlc09mR3JpZChnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMzEoX29iamVjdFNwcmVhZDMxKF9vYmplY3RTcHJlYWQzMSh7fSwgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyksIHlBeGlzKSwge30sIHsKICAgIHRpY2tzOiBnZXRUaWNrc09mQXhpcyh5QXhpcywgdHJ1ZSksCiAgICB2aWV3Qm94OiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0KICB9KSksIG9mZnNldC50b3AsIG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0LCBzeW5jV2l0aFRpY2tzKTsKfTsKdmFyIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMgPSB7CiAgaG9yaXpvbnRhbDogdHJ1ZSwKICB2ZXJ0aWNhbDogdHJ1ZSwKICAvLyBUaGUgb3JkaW5hdGVzIG9mIGhvcml6b250YWwgZ3JpZCBsaW5lcwogIGhvcml6b250YWxQb2ludHM6IFtdLAogIC8vIFRoZSBhYnNjaXNzYXMgb2YgdmVydGljYWwgZ3JpZCBsaW5lcwogIHZlcnRpY2FsUG9pbnRzOiBbXSwKICBzdHJva2U6ICIjY2NjIiwKICBmaWxsOiAibm9uZSIsCiAgLy8gVGhlIGZpbGwgb2YgY29sb3JzIG9mIGdyaWQgbGluZXMKICB2ZXJ0aWNhbEZpbGw6IFtdLAogIGhvcml6b250YWxGaWxsOiBbXSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgc3luY1dpdGhUaWNrczogZmFsc2UsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuZ3JpZAp9OwpmdW5jdGlvbiBDYXJ0ZXNpYW5HcmlkKHByb3BzKSB7CiAgdmFyIGNoYXJ0V2lkdGggPSB1c2VDaGFydFdpZHRoKCk7CiAgdmFyIGNoYXJ0SGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgb2Zmc2V0ID0gdXNlT2Zmc2V0SW50ZXJuYWwoKTsKICB2YXIgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cyA9IF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMpKSwge30sIHsKICAgIHg6IGlzTnVtYmVyKHByb3BzLngpID8gcHJvcHMueCA6IG9mZnNldC5sZWZ0LAogICAgeTogaXNOdW1iZXIocHJvcHMueSkgPyBwcm9wcy55IDogb2Zmc2V0LnRvcCwKICAgIHdpZHRoOiBpc051bWJlcihwcm9wcy53aWR0aCkgPyBwcm9wcy53aWR0aCA6IG9mZnNldC53aWR0aCwKICAgIGhlaWdodDogaXNOdW1iZXIocHJvcHMuaGVpZ2h0KSA/IHByb3BzLmhlaWdodCA6IG9mZnNldC5oZWlnaHQKICB9KTsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzeW5jV2l0aFRpY2tzLAogICAgaG9yaXpvbnRhbFZhbHVlcywKICAgIHZlcnRpY2FsVmFsdWVzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHhBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzUHJvcHNOZWVkZWRGb3JDYXJ0ZXNpYW5HcmlkVGlja3NHZW5lcmF0b3Ioc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgeUF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvcihzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIGlmICghaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgfHwgIWlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMudmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciB8fCBkZWZhdWx0VmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5ob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgfHwgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgewogICAgaG9yaXpvbnRhbFBvaW50cywKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgaWYgKCghaG9yaXpvbnRhbFBvaW50cyB8fCAhaG9yaXpvbnRhbFBvaW50cy5sZW5ndGgpICYmIHR5cGVvZiBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBpc0hvcml6b250YWxWYWx1ZXMgPSBob3Jpem9udGFsVmFsdWVzICYmIGhvcml6b250YWxWYWx1ZXMubGVuZ3RoOwogICAgdmFyIGdlbmVyYXRvclJlc3VsdCA9IGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcih7CiAgICAgIHlBeGlzOiB5QXhpcyA/IF9vYmplY3RTcHJlYWQzMShfb2JqZWN0U3ByZWFkMzEoe30sIHlBeGlzKSwge30sIHsKICAgICAgICB0aWNrczogaXNIb3Jpem9udGFsVmFsdWVzID8gaG9yaXpvbnRhbFZhbHVlcyA6IHlBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzSG9yaXpvbnRhbFZhbHVlcyA/IHRydWUgOiBzeW5jV2l0aFRpY2tzKTsKICAgIHdhcm4oQXJyYXkuaXNBcnJheShnZW5lcmF0b3JSZXN1bHQpLCAiaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBnZW5lcmF0b3JSZXN1bHQsICJdIikpOwogICAgaWYgKEFycmF5LmlzQXJyYXkoZ2VuZXJhdG9yUmVzdWx0KSkgewogICAgICBob3Jpem9udGFsUG9pbnRzID0gZ2VuZXJhdG9yUmVzdWx0OwogICAgfQogIH0KICBpZiAoKCF2ZXJ0aWNhbFBvaW50cyB8fCAhdmVydGljYWxQb2ludHMubGVuZ3RoKSAmJiB0eXBlb2YgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgdmFyIGlzVmVydGljYWxWYWx1ZXMgPSB2ZXJ0aWNhbFZhbHVlcyAmJiB2ZXJ0aWNhbFZhbHVlcy5sZW5ndGg7CiAgICB2YXIgX2dlbmVyYXRvclJlc3VsdCA9IHZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IoewogICAgICB4QXhpczogeEF4aXMgPyBfb2JqZWN0U3ByZWFkMzEoX29iamVjdFNwcmVhZDMxKHt9LCB4QXhpcyksIHt9LCB7CiAgICAgICAgdGlja3M6IGlzVmVydGljYWxWYWx1ZXMgPyB2ZXJ0aWNhbFZhbHVlcyA6IHhBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzVmVydGljYWxWYWx1ZXMgPyB0cnVlIDogc3luY1dpdGhUaWNrcyk7CiAgICB3YXJuKEFycmF5LmlzQXJyYXkoX2dlbmVyYXRvclJlc3VsdCksICJ2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBfZ2VuZXJhdG9yUmVzdWx0LCAiXSIpKTsKICAgIGlmIChBcnJheS5pc0FycmF5KF9nZW5lcmF0b3JSZXN1bHQpKSB7CiAgICAgIHZlcnRpY2FsUG9pbnRzID0gX2dlbmVyYXRvclJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQiCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChCYWNrZ3JvdW5kLCB7CiAgICBmaWxsOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmZpbGwsCiAgICBmaWxsT3BhY2l0eTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5maWxsT3BhY2l0eSwKICAgIHg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueCwKICAgIHk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueSwKICAgIHdpZHRoOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmhlaWdodCwKICAgIHJ5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnJ5CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFN0cmlwZXMsIF9leHRlbmRzMTcoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIGhvcml6b250YWxQb2ludHMKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxTdHJpcGVzLCBfZXh0ZW5kczE3KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICB2ZXJ0aWNhbFBvaW50cwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsR3JpZExpbmVzLCBfZXh0ZW5kczE3KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBvZmZzZXQsCiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgeEF4aXMsCiAgICB5QXhpcwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChWZXJ0aWNhbEdyaWRMaW5lcywgX2V4dGVuZHMxNyh7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgb2Zmc2V0LAogICAgdmVydGljYWxQb2ludHMsCiAgICB4QXhpcywKICAgIHlBeGlzCiAgfSkpKSk7Cn0KQ2FydGVzaWFuR3JpZC5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5HcmlkIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0UmFkaXVzQW5kU3Ryb2tlV2lkdGhGcm9tRG90LmpzCmZ1bmN0aW9uIGdldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdChkb3QpIHsKICB2YXIgcHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihkb3QpOwogIHZhciBkZWZhdWx0UiA9IDM7CiAgdmFyIGRlZmF1bHRTdHJva2VXaWR0aCA9IDI7CiAgaWYgKHByb3BzICE9IG51bGwpIHsKICAgIHZhciB7CiAgICAgIHI6IHIyLAogICAgICBzdHJva2VXaWR0aAogICAgfSA9IHByb3BzOwogICAgdmFyIHJlYWxSID0gTnVtYmVyKHIyKTsKICAgIHZhciByZWFsU3Ryb2tlV2lkdGggPSBOdW1iZXIoc3Ryb2tlV2lkdGgpOwogICAgaWYgKE51bWJlci5pc05hTihyZWFsUikgfHwgcmVhbFIgPCAwKSB7CiAgICAgIHJlYWxSID0gZGVmYXVsdFI7CiAgICB9CiAgICBpZiAoTnVtYmVyLmlzTmFOKHJlYWxTdHJva2VXaWR0aCkgfHwgcmVhbFN0cm9rZVdpZHRoIDwgMCkgewogICAgICByZWFsU3Ryb2tlV2lkdGggPSBkZWZhdWx0U3Ryb2tlV2lkdGg7CiAgICB9CiAgICByZXR1cm4gewogICAgICByOiByZWFsUiwKICAgICAgc3Ryb2tlV2lkdGg6IHJlYWxTdHJva2VXaWR0aAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHI6IGRlZmF1bHRSLAogICAgc3Ryb2tlV2lkdGg6IGRlZmF1bHRTdHJva2VXaWR0aAogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9BcmVhLmpzCnZhciBSZWFjdDI3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJlYVNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WEF4aXNXaXRoU2NhbGUgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RBeGlzV2l0aFNjYWxlKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFhBeGlzVGlja3MgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbShzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RZQXhpc1dpdGhTY2FsZSA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdEF4aXNXaXRoU2NhbGUoc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WUF4aXNUaWNrcyA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdEJhbmRTaXplID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RYQXhpc1dpdGhTY2FsZSwgc2VsZWN0WUF4aXNXaXRoU2NhbGUsIHNlbGVjdFhBeGlzVGlja3MsIHNlbGVjdFlBeGlzVGlja3NdLCAobGF5b3V0LCB4QXhpcywgeUF4aXMsIHhBeGlzVGlja3MsIHlBeGlzVGlja3MpID0+IHsKICBpZiAoaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHhBeGlzLCB4QXhpc1RpY2tzLCBmYWxzZSk7CiAgfQogIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh5QXhpcywgeUF4aXNUaWNrcywgZmFsc2UpOwp9KTsKdmFyIHBpY2tBcmVhSWQgPSAoX3N0YXRlLCBfeEF4aXNJZCwgX3lBeGlzSWQsIF9pc1Bhbm9yYW1hLCBpZCkgPT4gaWQ7CnZhciBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zLCBwaWNrQXJlYUlkXSwgKGdyYXBoaWNhbEl0ZW1zLCBpZCkgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJhcmVhIikuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gaWQpKTsKdmFyIHNlbGVjdEdyYXBoaWNhbEl0ZW1TdGFja2VkRGF0YSA9IChzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpID0+IHsKICB2YXIgX3N0YWNrR3JvdXBzJHN0YWNrSWQ7CiAgdmFyIGFyZWFTZXR0aW5ncyA9IHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpOwogIGlmIChhcmVhU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGxheW91dCA9IHNlbGVjdENoYXJ0TGF5b3V0KHN0YXRlKTsKICB2YXIgaXNYQXhpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKTsKICB2YXIgc3RhY2tHcm91cHM7CiAgaWYgKGlzWEF4aXNDYXRlZ29yaWNhbCkgewogICAgc3RhY2tHcm91cHMgPSBzZWxlY3RTdGFja0dyb3VwcyhzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgfSBlbHNlIHsKICAgIHN0YWNrR3JvdXBzID0gc2VsZWN0U3RhY2tHcm91cHMoc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwogIH0KICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHN0YWNrSWQKICB9ID0gYXJlYVNldHRpbmdzOwogIHZhciBzdGFja1Nlcmllc0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoYXJlYVNldHRpbmdzKTsKICBpZiAoc3RhY2tJZCA9PSBudWxsIHx8IHN0YWNrU2VyaWVzSWRlbnRpZmllciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZ3JvdXBzID0gKF9zdGFja0dyb3VwcyRzdGFja0lkID0gc3RhY2tHcm91cHNbc3RhY2tJZF0pID09PSBudWxsIHx8IF9zdGFja0dyb3VwcyRzdGFja0lkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfc3RhY2tHcm91cHMkc3RhY2tJZC5zdGFja2VkRGF0YTsKICByZXR1cm4gZ3JvdXBzID09PSBudWxsIHx8IGdyb3VwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ3JvdXBzLmZpbmQoKHYpID0+IHYua2V5ID09PSBzdGFja1Nlcmllc0lkZW50aWZpZXIpOwp9Owp2YXIgc2VsZWN0QXJlYSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0WEF4aXNXaXRoU2NhbGUsIHNlbGVjdFlBeGlzV2l0aFNjYWxlLCBzZWxlY3RYQXhpc1RpY2tzLCBzZWxlY3RZQXhpc1RpY2tzLCBzZWxlY3RHcmFwaGljYWxJdGVtU3RhY2tlZERhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hLCBzZWxlY3RCYW5kU2l6ZSwgc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzLCBzZWxlY3RDaGFydEJhc2VWYWx1ZV0sIChsYXlvdXQsIHhBeGlzLCB5QXhpcywgeEF4aXNUaWNrcywgeUF4aXNUaWNrcywgc3RhY2tlZERhdGEsIF9yZWYyLCBiYW5kU2l6ZSwgYXJlYVNldHRpbmdzLCBjaGFydEJhc2VWYWx1ZSkgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMjsKICBpZiAoYXJlYVNldHRpbmdzID09IG51bGwgfHwgbGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHhBeGlzID09IG51bGwgfHwgeUF4aXMgPT0gbnVsbCB8fCB4QXhpc1RpY2tzID09IG51bGwgfHwgeUF4aXNUaWNrcyA9PSBudWxsIHx8IHhBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IHlBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IGJhbmRTaXplID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhCiAgfSA9IGFyZWFTZXR0aW5nczsKICB2YXIgZGlzcGxheWVkRGF0YTsKICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCA+IDApIHsKICAgIGRpc3BsYXllZERhdGEgPSBkYXRhOwogIH0gZWxzZSB7CiAgICBkaXNwbGF5ZWREYXRhID0gY2hhcnREYXRhID09PSBudWxsIHx8IGNoYXJ0RGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2hhcnREYXRhLnNsaWNlKGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXggKyAxKTsKICB9CiAgaWYgKGRpc3BsYXllZERhdGEgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGNvbXB1dGVBcmVhKHsKICAgIGxheW91dCwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGRhdGFTdGFydEluZGV4LAogICAgYXJlYVNldHRpbmdzLAogICAgc3RhY2tlZERhdGEsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgY2hhcnRCYXNlVmFsdWUsCiAgICBiYW5kU2l6ZQogIH0pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9BcmVhLmpzCnZhciBfZXhjbHVkZWQxMiA9IFsiaWQiXTsKdmFyIF9leGNsdWRlZDI2ID0gWyJhY3RpdmVEb3QiLCAiYW5pbWF0aW9uQmVnaW4iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRWFzaW5nIiwgImNvbm5lY3ROdWxscyIsICJkb3QiLCAiZmlsbCIsICJmaWxsT3BhY2l0eSIsICJoaWRlIiwgImlzQW5pbWF0aW9uQWN0aXZlIiwgImxlZ2VuZFR5cGUiLCAic3Ryb2tlIiwgInhBeGlzSWQiLCAieUF4aXNJZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczE4KCkgewogIHJldHVybiBfZXh0ZW5kczE4ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxOC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEyKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTIocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIG93bktleXMzMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMyKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzIoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMzKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMyKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSB7CiAgcmV0dXJuIHN0cm9rZSAmJiBzdHJva2UgIT09ICJub25lIiA/IHN0cm9rZSA6IGZpbGw7Cn0KdmFyIGNvbXB1dGVMZWdlbmRQYXlsb2FkRnJvbUFyZWFEYXRhID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBuYW1lLAogICAgc3Ryb2tlLAogICAgZmlsbCwKICAgIGxlZ2VuZFR5cGUsCiAgICBoaWRlCiAgfSA9IHByb3BzOwogIHJldHVybiBbewogICAgaW5hY3RpdmU6IGhpZGUsCiAgICBkYXRhS2V5LAogICAgdHlwZTogbGVnZW5kVHlwZSwKICAgIGNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSwKICAgIHZhbHVlOiBnZXRUb29sdGlwTmFtZVByb3AobmFtZSwgZGF0YUtleSksCiAgICBwYXlsb2FkOiBwcm9wcwogIH1dOwp9Owp2YXIgU2V0QXJlYVRvb2x0aXBFbnRyeVNldHRpbmdzID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjcubWVtbygoX3JlZjIpID0+IHsKICB2YXIgewogICAgZGF0YUtleSwKICAgIGRhdGEsCiAgICBzdHJva2UsCiAgICBzdHJva2VXaWR0aCwKICAgIGZpbGwsCiAgICBuYW1lLAogICAgaGlkZSwKICAgIHVuaXQ6IHVuaXQyLAogICAgdG9vbHRpcFR5cGUKICB9ID0gX3JlZjI7CiAgdmFyIHRvb2x0aXBFbnRyeVNldHRpbmdzID0gewogICAgZGF0YURlZmluZWRPbkl0ZW06IGRhdGEsCiAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgIHNldHRpbmdzOiB7CiAgICAgIHN0cm9rZSwKICAgICAgc3Ryb2tlV2lkdGgsCiAgICAgIGZpbGwsCiAgICAgIGRhdGFLZXksCiAgICAgIG5hbWVLZXk6IHZvaWQgMCwKICAgICAgbmFtZTogZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWUsIGRhdGFLZXkpLAogICAgICBoaWRlLAogICAgICB0eXBlOiB0b29sdGlwVHlwZSwKICAgICAgY29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcihzdHJva2UsIGZpbGwpLAogICAgICB1bml0OiB1bml0MgogICAgfQogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MsIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgfSk7Cn0pOwpmdW5jdGlvbiBBcmVhRG90c1dyYXBwZXIoX3JlZjIpIHsKICB2YXIgewogICAgY2xpcFBhdGhJZCwKICAgIHBvaW50cywKICAgIHByb3BzCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGRvdCwKICAgIGRhdGFLZXkKICB9ID0gcHJvcHM7CiAgdmFyIGFyZWFQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoRG90cywgewogICAgcG9pbnRzLAogICAgZG90LAogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1kb3RzIiwKICAgIGRvdENsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtZG90IiwKICAgIGRhdGFLZXksCiAgICBiYXNlUHJvcHM6IGFyZWFQcm9wcywKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZAogIH0pOwp9CmZ1bmN0aW9uIEFyZWFMYWJlbExpc3RQcm92aWRlcihfcmVmMykgewogIHZhciB7CiAgICBzaG93TGFiZWxzLAogICAgY2hpbGRyZW4sCiAgICBwb2ludHMKICB9ID0gX3JlZjM7CiAgdmFyIGxhYmVsTGlzdEVudHJpZXMgPSBwb2ludHMubWFwKChwb2ludDQpID0+IHsKICAgIHZhciBfcG9pbnQkeCwgX3BvaW50JHk7CiAgICB2YXIgdmlld0JveCA9IHsKICAgICAgeDogKF9wb2ludCR4ID0gcG9pbnQ0LngpICE9PSBudWxsICYmIF9wb2ludCR4ICE9PSB2b2lkIDAgPyBfcG9pbnQkeCA6IDAsCiAgICAgIHk6IChfcG9pbnQkeSA9IHBvaW50NC55KSAhPT0gbnVsbCAmJiBfcG9pbnQkeSAhPT0gdm9pZCAwID8gX3BvaW50JHkgOiAwLAogICAgICB3aWR0aDogMCwKICAgICAgbG93ZXJXaWR0aDogMCwKICAgICAgdXBwZXJXaWR0aDogMCwKICAgICAgaGVpZ2h0OiAwCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzMihfb2JqZWN0U3ByZWFkMzIoe30sIHZpZXdCb3gpLCB7fSwgewogICAgICB2YWx1ZTogcG9pbnQ0LnZhbHVlLAogICAgICBwYXlsb2FkOiBwb2ludDQucGF5bG9hZCwKICAgICAgcGFyZW50Vmlld0JveDogdm9pZCAwLAogICAgICB2aWV3Qm94LAogICAgICBmaWxsOiB2b2lkIDAKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHRQcm92aWRlciwgewogICAgdmFsdWU6IHNob3dMYWJlbHMgPyBsYWJlbExpc3RFbnRyaWVzIDogdm9pZCAwCiAgfSwgY2hpbGRyZW4pOwp9CmZ1bmN0aW9uIFN0YXRpY0FyZWEoX3JlZjQpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcwogIH0gPSBfcmVmNDsKICB2YXIgewogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIHN0cm9rZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGlzUmFuZ2UKICB9ID0gcHJvcHM7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHByb3BzLCBwcm9wc1dpdGhvdXRJZCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEyKHByb3BzLCBfZXhjbHVkZWQxMik7CiAgdmFyIGFsbE90aGVyUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHNXaXRob3V0SWQpOwogIHZhciBwcm9wc1dpdGhFdmVudHMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzV2l0aG91dElkKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChSZWFjdDI3LkZyYWdtZW50LCBudWxsLCAocG9pbnRzID09PSBudWxsIHx8IHBvaW50cyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9pbnRzLmxlbmd0aCkgPiAxICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsaXBQYXRoOiBuZWVkQ2xpcCA/ICJ1cmwoI2NsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQsICIpIikgOiB2b2lkIDAKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE4KHt9LCBwcm9wc1dpdGhFdmVudHMsIHsKICAgIGlkLAogICAgcG9pbnRzLAogICAgY29ubmVjdE51bGxzLAogICAgdHlwZSwKICAgIGJhc2VMaW5lLAogICAgbGF5b3V0LAogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWFyZWEiCiAgfSkpLCBzdHJva2UgIT09ICJub25lIiAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE4KHt9LCBhbGxPdGhlclByb3BzLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWN1cnZlIiwKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBjb25uZWN0TnVsbHMsCiAgICBmaWxsOiAibm9uZSIsCiAgICBwb2ludHMKICB9KSksIHN0cm9rZSAhPT0gIm5vbmUiICYmIGlzUmFuZ2UgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMxOCh7fSwgYWxsT3RoZXJQcm9wcywgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1jdXJ2ZSIsCiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgY29ubmVjdE51bGxzLAogICAgZmlsbDogIm5vbmUiLAogICAgcG9pbnRzOiBiYXNlTGluZQogIH0pKSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQXJlYURvdHNXcmFwcGVyLCB7CiAgICBwb2ludHMsCiAgICBwcm9wczogcHJvcHNXaXRob3V0SWQsCiAgICBjbGlwUGF0aElkCiAgfSkpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsUmVjdChfcmVmNSkgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgYmFzZUxpbmUsCiAgICBwb2ludHMsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNTsKICB2YXIgc3RhcnRZID0gcG9pbnRzWzBdLnk7CiAgdmFyIGVuZFkgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdLnk7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHN0YXJ0WSkgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoZW5kWSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaGVpZ2h0ID0gYWxwaGEyICogTWF0aC5hYnMoc3RhcnRZIC0gZW5kWSk7CiAgdmFyIG1heFggPSBNYXRoLm1heCguLi5wb2ludHMubWFwKChlbnRyeSkgPT4gZW50cnkueCB8fCAwKSk7CiAgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbWF4WCA9IE1hdGgubWF4KGJhc2VMaW5lLCBtYXhYKTsKICB9IGVsc2UgaWYgKGJhc2VMaW5lICYmIEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpICYmIGJhc2VMaW5lLmxlbmd0aCkgewogICAgbWF4WCA9IE1hdGgubWF4KC4uLmJhc2VMaW5lLm1hcCgoZW50cnkpID0+IGVudHJ5LnggfHwgMCksIG1heFgpOwogIH0KICBpZiAoaXNOdW1iZXIobWF4WCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICB4OiAwLAogICAgICB5OiBzdGFydFkgPCBlbmRZID8gc3RhcnRZIDogc3RhcnRZIC0gaGVpZ2h0LAogICAgICB3aWR0aDogbWF4WCArIChzdHJva2VXaWR0aCA/IHBhcnNlSW50KCIiLmNvbmNhdChzdHJva2VXaWR0aCksIDEwKSA6IDEpLAogICAgICBoZWlnaHQ6IE1hdGguZmxvb3IoaGVpZ2h0KQogICAgfSk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIEhvcml6b250YWxSZWN0KF9yZWY2KSB7CiAgdmFyIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBiYXNlTGluZSwKICAgIHBvaW50cywKICAgIHN0cm9rZVdpZHRoCiAgfSA9IF9yZWY2OwogIHZhciBzdGFydFggPSBwb2ludHNbMF0ueDsKICB2YXIgZW5kWCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0ueDsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc3RhcnRYKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcihlbmRYKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB3aWR0aCA9IGFscGhhMiAqIE1hdGguYWJzKHN0YXJ0WCAtIGVuZFgpOwogIHZhciBtYXhZID0gTWF0aC5tYXgoLi4ucG9pbnRzLm1hcCgoZW50cnkpID0+IGVudHJ5LnkgfHwgMCkpOwogIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIG1heFkgPSBNYXRoLm1heChiYXNlTGluZSwgbWF4WSk7CiAgfSBlbHNlIGlmIChiYXNlTGluZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiBiYXNlTGluZS5sZW5ndGgpIHsKICAgIG1heFkgPSBNYXRoLm1heCguLi5iYXNlTGluZS5tYXAoKGVudHJ5KSA9PiBlbnRyeS55IHx8IDApLCBtYXhZKTsKICB9CiAgaWYgKGlzTnVtYmVyKG1heFkpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogc3RhcnRYIDwgZW5kWCA/IHN0YXJ0WCA6IHN0YXJ0WCAtIHdpZHRoLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0OiBNYXRoLmZsb29yKG1heFkgKyAoc3Ryb2tlV2lkdGggPyBwYXJzZUludCgiIi5jb25jYXQoc3Ryb2tlV2lkdGgpLCAxMCkgOiAxKSkKICAgIH0pOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBDbGlwUmVjdChfcmVmNykgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgbGF5b3V0LAogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNzsKICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChWZXJ0aWNhbFJlY3QsIHsKICAgICAgYWxwaGE6IGFscGhhMiwKICAgICAgcG9pbnRzLAogICAgICBiYXNlTGluZSwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsUmVjdCwgewogICAgYWxwaGE6IGFscGhhMiwKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgc3Ryb2tlV2lkdGgKICB9KTsKfQpmdW5jdGlvbiBBcmVhV2l0aEFuaW1hdGlvbihfcmVmOCkgewogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcywKICAgIHByZXZpb3VzUG9pbnRzUmVmLAogICAgcHJldmlvdXNCYXNlbGluZVJlZgogIH0gPSBfcmVmODsKICB2YXIgewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBvbkFuaW1hdGlvblN0YXJ0LAogICAgb25BbmltYXRpb25FbmQKICB9ID0gcHJvcHM7CiAgdmFyIGFuaW1hdGlvbklucHV0ID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZU1lbW8pKCgpID0+ICh7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZQogIH0pLCBbcG9pbnRzLCBiYXNlTGluZV0pOwogIHZhciBhbmltYXRpb25JZCA9IHVzZUFuaW1hdGlvbklkKGFuaW1hdGlvbklucHV0LCAicmVjaGFydHMtYXJlYS0iKTsKICB2YXIgbGF5b3V0ID0gdXNlQ2FydGVzaWFuQ2hhcnRMYXlvdXQoKTsKICB2YXIgW2lzQW5pbWF0aW5nLCBzZXRJc0FuaW1hdGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlU3RhdGUpKGZhbHNlKTsKICB2YXIgc2hvd0xhYmVscyA9ICFpc0FuaW1hdGluZzsKICB2YXIgaGFuZGxlQW5pbWF0aW9uRW5kID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBpZiAodHlwZW9mIG9uQW5pbWF0aW9uRW5kID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9uQW5pbWF0aW9uRW5kKCk7CiAgICB9CiAgICBzZXRJc0FuaW1hdGluZyhmYWxzZSk7CiAgfSwgW29uQW5pbWF0aW9uRW5kXSk7CiAgdmFyIGhhbmRsZUFuaW1hdGlvblN0YXJ0ID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBpZiAodHlwZW9mIG9uQW5pbWF0aW9uU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgb25BbmltYXRpb25TdGFydCgpOwogICAgfQogICAgc2V0SXNBbmltYXRpbmcodHJ1ZSk7CiAgfSwgW29uQW5pbWF0aW9uU3RhcnRdKTsKICBpZiAobGF5b3V0ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJldlBvaW50cyA9IHByZXZpb3VzUG9pbnRzUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZCYXNlTGluZSA9IHByZXZpb3VzQmFzZWxpbmVSZWYuY3VycmVudDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChBcmVhTGFiZWxMaXN0UHJvdmlkZXIsIHsKICAgIHNob3dMYWJlbHMsCiAgICBwb2ludHMKICB9LCBwcm9wcy5jaGlsZHJlbiwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChKYXZhc2NyaXB0QW5pbWF0ZSwgewogICAgYW5pbWF0aW9uSWQsCiAgICBiZWdpbjogYW5pbWF0aW9uQmVnaW4sCiAgICBkdXJhdGlvbjogYW5pbWF0aW9uRHVyYXRpb24sCiAgICBpc0FjdGl2ZTogaXNBbmltYXRpb25BY3RpdmUsCiAgICBlYXNpbmc6IGFuaW1hdGlvbkVhc2luZywKICAgIG9uQW5pbWF0aW9uRW5kOiBoYW5kbGVBbmltYXRpb25FbmQsCiAgICBvbkFuaW1hdGlvblN0YXJ0OiBoYW5kbGVBbmltYXRpb25TdGFydCwKICAgIGtleTogYW5pbWF0aW9uSWQKICB9LCAodCkgPT4gewogICAgaWYgKHByZXZQb2ludHMpIHsKICAgICAgdmFyIHByZXZQb2ludHNEaWZmRmFjdG9yID0gcHJldlBvaW50cy5sZW5ndGggLyBwb2ludHMubGVuZ3RoOwogICAgICB2YXIgc3RlcFBvaW50cyA9ICgKICAgICAgICAvKgogICAgICAgICAqIEhlcmUgaXQgaXMgaW1wb3J0YW50IHRoYXQgYXQgdGhlIHZlcnkgZW5kIG9mIHRoZSBhbmltYXRpb24sIG9uIHRoZSBsYXN0IGZyYW1lLAogICAgICAgICAqIHdlIHJlbmRlciB0aGUgb3JpZ2luYWwgcG9pbnRzIHdpdGhvdXQgYW55IGludGVycG9sYXRpb24uCiAgICAgICAgICogVGhpcyBpcyBuZWVkZWQgYmVjYXVzZSB0aGUgY29kZSBhYm92ZSBpcyBjaGVja2luZyBmb3IgcmVmZXJlbmNlIGVxdWFsaXR5IHRvIGRlY2lkZSBpZiB0aGUgYW5pbWF0aW9uIHNob3VsZCBydW4KICAgICAgICAgKiBhbmQgaWYgd2UgY3JlYXRlIGEgbmV3IGFycmF5IGluc3RhbmNlIChldmVuIGlmIHRoZSBudW1iZXJzIHdlcmUgdGhlIHNhbWUpCiAgICAgICAgICogdGhlbiB3ZSB3b3VsZCBicmVhayBhbmltYXRpb25zLgogICAgICAgICAqLwogICAgICAgIHQgPT09IDEgPyBwb2ludHMgOiBwb2ludHMubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgICAgIHZhciBwcmV2UG9pbnRJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggKiBwcmV2UG9pbnRzRGlmZkZhY3Rvcik7CiAgICAgICAgICBpZiAocHJldlBvaW50c1twcmV2UG9pbnRJbmRleF0pIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBwcmV2UG9pbnRzW3ByZXZQb2ludEluZGV4XTsKICAgICAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzMihfb2JqZWN0U3ByZWFkMzIoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgICAgICB4OiBpbnRlcnBvbGF0ZShwcmV2LngsIGVudHJ5LngsIHQpLAogICAgICAgICAgICAgIHk6IGludGVycG9sYXRlKHByZXYueSwgZW50cnkueSwgdCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW50cnk7CiAgICAgICAgfSkKICAgICAgKTsKICAgICAgdmFyIHN0ZXBCYXNlTGluZTsKICAgICAgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGludGVycG9sYXRlKHByZXZCYXNlTGluZSwgYmFzZUxpbmUsIHQpOwogICAgICB9IGVsc2UgaWYgKGlzTnVsbGlzaChiYXNlTGluZSkgfHwgaXNOYW4oYmFzZUxpbmUpKSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gaW50ZXJwb2xhdGUocHJldkJhc2VMaW5lLCAwLCB0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBiYXNlTGluZS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICAgICAgdmFyIHByZXZQb2ludEluZGV4ID0gTWF0aC5mbG9vcihpbmRleCAqIHByZXZQb2ludHNEaWZmRmFjdG9yKTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHByZXZCYXNlTGluZSkgJiYgcHJldkJhc2VMaW5lW3ByZXZQb2ludEluZGV4XSkgewogICAgICAgICAgICB2YXIgcHJldiA9IHByZXZCYXNlTGluZVtwcmV2UG9pbnRJbmRleF07CiAgICAgICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzIoX29iamVjdFNwcmVhZDMyKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICAgICAgeDogaW50ZXJwb2xhdGUocHJldi54LCBlbnRyeS54LCB0KSwKICAgICAgICAgICAgICB5OiBpbnRlcnBvbGF0ZShwcmV2LnksIGVudHJ5LnksIHQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVudHJ5OwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh0ID4gMCkgewogICAgICAgIHByZXZpb3VzUG9pbnRzUmVmLmN1cnJlbnQgPSBzdGVwUG9pbnRzOwogICAgICAgIHByZXZpb3VzQmFzZWxpbmVSZWYuY3VycmVudCA9IHN0ZXBCYXNlTGluZTsKICAgICAgfQogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChTdGF0aWNBcmVhLCB7CiAgICAgICAgcG9pbnRzOiBzdGVwUG9pbnRzLAogICAgICAgIGJhc2VMaW5lOiBzdGVwQmFzZUxpbmUsCiAgICAgICAgbmVlZENsaXAsCiAgICAgICAgY2xpcFBhdGhJZCwKICAgICAgICBwcm9wcwogICAgICB9KTsKICAgIH0KICAgIGlmICh0ID4gMCkgewogICAgICBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50ID0gcG9pbnRzOwogICAgICBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQgPSBiYXNlTGluZTsKICAgIH0KICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KExheWVyLCBudWxsLCBpc0FuaW1hdGlvbkFjdGl2ZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICAgIGlkOiAiYW5pbWF0aW9uQ2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCkKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQ2xpcFJlY3QsIHsKICAgICAgYWxwaGE6IHQsCiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIGxheW91dCwKICAgICAgc3Ryb2tlV2lkdGg6IHByb3BzLnN0cm9rZVdpZHRoCiAgICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsaXBQYXRoOiAidXJsKCNhbmltYXRpb25DbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFN0YXRpY0FyZWEsIHsKICAgICAgcG9pbnRzLAogICAgICBiYXNlTGluZSwKICAgICAgbmVlZENsaXAsCiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHByb3BzCiAgICB9KSkpOwogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KExhYmVsTGlzdEZyb21MYWJlbFByb3AsIHsKICAgIGxhYmVsOiBwcm9wcy5sYWJlbAogIH0pKTsKfQpmdW5jdGlvbiBSZW5kZXJBcmVhKF9yZWY5KSB7CiAgdmFyIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzCiAgfSA9IF9yZWY5OwogIHZhciBwcmV2aW91c1BvaW50c1JlZiA9ICgwLCBpbXBvcnRfcmVhY3QzOS51c2VSZWYpKG51bGwpOwogIHZhciBwcmV2aW91c0Jhc2VsaW5lUmVmID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZVJlZikoKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChBcmVhV2l0aEFuaW1hdGlvbiwgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMsCiAgICBwcmV2aW91c1BvaW50c1JlZiwKICAgIHByZXZpb3VzQmFzZWxpbmVSZWYKICB9KTsKfQp2YXIgQXJlYVdpdGhTdGF0ZSA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0MzkuUHVyZUNvbXBvbmVudCB7CiAgcmVuZGVyKCkgewogICAgdmFyIHsKICAgICAgaGlkZSwKICAgICAgZG90LAogICAgICBwb2ludHMsCiAgICAgIGNsYXNzTmFtZSwKICAgICAgdG9wLAogICAgICBsZWZ0LAogICAgICBuZWVkQ2xpcCwKICAgICAgeEF4aXNJZCwKICAgICAgeUF4aXNJZCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgaWQsCiAgICAgIGJhc2VMaW5lLAogICAgICB6SW5kZXgKICAgIH0gPSB0aGlzLnByb3BzOwogICAgaWYgKGhpZGUpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWFyZWEiLCBjbGFzc05hbWUpOwogICAgdmFyIGNsaXBQYXRoSWQgPSBpZDsKICAgIHZhciB7CiAgICAgIHI6IHIyLAogICAgICBzdHJva2VXaWR0aAogICAgfSA9IGdldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdChkb3QpOwogICAgdmFyIGNsaXBEb3QgPSBpc0NsaXBEb3QoZG90KTsKICAgIHZhciBkb3RTaXplID0gcjIgKiAyICsgc3Ryb2tlV2lkdGg7CiAgICB2YXIgYWN0aXZlUG9pbnRzQ2xpcFBhdGggPSBuZWVkQ2xpcCA/ICJ1cmwoI2NsaXBQYXRoLSIuY29uY2F0KGNsaXBEb3QgPyAiIiA6ICJkb3RzLSIpLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpIDogdm9pZCAwOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgICAgekluZGV4CiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcwogICAgfSwgbmVlZENsaXAgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoR3JhcGhpY2FsSXRlbUNsaXBQYXRoLCB7CiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHhBeGlzSWQsCiAgICAgIHlBeGlzSWQKICAgIH0pLCAhY2xpcERvdCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgICAgaWQ6ICJjbGlwUGF0aC1kb3RzLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICB4OiBsZWZ0IC0gZG90U2l6ZSAvIDIsCiAgICAgIHk6IHRvcCAtIGRvdFNpemUgLyAyLAogICAgICB3aWR0aDogd2lkdGggKyBkb3RTaXplLAogICAgICBoZWlnaHQ6IGhlaWdodCArIGRvdFNpemUKICAgIH0pKSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoUmVuZGVyQXJlYSwgewogICAgICBuZWVkQ2xpcCwKICAgICAgY2xpcFBhdGhJZCwKICAgICAgcHJvcHM6IHRoaXMucHJvcHMKICAgIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludHMsIHsKICAgICAgcG9pbnRzLAogICAgICBtYWluQ29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcih0aGlzLnByb3BzLnN0cm9rZSwgdGhpcy5wcm9wcy5maWxsKSwKICAgICAgaXRlbURhdGFLZXk6IHRoaXMucHJvcHMuZGF0YUtleSwKICAgICAgYWN0aXZlRG90OiB0aGlzLnByb3BzLmFjdGl2ZURvdCwKICAgICAgY2xpcFBhdGg6IGFjdGl2ZVBvaW50c0NsaXBQYXRoCiAgICB9KSwgdGhpcy5wcm9wcy5pc1JhbmdlICYmIEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoQWN0aXZlUG9pbnRzLCB7CiAgICAgIHBvaW50czogYmFzZUxpbmUsCiAgICAgIG1haW5Db2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHRoaXMucHJvcHMuc3Ryb2tlLCB0aGlzLnByb3BzLmZpbGwpLAogICAgICBpdGVtRGF0YUtleTogdGhpcy5wcm9wcy5kYXRhS2V5LAogICAgICBhY3RpdmVEb3Q6IHRoaXMucHJvcHMuYWN0aXZlRG90LAogICAgICBjbGlwUGF0aDogYWN0aXZlUG9pbnRzQ2xpcFBhdGgKICAgIH0pKTsKICB9Cn07CnZhciBkZWZhdWx0QXJlYVByb3BzID0gewogIGFjdGl2ZURvdDogdHJ1ZSwKICBhbmltYXRpb25CZWdpbjogMCwKICBhbmltYXRpb25EdXJhdGlvbjogMTUwMCwKICBhbmltYXRpb25FYXNpbmc6ICJlYXNlIiwKICBjb25uZWN0TnVsbHM6IGZhbHNlLAogIGRvdDogZmFsc2UsCiAgZmlsbDogIiMzMTgyYmQiLAogIGZpbGxPcGFjaXR5OiAwLjYsCiAgaGlkZTogZmFsc2UsCiAgaXNBbmltYXRpb25BY3RpdmU6ICJhdXRvIiwKICBsZWdlbmRUeXBlOiAibGluZSIsCiAgc3Ryb2tlOiAiIzMxODJiZCIsCiAgc3Ryb2tlV2lkdGg6IDEsCiAgdHlwZTogImxpbmVhciIsCiAgbGFiZWw6IGZhbHNlLAogIHhBeGlzSWQ6IDAsCiAgeUF4aXNJZDogMCwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5hcmVhCn07CmZ1bmN0aW9uIEFyZWFJbXBsKHByb3BzKSB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjsKICB2YXIgX3Jlc29sdmVEZWZhdWx0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLCBkZWZhdWx0QXJlYVByb3BzKSwgewogICAgYWN0aXZlRG90LAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGNvbm5lY3ROdWxscywKICAgIGRvdCwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGhpZGUsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGxlZ2VuZFR5cGUsCiAgICBzdHJva2UsCiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBfcmVzb2x2ZURlZmF1bHRQcm9wcywgZXZlcnl0aGluZ0Vsc2UgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMihfcmVzb2x2ZURlZmF1bHRQcm9wcywgX2V4Y2x1ZGVkMjYpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciBjaGFydE5hbWUgPSB1c2VDaGFydE5hbWUoKTsKICB2YXIgewogICAgbmVlZENsaXAKICB9ID0gdXNlTmVlZHNDbGlwKHhBeGlzSWQsIHlBeGlzSWQpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciB7CiAgICBwb2ludHMsCiAgICBpc1JhbmdlLAogICAgYmFzZUxpbmUKICB9ID0gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXJlYShzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgcHJvcHMuaWQpKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB7fTsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIGlmIChsYXlvdXQgIT09ICJob3Jpem9udGFsIiAmJiBsYXlvdXQgIT09ICJ2ZXJ0aWNhbCIgfHwgcGxvdEFyZWEgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChjaGFydE5hbWUgIT09ICJBcmVhQ2hhcnQiICYmIGNoYXJ0TmFtZSAhPT0gIkNvbXBvc2VkQ2hhcnQiKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGhlaWdodCwKICAgIHdpZHRoLAogICAgeDogbGVmdCwKICAgIHk6IHRvcAogIH0gPSBwbG90QXJlYTsKICBpZiAoIXBvaW50cyB8fCAhcG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEFyZWFXaXRoU3RhdGUsIF9leHRlbmRzMTgoe30sIGV2ZXJ5dGhpbmdFbHNlLCB7CiAgICBhY3RpdmVEb3QsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgYmFzZUxpbmUsCiAgICBjb25uZWN0TnVsbHMsCiAgICBkb3QsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBoZWlnaHQsCiAgICBoaWRlLAogICAgbGF5b3V0LAogICAgaXNBbmltYXRpb25BY3RpdmU6IGlzQW5pbWF0aW9uQWN0aXZlID09PSAiYXV0byIgPyAhR2xvYmFsLmlzU3NyIDogaXNBbmltYXRpb25BY3RpdmUsCiAgICBpc1JhbmdlLAogICAgbGVnZW5kVHlwZSwKICAgIG5lZWRDbGlwLAogICAgcG9pbnRzLAogICAgc3Ryb2tlLAogICAgd2lkdGgsCiAgICBsZWZ0LAogICAgdG9wLAogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9KSk7Cn0KdmFyIGdldEJhc2VWYWx1ZSA9IChsYXlvdXQsIGNoYXJ0QmFzZVZhbHVlLCBpdGVtQmFzZVZhbHVlLCB4QXhpcywgeUF4aXMpID0+IHsKICB2YXIgYmFzZVZhbHVlID0gaXRlbUJhc2VWYWx1ZSAhPT0gbnVsbCAmJiBpdGVtQmFzZVZhbHVlICE9PSB2b2lkIDAgPyBpdGVtQmFzZVZhbHVlIDogY2hhcnRCYXNlVmFsdWU7CiAgaWYgKGlzTnVtYmVyKGJhc2VWYWx1ZSkpIHsKICAgIHJldHVybiBiYXNlVmFsdWU7CiAgfQogIHZhciBudW1lcmljQXhpcyA9IGxheW91dCA9PT0gImhvcml6b250YWwiID8geUF4aXMgOiB4QXhpczsKICB2YXIgZG9tYWluID0gbnVtZXJpY0F4aXMuc2NhbGUuZG9tYWluKCk7CiAgaWYgKG51bWVyaWNBeGlzLnR5cGUgPT09ICJudW1iZXIiKSB7CiAgICB2YXIgZG9tYWluTWF4ID0gTWF0aC5tYXgoZG9tYWluWzBdLCBkb21haW5bMV0pOwogICAgdmFyIGRvbWFpbk1pbiA9IE1hdGgubWluKGRvbWFpblswXSwgZG9tYWluWzFdKTsKICAgIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWluIikgewogICAgICByZXR1cm4gZG9tYWluTWluOwogICAgfQogICAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNYXgiKSB7CiAgICAgIHJldHVybiBkb21haW5NYXg7CiAgICB9CiAgICByZXR1cm4gZG9tYWluTWF4IDwgMCA/IGRvbWFpbk1heCA6IE1hdGgubWF4KE1hdGgubWluKGRvbWFpblswXSwgZG9tYWluWzFdKSwgMCk7CiAgfQogIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWluIikgewogICAgcmV0dXJuIGRvbWFpblswXTsKICB9CiAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNYXgiKSB7CiAgICByZXR1cm4gZG9tYWluWzFdOwogIH0KICByZXR1cm4gZG9tYWluWzBdOwp9OwpmdW5jdGlvbiBjb21wdXRlQXJlYShfcmVmMCkgewogIHZhciB7CiAgICBhcmVhU2V0dGluZ3M6IHsKICAgICAgY29ubmVjdE51bGxzLAogICAgICBiYXNlVmFsdWU6IGl0ZW1CYXNlVmFsdWUsCiAgICAgIGRhdGFLZXkKICAgIH0sCiAgICBzdGFja2VkRGF0YSwKICAgIGxheW91dCwKICAgIGNoYXJ0QmFzZVZhbHVlLAogICAgeEF4aXMsCiAgICB5QXhpcywKICAgIGRpc3BsYXllZERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIHhBeGlzVGlja3MsCiAgICB5QXhpc1RpY2tzLAogICAgYmFuZFNpemUKICB9ID0gX3JlZjA7CiAgdmFyIGhhc1N0YWNrID0gc3RhY2tlZERhdGEgJiYgc3RhY2tlZERhdGEubGVuZ3RoOwogIHZhciBiYXNlVmFsdWUgPSBnZXRCYXNlVmFsdWUobGF5b3V0LCBjaGFydEJhc2VWYWx1ZSwgaXRlbUJhc2VWYWx1ZSwgeEF4aXMsIHlBeGlzKTsKICB2YXIgaXNIb3Jpem9udGFsTGF5b3V0ID0gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCI7CiAgdmFyIGlzUmFuZ2UgPSBmYWxzZTsKICB2YXIgcG9pbnRzID0gZGlzcGxheWVkRGF0YS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgdmFyIHZhbHVlOwogICAgaWYgKGhhc1N0YWNrKSB7CiAgICAgIHZhbHVlID0gc3RhY2tlZERhdGFbZGF0YVN0YXJ0SW5kZXggKyBpbmRleF07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gW2Jhc2VWYWx1ZSwgdmFsdWVdOwogICAgICB9IGVsc2UgewogICAgICAgIGlzUmFuZ2UgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICB2YXIgaXNCcmVha1BvaW50ID0gdmFsdWVbMV0gPT0gbnVsbCB8fCBoYXNTdGFjayAmJiAhY29ubmVjdE51bGxzICYmIGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KSA9PSBudWxsOwogICAgaWYgKGlzSG9yaXpvbnRhbExheW91dCkgewogICAgICByZXR1cm4gewogICAgICAgIHg6IGdldENhdGVDb29yZGluYXRlT2ZMaW5lKHsKICAgICAgICAgIGF4aXM6IHhBeGlzLAogICAgICAgICAgdGlja3M6IHhBeGlzVGlja3MsCiAgICAgICAgICBiYW5kU2l6ZSwKICAgICAgICAgIGVudHJ5LAogICAgICAgICAgaW5kZXgKICAgICAgICB9KSwKICAgICAgICB5OiBpc0JyZWFrUG9pbnQgPyBudWxsIDogeUF4aXMuc2NhbGUodmFsdWVbMV0pLAogICAgICAgIHZhbHVlLAogICAgICAgIHBheWxvYWQ6IGVudHJ5CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gewogICAgICB4OiBpc0JyZWFrUG9pbnQgPyBudWxsIDogeEF4aXMuc2NhbGUodmFsdWVbMV0pLAogICAgICB5OiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZSh7CiAgICAgICAgYXhpczogeUF4aXMsCiAgICAgICAgdGlja3M6IHlBeGlzVGlja3MsCiAgICAgICAgYmFuZFNpemUsCiAgICAgICAgZW50cnksCiAgICAgICAgaW5kZXgKICAgICAgfSksCiAgICAgIHZhbHVlLAogICAgICBwYXlsb2FkOiBlbnRyeQogICAgfTsKICB9KTsKICB2YXIgYmFzZUxpbmU7CiAgaWYgKGhhc1N0YWNrIHx8IGlzUmFuZ2UpIHsKICAgIGJhc2VMaW5lID0gcG9pbnRzLm1hcCgoZW50cnkpID0+IHsKICAgICAgdmFyIHgyID0gQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkgPyBlbnRyeS52YWx1ZVswXSA6IG51bGw7CiAgICAgIGlmIChpc0hvcml6b250YWxMYXlvdXQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgeDogZW50cnkueCwKICAgICAgICAgIHk6IHgyICE9IG51bGwgJiYgZW50cnkueSAhPSBudWxsID8geUF4aXMuc2NhbGUoeDIpIDogbnVsbCwKICAgICAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogeDIgIT0gbnVsbCA/IHhBeGlzLnNjYWxlKHgyKSA6IG51bGwsCiAgICAgICAgeTogZW50cnkueSwKICAgICAgICBwYXlsb2FkOiBlbnRyeS5wYXlsb2FkCiAgICAgIH07CiAgICB9KTsKICB9IGVsc2UgewogICAgYmFzZUxpbmUgPSBpc0hvcml6b250YWxMYXlvdXQgPyB5QXhpcy5zY2FsZShiYXNlVmFsdWUpIDogeEF4aXMuc2NhbGUoYmFzZVZhbHVlKTsKICB9CiAgcmV0dXJuIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgaXNSYW5nZQogIH07Cn0KZnVuY3Rpb24gQXJlYUZuKG91dHNpZGVQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0QXJlYVByb3BzKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCwgewogICAgaWQ6IHByb3BzLmlkLAogICAgdHlwZTogImFyZWEiCiAgfSwgKGlkKSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFJlYWN0MjcuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU2V0TGVnZW5kUGF5bG9hZCwgewogICAgbGVnZW5kUGF5bG9hZDogY29tcHV0ZUxlZ2VuZFBheWxvYWRGcm9tQXJlYURhdGEocHJvcHMpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU2V0QXJlYVRvb2x0aXBFbnRyeVNldHRpbmdzLCB7CiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgZGF0YTogcHJvcHMuZGF0YSwKICAgIHN0cm9rZTogcHJvcHMuc3Ryb2tlLAogICAgc3Ryb2tlV2lkdGg6IHByb3BzLnN0cm9rZVdpZHRoLAogICAgZmlsbDogcHJvcHMuZmlsbCwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgdW5pdDogcHJvcHMudW5pdCwKICAgIHRvb2x0aXBUeXBlOiBwcm9wcy50b29sdGlwVHlwZQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFNldENhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sIHsKICAgIHR5cGU6ICJhcmVhIiwKICAgIGlkLAogICAgZGF0YTogcHJvcHMuZGF0YSwKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICB4QXhpc0lkOiBwcm9wcy54QXhpc0lkLAogICAgeUF4aXNJZDogcHJvcHMueUF4aXNJZCwKICAgIHpBeGlzSWQ6IDAsCiAgICBzdGFja0lkOiBnZXROb3JtYWxpemVkU3RhY2tJZChwcm9wcy5zdGFja0lkKSwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICBiYXJTaXplOiB2b2lkIDAsCiAgICBiYXNlVmFsdWU6IHByb3BzLmJhc2VWYWx1ZSwKICAgIGlzUGFub3JhbWEsCiAgICBjb25uZWN0TnVsbHM6IHByb3BzLmNvbm5lY3ROdWxscwogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KEFyZWFJbXBsLCBfZXh0ZW5kczE4KHt9LCBwcm9wcywgewogICAgaWQKICB9KSkpKTsKfQp2YXIgQXJlYSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3Lm1lbW8oQXJlYUZuLCBwcm9wc0FyZUVxdWFsKTsKQXJlYS5kaXNwbGF5TmFtZSA9ICJBcmVhIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgUmVhY3QyOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9heGlzUHJvcHNBcmVFcXVhbC5qcwp2YXIgX2V4Y2x1ZGVkMTMgPSBbImRvbWFpbiIsICJyYW5nZSJdOwp2YXIgX2V4Y2x1ZGVkMjcgPSBbImRvbWFpbiIsICJyYW5nZSJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBzaG9ydEFycmF5c0FyZUVxdWFsKGFycjEsIGFycjIpIHsKICBpZiAoYXJyMSA9PT0gYXJyMikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGFycjEpICYmIGFycjEubGVuZ3RoID09PSAyICYmIEFycmF5LmlzQXJyYXkoYXJyMikgJiYgYXJyMi5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiBhcnIxWzBdID09PSBhcnIyWzBdICYmIGFycjFbMV0gPT09IGFycjJbMV07CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBheGlzUHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHZhciB7CiAgICBkb21haW46IHByZXZEb21haW4sCiAgICByYW5nZTogcHJldlJhbmdlCiAgfSA9IHByZXZQcm9wcywgcHJldlJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhwcmV2UHJvcHMsIF9leGNsdWRlZDEzKTsKICB2YXIgewogICAgZG9tYWluOiBuZXh0RG9tYWluLAogICAgcmFuZ2U6IG5leHRSYW5nZQogIH0gPSBuZXh0UHJvcHMsIG5leHRSZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTMobmV4dFByb3BzLCBfZXhjbHVkZWQyNyk7CiAgaWYgKCFzaG9ydEFycmF5c0FyZUVxdWFsKHByZXZEb21haW4sIG5leHREb21haW4pKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmICghc2hvcnRBcnJheXNBcmVFcXVhbChwcmV2UmFuZ2UsIG5leHRSYW5nZSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHByb3BzQXJlRXF1YWwocHJldlJlc3QsIG5leHRSZXN0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL1hBeGlzLmpzCnZhciBfZXhjbHVkZWQxNCA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAidGlja3MiXTsKdmFyIF9leGNsdWRlZDI4ID0gWyJpZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczE5KCkgewogIHJldHVybiBfZXh0ZW5kczE5ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxOS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTQocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIFNldFhBeGlzU2V0dGluZ3Moc2V0dGluZ3MpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkWEF4aXMoc2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VYQXhpcyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogc2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBzZXR0aW5nczsKICB9LCBbc2V0dGluZ3MsIGRpc3BhdGNoXSk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlWEF4aXMocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIFhBeGlzSW1wbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB4QXhpc0lkLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciB2aWV3Qm94ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QXhpc1ZpZXdCb3gpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBheGlzVHlwZSA9ICJ4QXhpcyI7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsIGF4aXNUeXBlLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGNhcnRlc2lhblRpY2tJdGVtcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VGlja3NPZkF4aXMoc3RhdGUsIGF4aXNUeXBlLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGF4aXNTaXplID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NpemUoc3RhdGUsIHhBeGlzSWQpKTsKICB2YXIgcG9zaXRpb24gPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzUG9zaXRpb24oc3RhdGUsIHhBeGlzSWQpKTsKICB2YXIgc3luY2hyb25pemVkU2V0dGluZ3MgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCB4QXhpc0lkKSk7CiAgaWYgKGF4aXNTaXplID09IG51bGwgfHwgcG9zaXRpb24gPT0gbnVsbCB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLAogICAgdGlja3M6IHRpY2tzMgogIH0gPSBwcm9wcywgYWxsT3RoZXJQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KHByb3BzLCBfZXhjbHVkZWQxNCk7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHN5bmNocm9uaXplZFNldHRpbmdzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChzeW5jaHJvbml6ZWRTZXR0aW5ncywgX2V4Y2x1ZGVkMjgpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXMsIF9leHRlbmRzMTkoe30sIGFsbE90aGVyUHJvcHMsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncywgewogICAgc2NhbGUsCiAgICB4OiBwb3NpdGlvbi54LAogICAgeTogcG9zaXRpb24ueSwKICAgIHdpZHRoOiBheGlzU2l6ZS53aWR0aCwKICAgIGhlaWdodDogYXhpc1NpemUuaGVpZ2h0LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIiAiKS5jb25jYXQoYXhpc1R5cGUpLCBjbGFzc05hbWUpLAogICAgdmlld0JveCwKICAgIHRpY2tzOiBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzVHlwZQogIH0pKTsKfTsKdmFyIHhBeGlzRGVmYXVsdFByb3BzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBpbXBsaWNpdFhBeGlzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGltcGxpY2l0WEF4aXMuYWxsb3dEZWNpbWFscywKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogaW1wbGljaXRYQXhpcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBhbmdsZTogaW1wbGljaXRYQXhpcy5hbmdsZSwKICBheGlzTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy5heGlzTGluZSwKICBoZWlnaHQ6IGltcGxpY2l0WEF4aXMuaGVpZ2h0LAogIGhpZGU6IGZhbHNlLAogIGluY2x1ZGVIaWRkZW46IGltcGxpY2l0WEF4aXMuaW5jbHVkZUhpZGRlbiwKICBpbnRlcnZhbDogaW1wbGljaXRYQXhpcy5pbnRlcnZhbCwKICBtaW5UaWNrR2FwOiBpbXBsaWNpdFhBeGlzLm1pblRpY2tHYXAsCiAgbWlycm9yOiBpbXBsaWNpdFhBeGlzLm1pcnJvciwKICBvcmllbnRhdGlvbjogaW1wbGljaXRYQXhpcy5vcmllbnRhdGlvbiwKICBwYWRkaW5nOiBpbXBsaWNpdFhBeGlzLnBhZGRpbmcsCiAgcmV2ZXJzZWQ6IGltcGxpY2l0WEF4aXMucmV2ZXJzZWQsCiAgc2NhbGU6IGltcGxpY2l0WEF4aXMuc2NhbGUsCiAgdGljazogaW1wbGljaXRYQXhpcy50aWNrLAogIHRpY2tDb3VudDogaW1wbGljaXRYQXhpcy50aWNrQ291bnQsCiAgdGlja0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja0xpbmUsCiAgdGlja1NpemU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja1NpemUsCiAgdHlwZTogaW1wbGljaXRYQXhpcy50eXBlLAogIHhBeGlzSWQ6IDAKfTsKdmFyIFhBeGlzU2V0dGluZ3NEaXNwYXRjaGVyID0gKG91dHNpZGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCB4QXhpc0RlZmF1bHRQcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoUmVhY3QyOC5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChTZXRYQXhpc1NldHRpbmdzLCB7CiAgICBhbGxvd0RhdGFPdmVyZmxvdzogcHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgICBhbGxvd0RlY2ltYWxzOiBwcm9wcy5hbGxvd0RlY2ltYWxzLAogICAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHByb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgYW5nbGU6IHByb3BzLmFuZ2xlLAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGRvbWFpbjogcHJvcHMuZG9tYWluLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgaWQ6IHByb3BzLnhBeGlzSWQsCiAgICBpbmNsdWRlSGlkZGVuOiBwcm9wcy5pbmNsdWRlSGlkZGVuLAogICAgaW50ZXJ2YWw6IHByb3BzLmludGVydmFsLAogICAgbWluVGlja0dhcDogcHJvcHMubWluVGlja0dhcCwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgbmFtZTogcHJvcHMubmFtZSwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIHBhZGRpbmc6IHByb3BzLnBhZGRpbmcsCiAgICByZXZlcnNlZDogcHJvcHMucmV2ZXJzZWQsCiAgICBzY2FsZTogcHJvcHMuc2NhbGUsCiAgICB0aWNrOiBwcm9wcy50aWNrLAogICAgdGlja0NvdW50OiBwcm9wcy50aWNrQ291bnQsCiAgICB0aWNrRm9ybWF0dGVyOiBwcm9wcy50aWNrRm9ybWF0dGVyLAogICAgdGlja3M6IHByb3BzLnRpY2tzLAogICAgdHlwZTogcHJvcHMudHlwZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChYQXhpc0ltcGwsIHByb3BzKSk7Cn07CnZhciBYQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4Lm1lbW8oWEF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIsIGF4aXNQcm9wc0FyZUVxdWFsKTsKWEF4aXMuZGlzcGxheU5hbWUgPSAiWEF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL1lBeGlzLmpzCnZhciBSZWFjdDI5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxNSA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAidGlja3MiXTsKdmFyIF9leGNsdWRlZDI5ID0gWyJpZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczIwKCkgewogIHJldHVybiBfZXh0ZW5kczIwID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyMC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIFNldFlBeGlzU2V0dGluZ3Moc2V0dGluZ3MpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDEudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NDEudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkWUF4aXMoc2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VZQXhpcyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogc2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBzZXR0aW5nczsKICB9LCBbc2V0dGluZ3MsIGRpc3BhdGNoXSk7CiAgKDAsIGltcG9ydF9yZWFjdDQxLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlWUF4aXMocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIFlBeGlzSW1wbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB5QXhpc0lkLAogICAgY2xhc3NOYW1lLAogICAgd2lkdGgsCiAgICBsYWJlbAogIH0gPSBwcm9wczsKICB2YXIgY2FydGVzaWFuQXhpc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VSZWYpKG51bGwpOwogIHZhciBsYWJlbFJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MS51c2VSZWYpKG51bGwpOwogIHZhciB2aWV3Qm94ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QXhpc1ZpZXdCb3gpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGF4aXNUeXBlID0gInlBeGlzIjsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgYXhpc1NpemUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2l6ZShzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBwb3NpdGlvbiA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNQb3NpdGlvbihzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBjYXJ0ZXNpYW5UaWNrSXRlbXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRpY2tzT2ZBeGlzKHN0YXRlLCBheGlzVHlwZSwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIHlBeGlzSWQpKTsKICAoMCwgaW1wb3J0X3JlYWN0NDEudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAod2lkdGggIT09ICJhdXRvIiB8fCAhYXhpc1NpemUgfHwgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24obGFiZWwpIHx8IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDEuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBheGlzQ29tcG9uZW50ID0gY2FydGVzaWFuQXhpc1JlZi5jdXJyZW50OwogICAgaWYgKCFheGlzQ29tcG9uZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB1cGRhdGVkWUF4aXNXaWR0aCA9IGF4aXNDb21wb25lbnQuZ2V0Q2FsY3VsYXRlZFdpZHRoKCk7CiAgICBpZiAoTWF0aC5yb3VuZChheGlzU2l6ZS53aWR0aCkgIT09IE1hdGgucm91bmQodXBkYXRlZFlBeGlzV2lkdGgpKSB7CiAgICAgIGRpc3BhdGNoKHVwZGF0ZVlBeGlzV2lkdGgoewogICAgICAgIGlkOiB5QXhpc0lkLAogICAgICAgIHdpZHRoOiB1cGRhdGVkWUF4aXNXaWR0aAogICAgICB9KSk7CiAgICB9CiAgfSwgWwogICAgLy8gVGhlIGRlcGVuZGVuY3kgb24gY2FydGVzaWFuQXhpc1JlZi5jdXJyZW50IGlzIG5vdCBuZWVkZWQgYmVjYXVzZSB1c2VMYXlvdXRFZmZlY3Qgd2lsbCBydW4gYWZ0ZXIgZXZlcnkgcmVuZGVyLgogICAgLy8gVGhlIHJlZiB3aWxsIGJlIHBvcHVsYXRlZCBieSB0aGVuLgogICAgLy8gVG8gcmUtcnVuIHRoaXMgZWZmZWN0IHdoZW4gdGlja3MgY2hhbmdlLCB3ZSBjYW4gZGVwZW5kIG9uIHRoZSB0aWNrcyBhcnJheSBmcm9tIHRoZSBzdG9yZS4KICAgIGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNTaXplLAogICAgZGlzcGF0Y2gsCiAgICBsYWJlbCwKICAgIHlBeGlzSWQsCiAgICB3aWR0aCwKICAgIHN5bmNocm9uaXplZFNldHRpbmdzCiAgXSk7CiAgaWYgKGF4aXNTaXplID09IG51bGwgfHwgcG9zaXRpb24gPT0gbnVsbCB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLAogICAgdGlja3M6IHRpY2tzMgogIH0gPSBwcm9wcywgYWxsT3RoZXJQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE1KHByb3BzLCBfZXhjbHVkZWQxNSk7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHN5bmNocm9uaXplZFNldHRpbmdzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShzeW5jaHJvbml6ZWRTZXR0aW5ncywgX2V4Y2x1ZGVkMjkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXMsIF9leHRlbmRzMjAoe30sIGFsbE90aGVyUHJvcHMsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncywgewogICAgcmVmOiBjYXJ0ZXNpYW5BeGlzUmVmLAogICAgbGFiZWxSZWYsCiAgICBzY2FsZSwKICAgIHg6IHBvc2l0aW9uLngsCiAgICB5OiBwb3NpdGlvbi55LAogICAgdGlja1RleHRQcm9wczogd2lkdGggPT09ICJhdXRvIiA/IHsKICAgICAgd2lkdGg6IHZvaWQgMAogICAgfSA6IHsKICAgICAgd2lkdGgKICAgIH0sCiAgICB3aWR0aDogYXhpc1NpemUud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTaXplLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICIgIikuY29uY2F0KGF4aXNUeXBlKSwgY2xhc3NOYW1lKSwKICAgIHZpZXdCb3gsCiAgICB0aWNrczogY2FydGVzaWFuVGlja0l0ZW1zLAogICAgYXhpc1R5cGUKICB9KSk7Cn07CnZhciB5QXhpc0RlZmF1bHRQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogaW1wbGljaXRZQXhpcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBpbXBsaWNpdFlBeGlzLmFsbG93RGVjaW1hbHMsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGltcGxpY2l0WUF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgYW5nbGU6IGltcGxpY2l0WUF4aXMuYW5nbGUsCiAgYXhpc0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMuYXhpc0xpbmUsCiAgaGlkZTogZmFsc2UsCiAgaW5jbHVkZUhpZGRlbjogaW1wbGljaXRZQXhpcy5pbmNsdWRlSGlkZGVuLAogIGludGVydmFsOiBpbXBsaWNpdFlBeGlzLmludGVydmFsLAogIG1pblRpY2tHYXA6IGltcGxpY2l0WUF4aXMubWluVGlja0dhcCwKICBtaXJyb3I6IGltcGxpY2l0WUF4aXMubWlycm9yLAogIG9yaWVudGF0aW9uOiBpbXBsaWNpdFlBeGlzLm9yaWVudGF0aW9uLAogIHBhZGRpbmc6IGltcGxpY2l0WUF4aXMucGFkZGluZywKICByZXZlcnNlZDogaW1wbGljaXRZQXhpcy5yZXZlcnNlZCwKICBzY2FsZTogaW1wbGljaXRZQXhpcy5zY2FsZSwKICB0aWNrOiBpbXBsaWNpdFlBeGlzLnRpY2ssCiAgdGlja0NvdW50OiBpbXBsaWNpdFlBeGlzLnRpY2tDb3VudCwKICB0aWNrTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrTGluZSwKICB0aWNrU2l6ZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrU2l6ZSwKICB0eXBlOiBpbXBsaWNpdFlBeGlzLnR5cGUsCiAgd2lkdGg6IGltcGxpY2l0WUF4aXMud2lkdGgsCiAgeUF4aXNJZDogMAp9Owp2YXIgWUF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIgPSAob3V0c2lkZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHlBeGlzRGVmYXVsdFByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChSZWFjdDI5LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOS5jcmVhdGVFbGVtZW50KFNldFlBeGlzU2V0dGluZ3MsIHsKICAgIGludGVydmFsOiBwcm9wcy5pbnRlcnZhbCwKICAgIGlkOiBwcm9wcy55QXhpc0lkLAogICAgc2NhbGU6IHByb3BzLnNjYWxlLAogICAgdHlwZTogcHJvcHMudHlwZSwKICAgIGRvbWFpbjogcHJvcHMuZG9tYWluLAogICAgYWxsb3dEYXRhT3ZlcmZsb3c6IHByb3BzLmFsbG93RGF0YU92ZXJmbG93LAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBwcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGFsbG93RGVjaW1hbHM6IHByb3BzLmFsbG93RGVjaW1hbHMsCiAgICB0aWNrQ291bnQ6IHByb3BzLnRpY2tDb3VudCwKICAgIHBhZGRpbmc6IHByb3BzLnBhZGRpbmcsCiAgICBpbmNsdWRlSGlkZGVuOiBwcm9wcy5pbmNsdWRlSGlkZGVuLAogICAgcmV2ZXJzZWQ6IHByb3BzLnJldmVyc2VkLAogICAgdGlja3M6IHByb3BzLnRpY2tzLAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgdW5pdDogcHJvcHMudW5pdCwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBhbmdsZTogcHJvcHMuYW5nbGUsCiAgICBtaW5UaWNrR2FwOiBwcm9wcy5taW5UaWNrR2FwLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChZQXhpc0ltcGwsIHByb3BzKSk7Cn07CnZhciBZQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5Lm1lbW8oWUF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIsIGF4aXNQcm9wc0FyZUVxdWFsKTsKWUF4aXMuZGlzcGxheU5hbWUgPSAiWUF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2FydGVzaWFuQ2hhcnQuanMKdmFyIFJlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1MCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlY2hhcnRzU3RvcmVQcm92aWRlci5qcwp2YXIgUmVhY3QzMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlci5qcwp2YXIgcGlja0NoYXJ0UG9pbnRlciA9IChfc3RhdGUsIGNoYXJ0UG9pbnRlcikgPT4gY2hhcnRQb2ludGVyOwp2YXIgc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyID0gY3JlYXRlU2VsZWN0b3IoW3BpY2tDaGFydFBvaW50ZXIsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RQb2xhclZpZXdCb3gsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlLCBzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RPcmRlcmVkVG9vbHRpcFRpY2tzLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgY29tYmluZUFjdGl2ZVByb3BzKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0Q2hhcnRQb2ludGVyLmpzCnZhciBnZXRDaGFydFBvaW50ZXIgPSAoZXZlbnQpID0+IHsKICB2YXIgcmVjdCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgdmFyIHNjYWxlWCA9IHJlY3Qud2lkdGggLyBldmVudC5jdXJyZW50VGFyZ2V0Lm9mZnNldFdpZHRoOwogIHZhciBzY2FsZVkgPSByZWN0LmhlaWdodCAvIGV2ZW50LmN1cnJlbnRUYXJnZXQub2Zmc2V0SGVpZ2h0OwogIHJldHVybiB7CiAgICAvKgogICAgICogSGVyZSBpdCdzIGltcG9ydGFudCB0byB1c2U6CiAgICAgKiAtIGV2ZW50LmNsaWVudFggYW5kIGV2ZW50LmNsaWVudFkgdG8gZ2V0IHRoZSBtb3VzZSBwb3NpdGlvbiByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQsIGluY2x1ZGluZyBzY3JvbGwuCiAgICAgKiAtIHBhZ2VYIGFuZCBwYWdlWSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgd2hvbGUgZG9jdW1lbnQsIGFuZCBpZ25vcmUgc2Nyb2xsLgogICAgICogLSByZWN0LmxlZnQgYW5kIHJlY3QudG9wIGFyZSB1c2VkIHRvIGdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNoYXJ0IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydC4KICAgICAqIC0gb2Zmc2V0WCBhbmQgb2Zmc2V0WSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0IHBhcmVudAogICAgICogIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIHRoZSBzYW1lIGFzIHRoZSBjbGllbnRYIGFuZCBjbGllbnRZLCBkZXBlbmRpbmcgb24gdGhlIHBvc2l0aW9uIG9mIHRoZSBjaGFydCBpbiB0aGUgRE9NCiAgICAgKiAgYW5kIHN1cnJvdW5kaW5nIGVsZW1lbnQgc3R5bGVzLiBDU1MgcG9zaXRpb246IHJlbGF0aXZlLCBhYnNvbHV0ZSwgZml4ZWQsIHdpbGwgY2hhbmdlIHRoZSBvZmZzZXQgcGFyZW50LgogICAgICogLSBzY2FsZVggYW5kIHNjYWxlWSBhcmUgbmVjZXNzYXJ5IGZvciB3aGVuIHRoZSBjaGFydCBlbGVtZW50IGlzIHNjYWxlZCB1c2luZyBDU1MgYHRyYW5zZm9ybTogc2NhbGUoTilgLgogICAgICovCiAgICBjaGFydFg6IE1hdGgucm91bmQoKGV2ZW50LmNsaWVudFggLSByZWN0LmxlZnQpIC8gc2NhbGVYKSwKICAgIGNoYXJ0WTogTWF0aC5yb3VuZCgoZXZlbnQuY2xpZW50WSAtIHJlY3QudG9wKSAvIHNjYWxlWSkKICB9Owp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbW91c2VFdmVudHNNaWRkbGV3YXJlLmpzCnZhciBtb3VzZUNsaWNrQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJtb3VzZUNsaWNrIik7CnZhciBtb3VzZUNsaWNrTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwptb3VzZUNsaWNrTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogbW91c2VDbGlja0FjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgbW91c2VQb2ludGVyID0gYWN0aW9uLnBheWxvYWQ7CiAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIobGlzdGVuZXJBcGkuZ2V0U3RhdGUoKSwgZ2V0Q2hhcnRQb2ludGVyKG1vdXNlUG9pbnRlcikpOwogICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0TW91c2VDbGlja0F4aXNJbmRleCh7CiAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwp2YXIgbW91c2VNb3ZlQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJtb3VzZU1vdmUiKTsKdmFyIG1vdXNlTW92ZU1pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKdmFyIHJhZklkID0gbnVsbDsKbW91c2VNb3ZlTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogbW91c2VNb3ZlQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBtb3VzZVBvaW50ZXIgPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmIChyYWZJZCAhPT0gbnVsbCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyYWZJZCk7CiAgICB9CiAgICB2YXIgY2hhcnRQb2ludGVyID0gZ2V0Q2hhcnRQb2ludGVyKG1vdXNlUG9pbnRlcik7CiAgICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgIHZhciB0b29sdGlwRXZlbnRUeXBlID0gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5zaGFyZWQpOwogICAgICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgICAgdmFyIGFjdGl2ZVByb3BzID0gc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyKHN0YXRlLCBjaGFydFBvaW50ZXIpOwogICAgICAgIGlmICgoYWN0aXZlUHJvcHMgPT09IG51bGwgfHwgYWN0aXZlUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4KSAhPSBudWxsKSB7CiAgICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZU92ZXJBeGlzSW5kZXgoewogICAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChtb3VzZUxlYXZlQ2hhcnQoKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJhZklkID0gbnVsbDsKICAgIH0pOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyLmpzCmZ1bmN0aW9uIHJlZHV4RGV2dG9vbHNKc29uU3RyaW5naWZ5UmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICByZXR1cm4gIkhUTUxFbGVtZW50IDwiLmNvbmNhdCh2YWx1ZS50YWdOYW1lLCAnIGNsYXNzPSInKS5jb25jYXQodmFsdWUuY2xhc3NOYW1lLCAnIj4nKTsKICB9CiAgaWYgKHZhbHVlID09PSB3aW5kb3cpIHsKICAgIHJldHVybiAiZ2xvYmFsLndpbmRvdyI7CiAgfQogIGlmIChrZXkgPT09ICJjaGlsZHJlbiIgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgcmV0dXJuICI8PENISUxEUkVOPj4iOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3Jvb3RQcm9wc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMiA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBiYXJTaXplOiB2b2lkIDAsCiAgY2xhc3NOYW1lOiB2b2lkIDAsCiAgbWF4QmFyU2l6ZTogdm9pZCAwLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY0lkOiB2b2lkIDAsCiAgc3luY01ldGhvZDogImluZGV4IiwKICBiYXNlVmFsdWU6IHZvaWQgMCwKICByZXZlcnNlU3RhY2tPcmRlcjogZmFsc2UKfTsKdmFyIHJvb3RQcm9wc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyb290UHJvcHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTIsCiAgcmVkdWNlcnM6IHsKICAgIHVwZGF0ZU9wdGlvbnM6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkYmFyR2E7CiAgICAgIHN0YXRlLmFjY2Vzc2liaWxpdHlMYXllciA9IGFjdGlvbi5wYXlsb2FkLmFjY2Vzc2liaWxpdHlMYXllcjsKICAgICAgc3RhdGUuYmFyQ2F0ZWdvcnlHYXAgPSBhY3Rpb24ucGF5bG9hZC5iYXJDYXRlZ29yeUdhcDsKICAgICAgc3RhdGUuYmFyR2FwID0gKF9hY3Rpb24kcGF5bG9hZCRiYXJHYSA9IGFjdGlvbi5wYXlsb2FkLmJhckdhcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJhckdhICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYmFyR2EgOiBpbml0aWFsU3RhdGUxMi5iYXJHYXA7CiAgICAgIHN0YXRlLmJhclNpemUgPSBhY3Rpb24ucGF5bG9hZC5iYXJTaXplOwogICAgICBzdGF0ZS5tYXhCYXJTaXplID0gYWN0aW9uLnBheWxvYWQubWF4QmFyU2l6ZTsKICAgICAgc3RhdGUuc3RhY2tPZmZzZXQgPSBhY3Rpb24ucGF5bG9hZC5zdGFja09mZnNldDsKICAgICAgc3RhdGUuc3luY0lkID0gYWN0aW9uLnBheWxvYWQuc3luY0lkOwogICAgICBzdGF0ZS5zeW5jTWV0aG9kID0gYWN0aW9uLnBheWxvYWQuc3luY01ldGhvZDsKICAgICAgc3RhdGUuY2xhc3NOYW1lID0gYWN0aW9uLnBheWxvYWQuY2xhc3NOYW1lOwogICAgICBzdGF0ZS5iYXNlVmFsdWUgPSBhY3Rpb24ucGF5bG9hZC5iYXNlVmFsdWU7CiAgICAgIHN0YXRlLnJldmVyc2VTdGFja09yZGVyID0gYWN0aW9uLnBheWxvYWQucmV2ZXJzZVN0YWNrT3JkZXI7CiAgICB9CiAgfQp9KTsKdmFyIHJvb3RQcm9wc1JlZHVjZXIgPSByb290UHJvcHNTbGljZS5yZWR1Y2VyOwp2YXIgewogIHVwZGF0ZU9wdGlvbnMKfSA9IHJvb3RQcm9wc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9wb2xhck9wdGlvbnNTbGljZS5qcwp2YXIgcG9sYXJPcHRpb25zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInBvbGFyT3B0aW9ucyIsCiAgaW5pdGlhbFN0YXRlOiBudWxsLAogIHJlZHVjZXJzOiB7CiAgICB1cGRhdGVQb2xhck9wdGlvbnM6IChfc3RhdGUsIGFjdGlvbikgPT4gewogICAgICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICB1cGRhdGVQb2xhck9wdGlvbnMKfSA9IHBvbGFyT3B0aW9uc1NsaWNlLmFjdGlvbnM7CnZhciBwb2xhck9wdGlvbnNSZWR1Y2VyID0gcG9sYXJPcHRpb25zU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2tleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIga2V5RG93bkFjdGlvbiA9IGNyZWF0ZUFjdGlvbigia2V5RG93biIpOwp2YXIgZm9jdXNBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImZvY3VzIik7CnZhciBrZXlib2FyZEV2ZW50c01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKa2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBrZXlEb3duQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICB2YXIgYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUgPSBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyICE9PSBmYWxzZTsKICAgIGlmICghYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHsKICAgICAga2V5Ym9hcmRJbnRlcmFjdGlvbgogICAgfSA9IHN0YXRlLnRvb2x0aXA7CiAgICB2YXIga2V5ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAoa2V5ICE9PSAiQXJyb3dSaWdodCIgJiYga2V5ICE9PSAiQXJyb3dMZWZ0IiAmJiBrZXkgIT09ICJFbnRlciIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlc29sdmVkSW5kZXggPSBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KGtleWJvYXJkSW50ZXJhY3Rpb24sIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhKHN0YXRlKSwgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5KHN0YXRlKSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4oc3RhdGUpKTsKICAgIHZhciBjdXJyZW50SW5kZXggPSByZXNvbHZlZEluZGV4ID09IG51bGwgPyAtMSA6IE51bWJlcihyZXNvbHZlZEluZGV4KTsKICAgIGlmICghTnVtYmVyLmlzRmluaXRlKGN1cnJlbnRJbmRleCkgfHwgY3VycmVudEluZGV4IDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdG9vbHRpcFRpY2tzID0gc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyhzdGF0ZSk7CiAgICBpZiAoa2V5ID09PSAiRW50ZXIiKSB7CiAgICAgIHZhciBfY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXgpKTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlOiAha2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUsCiAgICAgICAgYWN0aXZlSW5kZXg6IGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXgsCiAgICAgICAgYWN0aXZlRGF0YUtleToga2V5Ym9hcmRJbnRlcmFjdGlvbi5kYXRhS2V5LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IF9jb29yZGluYXRlCiAgICAgIH0pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRpcmVjdGlvbiA9IHNlbGVjdENoYXJ0RGlyZWN0aW9uKHN0YXRlKTsKICAgIHZhciBkaXJlY3Rpb25NdWx0aXBsaWVyID0gZGlyZWN0aW9uID09PSAibGVmdC10by1yaWdodCIgPyAxIDogLTE7CiAgICB2YXIgbW92ZW1lbnQgPSBrZXkgPT09ICJBcnJvd1JpZ2h0IiA/IDEgOiAtMTsKICAgIHZhciBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggKyBtb3ZlbWVudCAqIGRpcmVjdGlvbk11bHRpcGxpZXI7CiAgICBpZiAodG9vbHRpcFRpY2tzID09IG51bGwgfHwgbmV4dEluZGV4ID49IHRvb2x0aXBUaWNrcy5sZW5ndGggfHwgbmV4dEluZGV4IDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKG5leHRJbmRleCkpOwogICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgYWN0aXZlSW5kZXg6IG5leHRJbmRleC50b1N0cmluZygpLAogICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgIH0pKTsKICB9Cn0pOwprZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGZvY3VzQWN0aW9uLAogIGVmZmVjdDogKF9hY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIGFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlID0gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciAhPT0gZmFsc2U7CiAgICBpZiAoIWFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB7CiAgICAgIGtleWJvYXJkSW50ZXJhY3Rpb24KICAgIH0gPSBzdGF0ZS50b29sdGlwOwogICAgaWYgKGtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChrZXlib2FyZEludGVyYWN0aW9uLmluZGV4ID09IG51bGwpIHsKICAgICAgdmFyIG5leHRJbmRleCA9ICIwIjsKICAgICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhuZXh0SW5kZXgpKTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgICBhY3RpdmVJbmRleDogbmV4dEluZGV4LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9leHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGV4dGVybmFsRXZlbnRBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImV4dGVybmFsRXZlbnQiKTsKdmFyIGV4dGVybmFsRXZlbnRzTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp2YXIgcmFmSWRNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwpleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGV4dGVybmFsRXZlbnRBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHsKICAgICAgaGFuZGxlciwKICAgICAgcmVhY3RFdmVudAogICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGhhbmRsZXIgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZWFjdEV2ZW50LnBlcnNpc3QoKTsKICAgIHZhciBldmVudFR5cGUgPSByZWFjdEV2ZW50LnR5cGU7CiAgICB2YXIgZXhpc3RpbmdSYWZJZCA9IHJhZklkTWFwLmdldChldmVudFR5cGUpOwogICAgaWYgKGV4aXN0aW5nUmFmSWQgIT09IHZvaWQgMCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShleGlzdGluZ1JhZklkKTsKICAgIH0KICAgIHZhciByYWZJZDIgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICB0cnkgewogICAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHsKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IHNlbGVjdEFjdGl2ZVRvb2x0aXBDb29yZGluYXRlKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhS2V5KHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZUluZGV4OiBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgoc3RhdGUpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IHNlbGVjdEFjdGl2ZUxhYmVsKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZVRvb2x0aXBJbmRleDogc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KHN0YXRlKSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogc2VsZWN0SXNUb29sdGlwQWN0aXZlKHN0YXRlKQogICAgICAgIH07CiAgICAgICAgaGFuZGxlcihuZXh0U3RhdGUsIHJlYWN0RXZlbnQpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHJhZklkTWFwLmRlbGV0ZShldmVudFR5cGUpOwogICAgICB9CiAgICB9KTsKICAgIHJhZklkTWFwLnNldChldmVudFR5cGUsIHJhZklkMik7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy90b3VjaFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QWxsVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZV0sICh0b29sdGlwU3RhdGUpID0+IHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciwgKF9zdGF0ZSwgdG9vbHRpcEluZGV4LCBfZGF0YUtleSkgPT4gdG9vbHRpcEluZGV4LCAoX3N0YXRlLCBfdG9vbHRpcEluZGV4LCBkYXRhS2V5KSA9PiBkYXRhS2V5XSwgKGFsbFRvb2x0aXBDb25maWd1cmF0aW9ucywgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwgdG9vbHRpcEluZGV4LCBkYXRhS2V5KSA9PiB7CiAgdmFyIG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uID0gYWxsVG9vbHRpcENvbmZpZ3VyYXRpb25zLmZpbmQoKHRvb2x0aXBDb25maWd1cmF0aW9uKSA9PiB7CiAgICByZXR1cm4gdG9vbHRpcENvbmZpZ3VyYXRpb24uc2V0dGluZ3MuZGF0YUtleSA9PT0gZGF0YUtleTsKICB9KTsKICBpZiAobW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHBvc2l0aW9ucwogIH0gPSBtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbjsKICBpZiAocG9zaXRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBtYXliZVBvc2l0aW9uID0gdG9vbHRpcFBheWxvYWRTZWFyY2hlcihwb3NpdGlvbnMsIHRvb2x0aXBJbmRleCk7CiAgcmV0dXJuIG1heWJlUG9zaXRpb247Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdG91Y2hFdmVudHNNaWRkbGV3YXJlLmpzCnZhciB0b3VjaEV2ZW50QWN0aW9uID0gY3JlYXRlQWN0aW9uKCJ0b3VjaE1vdmUiKTsKdmFyIHRvdWNoRXZlbnRNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CnRvdWNoRXZlbnRNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiB0b3VjaEV2ZW50QWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciB0b3VjaEV2ZW50ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAodG91Y2hFdmVudC50b3VjaGVzID09IG51bGwgfHwgdG91Y2hFdmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnNoYXJlZCk7CiAgICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihzdGF0ZSwgZ2V0Q2hhcnRQb2ludGVyKHsKICAgICAgICBjbGllbnRYOiB0b3VjaEV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WCwKICAgICAgICBjbGllbnRZOiB0b3VjaEV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WSwKICAgICAgICBjdXJyZW50VGFyZ2V0OiB0b3VjaEV2ZW50LmN1cnJlbnRUYXJnZXQKICAgICAgfSkpOwogICAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlT3ZlckF4aXNJbmRleCh7CiAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgICAgfSkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJpdGVtIikgewogICAgICB2YXIgX3RhcmdldCRnZXRBdHRyaWJ1dGU7CiAgICAgIHZhciB0b3VjaCA9IHRvdWNoRXZlbnQudG91Y2hlc1swXTsKICAgICAgaWYgKGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQgPT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludCh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTsKICAgICAgaWYgKCF0YXJnZXQgfHwgIXRhcmdldC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGl0ZW1JbmRleCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoREFUQV9JVEVNX0lOREVYX0FUVFJJQlVURV9OQU1FKTsKICAgICAgdmFyIGRhdGFLZXkgPSAoX3RhcmdldCRnZXRBdHRyaWJ1dGUgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKERBVEFfSVRFTV9EQVRBS0VZX0FUVFJJQlVURV9OQU1FKSkgIT09IG51bGwgJiYgX3RhcmdldCRnZXRBdHRyaWJ1dGUgIT09IHZvaWQgMCA/IF90YXJnZXQkZ2V0QXR0cmlidXRlIDogdm9pZCAwOwogICAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdFRvb2x0aXBDb29yZGluYXRlKGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGl0ZW1JbmRleCwgZGF0YUtleSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleCh7CiAgICAgICAgYWN0aXZlRGF0YUtleTogZGF0YUtleSwKICAgICAgICBhY3RpdmVJbmRleDogaXRlbUluZGV4LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zdG9yZS5qcwp2YXIgcm9vdFJlZHVjZXIgPSBjb21iaW5lUmVkdWNlcnMoewogIGJydXNoOiBicnVzaFJlZHVjZXIsCiAgY2FydGVzaWFuQXhpczogY2FydGVzaWFuQXhpc1JlZHVjZXIsCiAgY2hhcnREYXRhOiBjaGFydERhdGFSZWR1Y2VyLAogIGVycm9yQmFyczogZXJyb3JCYXJSZWR1Y2VyLAogIGdyYXBoaWNhbEl0ZW1zOiBncmFwaGljYWxJdGVtc1JlZHVjZXIsCiAgbGF5b3V0OiBjaGFydExheW91dFJlZHVjZXIsCiAgbGVnZW5kOiBsZWdlbmRSZWR1Y2VyLAogIG9wdGlvbnM6IG9wdGlvbnNSZWR1Y2VyLAogIHBvbGFyQXhpczogcG9sYXJBeGlzUmVkdWNlciwKICBwb2xhck9wdGlvbnM6IHBvbGFyT3B0aW9uc1JlZHVjZXIsCiAgcmVmZXJlbmNlRWxlbWVudHM6IHJlZmVyZW5jZUVsZW1lbnRzUmVkdWNlciwKICByb290UHJvcHM6IHJvb3RQcm9wc1JlZHVjZXIsCiAgdG9vbHRpcDogdG9vbHRpcFJlZHVjZXIsCiAgekluZGV4OiB6SW5kZXhSZWR1Y2VyCn0pOwp2YXIgY3JlYXRlUmVjaGFydHNTdG9yZSA9IGZ1bmN0aW9uIGNyZWF0ZVJlY2hhcnRzU3RvcmUyKHByZWxvYWRlZFN0YXRlKSB7CiAgdmFyIGNoYXJ0TmFtZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogIkNoYXJ0IjsKICByZXR1cm4gY29uZmlndXJlU3RvcmUoewogICAgcmVkdWNlcjogcm9vdFJlZHVjZXIsCiAgICAvLyByZWR1eC10b29sa2l0IHYxIHR5cGVzIGFyZSB1bmhhcHB5IHdpdGggdGhlIHByZWxvYWRlZFN0YXRlIHR5cGUuIFJlbW92ZSB0aGUgYGFzIGFueWAgd2hlbiBidW1waW5nIHRvIHYyCiAgICBwcmVsb2FkZWRTdGF0ZSwKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgcmVkdXgtdG9vbGtpdCB2MSB0eXBlcyBhcmUgdW5oYXBweSB3aXRoIHRoZSBtaWRkbGV3YXJlIGFycmF5LiBSZW1vdmUgdGhpcyBjb21tZW50IHdoZW4gYnVtcGluZyB0byB2MgogICAgbWlkZGxld2FyZTogKGdldERlZmF1bHRNaWRkbGV3YXJlKSA9PiB7CiAgICAgIHZhciBfcHJvY2VzcyRlbnYkTk9ERV9FTlY7CiAgICAgIHJldHVybiBnZXREZWZhdWx0TWlkZGxld2FyZSh7CiAgICAgICAgc2VyaWFsaXphYmxlQ2hlY2s6IGZhbHNlLAogICAgICAgIGltbXV0YWJsZUNoZWNrOiAhWyJjb21tb25qcyIsICJlczYiLCAicHJvZHVjdGlvbiJdLmluY2x1ZGVzKChfcHJvY2VzcyRlbnYkTk9ERV9FTlYgPSAiZXM2IikgIT09IG51bGwgJiYgX3Byb2Nlc3MkZW52JE5PREVfRU5WICE9PSB2b2lkIDAgPyBfcHJvY2VzcyRlbnYkTk9ERV9FTlYgOiAiIikKICAgICAgfSkuY29uY2F0KFttb3VzZUNsaWNrTWlkZGxld2FyZS5taWRkbGV3YXJlLCBtb3VzZU1vdmVNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIGtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5taWRkbGV3YXJlLCBleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUubWlkZGxld2FyZSwgdG91Y2hFdmVudE1pZGRsZXdhcmUubWlkZGxld2FyZV0pOwogICAgfSwKICAgIC8qCiAgICAgKiBJIGNhbid0IGZpbmQgb3V0IGhvdyB0byBzYXRpc2Z5IHR5cGVzY3JpcHQgaGVyZS4KICAgICAqIFdlIHJldHVybiBgRW5oYW5jZXJBcnJheTxbU3RvcmVFbmhhbmNlcjx7fSwge30+LCBTdG9yZUVuaGFuY2VyXT5gIGZyb20gdGhpcyBmdW5jdGlvbiwKICAgICAqIGJ1dCB0aGUgdHlwZXMgc2F5IHdlIHNob3VsZCByZXR1cm4gYEVuaGFuY2VyQXJyYXk8U3RvcmVFbmhhbmNlcjx7fSwge30+YC4KICAgICAqIExvb2tzIGxpa2UgaXQncyBiYWRseSBpbmZlcnJlZCBnZW5lcmljcywgYnV0IGl0IHdvbid0IGFsbG93IG1lIHRvIHByb3ZpZGUgdGhlIGNvcnJlY3QgdHlwZSBtYW51YWxseSBlaXRoZXIuCiAgICAgKiBTbyBsZXQncyBqdXN0IGlnbm9yZSB0aGUgZXJyb3IgZm9yIG5vdy4KICAgICAqLwogICAgLy8gQHRzLWV4cGVjdC1lcnJvciBtaXNtYXRjaGVkIGdlbmVyaWNzCiAgICBlbmhhbmNlcnM6IChnZXREZWZhdWx0RW5oYW5jZXJzKSA9PiB7CiAgICAgIHZhciBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzOwogICAgICBpZiAodHlwZW9mIGdldERlZmF1bHRFbmhhbmNlcnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuaGFuY2Vycy5jb25jYXQoYXV0b0JhdGNoRW5oYW5jZXIoewogICAgICAgIHR5cGU6ICJyYWYiCiAgICAgIH0pKTsKICAgIH0sCiAgICBkZXZUb29sczogR2xvYmFsLmRldlRvb2xzRW5hYmxlZCAmJiB7CiAgICAgIHNlcmlhbGl6ZTogewogICAgICAgIHJlcGxhY2VyOiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyCiAgICAgIH0sCiAgICAgIG5hbWU6ICJyZWNoYXJ0cy0iLmNvbmNhdChjaGFydE5hbWUpCiAgICB9CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1N0b3JlUHJvdmlkZXIuanMKZnVuY3Rpb24gUmVjaGFydHNTdG9yZVByb3ZpZGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHByZWxvYWRlZFN0YXRlLAogICAgY2hpbGRyZW4sCiAgICByZWR1eFN0b3JlTmFtZQogIH0gPSBfcmVmMjsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgc3RvcmVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDIudXNlUmVmKShudWxsKTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICBpZiAoc3RvcmVSZWYuY3VycmVudCA9PSBudWxsKSB7CiAgICBzdG9yZVJlZi5jdXJyZW50ID0gY3JlYXRlUmVjaGFydHNTdG9yZShwcmVsb2FkZWRTdGF0ZSwgcmVkdXhTdG9yZU5hbWUpOwogIH0KICB2YXIgbm9uTnVsbENvbnRleHQgPSBSZWNoYXJ0c1JlZHV4Q29udGV4dDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChQcm92aWRlcl9kZWZhdWx0LCB7CiAgICBjb250ZXh0OiBub25OdWxsQ29udGV4dCwKICAgIHN0b3JlOiBzdG9yZVJlZi5jdXJyZW50CiAgfSwgY2hpbGRyZW4pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZXBvcnRNYWluQ2hhcnRQcm9wcy5qcwp2YXIgaW1wb3J0X3JlYWN0NDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFJlcG9ydE1haW5DaGFydFByb3BzSW1wbChfcmVmMikgewogIHZhciB7CiAgICBsYXlvdXQsCiAgICBtYXJnaW4KICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICAoMCwgaW1wb3J0X3JlYWN0NDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzUGFub3JhbWEpIHsKICAgICAgZGlzcGF0Y2goc2V0TGF5b3V0KGxheW91dCkpOwogICAgICBkaXNwYXRjaChzZXRNYXJnaW4obWFyZ2luKSk7CiAgICB9CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCBsYXlvdXQsIG1hcmdpbl0pOwogIHJldHVybiBudWxsOwp9CnZhciBSZXBvcnRNYWluQ2hhcnRQcm9wcyA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDMubWVtbykoUmVwb3J0TWFpbkNoYXJ0UHJvcHNJbXBsLCBwcm9wc0FyZUVxdWFsKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlcG9ydENoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQ0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRDaGFydFByb3BzKHByb3BzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0NDQudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaCh1cGRhdGVPcHRpb25zKHByb3BzKSk7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXRlZ29yaWNhbENoYXJ0LmpzCnZhciBSZWFjdDM0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvUm9vdFN1cmZhY2UuanMKdmFyIFJlYWN0MzIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhQb3J0YWwuanMKdmFyIFJlYWN0MzEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gWkluZGV4U3ZnUG9ydGFsKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIHByZWZpeCA9IGlzUGFub3JhbWEgPyAicmVjaGFydHMtemluZGV4LXBhbm9yYW1hLSIgOiAicmVjaGFydHMtemluZGV4LSI7CiAgdmFyIHBvcnRhbElkID0gdXNlVW5pcXVlSWQoIiIuY29uY2F0KHByZWZpeCkuY29uY2F0KHpJbmRleCkpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQ1LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2gocmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCh7CiAgICAgIHpJbmRleCwKICAgICAgZWxlbWVudElkOiBwb3J0YWxJZCwKICAgICAgaXNQYW5vcmFtYQogICAgfSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2godW5yZWdpc3RlclpJbmRleFBvcnRhbElkKHsKICAgICAgICB6SW5kZXgsCiAgICAgICAgaXNQYW5vcmFtYQogICAgICB9KSk7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgekluZGV4LCBwb3J0YWxJZCwgaXNQYW5vcmFtYV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgdGFiSW5kZXg6IC0xLAogICAgaWQ6IHBvcnRhbElkCiAgfSk7Cn0KZnVuY3Rpb24gQWxsWkluZGV4UG9ydGFscyhfcmVmMikgewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIGFsbFJlZ2lzdGVyZWRaSW5kZXhlcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFsbFJlZ2lzdGVyZWRaSW5kZXhlcyk7CiAgaWYgKCFhbGxSZWdpc3RlcmVkWkluZGV4ZXMgfHwgYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICB2YXIgYWxsTmVnYXRpdmVaSW5kZXhlcyA9IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5maWx0ZXIoKHpJbmRleCkgPT4gekluZGV4IDwgMCk7CiAgdmFyIGFsbFBvc2l0aXZlWkluZGV4ZXMgPSBhbGxSZWdpc3RlcmVkWkluZGV4ZXMuZmlsdGVyKCh6SW5kZXgpID0+IHpJbmRleCA+IDApOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFJlYWN0MzEuRnJhZ21lbnQsIG51bGwsIGFsbE5lZ2F0aXZlWkluZGV4ZXMubWFwKCh6SW5kZXgpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoWkluZGV4U3ZnUG9ydGFsLCB7CiAgICBrZXk6IHpJbmRleCwKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9KSksIGNoaWxkcmVuLCBhbGxQb3NpdGl2ZVpJbmRleGVzLm1hcCgoekluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KFpJbmRleFN2Z1BvcnRhbCwgewogICAga2V5OiB6SW5kZXgsCiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1Jvb3RTdXJmYWNlLmpzCnZhciBfZXhjbHVkZWQxNiA9IFsiY2hpbGRyZW4iXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTYoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE2KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX2V4dGVuZHMyMSgpIHsKICByZXR1cm4gX2V4dGVuZHMyMSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjEuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRlVMTF9XSURUSF9BTkRfSEVJR0hUID0gewogIHdpZHRoOiAiMTAwJSIsCiAgaGVpZ2h0OiAiMTAwJSIsCiAgLyoKICAgKiBkaXNwbGF5OiBibG9jayBpcyBuZWNlc3NhcnkgaGVyZSBiZWNhdXNlIHRoZSBkZWZhdWx0IGZvciBhbiBTVkcgaXMgZGlzcGxheTogaW5saW5lLAogICAqIHdoaWNoIGluIHNvbWUgYnJvd3NlcnMgKENocm9tZSkgYWRkcyBhIGxpdHRsZSBiaXQgb2YgZXh0cmEgc3BhY2UgYWJvdmUgYW5kIGJlbG93IHRoZSBTVkcKICAgKiB0byBtYWtlIHNwYWNlIGZvciB0aGUgZGVzY2VuZGVyIG9mIGxldHRlcnMgbGlrZSAiZyIgYW5kICJ5Ii4gVGhpcyB0aHJvd3Mgb2ZmIHRoZSBoZWlnaHQgY2FsY3VsYXRpb24KICAgKiBhbmQgY2F1c2VzIHRoZSBjb250YWluZXIgdG8gZ3JvdyBpbmRlZmluaXRlbHkgb24gZWFjaCByZW5kZXIgd2l0aCByZXNwb25zaXZlPXRydWUuCiAgICogRGlzcGxheTogYmxvY2sgcmVtb3ZlcyB0aGF0IGV4dHJhIHNwYWNlLgogICAqCiAgICogSW50ZXJlc3RpbmdseSwgRmlyZWZveCBkb2VzIG5vdCBoYXZlIHRoaXMgcHJvYmxlbSwgYnV0IGl0IGRvZXNuJ3QgaHVydCB0byBhZGQgdGhlIHN0eWxlIGFueXdheS4KICAgKi8KICBkaXNwbGF5OiAiYmxvY2siCn07CnZhciBNYWluQ2hhcnRTdXJmYWNlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ni5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB3aWR0aCA9IHVzZUNoYXJ0V2lkdGgoKTsKICB2YXIgaGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgaGFzQWNjZXNzaWJpbGl0eUxheWVyID0gdXNlQWNjZXNzaWJpbGl0eUxheWVyKCk7CiAgaWYgKCFpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSB8fCAhaXNQb3NpdGl2ZU51bWJlcihoZWlnaHQpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgb3RoZXJBdHRyaWJ1dGVzLAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzOwogIHZhciB0YWJJbmRleCwgcm9sZTsKICBpZiAob3RoZXJBdHRyaWJ1dGVzICE9IG51bGwpIHsKICAgIGlmICh0eXBlb2Ygb3RoZXJBdHRyaWJ1dGVzLnRhYkluZGV4ID09PSAibnVtYmVyIikgewogICAgICB0YWJJbmRleCA9IG90aGVyQXR0cmlidXRlcy50YWJJbmRleDsKICAgIH0gZWxzZSB7CiAgICAgIHRhYkluZGV4ID0gaGFzQWNjZXNzaWJpbGl0eUxheWVyID8gMCA6IHZvaWQgMDsKICAgIH0KICAgIGlmICh0eXBlb2Ygb3RoZXJBdHRyaWJ1dGVzLnJvbGUgPT09ICJzdHJpbmciKSB7CiAgICAgIHJvbGUgPSBvdGhlckF0dHJpYnV0ZXMucm9sZTsKICAgIH0gZWxzZSB7CiAgICAgIHJvbGUgPSBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPyAiYXBwbGljYXRpb24iIDogdm9pZCAwOwogICAgfQogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChTdXJmYWNlLCBfZXh0ZW5kczIxKHt9LCBvdGhlckF0dHJpYnV0ZXMsIHsKICAgIHRpdGxlLAogICAgZGVzYywKICAgIHJvbGUsCiAgICB0YWJJbmRleCwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3R5bGU6IEZVTExfV0lEVEhfQU5EX0hFSUdIVCwKICAgIHJlZgogIH0pLCBjaGlsZHJlbik7Cn0pOwp2YXIgQnJ1c2hQYW5vcmFtYVN1cmZhY2UgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIGJydXNoRGltZW5zaW9ucyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoRGltZW5zaW9ucyk7CiAgaWYgKCFicnVzaERpbWVuc2lvbnMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB5OiB5MiwKICAgIHg6IHgyCiAgfSA9IGJydXNoRGltZW5zaW9uczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChTdXJmYWNlLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCBjaGlsZHJlbik7Cn07CnZhciBSb290U3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDYuZm9yd2FyZFJlZikoKF9yZWYyLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjIsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNihfcmVmMiwgX2V4Y2x1ZGVkMTYpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChCcnVzaFBhbm9yYW1hU3VyZmFjZSwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChBbGxaSW5kZXhQb3J0YWxzLCB7CiAgICAgIGlzUGFub3JhbWE6IHRydWUKICAgIH0sIGNoaWxkcmVuKSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KE1haW5DaGFydFN1cmZhY2UsIF9leHRlbmRzMjEoewogICAgcmVmCiAgfSwgcmVzdCksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoQWxsWkluZGV4UG9ydGFscywgewogICAgaXNQYW5vcmFtYTogZmFsc2UKICB9LCBjaGlsZHJlbikpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1JlY2hhcnRzV3JhcHBlci5qcwp2YXIgUmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VSZXBvcnRTY2FsZS5qcwp2YXIgaW1wb3J0X3JlYWN0NDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZVJlcG9ydFNjYWxlKCkgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFtyZWYsIHNldFJlZl0gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKG51bGwpOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENvbnRhaW5lclNjYWxlKTsKICAoMCwgaW1wb3J0X3JlYWN0NDcudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocmVmID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlY3QgPSByZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB2YXIgbmV3U2NhbGUgPSByZWN0LndpZHRoIC8gcmVmLm9mZnNldFdpZHRoOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobmV3U2NhbGUpICYmIG5ld1NjYWxlICE9PSBzY2FsZSkgewogICAgICBkaXNwYXRjaChzZXRTY2FsZShuZXdTY2FsZSkpOwogICAgfQogIH0sIFtyZWYsIGRpc3BhdGNoLCBzY2FsZV0pOwogIHJldHVybiBzZXRSZWY7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1JlY2hhcnRzV3JhcHBlci5qcwpmdW5jdGlvbiBvd25LZXlzMzMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzMyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzNChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzNChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzNCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzNCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMyMigpIHsKICByZXR1cm4gX2V4dGVuZHMyMiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRXZlbnRTeW5jaHJvbml6ZXIgPSAoKSA9PiB7CiAgdXNlU3luY2hyb25pc2VkRXZlbnRzRnJvbU90aGVyQ2hhcnRzKCk7CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIGdldE51bWJlck9yWmVybyh2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICB2YXIgcGFyc2VkID0gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICBpZiAoIU51bWJlci5pc05hTihwYXJzZWQpKSB7CiAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9CiAgfQogIHJldHVybiAwOwp9CnZhciBSZXNwb25zaXZlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0OC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciBfcHJvcHMkc3R5bGUsIF9wcm9wcyRzdHlsZTI7CiAgdmFyIG9ic2VydmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZVJlZikobnVsbCk7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogZ2V0TnVtYmVyT3JaZXJvKChfcHJvcHMkc3R5bGUgPSBwcm9wcy5zdHlsZSkgPT09IG51bGwgfHwgX3Byb3BzJHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcHJvcHMkc3R5bGUud2lkdGgpLAogICAgY29udGFpbmVySGVpZ2h0OiBnZXROdW1iZXJPclplcm8oKF9wcm9wcyRzdHlsZTIgPSBwcm9wcy5zdHlsZSkgPT09IG51bGwgfHwgX3Byb3BzJHN0eWxlMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJHN0eWxlMi5oZWlnaHQpCiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgaWYgKG5vZGUgIT0gbnVsbCAmJiB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0CiAgICAgIH0gPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQpOwogICAgICB2YXIgY2FsbGJhY2sgPSAoZW50cmllcykgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodAogICAgICAgIH0gPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0OwogICAgICAgIHNldENvbnRhaW5lclNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgIH07CiAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7CiAgICAgIG9ic2VydmVyLm9ic2VydmUobm9kZSk7CiAgICAgIG9ic2VydmVyUmVmLmN1cnJlbnQgPSBvYnNlcnZlcjsKICAgIH0KICB9LCBbcmVmLCBzZXRDb250YWluZXJTaXplXSk7CiAgKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgdmFyIG9ic2VydmVyID0gb2JzZXJ2ZXJSZWYuY3VycmVudDsKICAgICAgaWYgKG9ic2VydmVyICE9IG51bGwpIHsKICAgICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgIH0KICAgIH07CiAgfSwgW3NldENvbnRhaW5lclNpemVdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZWFjdDMzLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGg6IHNpemVzLmNvbnRhaW5lcldpZHRoLAogICAgaGVpZ2h0OiBzaXplcy5jb250YWluZXJIZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyMih7CiAgICByZWY6IGlubmVyUmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgUmVhZFNpemVPbmNlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0OC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBnZXROdW1iZXJPclplcm8od2lkdGgpLAogICAgY29udGFpbmVySGVpZ2h0OiBnZXROdW1iZXJPclplcm8oaGVpZ2h0KQogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQKICAgICAgfSA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCk7CiAgICB9CiAgfSwgW3JlZiwgc2V0Q29udGFpbmVyU2l6ZV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlYWN0MzMuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aDogc2l6ZXMuY29udGFpbmVyV2lkdGgsCiAgICBoZWlnaHQ6IHNpemVzLmNvbnRhaW5lckhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczIyKHsKICAgIHJlZjogaW5uZXJSZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBTdGF0aWNEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlYWN0MzMuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczIyKHsKICAgIHJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIE5vblJlc3BvbnNpdmVEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIGlmIChpc1BlcmNlbnQod2lkdGgpIHx8IGlzUGVyY2VudChoZWlnaHQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZWFkU2l6ZU9uY2VEaXYsIF9leHRlbmRzMjIoe30sIHByb3BzLCB7CiAgICAgIHJlZgogICAgfSkpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChTdGF0aWNEaXYsIF9leHRlbmRzMjIoe30sIHByb3BzLCB7CiAgICByZWYKICB9KSk7Cn0pOwpmdW5jdGlvbiBnZXRXcmFwcGVyRGl2Q29tcG9uZW50KHJlc3BvbnNpdmUpIHsKICByZXR1cm4gcmVzcG9uc2l2ZSA9PT0gdHJ1ZSA/IFJlc3BvbnNpdmVEaXYgOiBOb25SZXNwb25zaXZlRGl2Owp9CnZhciBSZWNoYXJ0c1dyYXBwZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lLAogICAgaGVpZ2h0OiBoZWlnaHRGcm9tUHJvcHMsCiAgICBvbkNsaWNrLAogICAgb25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2ssCiAgICBvbk1vdXNlRG93biwKICAgIG9uTW91c2VFbnRlciwKICAgIG9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VNb3ZlLAogICAgb25Nb3VzZVVwLAogICAgb25Ub3VjaEVuZCwKICAgIG9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaFN0YXJ0LAogICAgc3R5bGUsCiAgICB3aWR0aDogd2lkdGhGcm9tUHJvcHMsCiAgICByZXNwb25zaXZlLAogICAgZGlzcGF0Y2hUb3VjaEV2ZW50cyA9IHRydWUKICB9ID0gcHJvcHM7CiAgdmFyIGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VSZWYpKG51bGwpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFt0b29sdGlwUG9ydGFsLCBzZXRUb29sdGlwUG9ydGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VTdGF0ZSkobnVsbCk7CiAgdmFyIFtsZWdlbmRQb3J0YWwsIHNldExlZ2VuZFBvcnRhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlU3RhdGUpKG51bGwpOwogIHZhciBzZXRTY2FsZVJlZiA9IHVzZVJlcG9ydFNjYWxlKCk7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIHZhciB3aWR0aCA9IChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSBudWxsIHx8IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGgpID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggOiB3aWR0aEZyb21Qcm9wczsKICB2YXIgaGVpZ2h0ID0gKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IG51bGwgfHwgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQpID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0IDogaGVpZ2h0RnJvbVByb3BzOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIHNldFNjYWxlUmVmKG5vZGUpOwogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgc2V0VG9vbHRpcFBvcnRhbChub2RlKTsKICAgIHNldExlZ2VuZFBvcnRhbChub2RlKTsKICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgY29udGFpbmVyUmVmLmN1cnJlbnQgPSBub2RlOwogICAgfQogIH0sIFtzZXRTY2FsZVJlZiwgcmVmLCBzZXRUb29sdGlwUG9ydGFsLCBzZXRMZWdlbmRQb3J0YWxdKTsKICB2YXIgbXlPbkNsaWNrID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VDbGlja0FjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25DbGljaywKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25DbGlja10pOwogIHZhciBteU9uTW91c2VFbnRlciA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTW92ZUFjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZUVudGVyLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlRW50ZXJdKTsKICB2YXIgbXlPbk1vdXNlTGVhdmUgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZUxlYXZlQ2hhcnQoKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZUxlYXZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlTGVhdmVdKTsKICB2YXIgbXlPbk1vdXNlTW92ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTW92ZUFjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZU1vdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VNb3ZlXSk7CiAgdmFyIG9uRm9jdXMgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGRpc3BhdGNoKGZvY3VzQWN0aW9uKCkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHZhciBvbktleURvd24gPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChrZXlEb3duQWN0aW9uKGUua2V5KSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdmFyIG15T25Db250ZXh0TWVudSA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkNvbnRleHRNZW51LAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkNvbnRleHRNZW51XSk7CiAgdmFyIG15T25Eb3VibGVDbGljayA9ICgwLCBpbXBvcnRfcmVhY3Q0OC51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkRvdWJsZUNsaWNrLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkRvdWJsZUNsaWNrXSk7CiAgdmFyIG15T25Nb3VzZURvd24gPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZURvd24sCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VEb3duXSk7CiAgdmFyIG15T25Nb3VzZVVwID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VVcCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZVVwXSk7CiAgdmFyIG15T25Ub3VjaFN0YXJ0ID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hTdGFydCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Ub3VjaFN0YXJ0XSk7CiAgdmFyIG15T25Ub3VjaE1vdmUgPSAoMCwgaW1wb3J0X3JlYWN0NDgudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBpZiAoZGlzcGF0Y2hUb3VjaEV2ZW50cykgewogICAgICBkaXNwYXRjaCh0b3VjaEV2ZW50QWN0aW9uKGUpKTsKICAgIH0KICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoTW92ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgZGlzcGF0Y2hUb3VjaEV2ZW50cywgb25Ub3VjaE1vdmVdKTsKICB2YXIgbXlPblRvdWNoRW5kID0gKDAsIGltcG9ydF9yZWFjdDQ4LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hFbmQsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uVG91Y2hFbmRdKTsKICB2YXIgV3JhcHBlckRpdiA9IGdldFdyYXBwZXJEaXZDb21wb25lbnQocmVzcG9uc2l2ZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoVG9vbHRpcFBvcnRhbENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiB0b29sdGlwUG9ydGFsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChMZWdlbmRQb3J0YWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogbGVnZW5kUG9ydGFsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChXcmFwcGVyRGl2LCB7CiAgICB3aWR0aDogd2lkdGggIT09IG51bGwgJiYgd2lkdGggIT09IHZvaWQgMCA/IHdpZHRoIDogc3R5bGUgPT09IG51bGwgfHwgc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN0eWxlLndpZHRoLAogICAgaGVpZ2h0OiBoZWlnaHQgIT09IG51bGwgJiYgaGVpZ2h0ICE9PSB2b2lkIDAgPyBoZWlnaHQgOiBzdHlsZSA9PT0gbnVsbCB8fCBzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3R5bGUuaGVpZ2h0LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy13cmFwcGVyIiwgY2xhc3NOYW1lKSwKICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkMzMoewogICAgICBwb3NpdGlvbjogInJlbGF0aXZlIiwKICAgICAgY3Vyc29yOiAiZGVmYXVsdCIsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0sIHN0eWxlKSwKICAgIG9uQ2xpY2s6IG15T25DbGljaywKICAgIG9uQ29udGV4dE1lbnU6IG15T25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2s6IG15T25Eb3VibGVDbGljaywKICAgIG9uRm9jdXMsCiAgICBvbktleURvd24sCiAgICBvbk1vdXNlRG93bjogbXlPbk1vdXNlRG93biwKICAgIG9uTW91c2VFbnRlcjogbXlPbk1vdXNlRW50ZXIsCiAgICBvbk1vdXNlTGVhdmU6IG15T25Nb3VzZUxlYXZlLAogICAgb25Nb3VzZU1vdmU6IG15T25Nb3VzZU1vdmUsCiAgICBvbk1vdXNlVXA6IG15T25Nb3VzZVVwLAogICAgb25Ub3VjaEVuZDogbXlPblRvdWNoRW5kLAogICAgb25Ub3VjaE1vdmU6IG15T25Ub3VjaE1vdmUsCiAgICBvblRvdWNoU3RhcnQ6IG15T25Ub3VjaFN0YXJ0LAogICAgcmVmOiBpbm5lclJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoRXZlbnRTeW5jaHJvbml6ZXIsIG51bGwpLCBjaGlsZHJlbikpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXRlZ29yaWNhbENoYXJ0LmpzCnZhciBfZXhjbHVkZWQxNyA9IFsid2lkdGgiLCAiaGVpZ2h0IiwgInJlc3BvbnNpdmUiLCAiY2hpbGRyZW4iLCAiY2xhc3NOYW1lIiwgInN0eWxlIiwgImNvbXBhY3QiLCAidGl0bGUiLCAiZGVzYyJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTcoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQ2F0ZWdvcmljYWxDaGFydCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDkuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZXNwb25zaXZlLAogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIGNvbXBhY3QsCiAgICB0aXRsZSwKICAgIGRlc2MKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE3KHByb3BzLCBfZXhjbHVkZWQxNyk7CiAgdmFyIGF0dHJzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycyk7CiAgaWYgKGNvbXBhY3QpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJlYWN0MzQuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJvb3RTdXJmYWNlLCB7CiAgICAgIG90aGVyQXR0cmlidXRlczogYXR0cnMsCiAgICAgIHRpdGxlLAogICAgICBkZXNjCiAgICB9LCBjaGlsZHJlbikpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1dyYXBwZXIsIHsKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZXNwb25zaXZlOiByZXNwb25zaXZlICE9PSBudWxsICYmIHJlc3BvbnNpdmUgIT09IHZvaWQgMCA/IHJlc3BvbnNpdmUgOiBmYWxzZSwKICAgIG9uQ2xpY2s6IHByb3BzLm9uQ2xpY2ssCiAgICBvbk1vdXNlTGVhdmU6IHByb3BzLm9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VFbnRlcjogcHJvcHMub25Nb3VzZUVudGVyLAogICAgb25Nb3VzZU1vdmU6IHByb3BzLm9uTW91c2VNb3ZlLAogICAgb25Nb3VzZURvd246IHByb3BzLm9uTW91c2VEb3duLAogICAgb25Nb3VzZVVwOiBwcm9wcy5vbk1vdXNlVXAsCiAgICBvbkNvbnRleHRNZW51OiBwcm9wcy5vbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljazogcHJvcHMub25Eb3VibGVDbGljaywKICAgIG9uVG91Y2hTdGFydDogcHJvcHMub25Ub3VjaFN0YXJ0LAogICAgb25Ub3VjaE1vdmU6IHByb3BzLm9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaEVuZDogcHJvcHMub25Ub3VjaEVuZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUm9vdFN1cmZhY2UsIHsKICAgIG90aGVyQXR0cmlidXRlczogYXR0cnMsCiAgICB0aXRsZSwKICAgIGRlc2MsCiAgICByZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KENsaXBQYXRoUHJvdmlkZXIsIG51bGwsIGNoaWxkcmVuKSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhcnRlc2lhbkNoYXJ0LmpzCmZ1bmN0aW9uIF9leHRlbmRzMjMoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIGRlZmF1bHRNYXJnaW4gPSB7CiAgdG9wOiA1LAogIHJpZ2h0OiA1LAogIGJvdHRvbTogNSwKICBsZWZ0OiA1Cn07CnZhciBkZWZhdWx0Q2FydGVzaWFuQ2hhcnRQcm9wcyA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICBtYXJnaW46IGRlZmF1bHRNYXJnaW4sCiAgcmVzcG9uc2l2ZTogZmFsc2UsCiAgcmV2ZXJzZVN0YWNrT3JkZXI6IGZhbHNlLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY01ldGhvZDogImluZGV4Igp9Owp2YXIgQ2FydGVzaWFuQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUwLmZvcndhcmRSZWYpKGZ1bmN0aW9uIENhcnRlc2lhbkNoYXJ0Mihwcm9wcywgcmVmKSB7CiAgdmFyIF9jYXRlZ29yaWNhbENoYXJ0UHJvcDsKICB2YXIgcm9vdENoYXJ0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLmNhdGVnb3JpY2FsQ2hhcnRQcm9wcywgZGVmYXVsdENhcnRlc2lhbkNoYXJ0UHJvcHMpOwogIHZhciB7CiAgICBjaGFydE5hbWUsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLAogICAgY2F0ZWdvcmljYWxDaGFydFByb3BzCiAgfSA9IHByb3BzOwogIHZhciBvcHRpb25zID0gewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwKICAgIGV2ZW50RW1pdHRlcjogdm9pZCAwCiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1N0b3JlUHJvdmlkZXIsIHsKICAgIHByZWxvYWRlZFN0YXRlOiB7CiAgICAgIG9wdGlvbnMKICAgIH0sCiAgICByZWR1eFN0b3JlTmFtZTogKF9jYXRlZ29yaWNhbENoYXJ0UHJvcCA9IGNhdGVnb3JpY2FsQ2hhcnRQcm9wcy5pZCkgIT09IG51bGwgJiYgX2NhdGVnb3JpY2FsQ2hhcnRQcm9wICE9PSB2b2lkIDAgPyBfY2F0ZWdvcmljYWxDaGFydFByb3AgOiBjaGFydE5hbWUKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KENoYXJ0RGF0YUNvbnRleHRQcm92aWRlciwgewogICAgY2hhcnREYXRhOiBjYXRlZ29yaWNhbENoYXJ0UHJvcHMuZGF0YQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KFJlcG9ydE1haW5DaGFydFByb3BzLCB7CiAgICBsYXlvdXQ6IHJvb3RDaGFydFByb3BzLmxheW91dCwKICAgIG1hcmdpbjogcm9vdENoYXJ0UHJvcHMubWFyZ2luCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM1LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRQcm9wcywgewogICAgYmFzZVZhbHVlOiByb290Q2hhcnRQcm9wcy5iYXNlVmFsdWUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHJvb3RDaGFydFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciwKICAgIGJhckNhdGVnb3J5R2FwOiByb290Q2hhcnRQcm9wcy5iYXJDYXRlZ29yeUdhcCwKICAgIG1heEJhclNpemU6IHJvb3RDaGFydFByb3BzLm1heEJhclNpemUsCiAgICBzdGFja09mZnNldDogcm9vdENoYXJ0UHJvcHMuc3RhY2tPZmZzZXQsCiAgICBiYXJHYXA6IHJvb3RDaGFydFByb3BzLmJhckdhcCwKICAgIGJhclNpemU6IHJvb3RDaGFydFByb3BzLmJhclNpemUsCiAgICBzeW5jSWQ6IHJvb3RDaGFydFByb3BzLnN5bmNJZCwKICAgIHN5bmNNZXRob2Q6IHJvb3RDaGFydFByb3BzLnN5bmNNZXRob2QsCiAgICBjbGFzc05hbWU6IHJvb3RDaGFydFByb3BzLmNsYXNzTmFtZSwKICAgIHJldmVyc2VTdGFja09yZGVyOiByb290Q2hhcnRQcm9wcy5yZXZlcnNlU3RhY2tPcmRlcgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KENhdGVnb3JpY2FsQ2hhcnQsIF9leHRlbmRzMjMoe30sIHJvb3RDaGFydFByb3BzLCB7CiAgICByZWYKICB9KSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0FyZWFDaGFydC5qcwp2YXIgUmVhY3QzNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDUxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgYWxsb3dlZFRvb2x0aXBUeXBlcyA9IFsiYXhpcyJdOwp2YXIgQXJlYUNoYXJ0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1MS5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNi5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkNoYXJ0LCB7CiAgICBjaGFydE5hbWU6ICJBcmVhQ2hhcnQiLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU6ICJheGlzIiwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXM6IGFsbG93ZWRUb29sdGlwVHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyOiBhcnJheVRvb2x0aXBTZWFyY2hlciwKICAgIGNhdGVnb3JpY2FsQ2hhcnRQcm9wczogcHJvcHMsCiAgICByZWYKICB9KTsKfSk7CgovLyBzcmMvY29tcG9uZW50LnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgQ09MT1JTID0gewogIHByaW1hcnk6ICIjNTZDNTk2IiwKICAvLyBNaW50IEdyZWVuCiAgcHJpbWFyeURhcms6ICIjM2FhODdiIiwKICBiZzogIiNGQUZBRkEiLAogIGNhcmQ6ICIjRkZGRkZGIiwKICB0ZXh0TWFpbjogIiMxQTFBMUEiLAogIHRleHRTZWNvbmRhcnk6ICIjOUNBM0FGIiwKICBib3JkZXI6ICIjRjNGNEY2IiwKICBpbnB1dEJnOiAiI0Y5RkFGQiIsCiAgYWNjZW50TGlnaHQ6ICIjRTZGN0YwIiwKICBibHVlOiAiIzVEOUNFQyIsCiAgeWVsbG93OiAiI0Y1OUUwQiIsCiAgcmVkOiAiI0ZGNkI2QiIsCiAgb3JhbmdlOiAiI0YyOTk0QSIsCiAgb3JhbmdlTGlnaHQ6ICIjRkZGN0VEIiwKICBzYXZlR3JlZW46ICIjNEQ3QzBGIiwKICB0YWJsZUhlYWRlcjogIiMyNTYzRUIiCn07CnZhciBOdW1iZXJDb250cm9sID0gKHsKICB2YWx1ZSwKICBvbkNoYW5nZSwKICBtaW46IG1pbjIgPSAwLAogIG1heDogbWF4MiA9IDFlNywKICBzdGVwID0gMSwKICBsYWJlbCwKICBzdWZmaXg6IHN1ZmZpeDIsCiAgcHJlZml4Cn0pID0+IHsKICBjb25zdCBoYW5kbGVEZWMgPSAoKSA9PiB7CiAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbHVlKSB8fCAwOwogICAgaWYgKG51bSAtIHN0ZXAgPj0gbWluMikgb25DaGFuZ2UoTWF0aC5yb3VuZCgobnVtIC0gc3RlcCkgKiAxMDApIC8gMTAwICsgIiIpOwogIH07CiAgY29uc3QgaGFuZGxlSW5jID0gKCkgPT4gewogICAgY29uc3QgbnVtID0gcGFyc2VGbG9hdCh2YWx1ZSkgfHwgMDsKICAgIGlmIChudW0gKyBzdGVwIDw9IG1heDIpIG9uQ2hhbmdlKE1hdGgucm91bmQoKG51bSArIHN0ZXApICogMTAwKSAvIDEwMCArICIiKTsKICB9OwogIGNvbnN0IGhhbmRsZUNoYW5nZSA9IChlKSA9PiB7CiAgICBjb25zdCByYXcgPSBlLnRhcmdldC52YWx1ZS5yZXBsYWNlKC8sL2csICIiKTsKICAgIGNvbnN0IHZhbCA9IHJhdy5yZXBsYWNlKC9bXjAtOS5dL2csICIiKTsKICAgIG9uQ2hhbmdlKHZhbCk7CiAgfTsKICBjb25zdCBidG5TdHlsZSA9IHsKICAgIHdpZHRoOiAiMzJweCIsCiAgICBoZWlnaHQ6ICIzMnB4IiwKICAgIGJvcmRlclJhZGl1czogIjhweCIsCiAgICBib3JkZXI6ICJub25lIiwKICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICBib3hTaGFkb3c6ICIwIDJweCA0cHggcmdiYSgwLDAsMCwwLjA1KSIKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgIGJvcmRlclJhZGl1czogIjEycHgiLAogICAgcGFkZGluZzogIjZweCIsCiAgICBkaXNwbGF5OiAiZmxleCIsCiAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsCiAgICBnYXA6ICI4cHgiLAogICAgaGVpZ2h0OiAiNDRweCIKICB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVEZWMsIHN0eWxlOiBidG5TdHlsZSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWludXMsIHsgc2l6ZTogMTYsIHN0cm9rZVdpZHRoOiAzIH0pIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgdGV4dEFsaWduOiAiY2VudGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBnYXA6ICI0cHgiIH0sIGNoaWxkcmVuOiBbCiAgICAgIHByZWZpeCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE2cHgiLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IHByZWZpeCB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAiaW5wdXQiLAogICAgICAgIHsKICAgICAgICAgIHR5cGU6ICJ0ZXh0IiwKICAgICAgICAgIHZhbHVlOiB2YWx1ZSA/IE51bWJlcih2YWx1ZSkudG9Mb2NhbGVTdHJpbmcoKSA6ICIiLAogICAgICAgICAgb25DaGFuZ2U6IGhhbmRsZUNoYW5nZSwKICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICBiYWNrZ3JvdW5kOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiLAogICAgICAgICAgICBmb250U2l6ZTogIjE2cHgiLAogICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sCiAgICAgICAgICAgIG91dGxpbmU6ICJub25lIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgKSwKICAgICAgc3VmZml4MiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjE0cHgiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRXZWlnaHQ6IDUwMCB9LCBjaGlsZHJlbjogc3VmZml4MiB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogaGFuZGxlSW5jLCBzdHlsZTogYnRuU3R5bGUsIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFBsdXMsIHsgc2l6ZTogMTYsIHN0cm9rZVdpZHRoOiAzIH0pIH0pCiAgXSB9KTsKfTsKdmFyIERFRkFVTFRfVkFMVUVTID0gewogIGN1cnJlbnRBZ2U6ICIzNSIsCiAgaW5jb21lOiAiNjAwMDAiLAogIHNhdmluZ3M6ICIzMDAwMCIsCiAgY29udHJpYnV0aW9uczogIjUwMCIsCiAgYnVkZ2V0OiAiMjU2MSIsCiAgb3RoZXJJbmNvbWU6ICIwIiwKICByZXRpcmVtZW50QWdlOiAiNjciLAogIGxpZmVFeHBlY3RhbmN5OiAiOTUiLAogIHByZVJldGlyZVJhdGU6ICI2IiwKICBwb3N0UmV0aXJlUmF0ZTogIjUiLAogIGluZmxhdGlvbjogIjMiLAogIGluY29tZUluY3JlYXNlOiAiMiIsCiAgY29udHJpYnV0aW9uTW9kZTogIiQiLAogIGJ1ZGdldE1vZGU6ICIkIgp9Owp2YXIgU1RPUkFHRV9LRVkgPSAiUkVUSVJFTUVOVF9DQUxDVUxBVE9SX0RBVEEiOwp2YXIgRVhQSVJBVElPTl9EQVlTID0gMzA7CnZhciBsb2FkU2F2ZWREYXRhID0gKCkgPT4gewogIHRyeSB7CiAgICBjb25zdCBzYXZlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUT1JBR0VfS0VZKTsKICAgIGlmIChzYXZlZCkgewogICAgICBjb25zdCB7IGRhdGEsIHRpbWVzdGFtcCB9ID0gSlNPTi5wYXJzZShzYXZlZCk7CiAgICAgIGNvbnN0IG5vdyA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICBjb25zdCBkYXlzRGlmZiA9IChub3cgLSB0aW1lc3RhbXApIC8gKDFlMyAqIDYwICogNjAgKiAyNCk7CiAgICAgIGlmIChkYXlzRGlmZiA8IEVYUElSQVRJT05fREFZUykgewogICAgICAgIGNvbnN0IG1lcmdlZCA9IHsKICAgICAgICAgICJSZXRpcmVtZW50IENhbGN1bGF0b3IiOiB7IHZhbHVlczogeyAuLi5ERUZBVUxUX1ZBTFVFUyB9LCB0b3VjaGVkOiB7fSwgcmVzdWx0OiBudWxsIH0KICAgICAgICB9OwogICAgICAgIGlmIChkYXRhWyJSZXRpcmVtZW50IENhbGN1bGF0b3IiXSkgewogICAgICAgICAgbWVyZ2VkWyJSZXRpcmVtZW50IENhbGN1bGF0b3IiXSA9IHsKICAgICAgICAgICAgLi4ubWVyZ2VkWyJSZXRpcmVtZW50IENhbGN1bGF0b3IiXSwKICAgICAgICAgICAgLi4uZGF0YVsiUmV0aXJlbWVudCBDYWxjdWxhdG9yIl0sCiAgICAgICAgICAgIHZhbHVlczogeyAuLi5tZXJnZWRbIlJldGlyZW1lbnQgQ2FsY3VsYXRvciJdLnZhbHVlcywgLi4uZGF0YVsiUmV0aXJlbWVudCBDYWxjdWxhdG9yIl0udmFsdWVzIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgIH0KICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gbG9hZCBzYXZlZCBkYXRhIiwgZSk7CiAgfQogIHJldHVybiB7CiAgICAiUmV0aXJlbWVudCBDYWxjdWxhdG9yIjogeyB2YWx1ZXM6IHsgLi4uREVGQVVMVF9WQUxVRVMgfSwgdG91Y2hlZDoge30sIHJlc3VsdDogbnVsbCB9CiAgfTsKfTsKZnVuY3Rpb24gUmV0aXJlbWVudENhbGN1bGF0b3JIZWxsb1dvcmxkKHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KSB7CiAgY29uc3QgW2NhbGN1bGF0b3JUeXBlLCBzZXRDYWxjdWxhdG9yVHlwZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCJSZXRpcmVtZW50IENhbGN1bGF0b3IiKTsKICBjb25zdCBbaXNBbmFseXppbmcsIHNldElzQW5hbHl6aW5nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtjYWxjdWxhdG9ycywgc2V0Q2FsY3VsYXRvcnNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgoKSA9PiB7CiAgICBjb25zdCBsb2FkZWQgPSBsb2FkU2F2ZWREYXRhKCk7CiAgICBpZiAoaW5pdGlhbERhdGEyICYmIChpbml0aWFsRGF0YTIuY3VycmVudF9hZ2UgfHwgaW5pdGlhbERhdGEyLmFubnVhbF9wcmVfdGF4X2luY29tZSkpIHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBjdXJyZW50MyA9IGxvYWRlZFsiUmV0aXJlbWVudCBDYWxjdWxhdG9yIl07CiAgICAgICAgbG9hZGVkWyJSZXRpcmVtZW50IENhbGN1bGF0b3IiXSA9IHsKICAgICAgICAgIC4uLmN1cnJlbnQzLAogICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgIC4uLmN1cnJlbnQzLnZhbHVlcywKICAgICAgICAgICAgY3VycmVudEFnZTogaW5pdGlhbERhdGEyLmN1cnJlbnRfYWdlID8gU3RyaW5nKGluaXRpYWxEYXRhMi5jdXJyZW50X2FnZSkgOiBjdXJyZW50My52YWx1ZXMuY3VycmVudEFnZSwKICAgICAgICAgICAgaW5jb21lOiBpbml0aWFsRGF0YTIuYW5udWFsX3ByZV90YXhfaW5jb21lID8gU3RyaW5nKGluaXRpYWxEYXRhMi5hbm51YWxfcHJlX3RheF9pbmNvbWUpIDogY3VycmVudDMudmFsdWVzLmluY29tZSwKICAgICAgICAgICAgc2F2aW5nczogaW5pdGlhbERhdGEyLmN1cnJlbnRfcmV0aXJlbWVudF9zYXZpbmdzID8gU3RyaW5nKGluaXRpYWxEYXRhMi5jdXJyZW50X3JldGlyZW1lbnRfc2F2aW5ncykgOiBjdXJyZW50My52YWx1ZXMuc2F2aW5ncywKICAgICAgICAgICAgY29udHJpYnV0aW9uczogaW5pdGlhbERhdGEyLm1vbnRobHlfY29udHJpYnV0aW9ucyA/IFN0cmluZyhpbml0aWFsRGF0YTIubW9udGhseV9jb250cmlidXRpb25zKSA6IGN1cnJlbnQzLnZhbHVlcy5jb250cmlidXRpb25zLAogICAgICAgICAgICBidWRnZXQ6IGluaXRpYWxEYXRhMi5tb250aGx5X2J1ZGdldF9pbl9yZXRpcmVtZW50ID8gU3RyaW5nKGluaXRpYWxEYXRhMi5tb250aGx5X2J1ZGdldF9pbl9yZXRpcmVtZW50KSA6IGN1cnJlbnQzLnZhbHVlcy5idWRnZXQsCiAgICAgICAgICAgIG90aGVySW5jb21lOiBpbml0aWFsRGF0YTIub3RoZXJfcmV0aXJlbWVudF9pbmNvbWUgPyBTdHJpbmcoaW5pdGlhbERhdGEyLm90aGVyX3JldGlyZW1lbnRfaW5jb21lKSA6IGN1cnJlbnQzLnZhbHVlcy5vdGhlckluY29tZSwKICAgICAgICAgICAgcmV0aXJlbWVudEFnZTogaW5pdGlhbERhdGEyLnJldGlyZW1lbnRfYWdlID8gU3RyaW5nKGluaXRpYWxEYXRhMi5yZXRpcmVtZW50X2FnZSkgOiBjdXJyZW50My52YWx1ZXMucmV0aXJlbWVudEFnZSwKICAgICAgICAgICAgbGlmZUV4cGVjdGFuY3k6IGluaXRpYWxEYXRhMi5saWZlX2V4cGVjdGFuY3kgPyBTdHJpbmcoaW5pdGlhbERhdGEyLmxpZmVfZXhwZWN0YW5jeSkgOiBjdXJyZW50My52YWx1ZXMubGlmZUV4cGVjdGFuY3ksCiAgICAgICAgICAgIHByZVJldGlyZVJhdGU6IGluaXRpYWxEYXRhMi5wcmVfcmV0aXJlbWVudF9yYXRlX29mX3JldHVybiA/IFN0cmluZyhpbml0aWFsRGF0YTIucHJlX3JldGlyZW1lbnRfcmF0ZV9vZl9yZXR1cm4pIDogY3VycmVudDMudmFsdWVzLnByZVJldGlyZVJhdGUsCiAgICAgICAgICAgIHBvc3RSZXRpcmVSYXRlOiBpbml0aWFsRGF0YTIucG9zdF9yZXRpcmVtZW50X3JhdGVfb2ZfcmV0dXJuID8gU3RyaW5nKGluaXRpYWxEYXRhMi5wb3N0X3JldGlyZW1lbnRfcmF0ZV9vZl9yZXR1cm4pIDogY3VycmVudDMudmFsdWVzLnBvc3RSZXRpcmVSYXRlLAogICAgICAgICAgICBpbmZsYXRpb246IGluaXRpYWxEYXRhMi5pbmZsYXRpb25fcmF0ZSA/IFN0cmluZyhpbml0aWFsRGF0YTIuaW5mbGF0aW9uX3JhdGUpIDogY3VycmVudDMudmFsdWVzLmluZmxhdGlvbiwKICAgICAgICAgICAgaW5jb21lSW5jcmVhc2U6IGluaXRpYWxEYXRhMi5hbm51YWxfaW5jb21lX2luY3JlYXNlID8gU3RyaW5nKGluaXRpYWxEYXRhMi5hbm51YWxfaW5jb21lX2luY3JlYXNlKSA6IGN1cnJlbnQzLnZhbHVlcy5pbmNvbWVJbmNyZWFzZQogICAgICAgICAgfSwKICAgICAgICAgIHRvdWNoZWQ6IHt9CiAgICAgICAgICAvLyBSZXNldCB0b3VjaGVkIG9uIGZyZXNoIGxvYWQKICAgICAgICB9OwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGFwcGx5IGluaXRpYWxEYXRhOiIsIGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbG9hZGVkOwogIH0pOwogIGNvbnN0IFtzaG93U3Vic2NyaWJlTW9kYWwsIHNldFNob3dTdWJzY3JpYmVNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZW1haWwsIHNldEVtYWlsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFt0dXJuc3RpbGVUb2tlbiwgc2V0VHVybnN0aWxlVG9rZW5dID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBbc3Vic2NyaWJlU3RhdHVzLCBzZXRTdWJzY3JpYmVTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiaWRsZSIpOwogIGNvbnN0IFtzdWJzY3JpYmVNZXNzYWdlLCBzZXRTdWJzY3JpYmVNZXNzYWdlXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzaG93RmVlZGJhY2tNb2RhbCwgc2V0U2hvd0ZlZWRiYWNrTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2ZlZWRiYWNrVGV4dCwgc2V0RmVlZGJhY2tUZXh0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtmZWVkYmFja1N0YXR1cywgc2V0RmVlZGJhY2tTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiaWRsZSIpOwogICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChzaG93U3Vic2NyaWJlTW9kYWwgJiYgd2luZG93LnR1cm5zdGlsZSkgewogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgd2luZG93LnR1cm5zdGlsZS5yZW5kZXIoIiN0dXJuc3RpbGUtd2lkZ2V0IiwgewogICAgICAgICAgICBzaXRla2V5OiB3aW5kb3cuVFVSTlNUSUxFX1NJVEVfS0VZLAogICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgICAgICBzZXRUdXJuc3RpbGVUb2tlbih0b2tlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgIH0sIDEwMCk7CiAgICB9CiAgfSwgW3Nob3dTdWJzY3JpYmVNb2RhbF0pOwogIGNvbnN0IGhhbmRsZVN1YnNjcmliZSA9IGFzeW5jICgpID0+IHsKICAgIGlmICghZW1haWwgfHwgIWVtYWlsLmluY2x1ZGVzKCJAIikpIHsKICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiUGxlYXNlIGVudGVyIGEgdmFsaWQgZW1haWwuIik7CiAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0dXJuc3RpbGVUb2tlbikgewogICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCJQbGVhc2UgY29tcGxldGUgdGhlIHNlY3VyaXR5IGNoZWNrLiIpOwogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldFN1YnNjcmliZVN0YXR1cygibG9hZGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgiL2FwaS9zdWJzY3JpYmUiLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZW1haWwsCiAgICAgICAgICBzZXR0bGVtZW50SWQ6ICJyZXRpcmVtZW50LW5ld3MiLAogICAgICAgICAgc2V0dGxlbWVudE5hbWU6ICJSZXRpcmVtZW50IENhbGN1bGF0b3IgTmV3cyIsCiAgICAgICAgICB0dXJuc3RpbGVUb2tlbgogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBpZiAocmVzcG9uc2Uub2sgJiYgZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLm1lc3NhZ2UpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEVtYWlsKCIiKTsKICAgICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiaWRsZSIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiIik7CiAgICAgICAgICBzZXRUdXJuc3RpbGVUb2tlbihudWxsKTsKICAgICAgICB9LCAzZTMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKGRhdGEuZXJyb3IgfHwgIkZhaWxlZCB0byBzdWJzY3JpYmUuIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCJOZXR3b3JrIGVycm9yLiBQbGVhc2UgdHJ5IGFnYWluLiIpOwogICAgfQogIH07CiAgY29uc3QgaGFuZGxlRmVlZGJhY2tTdWJtaXQgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIWZlZWRiYWNrVGV4dC50cmltKCkpIHJldHVybjsKICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWJtaXR0aW5nIik7CiAgICB0cnkgewogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCIvYXBpL3RyYWNrIiwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGV2ZW50OiAidXNlcl9mZWVkYmFjayIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGZlZWRiYWNrOiBmZWVkYmFja1RleHQsCiAgICAgICAgICAgIGNhbGN1bGF0b3JUeXBlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIGlmIChyZXNwb25zZS5vaykgewogICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSk7CiAgICAgICAgICBzZXRGZWVkYmFja1RleHQoIiIpOwogICAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgICB9LCAyZTMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJlcnJvciIpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJlcnJvciIpOwogICAgfQogIH07CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3QgZGF0YVRvU2F2ZSA9IHsKICAgICAgZGF0YTogY2FsY3VsYXRvcnMsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCkKICAgIH07CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTVE9SQUdFX0tFWSwgSlNPTi5zdHJpbmdpZnkoZGF0YVRvU2F2ZSkpOwogIH0sIFtjYWxjdWxhdG9yc10pOwogIGNvbnN0IGN1cnJlbnRDYWxjID0gY2FsY3VsYXRvcnNbY2FsY3VsYXRvclR5cGVdOwogIGNvbnN0IHsKICAgIGN1cnJlbnRBZ2UsCiAgICBpbmNvbWUsCiAgICBzYXZpbmdzLAogICAgY29udHJpYnV0aW9ucywKICAgIGJ1ZGdldCwKICAgIG90aGVySW5jb21lLAogICAgcmV0aXJlbWVudEFnZSwKICAgIGxpZmVFeHBlY3RhbmN5LAogICAgcHJlUmV0aXJlUmF0ZSwKICAgIHBvc3RSZXRpcmVSYXRlLAogICAgaW5mbGF0aW9uLAogICAgaW5jb21lSW5jcmVhc2UsCiAgICBjb250cmlidXRpb25Nb2RlLAogICAgYnVkZ2V0TW9kZQogIH0gPSBjdXJyZW50Q2FsYy52YWx1ZXM7CiAgY29uc3QgdXBkYXRlVmFsID0gKGZpZWxkLCB2YWx1ZSkgPT4gewogICAgc2V0Q2FsY3VsYXRvcnMoKHByZXYpID0+IHsKICAgICAgY29uc3QgbmV4dCA9IHsgLi4ucHJldiB9OwogICAgICBuZXh0W2NhbGN1bGF0b3JUeXBlXSA9IHsKICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXSwKICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgIC4uLm5leHRbY2FsY3VsYXRvclR5cGVdLnZhbHVlcywKICAgICAgICAgIFtmaWVsZF06IHZhbHVlCiAgICAgICAgfSwKICAgICAgICB0b3VjaGVkOiB7CiAgICAgICAgICAuLi5uZXh0W2NhbGN1bGF0b3JUeXBlXS50b3VjaGVkLAogICAgICAgICAgW2ZpZWxkXTogdHJ1ZQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIG5leHQ7CiAgICB9KTsKICB9OwogIGNvbnN0IHVwZGF0ZVJlc3VsdCA9IChyZXN1bHQpID0+IHsKICAgIHNldENhbGN1bGF0b3JzKChwcmV2KSA9PiAoewogICAgICAuLi5wcmV2LAogICAgICBbY2FsY3VsYXRvclR5cGVdOiB7CiAgICAgICAgLi4ucHJldltjYWxjdWxhdG9yVHlwZV0sCiAgICAgICAgcmVzdWx0CiAgICAgIH0KICAgIH0pKTsKICB9OwogIGNvbnN0IGNhbGN1bGF0ZVJldGlyZW1lbnQgPSAoKSA9PiB7CiAgICBjb25zdCBjdXJyZW50QWdlTnVtID0gcGFyc2VGbG9hdChjdXJyZW50QWdlKTsKICAgIGNvbnN0IHJldGlyZW1lbnRBZ2VOdW0gPSBwYXJzZUZsb2F0KHJldGlyZW1lbnRBZ2UpOwogICAgY29uc3QgbGlmZUV4cGVjdGFuY3lOdW0gPSBwYXJzZUZsb2F0KGxpZmVFeHBlY3RhbmN5KTsKICAgIGNvbnN0IGluY29tZU51bSA9IHBhcnNlRmxvYXQoaW5jb21lKTsKICAgIGxldCBzYXZpbmdzTnVtID0gcGFyc2VGbG9hdChzYXZpbmdzKTsKICAgIGlmIChpc05hTihjdXJyZW50QWdlTnVtKSB8fCBpc05hTihyZXRpcmVtZW50QWdlTnVtKSB8fCBpc05hTihpbmNvbWVOdW0pIHx8IGlzTmFOKHNhdmluZ3NOdW0pKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHByZVJhdGUgPSBwYXJzZUZsb2F0KHByZVJldGlyZVJhdGUpIC8gMTAwOwogICAgY29uc3QgcG9zdFJhdGUgPSBwYXJzZUZsb2F0KHBvc3RSZXRpcmVSYXRlKSAvIDEwMDsKICAgIGNvbnN0IGluZmwgPSBwYXJzZUZsb2F0KGluZmxhdGlvbikgLyAxMDA7CiAgICBjb25zdCBpbmNJbmNyZWFzZSA9IHBhcnNlRmxvYXQoaW5jb21lSW5jcmVhc2UpIC8gMTAwOwogICAgY29uc3QgeWVhcnNQcmUgPSByZXRpcmVtZW50QWdlTnVtIC0gY3VycmVudEFnZU51bTsKICAgIGNvbnN0IHllYXJzUG9zdCA9IGxpZmVFeHBlY3RhbmN5TnVtIC0gcmV0aXJlbWVudEFnZU51bTsKICAgIGNvbnN0IG1vbnRobHlTaG9ydGZhbGxUb2RheSA9IE1hdGgubWF4KDAsIHBhcnNlRmxvYXQoYnVkZ2V0KSAtIHBhcnNlRmxvYXQob3RoZXJJbmNvbWUpKTsKICAgIGNvbnN0IGFubnVhbFNob3J0ZmFsbFRvZGF5ID0gbW9udGhseVNob3J0ZmFsbFRvZGF5ICogMTI7CiAgICBjb25zdCBhbm51YWxTaG9ydGZhbGxBdFJldGlyZSA9IGFubnVhbFNob3J0ZmFsbFRvZGF5ICogTWF0aC5wb3coMSArIGluZmwsIHllYXJzUHJlKTsKICAgIGxldCBuZWVkZWRBdFJldGlyZW1lbnQgPSAwOwogICAgbGV0IGJhbGFuY2UgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB5ZWFyc1Bvc3Q7IGkrKykgewogICAgICBjb25zdCBwYXlvdXQgPSBhbm51YWxTaG9ydGZhbGxBdFJldGlyZSAqIE1hdGgucG93KDEgKyBpbmZsLCB5ZWFyc1Bvc3QgLSAxIC0gaSk7CiAgICAgIGJhbGFuY2UgPSAoYmFsYW5jZSArIHBheW91dCkgLyAoMSArIHBvc3RSYXRlKTsKICAgIH0KICAgIG5lZWRlZEF0UmV0aXJlbWVudCA9IGJhbGFuY2U7CiAgICBjb25zdCBmdlNhdmluZ3MgPSBzYXZpbmdzTnVtICogTWF0aC5wb3coMSArIHByZVJhdGUsIHllYXJzUHJlKTsKICAgIGNvbnN0IGdhcCA9IG5lZWRlZEF0UmV0aXJlbWVudCAtIGZ2U2F2aW5nczsKICAgIGxldCBpbml0aWFsQW5udWFsQ29udHJpYk5lZWRlZCA9IDA7CiAgICBsZXQgYWNjdW1GYWN0b3IgPSAwOwogICAgZm9yIChsZXQgayA9IDA7IGsgPCB5ZWFyc1ByZTsgaysrKSB7CiAgICAgIGFjY3VtRmFjdG9yICs9IE1hdGgucG93KDEgKyBpbmNJbmNyZWFzZSwgaykgKiBNYXRoLnBvdygxICsgcHJlUmF0ZSwgeWVhcnNQcmUgLSAxIC0gayk7CiAgICB9CiAgICBpZiAoYWNjdW1GYWN0b3IgPiAwKSB7CiAgICAgIGluaXRpYWxBbm51YWxDb250cmliTmVlZGVkID0gZ2FwIC8gYWNjdW1GYWN0b3I7CiAgICB9CiAgICBjb25zdCBncmFwaERhdGEgPSBbXTsKICAgIGxldCBzaW1DdXJyZW50ID0gc2F2aW5nc051bTsKICAgIGxldCBzaW1JZGVhbCA9IHNhdmluZ3NOdW07CiAgICBsZXQgc2ltU2FsYXJ5ID0gaW5jb21lTnVtOwogICAgbGV0IHNpbUN1cnJlbnRDb250cmliID0gcGFyc2VGbG9hdChjb250cmlidXRpb25zKTsKICAgIGlmIChjb250cmlidXRpb25Nb2RlID09PSAiJSIpIHNpbUN1cnJlbnRDb250cmliID0gc2ltU2FsYXJ5IC8gMTIgKiAoc2ltQ3VycmVudENvbnRyaWIgLyAxMDApOwogICAgc2ltQ3VycmVudENvbnRyaWIgKj0gMTI7CiAgICBsZXQgc2ltSWRlYWxDb250cmliID0gTWF0aC5tYXgoMCwgaW5pdGlhbEFubnVhbENvbnRyaWJOZWVkZWQpOwogICAgbGV0IHJ1bk91dEFnZUN1cnJlbnQgPSBudWxsOwogICAgbGV0IHJ1bk91dEFnZUlkZWFsID0gbnVsbDsKICAgIGNvbnN0IHRvdGFsWWVhcnMgPSBsaWZlRXhwZWN0YW5jeU51bSAtIGN1cnJlbnRBZ2VOdW07CiAgICBmb3IgKGxldCB5ciA9IDA7IHlyIDw9IHRvdGFsWWVhcnM7IHlyKyspIHsKICAgICAgY29uc3QgYWdlID0gY3VycmVudEFnZU51bSArIHlyOwogICAgICBjb25zdCBpc1JldGlyZWQgPSBhZ2UgPj0gcmV0aXJlbWVudEFnZU51bTsKICAgICAgZ3JhcGhEYXRhLnB1c2goewogICAgICAgIGFnZSwKICAgICAgICBjdXJyZW50OiBNYXRoLnJvdW5kKHNpbUN1cnJlbnQpLAogICAgICAgIHJlY29tbWVuZGVkOiBNYXRoLnJvdW5kKHNpbUlkZWFsKQogICAgICB9KTsKICAgICAgaWYgKGlzUmV0aXJlZCkgewogICAgICAgIGNvbnN0IHBheW91dCA9IGFubnVhbFNob3J0ZmFsbEF0UmV0aXJlICogTWF0aC5wb3coMSArIGluZmwsIGFnZSAtIHJldGlyZW1lbnRBZ2VOdW0pOwogICAgICAgIGlmIChzaW1DdXJyZW50ID4gMCkgewogICAgICAgICAgc2ltQ3VycmVudCA9IHNpbUN1cnJlbnQgKiAoMSArIHBvc3RSYXRlKSAtIHBheW91dDsKICAgICAgICAgIGlmIChzaW1DdXJyZW50IDwgMCkgewogICAgICAgICAgICBzaW1DdXJyZW50ID0gMDsKICAgICAgICAgICAgcnVuT3V0QWdlQ3VycmVudCA9IGFnZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNpbUlkZWFsID4gMCkgewogICAgICAgICAgc2ltSWRlYWwgPSBzaW1JZGVhbCAqICgxICsgcG9zdFJhdGUpIC0gcGF5b3V0OwogICAgICAgICAgaWYgKHNpbUlkZWFsIDwgMCkgewogICAgICAgICAgICBzaW1JZGVhbCA9IDA7CiAgICAgICAgICAgIHJ1bk91dEFnZUlkZWFsID0gYWdlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzaW1DdXJyZW50ID0gc2ltQ3VycmVudCAqICgxICsgcHJlUmF0ZSkgKyBzaW1DdXJyZW50Q29udHJpYjsKICAgICAgICBzaW1JZGVhbCA9IHNpbUlkZWFsICogKDEgKyBwcmVSYXRlKSArIHNpbUlkZWFsQ29udHJpYjsKICAgICAgICBzaW1TYWxhcnkgKj0gMSArIGluY0luY3JlYXNlOwogICAgICAgIGlmIChjb250cmlidXRpb25Nb2RlID09PSAiJSIpIHsKICAgICAgICAgIHNpbUN1cnJlbnRDb250cmliID0gc2ltU2FsYXJ5ICogKHBhcnNlRmxvYXQoY29udHJpYnV0aW9ucykgLyAxMDApOwogICAgICAgIH0KICAgICAgICBzaW1JZGVhbENvbnRyaWIgKj0gMSArIGluY0luY3JlYXNlOwogICAgICB9CiAgICB9CiAgICBjb25zdCB3aGF0WW91SGF2ZSA9IGdyYXBoRGF0YS5maW5kKChkKSA9PiBkLmFnZSA9PT0gcmV0aXJlbWVudEFnZU51bSk/LmN1cnJlbnQgfHwgMDsKICAgIGNvbnN0IHdoYXRZb3VOZWVkID0gbmVlZGVkQXRSZXRpcmVtZW50OwogICAgdXBkYXRlUmVzdWx0KHsKICAgICAgaGF2ZTogTWF0aC5yb3VuZCh3aGF0WW91SGF2ZSksCiAgICAgIG5lZWQ6IE1hdGgucm91bmQod2hhdFlvdU5lZWQpLAogICAgICBncmFwaERhdGEsCiAgICAgIHJ1bk91dEFnZUN1cnJlbnQ6IHJ1bk91dEFnZUN1cnJlbnQgfHwgbGlmZUV4cGVjdGFuY3lOdW0sCiAgICAgIHJ1bk91dEFnZUlkZWFsOiBydW5PdXRBZ2VJZGVhbCB8fCBsaWZlRXhwZWN0YW5jeU51bSwKICAgICAgbW9udGhseUNvbnRyaWJOZWVkZWQ6IE1hdGgucm91bmQoaW5pdGlhbEFubnVhbENvbnRyaWJOZWVkZWQgLyAxMiksCiAgICAgIGN1cnJlbnRNb250aGx5Q29udHJpYjogTWF0aC5yb3VuZChzaW1DdXJyZW50Q29udHJpYiAvIDEyKQogICAgfSk7CiAgfTsKICBjb25zdCBjYWxjdWxhdGUyID0gKCkgPT4gewogICAgY2FsY3VsYXRlUmV0aXJlbWVudCgpOwogIH07CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY2FsY3VsYXRlMigpOwogIH0sIFtjdXJyZW50Q2FsYy52YWx1ZXNdKTsKICBjb25zdCBbc2hvd0FkdmFuY2VkLCBzZXRTaG93QWR2YW5jZWRdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3Jlc3VsdFZpZXcsIHNldFJlc3VsdFZpZXddID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiZ3JhcGgiKTsKICBjb25zdCB0b2dnbGVNb2RlID0gKGZpZWxkKSA9PiB7CiAgICBjb25zdCBjdXJyZW50MyA9IGN1cnJlbnRDYWxjLnZhbHVlc1tmaWVsZF07CiAgICB1cGRhdGVWYWwoZmllbGQsIGN1cnJlbnQzID09PSAiJCIgPyAiJSIgOiAiJCIpOwogIH07CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3QgaW5jb21lTnVtID0gcGFyc2VGbG9hdChpbmNvbWUpOwogICAgaWYgKCFpc05hTihpbmNvbWVOdW0pICYmICFjdXJyZW50Q2FsYy50b3VjaGVkLmJ1ZGdldCkgewogICAgICBjb25zdCBzdWdnZXN0ZWRBbm51YWxCdWRnZXQgPSBpbmNvbWVOdW0gKiAwLjc1OwogICAgICBjb25zdCBzdWdnZXN0ZWRNb250aGx5QnVkZ2V0ID0gTWF0aC5yb3VuZChzdWdnZXN0ZWRBbm51YWxCdWRnZXQgLyAxMik7CiAgICAgIHNldENhbGN1bGF0b3JzKChwcmV2KSA9PiB7CiAgICAgICAgY29uc3QgbmV4dCA9IHsgLi4ucHJldiB9OwogICAgICAgIG5leHRbY2FsY3VsYXRvclR5cGVdID0gewogICAgICAgICAgLi4ubmV4dFtjYWxjdWxhdG9yVHlwZV0sCiAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgLi4ubmV4dFtjYWxjdWxhdG9yVHlwZV0udmFsdWVzLAogICAgICAgICAgICBidWRnZXQ6IFN0cmluZyhzdWdnZXN0ZWRNb250aGx5QnVkZ2V0KQogICAgICAgICAgfQogICAgICAgICAgLy8gRG8gTk9UIG1hcmsgYXMgdG91Y2hlZCBzbyBpdCBjb250aW51ZXMgdG8gdXBkYXRlIHVudGlsIHVzZXIgbWFudWFsbHkgb3ZlcnJpZGVzCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgfSk7CiAgICB9CiAgfSwgW2luY29tZSwgY3VycmVudENhbGMudG91Y2hlZC5idWRnZXQsIGNhbGN1bGF0b3JUeXBlXSk7CiAgY29uc3QgaGFuZGxlSW52ZXN0bWVudFN0cmF0ZWd5ID0gKHN0cmF0ZWd5KSA9PiB7CiAgICBsZXQgcHJlID0gIjYiOwogICAgbGV0IHBvc3QgPSAiNSI7CiAgICBpZiAoc3RyYXRlZ3kgPT09ICJjb25zZXJ2YXRpdmUiKSB7CiAgICAgIHByZSA9ICI0IjsKICAgICAgcG9zdCA9ICIzIjsKICAgIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09ICJhZ2dyZXNzaXZlIikgewogICAgICBwcmUgPSAiOSI7CiAgICAgIHBvc3QgPSAiNyI7CiAgICB9IGVsc2UgewogICAgICBwcmUgPSAiNyI7CiAgICAgIHBvc3QgPSAiNSI7CiAgICB9CiAgICBzZXRDYWxjdWxhdG9ycygocHJldikgPT4gewogICAgICBjb25zdCBuZXh0ID0geyAuLi5wcmV2IH07CiAgICAgIG5leHRbY2FsY3VsYXRvclR5cGVdID0gewogICAgICAgIC4uLm5leHRbY2FsY3VsYXRvclR5cGVdLAogICAgICAgIHZhbHVlczogewogICAgICAgICAgLi4ubmV4dFtjYWxjdWxhdG9yVHlwZV0udmFsdWVzLAogICAgICAgICAgcHJlUmV0aXJlUmF0ZTogcHJlLAogICAgICAgICAgcG9zdFJldGlyZVJhdGU6IHBvc3QKICAgICAgICB9LAogICAgICAgIHRvdWNoZWQ6IHsKICAgICAgICAgIC4uLm5leHRbY2FsY3VsYXRvclR5cGVdLnRvdWNoZWQsCiAgICAgICAgICBwcmVSZXRpcmVSYXRlOiB0cnVlLAogICAgICAgICAgcG9zdFJldGlyZVJhdGU6IHRydWUKICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBuZXh0OwogICAgfSk7CiAgfTsKICBjb25zdCBbc2hvd1F1aXosIHNldFNob3dRdWl6XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtxdWl6U3RlcCwgc2V0UXVpelN0ZXBdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgwKTsKICBjb25zdCBbcXVpekFuc3dlcnMsIHNldFF1aXpBbnN3ZXJzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoewogICAga2lkczogMCwKICAgIGNvbGxlZ2U6ICJubyIsCiAgICAvLyBubywgcGFydGlhbCwgZnVsbAogICAgdHJhdmVsOiAibW9kZXJhdGUiCiAgICAvLyBsb3csIG1vZGVyYXRlLCBoaWdoCiAgfSk7CiAgY29uc3QgaGFuZGxlUXVpekNvbXBsZXRlID0gKCkgPT4gewogICAgbGV0IGN1cnJlbnRDb250cmliID0gcGFyc2VGbG9hdChjb250cmlidXRpb25zKTsKICAgIGlmIChxdWl6QW5zd2Vycy5jb2xsZWdlID09PSAiZnVsbCIpIHsKICAgICAgY3VycmVudENvbnRyaWIgPSBNYXRoLm1heCgwLCBjdXJyZW50Q29udHJpYiAtIHF1aXpBbnN3ZXJzLmtpZHMgKiA1MDApOwogICAgfSBlbHNlIGlmIChxdWl6QW5zd2Vycy5jb2xsZWdlID09PSAicGFydGlhbCIpIHsKICAgICAgY3VycmVudENvbnRyaWIgPSBNYXRoLm1heCgwLCBjdXJyZW50Q29udHJpYiAtIHF1aXpBbnN3ZXJzLmtpZHMgKiAyMDApOwogICAgfQogICAgdXBkYXRlVmFsKCJjb250cmlidXRpb25zIiwgU3RyaW5nKGN1cnJlbnRDb250cmliKSk7CiAgICBsZXQgYmFzZUJ1ZGdldCA9IHBhcnNlRmxvYXQoYnVkZ2V0KTsKICAgIGxldCB0cmF2ZWxDb3N0ID0gMDsKICAgIGlmIChxdWl6QW5zd2Vycy50cmF2ZWwgPT09ICJsb3ciKSB0cmF2ZWxDb3N0ID0gMjAwOwogICAgZWxzZSBpZiAocXVpekFuc3dlcnMudHJhdmVsID09PSAibW9kZXJhdGUiKSB0cmF2ZWxDb3N0ID0gODAwOwogICAgZWxzZSBpZiAocXVpekFuc3dlcnMudHJhdmVsID09PSAiaGlnaCIpIHRyYXZlbENvc3QgPSAyNTAwOwogICAgaWYgKHF1aXpBbnN3ZXJzLmtpZHMgPiAwKSB0cmF2ZWxDb3N0ICs9IDIwMDsKICAgIGNvbnN0IG5ld0J1ZGdldCA9IE1hdGgucm91bmQoYmFzZUJ1ZGdldCArIHRyYXZlbENvc3QpOwogICAgdXBkYXRlVmFsKCJidWRnZXQiLCBTdHJpbmcobmV3QnVkZ2V0KSk7CiAgICBzZXRTaG93UXVpeihmYWxzZSk7CiAgICBzZXRRdWl6U3RlcCgwKTsKICB9OwogIGNvbnN0IGFwcGx5U21hcnRCdWRnZXQgPSAoKSA9PiB7CiAgICBjb25zdCBpbmNvbWVOdW0gPSBwYXJzZUZsb2F0KGluY29tZSk7CiAgICBpZiAoIWlzTmFOKGluY29tZU51bSkpIHsKICAgICAgY29uc3Qgc3VnZ2VzdGVkID0gTWF0aC5yb3VuZChpbmNvbWVOdW0gKiAwLjc1IC8gMTIpOwogICAgICB1cGRhdGVWYWwoImJ1ZGdldCIsIFN0cmluZyhzdWdnZXN0ZWQpKTsKICAgIH0KICB9OwogIGNvbnN0IHN0eWxlcyA9IHsKICAgIGNvbnRhaW5lcjogewogICAgICB3aWR0aDogIjEwMCUiLAogICAgICBtYXhXaWR0aDogIjYwMHB4IiwKICAgICAgbWFyZ2luOiAiMCBhdXRvIiwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmcsCiAgICAgIGZvbnRGYW1pbHk6ICInSW50ZXInLCBzYW5zLXNlcmlmIiwKICAgICAgcGFkZGluZzogIjIwcHgiLAogICAgICBib3hTaXppbmc6ICJib3JkZXItYm94IgogICAgfSwKICAgIHRpdGxlOiB7CiAgICAgIGZvbnRTaXplOiAiMjhweCIsCiAgICAgIGZvbnRXZWlnaHQ6IDgwMCwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICAgICAgbWFyZ2luQm90dG9tOiAiMTBweCIsCiAgICAgIHRleHRBbGlnbjogImxlZnQiCiAgICB9LAogICAgc3ViaGVhZGVyOiB7CiAgICAgIGZvbnRTaXplOiAiMTRweCIsCiAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgbWFyZ2luQm90dG9tOiAiMjBweCIsCiAgICAgIG1hcmdpblRvcDogIi01cHgiCiAgICB9LAogICAgY2FyZDogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6ICIyNHB4IiwKICAgICAgcGFkZGluZzogIjI0cHgiLAogICAgICBib3hTaGFkb3c6ICIwIDEwcHggNDBweCAtMTBweCByZ2JhKDAsMCwwLDAuMDgpIiwKICAgICAgbWFyZ2luQm90dG9tOiAiMjBweCIKICAgIH0sCiAgICByb3c6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsCiAgICAgIG1hcmdpbkJvdHRvbTogIjIwcHgiLAogICAgICBnYXA6ICIxNnB4IgogICAgfSwKICAgIGNvbHVtbjogewogICAgICBmbGV4OiAxLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLAogICAgICBnYXA6ICI4cHgiCiAgICB9LAogICAgbGFiZWw6IHsKICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICBmb250U2l6ZTogIjE1cHgiCiAgICB9LAogICAgdG9nZ2xlQ29udGFpbmVyOiB7CiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgZ2FwOiAiNHB4IiwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgYm9yZGVyUmFkaXVzOiAiOHB4IiwKICAgICAgcGFkZGluZzogIjJweCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiCiAgICB9LAogICAgdG9nZ2xlQnRuOiAoaXNBY3RpdmUpID0+ICh7CiAgICAgIHBhZGRpbmc6ICI0cHggMTJweCIsCiAgICAgIGJvcmRlclJhZGl1czogIjZweCIsCiAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgIGZvbnRTaXplOiAiMTRweCIsCiAgICAgIGNvbG9yOiBpc0FjdGl2ZSA/ICJ3aGl0ZSIgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgYmFja2dyb3VuZENvbG9yOiBpc0FjdGl2ZSA/IENPTE9SUy5ibHVlIDogInRyYW5zcGFyZW50IiwKICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjJzIgogICAgfSksCiAgICBidXR0b25Sb3c6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBnYXA6ICIxMnB4IiwKICAgICAgbWFyZ2luVG9wOiAiMTBweCIKICAgIH0sCiAgICBjYWxjQnV0dG9uOiB7CiAgICAgIGZsZXg6IDEsCiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICBib3JkZXI6ICJub25lIiwKICAgICAgcGFkZGluZzogIjE0cHgiLAogICAgICBib3JkZXJSYWRpdXM6ICIxNnB4IiwKICAgICAgZm9udFNpemU6ICIxNnB4IiwKICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICBnYXA6ICI4cHgiLAogICAgICBib3hTaGFkb3c6ICIwIDRweCAxMnB4IHJnYmEoODYsIDE5NywgMTUwLCAwLjIpIgogICAgfSwKICAgIHJlc3VsdENhcmQ6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiAiMjRweCIsCiAgICAgIHBhZGRpbmc6ICIyNHB4IiwKICAgICAgYm94U2hhZG93OiAiMCAxMHB4IDQwcHggLTEwcHggcmdiYSgwLDAsMCwwLjA4KSIsCiAgICAgIG1hcmdpblRvcDogIjI0cHgiCiAgICB9LAogICAgcmVzdWx0SGVhZGVyOiB7CiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIG1hcmdpbkJvdHRvbTogIjIwcHgiLAogICAgICBib3JkZXJCb3R0b206IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgIHBhZGRpbmdCb3R0b206ICIxNnB4IgogICAgfSwKICAgIHJlc3VsdFRpdGxlOiB7CiAgICAgIGZvbnRTaXplOiAiMThweCIsCiAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbgogICAgfSwKICAgIGxpc3Q6IHsKICAgICAgZm9udFNpemU6ICIxNHB4IiwKICAgICAgbGluZUhlaWdodDogIjEuOCIsCiAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICBib3JkZXJSYWRpdXM6ICIxNnB4IgogICAgfSwKICAgIGxpc3RJdGVtOiB7CiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgICAgbWFyZ2luQm90dG9tOiAiOHB4IiwKICAgICAgYm9yZGVyQm90dG9tOiAiMXB4IGRhc2hlZCAjRTVFN0VCIiwKICAgICAgcGFkZGluZ0JvdHRvbTogIjhweCIKICAgIH0sCiAgICBmb290ZXI6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgIGdhcDogIjI0cHgiLAogICAgICBtYXJnaW5Ub3A6ICI0MHB4IiwKICAgICAgcGFkZGluZ1RvcDogIjI0cHgiLAogICAgICBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAKICAgIH0sCiAgICBmb290ZXJCdG46IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgZ2FwOiAiOHB4IiwKICAgICAgYmFja2dyb3VuZDogIm5vbmUiLAogICAgICBib3JkZXI6ICJub25lIiwKICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgZm9udFNpemU6ICIxNHB4IiwKICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICB0cmFuc2l0aW9uOiAiY29sb3IgMC4ycyIsCiAgICAgIHBhZGRpbmc6ICI4cHgiCiAgICB9LAogICAgc2VjdGlvblRpdGxlOiB7CiAgICAgIGZvbnRTaXplOiAiMjBweCIsCiAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICAgICAgbWFyZ2luQm90dG9tOiAiMTZweCIsCiAgICAgIHBhZGRpbmdMZWZ0OiAiNHB4IgogICAgfSwKICAgIG1vZGFsT3ZlcmxheTogewogICAgICBwb3NpdGlvbjogImZpeGVkIiwKICAgICAgdG9wOiAwLAogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMCwKICAgICAgYm90dG9tOiAwLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNSkiLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgIHpJbmRleDogMWUzLAogICAgICBwYWRkaW5nOiAiMjBweCIKICAgIH0sCiAgICBtb2RhbENvbnRlbnQ6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICBib3JkZXJSYWRpdXM6ICIyNHB4IiwKICAgICAgcGFkZGluZzogIjMycHgiLAogICAgICB3aWR0aDogIjEwMCUiLAogICAgICBtYXhXaWR0aDogIjQwMHB4IiwKICAgICAgYm94U2hhZG93OiAiMCAyMHB4IDYwcHggLTEwcHggcmdiYSgwLDAsMCwwLjIpIiwKICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgIH0sCiAgICBtb2RhbENsb3NlOiB7CiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6ICIyMHB4IiwKICAgICAgcmlnaHQ6ICIyMHB4IiwKICAgICAgYmFja2dyb3VuZDogIm5vbmUiLAogICAgICBib3JkZXI6ICJub25lIiwKICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgcGFkZGluZzogIjRweCIKICAgIH0sCiAgICBpbnB1dDogewogICAgICB3aWR0aDogIjEwMCUiLAogICAgICBwYWRkaW5nOiAiMTJweCAxNnB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAiMTJweCIsCiAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgZm9udFNpemU6ICIxNnB4IiwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICAgICAgbWFyZ2luQm90dG9tOiAiMTZweCIsCiAgICAgIGJveFNpemluZzogImJvcmRlci1ib3giLAogICAgICBvdXRsaW5lOiAibm9uZSIKICAgIH0sCiAgICBoZWFkZXJSb3c6IHsKICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgbWFyZ2luQm90dG9tOiAiMTBweCIKICAgIH0sCiAgICBxdWl6QnV0dG9uOiB7CiAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmFjY2VudExpZ2h0LAogICAgICBjb2xvcjogQ09MT1JTLnByaW1hcnlEYXJrLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMucHJpbWFyeX1gLAogICAgICBwYWRkaW5nOiAiMTJweCIsCiAgICAgIGJvcmRlclJhZGl1czogIjEycHgiLAogICAgICBmb250U2l6ZTogIjE0cHgiLAogICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgIGdhcDogIjhweCIsCiAgICAgIG1hcmdpbkJvdHRvbTogIjI0cHgiLAogICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiCiAgICB9LAogICAgc3RyYXRlZ3lCdG46IChhY3RpdmUpID0+ICh7CiAgICAgIGZsZXg6IDEsCiAgICAgIHBhZGRpbmc6ICI4cHgiLAogICAgICBib3JkZXJSYWRpdXM6ICI4cHgiLAogICAgICBib3JkZXI6IGFjdGl2ZSA/IGAycHggc29saWQgJHtDT0xPUlMucHJpbWFyeX1gIDogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgYmFja2dyb3VuZENvbG9yOiBhY3RpdmUgPyBDT0xPUlMuYWNjZW50TGlnaHQgOiAid2hpdGUiLAogICAgICBjb2xvcjogYWN0aXZlID8gQ09MT1JTLnByaW1hcnlEYXJrIDogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgZm9udFNpemU6ICIxMnB4IiwKICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgIHRleHRBbGlnbjogImNlbnRlciIKICAgIH0pLAogICAgc3Vic2NyaWJlQnRuOiB7CiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGdhcDogIjZweCIsCiAgICAgIHBhZGRpbmc6ICI4cHggMTJweCIsCiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsCiAgICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgYm9yZGVyUmFkaXVzOiAiOHB4IiwKICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgIGZvbnRTaXplOiAiMTJweCIsCiAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgIHRleHREZWNvcmF0aW9uOiAibm9uZSIsCiAgICAgIHRyYW5zaXRpb246ICJiYWNrZ3JvdW5kLWNvbG9yIDAuMnMiCiAgICB9CiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5jb250YWluZXIsIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmhlYWRlclJvdywgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnRpdGxlLCBjaGlsZHJlbjogIlJldGlyZW1lbnQgQ2FsY3VsYXRvciIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuc3Vic2NyaWJlQnRuLCBjbGFzc05hbWU6ICJidG4tcHJlc3MiLCBvbkNsaWNrOiAoKSA9PiBzZXRTaG93U3Vic2NyaWJlTW9kYWwodHJ1ZSksIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShNYWlsLCB7IHNpemU6IDE0IH0pLAogICAgICAgICJTdWJzY3JpYmUiCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3ViaGVhZGVyLCBjaGlsZHJlbjogIlBsYW4geW91ciBmaW5hbmNpYWwgZnV0dXJlLiIgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLnF1aXpCdXR0b24sIG9uQ2xpY2s6ICgpID0+IHNldFNob3dRdWl6KHRydWUpLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1lc3NhZ2VTcXVhcmUsIHsgc2l6ZTogMTggfSksCiAgICAgICJHZXQgTW9yZSBBY2N1cmF0ZSBSZXN1bHRzIgogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY2FyZCwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnNlY3Rpb25UaXRsZSwgY2hpbGRyZW46ICJSZXRpcmVtZW50IGRldGFpbHMiIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJDdXJyZW50IGFnZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IGN1cnJlbnRBZ2UsCiAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiB1cGRhdGVWYWwoImN1cnJlbnRBZ2UiLCB2KSwKICAgICAgICAgICAgICBtaW46IDE4LAogICAgICAgICAgICAgIG1heDogMTAwCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIkFubnVhbCBwcmUtdGF4IGluY29tZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IGluY29tZSwKICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgiaW5jb21lIiwgdiksCiAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgIG1heDogMWU3LAogICAgICAgICAgICAgIHN0ZXA6IDFlMywKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJDdXJyZW50IHJldGlyZW1lbnQgc2F2aW5ncyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IHNhdmluZ3MsCiAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiB1cGRhdGVWYWwoInNhdmluZ3MiLCB2KSwKICAgICAgICAgICAgICBtaW46IDAsCiAgICAgICAgICAgICAgbWF4OiAxZTcsCiAgICAgICAgICAgICAgc3RlcDogMWUzLAogICAgICAgICAgICAgIHByZWZpeDogIiQiCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIk90aGVyIHJldGlyZW1lbnQgaW5jb21lIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogb3RoZXJJbmNvbWUsCiAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiB1cGRhdGVWYWwoIm90aGVySW5jb21lIiwgdiksCiAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgIG1heDogMWU1LAogICAgICAgICAgICAgIHN0ZXA6IDEwMCwKICAgICAgICAgICAgICBwcmVmaXg6ICIkIgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIk1vbnRobHkgY29udHJpYnV0aW9ucyIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMudG9nZ2xlQ29udGFpbmVyLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy50b2dnbGVCdG4oY29udHJpYnV0aW9uTW9kZSA9PT0gIiQiKSwKICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gdXBkYXRlVmFsKCJjb250cmlidXRpb25Nb2RlIiwgIiQiKSwKICAgICAgICAgICAgICAgICAgY2hpbGRyZW46ICIkIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnRvZ2dsZUJ0bihjb250cmlidXRpb25Nb2RlID09PSAiJSIpLAogICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB1cGRhdGVWYWwoImNvbnRyaWJ1dGlvbk1vZGUiLCAiJSIpLAogICAgICAgICAgICAgICAgICBjaGlsZHJlbjogIiUiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbHVlOiBjb250cmlidXRpb25zLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJjb250cmlidXRpb25zIiwgdiksCiAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgIG1heDogY29udHJpYnV0aW9uTW9kZSA9PT0gIiQiID8gMWU1IDogMTAwLAogICAgICAgICAgICAgIHN0ZXA6IGNvbnRyaWJ1dGlvbk1vZGUgPT09ICIkIiA/IDEwMCA6IDEsCiAgICAgICAgICAgICAgcHJlZml4OiBjb250cmlidXRpb25Nb2RlID09PSAiJCIgPyAiJCIgOiB2b2lkIDAsCiAgICAgICAgICAgICAgc3VmZml4OiBjb250cmlidXRpb25Nb2RlID09PSAiJSIgPyAiJSIgOiB2b2lkIDAKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5jb2x1bW4sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5sYWJlbCwgY2hpbGRyZW46ICJNb250aGx5IGJ1ZGdldCBpbiByZXRpcmVtZW50IiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy50b2dnbGVDb250YWluZXIsIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnRvZ2dsZUJ0bihidWRnZXRNb2RlID09PSAiJCIpLAogICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB1cGRhdGVWYWwoImJ1ZGdldE1vZGUiLCAiJCIpLAogICAgICAgICAgICAgICAgICBjaGlsZHJlbjogIiQiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMudG9nZ2xlQnRuKGJ1ZGdldE1vZGUgPT09ICIlIiksCiAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHVwZGF0ZVZhbCgiYnVkZ2V0TW9kZSIsICIlIiksCiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAiJSIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsdWU6IGJ1ZGdldCwKICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgiYnVkZ2V0IiwgdiksCiAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgIG1heDogYnVkZ2V0TW9kZSA9PT0gIiQiID8gMWU1IDogMjAwLAogICAgICAgICAgICAgIHN0ZXA6IGJ1ZGdldE1vZGUgPT09ICIkIiA/IDEwMCA6IDEsCiAgICAgICAgICAgICAgcHJlZml4OiBidWRnZXRNb2RlID09PSAiJCIgPyAiJCIgOiB2b2lkIDAsCiAgICAgICAgICAgICAgc3VmZml4OiBidWRnZXRNb2RlID09PSAiJSIgPyAiJSIgOiB2b2lkIDAKICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRXZWlnaHQ6IDcwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIsIG1hcmdpblRvcDogNCB9LAogICAgICAgICAgICAgIG9uQ2xpY2s6IGFwcGx5U21hcnRCdWRnZXQsCiAgICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiXHV7MUZBODR9IEVzdGltYXRlIiB9KQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAiZGl2IiwKICAgICAgICB7CiAgICAgICAgICBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDgsIGN1cnNvcjogInBvaW50ZXIiLCBtYXJnaW5Ub3A6IDIwLCBtYXJnaW5Cb3R0b206IDIwLCBjb2xvcjogQ09MT1JTLmJsdWUsIGZvbnRXZWlnaHQ6IDcwMCwgZm9udFNpemU6IDE0IH0sCiAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTaG93QWR2YW5jZWQoIXNob3dBZHZhbmNlZCksCiAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICBzaG93QWR2YW5jZWQgPyAiSElERSBBRFZBTkNFRCBERVRBSUxTIiA6ICJBRFZBTkNFRCBERVRBSUxTIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaGV2cm9uRG93biwgeyBzaXplOiAxNiwgc3R5bGU6IHsgdHJhbnNmb3JtOiBzaG93QWR2YW5jZWQgPyAicm90YXRlKDE4MGRlZykiIDogIm5vbmUiLCB0cmFuc2l0aW9uOiAidHJhbnNmb3JtIDAuMnMiIH0gfSkKICAgICAgICAgIF0KICAgICAgICB9CiAgICAgICksCiAgICAgIHNob3dBZHZhbmNlZCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJJbnZlc3RtZW50IFN0cmF0ZWd5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4ocHJlUmV0aXJlUmF0ZSA9PT0gIjQiICYmIHBvc3RSZXRpcmVSYXRlID09PSAiMyIpLCBvbkNsaWNrOiAoKSA9PiBoYW5kbGVJbnZlc3RtZW50U3RyYXRlZ3koImNvbnNlcnZhdGl2ZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJDb25zZXJ2YXRpdmUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIkJvbmRzICYgU3RhYmlsaXR5IiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHByZVJldGlyZVJhdGUgPT09ICI3IiAmJiBwb3N0UmV0aXJlUmF0ZSA9PT0gIjUiKSwgb25DbGljazogKCkgPT4gaGFuZGxlSW52ZXN0bWVudFN0cmF0ZWd5KCJtb2RlcmF0ZSIpLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgY2hpbGRyZW46ICJNb2RlcmF0ZSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGZvbnRXZWlnaHQ6IDQwMCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiAiQmFsYW5jZWQgR3Jvd3RoIiB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHByZVJldGlyZVJhdGUgPT09ICI5IiAmJiBwb3N0UmV0aXJlUmF0ZSA9PT0gIjciKSwgb25DbGljazogKCkgPT4gaGFuZGxlSW52ZXN0bWVudFN0cmF0ZWd5KCJhZ2dyZXNzaXZlIiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBjaGlsZHJlbjogIkFnZ3Jlc3NpdmUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBmb250V2VpZ2h0OiA0MDAsIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogIk1heCBSZXR1cm5zIiB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiUmV0aXJlbWVudCBhZ2UiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWU6IHJldGlyZW1lbnRBZ2UsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgicmV0aXJlbWVudEFnZSIsIHYpLAogICAgICAgICAgICAgICAgbWluOiBwYXJzZUludChjdXJyZW50QWdlKSArIDEsCiAgICAgICAgICAgICAgICBtYXg6IDEwMAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiTGlmZSBleHBlY3RhbmN5IiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBsaWZlRXhwZWN0YW5jeSwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJsaWZlRXhwZWN0YW5jeSIsIHYpLAogICAgICAgICAgICAgICAgbWluOiBwYXJzZUludChyZXRpcmVtZW50QWdlKSArIDEsCiAgICAgICAgICAgICAgICBtYXg6IDEyMAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5yb3csIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmNvbHVtbiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmxhYmVsLCBjaGlsZHJlbjogIlByZS1yZXRpcmVtZW50IHJhdGUgb2YgcmV0dXJuIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBwcmVSZXRpcmVSYXRlLAogICAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2KSA9PiB1cGRhdGVWYWwoInByZVJldGlyZVJhdGUiLCB2KSwKICAgICAgICAgICAgICAgIG1pbjogMCwKICAgICAgICAgICAgICAgIG1heDogMTUsCiAgICAgICAgICAgICAgICBzdWZmaXg6ICIlIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiUG9zdC1yZXRpcmVtZW50IHJhdGUgb2YgcmV0dXJuIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICBOdW1iZXJDb250cm9sLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBwb3N0UmV0aXJlUmF0ZSwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJwb3N0UmV0aXJlUmF0ZSIsIHYpLAogICAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgICAgbWF4OiAxNSwKICAgICAgICAgICAgICAgIHN1ZmZpeDogIiUiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJvdywgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiSW5mbGF0aW9uIHJhdGUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWU6IGluZmxhdGlvbiwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gdXBkYXRlVmFsKCJpbmZsYXRpb24iLCB2KSwKICAgICAgICAgICAgICAgIG1pbjogMCwKICAgICAgICAgICAgICAgIG1heDogMTAsCiAgICAgICAgICAgICAgICBzdWZmaXg6ICIlIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMuY29sdW1uLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiQW5udWFsIGluY29tZSBpbmNyZWFzZSIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgTnVtYmVyQ29udHJvbCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWx1ZTogaW5jb21lSW5jcmVhc2UsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKHYpID0+IHVwZGF0ZVZhbCgiaW5jb21lSW5jcmVhc2UiLCB2KSwKICAgICAgICAgICAgICAgIG1pbjogMCwKICAgICAgICAgICAgICAgIG1heDogMTAsCiAgICAgICAgICAgICAgICBzdWZmaXg6ICIlIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmJ1dHRvblJvdywgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwgc3R5bGU6IHN0eWxlcy5jYWxjQnV0dG9uLCBvbkNsaWNrOiBjYWxjdWxhdGUyLCBkaXNhYmxlZDogaXNBbmFseXppbmcsIGNoaWxkcmVuOiBpc0FuYWx5emluZyA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTG9hZGVyLCB7IHNpemU6IDIwLCBjbGFzc05hbWU6ICJzcGluIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgICJDYWxjdWxhdGUgIiwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFBsYXksIHsgc2l6ZTogMjAsIGZpbGw6ICJ3aGl0ZSIgfSkKICAgICAgXSB9KSB9KSB9KQogICAgXSB9KSwKICAgIGN1cnJlbnRDYWxjLnJlc3VsdCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLnJlc3VsdENhcmQsIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5yZXN1bHRIZWFkZXIsIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHN0eWxlcy5yZXN1bHRUaXRsZSwgY2hpbGRyZW46IFsKICAgICAgICAiUmV0aXJlbWVudCBzYXZpbmdzIGF0IGFnZSAiLAogICAgICAgIGN1cnJlbnRDYWxjLnZhbHVlcy5yZXRpcmVtZW50QWdlCiAgICAgIF0gfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgbWFyZ2luQm90dG9tOiAyNCwgZ2FwOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46ICJXaGF0IHlvdSdsbCBoYXZlIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyOCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgY3VycmVudENhbGMucmVzdWx0LmhhdmUudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgYm9yZGVyTGVmdDogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgcGFkZGluZ0xlZnQ6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luQm90dG9tOiA0IH0sIGNoaWxkcmVuOiAiV2hhdCB5b3UnbGwgbmVlZCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjgsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAiJCIsCiAgICAgICAgICAgIGN1cnJlbnRDYWxjLnJlc3VsdC5uZWVkLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2LCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy5ibHVlLCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2lyY2xlUXVlc3Rpb25NYXJrLCB7IHNpemU6IDE0IH0pLAogICAgICAgICJIb3cgZGlkIHdlIGNhbGN1bGF0ZSB5b3VyIHJlc3VsdHM/IgogICAgICBdIH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGJvcmRlckJvdHRvbTogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgbWFyZ2luQm90dG9tOiAyNCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyQm90dG9tOiByZXN1bHRWaWV3ID09PSAiZ3JhcGgiID8gYDJweCBzb2xpZCAke0NPTE9SUy5wcmltYXJ5fWAgOiAibm9uZSIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IHJlc3VsdFZpZXcgPT09ICJncmFwaCIgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDEyLCBsZXR0ZXJTcGFjaW5nOiAxIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFJlc3VsdFZpZXcoImdyYXBoIiksCiAgICAgICAgICAgIGNoaWxkcmVuOiAiR1JBUEggVklFVyIKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyQm90dG9tOiByZXN1bHRWaWV3ID09PSAic3VtbWFyeSIgPyBgMnB4IHNvbGlkICR7Q09MT1JTLnByaW1hcnl9YCA6ICJub25lIiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogcmVzdWx0VmlldyA9PT0gInN1bW1hcnkiID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgY3Vyc29yOiAicG9pbnRlciIsIGZvbnRTaXplOiAxMiwgbGV0dGVyU3BhY2luZzogMSB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRSZXN1bHRWaWV3KCJzdW1tYXJ5IiksCiAgICAgICAgICAgIGNoaWxkcmVuOiAiU1VNTUFSWSBWSUVXIgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KSwKICAgICAgcmVzdWx0VmlldyA9PT0gImdyYXBoIiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGhlaWdodDogMzAwLCB3aWR0aDogIjEwMCUiLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKEFyZWFDaGFydCwgeyBkYXRhOiBjdXJyZW50Q2FsYy5yZXN1bHQuZ3JhcGhEYXRhLCBtYXJnaW46IHsgdG9wOiAxMCwgcmlnaHQ6IDEwLCBsZWZ0OiAtMjAsIGJvdHRvbTogMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGVmcyIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJsaW5lYXJHcmFkaWVudCIsIHsgaWQ6ICJjb2xvckN1cnJlbnQiLCB4MTogIjAiLCB5MTogIjAiLCB4MjogIjAiLCB5MjogIjEiLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI1JSIsIHN0b3BDb2xvcjogQ09MT1JTLnByaW1hcnksIHN0b3BPcGFjaXR5OiAwLjEgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInN0b3AiLCB7IG9mZnNldDogIjk1JSIsIHN0b3BDb2xvcjogQ09MT1JTLnByaW1hcnksIHN0b3BPcGFjaXR5OiAwIH0pCiAgICAgICAgICBdIH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDYXJ0ZXNpYW5HcmlkLCB7IHN0cm9rZURhc2hhcnJheTogIjMgMyIsIHZlcnRpY2FsOiBmYWxzZSwgc3Ryb2tlOiBDT0xPUlMuYm9yZGVyIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShYQXhpcywgeyBkYXRhS2V5OiAiYWdlIiwgdGljazogeyBmaWxsOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCB0aWNrTGluZTogZmFsc2UsIGF4aXNMaW5lOiB7IHN0cm9rZTogQ09MT1JTLmJvcmRlciB9LCBtaW5UaWNrR2FwOiAzMCB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoWUF4aXMsIHsgdGljazogeyBmaWxsOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCB0aWNrRm9ybWF0dGVyOiAodmFsKSA9PiBgJCR7KHZhbCAvIDFlNikudG9GaXhlZCgxKX1tYCwgdGlja0xpbmU6IGZhbHNlLCBheGlzTGluZTogZmFsc2UgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBUb29sdGlwLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGVudDogKHsgYWN0aXZlLCBwYXlsb2FkLCBsYWJlbCB9KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlICYmIHBheWxvYWQgJiYgcGF5bG9hZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgcmVjID0gcGF5bG9hZC5maW5kKChwKSA9PiBwLm5hbWUgPT09ICJSZWNvbW1lbmRlZCIpPy52YWx1ZTsKICAgICAgICAgICAgICAgICAgY29uc3QgY3VyID0gcGF5bG9hZC5maW5kKChwKSA9PiBwLm5hbWUgPT09ICJDdXJyZW50IHBhdGgiKT8udmFsdWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBjdXIgIT09IHZvaWQgMCAmJiByZWMgIT09IHZvaWQgMCA/IGN1ciAtIHJlYyA6IDA7CiAgICAgICAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIHBhZGRpbmc6IDEyLCBib3JkZXJSYWRpdXM6IDgsIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjEpIiwgYm9yZGVyOiAiMXB4IHNvbGlkICNFNUU3RUIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNjAwLCBtYXJnaW5Cb3R0b206IDgsIGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAiQWdlICIsCiAgICAgICAgICAgICAgICAgICAgICBsYWJlbAogICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBnYXA6IDE2LCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMuYmx1ZSwgZm9udFdlaWdodDogNjAwLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46ICJSZWNvbW1lbmRlZCIgfSksCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgICAgICAgICByZWM/LnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZ2FwOiAxNiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRXZWlnaHQ6IDYwMCwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiQ3VycmVudCBwYXRoIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cj8udG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBnYXA6IDE2LCBib3JkZXJUb3A6ICIxcHggZGFzaGVkICNFNUU3RUIiLCBwYWRkaW5nVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogIkRpZmZlcmVuY2UiIH0pLAogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGRpZmYgPj0gMCA/IENPTE9SUy5wcmltYXJ5IDogQ09MT1JTLnJlZCwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmYgPj0gMCA/ICIrIiA6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmYudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgXSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAicmVjb21tZW5kZWQiLCBzdHJva2U6IENPTE9SUy5ibHVlLCBzdHJva2VEYXNoYXJyYXk6ICI1IDUiLCBmaWxsOiAidHJhbnNwYXJlbnQiLCBzdHJva2VXaWR0aDogMiwgbmFtZTogIlJlY29tbWVuZGVkIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAiY3VycmVudCIsIHN0cm9rZTogQ09MT1JTLnByaW1hcnksIGZpbGw6ICJ1cmwoI2NvbG9yQ3VycmVudCkiLCBzdHJva2VXaWR0aDogMiwgbmFtZTogIkN1cnJlbnQgcGF0aCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlZmVyZW5jZURvdCwgeyB4OiBwYXJzZUludChjdXJyZW50Q2FsYy52YWx1ZXMucmV0aXJlbWVudEFnZSksIHk6IGN1cnJlbnRDYWxjLnJlc3VsdC5oYXZlLCByOiA0LCBmaWxsOiBDT0xPUlMucHJpbWFyeSwgc3Ryb2tlOiAid2hpdGUiLCBzdHJva2VXaWR0aDogMiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUmVmZXJlbmNlRG90LCB7IHg6IHBhcnNlSW50KGN1cnJlbnRDYWxjLnZhbHVlcy5yZXRpcmVtZW50QWdlKSwgeTogY3VycmVudENhbGMucmVzdWx0Lm5lZWQsIHI6IDQsIGZpbGw6IENPTE9SUy5ibHVlLCBzdHJva2U6ICJ3aGl0ZSIsIHN0cm9rZVdpZHRoOiAyIH0pCiAgICAgICAgXSB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZ2FwOiAxNiwgbWFyZ2luVG9wOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogMTIsIGhlaWdodDogMiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmx1ZSB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogIlJlY29tbWVuZGVkIiB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxMiwgaGVpZ2h0OiAyLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5IH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiQ3VycmVudCBwYXRoIiB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGlzdCwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiAxNiwgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiQ3VycmVudCByZXRpcmVtZW50IHBsYW4iIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiVGFyZ2V0IHJldGlyZW1lbnQgcGxhbiIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogOCwgYm9yZGVyQm90dG9tOiAiMXB4IGRhc2hlZCAjRTVFN0VCIiwgcGFkZGluZ0JvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiVG90YWwgcmV0aXJlbWVudCBzYXZpbmdzIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRTaXplOiAxNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgY3VycmVudENhbGMucmVzdWx0LmhhdmUudG9Mb2NhbGVTdHJpbmcoKQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Cb3R0b206IDgsIGJvcmRlckJvdHRvbTogIjFweCBkYXNoZWQgI0U1RTdFQiIsIHBhZGRpbmdCb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIk1vbnRobHkgY29udHJpYnV0aW9uIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRTaXplOiAxNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgY3VycmVudENhbGMucmVzdWx0LmN1cnJlbnRNb250aGx5Q29udHJpYi50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogOCwgYm9yZGVyQm90dG9tOiAiMXB4IGRhc2hlZCAjRTVFN0VCIiwgcGFkZGluZ0JvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQWdlIHNhdmluZ3MgcnVucyBvdXQiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGN1cnJlbnRDYWxjLnJlc3VsdC5ydW5PdXRBZ2VDdXJyZW50IDwgcGFyc2VJbnQoY3VycmVudENhbGMudmFsdWVzLmxpZmVFeHBlY3RhbmN5KSA/IENPTE9SUy5yZWQgOiBDT0xPUlMucHJpbWFyeSwgZm9udFNpemU6IDE0IH0sIGNoaWxkcmVuOiBjdXJyZW50Q2FsYy5yZXN1bHQucnVuT3V0QWdlQ3VycmVudCA+PSBwYXJzZUludChjdXJyZW50Q2FsYy52YWx1ZXMubGlmZUV4cGVjdGFuY3kpID8gYCR7Y3VycmVudENhbGMucmVzdWx0LnJ1bk91dEFnZUN1cnJlbnR9K2AgOiBjdXJyZW50Q2FsYy5yZXN1bHQucnVuT3V0QWdlQ3VycmVudCB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Cb3R0b206IDgsIGJvcmRlckJvdHRvbTogIjFweCBkYXNoZWQgI0U1RTdFQiIsIHBhZGRpbmdCb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIlRvdGFsIHJldGlyZW1lbnQgc2F2aW5ncyIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250U2l6ZTogMTQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgIGN1cnJlbnRDYWxjLnJlc3VsdC5uZWVkLnRvTG9jYWxlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgbWFyZ2luQm90dG9tOiA4LCBib3JkZXJCb3R0b206ICIxcHggZGFzaGVkICNFNUU3RUIiLCBwYWRkaW5nQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJNb250aGx5IGNvbnRyaWJ1dGlvbiIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBmb250U2l6ZTogMTQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgIGN1cnJlbnRDYWxjLnJlc3VsdC5tb250aGx5Q29udHJpYk5lZWRlZC50b0xvY2FsZVN0cmluZygpCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogOCwgYm9yZGVyQm90dG9tOiAiMXB4IGRhc2hlZCAjRTVFN0VCIiwgcGFkZGluZ0JvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQWdlIHNhdmluZ3MgcnVucyBvdXQiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGN1cnJlbnRDYWxjLnJlc3VsdC5ydW5PdXRBZ2VJZGVhbCA+PSBwYXJzZUludChjdXJyZW50Q2FsYy52YWx1ZXMubGlmZUV4cGVjdGFuY3kpID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMucmVkLCBmb250U2l6ZTogMTQgfSwgY2hpbGRyZW46IGN1cnJlbnRDYWxjLnJlc3VsdC5ydW5PdXRBZ2VJZGVhbCA+PSBwYXJzZUludChjdXJyZW50Q2FsYy52YWx1ZXMubGlmZUV4cGVjdGFuY3kpID8gYCR7Y3VycmVudENhbGMucmVzdWx0LnJ1bk91dEFnZUlkZWFsfStgIDogY3VycmVudENhbGMucmVzdWx0LnJ1bk91dEFnZUlkZWFsIH0pCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLmZvb3RlciwgY2xhc3NOYW1lOiAibm8tcHJpbnQiLCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLmZvb3RlckJ0biwgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEhlYXJ0LCB7IHNpemU6IDE2IH0pLAogICAgICAgICIgRG9uYXRlIgogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLmZvb3RlckJ0biwgb25DbGljazogKCkgPT4gc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSksIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShNZXNzYWdlU3F1YXJlLCB7IHNpemU6IDE2IH0pLAogICAgICAgICIgRmVlZGJhY2siCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuZm9vdGVyQnRuLCBvbkNsaWNrOiAoKSA9PiB3aW5kb3cucHJpbnQoKSwgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFByaW50ZXIsIHsgc2l6ZTogMTYgfSksCiAgICAgICAgIiBQcmludCIKICAgICAgXSB9KQogICAgXSB9KSwKICAgIHNob3dGZWVkYmFja01vZGFsICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbE92ZXJsYXksIG9uQ2xpY2s6ICgpID0+IHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubW9kYWxDb250ZW50LCBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ2xvc2UsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWludXMsIHsgc2l6ZTogMjQsIHN0eWxlOiB7IHRyYW5zZm9ybTogInJvdGF0ZSg0NWRlZykiIH0gfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6ICIyNHB4IiwgZm9udFdlaWdodDogODAwLCBtYXJnaW5Cb3R0b206ICI4cHgiLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiRmVlZGJhY2siIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMTRweCIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiAiMjRweCIgfSwgY2hpbGRyZW46ICJIZWxwIHVzIGltcHJvdmUgdGhlIGNhbGN1bGF0b3IuIiB9KSwKICAgICAgZmVlZGJhY2tTdGF0dXMgPT09ICJzdWNjZXNzIiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAiY2VudGVyIiwgcGFkZGluZzogIjIwcHgiLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogIlRoYW5rcyBmb3IgeW91ciBmZWVkYmFjayEiIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJ0ZXh0YXJlYSIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IC4uLnN0eWxlcy5pbnB1dCwgaGVpZ2h0OiAiMTIwcHgiLCByZXNpemU6ICJub25lIiwgZm9udEZhbWlseTogImluaGVyaXQiIH0sCiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiVGVsbCB1cyB3aGF0IHlvdSB0aGluay4uLiIsCiAgICAgICAgICAgIHZhbHVlOiBmZWVkYmFja1RleHQsCiAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RmVlZGJhY2tUZXh0KGUudGFyZ2V0LnZhbHVlKQogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgZmVlZGJhY2tTdGF0dXMgPT09ICJlcnJvciIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnJlZCwgZm9udFNpemU6ICIxNHB4IiwgbWFyZ2luQm90dG9tOiAiMTBweCIgfSwgY2hpbGRyZW46ICJGYWlsZWQgdG8gc2VuZC4gUGxlYXNlIHRyeSBhZ2Fpbi4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgLi4uc3R5bGVzLmNhbGNCdXR0b24sIHdpZHRoOiAiMTAwJSIgfSwKICAgICAgICAgICAgb25DbGljazogaGFuZGxlRmVlZGJhY2tTdWJtaXQsCiAgICAgICAgICAgIGRpc2FibGVkOiBmZWVkYmFja1N0YXR1cyA9PT0gInN1Ym1pdHRpbmciIHx8ICFmZWVkYmFja1RleHQudHJpbSgpLAogICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICBjaGlsZHJlbjogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiA/ICJTZW5kaW5nLi4uIiA6ICJTZW5kIEZlZWRiYWNrIgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KQogICAgXSB9KSB9KSwKICAgIHNob3dRdWl6ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHN0eWxlcy5tb2RhbE92ZXJsYXksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ29udGVudCwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ2xvc2UsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dRdWl6KGZhbHNlKSwgY2hpbGRyZW46ICJcdTI3MTUiIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDI0LCB0ZXh0QWxpZ246ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjAsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiAiUGVyc29uYWxpemUgWW91ciBQbGFuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQW5zd2VyIGEgZmV3IHF1ZXN0aW9ucyB0byByZWZpbmUgeW91ciByZXRpcmVtZW50IGlucHV0cy4iIH0pCiAgICAgIF0gfSksCiAgICAgIHF1aXpTdGVwID09PSAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogIjEuIERvIHlvdSBwbGFuIHRvIGhhdmUgYSBmYW1pbHk/IiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubGFiZWwsIGNoaWxkcmVuOiAiSG93IG1hbnkgY2hpbGRyZW4/IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIE51bWJlckNvbnRyb2wsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWx1ZTogU3RyaW5nKHF1aXpBbnN3ZXJzLmtpZHMpLAogICAgICAgICAgICAgIG9uQ2hhbmdlOiAodikgPT4gc2V0UXVpekFuc3dlcnMoeyAuLi5xdWl6QW5zd2Vycywga2lkczogcGFyc2VJbnQodikgfSksCiAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgIG1heDogMTAKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDI0LCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiZmxleC1lbmQiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuc3Vic2NyaWJlQnRuLCBvbkNsaWNrOiAoKSA9PiBzZXRRdWl6U3RlcCgxKSwgY2hpbGRyZW46ICJOZXh0IFx1MjE5MiIgfSkgfSkKICAgICAgXSB9KSwKICAgICAgcXVpelN0ZXAgPT09IDEgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNiwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiAiMi4gQ29sbGVnZSBQbGFucyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogIkRvIHlvdSBwbGFuIHRvIHBheSBmb3IgeW91ciBjaGlsZHJlbidzIGNvbGxlZ2UgZWR1Y2F0aW9uPyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHF1aXpBbnN3ZXJzLmNvbGxlZ2UgPT09ICJubyIpLAogICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFF1aXpBbnN3ZXJzKHsgLi4ucXVpekFuc3dlcnMsIGNvbGxlZ2U6ICJubyIgfSksCiAgICAgICAgICAgICAgY2hpbGRyZW46ICJObyAvIFRoZXkgd2lsbCB0YWtlIGxvYW5zIgogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHF1aXpBbnN3ZXJzLmNvbGxlZ2UgPT09ICJwYXJ0aWFsIiksCiAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0UXVpekFuc3dlcnMoeyAuLi5xdWl6QW5zd2VycywgY29sbGVnZTogInBhcnRpYWwiIH0pLAogICAgICAgICAgICAgIGNoaWxkcmVuOiAiUGFydGlhbCBTdXBwb3J0IgogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHF1aXpBbnN3ZXJzLmNvbGxlZ2UgPT09ICJmdWxsIiksCiAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0UXVpekFuc3dlcnMoeyAuLi5xdWl6QW5zd2VycywgY29sbGVnZTogImZ1bGwiIH0pLAogICAgICAgICAgICAgIGNoaWxkcmVuOiAiRnVsbCBTdXBwb3J0IgogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDI0LCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgc3R5bGU6IHsgLi4uc3R5bGVzLnN1YnNjcmliZUJ0biwgYmFja2dyb3VuZDogInRyYW5zcGFyZW50IiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIG9uQ2xpY2s6ICgpID0+IHNldFF1aXpTdGVwKDApLCBjaGlsZHJlbjogIlx1MjE5MCBCYWNrIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgc3R5bGU6IHN0eWxlcy5zdWJzY3JpYmVCdG4sIG9uQ2xpY2s6ICgpID0+IHNldFF1aXpTdGVwKDIpLCBjaGlsZHJlbjogIk5leHQgXHUyMTkyIiB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgcXVpelN0ZXAgPT09IDIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNiwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiAiMy4gUmV0aXJlbWVudCBMaWZlc3R5bGUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46ICJIb3cgZG8geW91IGVudmlzaW9uIHlvdXIgdHJhdmVsIHBsYW5zPyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5zdHJhdGVneUJ0bihxdWl6QW5zd2Vycy50cmF2ZWwgPT09ICJsb3ciKSwKICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRRdWl6QW5zd2Vycyh7IC4uLnF1aXpBbnN3ZXJzLCB0cmF2ZWw6ICJsb3ciIH0pLAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiU3RhcnQgTG9jYWwiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDQwMCwgb3BhY2l0eTogMC44IH0sIGNoaWxkcmVuOiAiTG93IGNvc3QsIG1vc3RseSBsb2NhbCB0cmlwcyIgfSkKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnN0cmF0ZWd5QnRuKHF1aXpBbnN3ZXJzLnRyYXZlbCA9PT0gIm1vZGVyYXRlIiksCiAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0UXVpekFuc3dlcnMoeyAuLi5xdWl6QW5zd2VycywgdHJhdmVsOiAibW9kZXJhdGUiIH0pLAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiRXhwbG9yZXIiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDQwMCwgb3BhY2l0eTogMC44IH0sIGNoaWxkcmVuOiAiMS0yIG1ham9yIHRyaXBzIHBlciB5ZWFyIiB9KQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuc3RyYXRlZ3lCdG4ocXVpekFuc3dlcnMudHJhdmVsID09PSAiaGlnaCIpLAogICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFF1aXpBbnN3ZXJzKHsgLi4ucXVpekFuc3dlcnMsIHRyYXZlbDogImhpZ2giIH0pLAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNoaWxkcmVuOiAiR2xvYmV0cm90dGVyIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA0MDAsIG9wYWNpdHk6IDAuOCB9LCBjaGlsZHJlbjogIkZyZXF1ZW50IGludGVybmF0aW9uYWwgdHJhdmVsIiB9KQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAyNCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IHN0eWxlOiB7IC4uLnN0eWxlcy5zdWJzY3JpYmVCdG4sIGJhY2tncm91bmQ6ICJ0cmFuc3BhcmVudCIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBvbkNsaWNrOiAoKSA9PiBzZXRRdWl6U3RlcCgxKSwgY2hpbGRyZW46ICJcdTIxOTAgQmFjayIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IHN0eWxlOiBzdHlsZXMuc3Vic2NyaWJlQnRuLCBvbkNsaWNrOiBoYW5kbGVRdWl6Q29tcGxldGUsIGNoaWxkcmVuOiAiQXBwbHkgdG8gQ2FsY3VsYXRvciIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICBzaG93U3Vic2NyaWJlTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsT3ZlcmxheSwgb25DbGljazogKCkgPT4gc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiBzdHlsZXMubW9kYWxDb250ZW50LCBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBzdHlsZTogc3R5bGVzLm1vZGFsQ2xvc2UsIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSksIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1pbnVzLCB7IHNpemU6IDI0LCBzdHlsZTogeyB0cmFuc2Zvcm06ICJyb3RhdGUoNDVkZWcpIiB9IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAiMjRweCIsIGZvbnRXZWlnaHQ6IDgwMCwgbWFyZ2luQm90dG9tOiAiOHB4IiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIlN0YXkgVXBkYXRlZCIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6ICIxNHB4IiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206ICIyNHB4IiB9LCBjaGlsZHJlbjogIkdldCB0aGUgbGF0ZXN0IHVwZGF0ZXMgZGVsaXZlcmVkIHRvIHlvdXIgaW5ib3guIiB9KSwKICAgICAgc3Vic2NyaWJlU3RhdHVzID09PSAic3VjY2VzcyIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJjZW50ZXIiLCBwYWRkaW5nOiAiMjBweCIsIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogIjQwcHgiLCBtYXJnaW5Cb3R0b206ICIxMHB4IiB9LCBjaGlsZHJlbjogIlx1ezFGMzg5fSIgfSksCiAgICAgICAgc3Vic2NyaWJlTWVzc2FnZQogICAgICBdIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAiMTZweCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiYmxvY2siLCBmb250U2l6ZTogIjE0cHgiLCBmb250V2VpZ2h0OiA2MDAsIG1hcmdpbkJvdHRvbTogIjhweCIsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJFbWFpbCBBZGRyZXNzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmlucHV0LAogICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAieW91QGV4YW1wbGUuY29tIiwKICAgICAgICAgICAgICB2YWx1ZTogZW1haWwsCiAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRFbWFpbChlLnRhcmdldC52YWx1ZSkKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206ICIyMHB4IiwgbWluSGVpZ2h0OiAiMTIwcHgiLCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBpZDogInR1cm5zdGlsZS13aWRnZXQiIH0pIH0pLAogICAgICAgIHN1YnNjcmliZVN0YXR1cyA9PT0gImVycm9yIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucmVkLCBmb250U2l6ZTogIjE0cHgiLCBtYXJnaW5Cb3R0b206ICIxNnB4IiwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogc3Vic2NyaWJlTWVzc2FnZSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IC4uLnN0eWxlcy5jYWxjQnV0dG9uLCB3aWR0aDogIjEwMCUiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IGhhbmRsZVN1YnNjcmliZSwKICAgICAgICAgICAgZGlzYWJsZWQ6IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciLAogICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICBjaGlsZHJlbjogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIgPyAiU3Vic2NyaWJpbmcuLi4iIDogIlN1YnNjcmliZSIKICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGAKICAgICAgICBpbnB1dFt0eXBlPW51bWJlcl06Oi13ZWJraXQtaW5uZXItc3Bpbi1idXR0b24sIAogICAgICAgIGlucHV0W3R5cGU9bnVtYmVyXTo6LXdlYmtpdC1vdXRlci1zcGluLWJ1dHRvbiB7IAogICAgICAgICAgICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7IAogICAgICAgICAgICBtYXJnaW46IDA7IAogICAgICAgIH0KICAgICAgICAuYnRuLXByZXNzIHsKICAgICAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGVhc2UsIG9wYWNpdHkgMC4yczsKICAgICAgICB9CiAgICAgICAgLmJ0bi1wcmVzczphY3RpdmUgewogICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsKICAgICAgICB9CiAgICAgICAgLmJ0bi1wcmVzczpob3ZlciB7CiAgICAgICAgICBvcGFjaXR5OiAwLjc7CiAgICAgICAgfQogICAgICAgIEBrZXlmcmFtZXMgc3BpbiB7CiAgICAgICAgICAgIGZyb20geyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsgfQogICAgICAgICAgICB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0KICAgICAgICB9CiAgICAgICAgLnNwaW4gewogICAgICAgICAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgICAgIH0KICAgICAgICBAbWVkaWEgcHJpbnQgewogICAgICAgICAgYm9keSB7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgICAgfQogICAgICAgICAgLm5vLXByaW50IHsKICAgICAgICAgICAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgYCB9KQogIF0gfSk7Cn0KCi8vIHNyYy9tYWluLnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lMiA9IF9fdG9FU00ocmVxdWlyZV9qc3hfcnVudGltZSgpLCAxKTsKdmFyIEVycm9yQm91bmRhcnkgPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDUzLmRlZmF1bHQuQ29tcG9uZW50IHsKICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgc3VwZXIocHJvcHMpOwogICAgdGhpcy5zdGF0ZSA9IHsgaGFzRXJyb3I6IGZhbHNlIH07CiAgfQogIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IpIHsKICAgIHJldHVybiB7IGhhc0Vycm9yOiB0cnVlLCBlcnJvciB9OwogIH0KICBjb21wb25lbnREaWRDYXRjaChlcnJvciwgZXJyb3JJbmZvKSB7CiAgICBjb25zb2xlLmVycm9yKCJXaWRnZXQgRXJyb3IgQm91bmRhcnkgY2F1Z2h0IGVycm9yOiIsIGVycm9yLCBlcnJvckluZm8pOwogICAgdHJ5IHsKICAgICAgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZXZlbnQ6ICJjcmFzaCIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGVycm9yOiBlcnJvcj8ubWVzc2FnZSB8fCAiVW5rbm93biBlcnJvciIsCiAgICAgICAgICAgIHN0YWNrOiBlcnJvcj8uc3RhY2ssCiAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8/LmNvbXBvbmVudFN0YWNrCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goKGUpID0+IGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byByZXBvcnQgY3Jhc2giLCBlKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLnN0YXRlLmhhc0Vycm9yKSB7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMjAsIHRleHRBbGlnbjogImNlbnRlciIsIGZvbnRGYW1pbHk6ICJzYW5zLXNlcmlmIiwgY29sb3I6ICIjREMyNjI2Iiwgd29yZEJyZWFrOiAiYnJlYWstd29yZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IGNoaWxkcmVuOiAiU29tZXRoaW5nIHdlbnQgd3JvbmcuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgicCIsIHsgY2hpbGRyZW46ICJQbGVhc2UgdHJ5IHJlZnJlc2hpbmcgdGhlIHBhZ2UuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRldGFpbHMiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTAsIHRleHRBbGlnbjogImxlZnQiLCBmb250U2l6ZTogIjEycHgiLCBjb2xvcjogIiM2NjYiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3VtbWFyeSIsIHsgY2hpbGRyZW46ICJEZWJ1ZyBFcnJvciBEZXRhaWxzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgicHJlIiwgeyBzdHlsZTogeyB3aGl0ZVNwYWNlOiAicHJlLXdyYXAiLCBiYWNrZ3JvdW5kOiAiI2Y1ZjVmNSIsIHBhZGRpbmc6IDEwLCBib3JkZXJSYWRpdXM6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgdGhpcy5zdGF0ZS5lcnJvcj8udG9TdHJpbmcoKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJyIiwge30pLAogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy5zdGFjawogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuOwogIH0KfTsKdmFyIGdldEh5ZHJhdGlvbkRhdGEgPSAoKSA9PiB7CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFN0YXJ0aW5nIGh5ZHJhdGlvbiBjaGVjay4uLiIpOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFdpbmRvdyBpcyB1bmRlZmluZWQiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc3Qgb2EgPSB3aW5kb3cub3BlbmFpOwogIGlmICghb2EpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSB3aW5kb3cub3BlbmFpIG5vdCBmb3VuZCwgcmVuZGVyaW5nIHdpdGggZGVmYXVsdHMiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgZm91bmQ6IiwgT2JqZWN0LmtleXMob2EpKTsKICBjb25zdCBjYW5kaWRhdGVzID0gWwogICAgb2EudG9vbE91dHB1dCwKICAgIG9hLnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCwKICAgIG9hLnRvb2xJbnB1dAogIF07CiAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIEZvdW5kIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE5vIGRhdGEgZm91bmQgaW4gYW55IGNhbmRpZGF0ZSBzb3VyY2UiKTsKICByZXR1cm4ge307Cn07CmNvbnNvbGUubG9nKCJbTWFpbl0gUmV0aXJlbWVudCBDYWxjdWxhdG9yIG1haW4udHN4IGxvYWRpbmcuLi4iKTsKdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZXRpcmVtZW50LWNhbGN1bGF0b3Itcm9vdCIpOwppZiAoIWNvbnRhaW5lcikgewogIHRocm93IG5ldyBFcnJvcigicmV0aXJlbWVudC1jYWxjdWxhdG9yLXJvb3QgZWxlbWVudCBub3QgZm91bmQiKTsKfQp2YXIgcm9vdCA9ICgwLCBpbXBvcnRfY2xpZW50LmNyZWF0ZVJvb3QpKGNvbnRhaW5lcik7CnZhciByZW5kZXJBcHAgPSAoZGF0YSkgPT4gewogIHJvb3QucmVuZGVyKAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoaW1wb3J0X3JlYWN0NTMuZGVmYXVsdC5TdHJpY3RNb2RlLCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShFcnJvckJvdW5kYXJ5LCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShSZXRpcmVtZW50Q2FsY3VsYXRvckhlbGxvV29ybGQsIHsgaW5pdGlhbERhdGE6IGRhdGEgfSwgRGF0ZS5ub3coKSkgfSkgfSkKICApOwp9Owp2YXIgaW5pdGlhbERhdGEgPSBnZXRIeWRyYXRpb25EYXRhKCk7CnJlbmRlckFwcChpbml0aWFsRGF0YSk7CndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJvcGVuYWk6c2V0X2dsb2JhbHMiLCAoZXYpID0+IHsKICBjb25zdCBnbG9iYWxzID0gZXY/LmRldGFpbD8uZ2xvYmFsczsKICBpZiAoZ2xvYmFscykgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIExhdGUgZXZlbnQgcmVjZWl2ZWQ6IiwgZ2xvYmFscyk7CiAgICBjb25zdCBjYW5kaWRhdGVzID0gWwogICAgICBnbG9iYWxzLnRvb2xPdXRwdXQsCiAgICAgIGdsb2JhbHMuc3RydWN0dXJlZENvbnRlbnQsCiAgICAgIGdsb2JhbHMucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy50b29sSW5wdXQKICAgIF07CiAgICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICAgIGlmIChjYW5kaWRhdGUgJiYgdHlwZW9mIGNhbmRpZGF0ZSA9PT0gIm9iamVjdCIgJiYgT2JqZWN0LmtleXMoY2FuZGlkYXRlKS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFJlLXJlbmRlcmluZyB3aXRoIGxhdGUgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICAgIHJlbmRlckFwcChjYW5kaWRhdGUpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KfSk7Ci8qISBCdW5kbGVkIGxpY2Vuc2UgaW5mb3JtYXRpb246CgpyZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpzY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHNjaGVkdWxlci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpyZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCiAgKCoqCiAgICogQ2hlY2tzIGlmIGFuIGV2ZW50IGlzIHN1cHBvcnRlZCBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gZW52aXJvbm1lbnQuCiAgICoKICAgKiBOT1RFOiBUaGlzIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5IGZvciBub24tZ2VuZXJpYyBldmVudHMgc3VjaCBhcyBgY2hhbmdlYCwKICAgKiBgcmVzZXRgLCBgbG9hZGAsIGBlcnJvcmAsIGFuZCBgc2VsZWN0YC4KICAgKgogICAqIEJvcnJvd3MgZnJvbSBNb2Rlcm5penIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lU3VmZml4IEV2ZW50IG5hbWUsIGUuZy4gImNsaWNrIi4KICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQuCiAgICogQGludGVybmFsCiAgICogQGxpY2Vuc2UgTW9kZXJuaXpyIDMuMC4wcHJlIChDdXN0b20gQnVpbGQpIHwgTUlUCiAgICopCgp1c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHVzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgp1c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzOgogICgqISBkZWNpbWFsLmpzLWxpZ2h0IHYyLjUuMSBodHRwczovL2dpdGh1Yi5jb20vTWlrZU1jbC9kZWNpbWFsLmpzLWxpZ2h0L0xJQ0VOQ0UgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZXZyb24tZG93bi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NpcmNsZS1xdWVzdGlvbi1tYXJrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9sb2FkZXIuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWVzc2FnZS1zcXVhcmUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9taW51cy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsYXkuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbHVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcHJpbnRlci5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Retirement Calculator] Failed to load:', err);
          const root = document.getElementById('retirement-calculator-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load calculator</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
